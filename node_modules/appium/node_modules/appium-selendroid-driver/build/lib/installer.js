'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _fancyLog = require('fancy-log');

var _fancyLog2 = _interopRequireDefault(_fancyLog);

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var SE_VER = "0.17.0";
var SE_DOWNLOAD_CDNURL = process.env.npm_config_selendroid_driver_cdnurl || process.env.SELENDROID_DRIVER_CDNURL || "http://repo1.maven.org/maven2/io/selendroid/selendroid-standalone";
var SE_DOWNLOAD = SE_DOWNLOAD_CDNURL + '/' + SE_VER + '/selendroid-standalone-' + SE_VER + '-with-dependencies.jar';
var SE_DOWNLOAD_SHA256 = "7cf7163ac47f1c46eff95b62f78b58c1dabdec534acc6632da3784739f6e9d82";
var SE_DIR = _path2['default'].resolve(__dirname, "..", "..", "selendroid");
var SE_DOWNLOAD_DIR = _path2['default'].resolve(SE_DIR, "download");
// Use of temporary file means that SE_JAR_PATH can only exist if it has
// verified content.
var SE_JAR_PATH_TMP = _path2['default'].resolve(SE_DOWNLOAD_DIR, "selendroid-server.jar.tmp");
// Putting fingerprint in file name means download triggered if fingerprint changed.
var SE_JAR_PATH = _path2['default'].resolve(SE_DOWNLOAD_DIR, 'selendroid-server-' + SE_DOWNLOAD_SHA256 + '.jar');
var SE_APK_PATH = _path2['default'].resolve(SE_DIR, "selendroid-server.apk");
var SE_MANIFEST_PATH = _path2['default'].resolve(SE_DIR, "AndroidManifest.xml");

function setupSelendroid() {
  var manifestPath, serverPath, extractedManifestPath, extractedServerPath;
  return _regeneratorRuntime.async(function setupSelendroid$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('jar'));

      case 3:
        context$1$0.next = 10;
        break;

      case 5:
        context$1$0.prev = 5;
        context$1$0.t0 = context$1$0['catch'](0);

        if (!(context$1$0.t0.message.indexOf("ENOENT") !== -1 || context$1$0.t0.message.indexOf("exited with code 2") !== -1 || context$1$0.t0.message.indexOf("Command 'jar' not found. Is it installed?") !== -1)) {
          context$1$0.next = 10;
          break;
        }

        _fancyLog2['default'].error("Could not find Java's 'jar' executable on your PATH. Please " + "ensure it is present and try running install again");
        return context$1$0.abrupt('return');

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SE_JAR_PATH));

      case 12:
        if (!context$1$0.sent) {
          context$1$0.next = 16;
          break;
        }

        (0, _fancyLog2['default'])("Standalone jar exists, skipping download: " + SE_JAR_PATH);
        context$1$0.next = 18;
        break;

      case 16:
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(downloadSelendroid());

      case 18:
        (0, _fancyLog2['default'])('Determining AndroidManifest location');
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(getFilePathFromJar(/AndroidManifest.*\.xml$/, SE_JAR_PATH));

      case 21:
        manifestPath = context$1$0.sent;

        (0, _fancyLog2['default'])('Determining server apk location');
        context$1$0.next = 25;
        return _regeneratorRuntime.awrap(getFilePathFromJar(/selendroid-server.*\.apk$/, SE_JAR_PATH));

      case 25:
        serverPath = context$1$0.sent;

        (0, _fancyLog2['default'])('Extracting manifest and apk to ' + SE_DOWNLOAD_DIR);
        context$1$0.next = 29;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('jar', ['xf', SE_JAR_PATH, manifestPath, serverPath], {
          cwd: SE_DOWNLOAD_DIR
        }));

      case 29:
        (0, _fancyLog2['default'])('Copying manifest and apk to ' + SE_DIR);
        extractedManifestPath = _path2['default'].resolve(SE_DOWNLOAD_DIR, manifestPath);
        extractedServerPath = _path2['default'].resolve(SE_DOWNLOAD_DIR, serverPath);
        context$1$0.next = 34;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(extractedManifestPath, SE_MANIFEST_PATH));

      case 34:
        context$1$0.next = 36;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(extractedServerPath, SE_APK_PATH));

      case 36:
        (0, _fancyLog2['default'])("Cleaning up temp files");
        context$1$0.next = 39;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(extractedManifestPath));

      case 39:
        context$1$0.next = 41;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(extractedServerPath));

      case 41:
        (0, _fancyLog2['default'])('Fixing AndroidManifest icon bug');
        context$1$0.next = 44;
        return _regeneratorRuntime.awrap(fixManifestIcons(SE_MANIFEST_PATH));

      case 44:
        context$1$0.next = 46;
        return _regeneratorRuntime.awrap(serverExists());

      case 46:
        if (context$1$0.sent) {
          context$1$0.next = 48;
          break;
        }

        throw new Error("Something went wrong in setting up selendroid");

      case 48:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 5]]);
}

function downloadSelendroid() {
  var body, fingerprint;
  return _regeneratorRuntime.async(function downloadSelendroid$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        (0, _fancyLog2['default'])('Ensuring ' + SE_DOWNLOAD_DIR + ' exists');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(SE_DIR));

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(SE_DOWNLOAD_DIR));

      case 5:
        (0, _fancyLog2['default'])('Downloading Selendroid standalone server version ' + SE_VER + ' from ' + (SE_DOWNLOAD + ' --> ' + SE_JAR_PATH));
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ url: SE_DOWNLOAD, encoding: null }));

      case 8:
        body = context$1$0.sent;

        if (!(!body instanceof Buffer)) {
          context$1$0.next = 11;
          break;
        }

        throw new Error(Object.prototype.toString.call(body));

      case 11:
        (0, _fancyLog2['default'])('Writing binary content to ' + SE_JAR_PATH_TMP);
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(SE_JAR_PATH_TMP, body));

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.chmod(SE_JAR_PATH_TMP, 420));

      case 16:
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(sha256(body));

      case 18:
        fingerprint = context$1$0.sent;

        if (!(fingerprint === SE_DOWNLOAD_SHA256)) {
          context$1$0.next = 25;
          break;
        }

        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rename(SE_JAR_PATH_TMP, SE_JAR_PATH));

      case 22:
        (0, _fancyLog2['default'])("Selendroid standalone server downloaded");
        context$1$0.next = 26;
        break;

      case 25:
        throw new Error('Bad SHA256 fingerprint: \'' + fingerprint + '\', bytes: ' + body.length);

      case 26:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function sha256(buffer) {
  var hash;
  return _regeneratorRuntime.async(function sha256$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        hash = _crypto2['default'].createHash('sha256');
        return context$1$0.abrupt('return', hash.update(buffer).digest('hex'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getFilePathFromJar(fileRegex, jarPath) {
  var _ref, stdout, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, line;

  return _regeneratorRuntime.async(function getFilePathFromJar$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('jar', ['tf', jarPath]));

      case 2:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 7;
        _iterator = _getIterator(stdout.split("\n"));

      case 9:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 16;
          break;
        }

        line = _step.value;

        if (!fileRegex.test(line.trim())) {
          context$1$0.next = 13;
          break;
        }

        return context$1$0.abrupt('return', line.trim());

      case 13:
        _iteratorNormalCompletion = true;
        context$1$0.next = 9;
        break;

      case 16:
        context$1$0.next = 22;
        break;

      case 18:
        context$1$0.prev = 18;
        context$1$0.t0 = context$1$0['catch'](7);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 22:
        context$1$0.prev = 22;
        context$1$0.prev = 23;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 25:
        context$1$0.prev = 25;

        if (!_didIteratorError) {
          context$1$0.next = 28;
          break;
        }

        throw _iteratorError;

      case 28:
        return context$1$0.finish(25);

      case 29:
        return context$1$0.finish(22);

      case 30:
        throw new Error('Could not find ' + fileRegex + ' in ' + jarPath);

      case 31:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[7, 18, 22, 30], [23,, 25, 29]]);
}

function serverExists() {
  return _regeneratorRuntime.async(function serverExists$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SE_APK_PATH));

      case 3:
        context$1$0.t0 = context$1$0.sent;

        if (!context$1$0.t0) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SE_MANIFEST_PATH));

      case 7:
        context$1$0.t0 = context$1$0.sent;

      case 8:
        return context$1$0.abrupt('return', context$1$0.t0);

      case 11:
        context$1$0.prev = 11;
        context$1$0.t1 = context$1$0['catch'](0);

        if (!(context$1$0.t1.code.indexOf("ENOENT") !== -1)) {
          context$1$0.next = 15;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 15:
        throw context$1$0.t1;

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 11]]);
}

function fixManifestIcons(manifest) {
  var curData, iconRe, newData;
  return _regeneratorRuntime.async(function fixManifestIcons$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(manifest));

      case 2:
        curData = context$1$0.sent.toString('utf8');
        iconRe = /application[\s\S]+android:icon="[^"]+"/;
        newData = curData.replace(iconRe, "application");
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(manifest, newData));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.setupSelendroid = setupSelendroid;
exports.serverExists = serverExists;
exports.SE_APK_PATH = SE_APK_PATH;
exports.SE_MANIFEST_PATH = SE_MANIFEST_PATH;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFNLEdBQUcsd0NBQXdDO0FBQ2pELGVBQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxhQUFhLENBQUM7O3lDQUM5QyxrQkFBRyxTQUFTLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQzs7Ozs7OztDQUN0Qzs7UUFFUSxlQUFlLEdBQWYsZUFBZTtRQUFFLFlBQVksR0FBWixZQUFZO1FBQUUsV0FBVyxHQUFYLFdBQVc7UUFBRSxnQkFBZ0IsR0FBaEIsZ0JBQWdCIiwiZmlsZSI6ImxpYi9pbnN0YWxsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICdmYW5jeS1sb2cnO1xuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuXG5cbmNvbnN0IFNFX1ZFUiA9IFwiMC4xNy4wXCI7XG5jb25zdCBTRV9ET1dOTE9BRF9DRE5VUkwgPSBwcm9jZXNzLmVudi5ucG1fY29uZmlnX3NlbGVuZHJvaWRfZHJpdmVyX2NkbnVybCB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnYuU0VMRU5EUk9JRF9EUklWRVJfQ0ROVVJMIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBcImh0dHA6Ly9yZXBvMS5tYXZlbi5vcmcvbWF2ZW4yL2lvL3NlbGVuZHJvaWQvc2VsZW5kcm9pZC1zdGFuZGFsb25lXCI7XG5jb25zdCBTRV9ET1dOTE9BRCA9IGAke1NFX0RPV05MT0FEX0NETlVSTH0vJHtTRV9WRVJ9L3NlbGVuZHJvaWQtc3RhbmRhbG9uZS0ke1NFX1ZFUn0td2l0aC1kZXBlbmRlbmNpZXMuamFyYDtcbmNvbnN0IFNFX0RPV05MT0FEX1NIQTI1NiA9IFwiN2NmNzE2M2FjNDdmMWM0NmVmZjk1YjYyZjc4YjU4YzFkYWJkZWM1MzRhY2M2NjMyZGEzNzg0NzM5ZjZlOWQ4MlwiO1xuY29uc3QgU0VfRElSID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgXCIuLlwiLCBcIi4uXCIsIFwic2VsZW5kcm9pZFwiKTtcbmNvbnN0IFNFX0RPV05MT0FEX0RJUiA9IHBhdGgucmVzb2x2ZShTRV9ESVIsIFwiZG93bmxvYWRcIik7XG4vLyBVc2Ugb2YgdGVtcG9yYXJ5IGZpbGUgbWVhbnMgdGhhdCBTRV9KQVJfUEFUSCBjYW4gb25seSBleGlzdCBpZiBpdCBoYXNcbi8vIHZlcmlmaWVkIGNvbnRlbnQuXG5jb25zdCBTRV9KQVJfUEFUSF9UTVAgPSBwYXRoLnJlc29sdmUoU0VfRE9XTkxPQURfRElSLCBcInNlbGVuZHJvaWQtc2VydmVyLmphci50bXBcIik7XG4vLyBQdXR0aW5nIGZpbmdlcnByaW50IGluIGZpbGUgbmFtZSBtZWFucyBkb3dubG9hZCB0cmlnZ2VyZWQgaWYgZmluZ2VycHJpbnQgY2hhbmdlZC5cbmNvbnN0IFNFX0pBUl9QQVRIID0gcGF0aC5yZXNvbHZlKFNFX0RPV05MT0FEX0RJUiwgYHNlbGVuZHJvaWQtc2VydmVyLSR7U0VfRE9XTkxPQURfU0hBMjU2fS5qYXJgKTtcbmNvbnN0IFNFX0FQS19QQVRIID0gcGF0aC5yZXNvbHZlKFNFX0RJUiwgXCJzZWxlbmRyb2lkLXNlcnZlci5hcGtcIik7XG5jb25zdCBTRV9NQU5JRkVTVF9QQVRIID0gcGF0aC5yZXNvbHZlKFNFX0RJUiwgXCJBbmRyb2lkTWFuaWZlc3QueG1sXCIpO1xuXG5hc3luYyBmdW5jdGlvbiBzZXR1cFNlbGVuZHJvaWQgKCkge1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoJ2phcicpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZihcIkVOT0VOVFwiKSAhPT0gLTEgfHxcbiAgICAgICAgZXJyLm1lc3NhZ2UuaW5kZXhPZihcImV4aXRlZCB3aXRoIGNvZGUgMlwiKSAhPT0gLTEgfHxcbiAgICAgICAgZXJyLm1lc3NhZ2UuaW5kZXhPZihcIkNvbW1hbmQgJ2phcicgbm90IGZvdW5kLiBJcyBpdCBpbnN0YWxsZWQ/XCIpICE9PSAtMSkge1xuICAgICAgbG9nLmVycm9yKFwiQ291bGQgbm90IGZpbmQgSmF2YSdzICdqYXInIGV4ZWN1dGFibGUgb24geW91ciBQQVRILiBQbGVhc2UgXCIgK1xuICAgICAgICAgICAgICAgIFwiZW5zdXJlIGl0IGlzIHByZXNlbnQgYW5kIHRyeSBydW5uaW5nIGluc3RhbGwgYWdhaW5cIik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG4gIGlmIChhd2FpdCBmcy5leGlzdHMoU0VfSkFSX1BBVEgpKSB7XG4gICAgbG9nKFwiU3RhbmRhbG9uZSBqYXIgZXhpc3RzLCBza2lwcGluZyBkb3dubG9hZDogXCIgKyBTRV9KQVJfUEFUSCk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgZG93bmxvYWRTZWxlbmRyb2lkKCk7XG4gIH1cbiAgbG9nKGBEZXRlcm1pbmluZyBBbmRyb2lkTWFuaWZlc3QgbG9jYXRpb25gKTtcbiAgbGV0IG1hbmlmZXN0UGF0aCA9IGF3YWl0IGdldEZpbGVQYXRoRnJvbUphcigvQW5kcm9pZE1hbmlmZXN0LipcXC54bWwkLyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTRV9KQVJfUEFUSCk7XG4gIGxvZyhgRGV0ZXJtaW5pbmcgc2VydmVyIGFwayBsb2NhdGlvbmApO1xuICBsZXQgc2VydmVyUGF0aCA9IGF3YWl0IGdldEZpbGVQYXRoRnJvbUphcigvc2VsZW5kcm9pZC1zZXJ2ZXIuKlxcLmFwayQvLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTRV9KQVJfUEFUSCk7XG4gIGxvZyhgRXh0cmFjdGluZyBtYW5pZmVzdCBhbmQgYXBrIHRvICR7U0VfRE9XTkxPQURfRElSfWApO1xuICBhd2FpdCBleGVjKCdqYXInLCBbJ3hmJywgU0VfSkFSX1BBVEgsIG1hbmlmZXN0UGF0aCwgc2VydmVyUGF0aF0sIHtcbiAgICBjd2Q6IFNFX0RPV05MT0FEX0RJUlxuICB9KTtcbiAgbG9nKGBDb3B5aW5nIG1hbmlmZXN0IGFuZCBhcGsgdG8gJHtTRV9ESVJ9YCk7XG4gIGxldCBleHRyYWN0ZWRNYW5pZmVzdFBhdGggPSBwYXRoLnJlc29sdmUoU0VfRE9XTkxPQURfRElSLCBtYW5pZmVzdFBhdGgpO1xuICBsZXQgZXh0cmFjdGVkU2VydmVyUGF0aCA9IHBhdGgucmVzb2x2ZShTRV9ET1dOTE9BRF9ESVIsIHNlcnZlclBhdGgpO1xuICBhd2FpdCBmcy5jb3B5RmlsZShleHRyYWN0ZWRNYW5pZmVzdFBhdGgsIFNFX01BTklGRVNUX1BBVEgpO1xuICBhd2FpdCBmcy5jb3B5RmlsZShleHRyYWN0ZWRTZXJ2ZXJQYXRoLCBTRV9BUEtfUEFUSCk7XG4gIGxvZyhcIkNsZWFuaW5nIHVwIHRlbXAgZmlsZXNcIik7XG4gIGF3YWl0IGZzLnJpbXJhZihleHRyYWN0ZWRNYW5pZmVzdFBhdGgpO1xuICBhd2FpdCBmcy5yaW1yYWYoZXh0cmFjdGVkU2VydmVyUGF0aCk7XG4gIGxvZyhgRml4aW5nIEFuZHJvaWRNYW5pZmVzdCBpY29uIGJ1Z2ApO1xuICBhd2FpdCBmaXhNYW5pZmVzdEljb25zKFNFX01BTklGRVNUX1BBVEgpO1xuICBpZiAoIShhd2FpdCBzZXJ2ZXJFeGlzdHMoKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJTb21ldGhpbmcgd2VudCB3cm9uZyBpbiBzZXR0aW5nIHVwIHNlbGVuZHJvaWRcIik7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZG93bmxvYWRTZWxlbmRyb2lkICgpIHtcbiAgbG9nKGBFbnN1cmluZyAke1NFX0RPV05MT0FEX0RJUn0gZXhpc3RzYCk7XG4gIGF3YWl0IGZzLm1rZGlyKFNFX0RJUik7XG4gIGF3YWl0IGZzLm1rZGlyKFNFX0RPV05MT0FEX0RJUik7XG4gIGxvZyhgRG93bmxvYWRpbmcgU2VsZW5kcm9pZCBzdGFuZGFsb25lIHNlcnZlciB2ZXJzaW9uICR7U0VfVkVSfSBmcm9tIGAgK1xuICAgICAgICAgICBgJHtTRV9ET1dOTE9BRH0gLS0+ICR7U0VfSkFSX1BBVEh9YCk7XG4gIGxldCBib2R5ID0gYXdhaXQgcmVxdWVzdC5nZXQoe3VybDogU0VfRE9XTkxPQUQsIGVuY29kaW5nOiBudWxsfSk7XG4gIGlmICghYm9keSBpbnN0YW5jZW9mIEJ1ZmZlcikge1xuICAgIHRocm93IG5ldyBFcnJvcihPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoYm9keSkpO1xuICB9XG4gIGxvZyhgV3JpdGluZyBiaW5hcnkgY29udGVudCB0byAke1NFX0pBUl9QQVRIX1RNUH1gKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKFNFX0pBUl9QQVRIX1RNUCwgYm9keSk7XG4gIGF3YWl0IGZzLmNobW9kKFNFX0pBUl9QQVRIX1RNUCwgMG8wNjQ0KTtcbiAgbGV0IGZpbmdlcnByaW50ID0gYXdhaXQgc2hhMjU2KGJvZHkpO1xuICBpZiAoZmluZ2VycHJpbnQgPT09IFNFX0RPV05MT0FEX1NIQTI1Nikge1xuICAgIGF3YWl0IGZzLnJlbmFtZShTRV9KQVJfUEFUSF9UTVAsIFNFX0pBUl9QQVRIKTtcbiAgICBsb2coXCJTZWxlbmRyb2lkIHN0YW5kYWxvbmUgc2VydmVyIGRvd25sb2FkZWRcIik7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBCYWQgU0hBMjU2IGZpbmdlcnByaW50OiAnJHtmaW5nZXJwcmludH0nLCBieXRlczogJHtib2R5Lmxlbmd0aH1gKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzaGEyNTYgKGJ1ZmZlcikge1xuICBjb25zdCBoYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTI1NicpO1xuICByZXR1cm4gaGFzaC51cGRhdGUoYnVmZmVyKS5kaWdlc3QoJ2hleCcpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRGaWxlUGF0aEZyb21KYXIgKGZpbGVSZWdleCwgamFyUGF0aCkge1xuICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKCdqYXInLCBbJ3RmJywgamFyUGF0aF0pO1xuICBmb3IgKGxldCBsaW5lIG9mIHN0ZG91dC5zcGxpdChcIlxcblwiKSkge1xuICAgIGlmIChmaWxlUmVnZXgudGVzdChsaW5lLnRyaW0oKSkpIHtcbiAgICAgIHJldHVybiBsaW5lLnRyaW0oKTtcbiAgICB9XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCAke2ZpbGVSZWdleH0gaW4gJHtqYXJQYXRofWApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXJ2ZXJFeGlzdHMgKCkge1xuICB0cnkge1xuICAgIHJldHVybiAoYXdhaXQgZnMuZXhpc3RzKFNFX0FQS19QQVRIKSAmJlxuICAgICAgICAgICAgYXdhaXQgZnMuZXhpc3RzKFNFX01BTklGRVNUX1BBVEgpKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChlLmNvZGUuaW5kZXhPZihcIkVOT0VOVFwiKSAhPT0gLTEpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgdGhyb3cgZTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhNYW5pZmVzdEljb25zIChtYW5pZmVzdCkge1xuICBsZXQgY3VyRGF0YSA9IChhd2FpdCBmcy5yZWFkRmlsZShtYW5pZmVzdCkpLnRvU3RyaW5nKCd1dGY4Jyk7XG4gIGxldCBpY29uUmUgPSAvYXBwbGljYXRpb25bXFxzXFxTXSthbmRyb2lkOmljb249XCJbXlwiXStcIi87XG4gIGxldCBuZXdEYXRhID0gY3VyRGF0YS5yZXBsYWNlKGljb25SZSwgXCJhcHBsaWNhdGlvblwiKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKG1hbmlmZXN0LCBuZXdEYXRhKTtcbn1cblxuZXhwb3J0IHsgc2V0dXBTZWxlbmRyb2lkLCBzZXJ2ZXJFeGlzdHMsIFNFX0FQS19QQVRILCBTRV9NQU5JRkVTVF9QQVRIIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
