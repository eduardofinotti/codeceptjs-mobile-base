'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSupport = require('appium-support');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumIosDriver = require('appium-ios-driver');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _teen_process = require('teen_process');

var _nodeSimctl = require('node-simctl');

var CONTAINER_PATH_MARKER = '@';
// https://regex101.com/r/PLdB0G/2
var CONTAINER_PATH_PATTERN = new RegExp('^' + CONTAINER_PATH_MARKER + '([^/]+)/(.+)');

var commands = _appiumIosDriver.iosCommands.file;

function verifyIFusePresence() {
  return _regeneratorRuntime.async(function verifyIFusePresence$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.which('ifuse'));

      case 2:
        if (context$1$0.sent) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].errorAndThrow('\'ifuse\' tool is required to be installed on the machine. ' + 'Install it using \'brew cask install osxfuse && brew install ifuse\' or check ' + 'if it is available in PATH environment variable if the tool is already installed. ' + ('Current PATH value: ' + process.env.PATH));

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function mountDevice(device, iFuseArgs) {
  return _regeneratorRuntime.async(function mountDevice$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Starting ifuse with args \'' + iFuseArgs + '\'...');
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('ifuse', iFuseArgs));

      case 4:
        context$1$0.next = 9;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].errorAndThrow('Cannot mount the media folder of the device with UDID ' + device.udid + '. ' + 'Make sure osxfuse plugin has necessary permissions in System Preferences->Security & Privacy. ' + ('Error code: ' + context$1$0.t0.code + '; stderr output: ' + context$1$0.t0.stderr));

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 6]]);
}

function verifyIsSubPath(originalPath, root) {
  var normalizedRoot = _path2['default'].normalize(root);
  var normalizedPath = _path2['default'].normalize(_path2['default'].dirname(originalPath));
  if (!normalizedPath.startsWith(normalizedRoot)) {
    _logger2['default'].errorAndThrow('\'' + normalizedPath + '\' is expected to be a subpath of \'' + normalizedRoot + '\'');
  }
}

function parseContainerPath(remotePath, containerRootSupplier) {
  var match, containerRoot, resultPath;
  return _regeneratorRuntime.async(function parseContainerPath$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        match = CONTAINER_PATH_PATTERN.exec(remotePath);

        if (!match) {
          _logger2['default'].errorAndThrow('It is expected that package identifier is separated from the relative path with a single slash. ' + ('\'' + remotePath + '\' is given instead'));
        }

        if (!_lodash2['default'].isFunction(containerRootSupplier)) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(containerRootSupplier(match[1]));

      case 5:
        context$1$0.t0 = context$1$0.sent;
        context$1$0.next = 9;
        break;

      case 8:
        context$1$0.t0 = containerRootSupplier;

      case 9:
        containerRoot = context$1$0.t0;
        resultPath = _path2['default'].posix.resolve(containerRoot, match[2]);

        verifyIsSubPath(resultPath, containerRoot);
        return context$1$0.abrupt('return', [match[1], resultPath]);

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

/**
 * Save the given base64 data chunk as a binary file on the Simulator under test.
 *
 * @param {Object} device - The device object, which represents the device under test.
 *                          This object is expected to have the `udid` property containing the
 *                          valid device ID.
 * @param {string} remotePath - The remote path on the device. This variable can be prefixed with
 *                              bundle id, so then the file will be uploaded to the corresponding
 *                              application container instead of the default media folder, for example
 *                              '@com.myapp.bla/RelativePathInContainer/111.png'. The '@' character at the
 *                              beginning of the argument is mandatory in such case.
 *                              The relative folder path is ignored if the file is going to be uploaded
 *                              to the default media folder and only the file name is considered important.
 * @param {string} base64Data - Base-64 encoded content of the file to be uploaded.
 */
function pushFileToSimulator(device, remotePath, base64Data) {
  var buffer, _ref, _ref2, bundleId, _dstPath, dstFolder, dstPath;

  return _regeneratorRuntime.async(function pushFileToSimulator$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        buffer = Buffer.from(base64Data, 'base64');

        if (!CONTAINER_PATH_PATTERN.test(remotePath)) {
          context$1$0.next = 18;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(parseContainerPath(remotePath, function callee$1$0(x) {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap((0, _nodeSimctl.getAppContainer)(device.udid, x));

              case 2:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 3:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        }));

      case 4:
        _ref = context$1$0.sent;
        _ref2 = _slicedToArray(_ref, 2);
        bundleId = _ref2[0];
        _dstPath = _ref2[1];

        _logger2['default'].info('Parsed bundle identifier \'' + bundleId + '\' from \'' + remotePath + '\'. ' + ('Will put the data into \'' + _dstPath + '\''));
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(_path2['default'].dirname(_dstPath)));

      case 11:
        if (context$1$0.sent) {
          context$1$0.next = 15;
          break;
        }

        _logger2['default'].debug('The destination folder \'' + _path2['default'].dirname(_dstPath) + '\' does not exist. Creating...');
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(_path2['default'].dirname(_dstPath)));

      case 15:
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(_dstPath, buffer));

      case 17:
        return context$1$0.abrupt('return');

      case 18:
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.openDir());

      case 20:
        dstFolder = context$1$0.sent;
        dstPath = _path2['default'].resolve(dstFolder, _path2['default'].basename(remotePath));
        context$1$0.prev = 22;
        context$1$0.next = 25;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(dstPath, buffer));

      case 25:
        context$1$0.next = 27;
        return _regeneratorRuntime.awrap((0, _nodeSimctl.addMedia)(device.udid, dstPath));

      case 27:
        context$1$0.prev = 27;
        context$1$0.next = 30;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(dstFolder));

      case 30:
        return context$1$0.finish(27);

      case 31:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[22,, 27, 31]]);
}

/**
 * Save the given base64 data chunk as a binary file on the device under test.
 * ifuse/osxfuse should be installed and configured on the target machine in order
 * for this function to work properly. Read https://github.com/libimobiledevice/ifuse
 * and https://github.com/osxfuse/osxfuse/wiki/FAQ for more details.
 *
 * @param {Object} device - The device object, which represents the device under test.
 *                          This object is expected to have the `udid` property containing the
 *                          valid device ID.
 * @param {string} remotePath - The remote path on the device. This variable can be prefixed with
 *                              bundle id, so then the file will be uploaded to the corresponding
 *                              application container instead of the default media folder, for example
 *                              '@com.myapp.bla/RelativePathInContainer/111.png'. The '@' character at the
 *                              beginning of the argument is mandatory in such case.
 * @param {string} base64Data - Base-64 encoded content of the file to be uploaded.
 */
function pushFileToRealDevice(device, remotePath, base64Data) {
  var mntRoot, isUnmountSuccessful, dstPath, ifuseArgs, _ref3, _ref32, bundleId, pathInContainer;

  return _regeneratorRuntime.async(function pushFileToRealDevice$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(verifyIFusePresence());

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.openDir());

      case 4:
        mntRoot = context$1$0.sent;
        isUnmountSuccessful = true;
        context$1$0.prev = 6;
        dstPath = _path2['default'].resolve(mntRoot, remotePath);
        ifuseArgs = ['-u', device.udid, mntRoot];

        if (!CONTAINER_PATH_PATTERN.test(remotePath)) {
          context$1$0.next = 21;
          break;
        }

        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(parseContainerPath(remotePath, mntRoot));

      case 12:
        _ref3 = context$1$0.sent;
        _ref32 = _slicedToArray(_ref3, 2);
        bundleId = _ref32[0];
        pathInContainer = _ref32[1];

        dstPath = pathInContainer;
        _logger2['default'].info('Parsed bundle identifier \'' + bundleId + '\' from \'' + remotePath + '\'. ' + ('Will put the data into \'' + dstPath + '\''));
        ifuseArgs = ['-u', device.udid, '--container', bundleId, mntRoot];
        context$1$0.next = 22;
        break;

      case 21:
        verifyIsSubPath(dstPath, mntRoot);

      case 22:
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap(mountDevice(device, ifuseArgs));

      case 24:
        isUnmountSuccessful = false;
        context$1$0.prev = 25;
        context$1$0.next = 28;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(_path2['default'].dirname(dstPath)));

      case 28:
        if (context$1$0.sent) {
          context$1$0.next = 32;
          break;
        }

        _logger2['default'].debug('The destination folder \'' + _path2['default'].dirname(dstPath) + '\' does not exist. Creating...');
        context$1$0.next = 32;
        return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(_path2['default'].dirname(dstPath)));

      case 32:
        context$1$0.next = 34;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(dstPath, Buffer.from(base64Data, 'base64')));

      case 34:
        context$1$0.prev = 34;
        context$1$0.next = 37;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('umount', [mntRoot]));

      case 37:
        isUnmountSuccessful = true;
        return context$1$0.finish(34);

      case 39:
        context$1$0.prev = 39;

        if (!isUnmountSuccessful) {
          context$1$0.next = 45;
          break;
        }

        context$1$0.next = 43;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(mntRoot));

      case 43:
        context$1$0.next = 46;
        break;

      case 45:
        _logger2['default'].warn('Umount has failed, so not removing \'' + mntRoot + '\'');

      case 46:
        return context$1$0.finish(39);

      case 47:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6,, 39, 47], [25,, 34, 39]]);
}

/**
 * Get the content of given file or folder from iOS Simulator and return it as base-64 encoded string.
 * Folder content is recursively packed into a zip archive.
 *
 * @param {Object} device - The device object, which represents the device under test.
 *                          This object is expected to have the `udid` property containing the
 *                          valid device ID.
 * @param {string} remotePath - The path to a file or a folder, which exists in the corresponding application
 *                              container on Simulator. Use
 *                              @<app_bundle_id>/<path_to_the_file_or_folder_inside_container>
 *                              format to pull a file or a folder from an application container
 * @param {boolean} isFile - Whether the destination item is a file or a folder
 * @returns {string} Base-64 encoded content of the file.
 */
function pullFromSimulator(device, remotePath, isFile) {
  var pathOnServer, _ref4, _ref42, bundleId, dstPath, simRoot, buffer;

  return _regeneratorRuntime.async(function pullFromSimulator$(context$1$0) {
    var _this2 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        pathOnServer = undefined;

        if (!CONTAINER_PATH_PATTERN.test(remotePath)) {
          context$1$0.next = 12;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(parseContainerPath(remotePath, function callee$1$0(x) {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap((0, _nodeSimctl.getAppContainer)(device.udid, x));

              case 2:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 3:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this2);
        }));

      case 4:
        _ref4 = context$1$0.sent;
        _ref42 = _slicedToArray(_ref4, 2);
        bundleId = _ref42[0];
        dstPath = _ref42[1];

        _logger2['default'].info('Parsed bundle identifier \'' + bundleId + '\' from \'' + remotePath + '\'. ' + ('Will get the data from \'' + dstPath + '\''));
        pathOnServer = dstPath;
        context$1$0.next = 16;
        break;

      case 12:
        simRoot = device.getDir();

        pathOnServer = _path2['default'].posix.join(simRoot, remotePath);
        verifyIsSubPath(pathOnServer, simRoot);
        _logger2['default'].info('Got the full item path: ' + pathOnServer);

      case 16:
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(pathOnServer));

      case 18:
        if (context$1$0.sent) {
          context$1$0.next = 20;
          break;
        }

        _logger2['default'].errorAndThrow('The remote ' + (isFile ? 'file' : 'folder') + ' at \'' + pathOnServer + '\' does not exist');

      case 20:
        if (!isFile) {
          context$1$0.next = 26;
          break;
        }

        context$1$0.next = 23;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(pathOnServer));

      case 23:
        context$1$0.t0 = context$1$0.sent;
        context$1$0.next = 29;
        break;

      case 26:
        context$1$0.next = 28;
        return _regeneratorRuntime.awrap(_appiumSupport.zip.toInMemoryZip(pathOnServer));

      case 28:
        context$1$0.t0 = context$1$0.sent;

      case 29:
        buffer = context$1$0.t0;
        return context$1$0.abrupt('return', Buffer.from(buffer).toString('base64'));

      case 31:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

/**
 * Get the content of given file or folder from the real device under test and return it as base-64 encoded string.
 * Folder content is recursively packed into a zip archive.
 *
 * @param {Object} device - The device object, which represents the device under test.
 *                          This object is expected to have the `udid` property containing the
 *                          valid device ID.
 * @param {string} remotePath - The path to an existing remote file on the device. This variable can be prefixed with
 *                              bundle id, so then the file will be downloaded from the corresponding
 *                              application container instead of the default media folder, for example
 *                              '@com.myapp.bla/RelativePathInContainer/111.png'. The '@' character at the
 *                              beginning of the argument is mandatory in such case.
 * @param {boolean} isFile - Whether the destination item is a file or a folder
 * @return {string} Base-64 encoded content of the remote file
 */
function pullFromRealDevice(device, remotePath, isFile) {
  var mntRoot, isUnmountSuccessful, dstPath, ifuseArgs, _ref5, _ref52, bundleId, pathInContainer, buffer;

  return _regeneratorRuntime.async(function pullFromRealDevice$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(verifyIFusePresence());

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.openDir());

      case 4:
        mntRoot = context$1$0.sent;
        isUnmountSuccessful = true;
        context$1$0.prev = 6;
        dstPath = _path2['default'].resolve(mntRoot, remotePath);
        ifuseArgs = ['-u', device.udid, mntRoot];

        if (!CONTAINER_PATH_PATTERN.test(remotePath)) {
          context$1$0.next = 21;
          break;
        }

        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(parseContainerPath(remotePath, mntRoot));

      case 12:
        _ref5 = context$1$0.sent;
        _ref52 = _slicedToArray(_ref5, 2);
        bundleId = _ref52[0];
        pathInContainer = _ref52[1];

        dstPath = pathInContainer;
        _logger2['default'].info('Parsed bundle identifier \'' + bundleId + '\' from \'' + remotePath + '\'. ' + ('Will get the data from \'' + dstPath + '\''));
        ifuseArgs = ['-u', device.udid, '--container', bundleId, mntRoot];
        context$1$0.next = 22;
        break;

      case 21:
        verifyIsSubPath(dstPath, mntRoot);

      case 22:
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap(mountDevice(device, ifuseArgs));

      case 24:
        isUnmountSuccessful = false;
        context$1$0.prev = 25;
        context$1$0.next = 28;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(dstPath));

      case 28:
        if (context$1$0.sent) {
          context$1$0.next = 30;
          break;
        }

        _logger2['default'].errorAndThrow('The remote ' + (isFile ? 'file' : 'folder') + ' at \'' + dstPath + '\' does not exist');

      case 30:
        if (!isFile) {
          context$1$0.next = 36;
          break;
        }

        context$1$0.next = 33;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(dstPath));

      case 33:
        context$1$0.t0 = context$1$0.sent;
        context$1$0.next = 39;
        break;

      case 36:
        context$1$0.next = 38;
        return _regeneratorRuntime.awrap(_appiumSupport.zip.toInMemoryZip(dstPath));

      case 38:
        context$1$0.t0 = context$1$0.sent;

      case 39:
        buffer = context$1$0.t0;
        return context$1$0.abrupt('return', Buffer.from(buffer).toString('base64'));

      case 41:
        context$1$0.prev = 41;
        context$1$0.next = 44;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('umount', [mntRoot]));

      case 44:
        isUnmountSuccessful = true;
        return context$1$0.finish(41);

      case 46:
        context$1$0.prev = 46;

        if (!isUnmountSuccessful) {
          context$1$0.next = 52;
          break;
        }

        context$1$0.next = 50;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(mntRoot));

      case 50:
        context$1$0.next = 53;
        break;

      case 52:
        _logger2['default'].warn('Umount has failed, so not removing \'' + mntRoot + '\'');

      case 53:
        return context$1$0.finish(46);

      case 54:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6,, 46, 54], [25,, 41, 46]]);
}

commands.pushFile = function callee$0$0(remotePath, base64Data) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (remotePath.endsWith('/')) {
          _logger2['default'].errorAndThrow('It is expected that remote path points to a file and not to a folder. ' + ('\'' + remotePath + '\' is given instead'));
        }
        if (_lodash2['default'].isArray(base64Data)) {
          // some clients (ahem) java, send a byte array encoding utf8 characters
          // instead of a string, which would be infinitely better!
          base64Data = Buffer.from(base64Data).toString('utf8');
        }

        if (!this.isSimulator()) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(pushFileToSimulator(this.opts.device, remotePath, base64Data));

      case 5:
        context$1$0.t0 = context$1$0.sent;
        context$1$0.next = 11;
        break;

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(pushFileToRealDevice(this.opts.device, remotePath, base64Data));

      case 10:
        context$1$0.t0 = context$1$0.sent;

      case 11:
        return context$1$0.abrupt('return', context$1$0.t0);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pullFile = function callee$0$0(remotePath) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (remotePath.endsWith('/')) {
          _logger2['default'].errorAndThrow('It is expected that remote path points to a file and not to a folder. ' + ('\'' + remotePath + '\' is given instead'));
        }

        if (!this.isSimulator()) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(pullFromSimulator(this.opts.device, remotePath, true));

      case 4:
        context$1$0.t0 = context$1$0.sent;
        context$1$0.next = 10;
        break;

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(pullFromRealDevice(this.opts.device, remotePath, true));

      case 9:
        context$1$0.t0 = context$1$0.sent;

      case 10:
        return context$1$0.abrupt('return', context$1$0.t0);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getSimFileFullPath = function callee$0$0(remotePath) {
  var basePath, appName, appNameRegex, appNameMatches, findPath, _ref6, stdout, appRoot, subPath, fullPath;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        basePath = this.opts.device.getDir();
        appName = null;

        if (this.opts.app) {
          appNameRegex = new RegExp('\\' + _path2['default'].sep + '([\\w-]+\\.app)');
          appNameMatches = appNameRegex.exec(this.opts.app);

          if (appNameMatches) {
            appName = appNameMatches[1];
          }
        }
        // de-absolutize the path
        if (_appiumSupport.system.isWindows()) {
          if (remotePath.indexof('://') === 1) {
            remotePath = remotePath.slice(4);
          }
        } else {
          if (remotePath.indexOf('/') === 0) {
            remotePath = remotePath.slice(1);
          }
        }

        if (!(remotePath.indexOf(appName) === 0)) {
          context$1$0.next = 19;
          break;
        }

        findPath = basePath;

        if (this.opts.platformVersion >= 8) {
          // the .app file appears in /Containers/Data and /Containers/Bundle both. We only want /Bundle
          findPath = _path2['default'].resolve(basePath, 'Containers', 'Bundle');
        }
        findPath = findPath.replace(/\s/g, '\\ ');

        context$1$0.next = 10;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('find', [findPath, '-name', appName]));

      case 10:
        _ref6 = context$1$0.sent;
        stdout = _ref6.stdout;
        appRoot = stdout.replace(/\n$/, '');
        subPath = remotePath.substring(appName.length + 1);
        fullPath = _path2['default'].resolve(appRoot, subPath);

        _logger2['default'].debug('Finding app-relative file: \'' + fullPath + '\'');
        return context$1$0.abrupt('return', fullPath);

      case 19:
        fullPath = _path2['default'].resolve(basePath, remotePath);

        _logger2['default'].debug('Finding sim-relative file: ' + fullPath);
        return context$1$0.abrupt('return', fullPath);

      case 22:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pullFolder = function callee$0$0(remotePath) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!remotePath.endsWith('/')) {
          remotePath = remotePath + '/';
        }

        if (!this.isSimulator()) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(pullFromSimulator(this.opts.device, remotePath, false));

      case 4:
        context$1$0.t0 = context$1$0.sent;
        context$1$0.next = 10;
        break;

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(pullFromRealDevice(this.opts.device, remotePath, false));

      case 9:
        context$1$0.t0 = context$1$0.sent;

      case 10:
        return context$1$0.abrupt('return', context$1$0.t0);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

exports.commands = commands;
exports['default'] = commands;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maWxlLW1vdmVtZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztzQkFBYyxRQUFROzs7OzZCQUMyQixnQkFBZ0I7O29CQUNoRCxNQUFNOzs7OytCQUNLLG1CQUFtQjs7c0JBQy9CLFdBQVc7Ozs7NEJBQ04sY0FBYzs7MEJBQ08sYUFBYTs7QUFFdkQsSUFBTSxxQkFBcUIsR0FBRyxHQUFHLENBQUM7O0FBRWxDLElBQU0sc0JBQXNCLEdBQUcsSUFBSSxNQUFNLE9BQUsscUJBQXFCLGtCQUFlLENBQUM7O0FBR25GLElBQUksUUFBUSxHQUFHLDZCQUFZLElBQUksQ0FBQzs7QUFFaEMsU0FBZSxtQkFBbUI7Ozs7O3lDQUNyQixrQkFBRyxLQUFLLENBQUMsT0FBTyxDQUFDOzs7Ozs7OztBQUMxQiw0QkFBSSxhQUFhLENBQUMsZ0pBQzhFLHVGQUNNLDZCQUM3RCxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBRSxDQUFDLENBQUM7Ozs7Ozs7Q0FFaEU7O0FBRUQsU0FBZSxXQUFXLENBQUUsTUFBTSxFQUFFLFNBQVM7Ozs7QUFDM0MsNEJBQUksS0FBSyxpQ0FBOEIsU0FBUyxXQUFPLENBQUM7Ozt5Q0FFaEQsd0JBQUssT0FBTyxFQUFFLFNBQVMsQ0FBQzs7Ozs7Ozs7OztBQUU5Qiw0QkFBSSxhQUFhLENBQUMsMkRBQXlELE1BQU0sQ0FBQyxJQUFJLDBHQUM0QixxQkFDakYsZUFBRSxJQUFJLHlCQUFvQixlQUFFLE1BQU0sQ0FBRSxDQUFDLENBQUM7Ozs7Ozs7Q0FFMUU7O0FBRUQsU0FBUyxlQUFlLENBQUUsWUFBWSxFQUFFLElBQUksRUFBRTtBQUM1QyxNQUFNLGNBQWMsR0FBRyxrQkFBSyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDNUMsTUFBTSxjQUFjLEdBQUcsa0JBQUssU0FBUyxDQUFDLGtCQUFLLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0FBQ2xFLE1BQUksQ0FBQyxjQUFjLENBQUMs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LGlCQUFpQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxLQUFLLENBQUM7Ozs7Ozs7Ozt5Q0FDdEQsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLEtBQUssQ0FBQzs7Ozs7Ozs7Ozs7OztDQUNsRSxDQUFDOztRQUVPLFFBQVEsR0FBUixRQUFRO3FCQUNGLFFBQVEiLCJmaWxlIjoibGliL2NvbW1hbmRzL2ZpbGUtbW92ZW1lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgc3lzdGVtLCBmcywgdGVtcERpciwgbWtkaXJwLCB6aXAgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGlvc0NvbW1hbmRzIH0gZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBhZGRNZWRpYSwgZ2V0QXBwQ29udGFpbmVyIH0gZnJvbSAnbm9kZS1zaW1jdGwnO1xuXG5jb25zdCBDT05UQUlORVJfUEFUSF9NQVJLRVIgPSAnQCc7XG4vLyBodHRwczovL3JlZ2V4MTAxLmNvbS9yL1BMZEIwRy8yXG5jb25zdCBDT05UQUlORVJfUEFUSF9QQVRURVJOID0gbmV3IFJlZ0V4cChgXiR7Q09OVEFJTkVSX1BBVEhfTUFSS0VSfShbXi9dKykvKC4rKWApO1xuXG5cbmxldCBjb21tYW5kcyA9IGlvc0NvbW1hbmRzLmZpbGU7XG5cbmFzeW5jIGZ1bmN0aW9uIHZlcmlmeUlGdXNlUHJlc2VuY2UgKCkge1xuICBpZiAoIWF3YWl0IGZzLndoaWNoKCdpZnVzZScpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYCdpZnVzZScgdG9vbCBpcyByZXF1aXJlZCB0byBiZSBpbnN0YWxsZWQgb24gdGhlIG1hY2hpbmUuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGBJbnN0YWxsIGl0IHVzaW5nICdicmV3IGNhc2sgaW5zdGFsbCBvc3hmdXNlICYmIGJyZXcgaW5zdGFsbCBpZnVzZScgb3IgY2hlY2sgYCArXG4gICAgICAgICAgICAgICAgICAgICAgYGlmIGl0IGlzIGF2YWlsYWJsZSBpbiBQQVRIIGVudmlyb25tZW50IHZhcmlhYmxlIGlmIHRoZSB0b29sIGlzIGFscmVhZHkgaW5zdGFsbGVkLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgQ3VycmVudCBQQVRIIHZhbHVlOiAke3Byb2Nlc3MuZW52LlBBVEh9YCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gbW91bnREZXZpY2UgKGRldmljZSwgaUZ1c2VBcmdzKSB7XG4gIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgaWZ1c2Ugd2l0aCBhcmdzICcke2lGdXNlQXJnc30nLi4uYCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygnaWZ1c2UnLCBpRnVzZUFyZ3MpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYENhbm5vdCBtb3VudCB0aGUgbWVkaWEgZm9sZGVyIG9mIHRoZSBkZXZpY2Ugd2l0aCBVRElEICR7ZGV2aWNlLnVkaWR9LiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgTWFrZSBzdXJlIG9zeGZ1c2UgcGx1Z2luIGhhcyBuZWNlc3NhcnkgcGVybWlzc2lvbnMgaW4gU3lzdGVtIFByZWZlcmVuY2VzLT5TZWN1cml0eSAmIFByaXZhY3kuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGBFcnJvciBjb2RlOiAke2UuY29kZX07IHN0ZGVyciBvdXRwdXQ6ICR7ZS5zdGRlcnJ9YCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gdmVyaWZ5SXNTdWJQYXRoIChvcmlnaW5hbFBhdGgsIHJvb3QpIHtcbiAgY29uc3Qgbm9ybWFsaXplZFJvb3QgPSBwYXRoLm5vcm1hbGl6ZShyb290KTtcbiAgY29uc3Qgbm9ybWFsaXplZFBhdGggPSBwYXRoLm5vcm1hbGl6ZShwYXRoLmRpcm5hbWUob3JpZ2luYWxQYXRoKSk7XG4gIGlmICghbm9ybWFsaXplZFBhdGguc3RhcnRzV2l0aChub3JtYWxpemVkUm9vdCkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgJyR7bm9ybWFsaXplZFBhdGh9JyBpcyBleHBlY3RlZCB0byBiZSBhIHN1YnBhdGggb2YgJyR7bm9ybWFsaXplZFJvb3R9J2ApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhcnNlQ29udGFpbmVyUGF0aCAocmVtb3RlUGF0aCwgY29udGFpbmVyUm9vdFN1cHBsaWVyKSB7XG4gIGNvbnN0IG1hdGNoID0gQ09OVEFJTkVSX1BBVEhfUEFUVEVSTi5leGVjKHJlbW90ZVBhdGgpO1xuICBpZiAoIW1hdGNoKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEl0IGlzIGV4cGVjdGVkIHRoYXQgcGFja2FnZSBpZGVudGlmaWVyIGlzIHNlcGFyYXRlZCBmcm9tIHRoZSByZWxhdGl2ZSBwYXRoIHdpdGggYSBzaW5nbGUgc2xhc2guIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGAnJHtyZW1vdGVQYXRofScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICB9XG4gIGNvbnN0IGNvbnRhaW5lclJvb3QgPSBfLmlzRnVuY3Rpb24oY29udGFpbmVyUm9vdFN1cHBsaWVyKSA/XG4gICAgKGF3YWl0IGNvbnRhaW5lclJvb3RTdXBwbGllcihtYXRjaFsxXSkpIDpcbiAgICBjb250YWluZXJSb290U3VwcGxpZXI7XG4gIGNvbnN0IHJlc3VsdFBhdGggPSBwYXRoLnBvc2l4LnJlc29sdmUoY29udGFpbmVyUm9vdCwgbWF0Y2hbMl0pO1xuICB2ZXJpZnlJc1N1YlBhdGgocmVzdWx0UGF0aCwgY29udGFpbmVyUm9vdCk7XG4gIHJldHVybiBbbWF0Y2hbMV0sIHJlc3VsdFBhdGhdO1xufVxuXG4vKipcbiAqIFNhdmUgdGhlIGdpdmVuIGJhc2U2NCBkYXRhIGNodW5rIGFzIGEgYmluYXJ5IGZpbGUgb24gdGhlIFNpbXVsYXRvciB1bmRlciB0ZXN0LlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBkZXZpY2UgLSBUaGUgZGV2aWNlIG9iamVjdCwgd2hpY2ggcmVwcmVzZW50cyB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBvYmplY3QgaXMgZXhwZWN0ZWQgdG8gaGF2ZSB0aGUgYHVkaWRgIHByb3BlcnR5IGNvbnRhaW5pbmcgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgZGV2aWNlIElELlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcmVtb3RlIHBhdGggb24gdGhlIGRldmljZS4gVGhpcyB2YXJpYWJsZSBjYW4gYmUgcHJlZml4ZWQgd2l0aFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidW5kbGUgaWQsIHNvIHRoZW4gdGhlIGZpbGUgd2lsbCBiZSB1cGxvYWRlZCB0byB0aGUgY29ycmVzcG9uZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBjb250YWluZXIgaW5zdGVhZCBvZiB0aGUgZGVmYXVsdCBtZWRpYSBmb2xkZXIsIGZvciBleGFtcGxlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdAY29tLm15YXBwLmJsYS9SZWxhdGl2ZVBhdGhJbkNvbnRhaW5lci8xMTEucG5nJy4gVGhlICdAJyBjaGFyYWN0ZXIgYXQgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2lubmluZyBvZiB0aGUgYXJndW1lbnQgaXMgbWFuZGF0b3J5IGluIHN1Y2ggY2FzZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIHJlbGF0aXZlIGZvbGRlciBwYXRoIGlzIGlnbm9yZWQgaWYgdGhlIGZpbGUgaXMgZ29pbmcgdG8gYmUgdXBsb2FkZWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG8gdGhlIGRlZmF1bHQgbWVkaWEgZm9sZGVyIGFuZCBvbmx5IHRoZSBmaWxlIG5hbWUgaXMgY29uc2lkZXJlZCBpbXBvcnRhbnQuXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZTY0RGF0YSAtIEJhc2UtNjQgZW5jb2RlZCBjb250ZW50IG9mIHRoZSBmaWxlIHRvIGJlIHVwbG9hZGVkLlxuICovXG5hc3luYyBmdW5jdGlvbiBwdXNoRmlsZVRvU2ltdWxhdG9yIChkZXZpY2UsIHJlbW90ZVBhdGgsIGJhc2U2NERhdGEpIHtcbiAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmZyb20oYmFzZTY0RGF0YSwgJ2Jhc2U2NCcpO1xuICBpZiAoQ09OVEFJTkVSX1BBVEhfUEFUVEVSTi50ZXN0KHJlbW90ZVBhdGgpKSB7XG4gICAgY29uc3QgW2J1bmRsZUlkLCBkc3RQYXRoXSA9IGF3YWl0IHBhcnNlQ29udGFpbmVyUGF0aChyZW1vdGVQYXRoLFxuICAgICAgYXN5bmMgKHgpID0+IGF3YWl0IGdldEFwcENvbnRhaW5lcihkZXZpY2UudWRpZCwgeCkpO1xuICAgIGxvZy5pbmZvKGBQYXJzZWQgYnVuZGxlIGlkZW50aWZpZXIgJyR7YnVuZGxlSWR9JyBmcm9tICcke3JlbW90ZVBhdGh9Jy4gYCArXG4gICAgICAgICAgICAgYFdpbGwgcHV0IHRoZSBkYXRhIGludG8gJyR7ZHN0UGF0aH0nYCk7XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHMocGF0aC5kaXJuYW1lKGRzdFBhdGgpKSkge1xuICAgICAgbG9nLmRlYnVnKGBUaGUgZGVzdGluYXRpb24gZm9sZGVyICcke3BhdGguZGlybmFtZShkc3RQYXRoKX0nIGRvZXMgbm90IGV4aXN0LiBDcmVhdGluZy4uLmApO1xuICAgICAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZShkc3RQYXRoKSk7XG4gICAgfVxuICAgIGF3YWl0IGZzLndyaXRlRmlsZShkc3RQYXRoLCBidWZmZXIpO1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCBkc3RGb2xkZXIgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgY29uc3QgZHN0UGF0aCA9IHBhdGgucmVzb2x2ZShkc3RGb2xkZXIsIHBhdGguYmFzZW5hbWUocmVtb3RlUGF0aCkpO1xuICB0cnkge1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZShkc3RQYXRoLCBidWZmZXIpO1xuICAgIGF3YWl0IGFkZE1lZGlhKGRldmljZS51ZGlkLCBkc3RQYXRoKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYoZHN0Rm9sZGVyKTtcbiAgfVxufVxuXG4vKipcbiAqIFNhdmUgdGhlIGdpdmVuIGJhc2U2NCBkYXRhIGNodW5rIGFzIGEgYmluYXJ5IGZpbGUgb24gdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogaWZ1c2Uvb3N4ZnVzZSBzaG91bGQgYmUgaW5zdGFsbGVkIGFuZCBjb25maWd1cmVkIG9uIHRoZSB0YXJnZXQgbWFjaGluZSBpbiBvcmRlclxuICogZm9yIHRoaXMgZnVuY3Rpb24gdG8gd29yayBwcm9wZXJseS4gUmVhZCBodHRwczovL2dpdGh1Yi5jb20vbGliaW1vYmlsZWRldmljZS9pZnVzZVxuICogYW5kIGh0dHBzOi8vZ2l0aHViLmNvbS9vc3hmdXNlL29zeGZ1c2Uvd2lraS9GQVEgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gZGV2aWNlIC0gVGhlIGRldmljZSBvYmplY3QsIHdoaWNoIHJlcHJlc2VudHMgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb2JqZWN0IGlzIGV4cGVjdGVkIHRvIGhhdmUgdGhlIGB1ZGlkYCBwcm9wZXJ0eSBjb250YWluaW5nIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkIGRldmljZSBJRC5cbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHJlbW90ZSBwYXRoIG9uIHRoZSBkZXZpY2UuIFRoaXMgdmFyaWFibGUgY2FuIGJlIHByZWZpeGVkIHdpdGhcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVuZGxlIGlkLCBzbyB0aGVuIHRoZSBmaWxlIHdpbGwgYmUgdXBsb2FkZWQgdG8gdGhlIGNvcnJlc3BvbmRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb24gY29udGFpbmVyIGluc3RlYWQgb2YgdGhlIGRlZmF1bHQgbWVkaWEgZm9sZGVyLCBmb3IgZXhhbXBsZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQGNvbS5teWFwcC5ibGEvUmVsYXRpdmVQYXRoSW5Db250YWluZXIvMTExLnBuZycuIFRoZSAnQCcgY2hhcmFjdGVyIGF0IHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWdpbm5pbmcgb2YgdGhlIGFyZ3VtZW50IGlzIG1hbmRhdG9yeSBpbiBzdWNoIGNhc2UuXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZTY0RGF0YSAtIEJhc2UtNjQgZW5jb2RlZCBjb250ZW50IG9mIHRoZSBmaWxlIHRvIGJlIHVwbG9hZGVkLlxuICovXG5hc3luYyBmdW5jdGlvbiBwdXNoRmlsZVRvUmVhbERldmljZSAoZGV2aWNlLCByZW1vdGVQYXRoLCBiYXNlNjREYXRhKSB7XG4gIGF3YWl0IHZlcmlmeUlGdXNlUHJlc2VuY2UoKTtcbiAgY29uc3QgbW50Um9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICBsZXQgaXNVbm1vdW50U3VjY2Vzc2Z1bCA9IHRydWU7XG4gIHRyeSB7XG4gICAgbGV0IGRzdFBhdGggPSBwYXRoLnJlc29sdmUobW50Um9vdCwgcmVtb3RlUGF0aCk7XG4gICAgbGV0IGlmdXNlQXJncyA9IFsnLXUnLCBkZXZpY2UudWRpZCwgbW50Um9vdF07XG4gICAgaWYgKENPTlRBSU5FUl9QQVRIX1BBVFRFUk4udGVzdChyZW1vdGVQYXRoKSkge1xuICAgICAgY29uc3QgW2J1bmRsZUlkLCBwYXRoSW5Db250YWluZXJdID0gYXdhaXQgcGFyc2VDb250YWluZXJQYXRoKHJlbW90ZVBhdGgsIG1udFJvb3QpO1xuICAgICAgZHN0UGF0aCA9IHBhdGhJbkNvbnRhaW5lcjtcbiAgICAgIGxvZy5pbmZvKGBQYXJzZWQgYnVuZGxlIGlkZW50aWZpZXIgJyR7YnVuZGxlSWR9JyBmcm9tICcke3JlbW90ZVBhdGh9Jy4gYCArXG4gICAgICAgICAgICAgICBgV2lsbCBwdXQgdGhlIGRhdGEgaW50byAnJHtkc3RQYXRofSdgKTtcbiAgICAgIGlmdXNlQXJncyA9IFsnLXUnLCBkZXZpY2UudWRpZCwgJy0tY29udGFpbmVyJywgYnVuZGxlSWQsIG1udFJvb3RdO1xuICAgIH0gZWxzZSB7XG4gICAgICB2ZXJpZnlJc1N1YlBhdGgoZHN0UGF0aCwgbW50Um9vdCk7XG4gICAgfVxuICAgIGF3YWl0IG1vdW50RGV2aWNlKGRldmljZSwgaWZ1c2VBcmdzKTtcbiAgICBpc1VubW91bnRTdWNjZXNzZnVsID0gZmFsc2U7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHBhdGguZGlybmFtZShkc3RQYXRoKSkpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBUaGUgZGVzdGluYXRpb24gZm9sZGVyICcke3BhdGguZGlybmFtZShkc3RQYXRoKX0nIGRvZXMgbm90IGV4aXN0LiBDcmVhdGluZy4uLmApO1xuICAgICAgICBhd2FpdCBta2RpcnAocGF0aC5kaXJuYW1lKGRzdFBhdGgpKTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShkc3RQYXRoLCBCdWZmZXIuZnJvbShiYXNlNjREYXRhLCAnYmFzZTY0JykpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhd2FpdCBleGVjKCd1bW91bnQnLCBbbW50Um9vdF0pO1xuICAgICAgaXNVbm1vdW50U3VjY2Vzc2Z1bCA9IHRydWU7XG4gICAgfVxuICB9IGZpbmFsbHkge1xuICAgIGlmIChpc1VubW91bnRTdWNjZXNzZnVsKSB7XG4gICAgICBhd2FpdCBmcy5yaW1yYWYobW50Um9vdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy53YXJuKGBVbW91bnQgaGFzIGZhaWxlZCwgc28gbm90IHJlbW92aW5nICcke21udFJvb3R9J2ApO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIEdldCB0aGUgY29udGVudCBvZiBnaXZlbiBmaWxlIG9yIGZvbGRlciBmcm9tIGlPUyBTaW11bGF0b3IgYW5kIHJldHVybiBpdCBhcyBiYXNlLTY0IGVuY29kZWQgc3RyaW5nLlxuICogRm9sZGVyIGNvbnRlbnQgaXMgcmVjdXJzaXZlbHkgcGFja2VkIGludG8gYSB6aXAgYXJjaGl2ZS5cbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gZGV2aWNlIC0gVGhlIGRldmljZSBvYmplY3QsIHdoaWNoIHJlcHJlc2VudHMgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb2JqZWN0IGlzIGV4cGVjdGVkIHRvIGhhdmUgdGhlIGB1ZGlkYCBwcm9wZXJ0eSBjb250YWluaW5nIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkIGRldmljZSBJRC5cbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gYSBmaWxlIG9yIGEgZm9sZGVyLCB3aGljaCBleGlzdHMgaW4gdGhlIGNvcnJlc3BvbmRpbmcgYXBwbGljYXRpb25cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyIG9uIFNpbXVsYXRvci4gVXNlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEA8YXBwX2J1bmRsZV9pZD4vPHBhdGhfdG9fdGhlX2ZpbGVfb3JfZm9sZGVyX2luc2lkZV9jb250YWluZXI+XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdCB0byBwdWxsIGEgZmlsZSBvciBhIGZvbGRlciBmcm9tIGFuIGFwcGxpY2F0aW9uIGNvbnRhaW5lclxuICogQHBhcmFtIHtib29sZWFufSBpc0ZpbGUgLSBXaGV0aGVyIHRoZSBkZXN0aW5hdGlvbiBpdGVtIGlzIGEgZmlsZSBvciBhIGZvbGRlclxuICogQHJldHVybnMge3N0cmluZ30gQmFzZS02NCBlbmNvZGVkIGNvbnRlbnQgb2YgdGhlIGZpbGUuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHB1bGxGcm9tU2ltdWxhdG9yIChkZXZpY2UsIHJlbW90ZVBhdGgsIGlzRmlsZSkge1xuICBsZXQgcGF0aE9uU2VydmVyO1xuICBpZiAoQ09OVEFJTkVSX1BBVEhfUEFUVEVSTi50ZXN0KHJlbW90ZVBhdGgpKSB7XG4gICAgY29uc3QgW2J1bmRsZUlkLCBkc3RQYXRoXSA9IGF3YWl0IHBhcnNlQ29udGFpbmVyUGF0aChyZW1vdGVQYXRoLFxuICAgICAgYXN5bmMgKHgpID0+IGF3YWl0IGdldEFwcENvbnRhaW5lcihkZXZpY2UudWRpZCwgeCkpO1xuICAgIGxvZy5pbmZvKGBQYXJzZWQgYnVuZGxlIGlkZW50aWZpZXIgJyR7YnVuZGxlSWR9JyBmcm9tICcke3JlbW90ZVBhdGh9Jy4gYCArXG4gICAgICAgICAgICAgYFdpbGwgZ2V0IHRoZSBkYXRhIGZyb20gJyR7ZHN0UGF0aH0nYCk7XG4gICAgcGF0aE9uU2VydmVyID0gZHN0UGF0aDtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBzaW1Sb290ID0gZGV2aWNlLmdldERpcigpO1xuICAgIHBhdGhPblNlcnZlciA9IHBhdGgucG9zaXguam9pbihzaW1Sb290LCByZW1vdGVQYXRoKTtcbiAgICB2ZXJpZnlJc1N1YlBhdGgocGF0aE9uU2VydmVyLCBzaW1Sb290KTtcbiAgICBsb2cuaW5mbyhgR290IHRoZSBmdWxsIGl0ZW0gcGF0aDogJHtwYXRoT25TZXJ2ZXJ9YCk7XG4gIH1cbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMocGF0aE9uU2VydmVyKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgcmVtb3RlICR7aXNGaWxlID8gJ2ZpbGUnIDogJ2ZvbGRlcid9IGF0ICcke3BhdGhPblNlcnZlcn0nIGRvZXMgbm90IGV4aXN0YCk7XG4gIH1cbiAgY29uc3QgYnVmZmVyID0gaXNGaWxlXG4gICAgPyBhd2FpdCBmcy5yZWFkRmlsZShwYXRoT25TZXJ2ZXIpXG4gICAgOiBhd2FpdCB6aXAudG9Jbk1lbW9yeVppcChwYXRoT25TZXJ2ZXIpO1xuICByZXR1cm4gQnVmZmVyLmZyb20oYnVmZmVyKS50b1N0cmluZygnYmFzZTY0Jyk7XG59XG5cbi8qKlxuICogR2V0IHRoZSBjb250ZW50IG9mIGdpdmVuIGZpbGUgb3IgZm9sZGVyIGZyb20gdGhlIHJlYWwgZGV2aWNlIHVuZGVyIHRlc3QgYW5kIHJldHVybiBpdCBhcyBiYXNlLTY0IGVuY29kZWQgc3RyaW5nLlxuICogRm9sZGVyIGNvbnRlbnQgaXMgcmVjdXJzaXZlbHkgcGFja2VkIGludG8gYSB6aXAgYXJjaGl2ZS5cbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gZGV2aWNlIC0gVGhlIGRldmljZSBvYmplY3QsIHdoaWNoIHJlcHJlc2VudHMgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb2JqZWN0IGlzIGV4cGVjdGVkIHRvIGhhdmUgdGhlIGB1ZGlkYCBwcm9wZXJ0eSBjb250YWluaW5nIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkIGRldmljZSBJRC5cbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gYW4gZXhpc3RpbmcgcmVtb3RlIGZpbGUgb24gdGhlIGRldmljZS4gVGhpcyB2YXJpYWJsZSBjYW4gYmUgcHJlZml4ZWQgd2l0aFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidW5kbGUgaWQsIHNvIHRoZW4gdGhlIGZpbGUgd2lsbCBiZSBkb3dubG9hZGVkIGZyb20gdGhlIGNvcnJlc3BvbmRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb24gY29udGFpbmVyIGluc3RlYWQgb2YgdGhlIGRlZmF1bHQgbWVkaWEgZm9sZGVyLCBmb3IgZXhhbXBsZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQGNvbS5teWFwcC5ibGEvUmVsYXRpdmVQYXRoSW5Db250YWluZXIvMTExLnBuZycuIFRoZSAnQCcgY2hhcmFjdGVyIGF0IHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWdpbm5pbmcgb2YgdGhlIGFyZ3VtZW50IGlzIG1hbmRhdG9yeSBpbiBzdWNoIGNhc2UuXG4gKiBAcGFyYW0ge2Jvb2xlYW59IGlzRmlsZSAtIFdoZXRoZXIgdGhlIGRlc3RpbmF0aW9uIGl0ZW0gaXMgYSBmaWxlIG9yIGEgZm9sZGVyXG4gKiBAcmV0dXJuIHtzdHJpbmd9IEJhc2UtNjQgZW5jb2RlZCBjb250ZW50IG9mIHRoZSByZW1vdGUgZmlsZVxuICovXG5hc3luYyBmdW5jdGlvbiBwdWxsRnJvbVJlYWxEZXZpY2UgKGRldmljZSwgcmVtb3RlUGF0aCwgaXNGaWxlKSB7XG4gIGF3YWl0IHZlcmlmeUlGdXNlUHJlc2VuY2UoKTtcbiAgY29uc3QgbW50Um9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICBsZXQgaXNVbm1vdW50U3VjY2Vzc2Z1bCA9IHRydWU7XG4gIHRyeSB7XG4gICAgbGV0IGRzdFBhdGggPSBwYXRoLnJlc29sdmUobW50Um9vdCwgcmVtb3RlUGF0aCk7XG4gICAgbGV0IGlmdXNlQXJncyA9IFsnLXUnLCBkZXZpY2UudWRpZCwgbW50Um9vdF07XG4gICAgaWYgKENPTlRBSU5FUl9QQVRIX1BBVFRFUk4udGVzdChyZW1vdGVQYXRoKSkge1xuICAgICAgY29uc3QgW2J1bmRsZUlkLCBwYXRoSW5Db250YWluZXJdID0gYXdhaXQgcGFyc2VDb250YWluZXJQYXRoKHJlbW90ZVBhdGgsIG1udFJvb3QpO1xuICAgICAgZHN0UGF0aCA9IHBhdGhJbkNvbnRhaW5lcjtcbiAgICAgIGxvZy5pbmZvKGBQYXJzZWQgYnVuZGxlIGlkZW50aWZpZXIgJyR7YnVuZGxlSWR9JyBmcm9tICcke3JlbW90ZVBhdGh9Jy4gYCArXG4gICAgICAgICAgICAgICBgV2lsbCBnZXQgdGhlIGRhdGEgZnJvbSAnJHtkc3RQYXRofSdgKTtcbiAgICAgIGlmdXNlQXJncyA9IFsnLXUnLCBkZXZpY2UudWRpZCwgJy0tY29udGFpbmVyJywgYnVuZGxlSWQsIG1udFJvb3RdO1xuICAgIH0gZWxzZSB7XG4gICAgICB2ZXJpZnlJc1N1YlBhdGgoZHN0UGF0aCwgbW50Um9vdCk7XG4gICAgfVxuICAgIGF3YWl0IG1vdW50RGV2aWNlKGRldmljZSwgaWZ1c2VBcmdzKTtcbiAgICBpc1VubW91bnRTdWNjZXNzZnVsID0gZmFsc2U7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKGRzdFBhdGgpKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgcmVtb3RlICR7aXNGaWxlID8gJ2ZpbGUnIDogJ2ZvbGRlcid9IGF0ICcke2RzdFBhdGh9JyBkb2VzIG5vdCBleGlzdGApO1xuICAgICAgfVxuICAgICAgY29uc3QgYnVmZmVyID0gaXNGaWxlXG4gICAgICAgID8gYXdhaXQgZnMucmVhZEZpbGUoZHN0UGF0aClcbiAgICAgICAgOiBhd2FpdCB6aXAudG9Jbk1lbW9yeVppcChkc3RQYXRoKTtcbiAgICAgIHJldHVybiBCdWZmZXIuZnJvbShidWZmZXIpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgYXdhaXQgZXhlYygndW1vdW50JywgW21udFJvb3RdKTtcbiAgICAgIGlzVW5tb3VudFN1Y2Nlc3NmdWwgPSB0cnVlO1xuICAgIH1cbiAgfSBmaW5hbGx5IHtcbiAgICBpZiAoaXNVbm1vdW50U3VjY2Vzc2Z1bCkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKG1udFJvb3QpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cud2FybihgVW1vdW50IGhhcyBmYWlsZWQsIHNvIG5vdCByZW1vdmluZyAnJHttbnRSb290fSdgKTtcbiAgICB9XG4gIH1cbn1cblxuXG5jb21tYW5kcy5wdXNoRmlsZSA9IGFzeW5jIGZ1bmN0aW9uIChyZW1vdGVQYXRoLCBiYXNlNjREYXRhKSB7XG4gIGlmIChyZW1vdGVQYXRoLmVuZHNXaXRoKCcvJykpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgSXQgaXMgZXhwZWN0ZWQgdGhhdCByZW1vdGUgcGF0aCBwb2ludHMgdG8gYSBmaWxlIGFuZCBub3QgdG8gYSBmb2xkZXIuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGAnJHtyZW1vdGVQYXRofScgaXMgZ2l2ZW4gaW5zdGVhZGApO1xuICB9XG4gIGlmIChfLmlzQXJyYXkoYmFzZTY0RGF0YSkpIHtcbiAgICAvLyBzb21lIGNsaWVudHMgKGFoZW0pIGphdmEsIHNlbmQgYSBieXRlIGFycmF5IGVuY29kaW5nIHV0ZjggY2hhcmFjdGVyc1xuICAgIC8vIGluc3RlYWQgb2YgYSBzdHJpbmcsIHdoaWNoIHdvdWxkIGJlIGluZmluaXRlbHkgYmV0dGVyIVxuICAgIGJhc2U2NERhdGEgPSBCdWZmZXIuZnJvbShiYXNlNjREYXRhKS50b1N0cmluZygndXRmOCcpO1xuICB9XG4gIHJldHVybiB0aGlzLmlzU2ltdWxhdG9yKClcbiAgICA/IGF3YWl0IHB1c2hGaWxlVG9TaW11bGF0b3IodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgYmFzZTY0RGF0YSlcbiAgICA6IGF3YWl0IHB1c2hGaWxlVG9SZWFsRGV2aWNlKHRoaXMub3B0cy5kZXZpY2UsIHJlbW90ZVBhdGgsIGJhc2U2NERhdGEpO1xufTtcblxuY29tbWFuZHMucHVsbEZpbGUgPSBhc3luYyBmdW5jdGlvbiAocmVtb3RlUGF0aCkge1xuICBpZiAocmVtb3RlUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEl0IGlzIGV4cGVjdGVkIHRoYXQgcmVtb3RlIHBhdGggcG9pbnRzIHRvIGEgZmlsZSBhbmQgbm90IHRvIGEgZm9sZGVyLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgJyR7cmVtb3RlUGF0aH0nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgfVxuICByZXR1cm4gdGhpcy5pc1NpbXVsYXRvcigpXG4gICAgPyBhd2FpdCBwdWxsRnJvbVNpbXVsYXRvcih0aGlzLm9wdHMuZGV2aWNlLCByZW1vdGVQYXRoLCB0cnVlKVxuICAgIDogYXdhaXQgcHVsbEZyb21SZWFsRGV2aWNlKHRoaXMub3B0cy5kZXZpY2UsIHJlbW90ZVBhdGgsIHRydWUpO1xufTtcblxuY29tbWFuZHMuZ2V0U2ltRmlsZUZ1bGxQYXRoID0gYXN5bmMgZnVuY3Rpb24gKHJlbW90ZVBhdGgpIHtcbiAgbGV0IGJhc2VQYXRoID0gdGhpcy5vcHRzLmRldmljZS5nZXREaXIoKTtcbiAgbGV0IGFwcE5hbWUgPSBudWxsO1xuXG4gIGlmICh0aGlzLm9wdHMuYXBwKSB7XG4gICAgbGV0IGFwcE5hbWVSZWdleCA9IG5ldyBSZWdFeHAoYFxcXFwke3BhdGguc2VwfShbXFxcXHctXStcXFxcLmFwcClgKTtcbiAgICBsZXQgYXBwTmFtZU1hdGNoZXMgPSBhcHBOYW1lUmVnZXguZXhlYyh0aGlzLm9wdHMuYXBwKTtcbiAgICBpZiAoYXBwTmFtZU1hdGNoZXMpIHtcbiAgICAgIGFwcE5hbWUgPSBhcHBOYW1lTWF0Y2hlc1sxXTtcbiAgICB9XG4gIH1cbiAgLy8gZGUtYWJzb2x1dGl6ZSB0aGUgcGF0aFxuICBpZiAoc3lzdGVtLmlzV2luZG93cygpKSB7XG4gICAgaWYgKHJlbW90ZVBhdGguaW5kZXhvZignOi8vJykgPT09IDEpIHtcbiAgICAgIHJlbW90ZVBhdGggPSByZW1vdGVQYXRoLnNsaWNlKDQpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAocmVtb3RlUGF0aC5pbmRleE9mKCcvJykgPT09IDApIHtcbiAgICAgIHJlbW90ZVBhdGggPSByZW1vdGVQYXRoLnNsaWNlKDEpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChyZW1vdGVQYXRoLmluZGV4T2YoYXBwTmFtZSkgPT09IDApIHtcbiAgICBsZXQgZmluZFBhdGggPSBiYXNlUGF0aDtcbiAgICBpZiAodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiA+PSA4KSB7XG4gICAgICAvLyB0aGUgLmFwcCBmaWxlIGFwcGVhcnMgaW4gL0NvbnRhaW5lcnMvRGF0YSBhbmQgL0NvbnRhaW5lcnMvQnVuZGxlIGJvdGguIFdlIG9ubHkgd2FudCAvQnVuZGxlXG4gICAgICBmaW5kUGF0aCA9IHBhdGgucmVzb2x2ZShiYXNlUGF0aCwgJ0NvbnRhaW5lcnMnLCAnQnVuZGxlJyk7XG4gICAgfVxuICAgIGZpbmRQYXRoID0gIGZpbmRQYXRoLnJlcGxhY2UoL1xccy9nLCAnXFxcXCAnKTtcblxuICAgIGxldCB7IHN0ZG91dCB9ID0gYXdhaXQgZXhlYygnZmluZCcsIFtmaW5kUGF0aCwgJy1uYW1lJywgYXBwTmFtZV0pO1xuICAgIGxldCBhcHBSb290ID0gc3Rkb3V0LnJlcGxhY2UoL1xcbiQvLCAnJyk7XG4gICAgbGV0IHN1YlBhdGggPSByZW1vdGVQYXRoLnN1YnN0cmluZyhhcHBOYW1lLmxlbmd0aCArIDEpO1xuICAgIGxldCBmdWxsUGF0aCA9IHBhdGgucmVzb2x2ZShhcHBSb290LCBzdWJQYXRoKTtcbiAgICBsb2cuZGVidWcoYEZpbmRpbmcgYXBwLXJlbGF0aXZlIGZpbGU6ICcke2Z1bGxQYXRofSdgKTtcbiAgICByZXR1cm4gZnVsbFBhdGg7XG4gIH0gZWxzZSB7XG4gICAgbGV0IGZ1bGxQYXRoID0gcGF0aC5yZXNvbHZlKGJhc2VQYXRoLCByZW1vdGVQYXRoKTtcbiAgICBsb2cuZGVidWcoYEZpbmRpbmcgc2ltLXJlbGF0aXZlIGZpbGU6ICR7ZnVsbFBhdGh9YCk7XG4gICAgcmV0dXJuIGZ1bGxQYXRoO1xuICB9XG59O1xuXG5jb21tYW5kcy5wdWxsRm9sZGVyID0gYXN5bmMgZnVuY3Rpb24gKHJlbW90ZVBhdGgpIHtcbiAgaWYgKCFyZW1vdGVQYXRoLmVuZHNXaXRoKCcvJykpIHtcbiAgICByZW1vdGVQYXRoID0gYCR7cmVtb3RlUGF0aH0vYDtcbiAgfVxuICByZXR1cm4gdGhpcy5pc1NpbXVsYXRvcigpXG4gICAgPyBhd2FpdCBwdWxsRnJvbVNpbXVsYXRvcih0aGlzLm9wdHMuZGV2aWNlLCByZW1vdGVQYXRoLCBmYWxzZSlcbiAgICA6IGF3YWl0IHB1bGxGcm9tUmVhbERldmljZSh0aGlzLm9wdHMuZGV2aWNlLCByZW1vdGVQYXRoLCBmYWxzZSk7XG59O1xuXG5leHBvcnQgeyBjb21tYW5kcyB9O1xuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
