'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var WDA_RUNNER_BUNDLE_ID = 'com.facebook.WebDriverAgentRunner';
var PROJECT_FILE = 'project.pbxproj';
var XCUICOORDINATE_FILE = 'PrivateHeaders/XCTest/XCUICoordinate.h';
var FBMACROS_FILE = 'WebDriverAgentLib/Utilities/FBMacros.h';
var XCUIAPPLICATION_FILE = 'PrivateHeaders/XCTest/XCUIApplication.h';
var FBSESSION_FILE = 'WebDriverAgentLib/Routing/FBSession.m';

function replaceInFile(file, find, replace) {
  var contents, newContents;
  return _regeneratorRuntime.async(function replaceInFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(file, 'utf-8'));

      case 2:
        contents = context$1$0.sent;
        newContents = contents.replace(find, replace);

        if (!(newContents !== contents)) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(file, newContents, 'utf-8'));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

/**
 * Update WebDriverAgentRunner project bundle ID with newBundleId.
 * This method assumes project file is in the correct state.
 * @param {string} agentPath - Path to the .xcodeproj directory.
 * @param {string} newBundleId the new bundle ID used to update.
 */
function updateProjectFile(agentPath, newBundleId) {
  var projectFilePath;
  return _regeneratorRuntime.async(function updateProjectFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        projectFilePath = agentPath + '/' + PROJECT_FILE;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(projectFilePath, projectFilePath + '.old'));

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(replaceInFile(projectFilePath, new RegExp(WDA_RUNNER_BUNDLE_ID.replace('.', '\.'), 'g'), newBundleId));

      case 6:
        _logger2['default'].debug('Successfully updated \'' + projectFilePath + '\' with bundle id \'' + newBundleId + '\'');
        context$1$0.next = 13;
        break;

      case 9:
        context$1$0.prev = 9;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].debug('Error updating project file: ' + context$1$0.t0.message);
        _logger2['default'].warn('Unable to update project file \'' + projectFilePath + '\' with ' + ('bundle id \'' + newBundleId + '\'. WebDriverAgent may not start'));

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 9]]);
}

/**
 * Reset WebDriverAgentRunner project bundle ID to correct state.
 * @param {string} agentPath - Path to the .xcodeproj directory.
 */
function resetProjectFile(agentPath) {
  var projectFilePath;
  return _regeneratorRuntime.async(function resetProjectFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        projectFilePath = agentPath + '/' + PROJECT_FILE;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(projectFilePath + '.old'));

      case 4:
        if (context$1$0.sent) {
          context$1$0.next = 6;
          break;
        }

        return context$1$0.abrupt('return');

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mv(projectFilePath + '.old', projectFilePath));

      case 8:
        _logger2['default'].debug('Successfully reset \'' + projectFilePath + '\' with bundle id \'' + WDA_RUNNER_BUNDLE_ID + '\'');
        context$1$0.next = 15;
        break;

      case 11:
        context$1$0.prev = 11;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].debug('Error resetting project file: ' + context$1$0.t0.message);
        _logger2['default'].warn('Unable to reset project file \'' + projectFilePath + '\' with ' + ('bundle id \'' + WDA_RUNNER_BUNDLE_ID + '\'. WebDriverAgent has been ') + 'modified and not returned to the original state.');

      case 15:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 11]]);
}

function checkForDependencies(bootstrapPath) {
  var useSsl = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];

  var carthagePath, carthageRoot, args, _arr, _i, std, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, line;

  return _regeneratorRuntime.async(function checkForDependencies$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.which('carthage'));

      case 3:
        carthagePath = context$1$0.sent;

        _logger2['default'].debug('Carthage found: \'' + carthagePath + '\'');
        context$1$0.next = 10;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](0);

        _logger2['default'].errorAndThrow('Carthage binary is not found. Install using `brew install carthage` if it is not installed ' + 'and make sure the root folder, where carthage binary is installed, is present in PATH environment variable. ' + ('The current PATH value: \'' + (process.env.PATH ? process.env.PATH : "<not defined for the Appium process>") + '\''));

      case 10:
        carthageRoot = bootstrapPath + '/Carthage';
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(carthageRoot));

      case 13:
        if (context$1$0.sent) {
          context$1$0.next = 60;
          break;
        }

        _logger2['default'].debug('Running WebDriverAgent bootstrap script to install dependencies');
        context$1$0.prev = 15;
        args = useSsl ? ['-d', '-D'] : ['-d'];
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('Scripts/bootstrap.sh', args, { cwd: bootstrapPath }));

      case 19:
        context$1$0.next = 60;
        break;

      case 21:
        context$1$0.prev = 21;
        context$1$0.t1 = context$1$0['catch'](15);
        _arr = ['stdout', 'stderr'];
        _i = 0;

      case 25:
        if (!(_i < _arr.length)) {
          context$1$0.next = 57;
          break;
        }

        std = _arr[_i];
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 30;
        _iterator = _getIterator((context$1$0.t1[std] || '').split('\n'));

      case 32:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 40;
          break;
        }

        line = _step.value;

        if (line.length) {
          context$1$0.next = 36;
          break;
        }

        return context$1$0.abrupt('continue', 37);

      case 36:
        _logger2['default'].error(line);

      case 37:
        _iteratorNormalCompletion = true;
        context$1$0.next = 32;
        break;

      case 40:
        context$1$0.next = 46;
        break;

      case 42:
        context$1$0.prev = 42;
        context$1$0.t2 = context$1$0['catch'](30);
        _didIteratorError = true;
        _iteratorError = context$1$0.t2;

      case 46:
        context$1$0.prev = 46;
        context$1$0.prev = 47;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 49:
        context$1$0.prev = 49;

        if (!_didIteratorError) {
          context$1$0.next = 52;
          break;
        }

        throw _iteratorError;

      case 52:
        return context$1$0.finish(49);

      case 53:
        return context$1$0.finish(46);

      case 54:
        _i++;
        context$1$0.next = 25;
        break;

      case 57:
        context$1$0.next = 59;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(carthageRoot));

      case 59:
        throw context$1$0.t1;

      case 60:
        context$1$0.next = 62;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(bootstrapPath + '/Resources'));

      case 62:
        if (context$1$0.sent) {
          context$1$0.next = 66;
          break;
        }

        _logger2['default'].debug('Creating WebDriverAgent resources directory');
        context$1$0.next = 66;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(bootstrapPath + '/Resources'));

      case 66:
        context$1$0.next = 68;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(bootstrapPath + '/Resources/WebDriverAgent.bundle'));

      case 68:
        if (context$1$0.sent) {
          context$1$0.next = 72;
          break;
        }

        _logger2['default'].debug('Creating WebDriverAgent resource bundle directory');
        context$1$0.next = 72;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(bootstrapPath + '/Resources/WebDriverAgent.bundle'));

      case 72:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 7], [15, 21], [30, 42, 46, 54], [47,, 49, 53]]);
}

function setRealDeviceSecurity(keychainPath, keychainPassword) {
  return _regeneratorRuntime.async(function setRealDeviceSecurity$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Setting security for iOS device');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['-v', 'list-keychains', '-s', keychainPath]));

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['-v', 'unlock-keychain', '-p', keychainPassword, keychainPath]));

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('security', ['set-keychain-settings', '-t', '3600', '-l', keychainPath]));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function fixXCUICoordinateFile(bootstrapPath) {
  var initial = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

  var file, oldDef, newDef, _ref;

  return _regeneratorRuntime.async(function fixXCUICoordinateFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        file = _path2['default'].resolve(bootstrapPath, XCUICOORDINATE_FILE);
        oldDef = '- (void)pressForDuration:(double)arg1 thenDragToCoordinate:(id)arg2;';
        newDef = '- (void)pressForDuration:(NSTimeInterval)duration thenDragToCoordinate:(XCUICoordinate *)otherCoordinate;';

        if (!initial) {
          _ref = [newDef, oldDef];
          oldDef = _ref[0];
          newDef = _ref[1];
        }
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(replaceInFile(file, oldDef, newDef));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function fixFBSessionFile(bootstrapPath) {
  var initial = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

  var file, oldLine, newLine, _ref2;

  return _regeneratorRuntime.async(function fixFBSessionFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        file = _path2['default'].resolve(bootstrapPath, FBSESSION_FILE);
        oldLine = 'return [FBApplication fb_activeApplication] ?: self.testedApplication;';
        newLine = 'FBApplication *application = [FBApplication fb_activeApplication] ?: self.testedApplication;\n' + '  return application;';

        if (!initial) {
          _ref2 = [newLine, oldLine];
          oldLine = _ref2[0];
          newLine = _ref2[1];
        }
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(replaceInFile(file, oldLine, newLine));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function fixForXcode7(bootstrapPath) {
  var initial = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];
  var fixXcode9 = arguments.length <= 2 || arguments[2] === undefined ? true : arguments[2];
  return _regeneratorRuntime.async(function fixForXcode7$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!fixXcode9) {
          context$1$0.next = 3;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(fixForXcode9(bootstrapPath, !initial, false));

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(fixXCUICoordinateFile(bootstrapPath, initial));

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(fixFBSessionFile(bootstrapPath, initial));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function fixFBMacrosFile(bootstrapPath) {
  var initial = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

  var file, oldDef, newDef, _ref3;

  return _regeneratorRuntime.async(function fixFBMacrosFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        file = _path2['default'].resolve(bootstrapPath, FBMACROS_FILE);
        oldDef = '#define FBStringify(class, property) ({if(NO){[class.new property];} @#property;})';
        newDef = '#define FBStringify(class, property) ({@#property;})';

        if (!initial) {
          _ref3 = [newDef, oldDef];
          oldDef = _ref3[0];
          newDef = _ref3[1];
        }
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(replaceInFile(file, oldDef, newDef));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function fixXCUIApplicationFile(bootstrapPath) {
  var initial = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

  var file, oldDef, newDef, _ref4;

  return _regeneratorRuntime.async(function fixXCUIApplicationFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        file = _path2['default'].resolve(bootstrapPath, XCUIAPPLICATION_FILE);
        oldDef = '@property(nonatomic, readonly) NSUInteger state; // @synthesize state=_state;';
        newDef = '@property XCUIApplicationState state;';

        if (!initial) {
          _ref4 = [newDef, oldDef];
          oldDef = _ref4[0];
          newDef = _ref4[1];
        }
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(replaceInFile(file, oldDef, newDef));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function fixForXcode9(bootstrapPath) {
  var initial = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];
  var fixXcode7 = arguments.length <= 2 || arguments[2] === undefined ? true : arguments[2];
  return _regeneratorRuntime.async(function fixForXcode9$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!fixXcode7) {
          context$1$0.next = 3;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(fixForXcode7(bootstrapPath, !initial, false));

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(fixFBMacrosFile(bootstrapPath, initial));

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(fixXCUIApplicationFile(bootstrapPath, initial));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function generateXcodeConfigFile(orgId, signingId) {
  var contents, xcconfigPath;
  return _regeneratorRuntime.async(function generateXcodeConfigFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Generating xcode config file for orgId \'' + orgId + '\' and signingId ' + ('\'' + signingId + '\''));
        contents = 'DEVELOPMENT_TEAM = ' + orgId + '\nCODE_SIGN_IDENTITY = ' + signingId + '\n';
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.path('appium-temp.xcconfig'));

      case 4:
        xcconfigPath = context$1$0.sent;

        _logger2['default'].debug('Writing xcode config file to ' + xcconfigPath);
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(xcconfigPath, contents, "utf8"));

      case 8:
        return context$1$0.abrupt('return', xcconfigPath);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

/**
 * Creates xctestrun file per device & platform version.
 * We expects to have WebDriverAgentRunner_iphoneos${platformVersion}-arm64.xctestrun for real device
 * and WebDriverAgentRunner_iphonesimulator${platformVersion}-x86_64.xctestrun for simulator located @bootstrapPath
 *
 * @param {boolean} isRealDevice - Equals to true if the current device is a real device
 * @param {string} udid - The device UDID.
 * @param {string} platformVersion - The platform version of OS.
 * @param {string} bootstrapPath - The folder path containing xctestrun file.
 * @param {string} wdaRemotePort - The remote port WDA is listening on.
 * @return {string} returns xctestrunFilePath for given device
 * @throws if WebDriverAgentRunner_iphoneos${platformVersion}-arm64.xctestrun for real device
 * or WebDriverAgentRunner_iphonesimulator${platformVersion}-x86_64.xctestrun for simulator is not found @bootstrapPath,
 * then it will throw file not found exception
 */
function setXctestrunFile(isRealDevice, udid, platformVersion, bootstrapPath, wdaRemotePort) {
  var xctestrunDeviceFileName, xctestrunFilePath, xctestBaseFileName, originalXctestrunFile, xctestRunContent, updateWDAPort, newXctestRunContent;
  return _regeneratorRuntime.async(function setXctestrunFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        xctestrunDeviceFileName = udid + '_' + platformVersion + '.xctestrun';
        xctestrunFilePath = _path2['default'].resolve(bootstrapPath, xctestrunDeviceFileName);
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(xctestrunFilePath));

      case 4:
        if (context$1$0.sent) {
          context$1$0.next = 13;
          break;
        }

        xctestBaseFileName = isRealDevice ? 'WebDriverAgentRunner_iphoneos' + platformVersion + '-arm64.xctestrun' : 'WebDriverAgentRunner_iphonesimulator' + platformVersion + '-x86_64.xctestrun';
        originalXctestrunFile = _path2['default'].resolve(bootstrapPath, xctestBaseFileName);
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(originalXctestrunFile));

      case 9:
        if (context$1$0.sent) {
          context$1$0.next = 11;
          break;
        }

        _logger2['default'].errorAndThrow('if you are using useXctestrunFile capability then you need to have ' + originalXctestrunFile + ' file');

      case 11:
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(originalXctestrunFile, xctestrunFilePath));

      case 13:
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(_appiumSupport.plist.parsePlistFile(xctestrunFilePath));

      case 15:
        xctestRunContent = context$1$0.sent;
        updateWDAPort = {
          WebDriverAgentRunner: {
            EnvironmentVariables: {
              USE_PORT: wdaRemotePort
            }
          }
        };
        newXctestRunContent = _lodash2['default'].merge(xctestRunContent, updateWDAPort);
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(_appiumSupport.plist.updatePlistFile(xctestrunFilePath, newXctestRunContent, true));

      case 20:
        return context$1$0.abrupt('return', xctestrunFilePath);

      case 21:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function killProcess(name, proc) {
  return _regeneratorRuntime.async(function killProcess$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(proc && proc.proc)) {
          context$1$0.next = 22;
          break;
        }

        _logger2['default'].info('Shutting down ' + name + ' process (pid ' + proc.proc.pid + ')');
        context$1$0.prev = 2;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(proc.stop('SIGTERM', 1000));

      case 5:
        context$1$0.next = 22;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](2);

        if (!(context$1$0.t0.message.indexOf('Process didn\'t end after') === -1)) {
          context$1$0.next = 11;
          break;
        }

        throw context$1$0.t0;

      case 11:
        _logger2['default'].debug(name + ' process did not end in a timely fashion: \'' + context$1$0.t0.message + '\'. ' + 'Sending \'SIGKILL\'...');
        context$1$0.prev = 12;
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(proc.stop('SIGKILL'));

      case 15:
        context$1$0.next = 22;
        break;

      case 17:
        context$1$0.prev = 17;
        context$1$0.t1 = context$1$0['catch'](12);

        if (!(context$1$0.t1.message.indexOf('not currently running') !== -1)) {
          context$1$0.next = 21;
          break;
        }

        return context$1$0.abrupt('return');

      case 21:
        throw context$1$0.t1;

      case 22:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 7], [12, 17]]);
}

/**
 * Generate a random integer.
 *
 * @return {number} A random integer number in range [low, hight). `low`` is inclusive and `high` is exclusive.
 */
function randomInt(low, high) {
  return Math.floor(Math.random() * (high - low) + low);
}

exports.updateProjectFile = updateProjectFile;
exports.resetProjectFile = resetProjectFile;
exports.checkForDependencies = checkForDependencies;
exports.setRealDeviceSecurity = setRealDeviceSecurity;
exports.fixForXcode7 = fixForXcode7;
exports.fixForXcode9 = fixForXcode9;
exports.generateXcodeConfigFile = generateXcodeConfigFile;
exports.setXctestrunFile = setXctestrunFile;
exports.killProcess = killProcess;
exports.randomInt = randomInt;
exports.WDA_RUNNER_BUNDLE_ID = WDA_RUNNER_BUNDLE_ID;

// Assuming projectFilePath is in the correct state, create .old from projectFilePath

// restore projectFilePath from .old file
// no need to reset

// print out the stdout and stderr reports

// remove the carthage directory, or else subsequent runs will see it and
// assume the dependencies are already downloaded

// the way the updated XCTest headers are in the WDA project, building in
// Xcode 8.0 causes a duplicate declaration of method
// so fix the offending line in the local headers

// If this is first time run for given device, then first generate xctestrun file for device.
// We need to have a xctestrun file per device because we cant not have same wda port for all devices.

// the process ended but for some reason we were not informed
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZGEvdXRpbHMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OzZCQUFtQyxnQkFBZ0I7OzRCQUM5QixjQUFjOztvQkFDbEIsTUFBTTs7OztzQkFDUCxXQUFXOzs7O3NCQUNiLFFBQVE7Ozs7QUFHdEIsSUFBTSxvQkFBb0IsR0FBRyxtQ0FBbUMsQ0FBQztBQUNqRSxJQUFNLFlBQVksR0FBRyxpQkFBaUIsQ0FBQztBQUN2QyxJQUFNLG1CQUFtQixHQUFHLHdDQUF3QyxDQUFDO0FBQ3JFLElBQU0sYUFBYSxHQUFHLHdDQUF3QyxDQUFDO0FBQy9ELElBQU0sb0JBQW9CLEdBQUcseUNBQXlDLENBQUM7QUFDdkUsSUFBTSxjQUFjLEdBQUcsdUNBQXVDLENBQUM7O0FBRS9ELFNBQWUsYUFBYSxDQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsT0FBTztNQUMzQyxRQUFRLEVBRVIsV0FBVzs7Ozs7eUNBRk0sa0JBQUcsUUFBUSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUM7OztBQUEzQyxnQkFBUTtBQUVSLG1CQUFXLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDOztjQUM3QyxXQUFXLEtBQUssUUFBUSxDQUFBOzs7Ozs7eUNBQ3BCLGtCQUFHLFNBQVMsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQzs7Ozs7OztDQUVqRDs7Ozs7Ozs7QUFRRCxTQUFlLGlCQUFpQixDQUFFLFNBQVMsRUFBRSxXQUFXO01BQ2xELGVBQWU7Ozs7QUFBZix1QkFBZSxHQUFNLFNBQVMsU0FBSSxZQUFZOzs7eUNBRzFDLGtCQUFHLFFBQVEsQ0FBQyxlQUFlLEVBQUssZUFBZSxVQUFPOzs7O3lDQUN0RCxhQUFhLENBQUMsZUFBZSxFQUFFLElBQUksTUFBTSxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLEVBQUUsV0FBVyxDQUFDOzs7QUFDM0csNEJBQUksS0FBSyw2QkFBMEIsZUFBZSw0QkFBcUIsV0FBVyxRQUFJLENBQUM7Ozs7Ozs7O0FBRXZGLDRCQUFJLEtBQUssbUNBQWlDLGVBQUksT0FBTyxDQUFHLENBQUM7QUFDekQsNEJBQUksSUFBSSxDQUFDLHFDQUFrQyxlQUFlLGtDQUNuQyxXQUFXLHNDQUFpQyxDQUFDLENBQUM7Ozs7Ozs7Q0FFeEU7Ozs7OztBQU1ELFNBQWUsZ0JBQWdCLENBQUUsU0FBUztNQUNwQyxlQUFlOzs7O0FBQWYsdUJBQWUsR0FBTSxTQUFTLFNBQUksWUFBWTs7O3lDQUdyQyxrQkFBRyxNQUFNLENBQUksZUFBZSxVQUFPOzs7Ozs7Ozs7Ozs7eUNBR3hDLGtCQUFHLEVBQUUsQ0FBSSxlQUFlLFdBQVEsZUFBZSxDQUFDOzs7QUFDdEQsNEJBQUksS0FBSywyQkFBd0IsZUFBZSw0QkFBcUIsb0JBQW9CLFFBQUksQ0FBQzs7Ozs7Ozs7QUFFOUYsNEJBQUksS0FBSyxvQ0FBa0MsZUFBSSxPQUFPLENBQUcsQ0FBQztBQUMxRCw0QkFBSSxJQUFJLENBQUMsb0NBQWlDLGVBQWUsa0NBQ2xDLG9CQUFvQixrQ0FBNkIscURBQ2IsQ0FBQyxDQUFDOzs7Ozs7O0NBRWhFOztBQUVELFNBQWUsb0JBQW9CLENBQUUsYUFBYTtNQUFFLE1BQU0seURBQUcsS0FBSzs7TUFFMUQsWUFBWSxFQU9aLFlBQVksRUFJVixJQUFJLFlBSUMsR0FBRyxrRkFDRCxJQUFJOzs7Ozs7O3lDQWhCUSxrQkFBRyxLQUFLLENBQUMsVUFBVSxDQUFDOzs7QUFBekMsb0JBQVk7O0FBQ2hCLDRCQUFJLEtBQUssd0JBQXFCLFlBQVksUUFBSSxDQUFDOzs7Ozs7OztBQUUvQyw0QkFBSSxhQUFhLENBQUMsNkZBQTZGLEdBQzdHLDhHQUE4RyxvQ0FDbEYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsc0NBQXNDLENBQUEsUUFBRyxDQUFDLENBQUM7OztBQUUzRyxvQkFBWSxHQUFNLGFBQWE7O3lDQUMxQixrQkFBRyxTQUFTLENBQUMsWUFBWSxDQUFDOzs7Ozs7OztBQUNuQyw0QkFBSSxLQUFLLENBQUMsaUVBQWlFLENBQUMsQ0FBQzs7QUFFdkUsWUFBSSxHQUFHLE1BQU0sR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQzs7eUNBQ25DLHdCQUFLLHNCQUFzQixFQUFFLElBQUksRUFBRSxFQUFDLEdBQUcsRUFBRSxhQUFhLEVBQUMsQ0FBQzs7Ozs7Ozs7O2VBRzlDLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQzs7Ozs7Ozs7O0FBQTNCLFdBQUc7Ozs7O2lDQUNPLENBQUMsZUFBSSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUEsQ0FBRSxLQUFLLENBQUMsSUFBSSxDQUFDOzs7Ozs7OztBQUFwQyxZQUFJOztZQUNOLElBQUksQ0FBQyxNQUFNOzs7Ozs7OztBQUdoQiw0QkFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozt5Q0FLZCxrQkFBRyxNQUFNLENBQUMsWUFBWSxDQUFDOzs7Ozs7O3lDQUt0QixrQkFBRyxTQUFTLENBQUksYUFBYSxnQkFBYTs7Ozs7Ozs7QUFDbkQsNEJBQUksS0FBSyxDQUFDLDZDQUE2QyxDQUFDLENBQUM7O3lDQUNuRCxrQkFBRyxLQUFLLENBQUksYUFBYSxnQkFBYTs7Ozt5Q0FFbkMsa0JBQUcsU0FBUyxDQUFJLGFBQWEsc0NBQW1DOzs7Ozs7OztBQUN6RSw0QkFBSSxLQUFLLENBQUMsbURBQW1ELENBQUMsQ0FBQzs7eUNBQ3pELGtCQUFHLEtBQUssQ0FBSSxhQUFhLHNDQUFtQzs7Ozs7OztDQUVyRTs7QUFFRCxTQUFlLHFCQUFxQixDQUFFLFlBQVksRUFBRSxnQkFBZ0I7Ozs7QUFDbEUsNEJBQUksS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7O3lDQUN2Qyx3QkFBSyxVQUFVLEVBQUUsQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDOzs7O3lDQUM5RCx3QkFBSyxVQUFVLEVBQUUsQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLFlBQVksQ0FBQyxDQUFDOzs7O3lDQUNqRix3QkFBSyxVQUFVLEVBQUUsQ0FBQyx1QkFBdUIsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQzs7Ozs7OztDQUNwRjs7QUFFRCxTQUFlLHFCQUFxQixDQUFFLGFBQWE7TUFBRSxPQUFPLHlEQUFHLElBQUk7O01BSTNELElBQUksRUFFTixNQUFNLEVBQ04sTUFBTTs7Ozs7QUFISixZQUFJLEdBQUcsa0JBQUssT0FBTyxDQUFDLGFBQWEsRUFBRSxtQkFBbUIsQ0FBQztBQUV6RCxjQUFNLEdBQUcsc0VBQXNFO0FBQy9FLGNBQU0sR0FBRywyR0FBMkc7O0FBQ3hILFlBQUksQ0FBQyxPQUFPLEVBQUU7aUJBQ08sQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO0FBQWxDLGdCQUFNO0FBQUUsZ0JBQU07U0FDaEI7O3lDQUNLLGFBQWEsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQzs7Ozs7OztDQUMxQzs7QUFFRCxTQUFlLGdCQUFnQixDQUFFLGFBQWE7TUFBRSxPQUFPLHlEQUFHLElBQUk7O01BQ3RELElBQUksRUFFTixPQUFPLEVBQ1AsT0FBTzs7Ozs7QUFITCxZQUFJLEdBQUcsa0JBQUssT0FBTyxDQUFDLGFBQWEsRUFBRSxjQUFjLENBQUM7QUFFcEQsZUFBTyxHQUFHLHdFQUF3RTtBQUNsRixlQUFPLEdBQUcsZ0dBQWdHLEdBQ2hHLHVCQUF1Qjs7QUFDckMsWUFBSSxDQUFDLE9BQU8sRUFBRTtrQkFDUyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUM7QUFBdEMsaUJBQU87QUFBRSxpQkFBTztTQUNsQjs7eUNBQ0ssYUFBYSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDOzs7Ozs7O0NBQzVDOztBQUVELFNBQWUsWUFBWSxDQUFFLGFBQWE7TUFBRSxPQUFPLHlEQUFHLElBQUk7TUFBRSxTQUFTLHlEQUFHLElBQUk7Ozs7YUFDdEUsU0FBUzs7Ozs7O3lDQUNMLFlBQVksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDOzs7O3lDQUU5QyxxQkFBcUIsQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDOzs7O3lDQUM3QyxnQkFBZ0IsQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDOzs7Ozs7O0NBQy9DOztBQUVELFNBQWUsZUFBZSxDQUFFLGFBQWE7TUFBRSxPQUFPLHlEQUFHLElBQUk7O01BQ3JELElBQUksRUFFTixNQUFNLEVBQ04sTUFBTTs7Ozs7QUFISixZQUFJLEdBQUcsa0JBQUssT0FBTyxDQUFDLGFBQWEsRUFBRSxhQUFhLENBQUM7QUFFbkQsY0FBTSxHQUFHLG9GQUFvRjtBQUM3RixjQUFNLEdBQUcsc0RBQXNEOztBQUNuRSxZQUFJLENBQUMsT0FBTyxFQUFFO2tCQUNPLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztBQUFsQyxnQkFBTTtBQUFFLGdCQUFNO1NBQ2hCOzt5Q0FDSyxhQUFhLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUM7Ozs7Ozs7Q0FDMUM7O0FBRUQsU0FBZSxzQkFBc0IsQ0FBRSxhQUFhO01BQUUsT0FBTyx5REFBRyxJQUFJOztNQUM1RCxJQUFJLEVBRU4sTUFBTSxFQUNOLE1BQU07Ozs7O0FBSEosWUFBSSxHQUFHLGtCQUFLLE9BQU8sQ0FBQyxhQUFhLEVBQUUsb0JBQW9CLENBQUM7QUFFMUQsY0FBTSxHQUFHLCtFQUErRTtBQUN4RixjQUFNLEdBQUcsdUNBQXVDOztBQUNwRCxZQUFJLENBQUMsT0FBTyxFQUFFO2tCQUNPLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztBQUFsQyxnQkFBTTtBQUFFLGdCQUFNO1NBQ2hCOzt5Q0FDSyxhQUFhLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUM7Ozs7Ozs7Q0FDMUM7O0FBRUQsU0FBZSxZQUFZLENBQUUsYUFBYTtNQUFFLE9BQU8seURBQUcsSUFBSTtNQUFFLFNBQVMseURBQUcsSUFBSTs7OzthQUN0RSxTQUFTOzs7Ozs7eUNBQ0wsWUFBWSxDQUFDLGFBQWEsRUFBRSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUM7Ozs7eUNBRTlDLGVBQWUsQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDOzs7O3lDQUN2QyxzQkFBc0IsQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDOzs7Ozs7O0NBQ3JEOztBQUVELFNBQWUsdUJBQXVCLENBQUUsS0FBSyxFQUFFLFNBQVM7TUFHbEQsUUFBUSxFQUdSLFlBQVk7Ozs7QUFMaEIsNEJBQUksS0FBSyxDQUFDLDhDQUEyQyxLQUFLLGlDQUM1QyxTQUFTLFFBQUcsQ0FBQyxDQUFDO0FBQ3hCLGdCQUFRLDJCQUF5QixLQUFLLCtCQUNyQixTQUFTOzt5Q0FFTCx1QkFBUSxJQUFJLENBQUMsc0JBQXNCLENBQUM7OztBQUF6RCxvQkFBWTs7QUFDaEIsNEJBQUksS0FBSyxtQ0FBaUMsWUFBWSxDQUFHLENBQUM7O3lDQUNwRCxrQkFBRyxTQUFTLENBQUMsWUFBWSxFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUM7Ozs0Q0FDM0MsWUFBWTs7Ozs7OztDQUNwQjs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkQsU0FBZSxnQkFBZ0IsQ0FBRSxZQUFZLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsYUFBYTtNQUM1Rix1QkFBdUIsRUFDdkIsaUJBQWlCLEVBR2Ysa0JBQWtCLEVBRWxCLHFCQUFxQixFQVN2QixnQkFBZ0IsRUFFaEIsYUFBYSxFQVFiLG1CQUFtQjs7OztBQXpCbkIsK0JBQXVCLEdBQU0sSUFBSSxTQUFJLGVBQWU7QUFDcEQseUJBQWlCLEdBQUcsa0JBQUssT0FBTyxDQUFDLGFBQWEsRUFBRSx1QkFBdUIsQ0FBQzs7eUNBRWpFLGtCQUFHLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQzs7Ozs7Ozs7QUFDakMsMEJBQWtCLEdBQUcsWUFBWSxxQ0FBbUMsZUFBZSxpRUFDOUMsZUFBZSxzQkFBbUI7QUFDdkUsNkJBQXFCLEdBQUcsa0JBQUssT0FBTyxDQUFDLGFBQWEsRUFBRSxrQkFBa0IsQ0FBQzs7eUNBQ2hFLGtCQUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQzs7Ozs7Ozs7QUFDekMsNEJBQUksYUFBYSx5RUFBdUUscUJBQXFCLFdBQVEsQ0FBQzs7Ozt5Q0FJbEgsa0JBQUcsUUFBUSxDQUFDLHFCQUFxQixFQUFFLGlCQUFpQixDQUFDOzs7O3lDQUdoQyxxQkFBTSxjQUFjLENBQUMsaUJBQWlCLENBQUM7OztBQUFoRSx3QkFBZ0I7QUFFaEIscUJBQWEsR0FBRztBQUNsQiw4QkFBb0IsRUFBRTtBQUNwQixnQ0FBb0IsRUFBRTtBQUNwQixzQkFBUSxFQUFFLGFBQWE7YUFDeEI7V0FDRjtTQUNGO0FBRUcsMkJBQW1CLEdBQUcsb0JBQUUsS0FBSyxDQUFDLGdCQUFnQixFQUFFLGFBQWEsQ0FBQzs7eUNBQzVELHFCQUFNLGVBQWUsQ0FBQyxpQkFBaUIsRUFBRSxtQkFBbUIsRUFBRSxJQUFJLENBQUM7Ozs0Q0FFbEUsaUJBQWlCOzs7Ozs7O0NBQ3pCOztBQUVELFNBQWUsV0FBVyxDQUFFLElBQUksRUFBRSxJQUFJOzs7O2NBQ2hDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFBOzs7OztBQUNuQiw0QkFBSSxJQUFJLG9CQUFrQixJQUFJLHNCQUFpQixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsT0FBSSxDQUFDOzs7eUNBRXpELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQzs7Ozs7Ozs7OztjQUU1QixlQUFJLE9BQU8sQ0FBQyxPQUFPLDZCQUE0QixLQUFLLENBQUMsQ0FBQyxDQUFBOzs7Ozs7OztBQUcxRCw0QkFBSSxLQUFLLENBQUMsQUFBRyxJQUFJLG9EQUE4QyxlQUFJLE9BQU8sb0NBQzFDLENBQUMsQ0FBQzs7O3lDQUUxQixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQzs7Ozs7Ozs7OztjQUV0QixlQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsdUJBQXVCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTs7Ozs7Ozs7Ozs7Ozs7O0NBUTlEOzs7Ozs7O0FBT0QsU0FBUyxTQUFTLENBQUUsR0FBRyxFQUFFLElBQUksRUFBRTtBQUM3QixTQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLElBQUksR0FBRyxHQUFHLENBQUEsQUFBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDO0NBQ3ZEOztRQUVRLGlCQUFpQixHQUFqQixpQkFBaUI7UUFBRSxnQkFBZ0IsR0FBaEIsZ0JBQWdCO1FBQUUsb0JBQW9CLEdBQXBCLG9CQUFvQjtRQUN6RCxxQkFBcUIsR0FBckIscUJBQXFCO1FBQUUsWUFBWSxHQUFaLFlBQVk7UUFBRSxZQUFZLEdBQVosWUFBWTtRQUNqRCx1QkFBdUIsR0FBdkIsdUJBQXVCO1FBQUUsZ0JBQWdCLEdBQWhCLGdCQUFnQjtRQUFFLFdBQVcsR0FBWCxXQUFXO1FBQUUsU0FBUyxHQUFULFNBQVM7UUFBRSxvQkFBb0IsR0FBcEIsb0JBQW9CIiwiZmlsZSI6ImxpYi93ZGEvdXRpbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmcywgdGVtcERpciwgcGxpc3QgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5jb25zdCBXREFfUlVOTkVSX0JVTkRMRV9JRCA9ICdjb20uZmFjZWJvb2suV2ViRHJpdmVyQWdlbnRSdW5uZXInO1xuY29uc3QgUFJPSkVDVF9GSUxFID0gJ3Byb2plY3QucGJ4cHJvaic7XG5jb25zdCBYQ1VJQ09PUkRJTkFURV9GSUxFID0gJ1ByaXZhdGVIZWFkZXJzL1hDVGVzdC9YQ1VJQ29vcmRpbmF0ZS5oJztcbmNvbnN0IEZCTUFDUk9TX0ZJTEUgPSAnV2ViRHJpdmVyQWdlbnRMaWIvVXRpbGl0aWVzL0ZCTWFjcm9zLmgnO1xuY29uc3QgWENVSUFQUExJQ0FUSU9OX0ZJTEUgPSAnUHJpdmF0ZUhlYWRlcnMvWENUZXN0L1hDVUlBcHBsaWNhdGlvbi5oJztcbmNvbnN0IEZCU0VTU0lPTl9GSUxFID0gJ1dlYkRyaXZlckFnZW50TGliL1JvdXRpbmcvRkJTZXNzaW9uLm0nO1xuXG5hc3luYyBmdW5jdGlvbiByZXBsYWNlSW5GaWxlIChmaWxlLCBmaW5kLCByZXBsYWNlKSB7XG4gIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGUsICd1dGYtOCcpO1xuXG4gIGxldCBuZXdDb250ZW50cyA9IGNvbnRlbnRzLnJlcGxhY2UoZmluZCwgcmVwbGFjZSk7XG4gIGlmIChuZXdDb250ZW50cyAhPT0gY29udGVudHMpIHtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoZmlsZSwgbmV3Q29udGVudHMsICd1dGYtOCcpO1xuICB9XG59XG5cbi8qKlxuICogVXBkYXRlIFdlYkRyaXZlckFnZW50UnVubmVyIHByb2plY3QgYnVuZGxlIElEIHdpdGggbmV3QnVuZGxlSWQuXG4gKiBUaGlzIG1ldGhvZCBhc3N1bWVzIHByb2plY3QgZmlsZSBpcyBpbiB0aGUgY29ycmVjdCBzdGF0ZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBhZ2VudFBhdGggLSBQYXRoIHRvIHRoZSAueGNvZGVwcm9qIGRpcmVjdG9yeS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBuZXdCdW5kbGVJZCB0aGUgbmV3IGJ1bmRsZSBJRCB1c2VkIHRvIHVwZGF0ZS5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gdXBkYXRlUHJvamVjdEZpbGUgKGFnZW50UGF0aCwgbmV3QnVuZGxlSWQpIHtcbiAgbGV0IHByb2plY3RGaWxlUGF0aCA9IGAke2FnZW50UGF0aH0vJHtQUk9KRUNUX0ZJTEV9YDtcbiAgdHJ5IHtcbiAgICAvLyBBc3N1bWluZyBwcm9qZWN0RmlsZVBhdGggaXMgaW4gdGhlIGNvcnJlY3Qgc3RhdGUsIGNyZWF0ZSAub2xkIGZyb20gcHJvamVjdEZpbGVQYXRoXG4gICAgYXdhaXQgZnMuY29weUZpbGUocHJvamVjdEZpbGVQYXRoLCBgJHtwcm9qZWN0RmlsZVBhdGh9Lm9sZGApO1xuICAgIGF3YWl0IHJlcGxhY2VJbkZpbGUocHJvamVjdEZpbGVQYXRoLCBuZXcgUmVnRXhwKFdEQV9SVU5ORVJfQlVORExFX0lELnJlcGxhY2UoJy4nLCAnXFwuJyksICdnJyksIG5ld0J1bmRsZUlkKTtcbiAgICBsb2cuZGVidWcoYFN1Y2Nlc3NmdWxseSB1cGRhdGVkICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYnVuZGxlIGlkICcke25ld0J1bmRsZUlkfSdgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmRlYnVnKGBFcnJvciB1cGRhdGluZyBwcm9qZWN0IGZpbGU6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byB1cGRhdGUgcHJvamVjdCBmaWxlICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYCArXG4gICAgICAgICAgICAgYGJ1bmRsZSBpZCAnJHtuZXdCdW5kbGVJZH0nLiBXZWJEcml2ZXJBZ2VudCBtYXkgbm90IHN0YXJ0YCk7XG4gIH1cbn1cblxuLyoqXG4gKiBSZXNldCBXZWJEcml2ZXJBZ2VudFJ1bm5lciBwcm9qZWN0IGJ1bmRsZSBJRCB0byBjb3JyZWN0IHN0YXRlLlxuICogQHBhcmFtIHtzdHJpbmd9IGFnZW50UGF0aCAtIFBhdGggdG8gdGhlIC54Y29kZXByb2ogZGlyZWN0b3J5LlxuICovXG5hc3luYyBmdW5jdGlvbiByZXNldFByb2plY3RGaWxlIChhZ2VudFBhdGgpIHtcbiAgbGV0IHByb2plY3RGaWxlUGF0aCA9IGAke2FnZW50UGF0aH0vJHtQUk9KRUNUX0ZJTEV9YDtcbiAgdHJ5IHtcbiAgICAvLyByZXN0b3JlIHByb2plY3RGaWxlUGF0aCBmcm9tIC5vbGQgZmlsZVxuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKGAke3Byb2plY3RGaWxlUGF0aH0ub2xkYCkpIHtcbiAgICAgIHJldHVybjsgIC8vIG5vIG5lZWQgdG8gcmVzZXRcbiAgICB9XG4gICAgYXdhaXQgZnMubXYoYCR7cHJvamVjdEZpbGVQYXRofS5vbGRgLCBwcm9qZWN0RmlsZVBhdGgpO1xuICAgIGxvZy5kZWJ1ZyhgU3VjY2Vzc2Z1bGx5IHJlc2V0ICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYnVuZGxlIGlkICcke1dEQV9SVU5ORVJfQlVORExFX0lEfSdgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmRlYnVnKGBFcnJvciByZXNldHRpbmcgcHJvamVjdCBmaWxlOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIGxvZy53YXJuKGBVbmFibGUgdG8gcmVzZXQgcHJvamVjdCBmaWxlICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYCArXG4gICAgICAgICAgICAgYGJ1bmRsZSBpZCAnJHtXREFfUlVOTkVSX0JVTkRMRV9JRH0nLiBXZWJEcml2ZXJBZ2VudCBoYXMgYmVlbiBgICtcbiAgICAgICAgICAgICBgbW9kaWZpZWQgYW5kIG5vdCByZXR1cm5lZCB0byB0aGUgb3JpZ2luYWwgc3RhdGUuYCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tGb3JEZXBlbmRlbmNpZXMgKGJvb3RzdHJhcFBhdGgsIHVzZVNzbCA9IGZhbHNlKSB7XG4gIHRyeSB7XG4gICAgbGV0IGNhcnRoYWdlUGF0aCA9IGF3YWl0IGZzLndoaWNoKCdjYXJ0aGFnZScpO1xuICAgIGxvZy5kZWJ1ZyhgQ2FydGhhZ2UgZm91bmQ6ICcke2NhcnRoYWdlUGF0aH0nYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdDYXJ0aGFnZSBiaW5hcnkgaXMgbm90IGZvdW5kLiBJbnN0YWxsIHVzaW5nIGBicmV3IGluc3RhbGwgY2FydGhhZ2VgIGlmIGl0IGlzIG5vdCBpbnN0YWxsZWQgJyArXG4gICAgICAnYW5kIG1ha2Ugc3VyZSB0aGUgcm9vdCBmb2xkZXIsIHdoZXJlIGNhcnRoYWdlIGJpbmFyeSBpcyBpbnN0YWxsZWQsIGlzIHByZXNlbnQgaW4gUEFUSCBlbnZpcm9ubWVudCB2YXJpYWJsZS4gJyArXG4gICAgICBgVGhlIGN1cnJlbnQgUEFUSCB2YWx1ZTogJyR7cHJvY2Vzcy5lbnYuUEFUSCA/IHByb2Nlc3MuZW52LlBBVEggOiBcIjxub3QgZGVmaW5lZCBmb3IgdGhlIEFwcGl1bSBwcm9jZXNzPlwifSdgKTtcbiAgfVxuICBjb25zdCBjYXJ0aGFnZVJvb3QgPSBgJHtib290c3RyYXBQYXRofS9DYXJ0aGFnZWA7XG4gIGlmICghYXdhaXQgZnMuaGFzQWNjZXNzKGNhcnRoYWdlUm9vdCkpIHtcbiAgICBsb2cuZGVidWcoJ1J1bm5pbmcgV2ViRHJpdmVyQWdlbnQgYm9vdHN0cmFwIHNjcmlwdCB0byBpbnN0YWxsIGRlcGVuZGVuY2llcycpO1xuICAgIHRyeSB7XG4gICAgICBsZXQgYXJncyA9IHVzZVNzbCA/IFsnLWQnLCAnLUQnXSA6IFsnLWQnXTtcbiAgICAgIGF3YWl0IGV4ZWMoJ1NjcmlwdHMvYm9vdHN0cmFwLnNoJywgYXJncywge2N3ZDogYm9vdHN0cmFwUGF0aH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gcHJpbnQgb3V0IHRoZSBzdGRvdXQgYW5kIHN0ZGVyciByZXBvcnRzXG4gICAgICBmb3IgKGxldCBzdGQgb2YgWydzdGRvdXQnLCAnc3RkZXJyJ10pIHtcbiAgICAgICAgZm9yIChsZXQgbGluZSBvZiAoZXJyW3N0ZF0gfHwgJycpLnNwbGl0KCdcXG4nKSkge1xuICAgICAgICAgIGlmICghbGluZS5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBsb2cuZXJyb3IobGluZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIHJlbW92ZSB0aGUgY2FydGhhZ2UgZGlyZWN0b3J5LCBvciBlbHNlIHN1YnNlcXVlbnQgcnVucyB3aWxsIHNlZSBpdCBhbmRcbiAgICAgIC8vIGFzc3VtZSB0aGUgZGVwZW5kZW5jaWVzIGFyZSBhbHJlYWR5IGRvd25sb2FkZWRcbiAgICAgIGF3YWl0IGZzLnJpbXJhZihjYXJ0aGFnZVJvb3QpO1xuXG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG4gIGlmICghYXdhaXQgZnMuaGFzQWNjZXNzKGAke2Jvb3RzdHJhcFBhdGh9L1Jlc291cmNlc2ApKSB7XG4gICAgbG9nLmRlYnVnKCdDcmVhdGluZyBXZWJEcml2ZXJBZ2VudCByZXNvdXJjZXMgZGlyZWN0b3J5Jyk7XG4gICAgYXdhaXQgZnMubWtkaXIoYCR7Ym9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzYCk7XG4gIH1cbiAgaWYgKCFhd2FpdCBmcy5oYXNBY2Nlc3MoYCR7Ym9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzL1dlYkRyaXZlckFnZW50LmJ1bmRsZWApKSB7XG4gICAgbG9nLmRlYnVnKCdDcmVhdGluZyBXZWJEcml2ZXJBZ2VudCByZXNvdXJjZSBidW5kbGUgZGlyZWN0b3J5Jyk7XG4gICAgYXdhaXQgZnMubWtkaXIoYCR7Ym9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzL1dlYkRyaXZlckFnZW50LmJ1bmRsZWApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFJlYWxEZXZpY2VTZWN1cml0eSAoa2V5Y2hhaW5QYXRoLCBrZXljaGFpblBhc3N3b3JkKSB7XG4gIGxvZy5kZWJ1ZygnU2V0dGluZyBzZWN1cml0eSBmb3IgaU9TIGRldmljZScpO1xuICBhd2FpdCBleGVjKCdzZWN1cml0eScsIFsnLXYnLCAnbGlzdC1rZXljaGFpbnMnLCAnLXMnLCBrZXljaGFpblBhdGhdKTtcbiAgYXdhaXQgZXhlYygnc2VjdXJpdHknLCBbJy12JywgJ3VubG9jay1rZXljaGFpbicsICctcCcsIGtleWNoYWluUGFzc3dvcmQsIGtleWNoYWluUGF0aF0pO1xuICBhd2FpdCBleGVjKCdzZWN1cml0eScsIFsnc2V0LWtleWNoYWluLXNldHRpbmdzJywgJy10JywgJzM2MDAnLCAnLWwnLCBrZXljaGFpblBhdGhdKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4WENVSUNvb3JkaW5hdGVGaWxlIChib290c3RyYXBQYXRoLCBpbml0aWFsID0gdHJ1ZSkge1xuICAvLyB0aGUgd2F5IHRoZSB1cGRhdGVkIFhDVGVzdCBoZWFkZXJzIGFyZSBpbiB0aGUgV0RBIHByb2plY3QsIGJ1aWxkaW5nIGluXG4gIC8vIFhjb2RlIDguMCBjYXVzZXMgYSBkdXBsaWNhdGUgZGVjbGFyYXRpb24gb2YgbWV0aG9kXG4gIC8vIHNvIGZpeCB0aGUgb2ZmZW5kaW5nIGxpbmUgaW4gdGhlIGxvY2FsIGhlYWRlcnNcbiAgY29uc3QgZmlsZSA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBYQ1VJQ09PUkRJTkFURV9GSUxFKTtcblxuICBsZXQgb2xkRGVmID0gJy0gKHZvaWQpcHJlc3NGb3JEdXJhdGlvbjooZG91YmxlKWFyZzEgdGhlbkRyYWdUb0Nvb3JkaW5hdGU6KGlkKWFyZzI7JztcbiAgbGV0IG5ld0RlZiA9ICctICh2b2lkKXByZXNzRm9yRHVyYXRpb246KE5TVGltZUludGVydmFsKWR1cmF0aW9uIHRoZW5EcmFnVG9Db29yZGluYXRlOihYQ1VJQ29vcmRpbmF0ZSAqKW90aGVyQ29vcmRpbmF0ZTsnO1xuICBpZiAoIWluaXRpYWwpIHtcbiAgICBbb2xkRGVmLCBuZXdEZWZdID0gW25ld0RlZiwgb2xkRGVmXTtcbiAgfVxuICBhd2FpdCByZXBsYWNlSW5GaWxlKGZpbGUsIG9sZERlZiwgbmV3RGVmKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4RkJTZXNzaW9uRmlsZSAoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCA9IHRydWUpIHtcbiAgY29uc3QgZmlsZSA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBGQlNFU1NJT05fRklMRSk7XG5cbiAgbGV0IG9sZExpbmUgPSAncmV0dXJuIFtGQkFwcGxpY2F0aW9uIGZiX2FjdGl2ZUFwcGxpY2F0aW9uXSA/OiBzZWxmLnRlc3RlZEFwcGxpY2F0aW9uOyc7XG4gIGxldCBuZXdMaW5lID0gJ0ZCQXBwbGljYXRpb24gKmFwcGxpY2F0aW9uID0gW0ZCQXBwbGljYXRpb24gZmJfYWN0aXZlQXBwbGljYXRpb25dID86IHNlbGYudGVzdGVkQXBwbGljYXRpb247XFxuJyArXG4gICAgICAgICAgICAgICAgJyAgcmV0dXJuIGFwcGxpY2F0aW9uOyc7XG4gIGlmICghaW5pdGlhbCkge1xuICAgIFtvbGRMaW5lLCBuZXdMaW5lXSA9IFtuZXdMaW5lLCBvbGRMaW5lXTtcbiAgfVxuICBhd2FpdCByZXBsYWNlSW5GaWxlKGZpbGUsIG9sZExpbmUsIG5ld0xpbmUpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhGb3JYY29kZTcgKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwgPSB0cnVlLCBmaXhYY29kZTkgPSB0cnVlKSB7XG4gIGlmIChmaXhYY29kZTkpIHtcbiAgICBhd2FpdCBmaXhGb3JYY29kZTkoYm9vdHN0cmFwUGF0aCwgIWluaXRpYWwsIGZhbHNlKTtcbiAgfVxuICBhd2FpdCBmaXhYQ1VJQ29vcmRpbmF0ZUZpbGUoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCk7XG4gIGF3YWl0IGZpeEZCU2Vzc2lvbkZpbGUoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeEZCTWFjcm9zRmlsZSAoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCA9IHRydWUpIHtcbiAgY29uc3QgZmlsZSA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBGQk1BQ1JPU19GSUxFKTtcblxuICBsZXQgb2xkRGVmID0gJyNkZWZpbmUgRkJTdHJpbmdpZnkoY2xhc3MsIHByb3BlcnR5KSAoe2lmKE5PKXtbY2xhc3MubmV3IHByb3BlcnR5XTt9IEAjcHJvcGVydHk7fSknO1xuICBsZXQgbmV3RGVmID0gJyNkZWZpbmUgRkJTdHJpbmdpZnkoY2xhc3MsIHByb3BlcnR5KSAoe0AjcHJvcGVydHk7fSknO1xuICBpZiAoIWluaXRpYWwpIHtcbiAgICBbb2xkRGVmLCBuZXdEZWZdID0gW25ld0RlZiwgb2xkRGVmXTtcbiAgfVxuICBhd2FpdCByZXBsYWNlSW5GaWxlKGZpbGUsIG9sZERlZiwgbmV3RGVmKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4WENVSUFwcGxpY2F0aW9uRmlsZSAoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCA9IHRydWUpIHtcbiAgY29uc3QgZmlsZSA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBYQ1VJQVBQTElDQVRJT05fRklMRSk7XG5cbiAgbGV0IG9sZERlZiA9ICdAcHJvcGVydHkobm9uYXRvbWljLCByZWFkb25seSkgTlNVSW50ZWdlciBzdGF0ZTsgLy8gQHN5bnRoZXNpemUgc3RhdGU9X3N0YXRlOyc7XG4gIGxldCBuZXdEZWYgPSAnQHByb3BlcnR5IFhDVUlBcHBsaWNhdGlvblN0YXRlIHN0YXRlOyc7XG4gIGlmICghaW5pdGlhbCkge1xuICAgIFtvbGREZWYsIG5ld0RlZl0gPSBbbmV3RGVmLCBvbGREZWZdO1xuICB9XG4gIGF3YWl0IHJlcGxhY2VJbkZpbGUoZmlsZSwgb2xkRGVmLCBuZXdEZWYpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhGb3JYY29kZTkgKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwgPSB0cnVlLCBmaXhYY29kZTcgPSB0cnVlKSB7XG4gIGlmIChmaXhYY29kZTcpIHtcbiAgICBhd2FpdCBmaXhGb3JYY29kZTcoYm9vdHN0cmFwUGF0aCwgIWluaXRpYWwsIGZhbHNlKTtcbiAgfVxuICBhd2FpdCBmaXhGQk1hY3Jvc0ZpbGUoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCk7XG4gIGF3YWl0IGZpeFhDVUlBcHBsaWNhdGlvbkZpbGUoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlWGNvZGVDb25maWdGaWxlIChvcmdJZCwgc2lnbmluZ0lkKSB7XG4gIGxvZy5kZWJ1ZyhgR2VuZXJhdGluZyB4Y29kZSBjb25maWcgZmlsZSBmb3Igb3JnSWQgJyR7b3JnSWR9JyBhbmQgc2lnbmluZ0lkIGAgK1xuICAgICAgICAgICAgYCcke3NpZ25pbmdJZH0nYCk7XG4gIGxldCBjb250ZW50cyA9IGBERVZFTE9QTUVOVF9URUFNID0gJHtvcmdJZH1cbkNPREVfU0lHTl9JREVOVElUWSA9ICR7c2lnbmluZ0lkfVxuYDtcbiAgbGV0IHhjY29uZmlnUGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCgnYXBwaXVtLXRlbXAueGNjb25maWcnKTtcbiAgbG9nLmRlYnVnKGBXcml0aW5nIHhjb2RlIGNvbmZpZyBmaWxlIHRvICR7eGNjb25maWdQYXRofWApO1xuICBhd2FpdCBmcy53cml0ZUZpbGUoeGNjb25maWdQYXRoLCBjb250ZW50cywgXCJ1dGY4XCIpO1xuICByZXR1cm4geGNjb25maWdQYXRoO1xufVxuXG4vKipcbiAqIENyZWF0ZXMgeGN0ZXN0cnVuIGZpbGUgcGVyIGRldmljZSAmIHBsYXRmb3JtIHZlcnNpb24uXG4gKiBXZSBleHBlY3RzIHRvIGhhdmUgV2ViRHJpdmVyQWdlbnRSdW5uZXJfaXBob25lb3Mke3BsYXRmb3JtVmVyc2lvbn0tYXJtNjQueGN0ZXN0cnVuIGZvciByZWFsIGRldmljZVxuICogYW5kIFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZXNpbXVsYXRvciR7cGxhdGZvcm1WZXJzaW9ufS14ODZfNjQueGN0ZXN0cnVuIGZvciBzaW11bGF0b3IgbG9jYXRlZCBAYm9vdHN0cmFwUGF0aFxuICpcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNSZWFsRGV2aWNlIC0gRXF1YWxzIHRvIHRydWUgaWYgdGhlIGN1cnJlbnQgZGV2aWNlIGlzIGEgcmVhbCBkZXZpY2VcbiAqIEBwYXJhbSB7c3RyaW5nfSB1ZGlkIC0gVGhlIGRldmljZSBVRElELlxuICogQHBhcmFtIHtzdHJpbmd9IHBsYXRmb3JtVmVyc2lvbiAtIFRoZSBwbGF0Zm9ybSB2ZXJzaW9uIG9mIE9TLlxuICogQHBhcmFtIHtzdHJpbmd9IGJvb3RzdHJhcFBhdGggLSBUaGUgZm9sZGVyIHBhdGggY29udGFpbmluZyB4Y3Rlc3RydW4gZmlsZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSB3ZGFSZW1vdGVQb3J0IC0gVGhlIHJlbW90ZSBwb3J0IFdEQSBpcyBsaXN0ZW5pbmcgb24uXG4gKiBAcmV0dXJuIHtzdHJpbmd9IHJldHVybnMgeGN0ZXN0cnVuRmlsZVBhdGggZm9yIGdpdmVuIGRldmljZVxuICogQHRocm93cyBpZiBXZWJEcml2ZXJBZ2VudFJ1bm5lcl9pcGhvbmVvcyR7cGxhdGZvcm1WZXJzaW9ufS1hcm02NC54Y3Rlc3RydW4gZm9yIHJlYWwgZGV2aWNlXG4gKiBvciBXZWJEcml2ZXJBZ2VudFJ1bm5lcl9pcGhvbmVzaW11bGF0b3Ike3BsYXRmb3JtVmVyc2lvbn0teDg2XzY0LnhjdGVzdHJ1biBmb3Igc2ltdWxhdG9yIGlzIG5vdCBmb3VuZCBAYm9vdHN0cmFwUGF0aCxcbiAqIHRoZW4gaXQgd2lsbCB0aHJvdyBmaWxlIG5vdCBmb3VuZCBleGNlcHRpb25cbiAqL1xuYXN5bmMgZnVuY3Rpb24gc2V0WGN0ZXN0cnVuRmlsZSAoaXNSZWFsRGV2aWNlLCB1ZGlkLCBwbGF0Zm9ybVZlcnNpb24sIGJvb3RzdHJhcFBhdGgsIHdkYVJlbW90ZVBvcnQpIHtcbiAgbGV0IHhjdGVzdHJ1bkRldmljZUZpbGVOYW1lID0gYCR7dWRpZH1fJHtwbGF0Zm9ybVZlcnNpb259LnhjdGVzdHJ1bmA7XG4gIGxldCB4Y3Rlc3RydW5GaWxlUGF0aCA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCB4Y3Rlc3RydW5EZXZpY2VGaWxlTmFtZSk7XG5cbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMoeGN0ZXN0cnVuRmlsZVBhdGgpKSB7XG4gICAgbGV0IHhjdGVzdEJhc2VGaWxlTmFtZSA9IGlzUmVhbERldmljZSA/IGBXZWJEcml2ZXJBZ2VudFJ1bm5lcl9pcGhvbmVvcyR7cGxhdGZvcm1WZXJzaW9ufS1hcm02NC54Y3Rlc3RydW5gIDpcbiAgICAgIGBXZWJEcml2ZXJBZ2VudFJ1bm5lcl9pcGhvbmVzaW11bGF0b3Ike3BsYXRmb3JtVmVyc2lvbn0teDg2XzY0LnhjdGVzdHJ1bmA7XG4gICAgbGV0IG9yaWdpbmFsWGN0ZXN0cnVuRmlsZSA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCB4Y3Rlc3RCYXNlRmlsZU5hbWUpO1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKG9yaWdpbmFsWGN0ZXN0cnVuRmlsZSkpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBpZiB5b3UgYXJlIHVzaW5nIHVzZVhjdGVzdHJ1bkZpbGUgY2FwYWJpbGl0eSB0aGVuIHlvdSBuZWVkIHRvIGhhdmUgJHtvcmlnaW5hbFhjdGVzdHJ1bkZpbGV9IGZpbGVgKTtcbiAgICB9XG4gICAgLy8gSWYgdGhpcyBpcyBmaXJzdCB0aW1lIHJ1biBmb3IgZ2l2ZW4gZGV2aWNlLCB0aGVuIGZpcnN0IGdlbmVyYXRlIHhjdGVzdHJ1biBmaWxlIGZvciBkZXZpY2UuXG4gICAgLy8gV2UgbmVlZCB0byBoYXZlIGEgeGN0ZXN0cnVuIGZpbGUgcGVyIGRldmljZSBiZWNhdXNlIHdlIGNhbnQgbm90IGhhdmUgc2FtZSB3ZGEgcG9ydCBmb3IgYWxsIGRldmljZXMuXG4gICAgYXdhaXQgZnMuY29weUZpbGUob3JpZ2luYWxYY3Rlc3RydW5GaWxlLCB4Y3Rlc3RydW5GaWxlUGF0aCk7XG4gIH1cblxuICBsZXQgeGN0ZXN0UnVuQ29udGVudCA9IGF3YWl0IHBsaXN0LnBhcnNlUGxpc3RGaWxlKHhjdGVzdHJ1bkZpbGVQYXRoKTtcblxuICBsZXQgdXBkYXRlV0RBUG9ydCA9IHtcbiAgICBXZWJEcml2ZXJBZ2VudFJ1bm5lcjoge1xuICAgICAgRW52aXJvbm1lbnRWYXJpYWJsZXM6IHtcbiAgICAgICAgVVNFX1BPUlQ6IHdkYVJlbW90ZVBvcnRcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgbGV0IG5ld1hjdGVzdFJ1bkNvbnRlbnQgPSBfLm1lcmdlKHhjdGVzdFJ1bkNvbnRlbnQsIHVwZGF0ZVdEQVBvcnQpO1xuICBhd2FpdCBwbGlzdC51cGRhdGVQbGlzdEZpbGUoeGN0ZXN0cnVuRmlsZVBhdGgsIG5ld1hjdGVzdFJ1bkNvbnRlbnQsIHRydWUpO1xuXG4gIHJldHVybiB4Y3Rlc3RydW5GaWxlUGF0aDtcbn1cblxuYXN5bmMgZnVuY3Rpb24ga2lsbFByb2Nlc3MgKG5hbWUsIHByb2MpIHtcbiAgaWYgKHByb2MgJiYgcHJvYy5wcm9jKSB7XG4gICAgbG9nLmluZm8oYFNodXR0aW5nIGRvd24gJHtuYW1lfSBwcm9jZXNzIChwaWQgJHtwcm9jLnByb2MucGlkfSlgKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcHJvYy5zdG9wKCdTSUdURVJNJywgMTAwMCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZihgUHJvY2VzcyBkaWRuJ3QgZW5kIGFmdGVyYCkgPT09IC0xKSB7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhgJHtuYW1lfSBwcm9jZXNzIGRpZCBub3QgZW5kIGluIGEgdGltZWx5IGZhc2hpb246ICcke2Vyci5tZXNzYWdlfScuIGAgK1xuICAgICAgICAgICAgICAgIGBTZW5kaW5nICdTSUdLSUxMJy4uLmApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgcHJvYy5zdG9wKCdTSUdLSUxMJyk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgaWYgKGVyci5tZXNzYWdlLmluZGV4T2YoJ25vdCBjdXJyZW50bHkgcnVubmluZycpICE9PSAtMSkge1xuICAgICAgICAgIC8vIHRoZSBwcm9jZXNzIGVuZGVkIGJ1dCBmb3Igc29tZSByZWFzb24gd2Ugd2VyZSBub3QgaW5mb3JtZWRcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIEdlbmVyYXRlIGEgcmFuZG9tIGludGVnZXIuXG4gKlxuICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSBpbnRlZ2VyIG51bWJlciBpbiByYW5nZSBbbG93LCBoaWdodCkuIGBsb3dgYCBpcyBpbmNsdXNpdmUgYW5kIGBoaWdoYCBpcyBleGNsdXNpdmUuXG4gKi9cbmZ1bmN0aW9uIHJhbmRvbUludCAobG93LCBoaWdoKSB7XG4gIHJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoaGlnaCAtIGxvdykgKyBsb3cpO1xufVxuXG5leHBvcnQgeyB1cGRhdGVQcm9qZWN0RmlsZSwgcmVzZXRQcm9qZWN0RmlsZSwgY2hlY2tGb3JEZXBlbmRlbmNpZXMsXG4gICAgICAgICBzZXRSZWFsRGV2aWNlU2VjdXJpdHksIGZpeEZvclhjb2RlNywgZml4Rm9yWGNvZGU5LFxuICAgICAgICAgZ2VuZXJhdGVYY29kZUNvbmZpZ0ZpbGUsIHNldFhjdGVzdHJ1bkZpbGUsIGtpbGxQcm9jZXNzLCByYW5kb21JbnQsIFdEQV9SVU5ORVJfQlVORExFX0lEIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
