'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _url2 = require('url');

var _url3 = _interopRequireDefault(_url2);

var _appiumBaseDriver = require('appium-base-driver');

var _appiumSupport = require('appium-support');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _noSessionProxy = require("./no-session-proxy");

var _utils = require('./utils');

var _utils2 = require('../utils');

var _xcodebuild = require('./xcodebuild');

var _xcodebuild2 = _interopRequireDefault(_xcodebuild);

var _iproxy = require('./iproxy');

var _iproxy2 = _interopRequireDefault(_iproxy);

var _teen_process = require('teen_process');

var BOOTSTRAP_PATH = _path2['default'].resolve(__dirname, '..', '..', '..', 'WebDriverAgent');
var WDA_BUNDLE_ID = 'com.apple.test.WebDriverAgentRunner-Runner';
var WDA_LAUNCH_TIMEOUT = 60 * 1000;
var WDA_AGENT_PORT = 8100;
var WDA_BASE_URL = 'http://localhost';

var WebDriverAgent = (function () {
  function WebDriverAgent(xcodeVersion) {
    var args = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    _classCallCheck(this, WebDriverAgent);

    this.xcodeVersion = xcodeVersion;

    this.args = _lodash2['default'].clone(args);

    this.device = args.device;
    this.platformVersion = args.platformVersion;
    this.host = args.host;
    this.realDevice = !!args.realDevice;

    this.setWDAPaths(args.bootstrapPath, args.agentPath);

    this.wdaLocalPort = args.wdaLocalPort;

    this.prebuildWDA = args.prebuildWDA;

    this.webDriverAgentUrl = args.webDriverAgentUrl;

    this.started = false;

    this.wdaConnectionTimeout = args.wdaConnectionTimeout;

    this.useCarthageSsl = _lodash2['default'].isBoolean(args.useCarthageSsl) && args.useCarthageSsl;

    this.useXctestrunFile = args.useXctestrunFile;

    this.xcodebuild = new _xcodebuild2['default'](this.xcodeVersion, this.device, {
      platformVersion: this.platformVersion,
      agentPath: this.agentPath,
      bootstrapPath: this.bootstrapPath,
      realDevice: this.realDevice,
      showXcodeLog: !!args.showXcodeLog,
      xcodeConfigFile: args.xcodeConfigFile,
      xcodeOrgId: args.xcodeOrgId,
      xcodeSigningId: args.xcodeSigningId,
      keychainPath: args.keychainPath,
      keychainPassword: args.keychainPassword,
      useSimpleBuildTest: args.useSimpleBuildTest,
      usePrebuiltWDA: args.usePrebuiltWDA,
      updatedWDABundleId: args.updatedWDABundleId,
      launchTimeout: args.wdaLaunchTimeout || WDA_LAUNCH_TIMEOUT,
      wdaRemotePort: this.realDevice ? WDA_AGENT_PORT : this.wdaLocalPort || WDA_AGENT_PORT,
      useXctestrunFile: this.useXctestrunFile,
      derivedDataPath: args.derivedDataPath,
      mjpegServerPort: args.mjpegServerPort
    });
  }

  _createClass(WebDriverAgent, [{
    key: 'setWDAPaths',
    value: function setWDAPaths(bootstrapPath, agentPath) {
      // allow the user to specify a place for WDA. This is undocumented and
      // only here for the purposes of testing development of WDA
      this.bootstrapPath = bootstrapPath || BOOTSTRAP_PATH;
      _logger2['default'].info('Using WDA path: \'' + this.bootstrapPath + '\'');

      // for backward compatibility we need to be able to specify agentPath too
      this.agentPath = agentPath || _path2['default'].resolve(this.bootstrapPath, 'WebDriverAgent.xcodeproj');
      _logger2['default'].info('Using WDA agent: \'' + this.agentPath + '\'');
    }
  }, {
    key: 'cleanupObsoleteProcesses',
    value: function cleanupObsoleteProcesses() {
      var pids;
      return _regeneratorRuntime.async(function cleanupObsoleteProcesses$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _utils2.getPIDsListeningOnPort)(this.url.port, function (cmdLine) {
              return (cmdLine.includes('/WebDriverAgentRunner') || cmdLine.includes('/iproxy')) && !cmdLine.toLowerCase().includes(_this.device.udid.toLowerCase());
            }));

          case 2:
            pids = context$2$0.sent;

            if (pids.length) {
              context$2$0.next = 6;
              break;
            }

            _logger2['default'].debug('No obsolete cached processes from previous WDA sessions ' + ('listening on port ' + this.url.port + ' have been found'));
            return context$2$0.abrupt('return');

          case 6:

            _logger2['default'].info('Detected ' + pids.length + ' obsolete cached process' + (pids.length === 1 ? '' : 'es') + ' ' + 'from previous WDA sessions. Cleaning up...');
            context$2$0.prev = 7;
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('kill', pids));

          case 10:
            context$2$0.next = 15;
            break;

          case 12:
            context$2$0.prev = 12;
            context$2$0.t0 = context$2$0['catch'](7);

            _logger2['default'].warn('Failed to kill obsolete cached process' + (pids.length === 1 ? '' : 'es') + ' \'' + pids + '\'. ' + ('Original error: ' + context$2$0.t0.message));

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[7, 12]]);
    }

    /**
     * Return boolean if WDA is running or not
     * @return {boolean} True if WDA is running
     * @throws {Error} If there was invalid response code or body
     */
  }, {
    key: 'isRunning',
    value: function isRunning() {
      return _regeneratorRuntime.async(function isRunning$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getStatus());

          case 2:
            return context$2$0.abrupt('return', !!context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Return current running WDA's status like below
     * {
     *   "state": "success",
     *   "os": {
     *     "name": "iOS",
     *     "version": "11.4",
     *     "sdkVersion": "11.3"
     *   },
     *   "ios": {
     *     "simulatorVersion": "11.4",
     *     "ip": "172.254.99.34"
     *   },
     *   "build": {
     *     "time": "Jun 24 2018 17:08:21",
     *     "productBundleIdentifier": "com.facebook.WebDriverAgentRunner"
     *   }
     * }
     *
     * @return {?object} State Object
     * @throws {Error} If there was invalid response code or body
     */
  }, {
    key: 'getStatus',
    value: function getStatus() {
      var noSessionProxy;
      return _regeneratorRuntime.async(function getStatus$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            noSessionProxy = new _noSessionProxy.NoSessionProxy({
              server: this.url.hostname,
              port: this.url.port,
              base: '',
              timeout: 3000
            });
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(noSessionProxy.command('/status', 'GET'));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].debug('WDA is not listening at \'' + this.url.href + '\'');
            return context$2$0.abrupt('return', null);

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 7]]);
    }
  }, {
    key: 'uninstall',
    value: function uninstall() {
      return _regeneratorRuntime.async(function uninstall$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Removing WDA application from device');
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.device.removeApp(WDA_BUNDLE_ID));

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].warn('WebDriverAgent uninstall failed. Perhaps, it is already uninstalled? Original error: ' + JSON.stringify(context$2$0.t0));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }, {
    key: 'launch',
    value: function launch(sessionId) {
      return _regeneratorRuntime.async(function launch$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.webDriverAgentUrl) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].info('Using provided WebdriverAgent at \'' + this.webDriverAgentUrl + '\'');
            this.url = this.webDriverAgentUrl;
            this.setupProxies(sessionId);
            return context$2$0.abrupt('return');

          case 5:

            _logger2['default'].info('Launching WebDriverAgent on the device');

            this.setupProxies(sessionId);

            context$2$0.t0 = !this.useXctestrunFile;

            if (!context$2$0.t0) {
              context$2$0.next = 12;
              break;
            }

            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.agentPath));

          case 11:
            context$2$0.t0 = !context$2$0.sent;

          case 12:
            if (!context$2$0.t0) {
              context$2$0.next = 14;
              break;
            }

            throw new Error('Trying to use WebDriverAgent project at \'' + this.agentPath + '\' but the ' + 'file does not exist');

          case 14:
            if (this.useXctestrunFile) {
              context$2$0.next = 17;
              break;
            }

            context$2$0.next = 17;
            return _regeneratorRuntime.awrap((0, _utils.checkForDependencies)(this.bootstrapPath, this.useCarthageSsl));

          case 17:
            context$2$0.next = 19;
            return _regeneratorRuntime.awrap((0, _utils2.resetXCTestProcesses)(this.device.udid, !this.realDevice, { wdaLocalPort: this.url.port }));

          case 19:
            if (!this.realDevice) {
              context$2$0.next = 23;
              break;
            }

            this.iproxy = new _iproxy2['default'](this.device.udid, this.url.port, WDA_AGENT_PORT);
            context$2$0.next = 23;
            return _regeneratorRuntime.awrap(this.iproxy.start());

          case 23:
            context$2$0.next = 25;
            return _regeneratorRuntime.awrap(this.xcodebuild.init(this.noSessionProxy));

          case 25:
            if (!this.prebuildWDA) {
              context$2$0.next = 28;
              break;
            }

            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(this.xcodebuild.prebuild());

          case 28:
            context$2$0.next = 30;
            return _regeneratorRuntime.awrap(this.xcodebuild.start());

          case 30:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 31:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setupProxies',
    value: function setupProxies(sessionId) {
      var proxyOpts = {
        server: this.url.hostname,
        port: this.url.port,
        base: '',
        timeout: this.wdaConnectionTimeout
      };

      this.jwproxy = new _appiumBaseDriver.JWProxy(proxyOpts);
      this.jwproxy.sessionId = sessionId;
      this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);

      this.noSessionProxy = new _noSessionProxy.NoSessionProxy(proxyOpts);
      this.noSessionProxyReqRes = this.noSessionProxy.proxyReqRes.bind(this.noSessionProxy);
    }
  }, {
    key: 'quit',
    value: function quit() {
      return _regeneratorRuntime.async(function quit$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info('Shutting down sub-processes');

            if (!this.iproxy) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.iproxy.quit());

          case 4:
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.xcodebuild.quit());

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.xcodebuild.reset());

          case 8:

            if (this.jwproxy) {
              this.jwproxy.sessionId = null;
            }

            this.started = false;

            if (!this.args.webDriverAgentUrl) {
              // if we populated the url ourselves (during `setupCaching` call, for instance)
              // then clean that up. If the url was supplied, we want to keep it
              this.webDriverAgentUrl = null;
            }

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'retrieveDerivedDataPath',
    value: function retrieveDerivedDataPath() {
      return _regeneratorRuntime.async(function retrieveDerivedDataPath$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.xcodebuild.retrieveDerivedDataPath());

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Reuse running WDA if it has the same bundle id with updatedWDABundleId.
     * Or reuse it if it has the default id without updatedWDABundleId.
     * Uninstall it if the method faces an exception for the above situation.
     *
     * @param {string} updatedWDABundleId BundleId you'd like to use
     */
  }, {
    key: 'setupCaching',
    value: function setupCaching(updatedWDABundleId) {
      var status, currentAppBundleID, message;
      return _regeneratorRuntime.async(function setupCaching$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getStatus());

          case 2:
            status = context$2$0.sent;
            currentAppBundleID = undefined;

            if (!(!status || !status.build)) {
              context$2$0.next = 7;
              break;
            }

            _logger2['default'].debug('WDA is currently not running');
            return context$2$0.abrupt('return');

          case 7:

            if (_appiumSupport.util.hasValue(status.build.productBundleIdentifier)) {
              currentAppBundleID = status.build.productBundleIdentifier;
            }

            if (!(_appiumSupport.util.hasValue(currentAppBundleID) && _appiumSupport.util.hasValue(updatedWDABundleId) && updatedWDABundleId !== currentAppBundleID)) {
              context$2$0.next = 14;
              break;
            }

            _logger2['default'].info('Will uninstall running WDA since it has different bundle id. The actual value is \'' + currentAppBundleID + '\'.');
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.uninstall());

          case 12:
            context$2$0.next = 23;
            break;

          case 14:
            if (!(_appiumSupport.util.hasValue(currentAppBundleID) && !_appiumSupport.util.hasValue(updatedWDABundleId) && _utils.WDA_RUNNER_BUNDLE_ID !== currentAppBundleID)) {
              context$2$0.next = 20;
              break;
            }

            _logger2['default'].info('Will uninstall running WDA since its bundle id is not equal to the default value ' + _utils.WDA_RUNNER_BUNDLE_ID);
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(this.uninstall());

          case 18:
            context$2$0.next = 23;
            break;

          case 20:
            message = _appiumSupport.util.hasValue(currentAppBundleID) ? 'Will reuse previously cached WDA instance at \'' + this.url.href + '\' with \'' + currentAppBundleID + '\'' : 'Will reuse previously cached WDA instance at \'' + this.url.href + '\'';

            _logger2['default'].info(message + '. Set the wdaLocalPort capability to a value different from ' + this.url.port + ' if this is an undesired behavior.');
            this.webDriverAgentUrl = this.url.href;

          case 23:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'quitAndUninstall',
    value: function quitAndUninstall() {
      return _regeneratorRuntime.async(function quitAndUninstall$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.quit());

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.uninstall());

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'url',
    get: function get() {
      if (!this._url) {
        var port = this.wdaLocalPort || WDA_AGENT_PORT;
        this._url = _url3['default'].parse(WDA_BASE_URL + ':' + port);
      }
      return this._url;
    },
    set: function set(_url) {
      this._url = _url3['default'].parse(_url);
    }
  }, {
    key: 'fullyStarted',
    get: function get() {
      return this.started;
    },
    set: function set() {
      var started = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];

      // before WDA is started we expect errors from iproxy, since it is not
      // communicating with anything yet
      this.started = started;
      if (this.iproxy) {
        this.iproxy.expectIProxyErrors = !started;
      }
    }
  }]);

  return WebDriverAgent;
})();

exports['default'] = WebDriverAgent;
exports.WebDriverAgent = WebDriverAgent;
exports.WDA_BUNDLE_ID = WDA_BUNDLE_ID;
exports.BOOTSTRAP_PATH = BOOTSTRAP_PATH;

// make sure that the WDA dependencies have been built

// We need to provide WDA local port, because it might be occupied with
// iproxy instance initiated by some preceeding run with a real device
// (iproxy instances are not killed on session termination by default)

// Start the xcodebuild process
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZGEvd2ViZHJpdmVyYWdlbnQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7c0JBQWMsUUFBUTs7OztvQkFDTCxNQUFNOzs7O29CQUNQLEtBQUs7Ozs7Z0NBQ0csb0JBQW9COzs2QkFDbkIsZ0JBQWdCOztzQkFDekIsV0FBVzs7Ozs4QkFDSSxvQkFBb0I7O3FCQUNRLFNBQVM7O3NCQUNQLFVBQVU7OzBCQUNoRCxjQUFjOzs7O3NCQUNsQixVQUFVOzs7OzRCQUNSLGNBQWM7O0FBR25DLElBQU0sY0FBYyxHQUFHLGtCQUFLLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztBQUNuRixJQUFNLGFBQWEsR0FBRyw0Q0FBNEMsQ0FBQztBQUNuRSxJQUFNLGtCQUFrQixHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7QUFDckMsSUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDO0FBQzVCLElBQU0sWUFBWSxHQUFHLGtCQUFrQixDQUFDOztJQUdsQyxjQUFjO0FBQ04sV0FEUixjQUFjLENBQ0wsWUFBWSxFQUFhO1FBQVgsSUFBSSx5REFBRyxFQUFFOzswQkFEaEMsY0FBYzs7QUFFaEIsUUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUM7O0FBRWpDLFFBQUksQ0FBQyxJQUFJLEdBQUcsb0JBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDOztBQUUxQixRQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7QUFDMUIsUUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDO0FBQzVDLFFBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztBQUN0QixRQUFJLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDOztBQUVwQyxRQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLEVB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ZXJhZ2VudC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgZnMsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBOb1Nlc3Npb25Qcm94eSB9IGZyb20gXCIuL25vLXNlc3Npb24tcHJveHlcIjtcbmltcG9ydCB7IGNoZWNrRm9yRGVwZW5kZW5jaWVzLCBXREFfUlVOTkVSX0JVTkRMRV9JRCB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgcmVzZXRYQ1Rlc3RQcm9jZXNzZXMsIGdldFBJRHNMaXN0ZW5pbmdPblBvcnQgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgWGNvZGVCdWlsZCBmcm9tICcuL3hjb2RlYnVpbGQnO1xuaW1wb3J0IGlQcm94eSBmcm9tICcuL2lwcm94eSc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcblxuXG5jb25zdCBCT09UU1RSQVBfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICcuLicsICdXZWJEcml2ZXJBZ2VudCcpO1xuY29uc3QgV0RBX0JVTkRMRV9JRCA9ICdjb20uYXBwbGUudGVzdC5XZWJEcml2ZXJBZ2VudFJ1bm5lci1SdW5uZXInO1xuY29uc3QgV0RBX0xBVU5DSF9USU1FT1VUID0gNjAgKiAxMDAwO1xuY29uc3QgV0RBX0FHRU5UX1BPUlQgPSA4MTAwO1xuY29uc3QgV0RBX0JBU0VfVVJMID0gJ2h0dHA6Ly9sb2NhbGhvc3QnO1xuXG5cbmNsYXNzIFdlYkRyaXZlckFnZW50IHtcbiAgY29uc3RydWN0b3IgKHhjb2RlVmVyc2lvbiwgYXJncyA9IHt9KSB7XG4gICAgdGhpcy54Y29kZVZlcnNpb24gPSB4Y29kZVZlcnNpb247XG5cbiAgICB0aGlzLmFyZ3MgPSBfLmNsb25lKGFyZ3MpO1xuXG4gICAgdGhpcy5kZXZpY2UgPSBhcmdzLmRldmljZTtcbiAgICB0aGlzLnBsYXRmb3JtVmVyc2lvbiA9IGFyZ3MucGxhdGZvcm1WZXJzaW9uO1xuICAgIHRoaXMuaG9zdCA9IGFyZ3MuaG9zdDtcbiAgICB0aGlzLnJlYWxEZXZpY2UgPSAhIWFyZ3MucmVhbERldmljZTtcblxuICAgIHRoaXMuc2V0V0RBUGF0aHMoYXJncy5ib290c3RyYXBQYXRoLCBhcmdzLmFnZW50UGF0aCk7XG5cbiAgICB0aGlzLndkYUxvY2FsUG9ydCA9IGFyZ3Mud2RhTG9jYWxQb3J0O1xuXG4gICAgdGhpcy5wcmVidWlsZFdEQSA9IGFyZ3MucHJlYnVpbGRXREE7XG5cbiAgICB0aGlzLndlYkRyaXZlckFnZW50VXJsID0gYXJncy53ZWJEcml2ZXJBZ2VudFVybDtcblxuICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlO1xuXG4gICAgdGhpcy53ZGFDb25uZWN0aW9uVGltZW91dCA9IGFyZ3Mud2RhQ29ubmVjdGlvblRpbWVvdXQ7XG5cbiAgICB0aGlzLnVzZUNhcnRoYWdlU3NsID0gXy5pc0Jvb2xlYW4oYXJncy51c2VDYXJ0aGFnZVNzbCkgJiYgYXJncy51c2VDYXJ0aGFnZVNzbDtcblxuICAgIHRoaXMudXNlWGN0ZXN0cnVuRmlsZSA9IGFyZ3MudXNlWGN0ZXN0cnVuRmlsZTtcblxuICAgIHRoaXMueGNvZGVidWlsZCA9IG5ldyBYY29kZUJ1aWxkKHRoaXMueGNvZGVWZXJzaW9uLCB0aGlzLmRldmljZSwge1xuICAgICAgcGxhdGZvcm1WZXJzaW9uOiB0aGlzLnBsYXRmb3JtVmVyc2lvbixcbiAgICAgIGFnZW50UGF0aDogdGhpcy5hZ2VudFBhdGgsXG4gICAgICBib290c3RyYXBQYXRoOiB0aGlzLmJvb3RzdHJhcFBhdGgsXG4gICAgICByZWFsRGV2aWNlOiB0aGlzLnJlYWxEZXZpY2UsXG4gICAgICBzaG93WGNvZGVMb2c6ICEhYXJncy5zaG93WGNvZGVMb2csXG4gICAgICB4Y29kZUNvbmZpZ0ZpbGU6IGFyZ3MueGNvZGVDb25maWdGaWxlLFxuICAgICAgeGNvZGVPcmdJZDogYXJncy54Y29kZU9yZ0lkLFxuICAgICAgeGNvZGVTaWduaW5nSWQ6IGFyZ3MueGNvZGVTaWduaW5nSWQsXG4gICAgICBrZXljaGFpblBhdGg6IGFyZ3Mua2V5Y2hhaW5QYXRoLFxuICAgICAga2V5Y2hhaW5QYXNzd29yZDogYXJncy5rZXljaGFpblBhc3N3b3JkLFxuICAgICAgdXNlU2ltcGxlQnVpbGRUZXN0OiBhcmdzLnVzZVNpbXBsZUJ1aWxkVGVzdCxcbiAgICAgIHVzZVByZWJ1aWx0V0RBOiBhcmdzLnVzZVByZWJ1aWx0V0RBLFxuICAgICAgdXBkYXRlZFdEQUJ1bmRsZUlkOiBhcmdzLnVwZGF0ZWRXREFCdW5kbGVJZCxcbiAgICAgIGxhdW5jaFRpbWVvdXQ6IGFyZ3Mud2RhTGF1bmNoVGltZW91dCB8fCBXREFfTEFVTkNIX1RJTUVPVVQsXG4gICAgICB3ZGFSZW1vdGVQb3J0OiB0aGlzLnJlYWxEZXZpY2UgPyBXREFfQUdFTlRfUE9SVCA6ICh0aGlzLndkYUxvY2FsUG9ydCB8fCBXREFfQUdFTlRfUE9SVCksXG4gICAgICB1c2VYY3Rlc3RydW5GaWxlOiB0aGlzLnVzZVhjdGVzdHJ1bkZpbGUsXG4gICAgICBkZXJpdmVkRGF0YVBhdGg6IGFyZ3MuZGVyaXZlZERhdGFQYXRoLFxuICAgICAgbWpwZWdTZXJ2ZXJQb3J0OiBhcmdzLm1qcGVnU2VydmVyUG9ydCxcbiAgICB9KTtcbiAgfVxuXG4gIHNldFdEQVBhdGhzIChib290c3RyYXBQYXRoLCBhZ2VudFBhdGgpIHtcbiAgICAvLyBhbGxvdyB0aGUgdXNlciB0byBzcGVjaWZ5IGEgcGxhY2UgZm9yIFdEQS4gVGhpcyBpcyB1bmRvY3VtZW50ZWQgYW5kXG4gICAgLy8gb25seSBoZXJlIGZvciB0aGUgcHVycG9zZXMgb2YgdGVzdGluZyBkZXZlbG9wbWVudCBvZiBXREFcbiAgICB0aGlzLmJvb3RzdHJhcFBhdGggPSBib290c3RyYXBQYXRoIHx8IEJPT1RTVFJBUF9QQVRIO1xuICAgIGxvZy5pbmZvKGBVc2luZyBXREEgcGF0aDogJyR7dGhpcy5ib290c3RyYXBQYXRofSdgKTtcblxuICAgIC8vIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5IHdlIG5lZWQgdG8gYmUgYWJsZSB0byBzcGVjaWZ5IGFnZW50UGF0aCB0b29cbiAgICB0aGlzLmFnZW50UGF0aCA9IGFnZW50UGF0aCB8fCBwYXRoLnJlc29sdmUodGhpcy5ib290c3RyYXBQYXRoLCAnV2ViRHJpdmVyQWdlbnQueGNvZGVwcm9qJyk7XG4gICAgbG9nLmluZm8oYFVzaW5nIFdEQSBhZ2VudDogJyR7dGhpcy5hZ2VudFBhdGh9J2ApO1xuICB9XG5cbiAgYXN5bmMgY2xlYW51cE9ic29sZXRlUHJvY2Vzc2VzICgpIHtcbiAgICBjb25zdCBwaWRzID0gYXdhaXQgZ2V0UElEc0xpc3RlbmluZ09uUG9ydCh0aGlzLnVybC5wb3J0LFxuICAgICAgKGNtZExpbmUpID0+IChjbWRMaW5lLmluY2x1ZGVzKCcvV2ViRHJpdmVyQWdlbnRSdW5uZXInKSB8fCBjbWRMaW5lLmluY2x1ZGVzKCcvaXByb3h5JykpICYmXG4gICAgICAgICFjbWRMaW5lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXModGhpcy5kZXZpY2UudWRpZC50b0xvd2VyQ2FzZSgpKSk7XG4gICAgaWYgKCFwaWRzLmxlbmd0aCkge1xuICAgICAgbG9nLmRlYnVnKGBObyBvYnNvbGV0ZSBjYWNoZWQgcHJvY2Vzc2VzIGZyb20gcHJldmlvdXMgV0RBIHNlc3Npb25zIGAgK1xuICAgICAgICAgICAgICAgIGBsaXN0ZW5pbmcgb24gcG9ydCAke3RoaXMudXJsLnBvcnR9IGhhdmUgYmVlbiBmb3VuZGApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxvZy5pbmZvKGBEZXRlY3RlZCAke3BpZHMubGVuZ3RofSBvYnNvbGV0ZSBjYWNoZWQgcHJvY2VzcyR7cGlkcy5sZW5ndGggPT09IDEgPyAnJyA6ICdlcyd9IGAgK1xuICAgICAgICAgICAgIGBmcm9tIHByZXZpb3VzIFdEQSBzZXNzaW9ucy4gQ2xlYW5pbmcgdXAuLi5gKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZXhlYygna2lsbCcsIHBpZHMpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy53YXJuKGBGYWlsZWQgdG8ga2lsbCBvYnNvbGV0ZSBjYWNoZWQgcHJvY2VzcyR7cGlkcy5sZW5ndGggPT09IDEgPyAnJyA6ICdlcyd9ICcke3BpZHN9Jy4gYCArXG4gICAgICAgICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gYm9vbGVhbiBpZiBXREEgaXMgcnVubmluZyBvciBub3RcbiAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBXREEgaXMgcnVubmluZ1xuICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGludmFsaWQgcmVzcG9uc2UgY29kZSBvciBib2R5XG4gICAqL1xuICBhc3luYyBpc1J1bm5pbmcgKCkge1xuICAgIHJldHVybiAhIShhd2FpdCB0aGlzLmdldFN0YXR1cygpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gY3VycmVudCBydW5uaW5nIFdEQSdzIHN0YXR1cyBsaWtlIGJlbG93XG4gICAqIHtcbiAgICogICBcInN0YXRlXCI6IFwic3VjY2Vzc1wiLFxuICAgKiAgIFwib3NcIjoge1xuICAgKiAgICAgXCJuYW1lXCI6IFwiaU9TXCIsXG4gICAqICAgICBcInZlcnNpb25cIjogXCIxMS40XCIsXG4gICAqICAgICBcInNka1ZlcnNpb25cIjogXCIxMS4zXCJcbiAgICogICB9LFxuICAgKiAgIFwiaW9zXCI6IHtcbiAgICogICAgIFwic2ltdWxhdG9yVmVyc2lvblwiOiBcIjExLjRcIixcbiAgICogICAgIFwiaXBcIjogXCIxNzIuMjU0Ljk5LjM0XCJcbiAgICogICB9LFxuICAgKiAgIFwiYnVpbGRcIjoge1xuICAgKiAgICAgXCJ0aW1lXCI6IFwiSnVuIDI0IDIwMTggMTc6MDg6MjFcIixcbiAgICogICAgIFwicHJvZHVjdEJ1bmRsZUlkZW50aWZpZXJcIjogXCJjb20uZmFjZWJvb2suV2ViRHJpdmVyQWdlbnRSdW5uZXJcIlxuICAgKiAgIH1cbiAgICogfVxuICAgKlxuICAgKiBAcmV0dXJuIHs/b2JqZWN0fSBTdGF0ZSBPYmplY3RcbiAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBpbnZhbGlkIHJlc3BvbnNlIGNvZGUgb3IgYm9keVxuICAgKi9cbiAgYXN5bmMgZ2V0U3RhdHVzICgpIHtcbiAgICBjb25zdCBub1Nlc3Npb25Qcm94eSA9IG5ldyBOb1Nlc3Npb25Qcm94eSh7XG4gICAgICBzZXJ2ZXI6IHRoaXMudXJsLmhvc3RuYW1lLFxuICAgICAgcG9ydDogdGhpcy51cmwucG9ydCxcbiAgICAgIGJhc2U6ICcnLFxuICAgICAgdGltZW91dDogMzAwMCxcbiAgICB9KTtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IG5vU2Vzc2lvblByb3h5LmNvbW1hbmQoJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZGVidWcoYFdEQSBpcyBub3QgbGlzdGVuaW5nIGF0ICcke3RoaXMudXJsLmhyZWZ9J2ApO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdW5pbnN0YWxsICgpIHtcbiAgICBsb2cuZGVidWcoYFJlbW92aW5nIFdEQSBhcHBsaWNhdGlvbiBmcm9tIGRldmljZWApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmRldmljZS5yZW1vdmVBcHAoV0RBX0JVTkRMRV9JRCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLndhcm4oYFdlYkRyaXZlckFnZW50IHVuaW5zdGFsbCBmYWlsZWQuIFBlcmhhcHMsIGl0IGlzIGFscmVhZHkgdW5pbnN0YWxsZWQ/IE9yaWdpbmFsIGVycm9yOiAke0pTT04uc3RyaW5naWZ5KGUpfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGxhdW5jaCAoc2Vzc2lvbklkKSB7XG4gICAgaWYgKHRoaXMud2ViRHJpdmVyQWdlbnRVcmwpIHtcbiAgICAgIGxvZy5pbmZvKGBVc2luZyBwcm92aWRlZCBXZWJkcml2ZXJBZ2VudCBhdCAnJHt0aGlzLndlYkRyaXZlckFnZW50VXJsfSdgKTtcbiAgICAgIHRoaXMudXJsID0gdGhpcy53ZWJEcml2ZXJBZ2VudFVybDtcbiAgICAgIHRoaXMuc2V0dXBQcm94aWVzKHNlc3Npb25JZCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbG9nLmluZm8oJ0xhdW5jaGluZyBXZWJEcml2ZXJBZ2VudCBvbiB0aGUgZGV2aWNlJyk7XG5cbiAgICB0aGlzLnNldHVwUHJveGllcyhzZXNzaW9uSWQpO1xuXG4gICAgaWYgKCF0aGlzLnVzZVhjdGVzdHJ1bkZpbGUgJiYgIWF3YWl0IGZzLmV4aXN0cyh0aGlzLmFnZW50UGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJ5aW5nIHRvIHVzZSBXZWJEcml2ZXJBZ2VudCBwcm9qZWN0IGF0ICcke3RoaXMuYWdlbnRQYXRofScgYnV0IHRoZSBgICtcbiAgICAgICAgICAgICAgICAgICAgICAnZmlsZSBkb2VzIG5vdCBleGlzdCcpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy51c2VYY3Rlc3RydW5GaWxlKSB7XG4gICAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgV0RBIGRlcGVuZGVuY2llcyBoYXZlIGJlZW4gYnVpbHRcbiAgICAgIGF3YWl0IGNoZWNrRm9yRGVwZW5kZW5jaWVzKHRoaXMuYm9vdHN0cmFwUGF0aCwgdGhpcy51c2VDYXJ0aGFnZVNzbCk7XG4gICAgfVxuICAgIC8vIFdlIG5lZWQgdG8gcHJvdmlkZSBXREEgbG9jYWwgcG9ydCwgYmVjYXVzZSBpdCBtaWdodCBiZSBvY2N1cGllZCB3aXRoXG4gICAgLy8gaXByb3h5IGluc3RhbmNlIGluaXRpYXRlZCBieSBzb21lIHByZWNlZWRpbmcgcnVuIHdpdGggYSByZWFsIGRldmljZVxuICAgIC8vIChpcHJveHkgaW5zdGFuY2VzIGFyZSBub3Qga2lsbGVkIG9uIHNlc3Npb24gdGVybWluYXRpb24gYnkgZGVmYXVsdClcbiAgICBhd2FpdCByZXNldFhDVGVzdFByb2Nlc3Nlcyh0aGlzLmRldmljZS51ZGlkLCAhdGhpcy5yZWFsRGV2aWNlLCB7d2RhTG9jYWxQb3J0OiB0aGlzLnVybC5wb3J0fSk7XG5cbiAgICBpZiAodGhpcy5yZWFsRGV2aWNlKSB7XG4gICAgICB0aGlzLmlwcm94eSA9IG5ldyBpUHJveHkodGhpcy5kZXZpY2UudWRpZCwgdGhpcy51cmwucG9ydCwgV0RBX0FHRU5UX1BPUlQpO1xuICAgICAgYXdhaXQgdGhpcy5pcHJveHkuc3RhcnQoKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnhjb2RlYnVpbGQuaW5pdCh0aGlzLm5vU2Vzc2lvblByb3h5KTtcblxuICAgIC8vIFN0YXJ0IHRoZSB4Y29kZWJ1aWxkIHByb2Nlc3NcbiAgICBpZiAodGhpcy5wcmVidWlsZFdEQSkge1xuICAgICAgYXdhaXQgdGhpcy54Y29kZWJ1aWxkLnByZWJ1aWxkKCk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLnhjb2RlYnVpbGQuc3RhcnQoKTtcbiAgfVxuXG4gIHNldHVwUHJveGllcyAoc2Vzc2lvbklkKSB7XG4gICAgY29uc3QgcHJveHlPcHRzID0ge1xuICAgICAgc2VydmVyOiB0aGlzLnVybC5ob3N0bmFtZSxcbiAgICAgIHBvcnQ6IHRoaXMudXJsLnBvcnQsXG4gICAgICBiYXNlOiAnJyxcbiAgICAgIHRpbWVvdXQ6IHRoaXMud2RhQ29ubmVjdGlvblRpbWVvdXQsXG4gICAgfTtcblxuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHByb3h5T3B0cyk7XG4gICAgdGhpcy5qd3Byb3h5LnNlc3Npb25JZCA9IHNlc3Npb25JZDtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy5qd3Byb3h5KTtcblxuICAgIHRoaXMubm9TZXNzaW9uUHJveHkgPSBuZXcgTm9TZXNzaW9uUHJveHkocHJveHlPcHRzKTtcbiAgICB0aGlzLm5vU2Vzc2lvblByb3h5UmVxUmVzID0gdGhpcy5ub1Nlc3Npb25Qcm94eS5wcm94eVJlcVJlcy5iaW5kKHRoaXMubm9TZXNzaW9uUHJveHkpO1xuICB9XG5cbiAgYXN5bmMgcXVpdCAoKSB7XG4gICAgbG9nLmluZm8oJ1NodXR0aW5nIGRvd24gc3ViLXByb2Nlc3NlcycpO1xuXG4gICAgaWYgKHRoaXMuaXByb3h5KSB7XG4gICAgICBhd2FpdCB0aGlzLmlwcm94eS5xdWl0KCk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy54Y29kZWJ1aWxkLnF1aXQoKTtcbiAgICBhd2FpdCB0aGlzLnhjb2RlYnVpbGQucmVzZXQoKTtcblxuICAgIGlmICh0aGlzLmp3cHJveHkpIHtcbiAgICAgIHRoaXMuandwcm94eS5zZXNzaW9uSWQgPSBudWxsO1xuICAgIH1cblxuICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlO1xuXG4gICAgaWYgKCF0aGlzLmFyZ3Mud2ViRHJpdmVyQWdlbnRVcmwpIHtcbiAgICAgIC8vIGlmIHdlIHBvcHVsYXRlZCB0aGUgdXJsIG91cnNlbHZlcyAoZHVyaW5nIGBzZXR1cENhY2hpbmdgIGNhbGwsIGZvciBpbnN0YW5jZSlcbiAgICAgIC8vIHRoZW4gY2xlYW4gdGhhdCB1cC4gSWYgdGhlIHVybCB3YXMgc3VwcGxpZWQsIHdlIHdhbnQgdG8ga2VlcCBpdFxuICAgICAgdGhpcy53ZWJEcml2ZXJBZ2VudFVybCA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgZ2V0IHVybCAoKSB7XG4gICAgaWYgKCF0aGlzLl91cmwpIHtcbiAgICAgIGxldCBwb3J0ID0gdGhpcy53ZGFMb2NhbFBvcnQgfHwgV0RBX0FHRU5UX1BPUlQ7XG4gICAgICB0aGlzLl91cmwgPSB1cmwucGFyc2UoYCR7V0RBX0JBU0VfVVJMfToke3BvcnR9YCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl91cmw7XG4gIH1cblxuICBzZXQgdXJsIChfdXJsKSB7XG4gICAgdGhpcy5fdXJsID0gdXJsLnBhcnNlKF91cmwpO1xuICB9XG5cbiAgZ2V0IGZ1bGx5U3RhcnRlZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhcnRlZDtcbiAgfVxuXG4gIHNldCBmdWxseVN0YXJ0ZWQgKHN0YXJ0ZWQgPSBmYWxzZSkge1xuICAgIC8vIGJlZm9yZSBXREEgaXMgc3RhcnRlZCB3ZSBleHBlY3QgZXJyb3JzIGZyb20gaXByb3h5LCBzaW5jZSBpdCBpcyBub3RcbiAgICAvLyBjb21tdW5pY2F0aW5nIHdpdGggYW55dGhpbmcgeWV0XG4gICAgdGhpcy5zdGFydGVkID0gc3RhcnRlZDtcbiAgICBpZiAodGhpcy5pcHJveHkpIHtcbiAgICAgIHRoaXMuaXByb3h5LmV4cGVjdElQcm94eUVycm9ycyA9ICFzdGFydGVkO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJldHJpZXZlRGVyaXZlZERhdGFQYXRoICgpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy54Y29kZWJ1aWxkLnJldHJpZXZlRGVyaXZlZERhdGFQYXRoKCk7XG4gIH1cblxuICAvKipcbiAgICogUmV1c2UgcnVubmluZyBXREEgaWYgaXQgaGFzIHRoZSBzYW1lIGJ1bmRsZSBpZCB3aXRoIHVwZGF0ZWRXREFCdW5kbGVJZC5cbiAgICogT3IgcmV1c2UgaXQgaWYgaXQgaGFzIHRoZSBkZWZhdWx0IGlkIHdpdGhvdXQgdXBkYXRlZFdEQUJ1bmRsZUlkLlxuICAgKiBVbmluc3RhbGwgaXQgaWYgdGhlIG1ldGhvZCBmYWNlcyBhbiBleGNlcHRpb24gZm9yIHRoZSBhYm92ZSBzaXR1YXRpb24uXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1cGRhdGVkV0RBQnVuZGxlSWQgQnVuZGxlSWQgeW91J2QgbGlrZSB0byB1c2VcbiAgICovXG4gIGFzeW5jIHNldHVwQ2FjaGluZyAodXBkYXRlZFdEQUJ1bmRsZUlkKSB7XG4gICAgY29uc3Qgc3RhdHVzID0gYXdhaXQgdGhpcy5nZXRTdGF0dXMoKTtcbiAgICBsZXQgY3VycmVudEFwcEJ1bmRsZUlEO1xuICAgIGlmICghc3RhdHVzIHx8ICFzdGF0dXMuYnVpbGQpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgV0RBIGlzIGN1cnJlbnRseSBub3QgcnVubmluZ2ApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh1dGlsLmhhc1ZhbHVlKHN0YXR1cy5idWlsZC5wcm9kdWN0QnVuZGxlSWRlbnRpZmllcikpIHtcbiAgICAgIGN1cnJlbnRBcHBCdW5kbGVJRCA9IHN0YXR1cy5idWlsZC5wcm9kdWN0QnVuZGxlSWRlbnRpZmllcjtcbiAgICB9XG5cbiAgICBpZiAodXRpbC5oYXNWYWx1ZShjdXJyZW50QXBwQnVuZGxlSUQpICYmIHV0aWwuaGFzVmFsdWUodXBkYXRlZFdEQUJ1bmRsZUlkKSAmJiB1cGRhdGVkV0RBQnVuZGxlSWQgIT09IGN1cnJlbnRBcHBCdW5kbGVJRCkge1xuICAgICAgbG9nLmluZm8oYFdpbGwgdW5pbnN0YWxsIHJ1bm5pbmcgV0RBIHNpbmNlIGl0IGhhcyBkaWZmZXJlbnQgYnVuZGxlIGlkLiBUaGUgYWN0dWFsIHZhbHVlIGlzICcke2N1cnJlbnRBcHBCdW5kbGVJRH0nLmApO1xuICAgICAgYXdhaXQgdGhpcy51bmluc3RhbGwoKTtcbiAgICB9IGVsc2UgaWYgKHV0aWwuaGFzVmFsdWUoY3VycmVudEFwcEJ1bmRsZUlEKSAmJiAhdXRpbC5oYXNWYWx1ZSh1cGRhdGVkV0RBQnVuZGxlSWQpICYmIFdEQV9SVU5ORVJfQlVORExFX0lEICE9PSBjdXJyZW50QXBwQnVuZGxlSUQpIHtcbiAgICAgIGxvZy5pbmZvKGBXaWxsIHVuaW5zdGFsbCBydW5uaW5nIFdEQSBzaW5jZSBpdHMgYnVuZGxlIGlkIGlzIG5vdCBlcXVhbCB0byB0aGUgZGVmYXVsdCB2YWx1ZSAke1dEQV9SVU5ORVJfQlVORExFX0lEfWApO1xuICAgICAgYXdhaXQgdGhpcy51bmluc3RhbGwoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IHV0aWwuaGFzVmFsdWUoY3VycmVudEFwcEJ1bmRsZUlEKVxuICAgICAgICAgID8gYFdpbGwgcmV1c2UgcHJldmlvdXNseSBjYWNoZWQgV0RBIGluc3RhbmNlIGF0ICcke3RoaXMudXJsLmhyZWZ9JyB3aXRoICcke2N1cnJlbnRBcHBCdW5kbGVJRH0nYFxuICAgICAgICAgIDogYFdpbGwgcmV1c2UgcHJldmlvdXNseSBjYWNoZWQgV0RBIGluc3RhbmNlIGF0ICcke3RoaXMudXJsLmhyZWZ9J2A7XG4gICAgICBsb2cuaW5mbyhgJHttZXNzYWdlfS4gU2V0IHRoZSB3ZGFMb2NhbFBvcnQgY2FwYWJpbGl0eSB0byBhIHZhbHVlIGRpZmZlcmVudCBmcm9tICR7dGhpcy51cmwucG9ydH0gaWYgdGhpcyBpcyBhbiB1bmRlc2lyZWQgYmVoYXZpb3IuYCk7XG4gICAgICB0aGlzLndlYkRyaXZlckFnZW50VXJsID0gdGhpcy51cmwuaHJlZjtcbiAgICB9XG4gIH1cblxuICBhc3luYyBxdWl0QW5kVW5pbnN0YWxsICgpIHtcbiAgICBhd2FpdCB0aGlzLnF1aXQoKTtcbiAgICBhd2FpdCB0aGlzLnVuaW5zdGFsbCgpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFdlYkRyaXZlckFnZW50O1xuZXhwb3J0IHsgV2ViRHJpdmVyQWdlbnQsIFdEQV9CVU5ETEVfSUQsIEJPT1RTVFJBUF9QQVRIIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
