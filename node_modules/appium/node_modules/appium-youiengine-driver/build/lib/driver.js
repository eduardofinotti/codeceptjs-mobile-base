'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _desiredCaps = require('./desired-caps');

var _desiredCaps2 = _interopRequireDefault(_desiredCaps);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _commandsIndex = require('./commands/index');

var _commandsIndex2 = _interopRequireDefault(_commandsIndex);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _asyncbox = require('asyncbox');

// for proxies

var _appiumAndroidDriver = require('appium-android-driver');

var _appiumAndroidDriver2 = _interopRequireDefault(_appiumAndroidDriver);

var _appiumIosDriver = require('appium-ios-driver');

var _appiumIosDriver2 = _interopRequireDefault(_appiumIosDriver);

var _appiumXcuitestDriver = require('appium-xcuitest-driver');

var _appiumXcuitestDriver2 = _interopRequireDefault(_appiumXcuitestDriver);

var _appiumMacDriver = require('appium-mac-driver');

var _appiumMacDriver2 = _interopRequireDefault(_appiumMacDriver);

// Add commands from the following location that should be mapped to existing drivers:
// https://github.com/appium/appium-base-driver/blob/master/lib/mjsonwp/routes.js

var TO_PROXY_COMMON = ['background', 'closeApp', 'getLog', 'getLogTypes', 'getOrientation', 'getStrings', 'launchApp', 'lock', 'removeApp', 'setOrientation'];

var TO_PROXY_IOS_ONLY = ['mobileShake'];

var TO_PROXY_ANDROID_ONLY = ['getNetworkConnection', 'isAppInstalled', 'isLocked', 'longPressKeyCode', 'pressKeyCode', 'setNetworkConnection', 'toggleLocationServices', 'unlock'];

var TO_PROXY_IOS = TO_PROXY_IOS_ONLY.concat(TO_PROXY_COMMON);
var TO_PROXY_ANDROID = TO_PROXY_ANDROID_ONLY.concat(TO_PROXY_COMMON);
var TO_PROXY_MAC = TO_PROXY_COMMON;

var MAX_RETRY_COUNT = 10;
var RETRY_BACKOFF = 3000;

var YouiEngineDriver = (function (_BaseDriver) {
  _inherits(YouiEngineDriver, _BaseDriver);

  _createClass(YouiEngineDriver, [{
    key: 'resetYouiEngine',
    value: function resetYouiEngine() {

      this.ready = false;
      this.socket = null;
      this.locatorStrategies = ['id', 'name', 'class name', 'accessibility id'];
      this.proxydriver = null;
      this.proxyAllowList = '';
    }
  }]);

  function YouiEngineDriver(opts, shouldValidateCaps) {
    _classCallCheck(this, YouiEngineDriver);

    _get(Object.getPrototypeOf(YouiEngineDriver.prototype), 'constructor', this).call(this, opts, shouldValidateCaps);

    this.desiredCapConstraints = _desiredCaps2['default'];
    this.settings = new _appiumBaseDriver.DeviceSettings({ 'TimeDilation': 1, 'SourceTreeFilter': '' }, this.onSettingsUpdate.bind(this));
    this.resetYouiEngine();
  }

  _createClass(YouiEngineDriver, [{
    key: 'validateLocatorStrategy',
    value: function validateLocatorStrategy(strategy) {
      _get(Object.getPrototypeOf(YouiEngineDriver.prototype), 'validateLocatorStrategy', this).call(this, strategy, false);
    }
  }, {
    key: 'createSession',
    value: function createSession(caps) {
      var _ref, _ref2, sessionId, appPlatform;

      return _regeneratorRuntime.async(function createSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(YouiEngineDriver.prototype), 'createSession', this).call(this, caps));

          case 3:
            _ref = context$2$0.sent;
            _ref2 = _slicedToArray(_ref, 1);
            sessionId = _ref2[0];

            if (!(caps.platformName !== null)) {
              context$2$0.next = 24;
              break;
            }

            appPlatform = caps.platformName.toLowerCase();

            if (!(appPlatform === "ios")) {
              context$2$0.next = 13;
              break;
            }

            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.startIOSSession(caps));

          case 11:
            context$2$0.next = 24;
            break;

          case 13:
            if (!(appPlatform === "android")) {
              context$2$0.next = 18;
              break;
            }

            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(this.startAndroidSession(caps));

          case 16:
            context$2$0.next = 24;
            break;

          case 18:
            if (!(appPlatform === "mac")) {
              context$2$0.next = 23;
              break;
            }

            context$2$0.next = 21;
            return _regeneratorRuntime.awrap(this.startMacSession(caps));

          case 21:
            context$2$0.next = 24;
            break;

          case 23:
            if (appPlatform === "yimac") {
              this.startYIMacSession(caps);
            } else if (appPlatform === "yiroku") {
              this.startYIRokuSession(caps);
            } else if (appPlatform === "yitvos") {
              this.startYITVOSSession(caps);
            }

          case 24:
            context$2$0.next = 26;
            return _regeneratorRuntime.awrap(this.connectSocket());

          case 26:
            return context$2$0.abrupt('return', [sessionId, this.opts]);

          case 29:
            context$2$0.prev = 29;
            context$2$0.t0 = context$2$0['catch'](0);
            context$2$0.next = 33;
            return _regeneratorRuntime.awrap(this.deleteSession());

          case 33:
            throw context$2$0.t0;

          case 34:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 29]]);
    }
  }, {
    key: 'onSettingsUpdate',
    value: function onSettingsUpdate(key, value) {
      return _regeneratorRuntime.async(function onSettingsUpdate$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(key === "TimeDilation")) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.setTimeDilation(value));

          case 3:
            context$2$0.next = 8;
            break;

          case 5:
            if (!(key === "SourceTreeFilter")) {
              context$2$0.next = 8;
              break;
            }

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.setSourceTreeFilter(value));

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.ready = false;

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      var appPlatform;
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug("Deleting YouiEngine session");

            if (this.caps.platformName !== null) {
              appPlatform = this.caps.platformName.toLowerCase();

              if (appPlatform === "yimac") {
                this.endYIMacSession(this.caps);
              } else if (appPlatform === "yitvos") {
                this.endYITVOSSession(this.caps);
              }
            }

            if (!(this.proxydriver !== null)) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.proxydriver.deleteSession());

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(YouiEngineDriver.prototype), 'deleteSession', this).call(this));

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.stop());

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'driverShouldDoProxyCmd',
    value: function driverShouldDoProxyCmd(command) {

      if (!this.proxydriver) return false;

      // only allow white listed commands
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = _getIterator(this.proxyAllowList), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          var allowedCommand = _step.value;

          if (allowedCommand === command) {
            return true;
          }
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      return false;
    }
  }, {
    key: 'executeCommand',
    value: function executeCommand(cmd) {
      for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        args[_key - 1] = arguments[_key];
      }

      var _proxydriver, result, _get2;

      return _regeneratorRuntime.async(function executeCommand$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(cmd === 'receiveAsyncResponse')) {
              context$2$0.next = 7;
              break;
            }

            _logger2['default'].debug('Executing YouiEngineDriver response \'' + cmd + '\'');
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.receiveAsyncResponse.apply(this, args));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 7:
            if (!this.ready) {
              context$2$0.next = 20;
              break;
            }

            if (!this.driverShouldDoProxyCmd(cmd)) {
              context$2$0.next = 16;
              break;
            }

            _logger2['default'].debug('Executing proxied WebDriver command \'' + cmd + '\'');

            // There are 2 CommandTimeout (YouiEngineDriver and proxy)
            // Only YouiEngineDriver CommandTimeout is used; Proxy is disabled
            // All proxy commands needs to reset the YouiEngineDriver CommandTimeout
            // Here we manually reset the YouiEngineDriver CommandTimeout for commands that goe to proxy.
            this.clearNewCommandTimeout();
            result = (_proxydriver = this.proxydriver).executeCommand.apply(_proxydriver, [cmd].concat(args));

            this.startNewCommandTimeout(cmd);
            return context$2$0.abrupt('return', result);

          case 16:
            _logger2['default'].debug('Executing YouiEngine WebDriver command \'' + cmd + '\'');
            return context$2$0.abrupt('return', (_get2 = _get(Object.getPrototypeOf(YouiEngineDriver.prototype), 'executeCommand', this)).call.apply(_get2, [this, cmd].concat(args)));

          case 18:
            context$2$0.next = 22;
            break;

          case 20:
            _logger2['default'].debug('Command Error \'' + cmd + '\'');
            throw new _appiumBaseDriver.errors.NoSuchDriverError('Driver is not ready, cannot execute ' + cmd + '.');

          case 22:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'validateDesiredCaps',
    value: function validateDesiredCaps(caps) {
      // check with the base class, and return if it fails
      var res = _get(Object.getPrototypeOf(YouiEngineDriver.prototype), 'validateDesiredCaps', this).call(this, caps);
      if (!res) return res;

      // using a proxy
      if (caps.platformName.toLowerCase() !== 'noproxy') {
        // make sure that the capabilities has youiEngineAppAddress
        if (!caps.youiEngineAppAddress) {
          var msg = 'The desired capabilities must include youiEngineAppAddress';
          _logger2['default'].errorAndThrow(msg);
        }
        // make sure that the capabilities has app
        if (!caps.app) {
          var msg = 'The desired capabilities must include app';
          _logger2['default'].errorAndThrow(msg);
        }

        //Android emulator with proxy
        if (caps.deviceName.toLowerCase() === 'android') {
          if (!caps.avd) {
            var msg = 'The desired capabilities must include avd';
            _logger2['default'].errorAndThrow(msg);
          }
        }
      }

      // finally, return true since the superclass check passed, as did this
      return true;
    }
  }, {
    key: 'setupNewIOSDriver',
    value: function setupNewIOSDriver(caps) {
      var iosArgs, iosdriver, majorVer, capsCopy;
      return _regeneratorRuntime.async(function setupNewIOSDriver$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            iosArgs = {
              javascriptEnabled: true
            };
            iosdriver = new _appiumIosDriver2['default'](iosArgs);

            // If iOS version is 10 or above we need to use XCUITestDriver (and Xcode 8+)
            if (caps.platformVersion) {
              majorVer = caps.platformVersion.toString().split(".")[0];

              if (parseInt(majorVer, 10) >= 10) {
                iosdriver = new _appiumXcuitestDriver2['default'](iosArgs);
              }
            }
            capsCopy = _lodash2['default'].cloneDeep(caps);

            // Disabling the proxy CommandTimeout in the iOS driver since we are now handling it in the YouiEngine Driver
            capsCopy.newCommandTimeout = 0;
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(iosdriver.createSession(capsCopy));

          case 7:
            return context$2$0.abrupt('return', iosdriver);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startIOSSession',
    value: function startIOSSession(caps) {
      return _regeneratorRuntime.async(function startIOSSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info("Starting an IOS proxy session");
            this.proxyAllowList = TO_PROXY_IOS;

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.setupNewIOSDriver(caps));

          case 4:
            this.proxydriver = context$2$0.sent;

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setupNewAndroidDriver',
    value: function setupNewAndroidDriver(caps) {
      var androidArgs, androiddriver, capsCopy;
      return _regeneratorRuntime.async(function setupNewAndroidDriver$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            androidArgs = {
              javascriptEnabled: true
            };
            androiddriver = new _appiumAndroidDriver2['default'](androidArgs);
            capsCopy = _lodash2['default'].cloneDeep(caps);

            // Disabling the proxy CommandTimeout in the Android driver since we are now handling it in the YouiEngine Driver
            capsCopy.newCommandTimeout = 0;

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(androiddriver.createSession(capsCopy));

          case 6:
            return context$2$0.abrupt('return', androiddriver);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startAndroidSession',
    value: function startAndroidSession(caps) {
      return _regeneratorRuntime.async(function startAndroidSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info("Starting an Android proxy session");
            this.proxyAllowList = TO_PROXY_ANDROID;

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.setupNewAndroidDriver(caps));

          case 4:
            this.proxydriver = context$2$0.sent;

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setupNewMacDriver',
    value: function setupNewMacDriver(caps) {
      var macArgs, macdriver, capsCopy;
      return _regeneratorRuntime.async(function setupNewMacDriver$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            macArgs = {
              javascriptEnabled: true
            };
            macdriver = new _appiumMacDriver2['default'](macArgs);
            capsCopy = _lodash2['default'].cloneDeep(caps);

            // Disabling the proxy CommandTimeout in the proxied driver since we are now handling it in the YouiEngine Driver
            capsCopy.newCommandTimeout = 0;

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(macdriver.createSession(capsCopy));

          case 6:
            return context$2$0.abrupt('return', macdriver);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startMacSession',
    value: function startMacSession(caps) {
      return _regeneratorRuntime.async(function startMacSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info("Starting a Mac proxy session");
            this.proxyAllowList = TO_PROXY_MAC;

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.setupNewMacDriver(caps));

          case 4:
            this.proxydriver = context$2$0.sent;

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startYIMacSession',
    value: function startYIMacSession(caps) {
      _logger2['default'].info("Killing app if run");
      var shell = require('shelljs');
      var process_name = caps.app.substring(caps.app.lastIndexOf("/") + 1);
      shell.exec("killall " + process_name);

      _logger2['default'].info("Launching app");
      var spawn = require('child_process').spawn,
          ls = spawn(caps.app);

      //Print Xcode logs (STDOUT)
      ls.stdout.on('data', function (data) {
        if (data != null && caps.showXcodeLog == true) {
          _logger2['default'].debug('Xcode Log Output: ' + data.toString());
        }
      });

      //Print Xcode logs (STDERR)
      ls.stderr.on('data', function (data) {
        if (data != null && caps.showXcodeLog == true) {
          _logger2['default'].debug('Xcode Log Error: ' + data.toString());
        }
      });

      ls.on('exit', function (code) {
        if (code != null && caps.showXcodeLog == true) {
          _logger2['default'].debug('Application exited with code ' + code.toString());
        }
      });
    }
  }, {
    key: 'endYIMacSession',
    value: function endYIMacSession(caps) {
      _logger2['default'].info("Deleting app");
      var shell = require('shelljs');
      var process_name = caps.app.substring(caps.app.lastIndexOf("/") + 1);
      shell.exec("killall " + process_name);
    }
  }, {
    key: 'startYIRokuSession',
    value: function startYIRokuSession(caps) {
      _logger2['default'].info("Launching app");
      var shell = require('shelljs');
      var roku_install_script = "curl -v -# -f -i --user '" + caps.username + ":" + caps.password + "' --digest --progress-bar -F 'mysubmit=Install' -F 'archive=@" + caps.app + "' -F 'passwd=' http://" + caps.youiEngineAppAddress + "/plugin_install | grep '<font color' | sed 's/<font color=\'red\'>//' ";
      shell.exec(roku_install_script);
      //"curl -v -# -f -i --user 'rokudev:youi' --digest --progress-bar -F 'mysubmit=Install' -F 'archive=@/Users/simongranger/Downloads/VideoPlayer.bin' -F 'passwd=' http://10.100.89.245/plugin_install | grep '<font color' | sed 's/<font color=\'red\'>//' "
    }
  }, {
    key: 'startYITVOSSession',
    value: function startYITVOSSession(caps) {
      _logger2['default'].info("Launching app");
      var shell = require('shelljs');
      if (caps.udid) {
        shell.exec("ios-deploy --id " + caps.udid + " --uninstall --justlaunch --bundle " + caps.app);
      } else {
        shell.exec("ios-deploy --uninstall --justlaunch --bundle " + caps.app);
      }
    }
  }, {
    key: 'endYITVOSSession',
    value: function endYITVOSSession(caps) {
      // If multiple apps with our socket are installed, it will connect to the first app installed.
      // For this reason, every app should be uninstalled after running.
      _logger2['default'].info("Deleting app");
      var shell = require('shelljs');
      var bundleid = shell.exec("osascript -e 'id of app \"" + caps.app + "\"'");
      if (caps.udid) {
        shell.exec("ios-deploy --id " + caps.udid + " --uninstall_only --bundle_id " + bundleid);
      } else {
        shell.exec("ios-deploy --uninstall_only --bundle_id " + bundleid);
      }
    }

    // SOCKETS
  }, {
    key: 'connectSocket',
    value: function connectSocket() {
      var retryCount, connected, connectedPromise;
      return _regeneratorRuntime.async(function connectSocket$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            retryCount = 0;
            connected = false;

          case 2:
            if (!(retryCount < MAX_RETRY_COUNT && !connected)) {
              context$2$0.next = 16;
              break;
            }

            if (!(retryCount > 0)) {
              context$2$0.next = 7;
              break;
            }

            _logger2['default'].info("Waiting " + RETRY_BACKOFF / 1000 + " seconds before trying...");
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _asyncbox.sleep)(RETRY_BACKOFF));

          case 7:
            _logger2['default'].info("Attempt #" + (retryCount + 1));

            connectedPromise = new _bluebird2['default'](function (resolve) {
              var net = require('net');

              var HOST = _this.opts.youiEngineAppAddress;
              var PORT = 12345;

              _logger2['default'].info('Connecting to WebDriver: ' + HOST + ':' + PORT);

              _this.socket = new net.Socket();

              // Add an 'error' event handler for the client socket
              _this.socket.on('error', function (ex) {
                _logger2['default'].error(ex);
                _logger2['default'].error('Check that WebDriver is enabled in application, if a device ensure the proper IP address is used.');
                resolve(false);
              });
              // Add a 'close' event handler for the client socket
              _this.socket.on('close', function () {
                _logger2['default'].info('Connection closed');
              });
              // Add a 'timeout' event handler for the client socket
              _this.socket.on('timeout', function () {
                _logger2['default'].error('Connection timed out');
                resolve(false);
              });
              _this.socket.connect(PORT, HOST, function () {
                _logger2['default'].info('Connected');
                resolve(true);
              });
            });

            retryCount++;
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(connectedPromise);

          case 12:
            connected = context$2$0.sent;

            if (!connected && retryCount === MAX_RETRY_COUNT - 1) {
              _logger2['default'].errorAndThrow("Failed to connect " + MAX_RETRY_COUNT + " times. Aborting.");
            }
            context$2$0.next = 2;
            break;

          case 16:
            retryCount = 0;
            this.ready = connected;

          case 18:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // responses to the commands are BINARY
  }, {
    key: 'executeSocketCommand',
    value: function executeSocketCommand(cmd) {
      var cmdPromise;
      return _regeneratorRuntime.async(function executeSocketCommand$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.socket.writable) {
              context$2$0.next = 4;
              break;
            }

            _logger2['default'].info("Socket is not writable. Trying to reconnect.");
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.connectSocket());

          case 4:
            cmdPromise = new _bluebird2['default'](function (resolve) {
              _logger2['default'].debug('COMMAND: ' + cmd);

              var totaldata = [];
              var endMarker = new Buffer("youiend");
              var socketClient = _this2.socket;

              var dataHandler = function dataHandler(data) {

                // determine if this includes an end parker
                // get last few values of buffer
                if (data.length >= endMarker.length) {
                  var dataend = new Buffer(endMarker.length);
                  var startIndex = data.length - endMarker.length;
                  data.copy(dataend, 0, startIndex, startIndex + endMarker.length);
                  //logger.debug('DATAEND' + dataend.toString());
                  if (dataend.equals(endMarker)) {
                    // remove data end
                    var lastData = data.slice(0, startIndex);
                    //logger.debug('LAST DATA: ' + lastData.toString());
                    totaldata.push(lastData);

                    //remove handler
                    socketClient.removeListener('data', dataHandler);

                    // resolve
                    resolve(Buffer.concat(totaldata));
                  } else {
                    totaldata.push(data);
                  }
                }
              };

              socketClient.write(cmd + "\n", "UTF8", function () {
                socketClient.on('data', dataHandler);
              });
            });
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(cmdPromise);

          case 7:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return YouiEngineDriver;
})(_appiumBaseDriver.BaseDriver);

var _iteratorNormalCompletion2 = true;
var _didIteratorError2 = false;
var _iteratorError2 = undefined;

try {

  for (var _iterator2 = _getIterator(_lodash2['default'].toPairs(_commandsIndex2['default'])), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
    var _step2$value = _slicedToArray(_step2.value, 2);

    var cmd = _step2$value[0];
    var fn = _step2$value[1];

    YouiEngineDriver.prototype[cmd] = fn;
  }
} catch (err) {
  _didIteratorError2 = true;
  _iteratorError2 = err;
} finally {
  try {
    if (!_iteratorNormalCompletion2 && _iterator2['return']) {
      _iterator2['return']();
    }
  } finally {
    if (_didIteratorError2) {
      throw _iteratorError2;
    }
  }
}

exports.YouiEngineDriver = YouiEngineDriver;

// setup proxies - if platformName is not empty, make it less case sensitive
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kcml2ZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztnQ0FBbUQsb0JBQW9COzsyQkFDckMsZ0JBQWdCOzs7O3NCQUMvQixVQUFVOzs7OzZCQUNSLGtCQUFrQjs7OztzQkFDekIsUUFBUTs7Ozt3QkFDUixVQUFVOzs7O3dCQUNGLFVBQVU7Ozs7bUNBR04sdUJBQXVCOzs7OytCQUMzQixtQkFBbUI7Ozs7b0NBQ2Qsd0JBQXdCOzs7OytCQUM3QixtQkFBbUI7Ozs7Ozs7QUFPekMsSUFBTSxlQUFlLEdBQUcsQ0FDdEIsWUFBWSxFQUNaLFVBQVUsRUFDVixRQUFRLEVBQ1IsYUFBYSxFQUNiLGdCQUFnQixFQUNoQixZQUFZLEVBQ1osV0FBVyxFQUNYLE1BQU0sRUFDTixXQUFXLEVBQ1gsZ0JBQWdCLENBQ2pCLENBQUM7O0FBRUYsSUFBTSxpQkFBaUIsR0FBRyxDQUN4QixhQUFhLENBQ2QsQ0FBQzs7QUFFRixJQUFNLHFCQUFxQixHQUFHLENBQzVCLHNCQUFzQixFQUN0QixnQkFBZ0IsRUFDaEIsVUFBVSxFQUNWLGtCQUFrQixFQUNsQixjQUFjLEVBQ2Qsc0JBQXNCLEVBQ3RCLHdCQUF3QixFQUN4QixRQUFRLENBQ1QsQ0FBQzs7QUFFRixJQUFNLFlBQVksR0FBRyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDL0QsSUFBTSxnQkFBZ0IsR0FBRyxxQkFBcUIsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDdkUsSUFBTSxZQUFZLEdBQUcsZUFBZSxDQUFDOztBQUVyQyxJQUFNLGVBQWUsR0FBRyxFQUFFLENBQUM7QUFDM0IsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDOztJQUVyQixnQkFBZ0I7WUFBaEIsZ0JBQWdCOztlQUFoQixnQkFBZ0I7O1dBQ0osMkJBQUc7O0FBRWpCLFVBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0FBQ25CLFVBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO0FBQ25CLFVBQUksQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLGtCQUFrQixDQUFDLENBQUM7QUFDMUUsVUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7QUFDeEIsVUFBSSxDQUFDLGNBQWMsR0FBRyxFQUFFLENBQUM7S0FDMUI7OztBQUVXLFdBVlIsZ0JBQWdCLENBVVAsSUFBSSxFQUFFLGtCQUFrQixFQUFFOzBCQVZuQyxnQkFBZ0I7O0FBV2xCLCtCQVhFLGdCQUFnQiw2Q0FXWixJQUFJLEVBQUUsa0JBQWtCLEVBQUU7O0FBRWhDLFFBQUksQ0FBQyxxQkFBcUIsMkJBQXdCLENBQUM7QUFDbkQsUUFBSSxDQUFDLFFBQVEsR0FBRyxxQ0FBbUIsRUFBQyxjQUFjLEVBQUUsQ0FBQyxFQUFFLGtCQUFrQixFQUFFLEVBQUUsRUFBQyxFQUMvQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDakUsUUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0dBRXhCOztlQWxCRyxnQkFBZ0I7O1dBb0JJLGlDQUFDLFFBQVEsRUFBRTtBQUNqQyxpQ0FyQkUsZ0JBQWdCLHlEQXFCWSxRQUFRLEVBQUUsS0FBSyxFQUFFO0tBQ2hEOzs7V0FFbUIsdUJBQUMsSUFBSTt1QkFFaEIsU0FBUyxFQUlSLFdBQVc7Ozs7Ozs7d0VBOUJqQixnQkFBZ0IsK0NBMEI0QixJQUFJOzs7OztBQUEzQyxxQkFBUzs7a0JBR1YsSUFBSSxDQUFDLFlBQVksS0FBSyxJQUFJLENBQUE7Ozs7O0FBQ3hCLHVCQUFXLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUU7O2tCQUM3QyxXQUFXLEtBQUssS0FBSyxDQUFBOzs7Ozs7NkNBQ2pCLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDOzs7Ozs7O2tCQUN2QixXQUFXLEtBQUssU0FBUyxDQUFBOzs7Ozs7NkNBQzVCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUM7Ozs7Ozs7a0JBQzNCLFdBQVcsS0FBSyxLQUFLLENBQUE7Ozs7Ozs2Q0FDeEIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUM7Ozs7Ozs7QUFDM0IsZ0JBQUksV0FBVyxLQUFLLE9BQU8sRUFBRTtBQUNsQyxrQkFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO2FBQzlCLE1BQU0sSUFBSSxXQUFXLEtBQUssUUFBUSxFQUFFO0FBQ25DLGtCQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDL0IsTUFBTSxJQUFJLFdBQVcsS0FBSyxRQUFRLEVBQUU7QUFDbkMsa0JBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUMvQjs7Ozs2Q0FHRyxJQUFJLENBQUMsYUFBYSxFQUFFOzs7Z0RBQ25CLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUM7Ozs7Ozs2Q0FHdkIsSUFBSSxDQUFDLGFBQWEsRUFBRTs7Ozs7Ozs7OztLQUc3Qjs7O1dBRXNCLDBCQUFDLEdBQUcsRUFBRSxLQUFLOzs7O2tCQUM1QixHQUFHLEtBQUssY0FBYyxDQUFBOzs7Ozs7NkNBQ2xCLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDOzs7Ozs7O2tCQUN4QixHQUFHLEtBQUssa0JBQWtCLENBQUE7Ozs7Ozs2Q0FDN0IsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQzs7Ozs7OztLQUV4Qzs7O1dBRVU7Ozs7QUFDVCxnQkFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7Ozs7Ozs7S0FDcEI7OztXQUVtQjtVQUlaLFdBQVc7Ozs7QUFIakIsZ0NBQU8sS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7O0FBRTVDLGdCQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxLQUFLLElBQUksRUFBRTtBQUMvQix5QkFBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRTs7QUFDdEQsa0JBQUksV0FBVyxLQUFLLE9BQU8sRUFBRTtBQUMzQixvQkFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7ZUFDakMsTUFBTSxJQUFJLFdBQVcsS0FBSyxRQUFRLEVBQUU7QUFDbkMsb0JBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7ZUFDbEM7YUFDRjs7a0JBRUcsSUFBSSxDQUFDLFdBQVcsS0FBSyxJQUFJLENBQUE7Ozs7Ozs2Q0FDckIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLEVBQUU7Ozs7d0VBaEZ0QyxnQkFBZ0I7Ozs7NkNBbUZaLElBQUksQ0FBQyxJQUFJLEVBQUU7Ozs7Ozs7S0FDbEI7OztXQUVzQixnQ0FBQyxPQUFPLEVBQUU7O0FBRS9CLFVBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUNuQixPQUFPLEtBQUssQ0FBQzs7Ozs7Ozs7QUFHZiwwQ0FBMkIsSUFBSSxDQUFDLGNBQWMsNEdBQUU7Y0FBdkMsY0FBYzs7QUFDckIsY0FBSSxjQUFjLEtBQUssT0FBTyxFQUFFO0FBQzlCLG1CQUFPLElBQUksQ0FBQztXQUNiO1NBQ0Y7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDRCxhQUFPLEtBQUssQ0FBQztLQUNkOzs7V0FFb0Isd0JBQUMsR0FBRzt3Q0FBSyxJQUFJO0FBQUosWUFBSTs7O3dCQWN4QixNQUFNOzs7OztrQkFiVixHQUFHLEtBQUssc0JBQXNCLENBQUE7Ozs7O0FBQ2hDLGdDQUFPLEtBQUssNENBQXlDLEdBQUcsUUFBSSxDQUFDOzs2Q0FDaEQsSUFBSSxDQUFDLG9CQUFvQixNQUFBLENBQXpCLElBQUksRUFBeUIsSUFBSSxDQUFDOzs7Ozs7aUJBQ3RDLElBQUksQ0FBQyxLQUFLOzs7OztpQkFFZixJQUFJLENBQUMsc0JBQXNCLENBQUMsR0FBRyxDQUFDOzs7OztBQUNsQyxnQ0FBTyxLQUFLLDRDQUF5QyxHQUFHLFFBQUksQ0FBQzs7Ozs7O0FBTTdELGdCQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztBQUMxQixrQkFBTSxHQUFHLGdCQUFBLElBQUksQ0FBQyxXQUFXLEVBQUMsY0FBYyxNQUFBLGdCQUFDLEdBQUcsU0FBSyxJQUFJLEVBQUM7O0FBQzFELGdCQUFJLENBQUMsc0JBQXNCLENBQUMsR0FBRyxDQUFDLENBQUM7Z0RBQzFCLE1BQU07OztBQUViLGdDQUFPLEtBQUssK0NBQTRDLEdBQUcsUUFBSSxDQUFDO29GQXRIbEUsZ0JBQWdCLCtEQXVIYyxHQUFHLFNBQUssSUFBSTs7Ozs7OztBQUcxQyxnQ0FBTyxLQUFLLHNCQUFtQixHQUFHLFFBQUksQ0FBQztrQkFDakMsSUFBSSx5QkFBTyxpQkFBaUIsMENBQXdDLEdBQUcsT0FBSTs7Ozs7OztLQUVwRjs7O1dBRW1CLDZCQUFDLElBQUksRUFBRTs7QUFFekIsVUFBSSxHQUFHLDhCQWpJTCxnQkFBZ0IscURBaUlrQixJQUFJLENBQUMsQ0FBQztBQUMxQyxVQUFJLENBQUMsR0FBRyxFQUFFLE9BQU8sR0FBRyxDQUFDOzs7QUFHckIsVUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxLQUFLLFNBQVMsRUFBRTs7QUFFakQsWUFBSSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRTtBQUM5QixjQUFJLEdBQUcsR0FBRyw0REFBNEQsQ0FBQztBQUN2RSw4QkFBTyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDM0I7O0FBRUQsWUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7QUFDYixjQUFJLEdBQUcsR0FBRywyQ0FBMkMsQ0FBQztBQUN0RCw4QkFBTyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDM0I7OztBQUdELFlBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsS0FBSyxTQUFTLEVBQUU7QUFDL0MsY0FBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7QUFDYixnQkFBSSxHQUFHLEdBQUcsMkNBQTJDLENBQUM7QUFDdEQsZ0NBQU8sYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1dBQzNCO1NBQ0Y7T0FDRjs7O0FBR0QsYUFBTyxJQUFJLENBQUM7S0FDYjs7O1dBRXVCLDJCQUFDLElBQUk7VUFDdkIsT0FBTyxFQUlQLFNBQVMsRUFHUCxRQUFRLEVBS1YsUUFBUTs7OztBQVpSLG1CQUFPLEdBQUc7QUFDWiwrQkFBaUIsRUFBRSxJQUFJO2FBQ3hCO0FBRUcscUJBQVMsR0FBRyxpQ0FBYyxPQUFPLENBQUM7OztBQUV0QyxnQkFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO0FBQ3BCLHNCQUFRLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDOztBQUM1RCxrQkFBSSxRQUFRLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtBQUNoQyx5QkFBUyxHQUFHLHNDQUFtQixPQUFPLENBQUMsQ0FBQztlQUN6QzthQUNGO0FBQ0csb0JBQVEsR0FBRyxvQkFBRSxTQUFTLENBQUMsSUFBSSxDQUFDOzs7QUFFaEMsb0JBQVEsQ0FBQyxpQkFBaUIsR0FBSSxDQUFDLENBQUM7OzZDQUMxQixTQUFTLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQzs7O2dEQUVoQyxTQUFTOzs7Ozs7O0tBQ2pCOzs7V0FFcUIseUJBQUMsSUFBSTs7OztBQUN6QixnQ0FBTyxJQUFJLENBQUMsK0JBQStCLENBQUMsQ0FBQztBQUM3QyxnQkFBSSxDQUFDLGNBQWMsR0FBRyxZQUFZLENBQUM7Ozs2Q0FFVixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDOzs7QUFBckQsZ0JBQUksQ0FBQyxXQUFXOzs7Ozs7O0tBQ2pCOzs7V0FFMkIsK0JBQUMsSUFBSTtVQUMzQixXQUFXLEVBR1gsYUFBYSxFQUNiLFFBQVE7Ozs7QUFKUix1QkFBVyxHQUFHO0FBQ2hCLCtCQUFpQixFQUFFLElBQUk7YUFDeEI7QUFDRyx5QkFBYSxHQUFHLHFDQUFrQixXQUFXLENBQUM7QUFDOUMsb0JBQVEsR0FBRyxvQkFBRSxTQUFTLENBQUMsSUFBSSxDQUFDOzs7QUFFaEMsb0JBQVEsQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLENBQUM7Ozs2Q0FFekIsYUFBYSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUM7OztnREFFcEMsYUFBYTs7Ozs7OztLQUNyQjs7O1dBRXlCLDZCQUFDLElBQUk7Ozs7QUFDN0IsZ0NBQU8sSUFBSSxDQUFDLG1DQUFtQyxDQUFDLENBQUM7QUFDakQsZ0JBQUksQ0FBQyxjQUFjLEdBQUcsZ0JBQWdCLENBQUM7Ozs2Q0FFZCxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDOzs7QUFBekQsZ0JBQUksQ0FBQyxXQUFXOzs7Ozs7O0tBQ2pCOzs7V0FFdUIsMkJBQUMsSUFBSTtVQUN2QixPQUFPLEVBR1AsU0FBUyxFQUNULFFBQVE7Ozs7QUFKUixtQkFBTyxHQUFHO0FBQ1osK0JBQWlCLEVBQUUsSUFBSTthQUN4QjtBQUNHLHFCQUFTLEdBQUcsaUNBQWMsT0FBTyxDQUFDO0FBQ2xDLG9CQUFRLEdBQUcsb0JBQUUsU0FBUyxDQUFDLElBQUksQ0FBQzs7O0FBRWhDLG9CQUFRLENBQUMsaUJBQWlCLEdBQUcsQ0FBQyxDQUFDOzs7NkNBRXpCLFNBQVMsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDOzs7Z0RBRWhDLFNBQVM7Ozs7Ozs7S0FDakI7OztXQUVxQix5QkFBQyxJQUFJOzs7O0FBQ3pCLGdDQUFPLElBQUksQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0FBQzVDLGdCQUFJLENBQUMsY0FBYyxHQUFHLFlBQVksQ0FBQzs7OzZDQUVWLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUM7OztBQUFyRCxnQkFBSSxDQUFDLFdBQVc7Ozs7Ozs7S0FDakI7OztXQUVpQiwyQkFBQyxJQUFJLEVBQUU7QUFDdkIsMEJBQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFDbEMsVUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQy9CLFVBQUksWUFBWSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ3JFLFdBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxHQUFHLFlBQVksQ0FBQyxDQUFDOztBQUV0QywwQkFBTyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDN0IsVUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLEtBQUs7VUFDdEMsRUFBRSxHQUFNLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7OztBQUc1QixRQUFFLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBVSxJQUFJLEVBQUU7QUFDbkMsWUFBRyxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxFQUFDO0FBQzNDLDhCQUFPLEtBQUssQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztTQUN0RDtPQUNGLENBQUMsQ0FBQzs7O0FBR0gsUUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLFVBQVUsSUFBSSxFQUFFO0FBQ25DLFlBQUcsSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksRUFBQztBQUMzQyw4QkFBTyxLQUFLLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7U0FDckQ7T0FDRixDQUFDLENBQUM7O0FBRUgsUUFBRSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBVSxJQUFJLEVBQUU7QUFDNUIsWUFBRyxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxFQUFDO0FBQzNDLDhCQUFPLEtBQUssQ0FBQywrQkFBK0IsR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztTQUNqRTtPQUNGLENBQUMsQ0FBQztLQUNKOzs7V0FFZSx5QkFBQyxJQUFJLEVBQUU7QUFDckIsMEJBQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBQzVCLFVBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUMvQixVQUFJLFlBQVksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUNyRSxXQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxZQUFZLENBQUMsQ0FBQztLQUN2Qzs7O1dBRWtCLDRCQUFDLElBQUksRUFBRTtBQUN4QiwwQkFBTyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDN0IsVUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQy9CLFVBQUksbUJBQW1CLEdBQUcsMkJBQTJCLEdBQUcsSUFBSSxDQUFDLFFBQVEsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFFBQVEsR0FBRywrREFBK0QsR0FBRyxJQUFJLENBQUMsR0FBRyxHQUFHLHdCQUF3QixHQUFHLElBQUksQ0FBQyxvQkFBb0IsR0FBRyx3RUFBd0UsQ0FBQztBQUMzUyxXQUFLLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7O0tBRWpDOzs7V0FFa0IsNEJBQUMsSUFBSSxFQUFFO0FBQ3hCLDBCQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUM3QixVQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDL0IsVUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFO0FBQ2IsYUFBSyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsSUFBSSxHQUFHLHFDQUFxQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztPQUMvRixNQUNJO0FBQ0gsYUFBSyxDQUFDLElBQUksQ0FBQywrQ0FBK0MsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7T0FDeEU7S0FDRjs7O1dBRWdCLDBCQUFDLElBQUksRUFBRTs7O0FBR3RCLDBCQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUM1QixVQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDL0IsVUFBSSxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsR0FBRyxJQUFJLENBQUMsR0FBRyxHQUFHLEtBQUssQ0FBRSxDQUFDO0FBQzVFLFVBQUksSUFBSSxDQUFDLElBQUksRUFBRTtBQUNiLGFBQUssQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxnQ0FBZ0MsR0FBRyxRQUFRLENBQUMsQ0FBQztPQUMxRixNQUNJO0FBQ0gsYUFBSyxDQUFDLElBQUksQ0FBQywwQ0FBMEMsR0FBRyxRQUFRLENBQUMsQ0FBQztPQUNuRTtLQUNGOzs7OztXQUdtQjtVQUVkLFVBQVUsRUFDVixTQUFTLEVBU1AsZ0JBQWdCOzs7Ozs7QUFWbEIsc0JBQVUsR0FBRyxDQUFDO0FBQ2QscUJBQVMsR0FBRyxLQUFLOzs7a0JBQ2QsVUFBVSxHQUFHLGVBQWUsSUFBSSxDQUFDLFNBQVMsQ0FBQTs7Ozs7a0JBRTNDLFVBQVUsR0FBRyxDQUFDLENBQUE7Ozs7O0FBQ2hCLGdDQUFPLElBQUksQ0FBQyxVQUFVLEdBQUksYUFBYSxHQUFDLElBQUksQUFBQyxHQUFHLDJCQUEyQixDQUFDLENBQUM7OzZDQUN2RSxxQkFBTSxhQUFhLENBQUM7OztBQUU1QixnQ0FBTyxJQUFJLENBQUMsV0FBVyxJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUEsQUFBQyxDQUFDLENBQUM7O0FBRXhDLDRCQUFnQixHQUFHLDBCQUFNLFVBQUMsT0FBTyxFQUFLO0FBQ3hDLGtCQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7O0FBRXpCLGtCQUFJLElBQUksR0FBRyxNQUFLLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztBQUMxQyxrQkFBSSxJQUFJLEdBQUcsS0FBSyxDQUFDOztBQUVqQixrQ0FBTyxJQUFJLENBQUMsMkJBQTJCLEdBQUcsSUFBSSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQzs7QUFFN0Qsb0JBQUssTUFBTSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDOzs7QUFHL0Isb0JBQUssTUFBTSxDQUFDLEVBQUUsQ0FBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLEVBQUU7QUFDckMsb0NBQU8sS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2pCLG9DQUFPLEtBQUssQ0FBQyxtR0FBbUcsQ0FBQyxDQUFDO0FBQ2xILHVCQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7ZUFDaEIsQ0FBQyxDQUFDOztBQUVILG9CQUFLLE1BQU0sQ0FBQyxFQUFFLENBQUUsT0FBTyxFQUFFLFlBQVk7QUFDbkMsb0NBQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7ZUFDbEMsQ0FBQyxDQUFDOztBQUVILG9CQUFLLE1BQU0sQ0FBQyxFQUFFLENBQUUsU0FBUyxFQUFFLFlBQVk7QUFDckMsb0NBQU8sS0FBSyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDckMsdUJBQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztlQUNoQixDQUFDLENBQUM7QUFDSCxvQkFBSyxNQUFNLENBQUMsT0FBTyxDQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsWUFBWTtBQUMzQyxvQ0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDekIsdUJBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztlQUNmLENBQUMsQ0FBQzthQUNKLENBQUM7O0FBQ0Ysc0JBQVUsRUFBRSxDQUFDOzs2Q0FDSyxnQkFBZ0I7OztBQUFsQyxxQkFBUzs7QUFFVCxnQkFBSSxDQUFDLFNBQVMsSUFBSSxVQUFVLEtBQU0sZUFBZSxHQUFHLENBQUMsQUFBQyxFQUFFO0FBQ3RELGtDQUFPLGFBQWEsQ0FBQyxvQkFBb0IsR0FBRyxlQUFlLEdBQUcsbUJBQW1CLENBQUMsQ0FBQzthQUNwRjs7Ozs7QUFFSCxzQkFBVSxHQUFHLENBQUMsQ0FBQztBQUNmLGdCQUFJLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQzs7Ozs7OztLQUN4Qjs7Ozs7V0FHMEIsOEJBQUMsR0FBRztVQU96QixVQUFVOzs7Ozs7Z0JBTFQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFROzs7OztBQUN2QixnQ0FBTyxJQUFJLENBQUMsOENBQThDLENBQUMsQ0FBQzs7NkNBQ3RELElBQUksQ0FBQyxhQUFhLEVBQUU7OztBQUd4QixzQkFBVSxHQUFHLDBCQUFNLFVBQUMsT0FBTyxFQUFLO0FBQ2xDLGtDQUFPLEtBQUssQ0FBQyxXQUFXLEdBQUcsR0FBRyxDQUFDLENBQUM7O0FBRWhDLGtCQUFJLFNBQVMsR0FBRyxFQUFFLENBQUM7QUFDbkIsa0JBQUksU0FBUyxHQUFHLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3RDLGtCQUFJLFlBQVksR0FBRyxPQUFLLE1BQU0sQ0FBQzs7QUFHL0Isa0JBQUksV0FBVyxHQUFHLFNBQWQsV0FBVyxDQUFhLElBQUksRUFBRTs7OztBQUloQyxvQkFBSSxJQUFJLENBQUMsTUFBTSxJQUFJLFNBQVMsQ0FBQyxNQUFNLEVBQUU7QUFDbkMsc0JBQUksT0FBTyxHQUFHLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzQyxzQkFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDO0FBQ2hELHNCQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFLFVBQVUsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7O0FBRWpFLHNCQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUU7O0FBRTdCLHdCQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQzs7QUFFekMsNkJBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7OztBQUd6QixnQ0FBWSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUM7OztBQUdqRCwyQkFBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQzttQkFDbkMsTUFBTTtBQUNMLDZCQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO21CQUN0QjtpQkFDRjtlQUNGLENBQUM7O0FBRUYsMEJBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLElBQUksRUFBRSxNQUFNLEVBQUUsWUFBTTtBQUMzQyw0QkFBWSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUM7ZUFDdEMsQ0FBQyxDQUFDO2FBQ0osQ0FBQzs7NkNBQ1csVUFBVTs7Ozs7Ozs7OztLQUN4Qjs7O1NBaFpHLGdCQUFnQjs7Ozs7Ozs7O0FBbVp0QixxQ0FBc0Isb0JBQUUsT0FBTyw0QkFBVSxpSEFBRTs7O1FBQWpDLEdBQUc7UUFBRSxFQUFFOztBQUNmLG9CQUFnQixDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7R0FDdEM7Ozs7Ozs7Ozs7Ozs7Ozs7UUFFUSxnQkFBZ0IsR0FBaEIsZ0JBQWdCIiwiZmlsZSI6ImxpYi9kcml2ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYXNlRHJpdmVyLCBEZXZpY2VTZXR0aW5ncywgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBkZXNpcmVkQ2FwQ29uc3RyYWludHMgZnJvbSAnLi9kZXNpcmVkLWNhcHMnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgY29tbWFuZHMgZnJvbSAnLi9jb21tYW5kcy9pbmRleCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgc2xlZXAgfSBmcm9tICdhc3luY2JveCc7XG5cbi8vIGZvciBwcm94aWVzXG5pbXBvcnQgQW5kcm9pZERyaXZlciBmcm9tICdhcHBpdW0tYW5kcm9pZC1kcml2ZXInO1xuaW1wb3J0IElPU0RyaXZlciBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgWENVSVRlc3REcml2ZXIgZnJvbSAnYXBwaXVtLXhjdWl0ZXN0LWRyaXZlcic7XG5pbXBvcnQgTWFjRHJpdmVyIGZyb20gJ2FwcGl1bS1tYWMtZHJpdmVyJztcblxuXG5cbi8vIEFkZCBjb21tYW5kcyBmcm9tIHRoZSBmb2xsb3dpbmcgbG9jYXRpb24gdGhhdCBzaG91bGQgYmUgbWFwcGVkIHRvIGV4aXN0aW5nIGRyaXZlcnM6XG4vLyBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS1iYXNlLWRyaXZlci9ibG9iL21hc3Rlci9saWIvbWpzb253cC9yb3V0ZXMuanNcblxuY29uc3QgVE9fUFJPWFlfQ09NTU9OID0gW1xuICAnYmFja2dyb3VuZCcsXG4gICdjbG9zZUFwcCcsXG4gICdnZXRMb2cnLFxuICAnZ2V0TG9nVHlwZXMnLFxuICAnZ2V0T3JpZW50YXRpb24nLFxuICAnZ2V0U3RyaW5ncycsXG4gICdsYXVuY2hBcHAnLFxuICAnbG9jaycsXG4gICdyZW1vdmVBcHAnLFxuICAnc2V0T3JpZW50YXRpb24nLFxuXTtcblxuY29uc3QgVE9fUFJPWFlfSU9TX09OTFkgPSBbXG4gICdtb2JpbGVTaGFrZScsXG5dO1xuXG5jb25zdCBUT19QUk9YWV9BTkRST0lEX09OTFkgPSBbXG4gICdnZXROZXR3b3JrQ29ubmVjdGlvbicsXG4gICdpc0FwcEluc3RhbGxlZCcsXG4gICdpc0xvY2tlZCcsXG4gICdsb25nUHJlc3NLZXlDb2RlJyxcbiAgJ3ByZXNzS2V5Q29kZScsXG4gICdzZXROZXR3b3JrQ29ubmVjdGlvbicsXG4gICd0b2dnbGVMb2NhdGlvblNlcnZpY2VzJyxcbiAgJ3VubG9jaycsXG5dO1xuXG5jb25zdCBUT19QUk9YWV9JT1MgPSBUT19QUk9YWV9JT1NfT05MWS5jb25jYXQoVE9fUFJPWFlfQ09NTU9OKTtcbmNvbnN0IFRPX1BST1hZX0FORFJPSUQgPSBUT19QUk9YWV9BTkRST0lEX09OTFkuY29uY2F0KFRPX1BST1hZX0NPTU1PTik7XG5jb25zdCBUT19QUk9YWV9NQUMgPSBUT19QUk9YWV9DT01NT047XG5cbmNvbnN0IE1BWF9SRVRSWV9DT1VOVCA9IDEwO1xuY29uc3QgUkVUUllfQkFDS09GRiA9IDMwMDA7XG5cbmNsYXNzIFlvdWlFbmdpbmVEcml2ZXIgZXh0ZW5kcyBCYXNlRHJpdmVyIHtcbiAgcmVzZXRZb3VpRW5naW5lICgpIHtcblxuICAgIHRoaXMucmVhZHkgPSBmYWxzZTtcbiAgICB0aGlzLnNvY2tldCA9IG51bGw7XG4gICAgdGhpcy5sb2NhdG9yU3RyYXRlZ2llcyA9IFsnaWQnLCAnbmFtZScsICdjbGFzcyBuYW1lJywgJ2FjY2Vzc2liaWxpdHkgaWQnXTtcbiAgICB0aGlzLnByb3h5ZHJpdmVyID0gbnVsbDtcbiAgICB0aGlzLnByb3h5QWxsb3dMaXN0ID0gJyc7XG4gIH1cblxuICBjb25zdHJ1Y3RvciAob3B0cywgc2hvdWxkVmFsaWRhdGVDYXBzKSB7XG4gICAgc3VwZXIob3B0cywgc2hvdWxkVmFsaWRhdGVDYXBzKTtcblxuICAgIHRoaXMuZGVzaXJlZENhcENvbnN0cmFpbnRzID0gZGVzaXJlZENhcENvbnN0cmFpbnRzO1xuICAgIHRoaXMuc2V0dGluZ3MgPSBuZXcgRGV2aWNlU2V0dGluZ3MoeydUaW1lRGlsYXRpb24nOiAxLCAnU291cmNlVHJlZUZpbHRlcic6ICcnfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vblNldHRpbmdzVXBkYXRlLmJpbmQodGhpcykpO1xuICAgIHRoaXMucmVzZXRZb3VpRW5naW5lKCk7XG5cbiAgfVxuXG4gIHZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5IChzdHJhdGVneSkge1xuICAgIHN1cGVyLnZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5KHN0cmF0ZWd5LCBmYWxzZSk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVTZXNzaW9uIChjYXBzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBbc2Vzc2lvbklkXSA9IGF3YWl0IHN1cGVyLmNyZWF0ZVNlc3Npb24oY2Fwcyk7XG5cbiAgICAgIC8vIHNldHVwIHByb3hpZXMgLSBpZiBwbGF0Zm9ybU5hbWUgaXMgbm90IGVtcHR5LCBtYWtlIGl0IGxlc3MgY2FzZSBzZW5zaXRpdmVcbiAgICAgIGlmIChjYXBzLnBsYXRmb3JtTmFtZSAhPT0gbnVsbCkge1xuICAgICAgICBsZXQgYXBwUGxhdGZvcm0gPSBjYXBzLnBsYXRmb3JtTmFtZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBpZiAoYXBwUGxhdGZvcm0gPT09IFwiaW9zXCIpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0SU9TU2Vzc2lvbihjYXBzKTtcbiAgICAgICAgfSBlbHNlIGlmIChhcHBQbGF0Zm9ybSA9PT0gXCJhbmRyb2lkXCIpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0QW5kcm9pZFNlc3Npb24oY2Fwcyk7XG4gICAgICAgIH0gZWxzZSBpZiAoYXBwUGxhdGZvcm0gPT09IFwibWFjXCIpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0TWFjU2Vzc2lvbihjYXBzKTtcbiAgICAgICAgfSBlbHNlIGlmIChhcHBQbGF0Zm9ybSA9PT0gXCJ5aW1hY1wiKSB7XG4gICAgICAgICAgdGhpcy5zdGFydFlJTWFjU2Vzc2lvbihjYXBzKTtcbiAgICAgICAgfSBlbHNlIGlmIChhcHBQbGF0Zm9ybSA9PT0gXCJ5aXJva3VcIikge1xuICAgICAgICAgIHRoaXMuc3RhcnRZSVJva3VTZXNzaW9uKGNhcHMpO1xuICAgICAgICB9IGVsc2UgaWYgKGFwcFBsYXRmb3JtID09PSBcInlpdHZvc1wiKSB7XG4gICAgICAgICAgdGhpcy5zdGFydFlJVFZPU1Nlc3Npb24oY2Fwcyk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgYXdhaXQgdGhpcy5jb25uZWN0U29ja2V0KCk7XG4gICAgICByZXR1cm4gW3Nlc3Npb25JZCwgdGhpcy5vcHRzXTtcblxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cbiAgXG4gIGFzeW5jIG9uU2V0dGluZ3NVcGRhdGUgKGtleSwgdmFsdWUpIHtcbiAgICBpZiAoa2V5ID09PSBcIlRpbWVEaWxhdGlvblwiKSB7XG4gICAgICBhd2FpdCB0aGlzLnNldFRpbWVEaWxhdGlvbih2YWx1ZSk7XG4gICAgfSBlbHNlIGlmIChrZXkgPT09IFwiU291cmNlVHJlZUZpbHRlclwiKSB7XG4gICAgICBhd2FpdCB0aGlzLnNldFNvdXJjZVRyZWVGaWx0ZXIodmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0b3AgKCkge1xuICAgIHRoaXMucmVhZHkgPSBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIkRlbGV0aW5nIFlvdWlFbmdpbmUgc2Vzc2lvblwiKTtcbiAgICBcbiAgICBpZiAodGhpcy5jYXBzLnBsYXRmb3JtTmFtZSAhPT0gbnVsbCkge1xuICAgICAgbGV0IGFwcFBsYXRmb3JtID0gdGhpcy5jYXBzLnBsYXRmb3JtTmFtZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgaWYgKGFwcFBsYXRmb3JtID09PSBcInlpbWFjXCIpIHtcbiAgICAgICAgdGhpcy5lbmRZSU1hY1Nlc3Npb24odGhpcy5jYXBzKTtcbiAgICAgIH0gZWxzZSBpZiAoYXBwUGxhdGZvcm0gPT09IFwieWl0dm9zXCIpIHtcbiAgICAgICAgdGhpcy5lbmRZSVRWT1NTZXNzaW9uKHRoaXMuY2Fwcyk7XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIGlmICh0aGlzLnByb3h5ZHJpdmVyICE9PSBudWxsKSB7XG4gICAgICBhd2FpdCB0aGlzLnByb3h5ZHJpdmVyLmRlbGV0ZVNlc3Npb24oKTtcbiAgICB9XG4gICAgYXdhaXQgc3VwZXIuZGVsZXRlU2Vzc2lvbigpO1xuICAgIGF3YWl0IHRoaXMuc3RvcCgpO1xuICB9XG5cbiAgZHJpdmVyU2hvdWxkRG9Qcm94eUNtZCAoY29tbWFuZCkge1xuXG4gICAgaWYgKCF0aGlzLnByb3h5ZHJpdmVyKVxuICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgLy8gb25seSBhbGxvdyB3aGl0ZSBsaXN0ZWQgY29tbWFuZHNcbiAgICBmb3IgKGxldCBhbGxvd2VkQ29tbWFuZCBvZiB0aGlzLnByb3h5QWxsb3dMaXN0KSB7XG4gICAgICBpZiAoYWxsb3dlZENvbW1hbmQgPT09IGNvbW1hbmQpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIGV4ZWN1dGVDb21tYW5kIChjbWQsIC4uLmFyZ3MpIHtcbiAgICBpZiAoY21kID09PSAncmVjZWl2ZUFzeW5jUmVzcG9uc2UnKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYEV4ZWN1dGluZyBZb3VpRW5naW5lRHJpdmVyIHJlc3BvbnNlICcke2NtZH0nYCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5yZWNlaXZlQXN5bmNSZXNwb25zZSguLi5hcmdzKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucmVhZHkpIHtcblxuICAgICAgaWYgKHRoaXMuZHJpdmVyU2hvdWxkRG9Qcm94eUNtZChjbWQpKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgRXhlY3V0aW5nIHByb3hpZWQgV2ViRHJpdmVyIGNvbW1hbmQgJyR7Y21kfSdgKTtcblxuICAgICAgICAvLyBUaGVyZSBhcmUgMiBDb21tYW5kVGltZW91dCAoWW91aUVuZ2luZURyaXZlciBhbmQgcHJveHkpXG4gICAgICAgIC8vIE9ubHkgWW91aUVuZ2luZURyaXZlciBDb21tYW5kVGltZW91dCBpcyB1c2VkOyBQcm94eSBpcyBkaXNhYmxlZFxuICAgICAgICAvLyBBbGwgcHJveHkgY29tbWFuZHMgbmVlZHMgdG8gcmVzZXQgdGhlIFlvdWlFbmdpbmVEcml2ZXIgQ29tbWFuZFRpbWVvdXRcbiAgICAgICAgLy8gSGVyZSB3ZSBtYW51YWxseSByZXNldCB0aGUgWW91aUVuZ2luZURyaXZlciBDb21tYW5kVGltZW91dCBmb3IgY29tbWFuZHMgdGhhdCBnb2UgdG8gcHJveHkuXG4gICAgICAgIHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuICAgICAgICBsZXQgcmVzdWx0ID0gdGhpcy5wcm94eWRyaXZlci5leGVjdXRlQ29tbWFuZChjbWQsIC4uLmFyZ3MpO1xuICAgICAgICB0aGlzLnN0YXJ0TmV3Q29tbWFuZFRpbWVvdXQoY21kKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgRXhlY3V0aW5nIFlvdWlFbmdpbmUgV2ViRHJpdmVyIGNvbW1hbmQgJyR7Y21kfSdgKTtcbiAgICAgICAgcmV0dXJuIHN1cGVyLmV4ZWN1dGVDb21tYW5kKGNtZCwgLi4uYXJncyk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgQ29tbWFuZCBFcnJvciAnJHtjbWR9J2ApO1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hEcml2ZXJFcnJvcihgRHJpdmVyIGlzIG5vdCByZWFkeSwgY2Fubm90IGV4ZWN1dGUgJHtjbWR9LmApO1xuICAgIH1cbiAgfVxuXG4gIHZhbGlkYXRlRGVzaXJlZENhcHMgKGNhcHMpIHtcbiAgICAvLyBjaGVjayB3aXRoIHRoZSBiYXNlIGNsYXNzLCBhbmQgcmV0dXJuIGlmIGl0IGZhaWxzXG4gICAgbGV0IHJlcyA9IHN1cGVyLnZhbGlkYXRlRGVzaXJlZENhcHMoY2Fwcyk7XG4gICAgaWYgKCFyZXMpIHJldHVybiByZXM7XG5cbiAgICAvLyB1c2luZyBhIHByb3h5XG4gICAgaWYgKGNhcHMucGxhdGZvcm1OYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdub3Byb3h5Jykge1xuICAgICAgLy8gbWFrZSBzdXJlIHRoYXQgdGhlIGNhcGFiaWxpdGllcyBoYXMgeW91aUVuZ2luZUFwcEFkZHJlc3NcbiAgICAgIGlmICghY2Fwcy55b3VpRW5naW5lQXBwQWRkcmVzcykge1xuICAgICAgICBsZXQgbXNnID0gJ1RoZSBkZXNpcmVkIGNhcGFiaWxpdGllcyBtdXN0IGluY2x1ZGUgeW91aUVuZ2luZUFwcEFkZHJlc3MnO1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgICAgfVxuICAgICAgLy8gbWFrZSBzdXJlIHRoYXQgdGhlIGNhcGFiaWxpdGllcyBoYXMgYXBwXG4gICAgICBpZiAoIWNhcHMuYXBwKSB7XG4gICAgICAgIGxldCBtc2cgPSAnVGhlIGRlc2lyZWQgY2FwYWJpbGl0aWVzIG11c3QgaW5jbHVkZSBhcHAnO1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgICAgfVxuXG4gICAgICAvL0FuZHJvaWQgZW11bGF0b3Igd2l0aCBwcm94eVxuICAgICAgaWYgKGNhcHMuZGV2aWNlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnYW5kcm9pZCcpIHtcbiAgICAgICAgaWYgKCFjYXBzLmF2ZCkge1xuICAgICAgICAgIGxldCBtc2cgPSAnVGhlIGRlc2lyZWQgY2FwYWJpbGl0aWVzIG11c3QgaW5jbHVkZSBhdmQnO1xuICAgICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBmaW5hbGx5LCByZXR1cm4gdHJ1ZSBzaW5jZSB0aGUgc3VwZXJjbGFzcyBjaGVjayBwYXNzZWQsIGFzIGRpZCB0aGlzXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBhc3luYyBzZXR1cE5ld0lPU0RyaXZlciAoY2Fwcykge1xuICAgIGxldCBpb3NBcmdzID0ge1xuICAgICAgamF2YXNjcmlwdEVuYWJsZWQ6IHRydWUsXG4gICAgfTtcblxuICAgIGxldCBpb3Nkcml2ZXIgPSBuZXcgSU9TRHJpdmVyKGlvc0FyZ3MpO1xuICAgIC8vIElmIGlPUyB2ZXJzaW9uIGlzIDEwIG9yIGFib3ZlIHdlIG5lZWQgdG8gdXNlIFhDVUlUZXN0RHJpdmVyIChhbmQgWGNvZGUgOCspXG4gICAgaWYgKGNhcHMucGxhdGZvcm1WZXJzaW9uKSB7XG4gICAgICBsZXQgbWFqb3JWZXIgPSBjYXBzLnBsYXRmb3JtVmVyc2lvbi50b1N0cmluZygpLnNwbGl0KFwiLlwiKVswXTtcbiAgICAgIGlmIChwYXJzZUludChtYWpvclZlciwgMTApID49IDEwKSB7XG4gICAgICAgIGlvc2RyaXZlciA9IG5ldyBYQ1VJVGVzdERyaXZlcihpb3NBcmdzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgbGV0IGNhcHNDb3B5ID0gXy5jbG9uZURlZXAoY2Fwcyk7XG4gICAgLy8gRGlzYWJsaW5nIHRoZSBwcm94eSBDb21tYW5kVGltZW91dCBpbiB0aGUgaU9TIGRyaXZlciBzaW5jZSB3ZSBhcmUgbm93IGhhbmRsaW5nIGl0IGluIHRoZSBZb3VpRW5naW5lIERyaXZlclxuICAgIGNhcHNDb3B5Lm5ld0NvbW1hbmRUaW1lb3V0ID0gIDA7XG4gICAgYXdhaXQgaW9zZHJpdmVyLmNyZWF0ZVNlc3Npb24oY2Fwc0NvcHkpO1xuXG4gICAgcmV0dXJuIGlvc2RyaXZlcjtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0SU9TU2Vzc2lvbiAoY2Fwcykge1xuICAgIGxvZ2dlci5pbmZvKFwiU3RhcnRpbmcgYW4gSU9TIHByb3h5IHNlc3Npb25cIik7XG4gICAgdGhpcy5wcm94eUFsbG93TGlzdCA9IFRPX1BST1hZX0lPUztcbiAgICBcbiAgICB0aGlzLnByb3h5ZHJpdmVyID0gYXdhaXQgdGhpcy5zZXR1cE5ld0lPU0RyaXZlcihjYXBzKTtcbiAgfVxuXG4gIGFzeW5jIHNldHVwTmV3QW5kcm9pZERyaXZlciAoY2Fwcykge1xuICAgIGxldCBhbmRyb2lkQXJncyA9IHtcbiAgICAgIGphdmFzY3JpcHRFbmFibGVkOiB0cnVlXG4gICAgfTtcbiAgICBsZXQgYW5kcm9pZGRyaXZlciA9IG5ldyBBbmRyb2lkRHJpdmVyKGFuZHJvaWRBcmdzKTtcbiAgICBsZXQgY2Fwc0NvcHkgPSBfLmNsb25lRGVlcChjYXBzKTtcbiAgICAvLyBEaXNhYmxpbmcgdGhlIHByb3h5IENvbW1hbmRUaW1lb3V0IGluIHRoZSBBbmRyb2lkIGRyaXZlciBzaW5jZSB3ZSBhcmUgbm93IGhhbmRsaW5nIGl0IGluIHRoZSBZb3VpRW5naW5lIERyaXZlclxuICAgIGNhcHNDb3B5Lm5ld0NvbW1hbmRUaW1lb3V0ID0gMDtcblxuICAgIGF3YWl0IGFuZHJvaWRkcml2ZXIuY3JlYXRlU2Vzc2lvbihjYXBzQ29weSk7XG5cbiAgICByZXR1cm4gYW5kcm9pZGRyaXZlcjtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0QW5kcm9pZFNlc3Npb24gKGNhcHMpIHtcbiAgICBsb2dnZXIuaW5mbyhcIlN0YXJ0aW5nIGFuIEFuZHJvaWQgcHJveHkgc2Vzc2lvblwiKTtcbiAgICB0aGlzLnByb3h5QWxsb3dMaXN0ID0gVE9fUFJPWFlfQU5EUk9JRDtcbiAgICBcbiAgICB0aGlzLnByb3h5ZHJpdmVyID0gYXdhaXQgdGhpcy5zZXR1cE5ld0FuZHJvaWREcml2ZXIoY2Fwcyk7XG4gIH1cbiAgXG4gIGFzeW5jIHNldHVwTmV3TWFjRHJpdmVyIChjYXBzKSB7XG4gICAgbGV0IG1hY0FyZ3MgPSB7XG4gICAgICBqYXZhc2NyaXB0RW5hYmxlZDogdHJ1ZVxuICAgIH07XG4gICAgbGV0IG1hY2RyaXZlciA9IG5ldyBNYWNEcml2ZXIobWFjQXJncyk7XG4gICAgbGV0IGNhcHNDb3B5ID0gXy5jbG9uZURlZXAoY2Fwcyk7XG4gICAgLy8gRGlzYWJsaW5nIHRoZSBwcm94eSBDb21tYW5kVGltZW91dCBpbiB0aGUgcHJveGllZCBkcml2ZXIgc2luY2Ugd2UgYXJlIG5vdyBoYW5kbGluZyBpdCBpbiB0aGUgWW91aUVuZ2luZSBEcml2ZXJcbiAgICBjYXBzQ29weS5uZXdDb21tYW5kVGltZW91dCA9IDA7XG5cbiAgICBhd2FpdCBtYWNkcml2ZXIuY3JlYXRlU2Vzc2lvbihjYXBzQ29weSk7XG5cbiAgICByZXR1cm4gbWFjZHJpdmVyO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRNYWNTZXNzaW9uIChjYXBzKSB7XG4gICAgbG9nZ2VyLmluZm8oXCJTdGFydGluZyBhIE1hYyBwcm94eSBzZXNzaW9uXCIpO1xuICAgIHRoaXMucHJveHlBbGxvd0xpc3QgPSBUT19QUk9YWV9NQUM7XG4gICAgXG4gICAgdGhpcy5wcm94eWRyaXZlciA9IGF3YWl0IHRoaXMuc2V0dXBOZXdNYWNEcml2ZXIoY2Fwcyk7XG4gIH1cbiAgXG4gIHN0YXJ0WUlNYWNTZXNzaW9uIChjYXBzKSB7ICAgIFxuICAgIGxvZ2dlci5pbmZvKFwiS2lsbGluZyBhcHAgaWYgcnVuXCIpO1xuICAgIHZhciBzaGVsbCA9IHJlcXVpcmUoJ3NoZWxsanMnKTtcbiAgICB2YXIgcHJvY2Vzc19uYW1lID0gY2Fwcy5hcHAuc3Vic3RyaW5nKGNhcHMuYXBwLmxhc3RJbmRleE9mKFwiL1wiKSArIDEpO1xuICAgIHNoZWxsLmV4ZWMoXCJraWxsYWxsIFwiICsgcHJvY2Vzc19uYW1lKTtcbiAgICBcbiAgICBsb2dnZXIuaW5mbyhcIkxhdW5jaGluZyBhcHBcIik7XG4gICAgdmFyIHNwYXduID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpLnNwYXduLFxuICAgICAgICBscyAgICA9IHNwYXduKGNhcHMuYXBwKTtcblxuICAgIC8vUHJpbnQgWGNvZGUgbG9ncyAoU1RET1VUKVxuICAgIGxzLnN0ZG91dC5vbignZGF0YScsIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICBpZihkYXRhICE9IG51bGwgJiYgY2Fwcy5zaG93WGNvZGVMb2cgPT0gdHJ1ZSl7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZygnWGNvZGUgTG9nIE91dHB1dDogJyArIGRhdGEudG9TdHJpbmcoKSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvL1ByaW50IFhjb2RlIGxvZ3MgKFNUREVSUilcbiAgICBscy5zdGRlcnIub24oJ2RhdGEnLCBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgaWYoZGF0YSAhPSBudWxsICYmIGNhcHMuc2hvd1hjb2RlTG9nID09IHRydWUpe1xuICAgICAgICBsb2dnZXIuZGVidWcoJ1hjb2RlIExvZyBFcnJvcjogJyArIGRhdGEudG9TdHJpbmcoKSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBscy5vbignZXhpdCcsIGZ1bmN0aW9uIChjb2RlKSB7XG4gICAgICBpZihjb2RlICE9IG51bGwgJiYgY2Fwcy5zaG93WGNvZGVMb2cgPT0gdHJ1ZSl7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZygnQXBwbGljYXRpb24gZXhpdGVkIHdpdGggY29kZSAnICsgY29kZS50b1N0cmluZygpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGVuZFlJTWFjU2Vzc2lvbiAoY2Fwcykge1xuICAgIGxvZ2dlci5pbmZvKFwiRGVsZXRpbmcgYXBwXCIpO1xuICAgIHZhciBzaGVsbCA9IHJlcXVpcmUoJ3NoZWxsanMnKTtcbiAgICB2YXIgcHJvY2Vzc19uYW1lID0gY2Fwcy5hcHAuc3Vic3RyaW5nKGNhcHMuYXBwLmxhc3RJbmRleE9mKFwiL1wiKSArIDEpO1xuICAgIHNoZWxsLmV4ZWMoXCJraWxsYWxsIFwiICsgcHJvY2Vzc19uYW1lKTtcbiAgfVxuXG4gIHN0YXJ0WUlSb2t1U2Vzc2lvbiAoY2FwcykgeyAgXG4gICAgbG9nZ2VyLmluZm8oXCJMYXVuY2hpbmcgYXBwXCIpO1xuICAgIHZhciBzaGVsbCA9IHJlcXVpcmUoJ3NoZWxsanMnKTtcbiAgICB2YXIgcm9rdV9pbnN0YWxsX3NjcmlwdCA9IFwiY3VybCAtdiAtIyAtZiAtaSAtLXVzZXIgJ1wiICsgY2Fwcy51c2VybmFtZSArIFwiOlwiICsgY2Fwcy5wYXNzd29yZCArIFwiJyAtLWRpZ2VzdCAtLXByb2dyZXNzLWJhciAtRiAnbXlzdWJtaXQ9SW5zdGFsbCcgLUYgJ2FyY2hpdmU9QFwiICsgY2Fwcy5hcHAgKyBcIicgLUYgJ3Bhc3N3ZD0nIGh0dHA6Ly9cIiArIGNhcHMueW91aUVuZ2luZUFwcEFkZHJlc3MgKyBcIi9wbHVnaW5faW5zdGFsbCB8IGdyZXAgJzxmb250IGNvbG9yJyB8IHNlZCAncy88Zm9udCBjb2xvcj1cXCdyZWRcXCc+Ly8nIFwiO1xuICAgIHNoZWxsLmV4ZWMocm9rdV9pbnN0YWxsX3NjcmlwdCk7XG4gICAgLy9cImN1cmwgLXYgLSMgLWYgLWkgLS11c2VyICdyb2t1ZGV2OnlvdWknIC0tZGlnZXN0IC0tcHJvZ3Jlc3MtYmFyIC1GICdteXN1Ym1pdD1JbnN0YWxsJyAtRiAnYXJjaGl2ZT1AL1VzZXJzL3NpbW9uZ3Jhbmdlci9Eb3dubG9hZHMvVmlkZW9QbGF5ZXIuYmluJyAtRiAncGFzc3dkPScgaHR0cDovLzEwLjEwMC44OS4yNDUvcGx1Z2luX2luc3RhbGwgfCBncmVwICc8Zm9udCBjb2xvcicgfCBzZWQgJ3MvPGZvbnQgY29sb3I9XFwncmVkXFwnPi8vJyBcIlxuICB9XG5cbiAgc3RhcnRZSVRWT1NTZXNzaW9uIChjYXBzKSB7ICBcbiAgICBsb2dnZXIuaW5mbyhcIkxhdW5jaGluZyBhcHBcIik7XG4gICAgdmFyIHNoZWxsID0gcmVxdWlyZSgnc2hlbGxqcycpO1xuICAgIGlmIChjYXBzLnVkaWQpIHtcbiAgICAgIHNoZWxsLmV4ZWMoXCJpb3MtZGVwbG95IC0taWQgXCIgKyBjYXBzLnVkaWQgKyBcIiAtLXVuaW5zdGFsbCAtLWp1c3RsYXVuY2ggLS1idW5kbGUgXCIgKyBjYXBzLmFwcCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgc2hlbGwuZXhlYyhcImlvcy1kZXBsb3kgLS11bmluc3RhbGwgLS1qdXN0bGF1bmNoIC0tYnVuZGxlIFwiICsgY2Fwcy5hcHApO1xuICAgIH1cbiAgfVxuICBcbiAgZW5kWUlUVk9TU2Vzc2lvbiAoY2Fwcykge1xuICAgIC8vIElmIG11bHRpcGxlIGFwcHMgd2l0aCBvdXIgc29ja2V0IGFyZSBpbnN0YWxsZWQsIGl0IHdpbGwgY29ubmVjdCB0byB0aGUgZmlyc3QgYXBwIGluc3RhbGxlZC5cbiAgICAvLyBGb3IgdGhpcyByZWFzb24sIGV2ZXJ5IGFwcCBzaG91bGQgYmUgdW5pbnN0YWxsZWQgYWZ0ZXIgcnVubmluZy5cbiAgICBsb2dnZXIuaW5mbyhcIkRlbGV0aW5nIGFwcFwiKTtcbiAgICB2YXIgc2hlbGwgPSByZXF1aXJlKCdzaGVsbGpzJyk7XG4gICAgdmFyIGJ1bmRsZWlkID0gc2hlbGwuZXhlYyhcIm9zYXNjcmlwdCAtZSAnaWQgb2YgYXBwIFxcXCJcIiArIGNhcHMuYXBwICsgXCJcXFwiJ1wiICk7XG4gICAgaWYgKGNhcHMudWRpZCkge1xuICAgICAgc2hlbGwuZXhlYyhcImlvcy1kZXBsb3kgLS1pZCBcIiArIGNhcHMudWRpZCArIFwiIC0tdW5pbnN0YWxsX29ubHkgLS1idW5kbGVfaWQgXCIgKyBidW5kbGVpZCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgc2hlbGwuZXhlYyhcImlvcy1kZXBsb3kgLS11bmluc3RhbGxfb25seSAtLWJ1bmRsZV9pZCBcIiArIGJ1bmRsZWlkKTtcbiAgICB9XG4gIH1cblxuLy8gU09DS0VUU1xuICBhc3luYyBjb25uZWN0U29ja2V0ICgpIHtcblxuICAgIHZhciByZXRyeUNvdW50ID0gMDtcbiAgICB2YXIgY29ubmVjdGVkID0gZmFsc2U7XG4gICAgd2hpbGUgKHJldHJ5Q291bnQgPCBNQVhfUkVUUllfQ09VTlQgJiYgIWNvbm5lY3RlZCkge1xuXG4gICAgICBpZiAocmV0cnlDb3VudCA+IDApIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oXCJXYWl0aW5nIFwiICsgKFJFVFJZX0JBQ0tPRkYvMTAwMCkgKyBcIiBzZWNvbmRzIGJlZm9yZSB0cnlpbmcuLi5cIik7XG4gICAgICAgIGF3YWl0IHNsZWVwKFJFVFJZX0JBQ0tPRkYpO1xuICAgICAgfVxuICAgICAgbG9nZ2VyLmluZm8oXCJBdHRlbXB0ICNcIiArIChyZXRyeUNvdW50ICsgMSkpO1xuXG4gICAgICB2YXIgY29ubmVjdGVkUHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlKSA9PiB7XG4gICAgICAgIHZhciBuZXQgPSByZXF1aXJlKCduZXQnKTtcblxuICAgICAgICB2YXIgSE9TVCA9IHRoaXMub3B0cy55b3VpRW5naW5lQXBwQWRkcmVzcztcbiAgICAgICAgdmFyIFBPUlQgPSAxMjM0NTtcblxuICAgICAgICBsb2dnZXIuaW5mbygnQ29ubmVjdGluZyB0byBXZWJEcml2ZXI6ICcgKyBIT1NUICsgJzonICsgUE9SVCk7XG5cbiAgICAgICAgdGhpcy5zb2NrZXQgPSBuZXcgbmV0LlNvY2tldCgpO1xuXG4gICAgICAgIC8vIEFkZCBhbiAnZXJyb3InIGV2ZW50IGhhbmRsZXIgZm9yIHRoZSBjbGllbnQgc29ja2V0XG4gICAgICAgIHRoaXMuc29ja2V0Lm9uICgnZXJyb3InLCBmdW5jdGlvbiAoZXgpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoZXgpO1xuICAgICAgICAgIGxvZ2dlci5lcnJvcignQ2hlY2sgdGhhdCBXZWJEcml2ZXIgaXMgZW5hYmxlZCBpbiBhcHBsaWNhdGlvbiwgaWYgYSBkZXZpY2UgZW5zdXJlIHRoZSBwcm9wZXIgSVAgYWRkcmVzcyBpcyB1c2VkLicpO1xuICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gQWRkIGEgJ2Nsb3NlJyBldmVudCBoYW5kbGVyIGZvciB0aGUgY2xpZW50IHNvY2tldFxuICAgICAgICB0aGlzLnNvY2tldC5vbiAoJ2Nsb3NlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGxvZ2dlci5pbmZvKCdDb25uZWN0aW9uIGNsb3NlZCcpO1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gQWRkIGEgJ3RpbWVvdXQnIGV2ZW50IGhhbmRsZXIgZm9yIHRoZSBjbGllbnQgc29ja2V0XG4gICAgICAgIHRoaXMuc29ja2V0Lm9uICgndGltZW91dCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0Nvbm5lY3Rpb24gdGltZWQgb3V0Jyk7XG4gICAgICAgICAgcmVzb2x2ZShmYWxzZSk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNvY2tldC5jb25uZWN0IChQT1JULCBIT1NULCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgbG9nZ2VyLmluZm8oJ0Nvbm5lY3RlZCcpO1xuICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgICByZXRyeUNvdW50Kys7XG4gICAgICBjb25uZWN0ZWQgPSBhd2FpdCBjb25uZWN0ZWRQcm9taXNlO1xuXG4gICAgICBpZiAoIWNvbm5lY3RlZCAmJiByZXRyeUNvdW50ID09PSAoTUFYX1JFVFJZX0NPVU5UIC0gMSkpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coXCJGYWlsZWQgdG8gY29ubmVjdCBcIiArIE1BWF9SRVRSWV9DT1VOVCArIFwiIHRpbWVzLiBBYm9ydGluZy5cIik7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHJ5Q291bnQgPSAwO1xuICAgIHRoaXMucmVhZHkgPSBjb25uZWN0ZWQ7XG4gIH1cblxuICAvLyByZXNwb25zZXMgdG8gdGhlIGNvbW1hbmRzIGFyZSBCSU5BUllcbiAgYXN5bmMgZXhlY3V0ZVNvY2tldENvbW1hbmQgKGNtZCkge1xuXG4gICAgaWYgKCF0aGlzLnNvY2tldC53cml0YWJsZSkge1xuICAgICAgbG9nZ2VyLmluZm8oXCJTb2NrZXQgaXMgbm90IHdyaXRhYmxlLiBUcnlpbmcgdG8gcmVjb25uZWN0LlwiKTtcbiAgICAgIGF3YWl0IHRoaXMuY29ubmVjdFNvY2tldCgpO1xuICAgIH1cblxuICAgIGxldCBjbWRQcm9taXNlID0gbmV3IEIoKHJlc29sdmUpID0+IHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnQ09NTUFORDogJyArIGNtZCk7XG5cbiAgICAgIHZhciB0b3RhbGRhdGEgPSBbXTtcbiAgICAgIHZhciBlbmRNYXJrZXIgPSBuZXcgQnVmZmVyKFwieW91aWVuZFwiKTtcbiAgICAgIGxldCBzb2NrZXRDbGllbnQgPSB0aGlzLnNvY2tldDtcblxuXG4gICAgICBsZXQgZGF0YUhhbmRsZXIgPSBmdW5jdGlvbiAoZGF0YSkge1xuXG4gICAgICAgIC8vIGRldGVybWluZSBpZiB0aGlzIGluY2x1ZGVzIGFuIGVuZCBwYXJrZXJcbiAgICAgICAgLy8gZ2V0IGxhc3QgZmV3IHZhbHVlcyBvZiBidWZmZXJcbiAgICAgICAgaWYgKGRhdGEubGVuZ3RoID49IGVuZE1hcmtlci5sZW5ndGgpIHtcbiAgICAgICAgICB2YXIgZGF0YWVuZCA9IG5ldyBCdWZmZXIoZW5kTWFya2VyLmxlbmd0aCk7XG4gICAgICAgICAgdmFyIHN0YXJ0SW5kZXggPSBkYXRhLmxlbmd0aCAtIGVuZE1hcmtlci5sZW5ndGg7XG4gICAgICAgICAgZGF0YS5jb3B5KGRhdGFlbmQsIDAsIHN0YXJ0SW5kZXgsIHN0YXJ0SW5kZXggKyBlbmRNYXJrZXIubGVuZ3RoKTtcbiAgICAgICAgICAvL2xvZ2dlci5kZWJ1ZygnREFUQUVORCcgKyBkYXRhZW5kLnRvU3RyaW5nKCkpO1xuICAgICAgICAgIGlmIChkYXRhZW5kLmVxdWFscyhlbmRNYXJrZXIpKSB7XG4gICAgICAgICAgICAvLyByZW1vdmUgZGF0YSBlbmRcbiAgICAgICAgICAgIHZhciBsYXN0RGF0YSA9IGRhdGEuc2xpY2UoMCwgc3RhcnRJbmRleCk7XG4gICAgICAgICAgICAvL2xvZ2dlci5kZWJ1ZygnTEFTVCBEQVRBOiAnICsgbGFzdERhdGEudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICB0b3RhbGRhdGEucHVzaChsYXN0RGF0YSk7XG5cbiAgICAgICAgICAgIC8vcmVtb3ZlIGhhbmRsZXJcbiAgICAgICAgICAgIHNvY2tldENsaWVudC5yZW1vdmVMaXN0ZW5lcignZGF0YScsIGRhdGFIYW5kbGVyKTtcblxuICAgICAgICAgICAgLy8gcmVzb2x2ZVxuICAgICAgICAgICAgcmVzb2x2ZShCdWZmZXIuY29uY2F0KHRvdGFsZGF0YSkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0b3RhbGRhdGEucHVzaChkYXRhKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIHNvY2tldENsaWVudC53cml0ZShjbWQgKyBcIlxcblwiLCBcIlVURjhcIiwgKCkgPT4ge1xuICAgICAgICBzb2NrZXRDbGllbnQub24oJ2RhdGEnLCBkYXRhSGFuZGxlcik7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gYXdhaXQgY21kUHJvbWlzZTtcbiAgfVxufVxuXG5mb3IgKGxldCBbY21kLCBmbl0gb2YgXy50b1BhaXJzKGNvbW1hbmRzKSkge1xuICBZb3VpRW5naW5lRHJpdmVyLnByb3RvdHlwZVtjbWRdID0gZm47XG59XG5cbmV4cG9ydCB7IFlvdWlFbmdpbmVEcml2ZXIgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
