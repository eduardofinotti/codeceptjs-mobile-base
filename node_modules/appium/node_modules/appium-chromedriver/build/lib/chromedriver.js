require('source-map-support').install();

'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Symbol$iterator = require('babel-runtime/core-js/symbol/iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _appiumBaseDriver = require('appium-base-driver');

var _child_process = require('child_process');

var _child_process2 = _interopRequireDefault(_child_process);

var _appiumSupport = require('appium-support');

var _asyncbox = require('asyncbox');

var _teen_process = require('teen_process');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _utils = require('./utils');

var _semver = require('semver');

var _semver2 = _interopRequireDefault(_semver);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var log = _appiumSupport.logger.getLogger('Chromedriver');

var DEFAULT_HOST = '127.0.0.1';
var DEFAULT_PORT = 9515;
var CHROMEDRIVER_CHROME_MAPPING = {
  // Chromedriver version: minumum Chrome version
  '2.41': '67.0.3396',
  '2.40': '66.0.3359',
  '2.39': '66.0.3359',
  '2.38': '65.0.3325',
  '2.37': '64.0.3282',
  '2.36': '63.0.3239',
  '2.35': '62.0.3202',
  '2.34': '61.0.3163',
  '2.33': '60.0.3112',
  '2.32': '59.0.3071',
  '2.31': '58.0.3029',
  '2.30': '58.0.3029',
  '2.29': '57.0.2987',
  '2.28': '55.0.2883',
  '2.27': '54.0.2840',
  '2.26': '53.0.2785',
  '2.25': '53.0.2785',
  '2.24': '52.0.2743',
  '2.23': '51.0.2704',
  '2.22': '49.0.2623',
  '2.21': '46.0.2490',
  '2.20': '43.0.2357',
  '2.19': '43.0.2357',
  '2.18': '43.0.2357',
  '2.17': '42.0.2311',
  '2.16': '42.0.2311',
  '2.15': '40.0.2214',
  '2.14': '39.0.2171',
  '2.13': '38.0.2125',
  '2.12': '36.0.1985',
  '2.11': '36.0.1985',
  '2.10': '33.0.1751',
  '2.9': '31.0.1650',
  '2.8': '30.0.1573',
  '2.7': '30.0.1573',
  '2.6': '29.0.1545',
  '2.5': '29.0.1545',
  '2.4': '29.0.1545',
  '2.3': '28.0.1500',
  '2.2': '27.0.1453',
  '2.1': '27.0.1453',
  '2.0': '27.0.1453'
};
var CHROME_BUNDLE_ID = 'com.android.chrome';
var WEBVIEW_BUNDLE_IDS = ['com.google.android.webview', 'com.android.webview'];

function getMostRecentChromedriver() {
  var mapping = arguments.length <= 0 || arguments[0] === undefined ? CHROMEDRIVER_CHROME_MAPPING : arguments[0];

  if (_lodash2['default'].isEmpty(mapping)) {
    throw new Error('Unable to get most recent Chromedriver from empty mapping');
  }
  return _lodash2['default'].keys(mapping).map(_semver2['default'].coerce).sort(_semver2['default'].rcompare).map(function (v) {
    return _semver2['default'].major(v) + '.' + _semver2['default'].minor(v);
  })[0];
}

var Chromedriver = (function (_events$EventEmitter) {
  _inherits(Chromedriver, _events$EventEmitter);

  function Chromedriver() {
    var args = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, Chromedriver);

    _get(Object.getPrototypeOf(Chromedriver.prototype), 'constructor', this).call(this);

    var _args$host = args.host;
    var host = _args$host === undefined ? DEFAULT_HOST : _args$host;
    var _args$port = args.port;
    var port = _args$port === undefined ? DEFAULT_PORT : _args$port;
    var _args$useSystemExecutable = args.useSystemExecutable;
    var useSystemExecutable = _args$useSystemExecutable === undefined ? false : _args$useSystemExecutable;
    var executable = args.executable;
    var _args$executableDir = args.executableDir;
    var executableDir = _args$executableDir === undefined ? (0, _utils.getChromedriverDir)() : _args$executableDir;
    var bundleId = args.bundleId;
    var mappingPath = args.mappingPath;
    var cmdArgs = args.cmdArgs;
    var adb = args.adb;
    var verbose = args.verbose;
    var logPath = args.logPath;

    this.proxyHost = host;
    this.proxyPort = port;
    this.adb = adb;
    this.cmdArgs = cmdArgs;
    this.proc = null;
    this.useSystemExecutable = useSystemExecutable;
    this.chromedriver = executable;
    this.executableDir = executableDir;
    this.mappingPath = mappingPath;
    this.bundleId = bundleId;
    this.executableVerified = false;
    this.state = Chromedriver.STATE_STOPPED;
    this.jwproxy = new _appiumBaseDriver.JWProxy({ server: this.proxyHost, port: this.proxyPort });
    this.verbose = verbose;
    this.logPath = logPath;
  }

  _createClass(Chromedriver, [{
    key: 'getMapping',
    value: function getMapping() {
      var mapping, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, cdVersion, chromeVersion;

      return _regeneratorRuntime.async(function getMapping$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            mapping = CHROMEDRIVER_CHROME_MAPPING;

            if (!this.mappingPath) {
              context$2$0.next = 21;
              break;
            }

            log.debug('Attempting to use Chromedriver-Chrome mapping from \'' + this.mappingPath + '\'');
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.mappingPath));

          case 5:
            if (context$2$0.sent) {
              context$2$0.next = 9;
              break;
            }

            log.warn('No file found at \'' + this.mappingPath + '\'. Using default mapping');
            context$2$0.next = 21;
            break;

          case 9:
            context$2$0.prev = 9;
            context$2$0.t0 = JSON;
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(this.mappingPath));

          case 13:
            context$2$0.t1 = context$2$0.sent;
            mapping = context$2$0.t0.parse.call(context$2$0.t0, context$2$0.t1);
            context$2$0.next = 21;
            break;

          case 17:
            context$2$0.prev = 17;
            context$2$0.t2 = context$2$0['catch'](9);

            log.error('Error parsing mapping from \'' + this.mappingPath + '\': ' + context$2$0.t2.message);
            log.warn('Using default mapping');

          case 21:
            _iteratorNormalCompletion = true;
            _didIteratorError = false;
            _iteratorError = undefined;
            context$2$0.prev = 24;

            // make sure that the values for minimum chrome version are semver compliant
            for (_iterator = _getIterator(_lodash2['default'].toPairs(mapping)); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
              _step$value = _slicedToArray(_step.value, 2);
              cdVersion = _step$value[0];
              chromeVersion = _step$value[1];

              mapping[cdVersion] = _semver2['default'].coerce(chromeVersion);
            }
            context$2$0.next = 32;
            break;

          case 28:
            context$2$0.prev = 28;
            context$2$0.t3 = context$2$0['catch'](24);
            _didIteratorError = true;
            _iteratorError = context$2$0.t3;

          case 32:
            context$2$0.prev = 32;
            context$2$0.prev = 33;

            if (!_iteratorNormalCompletion && _iterator['return']) {
              _iterator['return']();
            }

          case 35:
            context$2$0.prev = 35;

            if (!_didIteratorError) {
              context$2$0.next = 38;
              break;
            }

            throw _iteratorError;

          case 38:
            return context$2$0.finish(35);

          case 39:
            return context$2$0.finish(32);

          case 40:
            return context$2$0.abrupt('return', mapping);

          case 41:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[9, 17], [24, 28, 32, 40], [33,, 35, 39]]);
    }
  }, {
    key: 'getChromedrivers',
    value: function getChromedrivers(mapping) {
      var executables, cds, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, cd;

      return _regeneratorRuntime.async(function getChromedrivers$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.glob(this.executableDir + '/*'));

          case 2:
            executables = context$2$0.sent;

            log.debug('Found ' + executables.length + ' executable' + (executables.length === 1 ? '' : 's') + ' ' + ('in \'' + this.executableDir + '\''));
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap((0, _asyncbox.asyncmap)(executables, function callee$2$0(executable) {
              var logError, stdout, stderr, _ref2, match, version;

              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    logError = function logError(_ref) {
                      var message = _ref.message;
                      var _ref$stdout = _ref.stdout;
                      var stdout = _ref$stdout === undefined ? null : _ref$stdout;
                      var _ref$stderr = _ref.stderr;
                      var stderr = _ref$stderr === undefined ? null : _ref$stderr;

                      var errMsg = 'Cannot retrieve version number from \'' + _path2['default'].basename(executable) + '\' Chromedriver binary. ' + ('Make sure it returns a valid version string in response to \'--version\' command line argument. ' + message);
                      if (stdout) {
                        errMsg += '\nStdout: ' + stdout;
                      }
                      if (stderr) {
                        errMsg += '\nStderr: ' + stderr;
                      }
                      log.warn(errMsg);
                      return null;
                    };

                    stdout = undefined;
                    stderr = undefined;
                    context$3$0.prev = 3;
                    context$3$0.next = 6;
                    return _regeneratorRuntime.awrap((0, _teen_process.exec)(executable, ['--version']));

                  case 6:
                    _ref2 = context$3$0.sent;
                    stdout = _ref2.stdout;
                    stderr = _ref2.stderr;
                    context$3$0.next = 14;
                    break;

                  case 11:
                    context$3$0.prev = 11;
                    context$3$0.t0 = context$3$0['catch'](3);
                    return context$3$0.abrupt('return', logError(context$3$0.t0));

                  case 14:
                    match = /ChromeDriver\s(\d+\.\d+)\.\d+\s/.exec(stdout);

                    if (match) {
                      context$3$0.next = 17;
                      break;
                    }

                    return context$3$0.abrupt('return', logError({ message: 'Cannot parse the version string', stdout: stdout, stderr: stderr }));

                  case 17:
                    version = match[1];
                    return context$3$0.abrupt('return', {
                      executable: executable,
                      version: version,
                      minCDVersion: mapping[version]
                    });

                  case 19:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, this, [[3, 11]]);
            }));

          case 6:
            context$2$0.t0 = function (cd) {
              return !!cd;
            };

            context$2$0.t1 = function (a, b) {
              return _semver2['default'].gte(_semver2['default'].coerce(b.version), _semver2['default'].coerce(a.version)) ? 1 : -1;
            };

            cds = context$2$0.sent.filter(context$2$0.t0).sort(context$2$0.t1);

            if (_lodash2['default'].isEmpty(cds)) {
              log.errorAndThrow('No Chromedrivers found in \'' + this.executableDir + '\'');
            }
            log.debug('The following Chromedriver executables were found:');
            _iteratorNormalCompletion2 = true;
            _didIteratorError2 = false;
            _iteratorError2 = undefined;
            context$2$0.prev = 14;
            for (_iterator2 = _getIterator(cds); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
              cd = _step2.value;

              log.debug('    ' + cd.executable + ' (minimum Chrome version \'' + (cd.minCDVersion ? cd.minCDVersion : 'Unknown') + '\')');
            }
            context$2$0.next = 22;
            break;

          case 18:
            context$2$0.prev = 18;
            context$2$0.t2 = context$2$0['catch'](14);
            _didIteratorError2 = true;
            _iteratorError2 = context$2$0.t2;

          case 22:
            context$2$0.prev = 22;
            context$2$0.prev = 23;

            if (!_iteratorNormalCompletion2 && _iterator2['return']) {
              _iterator2['return']();
            }

          case 25:
            context$2$0.prev = 25;

            if (!_didIteratorError2) {
              context$2$0.next = 28;
              break;
            }

            throw _iteratorError2;

          case 28:
            return context$2$0.finish(25);

          case 29:
            return context$2$0.finish(22);

          case 30:
            return context$2$0.abrupt('return', cds);

          case 31:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[14, 18, 22, 30], [23,, 25, 29]]);
    }
  }, {
    key: 'getChromeVersion',
    value: function getChromeVersion() {
      var chromeVersion, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, bundleId;

      return _regeneratorRuntime.async(function getChromeVersion$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            chromeVersion = undefined;
            context$2$0.t0 = this.adb;

            if (!context$2$0.t0) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.adb.getApiLevel());

          case 5:
            context$2$0.t1 = context$2$0.sent;
            context$2$0.t0 = context$2$0.t1 >= 24;

          case 7:
            if (!context$2$0.t0) {
              context$2$0.next = 9;
              break;
            }

            this.bundleId = CHROME_BUNDLE_ID;

          case 9:
            if (this.bundleId) {
              context$2$0.next = 41;
              break;
            }

            // default to the generic Chrome bundle
            this.bundleId = CHROME_BUNDLE_ID;

            // we have a webview of some sort, so try to find the bundle version
            _iteratorNormalCompletion3 = true;
            _didIteratorError3 = false;
            _iteratorError3 = undefined;
            context$2$0.prev = 14;
            _iterator3 = _getIterator(WEBVIEW_BUNDLE_IDS);

          case 16:
            if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
              context$2$0.next = 27;
              break;
            }

            bundleId = _step3.value;
            context$2$0.next = 20;
            return _regeneratorRuntime.awrap((0, _utils.getChromeVersion)(this.adb, bundleId));

          case 20:
            chromeVersion = context$2$0.sent;

            if (!chromeVersion) {
              context$2$0.next = 24;
              break;
            }

            this.bundleId = bundleId;
            return context$2$0.abrupt('break', 27);

          case 24:
            _iteratorNormalCompletion3 = true;
            context$2$0.next = 16;
            break;

          case 27:
            context$2$0.next = 33;
            break;

          case 29:
            context$2$0.prev = 29;
            context$2$0.t2 = context$2$0['catch'](14);
            _didIteratorError3 = true;
            _iteratorError3 = context$2$0.t2;

          case 33:
            context$2$0.prev = 33;
            context$2$0.prev = 34;

            if (!_iteratorNormalCompletion3 && _iterator3['return']) {
              _iterator3['return']();
            }

          case 36:
            context$2$0.prev = 36;

            if (!_didIteratorError3) {
              context$2$0.next = 39;
              break;
            }

            throw _iteratorError3;

          case 39:
            return context$2$0.finish(36);

          case 40:
            return context$2$0.finish(33);

          case 41:
            if (chromeVersion) {
              context$2$0.next = 45;
              break;
            }

            context$2$0.next = 44;
            return _regeneratorRuntime.awrap((0, _utils.getChromeVersion)(this.adb, this.bundleId));

          case 44:
            chromeVersion = context$2$0.sent;

          case 45:
            return context$2$0.abrupt('return', chromeVersion ? _semver2['default'].coerce(chromeVersion) : null);

          case 46:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[14, 29, 33, 41], [34,, 36, 40]]);
    }
  }, {
    key: 'getCompatibleChromedriver',
    value: function getCompatibleChromedriver() {
      var mapping, cds, chromeVersion, cd, workingCds, binPath;
      return _regeneratorRuntime.async(function getCompatibleChromedriver$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.adb) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _utils.getChromedriverBinaryPath)());

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.getMapping());

          case 6:
            mapping = context$2$0.sent;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.getChromedrivers(mapping));

          case 9:
            cds = context$2$0.sent;
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.getChromeVersion());

          case 12:
            chromeVersion = context$2$0.sent;

            if (chromeVersion) {
              context$2$0.next = 17;
              break;
            }

            cd = cds[0];

            log.warn('Unable to discover Chrome version. Using Chromedriver ' + cd.version + ' at \'' + cd.executable + '\'');
            return context$2$0.abrupt('return', cd.executable);

          case 17:

            log.debug('Found Chrome bundle \'' + this.bundleId + '\' version \'' + chromeVersion + '\'');

            if (!(_semver2['default'].gt(chromeVersion, _lodash2['default'].values(mapping)[0]) && !_lodash2['default'].isUndefined(cds[0]) && _lodash2['default'].isUndefined(cds[0].minCDVersion))) {
              context$2$0.next = 22;
              break;
            }

            cd = cds[0];

            log.warn('No known Chromedriver available to automate Chrome version \'' + chromeVersion + '\'.\n' + ('Using Chromedriver version \'' + cd.version + '\', which has not been tested with Appium.'));
            return context$2$0.abrupt('return', cd.executable);

          case 22:
            workingCds = cds.filter(function (cd) {
              return !_lodash2['default'].isUndefined(cd.minCDVersion) && _semver2['default'].gte(chromeVersion, cd.minCDVersion);
            });

            if (_lodash2['default'].isEmpty(workingCds)) {
              log.errorAndThrow('No Chromedriver found that can automate Chrome \'' + chromeVersion + '\'. ' + 'See https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/web/chromedriver.md ' + 'for more details.');
            }

            binPath = workingCds[0].executable;

            log.debug('Found ' + workingCds.length + ' Chromedriver executable' + (workingCds.length === 1 ? '' : 's') + ' ' + ('capable of automating Chrome \'' + chromeVersion + '\'.\n') + ('Choosing the most recent, \'' + binPath + '\'.'));
            log.debug('If a specific version is required, specify it with the `chromedriverExecutable`' + 'desired capability.');
            return context$2$0.abrupt('return', binPath);

          case 28:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'initChromedriverPath',
    value: function initChromedriverPath() {
      return _regeneratorRuntime.async(function initChromedriverPath$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.executableVerified) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return');

          case 2:
            if (this.chromedriver) {
              context$2$0.next = 13;
              break;
            }

            if (!this.useSystemExecutable) {
              context$2$0.next = 9;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap((0, _utils.getChromedriverBinaryPath)());

          case 6:
            context$2$0.t0 = context$2$0.sent;
            context$2$0.next = 12;
            break;

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.getCompatibleChromedriver());

          case 11:
            context$2$0.t0 = context$2$0.sent;

          case 12:
            this.chromedriver = context$2$0.t0;

          case 13:
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.chromedriver));

          case 15:
            if (context$2$0.sent) {
              context$2$0.next = 17;
              break;
            }

            throw new Error('Trying to use a chromedriver binary at the path ' + (this.chromedriver + ', but it doesn\'t exist!'));

          case 17:
            this.executableVerified = true;
            log.info('Set chromedriver binary as: ' + this.chromedriver);

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'start',
    value: function start(caps) {
      var emitStartingState = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];
      var args, startDetector, processIsAlive, webviewVersion;
      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.capabilities = caps;
            if (emitStartingState) {
              this.changeState(Chromedriver.STATE_STARTING);
            }

            args = ["--url-base=wd/hub", '--port=' + this.proxyPort];

            if (this.adb && this.adb.adbPort) {
              args = args.concat(['--adb-port=' + this.adb.adbPort]);
            }
            if (this.cmdArgs) {
              args = args.concat(this.cmdArgs);
            }
            if (this.logPath) {
              args = args.concat(['--log-path=' + this.logPath]);
            }
            args = args.concat(['--verbose']);
            // what are the process stdout/stderr conditions wherein we know that
            // the process has started to our satisfaction?

            startDetector = function startDetector(stdout) {
              return stdout.indexOf('Starting ') === 0;
            };

            processIsAlive = false;
            webviewVersion = undefined;
            context$2$0.prev = 10;
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.initChromedriverPath());

          case 13:
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.killAll());

          case 15:

            // set up our subprocess object
            this.proc = new _teen_process.SubProcess(this.chromedriver, args);
            processIsAlive = true;

            // handle log output
            this.proc.on('output', function (stdout, stderr) {
              // if the cd output is not printed, find the chrome version and print
              // will get a response like
              //   DevTools response: {
              //      "Android-Package": "io.appium.sampleapp",
              //      "Browser": "Chrome/55.0.2883.91",
              //      "Protocol-Version": "1.2",
              //      "User-Agent": "...",
              //      "WebKit-Version": "537.36"
              //   }
              var out = stdout + stderr;
              var match = /"Browser": "(.*)"/.exec(out);
              if (match) {
                webviewVersion = match[1];
                log.debug('Webview version: \'' + webviewVersion + '\'');
              }

              // also print chromedriver version to logs
              // will output something like
              //  Starting ChromeDriver 2.33.506106 (8a06c39c4582fbfbab6966dbb1c38a9173bfb1a2) on port 9515
              match = /Starting ChromeDriver ([\.\d]+)/.exec(out);
              if (match) {
                log.debug('Chromedriver version: \'' + match[1] + '\'');
              }

              // give the output if it is requested
              if (_this.verbose) {
                var _iteratorNormalCompletion4 = true;
                var _didIteratorError4 = false;
                var _iteratorError4 = undefined;

                try {
                  for (var _iterator4 = _getIterator((stdout || '').trim().split('\n')), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
                    var line = _step4.value;

                    if (!line.trim().length) continue; // eslint-disable-line curly
                    log.debug('[STDOUT] ' + line);
                  }
                } catch (err) {
                  _didIteratorError4 = true;
                  _iteratorError4 = err;
                } finally {
                  try {
                    if (!_iteratorNormalCompletion4 && _iterator4['return']) {
                      _iterator4['return']();
                    }
                  } finally {
                    if (_didIteratorError4) {
                      throw _iteratorError4;
                    }
                  }
                }

                var _iteratorNormalCompletion5 = true;
                var _didIteratorError5 = false;
                var _iteratorError5 = undefined;

                try {
                  for (var _iterator5 = _getIterator((stderr || '').trim().split('\n')), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
                    var line = _step5.value;

                    if (!line.trim().length) continue; // eslint-disable-line curly
                    log.error('[STDERR] ' + line);
                  }
                } catch (err) {
                  _didIteratorError5 = true;
                  _iteratorError5 = err;
                } finally {
                  try {
                    if (!_iteratorNormalCompletion5 && _iterator5['return']) {
                      _iterator5['return']();
                    }
                  } finally {
                    if (_didIteratorError5) {
                      throw _iteratorError5;
                    }
                  }
                }
              }
            });

            // handle out-of-bound exit by simply emitting a stopped state
            this.proc.on('exit', function (code, signal) {
              processIsAlive = false;
              if (_this.state !== Chromedriver.STATE_STOPPED && _this.state !== Chromedriver.STATE_STOPPING && _this.state !== Chromedriver.STATE_RESTARTING) {
                var msg = 'Chromedriver exited unexpectedly with code ' + code + ', ' + ('signal ' + signal);
                log.error(msg);
                _this.changeState(Chromedriver.STATE_STOPPED);
              }
            });
            log.info('Spawning chromedriver with: ' + this.chromedriver + ' ' + ('' + args.join(' ')));
            // start subproc and wait for startDetector
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(this.proc.start(startDetector));

          case 22:
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(this.waitForOnline());

          case 24:
            context$2$0.next = 26;
            return _regeneratorRuntime.awrap(this.startSession());

          case 26:
            context$2$0.next = 36;
            break;

          case 28:
            context$2$0.prev = 28;
            context$2$0.t0 = context$2$0['catch'](10);

            this.emit(Chromedriver.EVENT_ERROR, context$2$0.t0);
            // just because we had an error doesn't mean the chromedriver process
            // finished; we should clean up if necessary

            if (!processIsAlive) {
              context$2$0.next = 34;
              break;
            }

            context$2$0.next = 34;
            return _regeneratorRuntime.awrap(this.proc.stop());

          case 34:

            // often the user's Chrome version is too low for the version of Chromedriver
            if (context$2$0.t0.message.indexOf('Chrome version must be') !== -1) {
              log.error('Unable to automate Chrome version because it is too old for this version of Chromedriver.');
              if (webviewVersion) {
                log.error('Chrome version on device: ' + webviewVersion);
              }
              log.error('Please see \'https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/web/chromedriver.md\'');
            }
            log.errorAndThrow(context$2$0.t0);

          case 36:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[10, 28]]);
    }
  }, {
    key: 'sessionId',
    value: function sessionId() {
      if (this.state !== Chromedriver.STATE_ONLINE) {
        return null;
      }

      return this.jwproxy.sessionId;
    }
  }, {
    key: 'restart',
    value: function restart() {
      return _regeneratorRuntime.async(function restart$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            log.info("Restarting chromedriver");

            if (!(this.state !== Chromedriver.STATE_ONLINE)) {
              context$2$0.next = 3;
              break;
            }

            throw new Error("Can't restart when we're not online");

          case 3:
            this.changeState(Chromedriver.STATE_RESTARTING);
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.stop(false));

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.start(this.capabilities, false));

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForOnline',
    value: function waitForOnline() {
      var chromedriverStopped;
      return _regeneratorRuntime.async(function waitForOnline$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            chromedriverStopped = false;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(20, 200, function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    if (!(this.state === Chromedriver.STATE_STOPPED)) {
                      context$3$0.next = 3;
                      break;
                    }

                    // we are either stopped or stopping, so something went wrong
                    chromedriverStopped = true;
                    return context$3$0.abrupt('return');

                  case 3:
                    context$3$0.next = 5;
                    return _regeneratorRuntime.awrap(this.getStatus());

                  case 5:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2);
            }));

          case 3:
            if (!chromedriverStopped) {
              context$2$0.next = 5;
              break;
            }

            throw new Error('ChromeDriver crashed during startup.');

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getStatus',
    value: function getStatus() {
      return _regeneratorRuntime.async(function getStatus$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/status', 'GET'));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSession',
    value: function startSession() {
      return _regeneratorRuntime.async(function startSession$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(4, 200, function callee$2$0() {
              var res;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.prev = 0;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap(this.jwproxy.command('/session', 'POST', { desiredCapabilities: this.capabilities }));

                  case 3:
                    res = context$3$0.sent;

                    if (!res.status) {
                      context$3$0.next = 6;
                      break;
                    }

                    throw new Error(res.value.message);

                  case 6:
                    context$3$0.next = 11;
                    break;

                  case 8:
                    context$3$0.prev = 8;
                    context$3$0.t0 = context$3$0['catch'](0);

                    log.errorAndThrow('Failed to start Chromedriver session: ' + context$3$0.t0.message);

                  case 11:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3, [[0, 8]]);
            }));

          case 2:
            this.changeState(Chromedriver.STATE_ONLINE);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      var emitStates = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (emitStates) {
              this.changeState(Chromedriver.STATE_STOPPING);
            }
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.jwproxy.command('', 'DELETE'));

          case 4:
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.proc.stop('SIGTERM', 20000));

          case 6:
            if (emitStates) {
              this.changeState(Chromedriver.STATE_STOPPED);
            }
            context$2$0.next = 12;
            break;

          case 9:
            context$2$0.prev = 9;
            context$2$0.t0 = context$2$0['catch'](1);

            log.error(context$2$0.t0);

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 9]]);
    }
  }, {
    key: 'changeState',
    value: function changeState(state) {
      this.state = state;
      log.debug('Changed state to \'' + state + '\'');
      this.emit(Chromedriver.EVENT_CHANGED, { state: state });
    }
  }, {
    key: 'sendCommand',
    value: function sendCommand(url, method, body) {
      return _regeneratorRuntime.async(function sendCommand$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.jwproxy.command(url, method, body));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'proxyReq',
    value: function proxyReq(req, res) {
      return _regeneratorRuntime.async(function proxyReq$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.jwproxy.proxyReqRes(req, res));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'killAll',
    value: function killAll() {
      var cmd, _iteratorNormalCompletion6, _didIteratorError6, _iteratorError6, _iterator6, _step6, conn, params;

      return _regeneratorRuntime.async(function killAll$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmd = undefined;

            if (_appiumSupport.system.isWindows()) {
              // js hint cannot handle backticks, even escaped, within template literals
              cmd = "FOR /F \"usebackq tokens=5\" %a in (`netstat -nao ^| " + "findstr /R /C:\"" + this.proxyPort + " \"`) do (" + "FOR /F \"usebackq\" %b in (`TASKLIST /FI \"PID eq %a\" ^| " + "findstr /I chromedriver.exe`) do (IF NOT %b==\"\" TASKKILL " + "/F /PID %a))";
            } else {
              cmd = 'pkill -15 -f "' + this.chromedriver + '.*--port=' + this.proxyPort + '"';
            }
            log.debug('Killing any old chromedrivers, running: ' + cmd);
            context$2$0.prev = 3;
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_bluebird2['default'].promisify(_child_process2['default'].exec)(cmd));

          case 6:
            log.debug("Successfully cleaned up old chromedrivers");
            context$2$0.next = 12;
            break;

          case 9:
            context$2$0.prev = 9;
            context$2$0.t0 = context$2$0['catch'](3);

            log.warn("No old chromedrivers seemed to exist");

          case 12:
            if (!this.adb) {
              context$2$0.next = 52;
              break;
            }

            log.debug('Cleaning any old adb forwarded port socket connections');
            context$2$0.prev = 14;
            _iteratorNormalCompletion6 = true;
            _didIteratorError6 = false;
            _iteratorError6 = undefined;
            context$2$0.prev = 18;
            context$2$0.next = 21;
            return _regeneratorRuntime.awrap(this.adb.getForwardList());

          case 21:
            context$2$0.t1 = _Symbol$iterator;
            _iterator6 = context$2$0.sent[context$2$0.t1]();

          case 23:
            if (_iteratorNormalCompletion6 = (_step6 = _iterator6.next()).done) {
              context$2$0.next = 33;
              break;
            }

            conn = _step6.value;

            if (!(conn.indexOf('webview_devtools') !== -1)) {
              context$2$0.next = 30;
              break;
            }

            params = conn.split(/\s+/);

            if (!(params.length > 1)) {
              context$2$0.next = 30;
              break;
            }

            context$2$0.next = 30;
            return _regeneratorRuntime.awrap(this.adb.removePortForward(params[1].replace(/[\D]*/, '')));

          case 30:
            _iteratorNormalCompletion6 = true;
            context$2$0.next = 23;
            break;

          case 33:
            context$2$0.next = 39;
            break;

          case 35:
            context$2$0.prev = 35;
            context$2$0.t2 = context$2$0['catch'](18);
            _didIteratorError6 = true;
            _iteratorError6 = context$2$0.t2;

          case 39:
            context$2$0.prev = 39;
            context$2$0.prev = 40;

            if (!_iteratorNormalCompletion6 && _iterator6['return']) {
              _iterator6['return']();
            }

          case 42:
            context$2$0.prev = 42;

            if (!_didIteratorError6) {
              context$2$0.next = 45;
              break;
            }

            throw _iteratorError6;

          case 45:
            return context$2$0.finish(42);

          case 46:
            return context$2$0.finish(39);

          case 47:
            context$2$0.next = 52;
            break;

          case 49:
            context$2$0.prev = 49;
            context$2$0.t3 = context$2$0['catch'](14);

            log.warn('Unable to clean forwarded ports. Error: \'' + context$2$0.t3.message + '\'. Continuing.');

          case 52:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[3, 9], [14, 49], [18, 35, 39, 47], [40,, 42, 46]]);
    }
  }, {
    key: 'hasWorkingWebview',
    value: function hasWorkingWebview() {
      return _regeneratorRuntime.async(function hasWorkingWebview$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/url', 'GET'));

          case 3:
            return context$2$0.abrupt('return', true);

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](0);
            return context$2$0.abrupt('return', false);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 6]]);
    }
  }]);

  return Chromedriver;
})(_events2['default'].EventEmitter);

Chromedriver.EVENT_ERROR = 'chromedriver_error';
Chromedriver.EVENT_CHANGED = 'stateChanged';
Chromedriver.STATE_STOPPED = 'stopped';
Chromedriver.STATE_STARTING = 'starting';
Chromedriver.STATE_ONLINE = 'online';
Chromedriver.STATE_STOPPING = 'stopping';
Chromedriver.STATE_RESTARTING = 'restarting';

exports.Chromedriver = Chromedriver;
exports.CHROMEDRIVER_CHROME_MAPPING = CHROMEDRIVER_CHROME_MAPPING;
exports.getMostRecentChromedriver = getMostRecentChromedriver;
exports['default'] = Chromedriver;

// go through the versions available

// on Android 7+ webviews are backed by the main Chrome, not the system webview

// try out webviews when no bundle id is sent in

// if we do not have a chrome version, it must not be a webview

// make sure it is semver, so later checks won't fail

// unable to get the chrome version

// this is a chrome above the latest version we know about,
// and we have a chromedriver that is beyond what we know,
// so use the most recent chromedriver that we found
//eslint-disable-line curly

// the executable might be set (if passed in)
// or we might want to use the basic one installed with this driver
// or we want to figure out the best one

// we need to make sure that CD hasn't crashed

// retry session start 4 times, sometimes this fails due to adb

// ChromeDriver can return a positive status despite failing

// chromedriver will ask ADB to forward a port like "deviceId tcp:port localabstract:webview_devtools_remote_port"

// sometimes chromedriver stops automating webviews. this method runs a
// simple command to determine our state, and responds accordingly
//# sourceMappingURL=data:application/json;charset=utf8;base64,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Qjs7Ozs7OzZDQUlkLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUM7OztnREFDbEMsSUFBSTs7Ozs7Z0RBRUosS0FBSzs7Ozs7OztLQUVmOzs7U0FqY0csWUFBWTtHQUFTLG9CQUFPLFlBQVk7O0FBb2M5QyxZQUFZLENBQUMsV0FBVyxHQUFHLG9CQUFvQixDQUFDO0FBQ2hELFlBQVksQ0FBQyxhQUFhLEdBQUcsY0FBYyxDQUFDO0FBQzVDLFlBQVksQ0FBQyxhQUFhLEdBQUcsU0FBUyxDQUFDO0FBQ3ZDLFlBQVksQ0FBQyxjQUFjLEdBQUcsVUFBVSxDQUFDO0FBQ3pDLFlBQVksQ0FBQyxZQUFZLEdBQUcsUUFBUSxDQUFDO0FBQ3JDLFlBQVksQ0FBQyxjQUFjLEdBQUcsVUFBVSxDQUFDO0FBQ3pDLFlBQVksQ0FBQyxnQkFBZ0IsR0FBRyxZQUFZLENBQUM7O1FBRXBDLFlBQVksR0FBWixZQUFZO1FBQUUsMkJBQTJCLEdBQTNCLDJCQUEyQjtRQUFFLHlCQUF5QixHQUF6Qix5QkFBeUI7cUJBQzlELFlBQVkiLCJmaWxlIjoibGliL2Nocm9tZWRyaXZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptYWluXG5cbmltcG9ydCBldmVudHMgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IGNwIGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IHsgc3lzdGVtLCBmcywgbG9nZ2VyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCwgYXN5bmNtYXAgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBTdWJQcm9jZXNzLCBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IGdldENocm9tZVZlcnNpb24sIGdldENocm9tZWRyaXZlckRpciwgZ2V0Q2hyb21lZHJpdmVyQmluYXJ5UGF0aCB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ0Nocm9tZWRyaXZlcicpO1xuXG5jb25zdCBERUZBVUxUX0hPU1QgPSAnMTI3LjAuMC4xJztcbmNvbnN0IERFRkFVTFRfUE9SVCA9IDk1MTU7XG5jb25zdCBDSFJPTUVEUklWRVJfQ0hST01FX01BUFBJTkcgPSB7XG4gIC8vIENocm9tZWRyaXZlciB2ZXJzaW9uOiBtaW51bXVtIENocm9tZSB2ZXJzaW9uXG4gICcyLjQxJzogJzY3LjAuMzM5NicsXG4gICcyLjQwJzogJzY2LjAuMzM1OScsXG4gICcyLjM5JzogJzY2LjAuMzM1OScsXG4gICcyLjM4JzogJzY1LjAuMzMyNScsXG4gICcyLjM3JzogJzY0LjAuMzI4MicsXG4gICcyLjM2JzogJzYzLjAuMzIzOScsXG4gICcyLjM1JzogJzYyLjAuMzIwMicsXG4gICcyLjM0JzogJzYxLjAuMzE2MycsXG4gICcyLjMzJzogJzYwLjAuMzExMicsXG4gICcyLjMyJzogJzU5LjAuMzA3MScsXG4gICcyLjMxJzogJzU4LjAuMzAyOScsXG4gICcyLjMwJzogJzU4LjAuMzAyOScsXG4gICcyLjI5JzogJzU3LjAuMjk4NycsXG4gICcyLjI4JzogJzU1LjAuMjg4MycsXG4gICcyLjI3JzogJzU0LjAuMjg0MCcsXG4gICcyLjI2JzogJzUzLjAuMjc4NScsXG4gICcyLjI1JzogJzUzLjAuMjc4NScsXG4gICcyLjI0JzogJzUyLjAuMjc0MycsXG4gICcyLjIzJzogJzUxLjAuMjcwNCcsXG4gICcyLjIyJzogJzQ5LjAuMjYyMycsXG4gICcyLjIxJzogJzQ2LjAuMjQ5MCcsXG4gICcyLjIwJzogJzQzLjAuMjM1NycsXG4gICcyLjE5JzogJzQzLjAuMjM1NycsXG4gICcyLjE4JzogJzQzLjAuMjM1NycsXG4gICcyLjE3JzogJzQyLjAuMjMxMScsXG4gICcyLjE2JzogJzQyLjAuMjMxMScsXG4gICcyLjE1JzogJzQwLjAuMjIxNCcsXG4gICcyLjE0JzogJzM5LjAuMjE3MScsXG4gICcyLjEzJzogJzM4LjAuMjEyNScsXG4gICcyLjEyJzogJzM2LjAuMTk4NScsXG4gICcyLjExJzogJzM2LjAuMTk4NScsXG4gICcyLjEwJzogJzMzLjAuMTc1MScsXG4gICcyLjknOiAnMzEuMC4xNjUwJyxcbiAgJzIuOCc6ICczMC4wLjE1NzMnLFxuICAnMi43JzogJzMwLjAuMTU3MycsXG4gICcyLjYnOiAnMjkuMC4xNTQ1JyxcbiAgJzIuNSc6ICcyOS4wLjE1NDUnLFxuICAnMi40JzogJzI5LjAuMTU0NScsXG4gICcyLjMnOiAnMjguMC4xNTAwJyxcbiAgJzIuMic6ICcyNy4wLjE0NTMnLFxuICAnMi4xJzogJzI3LjAuMTQ1MycsXG4gICcyLjAnOiAnMjcuMC4xNDUzJyxcbn07XG5jb25zdCBDSFJPTUVfQlVORExFX0lEID0gJ2NvbS5hbmRyb2lkLmNocm9tZSc7XG5jb25zdCBXRUJWSUVXX0JVTkRMRV9JRFMgPSBbXG4gICdjb20uZ29vZ2xlLmFuZHJvaWQud2VidmlldycsXG4gICdjb20uYW5kcm9pZC53ZWJ2aWV3Jyxcbl07XG5cbmZ1bmN0aW9uIGdldE1vc3RSZWNlbnRDaHJvbWVkcml2ZXIgKG1hcHBpbmcgPSBDSFJPTUVEUklWRVJfQ0hST01FX01BUFBJTkcpIHtcbiAgaWYgKF8uaXNFbXB0eShtYXBwaW5nKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignVW5hYmxlIHRvIGdldCBtb3N0IHJlY2VudCBDaHJvbWVkcml2ZXIgZnJvbSBlbXB0eSBtYXBwaW5nJyk7XG4gIH1cbiAgcmV0dXJuIF8ua2V5cyhtYXBwaW5nKVxuICAgIC5tYXAoc2VtdmVyLmNvZXJjZSlcbiAgICAuc29ydChzZW12ZXIucmNvbXBhcmUpXG4gICAgLm1hcCgodikgPT4gYCR7c2VtdmVyLm1ham9yKHYpfS4ke3NlbXZlci5taW5vcih2KX1gKVswXTtcbn1cblxuY2xhc3MgQ2hyb21lZHJpdmVyIGV4dGVuZHMgZXZlbnRzLkV2ZW50RW1pdHRlciB7XG4gIGNvbnN0cnVjdG9yIChhcmdzID0ge30pIHtcbiAgICBzdXBlcigpO1xuXG4gICAgY29uc3Qge1xuICAgICAgaG9zdCA9IERFRkFVTFRfSE9TVCxcbiAgICAgIHBvcnQgPSBERUZBVUxUX1BPUlQsXG4gICAgICB1c2VTeXN0ZW1FeGVjdXRhYmxlID0gZmFsc2UsXG4gICAgICBleGVjdXRhYmxlLFxuICAgICAgZXhlY3V0YWJsZURpciA9IGdldENocm9tZWRyaXZlckRpcigpLFxuICAgICAgYnVuZGxlSWQsXG4gICAgICBtYXBwaW5nUGF0aCxcbiAgICAgIGNtZEFyZ3MsXG4gICAgICBhZGIsXG4gICAgICB2ZXJib3NlLFxuICAgICAgbG9nUGF0aCxcbiAgICB9ID0gYXJncztcblxuICAgIHRoaXMucHJveHlIb3N0ID0gaG9zdDtcbiAgICB0aGlzLnByb3h5UG9ydCA9IHBvcnQ7XG4gICAgdGhpcy5hZGIgPSBhZGI7XG4gICAgdGhpcy5jbWRBcmdzID0gY21kQXJncztcbiAgICB0aGlzLnByb2MgPSBudWxsO1xuICAgIHRoaXMudXNlU3lzdGVtRXhlY3V0YWJsZSA9IHVzZVN5c3RlbUV4ZWN1dGFibGU7XG4gICAgdGhpcy5jaHJvbWVkcml2ZXIgPSBleGVjdXRhYmxlO1xuICAgIHRoaXMuZXhlY3V0YWJsZURpciA9IGV4ZWN1dGFibGVEaXI7XG4gICAgdGhpcy5tYXBwaW5nUGF0aCA9IG1hcHBpbmdQYXRoO1xuICAgIHRoaXMuYnVuZGxlSWQgPSBidW5kbGVJZDtcbiAgICB0aGlzLmV4ZWN1dGFibGVWZXJpZmllZCA9IGZhbHNlO1xuICAgIHRoaXMuc3RhdGUgPSBDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBFRDtcbiAgICB0aGlzLmp3cHJveHkgPSBuZXcgSldQcm94eSh7c2VydmVyOiB0aGlzLnByb3h5SG9zdCwgcG9ydDogdGhpcy5wcm94eVBvcnR9KTtcbiAgICB0aGlzLnZlcmJvc2UgPSB2ZXJib3NlO1xuICAgIHRoaXMubG9nUGF0aCA9IGxvZ1BhdGg7XG4gIH1cblxuICBhc3luYyBnZXRNYXBwaW5nICgpIHtcbiAgICBsZXQgbWFwcGluZyA9IENIUk9NRURSSVZFUl9DSFJPTUVfTUFQUElORztcbiAgICBpZiAodGhpcy5tYXBwaW5nUGF0aCkge1xuICAgICAgbG9nLmRlYnVnKGBBdHRlbXB0aW5nIHRvIHVzZSBDaHJvbWVkcml2ZXItQ2hyb21lIG1hcHBpbmcgZnJvbSAnJHt0aGlzLm1hcHBpbmdQYXRofSdgKTtcbiAgICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHRoaXMubWFwcGluZ1BhdGgpKSB7XG4gICAgICAgIGxvZy53YXJuKGBObyBmaWxlIGZvdW5kIGF0ICcke3RoaXMubWFwcGluZ1BhdGh9Jy4gVXNpbmcgZGVmYXVsdCBtYXBwaW5nYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIG1hcHBpbmcgPSBKU09OLnBhcnNlKGF3YWl0IGZzLnJlYWRGaWxlKHRoaXMubWFwcGluZ1BhdGgpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLmVycm9yKGBFcnJvciBwYXJzaW5nIG1hcHBpbmcgZnJvbSAnJHt0aGlzLm1hcHBpbmdQYXRofSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgbG9nLndhcm4oJ1VzaW5nIGRlZmF1bHQgbWFwcGluZycpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gbWFrZSBzdXJlIHRoYXQgdGhlIHZhbHVlcyBmb3IgbWluaW11bSBjaHJvbWUgdmVyc2lvbiBhcmUgc2VtdmVyIGNvbXBsaWFudFxuICAgIGZvciAoY29uc3QgW2NkVmVyc2lvbiwgY2hyb21lVmVyc2lvbl0gb2YgXy50b1BhaXJzKG1hcHBpbmcpKSB7XG4gICAgICBtYXBwaW5nW2NkVmVyc2lvbl0gPSBzZW12ZXIuY29lcmNlKGNocm9tZVZlcnNpb24pO1xuICAgIH1cbiAgICByZXR1cm4gbWFwcGluZztcbiAgfVxuXG4gIGFzeW5jIGdldENocm9tZWRyaXZlcnMgKG1hcHBpbmcpIHtcbiAgICAvLyBnbyB0aHJvdWdoIHRoZSB2ZXJzaW9ucyBhdmFpbGFibGVcbiAgICBjb25zdCBleGVjdXRhYmxlcyA9IGF3YWl0IGZzLmdsb2IoYCR7dGhpcy5leGVjdXRhYmxlRGlyfS8qYCk7XG4gICAgbG9nLmRlYnVnKGBGb3VuZCAke2V4ZWN1dGFibGVzLmxlbmd0aH0gZXhlY3V0YWJsZSR7ZXhlY3V0YWJsZXMubGVuZ3RoID09PSAxID8gJyc6ICdzJ30gYCArXG4gICAgICBgaW4gJyR7dGhpcy5leGVjdXRhYmxlRGlyfSdgKTtcbiAgICBjb25zdCBjZHMgPSAoYXdhaXQgYXN5bmNtYXAoZXhlY3V0YWJsZXMsIGFzeW5jIGZ1bmN0aW9uIChleGVjdXRhYmxlKSB7XG4gICAgICBjb25zdCBsb2dFcnJvciA9ICh7bWVzc2FnZSwgc3Rkb3V0ID0gbnVsbCwgc3RkZXJyID0gbnVsbH0pID0+IHtcbiAgICAgICAgbGV0IGVyck1zZyA9IGBDYW5ub3QgcmV0cmlldmUgdmVyc2lvbiBudW1iZXIgZnJvbSAnJHtwYXRoLmJhc2VuYW1lKGV4ZWN1dGFibGUpfScgQ2hyb21lZHJpdmVyIGJpbmFyeS4gYCArXG4gICAgICAgICAgYE1ha2Ugc3VyZSBpdCByZXR1cm5zIGEgdmFsaWQgdmVyc2lvbiBzdHJpbmcgaW4gcmVzcG9uc2UgdG8gJy0tdmVyc2lvbicgY29tbWFuZCBsaW5lIGFyZ3VtZW50LiAke21lc3NhZ2V9YDtcbiAgICAgICAgaWYgKHN0ZG91dCkge1xuICAgICAgICAgIGVyck1zZyArPSBgXFxuU3Rkb3V0OiAke3N0ZG91dH1gO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdGRlcnIpIHtcbiAgICAgICAgICBlcnJNc2cgKz0gYFxcblN0ZGVycjogJHtzdGRlcnJ9YDtcbiAgICAgICAgfVxuICAgICAgICBsb2cud2FybihlcnJNc2cpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH07XG5cbiAgICAgIGxldCBzdGRvdXQ7XG4gICAgICBsZXQgc3RkZXJyO1xuICAgICAgdHJ5IHtcbiAgICAgICAgKHtzdGRvdXQsIHN0ZGVycn0gPSBhd2FpdCBleGVjKGV4ZWN1dGFibGUsIFsnLS12ZXJzaW9uJ10pKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXR1cm4gbG9nRXJyb3IoZXJyKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgbWF0Y2ggPSAvQ2hyb21lRHJpdmVyXFxzKFxcZCtcXC5cXGQrKVxcLlxcZCtcXHMvLmV4ZWMoc3Rkb3V0KTtcbiAgICAgIGlmICghbWF0Y2gpIHtcbiAgICAgICAgcmV0dXJuIGxvZ0Vycm9yKHttZXNzYWdlOiAnQ2Fubm90IHBhcnNlIHRoZSB2ZXJzaW9uIHN0cmluZycsIHN0ZG91dCwgc3RkZXJyfSk7XG4gICAgICB9XG4gICAgICBjb25zdCB2ZXJzaW9uID0gbWF0Y2hbMV07XG4gICAgICByZXR1cm4ge1xuICAgICAgICBleGVjdXRhYmxlLFxuICAgICAgICB2ZXJzaW9uLFxuICAgICAgICBtaW5DRFZlcnNpb246IG1hcHBpbmdbdmVyc2lvbl0sXG4gICAgICB9O1xuICAgIH0pKVxuICAgICAgLmZpbHRlcigoY2QpID0+ICEhY2QpXG4gICAgICAuc29ydCgoYSwgYikgPT4gc2VtdmVyLmd0ZShzZW12ZXIuY29lcmNlKGIudmVyc2lvbiksIHNlbXZlci5jb2VyY2UoYS52ZXJzaW9uKSkgPyAxIDogLTEpO1xuICAgIGlmIChfLmlzRW1wdHkoY2RzKSkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYE5vIENocm9tZWRyaXZlcnMgZm91bmQgaW4gJyR7dGhpcy5leGVjdXRhYmxlRGlyfSdgKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBUaGUgZm9sbG93aW5nIENocm9tZWRyaXZlciBleGVjdXRhYmxlcyB3ZXJlIGZvdW5kOmApO1xuICAgIGZvciAoY29uc3QgY2Qgb2YgY2RzKSB7XG4gICAgICBsb2cuZGVidWcoYCAgICAke2NkLmV4ZWN1dGFibGV9IChtaW5pbXVtIENocm9tZSB2ZXJzaW9uICcke2NkLm1pbkNEVmVyc2lvbiA/IGNkLm1pbkNEVmVyc2lvbiA6ICdVbmtub3duJ30nKWApO1xuICAgIH1cbiAgICByZXR1cm4gY2RzO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q2hyb21lVmVyc2lvbiAoKSB7XG4gICAgbGV0IGNocm9tZVZlcnNpb247XG5cbiAgICAvLyBvbiBBbmRyb2lkIDcrIHdlYnZpZXdzIGFyZSBiYWNrZWQgYnkgdGhlIG1haW4gQ2hyb21lLCBub3QgdGhlIHN5c3RlbSB3ZWJ2aWV3XG4gICAgaWYgKHRoaXMuYWRiICYmIGF3YWl0IHRoaXMuYWRiLmdldEFwaUxldmVsKCkgPj0gMjQpIHtcbiAgICAgIHRoaXMuYnVuZGxlSWQgPSBDSFJPTUVfQlVORExFX0lEO1xuICAgIH1cblxuICAgIC8vIHRyeSBvdXQgd2Vidmlld3Mgd2hlbiBubyBidW5kbGUgaWQgaXMgc2VudCBpblxuICAgIGlmICghdGhpcy5idW5kbGVJZCkge1xuICAgICAgLy8gZGVmYXVsdCB0byB0aGUgZ2VuZXJpYyBDaHJvbWUgYnVuZGxlXG4gICAgICB0aGlzLmJ1bmRsZUlkID0gQ0hST01FX0JVTkRMRV9JRDtcblxuICAgICAgLy8gd2UgaGF2ZSBhIHdlYnZpZXcgb2Ygc29tZSBzb3J0LCBzbyB0cnkgdG8gZmluZCB0aGUgYnVuZGxlIHZlcnNpb25cbiAgICAgIGZvciAoY29uc3QgYnVuZGxlSWQgb2YgV0VCVklFV19CVU5ETEVfSURTKSB7XG4gICAgICAgIGNocm9tZVZlcnNpb24gPSBhd2FpdCBnZXRDaHJvbWVWZXJzaW9uKHRoaXMuYWRiLCBidW5kbGVJZCk7XG4gICAgICAgIGlmIChjaHJvbWVWZXJzaW9uKSB7XG4gICAgICAgICAgdGhpcy5idW5kbGVJZCA9IGJ1bmRsZUlkO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gaWYgd2UgZG8gbm90IGhhdmUgYSBjaHJvbWUgdmVyc2lvbiwgaXQgbXVzdCBub3QgYmUgYSB3ZWJ2aWV3XG4gICAgaWYgKCFjaHJvbWVWZXJzaW9uKSB7XG4gICAgICBjaHJvbWVWZXJzaW9uID0gYXdhaXQgZ2V0Q2hyb21lVmVyc2lvbih0aGlzLmFkYiwgdGhpcy5idW5kbGVJZCk7XG4gICAgfVxuXG4gICAgLy8gbWFrZSBzdXJlIGl0IGlzIHNlbXZlciwgc28gbGF0ZXIgY2hlY2tzIHdvbid0IGZhaWxcbiAgICByZXR1cm4gY2hyb21lVmVyc2lvbiA/IHNlbXZlci5jb2VyY2UoY2hyb21lVmVyc2lvbikgOiBudWxsO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q29tcGF0aWJsZUNocm9tZWRyaXZlciAoKSB7XG4gICAgaWYgKCF0aGlzLmFkYikge1xuICAgICAgcmV0dXJuIGF3YWl0IGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgoKTtcbiAgICB9XG5cbiAgICBjb25zdCBtYXBwaW5nID0gYXdhaXQgdGhpcy5nZXRNYXBwaW5nKCk7XG4gICAgY29uc3QgY2RzID0gYXdhaXQgdGhpcy5nZXRDaHJvbWVkcml2ZXJzKG1hcHBpbmcpO1xuXG4gICAgY29uc3QgY2hyb21lVmVyc2lvbiA9IGF3YWl0IHRoaXMuZ2V0Q2hyb21lVmVyc2lvbigpO1xuXG4gICAgaWYgKCFjaHJvbWVWZXJzaW9uKSB7XG4gICAgICAvLyB1bmFibGUgdG8gZ2V0IHRoZSBjaHJvbWUgdmVyc2lvblxuICAgICAgbGV0IGNkID0gY2RzWzBdO1xuICAgICAgbG9nLndhcm4oYFVuYWJsZSB0byBkaXNjb3ZlciBDaHJvbWUgdmVyc2lvbi4gVXNpbmcgQ2hyb21lZHJpdmVyICR7Y2QudmVyc2lvbn0gYXQgJyR7Y2QuZXhlY3V0YWJsZX0nYCk7XG4gICAgICByZXR1cm4gY2QuZXhlY3V0YWJsZTtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYEZvdW5kIENocm9tZSBidW5kbGUgJyR7dGhpcy5idW5kbGVJZH0nIHZlcnNpb24gJyR7Y2hyb21lVmVyc2lvbn0nYCk7XG5cbiAgICBpZiAoc2VtdmVyLmd0KGNocm9tZVZlcnNpb24sIF8udmFsdWVzKG1hcHBpbmcpWzBdKSAmJlxuICAgICAgICAhXy5pc1VuZGVmaW5lZChjZHNbMF0pICYmIF8uaXNVbmRlZmluZWQoY2RzWzBdLm1pbkNEVmVyc2lvbikpIHtcbiAgICAgIC8vIHRoaXMgaXMgYSBjaHJvbWUgYWJvdmUgdGhlIGxhdGVzdCB2ZXJzaW9uIHdlIGtub3cgYWJvdXQsXG4gICAgICAvLyBhbmQgd2UgaGF2ZSBhIGNocm9tZWRyaXZlciB0aGF0IGlzIGJleW9uZCB3aGF0IHdlIGtub3csXG4gICAgICAvLyBzbyB1c2UgdGhlIG1vc3QgcmVjZW50IGNocm9tZWRyaXZlciB0aGF0IHdlIGZvdW5kXG4gICAgICBsZXQgY2QgPSBjZHNbMF07XG4gICAgICBsb2cud2FybihgTm8ga25vd24gQ2hyb21lZHJpdmVyIGF2YWlsYWJsZSB0byBhdXRvbWF0ZSBDaHJvbWUgdmVyc2lvbiAnJHtjaHJvbWVWZXJzaW9ufScuXFxuYCArXG4gICAgICAgICAgICAgICBgVXNpbmcgQ2hyb21lZHJpdmVyIHZlcnNpb24gJyR7Y2QudmVyc2lvbn0nLCB3aGljaCBoYXMgbm90IGJlZW4gdGVzdGVkIHdpdGggQXBwaXVtLmApO1xuICAgICAgcmV0dXJuIGNkLmV4ZWN1dGFibGU7XG4gICAgfVxuXG4gICAgY29uc3Qgd29ya2luZ0NkcyA9IGNkcy5maWx0ZXIoKGNkKSA9PiB7XG4gICAgICByZXR1cm4gIV8uaXNVbmRlZmluZWQoY2QubWluQ0RWZXJzaW9uKSAmJiBzZW12ZXIuZ3RlKGNocm9tZVZlcnNpb24sIGNkLm1pbkNEVmVyc2lvbik7XG4gICAgfSk7XG5cbiAgICBpZiAoXy5pc0VtcHR5KHdvcmtpbmdDZHMpKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgTm8gQ2hyb21lZHJpdmVyIGZvdW5kIHRoYXQgY2FuIGF1dG9tYXRlIENocm9tZSAnJHtjaHJvbWVWZXJzaW9ufScuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgYFNlZSBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9ibG9iL21hc3Rlci9kb2NzL2VuL3dyaXRpbmctcnVubmluZy1hcHBpdW0vd2ViL2Nocm9tZWRyaXZlci5tZCBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgIGBmb3IgbW9yZSBkZXRhaWxzLmApO1xuICAgIH1cblxuICAgIGNvbnN0IGJpblBhdGggPSB3b3JraW5nQ2RzWzBdLmV4ZWN1dGFibGU7XG4gICAgbG9nLmRlYnVnKGBGb3VuZCAke3dvcmtpbmdDZHMubGVuZ3RofSBDaHJvbWVkcml2ZXIgZXhlY3V0YWJsZSR7d29ya2luZ0Nkcy5sZW5ndGggPT09IDEgPyAnJyA6ICdzJ30gYCArXG4gICAgICAgICAgICAgIGBjYXBhYmxlIG9mIGF1dG9tYXRpbmcgQ2hyb21lICcke2Nocm9tZVZlcnNpb259Jy5cXG5gICtcbiAgICAgICAgICAgICAgYENob29zaW5nIHRoZSBtb3N0IHJlY2VudCwgJyR7YmluUGF0aH0nLmApO1xuICAgIGxvZy5kZWJ1ZygnSWYgYSBzcGVjaWZpYyB2ZXJzaW9uIGlzIHJlcXVpcmVkLCBzcGVjaWZ5IGl0IHdpdGggdGhlIGBjaHJvbWVkcml2ZXJFeGVjdXRhYmxlYCcgK1xuICAgICAgICAgICAgICAnZGVzaXJlZCBjYXBhYmlsaXR5LicpO1xuICAgIHJldHVybiBiaW5QYXRoO1xuICB9XG5cbiAgYXN5bmMgaW5pdENocm9tZWRyaXZlclBhdGggKCkge1xuICAgIGlmICh0aGlzLmV4ZWN1dGFibGVWZXJpZmllZCkgcmV0dXJuOyAvL2VzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcblxuICAgIC8vIHRoZSBleGVjdXRhYmxlIG1pZ2h0IGJlIHNldCAoaWYgcGFzc2VkIGluKVxuICAgIC8vIG9yIHdlIG1pZ2h0IHdhbnQgdG8gdXNlIHRoZSBiYXNpYyBvbmUgaW5zdGFsbGVkIHdpdGggdGhpcyBkcml2ZXJcbiAgICAvLyBvciB3ZSB3YW50IHRvIGZpZ3VyZSBvdXQgdGhlIGJlc3Qgb25lXG4gICAgaWYgKCF0aGlzLmNocm9tZWRyaXZlcikge1xuICAgICAgdGhpcy5jaHJvbWVkcml2ZXIgPSB0aGlzLnVzZVN5c3RlbUV4ZWN1dGFibGVcbiAgICAgICAgPyBhd2FpdCBnZXRDaHJvbWVkcml2ZXJCaW5hcnlQYXRoKClcbiAgICAgICAgOiBhd2FpdCB0aGlzLmdldENvbXBhdGlibGVDaHJvbWVkcml2ZXIoKTtcbiAgICB9XG5cbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyh0aGlzLmNocm9tZWRyaXZlcikpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJ5aW5nIHRvIHVzZSBhIGNocm9tZWRyaXZlciBiaW5hcnkgYXQgdGhlIHBhdGggYCArXG4gICAgICAgICAgICAgICAgICAgICAgYCR7dGhpcy5jaHJvbWVkcml2ZXJ9LCBidXQgaXQgZG9lc24ndCBleGlzdCFgKTtcbiAgICB9XG4gICAgdGhpcy5leGVjdXRhYmxlVmVyaWZpZWQgPSB0cnVlO1xuICAgIGxvZy5pbmZvKGBTZXQgY2hyb21lZHJpdmVyIGJpbmFyeSBhczogJHt0aGlzLmNocm9tZWRyaXZlcn1gKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0IChjYXBzLCBlbWl0U3RhcnRpbmdTdGF0ZSA9IHRydWUpIHtcbiAgICB0aGlzLmNhcGFiaWxpdGllcyA9IGNhcHM7XG4gICAgaWYgKGVtaXRTdGFydGluZ1N0YXRlKSB7XG4gICAgICB0aGlzLmNoYW5nZVN0YXRlKENocm9tZWRyaXZlci5TVEFURV9TVEFSVElORyk7XG4gICAgfVxuXG4gICAgbGV0IGFyZ3MgPSBbXCItLXVybC1iYXNlPXdkL2h1YlwiLCBgLS1wb3J0PSR7dGhpcy5wcm94eVBvcnR9YF07XG4gICAgaWYgKHRoaXMuYWRiICYmIHRoaXMuYWRiLmFkYlBvcnQpIHtcbiAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbYC0tYWRiLXBvcnQ9JHt0aGlzLmFkYi5hZGJQb3J0fWBdKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuY21kQXJncykge1xuICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KHRoaXMuY21kQXJncyk7XG4gICAgfVxuICAgIGlmICh0aGlzLmxvZ1BhdGgpIHtcbiAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbYC0tbG9nLXBhdGg9JHt0aGlzLmxvZ1BhdGh9YF0pO1xuICAgIH1cbiAgICBhcmdzID0gYXJncy5jb25jYXQoWyctLXZlcmJvc2UnXSk7XG4gICAgLy8gd2hhdCBhcmUgdGhlIHByb2Nlc3Mgc3Rkb3V0L3N0ZGVyciBjb25kaXRpb25zIHdoZXJlaW4gd2Uga25vdyB0aGF0XG4gICAgLy8gdGhlIHByb2Nlc3MgaGFzIHN0YXJ0ZWQgdG8gb3VyIHNhdGlzZmFjdGlvbj9cbiAgICBjb25zdCBzdGFydERldGVjdG9yID0gKHN0ZG91dCkgPT4ge1xuICAgICAgcmV0dXJuIHN0ZG91dC5pbmRleE9mKCdTdGFydGluZyAnKSA9PT0gMDtcbiAgICB9O1xuXG4gICAgbGV0IHByb2Nlc3NJc0FsaXZlID0gZmFsc2U7XG4gICAgbGV0IHdlYnZpZXdWZXJzaW9uO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmluaXRDaHJvbWVkcml2ZXJQYXRoKCk7XG4gICAgICBhd2FpdCB0aGlzLmtpbGxBbGwoKTtcblxuICAgICAgLy8gc2V0IHVwIG91ciBzdWJwcm9jZXNzIG9iamVjdFxuICAgICAgdGhpcy5wcm9jID0gbmV3IFN1YlByb2Nlc3ModGhpcy5jaHJvbWVkcml2ZXIsIGFyZ3MpO1xuICAgICAgcHJvY2Vzc0lzQWxpdmUgPSB0cnVlO1xuXG4gICAgICAvLyBoYW5kbGUgbG9nIG91dHB1dFxuICAgICAgdGhpcy5wcm9jLm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgICAgLy8gaWYgdGhlIGNkIG91dHB1dCBpcyBub3QgcHJpbnRlZCwgZmluZCB0aGUgY2hyb21lIHZlcnNpb24gYW5kIHByaW50XG4gICAgICAgIC8vIHdpbGwgZ2V0IGEgcmVzcG9uc2UgbGlrZVxuICAgICAgICAvLyAgIERldlRvb2xzIHJlc3BvbnNlOiB7XG4gICAgICAgIC8vICAgICAgXCJBbmRyb2lkLVBhY2thZ2VcIjogXCJpby5hcHBpdW0uc2FtcGxlYXBwXCIsXG4gICAgICAgIC8vICAgICAgXCJCcm93c2VyXCI6IFwiQ2hyb21lLzU1LjAuMjg4My45MVwiLFxuICAgICAgICAvLyAgICAgIFwiUHJvdG9jb2wtVmVyc2lvblwiOiBcIjEuMlwiLFxuICAgICAgICAvLyAgICAgIFwiVXNlci1BZ2VudFwiOiBcIi4uLlwiLFxuICAgICAgICAvLyAgICAgIFwiV2ViS2l0LVZlcnNpb25cIjogXCI1MzcuMzZcIlxuICAgICAgICAvLyAgIH1cbiAgICAgICAgY29uc3Qgb3V0ID0gc3Rkb3V0ICsgc3RkZXJyO1xuICAgICAgICBsZXQgbWF0Y2ggPSAvXCJCcm93c2VyXCI6IFwiKC4qKVwiLy5leGVjKG91dCk7XG4gICAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICAgIHdlYnZpZXdWZXJzaW9uID0gbWF0Y2hbMV07XG4gICAgICAgICAgbG9nLmRlYnVnKGBXZWJ2aWV3IHZlcnNpb246ICcke3dlYnZpZXdWZXJzaW9ufSdgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGFsc28gcHJpbnQgY2hyb21lZHJpdmVyIHZlcnNpb24gdG8gbG9nc1xuICAgICAgICAvLyB3aWxsIG91dHB1dCBzb21ldGhpbmcgbGlrZVxuICAgICAgICAvLyAgU3RhcnRpbmcgQ2hyb21lRHJpdmVyIDIuMzMuNTA2MTA2ICg4YTA2YzM5YzQ1ODJmYmZiYWI2OTY2ZGJiMWMzOGE5MTczYmZiMWEyKSBvbiBwb3J0IDk1MTVcbiAgICAgICAgbWF0Y2ggPSAvU3RhcnRpbmcgQ2hyb21lRHJpdmVyIChbXFwuXFxkXSspLy5leGVjKG91dCk7XG4gICAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgQ2hyb21lZHJpdmVyIHZlcnNpb246ICcke21hdGNoWzFdfSdgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGdpdmUgdGhlIG91dHB1dCBpZiBpdCBpcyByZXF1ZXN0ZWRcbiAgICAgICAgaWYgKHRoaXMudmVyYm9zZSkge1xuICAgICAgICAgIGZvciAobGV0IGxpbmUgb2YgKHN0ZG91dCB8fCAnJykudHJpbSgpLnNwbGl0KCdcXG4nKSkge1xuICAgICAgICAgICAgaWYgKCFsaW5lLnRyaW0oKS5sZW5ndGgpIGNvbnRpbnVlOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG4gICAgICAgICAgICBsb2cuZGVidWcoYFtTVERPVVRdICR7bGluZX1gKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZm9yIChsZXQgbGluZSBvZiAoc3RkZXJyIHx8ICcnKS50cmltKCkuc3BsaXQoJ1xcbicpKSB7XG4gICAgICAgICAgICBpZiAoIWxpbmUudHJpbSgpLmxlbmd0aCkgY29udGludWU7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICAgICAgICAgIGxvZy5lcnJvcihgW1NUREVSUl0gJHtsaW5lfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIC8vIGhhbmRsZSBvdXQtb2YtYm91bmQgZXhpdCBieSBzaW1wbHkgZW1pdHRpbmcgYSBzdG9wcGVkIHN0YXRlXG4gICAgICB0aGlzLnByb2Mub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICAgIHByb2Nlc3NJc0FsaXZlID0gZmFsc2U7XG4gICAgICAgIGlmICh0aGlzLnN0YXRlICE9PSBDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBFRCAmJlxuICAgICAgICAgICAgdGhpcy5zdGF0ZSAhPT0gQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQSU5HICYmXG4gICAgICAgICAgICB0aGlzLnN0YXRlICE9PSBDaHJvbWVkcml2ZXIuU1RBVEVfUkVTVEFSVElORykge1xuICAgICAgICAgIGxldCBtc2cgPSBgQ2hyb21lZHJpdmVyIGV4aXRlZCB1bmV4cGVjdGVkbHkgd2l0aCBjb2RlICR7Y29kZX0sIGAgK1xuICAgICAgICAgICAgICAgICAgICBgc2lnbmFsICR7c2lnbmFsfWA7XG4gICAgICAgICAgbG9nLmVycm9yKG1zZyk7XG4gICAgICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBFRCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgbG9nLmluZm8oYFNwYXduaW5nIGNocm9tZWRyaXZlciB3aXRoOiAke3RoaXMuY2hyb21lZHJpdmVyfSBgICtcbiAgICAgICAgICAgICAgIGAke2FyZ3Muam9pbignICcpfWApO1xuICAgICAgLy8gc3RhcnQgc3VicHJvYyBhbmQgd2FpdCBmb3Igc3RhcnREZXRlY3RvclxuICAgICAgYXdhaXQgdGhpcy5wcm9jLnN0YXJ0KHN0YXJ0RGV0ZWN0b3IpO1xuICAgICAgYXdhaXQgdGhpcy53YWl0Rm9yT25saW5lKCk7XG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0U2Vzc2lvbigpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuZW1pdChDaHJvbWVkcml2ZXIuRVZFTlRfRVJST1IsIGUpO1xuICAgICAgLy8ganVzdCBiZWNhdXNlIHdlIGhhZCBhbiBlcnJvciBkb2Vzbid0IG1lYW4gdGhlIGNocm9tZWRyaXZlciBwcm9jZXNzXG4gICAgICAvLyBmaW5pc2hlZDsgd2Ugc2hvdWxkIGNsZWFuIHVwIGlmIG5lY2Vzc2FyeVxuICAgICAgaWYgKHByb2Nlc3NJc0FsaXZlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvYy5zdG9wKCk7XG4gICAgICB9XG5cbiAgICAgIC8vIG9mdGVuIHRoZSB1c2VyJ3MgQ2hyb21lIHZlcnNpb24gaXMgdG9vIGxvdyBmb3IgdGhlIHZlcnNpb24gb2YgQ2hyb21lZHJpdmVyXG4gICAgICBpZiAoZS5tZXNzYWdlLmluZGV4T2YoJ0Nocm9tZSB2ZXJzaW9uIG11c3QgYmUnKSAhPT0gLTEpIHtcbiAgICAgICAgbG9nLmVycm9yKCdVbmFibGUgdG8gYXV0b21hdGUgQ2hyb21lIHZlcnNpb24gYmVjYXVzZSBpdCBpcyB0b28gb2xkIGZvciB0aGlzIHZlcnNpb24gb2YgQ2hyb21lZHJpdmVyLicpO1xuICAgICAgICBpZiAod2Vidmlld1ZlcnNpb24pIHtcbiAgICAgICAgICBsb2cuZXJyb3IoYENocm9tZSB2ZXJzaW9uIG9uIGRldmljZTogJHt3ZWJ2aWV3VmVyc2lvbn1gKTtcbiAgICAgICAgfVxuICAgICAgICBsb2cuZXJyb3IoYFBsZWFzZSBzZWUgJ2h0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2Jsb2IvbWFzdGVyL2RvY3MvZW4vd3JpdGluZy1ydW5uaW5nLWFwcGl1bS93ZWIvY2hyb21lZHJpdmVyLm1kJ2ApO1xuICAgICAgfVxuICAgICAgbG9nLmVycm9yQW5kVGhyb3coZSk7XG4gICAgfVxuICB9XG5cbiAgc2Vzc2lvbklkICgpIHtcbiAgICBpZiAodGhpcy5zdGF0ZSAhPT0gQ2hyb21lZHJpdmVyLlNUQVRFX09OTElORSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuandwcm94eS5zZXNzaW9uSWQ7XG4gIH1cblxuICBhc3luYyByZXN0YXJ0ICgpIHtcbiAgICBsb2cuaW5mbyhcIlJlc3RhcnRpbmcgY2hyb21lZHJpdmVyXCIpO1xuICAgIGlmICh0aGlzLnN0YXRlICE9PSBDaHJvbWVkcml2ZXIuU1RBVEVfT05MSU5FKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW4ndCByZXN0YXJ0IHdoZW4gd2UncmUgbm90IG9ubGluZVwiKTtcbiAgICB9XG4gICAgdGhpcy5jaGFuZ2VTdGF0ZShDaHJvbWVkcml2ZXIuU1RBVEVfUkVTVEFSVElORyk7XG4gICAgYXdhaXQgdGhpcy5zdG9wKGZhbHNlKTtcbiAgICBhd2FpdCB0aGlzLnN0YXJ0KHRoaXMuY2FwYWJpbGl0aWVzLCBmYWxzZSk7XG4gIH1cblxuICBhc3luYyB3YWl0Rm9yT25saW5lICgpIHtcbiAgICAvLyB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0IENEIGhhc24ndCBjcmFzaGVkXG4gICAgbGV0IGNocm9tZWRyaXZlclN0b3BwZWQgPSBmYWxzZTtcbiAgICBhd2FpdCByZXRyeUludGVydmFsKDIwLCAyMDAsIGFzeW5jICgpID0+IHtcbiAgICAgIGlmICh0aGlzLnN0YXRlID09PSBDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBFRCkge1xuICAgICAgICAvLyB3ZSBhcmUgZWl0aGVyIHN0b3BwZWQgb3Igc3RvcHBpbmcsIHNvIHNvbWV0aGluZyB3ZW50IHdyb25nXG4gICAgICAgIGNocm9tZWRyaXZlclN0b3BwZWQgPSB0cnVlO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBhd2FpdCB0aGlzLmdldFN0YXR1cygpO1xuICAgIH0pO1xuICAgIGlmIChjaHJvbWVkcml2ZXJTdG9wcGVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nocm9tZURyaXZlciBjcmFzaGVkIGR1cmluZyBzdGFydHVwLicpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldFN0YXR1cyAoKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc3RhdHVzJywgJ0dFVCcpO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXNzaW9uICgpIHtcbiAgICAvLyByZXRyeSBzZXNzaW9uIHN0YXJ0IDQgdGltZXMsIHNvbWV0aW1lcyB0aGlzIGZhaWxzIGR1ZSB0byBhZGJcbiAgICBhd2FpdCByZXRyeUludGVydmFsKDQsIDIwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgbGV0IHJlcyA9IGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge2Rlc2lyZWRDYXBhYmlsaXRpZXM6IHRoaXMuY2FwYWJpbGl0aWVzfSk7XG4gICAgICAgIC8vIENocm9tZURyaXZlciBjYW4gcmV0dXJuIGEgcG9zaXRpdmUgc3RhdHVzIGRlc3BpdGUgZmFpbGluZ1xuICAgICAgICBpZiAocmVzLnN0YXR1cykge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihyZXMudmFsdWUubWVzc2FnZSk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgRmFpbGVkIHRvIHN0YXJ0IENocm9tZWRyaXZlciBzZXNzaW9uOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMuY2hhbmdlU3RhdGUoQ2hyb21lZHJpdmVyLlNUQVRFX09OTElORSk7XG4gIH1cblxuICBhc3luYyBzdG9wIChlbWl0U3RhdGVzID0gdHJ1ZSkge1xuICAgIGlmIChlbWl0U3RhdGVzKSB7XG4gICAgICB0aGlzLmNoYW5nZVN0YXRlKENocm9tZWRyaXZlci5TVEFURV9TVE9QUElORyk7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnJywgJ0RFTEVURScpO1xuICAgICAgYXdhaXQgdGhpcy5wcm9jLnN0b3AoJ1NJR1RFUk0nLCAyMDAwMCk7XG4gICAgICBpZiAoZW1pdFN0YXRlcykge1xuICAgICAgICB0aGlzLmNoYW5nZVN0YXRlKENocm9tZWRyaXZlci5TVEFURV9TVE9QUEVEKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cuZXJyb3IoZSk7XG4gICAgfVxuICB9XG5cbiAgY2hhbmdlU3RhdGUgKHN0YXRlKSB7XG4gICAgdGhpcy5zdGF0ZSA9IHN0YXRlO1xuICAgIGxvZy5kZWJ1ZyhgQ2hhbmdlZCBzdGF0ZSB0byAnJHtzdGF0ZX0nYCk7XG4gICAgdGhpcy5lbWl0KENocm9tZWRyaXZlci5FVkVOVF9DSEFOR0VELCB7c3RhdGV9KTtcbiAgfVxuXG4gIGFzeW5jIHNlbmRDb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCh1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cblxuICBhc3luYyBwcm94eVJlcSAocmVxLCByZXMpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzKHJlcSwgcmVzKTtcbiAgfVxuXG4gIGFzeW5jIGtpbGxBbGwgKCkge1xuICAgIGxldCBjbWQ7XG4gICAgaWYgKHN5c3RlbS5pc1dpbmRvd3MoKSkge1xuICAgICAgLy8ganMgaGludCBjYW5ub3QgaGFuZGxlIGJhY2t0aWNrcywgZXZlbiBlc2NhcGVkLCB3aXRoaW4gdGVtcGxhdGUgbGl0ZXJhbHNcbiAgICAgIGNtZCA9IFwiRk9SIC9GIFxcXCJ1c2ViYWNrcSB0b2tlbnM9NVxcXCIgJWEgaW4gKGBuZXRzdGF0IC1uYW8gXnwgXCIgK1xuICAgICAgICAgICAgXCJmaW5kc3RyIC9SIC9DOlxcXCJcIiArIHRoaXMucHJveHlQb3J0ICsgXCIgXFxcImApIGRvIChcIiArXG4gICAgICAgICAgICBcIkZPUiAvRiBcXFwidXNlYmFja3FcXFwiICViIGluIChgVEFTS0xJU1QgL0ZJIFxcXCJQSUQgZXEgJWFcXFwiIF58IFwiICtcbiAgICAgICAgICAgIFwiZmluZHN0ciAvSSBjaHJvbWVkcml2ZXIuZXhlYCkgZG8gKElGIE5PVCAlYj09XFxcIlxcXCIgVEFTS0tJTEwgXCIgK1xuICAgICAgICAgICAgXCIvRiAvUElEICVhKSlcIjtcbiAgICB9IGVsc2Uge1xuICAgICAgY21kID0gYHBraWxsIC0xNSAtZiBcIiR7dGhpcy5jaHJvbWVkcml2ZXJ9LiotLXBvcnQ9JHt0aGlzLnByb3h5UG9ydH1cImA7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgS2lsbGluZyBhbnkgb2xkIGNocm9tZWRyaXZlcnMsIHJ1bm5pbmc6ICR7Y21kfWApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCAoQi5wcm9taXNpZnkoY3AuZXhlYykpKGNtZCk7XG4gICAgICBsb2cuZGVidWcoXCJTdWNjZXNzZnVsbHkgY2xlYW5lZCB1cCBvbGQgY2hyb21lZHJpdmVyc1wiKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKFwiTm8gb2xkIGNocm9tZWRyaXZlcnMgc2VlbWVkIHRvIGV4aXN0XCIpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmFkYikge1xuICAgICAgbG9nLmRlYnVnKGBDbGVhbmluZyBhbnkgb2xkIGFkYiBmb3J3YXJkZWQgcG9ydCBzb2NrZXQgY29ubmVjdGlvbnNgKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGZvciAobGV0IGNvbm4gb2YgYXdhaXQgdGhpcy5hZGIuZ2V0Rm9yd2FyZExpc3QoKSkge1xuICAgICAgICAgIC8vIGNocm9tZWRyaXZlciB3aWxsIGFzayBBREIgdG8gZm9yd2FyZCBhIHBvcnQgbGlrZSBcImRldmljZUlkIHRjcDpwb3J0IGxvY2FsYWJzdHJhY3Q6d2Vidmlld19kZXZ0b29sc19yZW1vdGVfcG9ydFwiXG4gICAgICAgICAgaWYgKGNvbm4uaW5kZXhPZignd2Vidmlld19kZXZ0b29scycpICE9PSAtMSkge1xuICAgICAgICAgICAgbGV0IHBhcmFtcyA9IGNvbm4uc3BsaXQoL1xccysvKTtcbiAgICAgICAgICAgIGlmIChwYXJhbXMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFkYi5yZW1vdmVQb3J0Rm9yd2FyZChwYXJhbXNbMV0ucmVwbGFjZSgvW1xcRF0qLywgJycpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2cud2FybihgVW5hYmxlIHRvIGNsZWFuIGZvcndhcmRlZCBwb3J0cy4gRXJyb3I6ICcke2Vyci5tZXNzYWdlfScuIENvbnRpbnVpbmcuYCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgaGFzV29ya2luZ1dlYnZpZXcgKCkge1xuICAgIC8vIHNvbWV0aW1lcyBjaHJvbWVkcml2ZXIgc3RvcHMgYXV0b21hdGluZyB3ZWJ2aWV3cy4gdGhpcyBtZXRob2QgcnVucyBhXG4gICAgLy8gc2ltcGxlIGNvbW1hbmQgdG8gZGV0ZXJtaW5lIG91ciBzdGF0ZSwgYW5kIHJlc3BvbmRzIGFjY29yZGluZ2x5XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvdXJsJywgJ0dFVCcpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxufVxuXG5DaHJvbWVkcml2ZXIuRVZFTlRfRVJST1IgPSAnY2hyb21lZHJpdmVyX2Vycm9yJztcbkNocm9tZWRyaXZlci5FVkVOVF9DSEFOR0VEID0gJ3N0YXRlQ2hhbmdlZCc7XG5DaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBFRCA9ICdzdG9wcGVkJztcbkNocm9tZWRyaXZlci5TVEFURV9TVEFSVElORyA9ICdzdGFydGluZyc7XG5DaHJvbWVkcml2ZXIuU1RBVEVfT05MSU5FID0gJ29ubGluZSc7XG5DaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBJTkcgPSAnc3RvcHBpbmcnO1xuQ2hyb21lZHJpdmVyLlNUQVRFX1JFU1RBUlRJTkcgPSAncmVzdGFydGluZyc7XG5cbmV4cG9ydCB7IENocm9tZWRyaXZlciwgQ0hST01FRFJJVkVSX0NIUk9NRV9NQVBQSU5HLCBnZXRNb3N0UmVjZW50Q2hyb21lZHJpdmVyIH07XG5leHBvcnQgZGVmYXVsdCBDaHJvbWVkcml2ZXI7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
