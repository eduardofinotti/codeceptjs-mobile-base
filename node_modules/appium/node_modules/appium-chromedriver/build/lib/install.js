'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _asyncbox = require('asyncbox');

var _appiumSupport = require('appium-support');

var _chromedriver = require('./chromedriver');

var _utils = require('./utils');

var _fancyLog = require('fancy-log');

var _fancyLog2 = _interopRequireDefault(_fancyLog);

function log(line) {
  (0, _fancyLog2['default'])('[Chromedriver Install] ' + line);
}

var CD_VER = process.env.npm_config_chromedriver_version || process.env.CHROMEDRIVER_VERSION || (0, _chromedriver.getMostRecentChromedriver)();
var CD_CDN = process.env.npm_config_chromedriver_cdnurl || process.env.CHROMEDRIVER_CDNURL || 'https://chromedriver.storage.googleapis.com';
var CD_PLATS = ['linux', 'win', 'mac'];
var CD_ARCHS = ['32', '64'];

function getArchAndPlatform() {
  var arch, platform;
  return _regeneratorRuntime.async(function getArchAndPlatform$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.system.arch());

      case 2:
        arch = context$1$0.sent;
        platform = (0, _utils.getCurPlatform)();

        if (platform !== 'linux' && platform !== 'mac' && arch === '64') {
          arch = '32';
        }
        if (platform === 'mac' && parseFloat(CD_VER) < 2.23) {
          arch = '32';
        }
        return context$1$0.abrupt('return', { arch: arch, platform: platform });

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getDownloadUrl(version, platform, arch) {
  return CD_CDN + '/' + version + '/chromedriver_' + platform + arch + '.zip';
}

function validatePlatform(platform, arch) {
  if (!_lodash2['default'].includes(CD_PLATS, platform)) {
    throw new Error('Invalid platform: ' + platform);
  }
  if (!_lodash2['default'].includes(CD_ARCHS, arch)) {
    throw new Error('Invalid arch: ' + arch);
  }
  if (arch === "64" && platform !== "linux" && platform !== 'mac') {
    throw new Error('Only linux has a 64-bit version of Chromedriver');
  }
}

function installForPlatform(version, platform, arch) {
  var url, binarySpec, tempFile, body, tempUnzipped, extractedBin, newBin, binContents;
  return _regeneratorRuntime.async(function installForPlatform$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(version === 'LATEST')) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ uri: CD_CDN + '/LATEST_RELEASE' }));

      case 3:
        version = context$1$0.sent.trim();

      case 4:
        validatePlatform(platform, arch);

        url = getDownloadUrl(version, platform, arch);

        log('Installing Chromedriver version \'' + version + '\' for platform \'' + platform + '\' and architecture \'' + arch + '\'');

        // set up a temp file to download the chromedriver zipfile to
        binarySpec = 'chromedriver_' + platform + arch;

        log('Opening temp file to write \'' + binarySpec + '\' to...');
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.open({
          prefix: binarySpec,
          suffix: '.zip'
        }));

      case 11:
        tempFile = context$1$0.sent;

        log('Opened temp file \'' + tempFile.path + '\'');

        // actually download the zipfile and write it with appropriate perms
        log('Downloading ' + url + '...');
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ url: url, encoding: 'binary' }));

      case 16:
        body = context$1$0.sent;

        log('Writing binary content to ' + tempFile.path + '...');
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(tempFile.path, body, { encoding: 'binary' }));

      case 20:
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.chmod(tempFile.path, 420));

      case 22:
        tempUnzipped = _path2['default'].resolve(_path2['default'].dirname(tempFile.path), binarySpec);

        log('Extracting ' + tempFile.path + ' to ' + tempUnzipped);
        context$1$0.next = 26;
        return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(tempUnzipped));

      case 26:
        context$1$0.next = 28;
        return _regeneratorRuntime.awrap(_appiumSupport.zip.extractAllTo(tempFile.path, tempUnzipped));

      case 28:
        extractedBin = _path2['default'].resolve(tempUnzipped, 'chromedriver');

        if (platform === "win") {
          extractedBin += ".exe";
        }

        // make build dirs that will hold the chromedriver binary
        log('Creating ' + _path2['default'].resolve(_utils.CD_BASE_DIR, platform) + '...');
        context$1$0.next = 33;
        return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(_path2['default'].resolve(_utils.CD_BASE_DIR, platform)));

      case 33:
        context$1$0.next = 35;
        return _regeneratorRuntime.awrap((0, _utils.getChromedriverBinaryPath)(platform, arch));

      case 35:
        newBin = context$1$0.sent;

        log('Copying unzipped binary, reading from ' + extractedBin + '...');
        context$1$0.next = 39;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(extractedBin, { encoding: 'binary' }));

      case 39:
        binContents = context$1$0.sent;

        log('Writing to ' + newBin + '...');
        context$1$0.next = 43;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(newBin, binContents, { encoding: 'binary', mode: 493 }));

      case 43:
        log(newBin + ' successfully put in place');

      case 44:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function install() {
  var _ref, arch, platform;

  return _regeneratorRuntime.async(function install$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(getArchAndPlatform());

      case 2:
        _ref = context$1$0.sent;
        arch = _ref.arch;
        platform = _ref.platform;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(installForPlatform(CD_VER, platform, arch));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function conditionalInstall() {
  var _ref2, arch, platform, binPath;

  return _regeneratorRuntime.async(function conditionalInstall$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(getArchAndPlatform());

      case 2:
        _ref2 = context$1$0.sent;
        arch = _ref2.arch;
        platform = _ref2.platform;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap((0, _utils.getChromedriverBinaryPath)(platform, arch));

      case 7:
        binPath = context$1$0.sent;
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(binPath));

      case 10:
        if (context$1$0.sent) {
          context$1$0.next = 15;
          break;
        }

        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(installForPlatform(CD_VER, platform, arch));

      case 13:
        context$1$0.next = 16;
        break;

      case 15:
        log('No need to install chromedriver, ' + binPath + ' exists');

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getPlatforms() {
  var plats = [['win', '32'], ['linux', '64']];
  var cdVer = parseFloat(CD_VER);
  // before 2.23 Mac version was 32 bit. After it is 64.
  plats.push(cdVer < 2.23 ? ['mac', '32'] : ['mac', '64']);
  // 2.34 and above linux is only supporting 64 bit
  if (cdVer < 2.34) {
    plats.push(['linux', '32']);
  }
  return plats;
}

function installAll() {
  var downloads, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, platform, arch;

  return _regeneratorRuntime.async(function installAll$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        downloads = [];
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 4;

        for (_iterator = _getIterator(getPlatforms()); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          _step$value = _slicedToArray(_step.value, 2);
          platform = _step$value[0];
          arch = _step$value[1];

          downloads.push(installForPlatform(CD_VER, platform, arch));
        }
        context$1$0.next = 12;
        break;

      case 8:
        context$1$0.prev = 8;
        context$1$0.t0 = context$1$0['catch'](4);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 12:
        context$1$0.prev = 12;
        context$1$0.prev = 13;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 15:
        context$1$0.prev = 15;

        if (!_didIteratorError) {
          context$1$0.next = 18;
          break;
        }

        throw _iteratorError;

      case 18:
        return context$1$0.finish(15);

      case 19:
        return context$1$0.finish(12);

      case 20:
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap((0, _asyncbox.parallel)(downloads));

      case 22:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[4, 8, 12, 20], [13,, 15, 19]]);
}

function doInstall() {
  return _regeneratorRuntime.async(function doInstall$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(_lodash2['default'].includes(process.argv, '--all') || process.env.npm_config_chromedriver_install_all)) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(installAll());

      case 3:
        context$1$0.next = 12;
        break;

      case 5:
        if (!_lodash2['default'].includes(process.argv, '--conditional')) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(conditionalInstall());

      case 8:
        context$1$0.next = 12;
        break;

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(install());

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.getChromedriverBinaryPath = _utils.getChromedriverBinaryPath;
exports.install = install;
exports.installAll = installAll;
exports.CD_BASE_DIR = _utils.CD_BASE_DIR;
exports.getCurPlatform = _utils.getCurPlatform;
exports.conditionalInstall = conditionalInstall;
exports.doInstall = doInstall;
exports.getPlatforms = getPlatforms;
exports.getChromedriverDir = _utils.getChromedriverDir;

// extract downloaded zipfile to tempdir

// copy the extracted binary to the correct build dir
//# sourceMappingURL=data:application/json;charset=utf8;base64,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O0NBRWxCOztRQUVRLHlCQUF5QjtRQUFFLE9BQU8sR0FBUCxPQUFPO1FBQUUsVUFBVSxHQUFWLFVBQVU7UUFBRSxXQUFXO1FBQzNELGNBQWM7UUFBRSxrQkFBa0IsR0FBbEIsa0JBQWtCO1FBQUUsU0FBUyxHQUFULFNBQVM7UUFBRSxZQUFZLEdBQVosWUFBWTtRQUMzRCxrQkFBa0IiLCJmaWxlIjoibGliL2luc3RhbGwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHsgcGFyYWxsZWwgYXMgbGwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBzeXN0ZW0sIHRlbXBEaXIsIGZzLCB6aXAsIG1rZGlycCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGdldE1vc3RSZWNlbnRDaHJvbWVkcml2ZXIgfSBmcm9tICcuL2Nocm9tZWRyaXZlcic7XG5pbXBvcnQgeyBDRF9CQVNFX0RJUiwgZ2V0Q2hyb21lZHJpdmVyQmluYXJ5UGF0aCwgZ2V0Q3VyUGxhdGZvcm0sXG4gICAgICAgICBnZXRDaHJvbWVkcml2ZXJEaXIgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnZmFuY3ktbG9nJztcblxuXG5mdW5jdGlvbiBsb2cgKGxpbmUpIHtcbiAgbG9nZ2VyKGBbQ2hyb21lZHJpdmVyIEluc3RhbGxdICR7bGluZX1gKTtcbn1cblxuY29uc3QgQ0RfVkVSID0gcHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19jaHJvbWVkcml2ZXJfdmVyc2lvbiB8fFxuICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnYuQ0hST01FRFJJVkVSX1ZFUlNJT04gfHxcbiAgICAgICAgICAgICAgIGdldE1vc3RSZWNlbnRDaHJvbWVkcml2ZXIoKTtcbmNvbnN0IENEX0NETiA9IHByb2Nlc3MuZW52Lm5wbV9jb25maWdfY2hyb21lZHJpdmVyX2NkbnVybCB8fFxuICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnYuQ0hST01FRFJJVkVSX0NETlVSTCB8fFxuICAgICAgICAgICAgICAgJ2h0dHBzOi8vY2hyb21lZHJpdmVyLnN0b3JhZ2UuZ29vZ2xlYXBpcy5jb20nO1xuY29uc3QgQ0RfUExBVFMgPSBbJ2xpbnV4JywgJ3dpbicsICdtYWMnXTtcbmNvbnN0IENEX0FSQ0hTID0gWyczMicsICc2NCddO1xuXG5hc3luYyBmdW5jdGlvbiBnZXRBcmNoQW5kUGxhdGZvcm0gKCkge1xuICBsZXQgYXJjaCA9IGF3YWl0IHN5c3RlbS5hcmNoKCk7XG4gIGxldCBwbGF0Zm9ybSA9IGdldEN1clBsYXRmb3JtKCk7XG4gIGlmIChwbGF0Zm9ybSAhPT0gJ2xpbnV4JyAmJiBwbGF0Zm9ybSAhPT0gJ21hYycgJiYgYXJjaCA9PT0gJzY0Jykge1xuICAgIGFyY2ggPSAnMzInO1xuICB9XG4gIGlmIChwbGF0Zm9ybSA9PT0gJ21hYycgJiYgcGFyc2VGbG9hdChDRF9WRVIpIDwgMi4yMykge1xuICAgIGFyY2ggPSAnMzInO1xuICB9XG4gIHJldHVybiB7YXJjaCwgcGxhdGZvcm19O1xufVxuXG5mdW5jdGlvbiBnZXREb3dubG9hZFVybCAodmVyc2lvbiwgcGxhdGZvcm0sIGFyY2gpIHtcbiAgcmV0dXJuIGAke0NEX0NETn0vJHt2ZXJzaW9ufS9jaHJvbWVkcml2ZXJfJHtwbGF0Zm9ybX0ke2FyY2h9LnppcGA7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlUGxhdGZvcm0gKHBsYXRmb3JtLCBhcmNoKSB7XG4gIGlmICghXy5pbmNsdWRlcyhDRF9QTEFUUywgcGxhdGZvcm0pKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHBsYXRmb3JtOiAke3BsYXRmb3JtfWApO1xuICB9XG4gIGlmICghXy5pbmNsdWRlcyhDRF9BUkNIUywgYXJjaCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYXJjaDogJHthcmNofWApO1xuICB9XG4gIGlmIChhcmNoID09PSBcIjY0XCIgJiYgcGxhdGZvcm0gIT09IFwibGludXhcIiAmJiBwbGF0Zm9ybSAhPT0gJ21hYycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ09ubHkgbGludXggaGFzIGEgNjQtYml0IHZlcnNpb24gb2YgQ2hyb21lZHJpdmVyJyk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbEZvclBsYXRmb3JtICh2ZXJzaW9uLCBwbGF0Zm9ybSwgYXJjaCkge1xuICBpZiAodmVyc2lvbiA9PT0gJ0xBVEVTVCcpIHtcbiAgICB2ZXJzaW9uID0gKGF3YWl0IHJlcXVlc3QuZ2V0KHt1cmk6IGAke0NEX0NETn0vTEFURVNUX1JFTEVBU0VgfSkpLnRyaW0oKTtcbiAgfVxuICB2YWxpZGF0ZVBsYXRmb3JtKHBsYXRmb3JtLCBhcmNoKTtcblxuICBjb25zdCB1cmwgPSBnZXREb3dubG9hZFVybCh2ZXJzaW9uLCBwbGF0Zm9ybSwgYXJjaCk7XG5cbiAgbG9nKGBJbnN0YWxsaW5nIENocm9tZWRyaXZlciB2ZXJzaW9uICcke3ZlcnNpb259JyBmb3IgcGxhdGZvcm0gJyR7cGxhdGZvcm19JyBhbmQgYXJjaGl0ZWN0dXJlICcke2FyY2h9J2ApO1xuXG4gIC8vIHNldCB1cCBhIHRlbXAgZmlsZSB0byBkb3dubG9hZCB0aGUgY2hyb21lZHJpdmVyIHppcGZpbGUgdG9cbiAgY29uc3QgYmluYXJ5U3BlYyA9IGBjaHJvbWVkcml2ZXJfJHtwbGF0Zm9ybX0ke2FyY2h9YDtcbiAgbG9nKGBPcGVuaW5nIHRlbXAgZmlsZSB0byB3cml0ZSAnJHtiaW5hcnlTcGVjfScgdG8uLi5gKTtcbiAgY29uc3QgdGVtcEZpbGUgPSBhd2FpdCB0ZW1wRGlyLm9wZW4oe1xuICAgIHByZWZpeDogYmluYXJ5U3BlYyxcbiAgICBzdWZmaXg6ICcuemlwJ1xuICB9KTtcbiAgbG9nKGBPcGVuZWQgdGVtcCBmaWxlICcke3RlbXBGaWxlLnBhdGh9J2ApO1xuXG4gIC8vIGFjdHVhbGx5IGRvd25sb2FkIHRoZSB6aXBmaWxlIGFuZCB3cml0ZSBpdCB3aXRoIGFwcHJvcHJpYXRlIHBlcm1zXG4gIGxvZyhgRG93bmxvYWRpbmcgJHt1cmx9Li4uYCk7XG4gIGNvbnN0IGJvZHkgPSBhd2FpdCByZXF1ZXN0LmdldCh7dXJsLCBlbmNvZGluZzogJ2JpbmFyeSd9KTtcbiAgbG9nKGBXcml0aW5nIGJpbmFyeSBjb250ZW50IHRvICR7dGVtcEZpbGUucGF0aH0uLi5gKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKHRlbXBGaWxlLnBhdGgsIGJvZHksIHtlbmNvZGluZzogJ2JpbmFyeSd9KTtcbiAgYXdhaXQgZnMuY2htb2QodGVtcEZpbGUucGF0aCwgMG8wNjQ0KTtcblxuICAvLyBleHRyYWN0IGRvd25sb2FkZWQgemlwZmlsZSB0byB0ZW1wZGlyXG4gIGNvbnN0IHRlbXBVbnppcHBlZCA9IHBhdGgucmVzb2x2ZShwYXRoLmRpcm5hbWUodGVtcEZpbGUucGF0aCksIGJpbmFyeVNwZWMpO1xuICBsb2coYEV4dHJhY3RpbmcgJHt0ZW1wRmlsZS5wYXRofSB0byAke3RlbXBVbnppcHBlZH1gKTtcbiAgYXdhaXQgbWtkaXJwKHRlbXBVbnppcHBlZCk7XG4gIGF3YWl0IHppcC5leHRyYWN0QWxsVG8odGVtcEZpbGUucGF0aCwgdGVtcFVuemlwcGVkKTtcbiAgbGV0IGV4dHJhY3RlZEJpbiA9IHBhdGgucmVzb2x2ZSh0ZW1wVW56aXBwZWQsICdjaHJvbWVkcml2ZXInKTtcbiAgaWYgKHBsYXRmb3JtID09PSBcIndpblwiKSB7XG4gICAgZXh0cmFjdGVkQmluICs9IFwiLmV4ZVwiO1xuICB9XG5cbiAgLy8gbWFrZSBidWlsZCBkaXJzIHRoYXQgd2lsbCBob2xkIHRoZSBjaHJvbWVkcml2ZXIgYmluYXJ5XG4gIGxvZyhgQ3JlYXRpbmcgJHtwYXRoLnJlc29sdmUoQ0RfQkFTRV9ESVIsIHBsYXRmb3JtKX0uLi5gKTtcbiAgYXdhaXQgbWtkaXJwKHBhdGgucmVzb2x2ZShDRF9CQVNFX0RJUiwgcGxhdGZvcm0pKTtcblxuICAvLyBjb3B5IHRoZSBleHRyYWN0ZWQgYmluYXJ5IHRvIHRoZSBjb3JyZWN0IGJ1aWxkIGRpclxuICBjb25zdCBuZXdCaW4gPSBhd2FpdCBnZXRDaHJvbWVkcml2ZXJCaW5hcnlQYXRoKHBsYXRmb3JtLCBhcmNoKTtcbiAgbG9nKGBDb3B5aW5nIHVuemlwcGVkIGJpbmFyeSwgcmVhZGluZyBmcm9tICR7ZXh0cmFjdGVkQmlufS4uLmApO1xuICBjb25zdCBiaW5Db250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKGV4dHJhY3RlZEJpbiwge2VuY29kaW5nOiAnYmluYXJ5J30pO1xuICBsb2coYFdyaXRpbmcgdG8gJHtuZXdCaW59Li4uYCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZShuZXdCaW4sIGJpbkNvbnRlbnRzLCB7ZW5jb2Rpbmc6ICdiaW5hcnknLCBtb2RlOiAwbzc1NX0pO1xuICBsb2coYCR7bmV3QmlufSBzdWNjZXNzZnVsbHkgcHV0IGluIHBsYWNlYCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGwgKCkge1xuICBjb25zdCB7YXJjaCwgcGxhdGZvcm19ID0gYXdhaXQgZ2V0QXJjaEFuZFBsYXRmb3JtKCk7XG4gIGF3YWl0IGluc3RhbGxGb3JQbGF0Zm9ybShDRF9WRVIsIHBsYXRmb3JtLCBhcmNoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY29uZGl0aW9uYWxJbnN0YWxsICgpIHtcbiAgY29uc3Qge2FyY2gsIHBsYXRmb3JtfSA9IGF3YWl0IGdldEFyY2hBbmRQbGF0Zm9ybSgpO1xuICBjb25zdCBiaW5QYXRoID0gYXdhaXQgZ2V0Q2hyb21lZHJpdmVyQmluYXJ5UGF0aChwbGF0Zm9ybSwgYXJjaCk7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGJpblBhdGgpKSB7XG4gICAgYXdhaXQgaW5zdGFsbEZvclBsYXRmb3JtKENEX1ZFUiwgcGxhdGZvcm0sIGFyY2gpO1xuICB9IGVsc2Uge1xuICAgIGxvZyhgTm8gbmVlZCB0byBpbnN0YWxsIGNocm9tZWRyaXZlciwgJHtiaW5QYXRofSBleGlzdHNgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRQbGF0Zm9ybXMgKCkge1xuICBsZXQgcGxhdHMgPSBbXG4gICAgWyd3aW4nLCAnMzInXSxcbiAgICBbJ2xpbnV4JywgJzY0J10sXG4gIF07XG4gIGNvbnN0IGNkVmVyID0gcGFyc2VGbG9hdChDRF9WRVIpO1xuICAvLyBiZWZvcmUgMi4yMyBNYWMgdmVyc2lvbiB3YXMgMzIgYml0LiBBZnRlciBpdCBpcyA2NC5cbiAgcGxhdHMucHVzaChjZFZlciA8IDIuMjMgPyBbJ21hYycsICczMiddIDogWydtYWMnLCAnNjQnXSk7XG4gIC8vIDIuMzQgYW5kIGFib3ZlIGxpbnV4IGlzIG9ubHkgc3VwcG9ydGluZyA2NCBiaXRcbiAgaWYgKGNkVmVyIDwgMi4zNCkge1xuICAgIHBsYXRzLnB1c2goWydsaW51eCcsICczMiddKTtcbiAgfVxuICByZXR1cm4gcGxhdHM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGxBbGwgKCkge1xuICBsZXQgZG93bmxvYWRzID0gW107XG4gIGZvciAobGV0IFtwbGF0Zm9ybSwgYXJjaF0gb2YgZ2V0UGxhdGZvcm1zKCkpIHtcbiAgICBkb3dubG9hZHMucHVzaChpbnN0YWxsRm9yUGxhdGZvcm0oQ0RfVkVSLCBwbGF0Zm9ybSwgYXJjaCkpO1xuICB9XG4gIGF3YWl0IGxsKGRvd25sb2Fkcyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRvSW5zdGFsbCAoKSB7XG4gIGlmIChfLmluY2x1ZGVzKHByb2Nlc3MuYXJndiwgJy0tYWxsJykgfHxcbiAgICAgIHByb2Nlc3MuZW52Lm5wbV9jb25maWdfY2hyb21lZHJpdmVyX2luc3RhbGxfYWxsKSB7XG4gICAgYXdhaXQgaW5zdGFsbEFsbCgpO1xuICB9IGVsc2UgaWYgKF8uaW5jbHVkZXMocHJvY2Vzcy5hcmd2LCAnLS1jb25kaXRpb25hbCcpKSB7XG4gICAgYXdhaXQgY29uZGl0aW9uYWxJbnN0YWxsKCk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgaW5zdGFsbCgpO1xuICB9XG59XG5cbmV4cG9ydCB7IGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgsIGluc3RhbGwsIGluc3RhbGxBbGwsIENEX0JBU0VfRElSLFxuICAgICAgICAgZ2V0Q3VyUGxhdGZvcm0sIGNvbmRpdGlvbmFsSW5zdGFsbCwgZG9JbnN0YWxsLCBnZXRQbGF0Zm9ybXMsXG4gICAgICAgICBnZXRDaHJvbWVkcml2ZXJEaXIgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
