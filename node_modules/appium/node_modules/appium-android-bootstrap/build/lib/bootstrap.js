'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _uiautomator = require('./uiautomator');

var _uiautomator2 = _interopRequireDefault(_uiautomator);

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumBaseDriver = require('appium-base-driver');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumSupport = require('appium-support');

var log = _appiumSupport.logger.getLogger('AndroidBootstrap');
var COMMAND_TYPES = {
  ACTION: 'action',
  SHUTDOWN: 'shutdown'
};
var SEND_COMMAND_TIMEOUT = 1 * 60 * 1000;

var AndroidBootstrap = (function () {
  function AndroidBootstrap(adb) {
    var systemPort = arguments.length <= 1 || arguments[1] === undefined ? 4724 : arguments[1];
    var webSocket = arguments.length <= 2 || arguments[2] === undefined ? undefined : arguments[2];

    _classCallCheck(this, AndroidBootstrap);

    this.adb = adb;
    this.systemPort = systemPort;
    this.webSocket = webSocket;
    this.ignoreUnexpectedShutdown = false;
  }

  _createClass(AndroidBootstrap, [{
    key: 'start',
    value: function start(appPackage) {
      var disableAndroidWatchers = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];
      var acceptSslCerts = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
      var rootDir, startDetector, bootstrapJar;
      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            rootDir = _path2['default'].resolve(__dirname, '..', '..');

            startDetector = function startDetector(s) {
              return (/Appium Socket Server Ready/.test(s)
              );
            };

            bootstrapJar = _path2['default'].resolve(rootDir, 'bootstrap', 'bin', 'AppiumBootstrap.jar');
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.init());

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.adb.forwardPort(this.systemPort, 4724));

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.uiAutomator.start(bootstrapJar, 'io.appium.android.bootstrap.Bootstrap', startDetector, '-e', 'pkg', appPackage, '-e', 'disableAndroidWatchers', disableAndroidWatchers, '-e', 'acceptSslCerts', acceptSslCerts));

          case 10:
            this.process = context$2$0.sent;

            // process the output
            this.process.on('output', function (stdout, stderr) {
              var alertRe = /Emitting system alert message/;
              if (alertRe.test(stdout)) {
                log.debug("Emitting alert message...");
                if (_this.webSocket) {
                  _this.webSocket.sockets.emit('alert', { message: stdout });
                }
              }

              // the bootstrap logger wraps its own log lines with
              // [APPIUM-UIAUTO] ... [APPIUM-UIAUTO]
              // and leaves actual UiAutomator logs as they are
              var stdoutLines = (stdout || "").split("\n");
              var uiautoLog = /\[APPIUM-UIAUTO\](.+)\[\/APPIUM-UIAUTO\]/;
              var _iteratorNormalCompletion = true;
              var _didIteratorError = false;
              var _iteratorError = undefined;

              try {
                for (var _iterator = _getIterator(stdoutLines), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                  var line = _step.value;

                  if (line.trim()) {
                    if (uiautoLog.test(line)) {
                      var innerLine = uiautoLog.exec(line)[1].trim();
                      var logMethod = log.info.bind(log);
                      // if the bootstrap log considers something debug, log that as
                      // debug and not info
                      if (/\[debug\]/.test(innerLine)) {
                        logMethod = log.debug.bind(log);
                      }
                      logMethod('[BOOTSTRAP LOG] ' + innerLine);
                    } else {
                      log.debug('[UIAUTO STDOUT] ' + line);
                    }
                  }
                }
              } catch (err) {
                _didIteratorError = true;
                _iteratorError = err;
              } finally {
                try {
                  if (!_iteratorNormalCompletion && _iterator['return']) {
                    _iterator['return']();
                  }
                } finally {
                  if (_didIteratorError) {
                    throw _iteratorError;
                  }
                }
              }

              var stderrLines = (stderr || "").split("\n");
              var _iteratorNormalCompletion2 = true;
              var _didIteratorError2 = false;
              var _iteratorError2 = undefined;

              try {
                for (var _iterator2 = _getIterator(stderrLines), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                  var line = _step2.value;

                  if (line.trim()) {
                    log.debug('[UIAUTO STDERR] ' + line);
                  }
                }
              } catch (err) {
                _didIteratorError2 = true;
                _iteratorError2 = err;
              } finally {
                try {
                  if (!_iteratorNormalCompletion2 && _iterator2['return']) {
                    _iterator2['return']();
                  }
                } finally {
                  if (_didIteratorError2) {
                    throw _iteratorError2;
                  }
                }
              }
            });

            // only return when the socket client has connected
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve, reject) {
              try {
                _this.socketClient = _net2['default'].connect(_this.systemPort);
                // Windows: the socket errors out when ADB restarts. Let's catch it to avoid crashing.
                _this.socketClient.on('error', function (err) {
                  if (!_this.ignoreUnexpectedShutdown) {
                    throw new Error('Android bootstrap socket crashed: ' + err);
                  }
                });
                _this.socketClient.once('connect', function () {
                  log.info("Android bootstrap socket is now connected");
                  resolve();
                });
              } catch (err) {
                reject(err);
              }
            }));

          case 14:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 17:
            context$2$0.prev = 17;
            context$2$0.t0 = context$2$0['catch'](0);

            log.errorAndThrow('Error occured while starting AndroidBootstrap. Original error: ' + context$2$0.t0);

          case 20:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 17]]);
    }
  }, {
    key: 'sendCommand',
    value: function sendCommand(type) {
      var extra = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      return _regeneratorRuntime.async(function sendCommand$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.socketClient) {
              context$2$0.next = 2;
              break;
            }

            throw new Error('Socket connection closed unexpectedly');

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve, reject) {
              var cmd = _Object$assign({ cmd: type }, extra);
              var cmdJson = JSON.stringify(cmd) + ' \n';
              log.debug('Sending command to android: ' + _lodash2['default'].truncate(cmdJson, { length: 1000 }).trim());
              _this2.socketClient.write(cmdJson);
              _this2.socketClient.setEncoding('utf8');
              var streamData = '';
              var sendCommandTimeoutHandler = null;
              _this2.socketClient.on('data', function (data) {
                if (sendCommandTimeoutHandler) {
                  clearTimeout(sendCommandTimeoutHandler);
                }
                log.debug("Received command result from bootstrap");
                try {
                  streamData = JSON.parse(streamData + data);
                  // we successfully parsed JSON so we've got all the data,
                  // remove the socket listener and evaluate
                  _this2.socketClient.removeAllListeners('data');
                  if (streamData.status === 0) {
                    return resolve(streamData.value);
                  }
                  reject((0, _appiumBaseDriver.errorFromCode)(streamData.status, streamData.value));
                } catch (err) {
                  if (!_lodash2['default'].isString(streamData)) {
                    log.error('Got an unexpected error inside socket listener');
                    log.error(err.stack);
                    return reject((0, _appiumBaseDriver.errorFromCode)(13, err.message));
                  }
                  log.debug('Stream still not complete, waiting up to ' + SEND_COMMAND_TIMEOUT + 'ms for the data to arrive');
                  streamData += data;
                  sendCommandTimeoutHandler = setTimeout(function () {
                    var errMsg = 'Server socket stopped responding. The recent response was \'' + streamData + '\'';
                    log.error(errMsg);
                    _this2.socketClient.removeAllListeners('data');
                    reject((0, _appiumBaseDriver.errorFromCode)(13, errMsg));
                  }, SEND_COMMAND_TIMEOUT);
                }
              });
            }));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'sendAction',
    value: function sendAction(action) {
      var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      var extra;
      return _regeneratorRuntime.async(function sendAction$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            extra = { action: action, params: params };
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.sendCommand(COMMAND_TYPES.ACTION, extra));

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'shutdown',
    value: function shutdown() {
      return _regeneratorRuntime.async(function shutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.uiAutomator) {
              context$2$0.next = 3;
              break;
            }

            log.warn("Cannot shut down Android bootstrap; it has already shut down");
            return context$2$0.abrupt('return');

          case 3:

            // remove listners so we don't trigger unexpected shutdown
            this.uiAutomator.removeAllListeners(_uiautomator2['default'].EVENT_CHANGED);

            if (!this.socketClient) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.sendCommand(COMMAND_TYPES.SHUTDOWN));

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.uiAutomator.shutdown());

          case 9:
            this.uiAutomator = null;

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // this helper function makes unit testing easier.
  }, {
    key: 'init',
    value: function init() {
      return _regeneratorRuntime.async(function init$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.uiAutomator = new _uiautomator2['default'](this.adb);

            // Handle unexpected UiAutomator shutdown
            this.uiAutomator.on(_uiautomator2['default'].EVENT_CHANGED, function callee$2$0(msg) {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    if (msg.state === _uiautomator2['default'].STATE_STOPPED) {
                      this.uiAutomator = null;
                      this.onUnexpectedShutdown.cancel(new Error("UiAUtomator shut down unexpectedly"));
                    }

                  case 1:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3);
            });

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'onUnexpectedShutdown',
    get: function get() {
      if (!this._onUnexpectedShutdownPromise) {
        var reject = undefined;
        this._onUnexpectedShutdownPromise = new _bluebird2['default'](function (_resolve, _reject) {
          reject = _reject;
        });
        this._onUnexpectedShutdownPromise.cancel = reject;
      }
      return this._onUnexpectedShutdownPromise;
    }
  }, {
    key: 'ignoreUnexpectedShutdown',
    set: function set(ignore) {
      log.debug((ignore ? 'Ignoring' : 'Watching for') + ' bootstrap disconnect');
      this._ignoreUnexpectedShutdown = ignore;
    },
    get: function get() {
      return this._ignoreUnexpectedShutdown;
    }
  }]);

  return AndroidBootstrap;
})();

exports.AndroidBootstrap = AndroidBootstrap;
exports.COMMAND_TYPES = COMMAND_TYPES;
exports['default'] = AndroidBootstrap;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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Ozs7YUFDRixDQUFDLENBQUM7Ozs7Ozs7S0FDSjs7O1NBckt3QixlQUFHO0FBQzFCLFVBQUksQ0FBQyxJQUFJLENBQUMsNEJBQTRCLEVBQUU7QUFDdEMsWUFBSSxNQUFNLFlBQUEsQ0FBQztBQUNYLFlBQUksQ0FBQyw0QkFBNEIsR0FBRywwQkFBTSxVQUFVLFFBQVEsRUFBRSxPQUFPLEVBQUU7QUFDckUsZ0JBQU0sR0FBRyxPQUFPLENBQUM7U0FDbEIsQ0FBQyxDQUFDO0FBQ0gsWUFBSSxDQUFDLDRCQUE0QixDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7T0FDbkQ7QUFDRCxhQUFPLElBQUksQ0FBQyw0QkFBNEIsQ0FBQztLQUMxQzs7O1NBOEo0QixhQUFDLE1BQU0sRUFBRTtBQUNwQyxTQUFHLENBQUMsS0FBSyxFQUFJLE1BQU0sR0FBRyxVQUFVLEdBQUcsY0FBYyxDQUFBLDJCQUF3QixDQUFDO0FBQzFFLFVBQUksQ0FBQyx5QkFBeUIsR0FBRyxNQUFNLENBQUM7S0FDekM7U0FFNEIsZUFBRztBQUM5QixhQUFPLElBQUksQ0FBQyx5QkFBeUIsQ0FBQztLQUN2Qzs7O1NBdExHLGdCQUFnQjs7O1FBeUxiLGdCQUFnQixHQUFoQixnQkFBZ0I7UUFBRSxhQUFhLEdBQWIsYUFBYTtxQkFDekIsZ0JBQWdCIiwiZmlsZSI6ImxpYi9ib290c3RyYXAuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVWlBdXRvbWF0b3IgZnJvbSAnLi91aWF1dG9tYXRvcic7XG5pbXBvcnQgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvckZyb21Db2RlIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuXG5jb25zdCBsb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdBbmRyb2lkQm9vdHN0cmFwJyk7XG5jb25zdCBDT01NQU5EX1RZUEVTID0ge1xuICBBQ1RJT046ICdhY3Rpb24nLFxuICBTSFVURE9XTjogJ3NodXRkb3duJ1xufTtcbmNvbnN0IFNFTkRfQ09NTUFORF9USU1FT1VUID0gMSAqIDYwICogMTAwMDtcblxuY2xhc3MgQW5kcm9pZEJvb3RzdHJhcCB7XG4gIGNvbnN0cnVjdG9yIChhZGIsIHN5c3RlbVBvcnQgPSA0NzI0LCB3ZWJTb2NrZXQgPSB1bmRlZmluZWQpIHtcbiAgICB0aGlzLmFkYiA9IGFkYjtcbiAgICB0aGlzLnN5c3RlbVBvcnQgPSBzeXN0ZW1Qb3J0O1xuICAgIHRoaXMud2ViU29ja2V0ID0gd2ViU29ja2V0O1xuICAgIHRoaXMuaWdub3JlVW5leHBlY3RlZFNodXRkb3duID0gZmFsc2U7XG4gIH1cblxuICBnZXQgb25VbmV4cGVjdGVkU2h1dGRvd24gKCkge1xuICAgIGlmICghdGhpcy5fb25VbmV4cGVjdGVkU2h1dGRvd25Qcm9taXNlKSB7XG4gICAgICBsZXQgcmVqZWN0O1xuICAgICAgdGhpcy5fb25VbmV4cGVjdGVkU2h1dGRvd25Qcm9taXNlID0gbmV3IEIoZnVuY3Rpb24gKF9yZXNvbHZlLCBfcmVqZWN0KSB7XG4gICAgICAgIHJlamVjdCA9IF9yZWplY3Q7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuX29uVW5leHBlY3RlZFNodXRkb3duUHJvbWlzZS5jYW5jZWwgPSByZWplY3Q7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9vblVuZXhwZWN0ZWRTaHV0ZG93blByb21pc2U7XG4gIH1cblxuICBhc3luYyBzdGFydCAoYXBwUGFja2FnZSwgZGlzYWJsZUFuZHJvaWRXYXRjaGVycyA9IGZhbHNlLCBhY2NlcHRTc2xDZXJ0cyA9IGZhbHNlKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJvb3REaXIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nKTtcbiAgICAgIGNvbnN0IHN0YXJ0RGV0ZWN0b3IgPSAocykgPT4geyByZXR1cm4gL0FwcGl1bSBTb2NrZXQgU2VydmVyIFJlYWR5Ly50ZXN0KHMpOyB9O1xuICAgICAgY29uc3QgYm9vdHN0cmFwSmFyID0gcGF0aC5yZXNvbHZlKHJvb3REaXIsICdib290c3RyYXAnLCAnYmluJywgJ0FwcGl1bUJvb3RzdHJhcC5qYXInKTtcblxuICAgICAgYXdhaXQgdGhpcy5pbml0KCk7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5mb3J3YXJkUG9ydCh0aGlzLnN5c3RlbVBvcnQsIDQ3MjQpO1xuICAgICAgdGhpcy5wcm9jZXNzID0gYXdhaXQgdGhpcy51aUF1dG9tYXRvci5zdGFydChcbiAgICAgICAgICAgICAgICAgICAgICAgYm9vdHN0cmFwSmFyLCAnaW8uYXBwaXVtLmFuZHJvaWQuYm9vdHN0cmFwLkJvb3RzdHJhcCcsXG4gICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0RGV0ZWN0b3IsICctZScsICdwa2cnLCBhcHBQYWNrYWdlLFxuICAgICAgICAgICAgICAgICAgICAgICAnLWUnLCAnZGlzYWJsZUFuZHJvaWRXYXRjaGVycycsIGRpc2FibGVBbmRyb2lkV2F0Y2hlcnMsXG4gICAgICAgICAgICAgICAgICAgICAgICctZScsICdhY2NlcHRTc2xDZXJ0cycsIGFjY2VwdFNzbENlcnRzKTtcblxuICAgICAgLy8gcHJvY2VzcyB0aGUgb3V0cHV0XG4gICAgICB0aGlzLnByb2Nlc3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgICBjb25zdCBhbGVydFJlID0gL0VtaXR0aW5nIHN5c3RlbSBhbGVydCBtZXNzYWdlLztcbiAgICAgICAgaWYgKGFsZXJ0UmUudGVzdChzdGRvdXQpKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKFwiRW1pdHRpbmcgYWxlcnQgbWVzc2FnZS4uLlwiKTtcbiAgICAgICAgICBpZiAodGhpcy53ZWJTb2NrZXQpIHtcbiAgICAgICAgICAgIHRoaXMud2ViU29ja2V0LnNvY2tldHMuZW1pdCgnYWxlcnQnLCB7bWVzc2FnZTogc3Rkb3V0fSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gdGhlIGJvb3RzdHJhcCBsb2dnZXIgd3JhcHMgaXRzIG93biBsb2cgbGluZXMgd2l0aFxuICAgICAgICAvLyBbQVBQSVVNLVVJQVVUT10gLi4uIFtBUFBJVU0tVUlBVVRPXVxuICAgICAgICAvLyBhbmQgbGVhdmVzIGFjdHVhbCBVaUF1dG9tYXRvciBsb2dzIGFzIHRoZXkgYXJlXG4gICAgICAgIGxldCBzdGRvdXRMaW5lcyA9IChzdGRvdXQgfHwgXCJcIikuc3BsaXQoXCJcXG5cIik7XG4gICAgICAgIGNvbnN0IHVpYXV0b0xvZyA9IC9cXFtBUFBJVU0tVUlBVVRPXFxdKC4rKVxcW1xcL0FQUElVTS1VSUFVVE9cXF0vO1xuICAgICAgICBmb3IgKGxldCBsaW5lIG9mIHN0ZG91dExpbmVzKSB7XG4gICAgICAgICAgaWYgKGxpbmUudHJpbSgpKSB7XG4gICAgICAgICAgICBpZiAodWlhdXRvTG9nLnRlc3QobGluZSkpIHtcbiAgICAgICAgICAgICAgbGV0IGlubmVyTGluZSA9IHVpYXV0b0xvZy5leGVjKGxpbmUpWzFdLnRyaW0oKTtcbiAgICAgICAgICAgICAgbGV0IGxvZ01ldGhvZCA9IGxvZy5pbmZvLmJpbmQobG9nKTtcbiAgICAgICAgICAgICAgLy8gaWYgdGhlIGJvb3RzdHJhcCBsb2cgY29uc2lkZXJzIHNvbWV0aGluZyBkZWJ1ZywgbG9nIHRoYXQgYXNcbiAgICAgICAgICAgICAgLy8gZGVidWcgYW5kIG5vdCBpbmZvXG4gICAgICAgICAgICAgIGlmICgvXFxbZGVidWdcXF0vLnRlc3QoaW5uZXJMaW5lKSkge1xuICAgICAgICAgICAgICAgIGxvZ01ldGhvZCA9IGxvZy5kZWJ1Zy5iaW5kKGxvZyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgbG9nTWV0aG9kKGBbQk9PVFNUUkFQIExPR10gJHtpbm5lckxpbmV9YCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBsb2cuZGVidWcoYFtVSUFVVE8gU1RET1VUXSAke2xpbmV9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHN0ZGVyckxpbmVzID0gKHN0ZGVyciB8fCBcIlwiKS5zcGxpdChcIlxcblwiKTtcbiAgICAgICAgZm9yIChsZXQgbGluZSBvZiBzdGRlcnJMaW5lcykge1xuICAgICAgICAgIGlmIChsaW5lLnRyaW0oKSkge1xuICAgICAgICAgICAgbG9nLmRlYnVnKGBbVUlBVVRPIFNUREVSUl0gJHtsaW5lfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIC8vIG9ubHkgcmV0dXJuIHdoZW4gdGhlIHNvY2tldCBjbGllbnQgaGFzIGNvbm5lY3RlZFxuICAgICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICB0aGlzLnNvY2tldENsaWVudCA9IG5ldC5jb25uZWN0KHRoaXMuc3lzdGVtUG9ydCk7XG4gICAgICAgICAgLy8gV2luZG93czogdGhlIHNvY2tldCBlcnJvcnMgb3V0IHdoZW4gQURCIHJlc3RhcnRzLiBMZXQncyBjYXRjaCBpdCB0byBhdm9pZCBjcmFzaGluZy5cbiAgICAgICAgICB0aGlzLnNvY2tldENsaWVudC5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuaWdub3JlVW5leHBlY3RlZFNodXRkb3duKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQW5kcm9pZCBib290c3RyYXAgc29ja2V0IGNyYXNoZWQ6ICR7ZXJyfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMuc29ja2V0Q2xpZW50Lm9uY2UoJ2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgICAgICAgICBsb2cuaW5mbyhcIkFuZHJvaWQgYm9vdHN0cmFwIHNvY2tldCBpcyBub3cgY29ubmVjdGVkXCIpO1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgRXJyb3Igb2NjdXJlZCB3aGlsZSBzdGFydGluZyBBbmRyb2lkQm9vdHN0cmFwLiBPcmlnaW5hbCBlcnJvcjogJHtlcnJ9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VuZENvbW1hbmQgKHR5cGUsIGV4dHJhID0ge30pIHtcbiAgICBpZiAoIXRoaXMuc29ja2V0Q2xpZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBjb25uZWN0aW9uIGNsb3NlZCB1bmV4cGVjdGVkbHknKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgbGV0IGNtZCA9IE9iamVjdC5hc3NpZ24oe2NtZDogdHlwZX0sIGV4dHJhKTtcbiAgICAgIGxldCBjbWRKc29uID0gYCR7SlNPTi5zdHJpbmdpZnkoY21kKX0gXFxuYDtcbiAgICAgIGxvZy5kZWJ1ZyhgU2VuZGluZyBjb21tYW5kIHRvIGFuZHJvaWQ6ICR7Xy50cnVuY2F0ZShjbWRKc29uLCB7bGVuZ3RoOiAxMDAwfSkudHJpbSgpfWApO1xuICAgICAgdGhpcy5zb2NrZXRDbGllbnQud3JpdGUoY21kSnNvbik7XG4gICAgICB0aGlzLnNvY2tldENsaWVudC5zZXRFbmNvZGluZygndXRmOCcpO1xuICAgICAgbGV0IHN0cmVhbURhdGEgPSAnJztcbiAgICAgIGxldCBzZW5kQ29tbWFuZFRpbWVvdXRIYW5kbGVyID0gbnVsbDtcbiAgICAgIHRoaXMuc29ja2V0Q2xpZW50Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgICAgaWYgKHNlbmRDb21tYW5kVGltZW91dEhhbmRsZXIpIHtcbiAgICAgICAgICBjbGVhclRpbWVvdXQoc2VuZENvbW1hbmRUaW1lb3V0SGFuZGxlcik7XG4gICAgICAgIH1cbiAgICAgICAgbG9nLmRlYnVnKFwiUmVjZWl2ZWQgY29tbWFuZCByZXN1bHQgZnJvbSBib290c3RyYXBcIik7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgc3RyZWFtRGF0YSA9IEpTT04ucGFyc2Uoc3RyZWFtRGF0YSArIGRhdGEpO1xuICAgICAgICAgIC8vIHdlIHN1Y2Nlc3NmdWxseSBwYXJzZWQgSlNPTiBzbyB3ZSd2ZSBnb3QgYWxsIHRoZSBkYXRhLFxuICAgICAgICAgIC8vIHJlbW92ZSB0aGUgc29ja2V0IGxpc3RlbmVyIGFuZCBldmFsdWF0ZVxuICAgICAgICAgIHRoaXMuc29ja2V0Q2xpZW50LnJlbW92ZUFsbExpc3RlbmVycygnZGF0YScpO1xuICAgICAgICAgIGlmIChzdHJlYW1EYXRhLnN0YXR1cyA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoc3RyZWFtRGF0YS52YWx1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJlamVjdChlcnJvckZyb21Db2RlKHN0cmVhbURhdGEuc3RhdHVzLCBzdHJlYW1EYXRhLnZhbHVlKSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGlmICghXy5pc1N0cmluZyhzdHJlYW1EYXRhKSkge1xuICAgICAgICAgICAgbG9nLmVycm9yKCdHb3QgYW4gdW5leHBlY3RlZCBlcnJvciBpbnNpZGUgc29ja2V0IGxpc3RlbmVyJyk7XG4gICAgICAgICAgICBsb2cuZXJyb3IoZXJyLnN0YWNrKTtcbiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyb3JGcm9tQ29kZSgxMywgZXJyLm1lc3NhZ2UpKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbG9nLmRlYnVnKGBTdHJlYW0gc3RpbGwgbm90IGNvbXBsZXRlLCB3YWl0aW5nIHVwIHRvICR7U0VORF9DT01NQU5EX1RJTUVPVVR9bXMgZm9yIHRoZSBkYXRhIHRvIGFycml2ZWApO1xuICAgICAgICAgIHN0cmVhbURhdGEgKz0gZGF0YTtcbiAgICAgICAgICBzZW5kQ29tbWFuZFRpbWVvdXRIYW5kbGVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBlcnJNc2cgPSBgU2VydmVyIHNvY2tldCBzdG9wcGVkIHJlc3BvbmRpbmcuIFRoZSByZWNlbnQgcmVzcG9uc2Ugd2FzICcke3N0cmVhbURhdGF9J2A7XG4gICAgICAgICAgICBsb2cuZXJyb3IoZXJyTXNnKTtcbiAgICAgICAgICAgIHRoaXMuc29ja2V0Q2xpZW50LnJlbW92ZUFsbExpc3RlbmVycygnZGF0YScpO1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yRnJvbUNvZGUoMTMsIGVyck1zZykpO1xuICAgICAgICAgIH0sIFNFTkRfQ09NTUFORF9USU1FT1VUKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBzZW5kQWN0aW9uIChhY3Rpb24sIHBhcmFtcyA9IHt9KSB7XG4gICAgbGV0IGV4dHJhID0ge2FjdGlvbiwgcGFyYW1zfTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kQ29tbWFuZChDT01NQU5EX1RZUEVTLkFDVElPTiwgZXh0cmEpO1xuICB9XG5cbiAgYXN5bmMgc2h1dGRvd24gKCkge1xuICAgIGlmICghdGhpcy51aUF1dG9tYXRvcikge1xuICAgICAgbG9nLndhcm4oXCJDYW5ub3Qgc2h1dCBkb3duIEFuZHJvaWQgYm9vdHN0cmFwOyBpdCBoYXMgYWxyZWFkeSBzaHV0IGRvd25cIik7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gcmVtb3ZlIGxpc3RuZXJzIHNvIHdlIGRvbid0IHRyaWdnZXIgdW5leHBlY3RlZCBzaHV0ZG93blxuICAgIHRoaXMudWlBdXRvbWF0b3IucmVtb3ZlQWxsTGlzdGVuZXJzKFVpQXV0b21hdG9yLkVWRU5UX0NIQU5HRUQpO1xuICAgIGlmICh0aGlzLnNvY2tldENsaWVudCkge1xuICAgICAgYXdhaXQgdGhpcy5zZW5kQ29tbWFuZChDT01NQU5EX1RZUEVTLlNIVVRET1dOKTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy51aUF1dG9tYXRvci5zaHV0ZG93bigpO1xuICAgIHRoaXMudWlBdXRvbWF0b3IgPSBudWxsO1xuICB9XG5cbiAgLy8gdGhpcyBoZWxwZXIgZnVuY3Rpb24gbWFrZXMgdW5pdCB0ZXN0aW5nIGVhc2llci5cbiAgYXN5bmMgaW5pdCAoKSB7XG4gICAgdGhpcy51aUF1dG9tYXRvciA9IG5ldyBVaUF1dG9tYXRvcih0aGlzLmFkYik7XG5cbiAgICAvLyBIYW5kbGUgdW5leHBlY3RlZCBVaUF1dG9tYXRvciBzaHV0ZG93blxuICAgIHRoaXMudWlBdXRvbWF0b3Iub24oVWlBdXRvbWF0b3IuRVZFTlRfQ0hBTkdFRCwgYXN5bmMgKG1zZykgPT4ge1xuICAgICAgaWYgKG1zZy5zdGF0ZSA9PT0gVWlBdXRvbWF0b3IuU1RBVEVfU1RPUFBFRCkge1xuICAgICAgICB0aGlzLnVpQXV0b21hdG9yID0gbnVsbDtcbiAgICAgICAgdGhpcy5vblVuZXhwZWN0ZWRTaHV0ZG93bi5jYW5jZWwobmV3IEVycm9yKFwiVWlBVXRvbWF0b3Igc2h1dCBkb3duIHVuZXhwZWN0ZWRseVwiKSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzZXQgaWdub3JlVW5leHBlY3RlZFNodXRkb3duIChpZ25vcmUpIHtcbiAgICBsb2cuZGVidWcoYCR7aWdub3JlID8gJ0lnbm9yaW5nJyA6ICdXYXRjaGluZyBmb3InfSBib290c3RyYXAgZGlzY29ubmVjdGApO1xuICAgIHRoaXMuX2lnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biA9IGlnbm9yZTtcbiAgfVxuXG4gIGdldCBpZ25vcmVVbmV4cGVjdGVkU2h1dGRvd24gKCkge1xuICAgIHJldHVybiB0aGlzLl9pZ25vcmVVbmV4cGVjdGVkU2h1dGRvd247XG4gIH1cbn1cblxuZXhwb3J0IHsgQW5kcm9pZEJvb3RzdHJhcCwgQ09NTUFORF9UWVBFUyB9O1xuZXhwb3J0IGRlZmF1bHQgQW5kcm9pZEJvb3RzdHJhcDtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
