'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _simulatorXcode6 = require('./simulator-xcode-6');

var _simulatorXcode7 = require('./simulator-xcode-7');

var _simulatorXcode72 = _interopRequireDefault(_simulatorXcode7);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _asyncbox = require('asyncbox');

var _teen_process = require('teen_process');

var _nodeSimctl = require('node-simctl');

// these sims are sloooooooow
var STARTUP_TIMEOUT = 120 * 1000;
var SAFARI_STARTUP_TIMEOUT = 25 * 1000;
var SPRINGBOARD_BUNDLE_ID = 'com.apple.springboard';
var MOBILE_SAFARI_BUNDLE_ID = 'com.apple.mobilesafari';
var PROCESS_LAUNCH_OK_PATTERN = function PROCESS_LAUNCH_OK_PATTERN(bundleId) {
  return new RegExp(bundleId.replace('.', '\\.') + ':\\s+\\d+');
};

var SimulatorXcode8 = (function (_SimulatorXcode7) {
  _inherits(SimulatorXcode8, _SimulatorXcode7);

  function SimulatorXcode8(udid, xcodeVersion) {
    _classCallCheck(this, SimulatorXcode8);

    _get(Object.getPrototypeOf(SimulatorXcode8.prototype), 'constructor', this).call(this, udid, xcodeVersion);

    // list of files to check for when seeing if a simulator is "fresh"
    // (meaning it has never been booted).
    // If these files are present, we assume it's been successfully booted
    this.isFreshFiles = ['Library/Cookies', 'Library/Preferences/.GlobalPreferences.plist', 'Library/Preferences/com.apple.springboard.plist', 'var/run/syslog.pid'];
  }

  /**
   * Kill the UI client if it is running.
   *
   * @param {boolean} force - Set it to true to send SIGKILL signal to Simulator process.
   *                          SIGTERM will be sent by default.
   * @return {boolean} True if the UI client was successfully killed or false
   *                   if it is not running.
   * @throws {Error} If sending the signal to the client process fails
   */

  _createClass(SimulatorXcode8, [{
    key: 'killUIClient',
    value: function killUIClient() {
      var force = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];
      var pid;
      return _regeneratorRuntime.async(function killUIClient$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getUIClientPid());

          case 2:
            pid = context$2$0.sent;

            if (pid) {
              context$2$0.next = 5;
              break;
            }

            return context$2$0.abrupt('return', false);

          case 5:

            _logger2['default'].debug('Sending ' + (force ? 'forced ' : '') + 'kill signal to Simulator UI client with PID ' + pid);
            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('kill', force ? ['-9', pid] : [pid]));

          case 9:
            return context$2$0.abrupt('return', true);

          case 12:
            context$2$0.prev = 12;
            context$2$0.t0 = context$2$0['catch'](6);
            throw new Error('Cannot kill the Simulator UI client. Original error: ' + context$2$0.t0.message);

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6, 12]]);
    }

    /**
     * Verify whether the particular application is installed on Simulator.
     * @override
     *
     * @param {string} bundleId - The bundle id of the application to be checked.
     * @return {boolean} True if the given application is installed.
     */
  }, {
    key: 'isAppInstalled',
    value: function isAppInstalled(bundleId) {
      var appContainer, info;
      return _regeneratorRuntime.async(function isAppInstalled$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.getAppContainer)(this.udid, bundleId, false));

          case 3:
            appContainer = context$2$0.sent;
            return context$2$0.abrupt('return', appContainer.endsWith('.app'));

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](0);
            context$2$0.prev = 9;
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.appInfo)(this.udid, bundleId));

          case 12:
            info = context$2$0.sent;
            return context$2$0.abrupt('return', info.includes('ApplicationType'));

          case 16:
            context$2$0.prev = 16;
            context$2$0.t1 = context$2$0['catch'](9);
            return context$2$0.abrupt('return', false);

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 7], [9, 16]]);
    }

    /**
     * @return {string} Application bundle id, which signals that Simulator booting is
     * competed if it is running.
     */
  }, {
    key: 'waitForBoot',

    /**
     * Verify whether the Simulator booting is completed and/or wait for it
     * until the timeout expires.
     * @override
     *
     * @param {number} startupTimeout - the number of milliseconds to wait until booting is completed.
     * @param {?function} bootFn - a function to boot the simulator if simctl reports that it is not booted.
     * @emits BOOT_COMPLETED_EVENT if the current Simulator is ready to accept simctl commands, like 'install'.
     */
    value: function waitForBoot(startupTimeout) {
      var bootFn = arguments.length <= 1 || arguments[1] === undefined ? _lodash2['default'].noop : arguments[1];
      var startupTimestamp, lastError;
      return _regeneratorRuntime.async(function waitForBoot$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            startupTimestamp = process.hrtime();
            lastError = null;
            context$2$0.prev = 2;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((function callee$2$0() {
              var isOnBootCompletedEmitted, tries;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this2 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    isOnBootCompletedEmitted = false;
                    tries = parseInt(startupTimeout / 10000, 10);
                    context$3$0.next = 4;
                    return _regeneratorRuntime.awrap((0, _asyncbox.retry)(tries, function callee$3$0() {
                      return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                        var _this = this;

                        while (1) switch (context$4$0.prev = context$4$0.next) {
                          case 0:
                            context$4$0.next = 2;
                            return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(function callee$4$0() {
                              var _ref,
                              // 'springboard' process should be the last one to start after boot
                              // 'simctl launch' will block until this process is running or fail if booting is still in progress
                              stdout;

                              return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
                                while (1) switch (context$5$0.prev = context$5$0.next) {
                                  case 0:
                                    context$5$0.prev = 0;
                                    context$5$0.next = 3;
                                    return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', ['simctl', 'launch', this.udid, this.startupPollBundleId]));

                                  case 3:
                                    _ref = context$5$0.sent;
                                    stdout = _ref.stdout;

                                    if (!PROCESS_LAUNCH_OK_PATTERN(this.startupPollBundleId).test(stdout)) {
                                      context$5$0.next = 8;
                                      break;
                                    }

                                    if (!isOnBootCompletedEmitted) {
                                      isOnBootCompletedEmitted = true;
                                      this.emit(_simulatorXcode6.BOOT_COMPLETED_EVENT);
                                    }

                                    return context$5$0.abrupt('return', true);

                                  case 8:
                                    context$5$0.next = 17;
                                    break;

                                  case 10:
                                    context$5$0.prev = 10;
                                    context$5$0.t0 = context$5$0['catch'](0);

                                    lastError = context$5$0.t0.stderr || context$5$0.t0.message;

                                    if (!(context$5$0.t0.stderr && context$5$0.t0.stderr.includes('Unable to lookup in current state: Shutdown') && _lodash2['default'].isFunction(bootFn))) {
                                      context$5$0.next = 17;
                                      break;
                                    }

                                    _logger2['default'].debug('Simulator in shutdown state. Retrying boot process');
                                    context$5$0.next = 17;
                                    return _regeneratorRuntime.awrap(bootFn());

                                  case 17:
                                    return context$5$0.abrupt('return', false);

                                  case 18:
                                  case 'end':
                                    return context$5$0.stop();
                                }
                              }, null, _this, [[0, 10]]);
                            }, { waitMs: 10000, intervalMs: 1500 }));

                          case 2:
                          case 'end':
                            return context$4$0.stop();
                        }
                      }, null, _this2);
                    }));

                  case 4:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3);
            })());

          case 5:
            context$2$0.next = 10;
            break;

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](2);

            _logger2['default'].errorAndThrow('Simulator is not booted after ' + process.hrtime(startupTimestamp)[0] + ' seconds ' + ('because of: ' + (lastError || 'an unknown error')));

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[2, 7]]);
    }

    /**
     * Open the given URL in mobile Safari browser.
     * The browser will be started automatically if it is not running.
     * @override
     *
     * @param {string} url - The URL to be opened.
     */
  }, {
    key: 'openUrl',
    value: function openUrl(url) {
      var launchTimestamp, lastError;
      return _regeneratorRuntime.async(function openUrl$(context$2$0) {
        var _this4 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.isRunning());

          case 2:
            if (context$2$0.sent) {
              context$2$0.next = 4;
              break;
            }

            throw new Error('Tried to open ' + url + ', but Simulator is not in Booted state');

          case 4:
            launchTimestamp = process.hrtime();
            lastError = null;
            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(function callee$2$0() {
              var _ref2,
              // This is to make sure Safari is already running
              stdout;

              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.prev = 0;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', ['simctl', 'launch', this.udid, MOBILE_SAFARI_BUNDLE_ID]));

                  case 3:
                    _ref2 = context$3$0.sent;
                    stdout = _ref2.stdout;

                    if (!PROCESS_LAUNCH_OK_PATTERN(MOBILE_SAFARI_BUNDLE_ID).test(stdout)) {
                      context$3$0.next = 9;
                      break;
                    }

                    context$3$0.next = 8;
                    return _regeneratorRuntime.awrap((0, _nodeSimctl.openUrl)(this.udid, url));

                  case 8:
                    return context$3$0.abrupt('return', true);

                  case 9:
                    context$3$0.next = 15;
                    break;

                  case 11:
                    context$3$0.prev = 11;
                    context$3$0.t0 = context$3$0['catch'](0);

                    _logger2['default'].error('Failed to open \'' + url + '\' in Safari. Retrying...');
                    lastError = context$3$0.t0.stderr || context$3$0.t0.message;

                  case 15:
                    return context$3$0.abrupt('return', false);

                  case 16:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this4, [[0, 11]]);
            }, { waitMs: SAFARI_STARTUP_TIMEOUT, intervalMs: 500 }));

          case 9:
            context$2$0.next = 14;
            break;

          case 11:
            context$2$0.prev = 11;
            context$2$0.t0 = context$2$0['catch'](6);

            _logger2['default'].errorAndThrow('Safari cannot open \'' + url + '\' after ' + process.hrtime(launchTimestamp)[0] + ' seconds ' + ('because of: ' + (lastError || 'an unknown error')));

          case 14:
            _logger2['default'].debug('Safari has successfully opened \'' + url + '\' in ' + process.hrtime(launchTimestamp)[0] + ' seconds');

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6, 11]]);
    }

    /**
     * Clean up the directories for mobile Safari.
     * @override
     *
     * @param {boolean} keepPrefs - Whether to keep Safari preferences from being deleted.
     */
  }, {
    key: 'cleanSafari',
    value: function cleanSafari() {
      var keepPrefs = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
      return _regeneratorRuntime.async(function cleanSafari$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.isRunning());

          case 3:
            if (!context$2$0.sent) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.terminate)(this.udid, MOBILE_SAFARI_BUNDLE_ID));

          case 6:
            context$2$0.next = 10;
            break;

          case 8:
            context$2$0.prev = 8;
            context$2$0.t0 = context$2$0['catch'](0);

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(SimulatorXcode8.prototype), 'cleanSafari', this).call(this, keepPrefs));

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 8]]);
    }

    /**
     * Clean/scrub the particular application on Simulator.
     * @override
     *
     * @param {string} appFile - Application name minus ".app".
     * @param {string} appBundleId - Bundle identifier of the application.
     * @param {boolean} scrub - If `scrub` is false, we want to clean by deleting the app and all
     *   files associated with it. If `scrub` is true, we just want to delete the preferences and
     *   changed files.
     */
  }, {
    key: 'cleanCustomApp',
    value: function cleanCustomApp(appFile, appBundleId) {
      var scrub = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
      return _regeneratorRuntime.async(function cleanCustomApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.terminate)(this.udid, appBundleId));

          case 3:
            context$2$0.next = 7;
            break;

          case 5:
            context$2$0.prev = 5;
            context$2$0.t0 = context$2$0['catch'](0);

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(SimulatorXcode8.prototype), 'cleanCustomApp', this).call(this, appFile, appBundleId, scrub));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 5]]);
    }

    /**
     * Perform Shake gesture on Simulator window via AppleScript.
     */
  }, {
    key: 'shake',
    value: function shake() {
      return _regeneratorRuntime.async(function shake$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.executeUIClientScript('\n      tell application "System Events"\n        tell process "Simulator"\n          keystroke "z" using {control down, command down}\n        end tell\n      end tell\n    '));

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Set custom geolocation parameters for the given Simulator using AppleScript.
     *
     * @param {string} latitude - The latitude value, which is going to be entered
     *   into the corresponding edit field, for example '39,0006'.
     * @param {string} longitude - The longitude value, which is going to be entered
     *   into the corresponding edit field, for example '19,0068'.
     * @returns {boolean} True if the given parameters have correct format and were successfully accepted.
     */
  }, {
    key: 'setGeolocation',
    value: function setGeolocation(latitude, longitude) {
      var output;
      return _regeneratorRuntime.async(function setGeolocation$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.executeUIClientScript('\n      tell application "System Events"\n        tell process "Simulator"\n          set featureName to "Custom Location"\n          set dstMenuItem to menu item (featureName & "â€¦") of menu 1 of menu item "Location" of menu 1 of menu bar item "Debug" of menu bar 1\n          click dstMenuItem\n          delay 1\n          set value of text field 1 of window featureName to "' + latitude + '"\n          delay 0.5\n          set value of text field 2 of window featureName to "' + longitude + '"\n          delay 0.5\n          click button "OK" of window featureName\n          delay 0.5\n          set isInvisible to (not (exists (window featureName)))\n        end tell\n      end tell\n    '));

          case 2:
            output = context$2$0.sent;

            _logger2['default'].debug('Geolocation parameters dialog accepted: ' + output);
            return context$2$0.abrupt('return', _lodash2['default'].isString(output) && output.trim() === 'true');

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startupPollBundleId',
    get: function get() {
      return SPRINGBOARD_BUNDLE_ID;
    }

    /**
     * @return {number} The max number of milliseconds to wait until Simulator booting is completed.
     */
  }, {
    key: 'startupTimeout',
    get: function get() {
      return STARTUP_TIMEOUT;
    }
  }]);

  return SimulatorXcode8;
})(_simulatorXcode72['default']);

exports['default'] = SimulatorXcode8;
module.exports = exports['default'];

// get_app_container subcommand fails for system applications,
// so we try the hidden appinfo subcommand, which prints correct info for
// system/hidden apps

// ignore error

// ignore error
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7K0JBQXFDLHFCQUFxQjs7K0JBQzlCLHFCQUFxQjs7OztzQkFDbkMsUUFBUTs7OztzQkFDTixVQUFVOzs7O3dCQUNjLFVBQVU7OzRCQUM3QixjQUFjOzswQkFDMkMsYUFBYTs7O0FBSTNGLElBQU0sZUFBZSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUM7QUFDbkMsSUFBTSxzQkFBc0IsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO0FBQ3pDLElBQU0scUJBQXFCLEdBQUcsdUJBQXVCLENBQUM7QUFDdEQsSUFBTSx1QkFBdUIsR0FBRyx3QkFBd0IsQ0FBQztBQUN6RCxJQUFNLHlCQUF5QixHQUFHLFNBQTVCLHlCQUF5QixDQUFJLFFBQVE7U0FBSyxJQUFJLE1BQU0sQ0FBSSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsZUFBWTtDQUFBLENBQUM7O0lBRWpHLGVBQWU7WUFBZixlQUFlOztBQUNQLFdBRFIsZUFBZSxDQUNOLElBQUksRUFBRSxZQUFZLEVBQUU7MEJBRDdCLGVBQWU7O0FBRWpCLCtCQUZFLGVBQWUsNkNBRVgsSUFBSSxFQUFFLFlBQVksRUFBRTs7Ozs7QUFLMUIsUUFBSSxDQUFDLFlBQVksR0FBRyxDQUNsQixpQkFBaUIsRUFDakIsOENBQThDLEVBQzlDLGlEQUFpRCxFQUNqRCxvQkFBb0IsQ0FDckIsQ0FBQztHQUNIOzs7Ozs7Ozs7Ozs7ZUFiRyxlQUFlOztXQXdCQTtVQUFDLEtBQUsseURBQUcsS0FBSztVQUN6QixHQUFHOzs7Ozs2Q0FBUyxJQUFJLENBQUMsY0FBYyxFQUFFOzs7QUFBakMsZUFBRzs7Z0JBQ0osR0FBRzs7Ozs7Z0RBQ0MsS0FBSzs7OztBQUdkLGdDQUFJLEtBQUssZUFBWSxLQUFLLEdBQUcsU0FBUyxHQUFHLEVBQUUsQ0FBQSxvREFBK0MsR0FBRyxDQUFHLENBQUM7Ozs2Q0FFekYs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O0tBQ3ZEOzs7Ozs7O1dBS1c7Ozs7OzZDQUNKLElBQUksQ0FBQyxxQkFBcUIsa0xBTTlCOzs7Ozs7O0tBQ0g7Ozs7Ozs7Ozs7Ozs7V0FXb0Isd0JBQUMsUUFBUSxFQUFFLFNBQVM7VUFDakMsTUFBTTs7Ozs7NkNBQVMsSUFBSSxDQUFDLHFCQUFxQiwrWEFPYSxRQUFRLDhGQUVSLFNBQVMsOE1BT25FOzs7QUFoQkksa0JBQU07O0FBaUJaLGdDQUFJLEtBQUssOENBQTRDLE1BQU0sQ0FBRyxDQUFDO2dEQUN4RCxvQkFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksTUFBTSxDQUFDLElBQUksRUFBRSxLQUFLLE1BQU07Ozs7Ozs7S0FDdEQ7OztTQTFLdUIsZUFBRztBQUN6QixhQUFPLHFCQUFxQixDQUFDO0tBQzlCOzs7Ozs7O1NBS2tCLGVBQUc7QUFDcEIsYUFBTyxlQUFlLENBQUM7S0FDeEI7OztTQTVFRyxlQUFlOzs7cUJBZ1BOLGVBQWUiLCJmaWxlIjoibGliL3NpbXVsYXRvci14Y29kZS04LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQk9PVF9DT01QTEVURURfRVZFTlQgfSBmcm9tICcuL3NpbXVsYXRvci14Y29kZS02JztcbmltcG9ydCBTaW11bGF0b3JYY29kZTcgZnJvbSAnLi9zaW11bGF0b3IteGNvZGUtNyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uLCByZXRyeSB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgZ2V0QXBwQ29udGFpbmVyLCBvcGVuVXJsIGFzIHNpbWN0bE9wZW5VcmwsIHRlcm1pbmF0ZSwgYXBwSW5mbyB9IGZyb20gJ25vZGUtc2ltY3RsJztcblxuXG4vLyB0aGVzZSBzaW1zIGFyZSBzbG9vb29vb29vd1xuY29uc3QgU1RBUlRVUF9USU1FT1VUID0gMTIwICogMTAwMDtcbmNvbnN0IFNBRkFSSV9TVEFSVFVQX1RJTUVPVVQgPSAyNSAqIDEwMDA7XG5jb25zdCBTUFJJTkdCT0FSRF9CVU5ETEVfSUQgPSAnY29tLmFwcGxlLnNwcmluZ2JvYXJkJztcbmNvbnN0IE1PQklMRV9TQUZBUklfQlVORExFX0lEID0gJ2NvbS5hcHBsZS5tb2JpbGVzYWZhcmknO1xuY29uc3QgUFJPQ0VTU19MQVVOQ0hfT0tfUEFUVEVSTiA9IChidW5kbGVJZCkgPT4gbmV3IFJlZ0V4cChgJHtidW5kbGVJZC5yZXBsYWNlKCcuJywgJ1xcXFwuJyl9OlxcXFxzK1xcXFxkK2ApO1xuXG5jbGFzcyBTaW11bGF0b3JYY29kZTggZXh0ZW5kcyBTaW11bGF0b3JYY29kZTcge1xuICBjb25zdHJ1Y3RvciAodWRpZCwgeGNvZGVWZXJzaW9uKSB7XG4gICAgc3VwZXIodWRpZCwgeGNvZGVWZXJzaW9uKTtcblxuICAgIC8vIGxpc3Qgb2YgZmlsZXMgdG8gY2hlY2sgZm9yIHdoZW4gc2VlaW5nIGlmIGEgc2ltdWxhdG9yIGlzIFwiZnJlc2hcIlxuICAgIC8vIChtZWFuaW5nIGl0IGhhcyBuZXZlciBiZWVuIGJvb3RlZCkuXG4gICAgLy8gSWYgdGhlc2UgZmlsZXMgYXJlIHByZXNlbnQsIHdlIGFzc3VtZSBpdCdzIGJlZW4gc3VjY2Vzc2Z1bGx5IGJvb3RlZFxuICAgIHRoaXMuaXNGcmVzaEZpbGVzID0gW1xuICAgICAgJ0xpYnJhcnkvQ29va2llcycsXG4gICAgICAnTGlicmFyeS9QcmVmZXJlbmNlcy8uR2xvYmFsUHJlZmVyZW5jZXMucGxpc3QnLFxuICAgICAgJ0xpYnJhcnkvUHJlZmVyZW5jZXMvY29tLmFwcGxlLnNwcmluZ2JvYXJkLnBsaXN0JyxcbiAgICAgICd2YXIvcnVuL3N5c2xvZy5waWQnXG4gICAgXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBLaWxsIHRoZSBVSSBjbGllbnQgaWYgaXQgaXMgcnVubmluZy5cbiAgICpcbiAgICogQHBhcmFtIHtib29sZWFufSBmb3JjZSAtIFNldCBpdCB0byB0cnVlIHRvIHNlbmQgU0lHS0lMTCBzaWduYWwgdG8gU2ltdWxhdG9yIHByb2Nlc3MuXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICBTSUdURVJNIHdpbGwgYmUgc2VudCBieSBkZWZhdWx0LlxuICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBVSSBjbGllbnQgd2FzIHN1Y2Nlc3NmdWxseSBraWxsZWQgb3IgZmFsc2VcbiAgICogICAgICAgICAgICAgICAgICAgaWYgaXQgaXMgbm90IHJ1bm5pbmcuXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiBzZW5kaW5nIHRoZSBzaWduYWwgdG8gdGhlIGNsaWVudCBwcm9jZXNzIGZhaWxzXG4gICAqL1xuICBhc3luYyBraWxsVUlDbGllbnQgKGZvcmNlID0gZmFsc2UpIHtcbiAgICBjb25zdCBwaWQgPSBhd2FpdCB0aGlzLmdldFVJQ2xpZW50UGlkKCk7XG4gICAgaWYgKCFwaWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYFNlbmRpbmcgJHtmb3JjZSA/ICdmb3JjZWQgJyA6ICcnfWtpbGwgc2lnbmFsIHRvIFNpbXVsYXRvciBVSSBjbGllbnQgd2l0aCBQSUQgJHtwaWR9YCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWMoJ2tpbGwnLCBmb3JjZSA/IFsnLTknLCBwaWRdIDogW3BpZF0pO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3Qga2lsbCB0aGUgU2ltdWxhdG9yIFVJIGNsaWVudC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZnkgd2hldGhlciB0aGUgcGFydGljdWxhciBhcHBsaWNhdGlvbiBpcyBpbnN0YWxsZWQgb24gU2ltdWxhdG9yLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGJ1bmRsZUlkIC0gVGhlIGJ1bmRsZSBpZCBvZiB0aGUgYXBwbGljYXRpb24gdG8gYmUgY2hlY2tlZC5cbiAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gYXBwbGljYXRpb24gaXMgaW5zdGFsbGVkLlxuICAgKi9cbiAgYXN5bmMgaXNBcHBJbnN0YWxsZWQgKGJ1bmRsZUlkKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGFwcENvbnRhaW5lciA9IGF3YWl0IGdldEFwcENvbnRhaW5lcih0aGlzLnVkaWQsIGJ1bmRsZUlkLCBmYWxzZSk7XG4gICAgICByZXR1cm4gYXBwQ29udGFpbmVyLmVuZHNXaXRoKCcuYXBwJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBnZXRfYXBwX2NvbnRhaW5lciBzdWJjb21tYW5kIGZhaWxzIGZvciBzeXN0ZW0gYXBwbGljYXRpb25zLFxuICAgICAgLy8gc28gd2UgdHJ5IHRoZSBoaWRkZW4gYXBwaW5mbyBzdWJjb21tYW5kLCB3aGljaCBwcmludHMgY29ycmVjdCBpbmZvIGZvclxuICAgICAgLy8gc3lzdGVtL2hpZGRlbiBhcHBzXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBpbmZvID0gYXdhaXQgYXBwSW5mbyh0aGlzLnVkaWQsIGJ1bmRsZUlkKTtcbiAgICAgICAgcmV0dXJuIGluZm8uaW5jbHVkZXMoJ0FwcGxpY2F0aW9uVHlwZScpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm4ge3N0cmluZ30gQXBwbGljYXRpb24gYnVuZGxlIGlkLCB3aGljaCBzaWduYWxzIHRoYXQgU2ltdWxhdG9yIGJvb3RpbmcgaXNcbiAgICogY29tcGV0ZWQgaWYgaXQgaXMgcnVubmluZy5cbiAgICovXG4gIGdldCBzdGFydHVwUG9sbEJ1bmRsZUlkICgpIHtcbiAgICByZXR1cm4gU1BSSU5HQk9BUkRfQlVORExFX0lEO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG1heCBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWwgU2ltdWxhdG9yIGJvb3RpbmcgaXMgY29tcGxldGVkLlxuICAgKi9cbiAgZ2V0IHN0YXJ0dXBUaW1lb3V0ICgpIHtcbiAgICByZXR1cm4gU1RBUlRVUF9USU1FT1VUO1xuICB9XG5cbiAgLyoqXG4gICAqIFZlcmlmeSB3aGV0aGVyIHRoZSBTaW11bGF0b3IgYm9vdGluZyBpcyBjb21wbGV0ZWQgYW5kL29yIHdhaXQgZm9yIGl0XG4gICAqIHVudGlsIHRoZSB0aW1lb3V0IGV4cGlyZXMuXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnR1cFRpbWVvdXQgLSB0aGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IHVudGlsIGJvb3RpbmcgaXMgY29tcGxldGVkLlxuICAgKiBAcGFyYW0gez9mdW5jdGlvbn0gYm9vdEZuIC0gYSBmdW5jdGlvbiB0byBib290IHRoZSBzaW11bGF0b3IgaWYgc2ltY3RsIHJlcG9ydHMgdGhhdCBpdCBpcyBub3QgYm9vdGVkLlxuICAgKiBAZW1pdHMgQk9PVF9DT01QTEVURURfRVZFTlQgaWYgdGhlIGN1cnJlbnQgU2ltdWxhdG9yIGlzIHJlYWR5IHRvIGFjY2VwdCBzaW1jdGwgY29tbWFuZHMsIGxpa2UgJ2luc3RhbGwnLlxuICAgKi9cbiAgYXN5bmMgd2FpdEZvckJvb3QgKHN0YXJ0dXBUaW1lb3V0LCBib290Rm4gPSBfLm5vb3ApIHtcbiAgICBjb25zdCBzdGFydHVwVGltZXN0YW1wID0gcHJvY2Vzcy5ocnRpbWUoKTtcbiAgICBsZXQgbGFzdEVycm9yID0gbnVsbDtcblxuICAgIHRyeSB7XG4gICAgICBsZXQgaXNPbkJvb3RDb21wbGV0ZWRFbWl0dGVkID0gZmFsc2U7XG4gICAgICBsZXQgdHJpZXMgPSBwYXJzZUludChzdGFydHVwVGltZW91dCAvIDEwMDAwLCAxMCk7XG4gICAgICBhd2FpdCByZXRyeSh0cmllcywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gJ3NwcmluZ2JvYXJkJyBwcm9jZXNzIHNob3VsZCBiZSB0aGUgbGFzdCBvbmUgdG8gc3RhcnQgYWZ0ZXIgYm9vdFxuICAgICAgICAgICAgLy8gJ3NpbWN0bCBsYXVuY2gnIHdpbGwgYmxvY2sgdW50aWwgdGhpcyBwcm9jZXNzIGlzIHJ1bm5pbmcgb3IgZmFpbCBpZiBib290aW5nIGlzIHN0aWxsIGluIHByb2dyZXNzXG4gICAgICAgICAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ3hjcnVuJywgWydzaW1jdGwnLCAnbGF1bmNoJywgdGhpcy51ZGlkLCB0aGlzLnN0YXJ0dXBQb2xsQnVuZGxlSWRdKTtcbiAgICAgICAgICAgIGlmIChQUk9DRVNTX0xBVU5DSF9PS19QQVRURVJOKHRoaXMuc3RhcnR1cFBvbGxCdW5kbGVJZCkudGVzdChzdGRvdXQpKSB7XG4gICAgICAgICAgICAgIGlmICghaXNPbkJvb3RDb21wbGV0ZWRFbWl0dGVkKSB7XG4gICAgICAgICAgICAgICAgaXNPbkJvb3RDb21wbGV0ZWRFbWl0dGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoQk9PVF9DT01QTEVURURfRVZFTlQpO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBsYXN0RXJyb3IgPSBlcnIuc3RkZXJyIHx8IGVyci5tZXNzYWdlO1xuICAgICAgICAgICAgaWYgKGVyci5zdGRlcnIgJiYgZXJyLnN0ZGVyci5pbmNsdWRlcygnVW5hYmxlIHRvIGxvb2t1cCBpbiBjdXJyZW50IHN0YXRlOiBTaHV0ZG93bicpICYmIF8uaXNGdW5jdGlvbihib290Rm4pKSB7XG4gICAgICAgICAgICAgIGxvZy5kZWJ1ZyhgU2ltdWxhdG9yIGluIHNodXRkb3duIHN0YXRlLiBSZXRyeWluZyBib290IHByb2Nlc3NgKTtcbiAgICAgICAgICAgICAgYXdhaXQgYm9vdEZuKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSwge3dhaXRNczogMTAwMDAsIGludGVydmFsTXM6IDE1MDB9KTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYFNpbXVsYXRvciBpcyBub3QgYm9vdGVkIGFmdGVyICR7cHJvY2Vzcy5ocnRpbWUoc3RhcnR1cFRpbWVzdGFtcClbMF19IHNlY29uZHMgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgYmVjYXVzZSBvZjogJHtsYXN0RXJyb3IgfHwgJ2FuIHVua25vd24gZXJyb3InfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVuIHRoZSBnaXZlbiBVUkwgaW4gbW9iaWxlIFNhZmFyaSBicm93c2VyLlxuICAgKiBUaGUgYnJvd3NlciB3aWxsIGJlIHN0YXJ0ZWQgYXV0b21hdGljYWxseSBpZiBpdCBpcyBub3QgcnVubmluZy5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBUaGUgVVJMIHRvIGJlIG9wZW5lZC5cbiAgICovXG4gIGFzeW5jIG9wZW5VcmwgKHVybCkge1xuICAgIGlmICghYXdhaXQgdGhpcy5pc1J1bm5pbmcoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcmllZCB0byBvcGVuICR7dXJsfSwgYnV0IFNpbXVsYXRvciBpcyBub3QgaW4gQm9vdGVkIHN0YXRlYCk7XG4gICAgfVxuICAgIGNvbnN0IGxhdW5jaFRpbWVzdGFtcCA9IHByb2Nlc3MuaHJ0aW1lKCk7XG4gICAgbGV0IGxhc3RFcnJvciA9IG51bGw7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIC8vIFRoaXMgaXMgdG8gbWFrZSBzdXJlIFNhZmFyaSBpcyBhbHJlYWR5IHJ1bm5pbmdcbiAgICAgICAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ3hjcnVuJywgWydzaW1jdGwnLCAnbGF1bmNoJywgdGhpcy51ZGlkLCBNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRF0pO1xuICAgICAgICAgIGlmIChQUk9DRVNTX0xBVU5DSF9PS19QQVRURVJOKE1PQklMRV9TQUZBUklfQlVORExFX0lEKS50ZXN0KHN0ZG91dCkpIHtcbiAgICAgICAgICAgIGF3YWl0IHNpbWN0bE9wZW5VcmwodGhpcy51ZGlkLCB1cmwpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBsb2cuZXJyb3IoYEZhaWxlZCB0byBvcGVuICcke3VybH0nIGluIFNhZmFyaS4gUmV0cnlpbmcuLi5gKTtcbiAgICAgICAgICBsYXN0RXJyb3IgPSBlcnIuc3RkZXJyIHx8IGVyci5tZXNzYWdlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0sIHt3YWl0TXM6IFNBRkFSSV9TVEFSVFVQX1RJTUVPVVQsIGludGVydmFsTXM6IDUwMH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYFNhZmFyaSBjYW5ub3Qgb3BlbiAnJHt1cmx9JyBhZnRlciAke3Byb2Nlc3MuaHJ0aW1lKGxhdW5jaFRpbWVzdGFtcClbMF19IHNlY29uZHMgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgYmVjYXVzZSBvZjogJHtsYXN0RXJyb3IgfHwgJ2FuIHVua25vd24gZXJyb3InfWApO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFNhZmFyaSBoYXMgc3VjY2Vzc2Z1bGx5IG9wZW5lZCAnJHt1cmx9JyBpbiAke3Byb2Nlc3MuaHJ0aW1lKGxhdW5jaFRpbWVzdGFtcClbMF19IHNlY29uZHNgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhbiB1cCB0aGUgZGlyZWN0b3JpZXMgZm9yIG1vYmlsZSBTYWZhcmkuXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGtlZXBQcmVmcyAtIFdoZXRoZXIgdG8ga2VlcCBTYWZhcmkgcHJlZmVyZW5jZXMgZnJvbSBiZWluZyBkZWxldGVkLlxuICAgKi9cbiAgYXN5bmMgY2xlYW5TYWZhcmkgKGtlZXBQcmVmcyA9IHRydWUpIHtcbiAgICB0cnkge1xuICAgICAgaWYgKGF3YWl0IHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgICAgYXdhaXQgdGVybWluYXRlKHRoaXMudWRpZCwgTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGlnbikge1xuICAgICAgLy8gaWdub3JlIGVycm9yXG4gICAgfVxuICAgIGF3YWl0IHN1cGVyLmNsZWFuU2FmYXJpKGtlZXBQcmVmcyk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW4vc2NydWIgdGhlIHBhcnRpY3VsYXIgYXBwbGljYXRpb24gb24gU2ltdWxhdG9yLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEZpbGUgLSBBcHBsaWNhdGlvbiBuYW1lIG1pbnVzIFwiLmFwcFwiLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gYXBwQnVuZGxlSWQgLSBCdW5kbGUgaWRlbnRpZmllciBvZiB0aGUgYXBwbGljYXRpb24uXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gc2NydWIgLSBJZiBgc2NydWJgIGlzIGZhbHNlLCB3ZSB3YW50IHRvIGNsZWFuIGJ5IGRlbGV0aW5nIHRoZSBhcHAgYW5kIGFsbFxuICAgKiAgIGZpbGVzIGFzc29jaWF0ZWQgd2l0aCBpdC4gSWYgYHNjcnViYCBpcyB0cnVlLCB3ZSBqdXN0IHdhbnQgdG8gZGVsZXRlIHRoZSBwcmVmZXJlbmNlcyBhbmRcbiAgICogICBjaGFuZ2VkIGZpbGVzLlxuICAgKi9cbiAgYXN5bmMgY2xlYW5DdXN0b21BcHAgKGFwcEZpbGUsIGFwcEJ1bmRsZUlkLCBzY3J1YiA9IGZhbHNlKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRlcm1pbmF0ZSh0aGlzLnVkaWQsIGFwcEJ1bmRsZUlkKTtcbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIC8vIGlnbm9yZSBlcnJvclxuICAgIH1cbiAgICBhd2FpdCBzdXBlci5jbGVhbkN1c3RvbUFwcChhcHBGaWxlLCBhcHBCdW5kbGVJZCwgc2NydWIpO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gU2hha2UgZ2VzdHVyZSBvbiBTaW11bGF0b3Igd2luZG93IHZpYSBBcHBsZVNjcmlwdC5cbiAgICovXG4gIGFzeW5jIHNoYWtlICgpIHtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVVSUNsaWVudFNjcmlwdChgXG4gICAgICB0ZWxsIGFwcGxpY2F0aW9uIFwiU3lzdGVtIEV2ZW50c1wiXG4gICAgICAgIHRlbGwgcHJvY2VzcyBcIlNpbXVsYXRvclwiXG4gICAgICAgICAga2V5c3Ryb2tlIFwielwiIHVzaW5nIHtjb250cm9sIGRvd24sIGNvbW1hbmQgZG93bn1cbiAgICAgICAgZW5kIHRlbGxcbiAgICAgIGVuZCB0ZWxsXG4gICAgYCk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IGN1c3RvbSBnZW9sb2NhdGlvbiBwYXJhbWV0ZXJzIGZvciB0aGUgZ2l2ZW4gU2ltdWxhdG9yIHVzaW5nIEFwcGxlU2NyaXB0LlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gbGF0aXR1ZGUgLSBUaGUgbGF0aXR1ZGUgdmFsdWUsIHdoaWNoIGlzIGdvaW5nIHRvIGJlIGVudGVyZWRcbiAgICogICBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIGVkaXQgZmllbGQsIGZvciBleGFtcGxlICczOSwwMDA2Jy5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGxvbmdpdHVkZSAtIFRoZSBsb25naXR1ZGUgdmFsdWUsIHdoaWNoIGlzIGdvaW5nIHRvIGJlIGVudGVyZWRcbiAgICogICBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIGVkaXQgZmllbGQsIGZvciBleGFtcGxlICcxOSwwMDY4Jy5cbiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIHBhcmFtZXRlcnMgaGF2ZSBjb3JyZWN0IGZvcm1hdCBhbmQgd2VyZSBzdWNjZXNzZnVsbHkgYWNjZXB0ZWQuXG4gICAqL1xuICBhc3luYyBzZXRHZW9sb2NhdGlvbiAobGF0aXR1ZGUsIGxvbmdpdHVkZSkge1xuICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHRoaXMuZXhlY3V0ZVVJQ2xpZW50U2NyaXB0KGBcbiAgICAgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCJcbiAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICBzZXQgZmVhdHVyZU5hbWUgdG8gXCJDdXN0b20gTG9jYXRpb25cIlxuICAgICAgICAgIHNldCBkc3RNZW51SXRlbSB0byBtZW51IGl0ZW0gKGZlYXR1cmVOYW1lICYgXCLigKZcIikgb2YgbWVudSAxIG9mIG1lbnUgaXRlbSBcIkxvY2F0aW9uXCIgb2YgbWVudSAxIG9mIG1lbnUgYmFyIGl0ZW0gXCJEZWJ1Z1wiIG9mIG1lbnUgYmFyIDFcbiAgICAgICAgICBjbGljayBkc3RNZW51SXRlbVxuICAgICAgICAgIGRlbGF5IDFcbiAgICAgICAgICBzZXQgdmFsdWUgb2YgdGV4dCBmaWVsZCAxIG9mIHdpbmRvdyBmZWF0dXJlTmFtZSB0byBcIiR7bGF0aXR1ZGV9XCJcbiAgICAgICAgICBkZWxheSAwLjVcbiAgICAgICAgICBzZXQgdmFsdWUgb2YgdGV4dCBmaWVsZCAyIG9mIHdpbmRvdyBmZWF0dXJlTmFtZSB0byBcIiR7bG9uZ2l0dWRlfVwiXG4gICAgICAgICAgZGVsYXkgMC41XG4gICAgICAgICAgY2xpY2sgYnV0dG9uIFwiT0tcIiBvZiB3aW5kb3cgZmVhdHVyZU5hbWVcbiAgICAgICAgICBkZWxheSAwLjVcbiAgICAgICAgICBzZXQgaXNJbnZpc2libGUgdG8gKG5vdCAoZXhpc3RzICh3aW5kb3cgZmVhdHVyZU5hbWUpKSlcbiAgICAgICAgZW5kIHRlbGxcbiAgICAgIGVuZCB0ZWxsXG4gICAgYCk7XG4gICAgbG9nLmRlYnVnKGBHZW9sb2NhdGlvbiBwYXJhbWV0ZXJzIGRpYWxvZyBhY2NlcHRlZDogJHtvdXRwdXR9YCk7XG4gICAgcmV0dXJuIF8uaXNTdHJpbmcob3V0cHV0KSAmJiBvdXRwdXQudHJpbSgpID09PSAndHJ1ZSc7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgU2ltdWxhdG9yWGNvZGU4O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
