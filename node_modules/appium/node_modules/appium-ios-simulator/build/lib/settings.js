'use strict';

var _defineProperty = require('babel-runtime/helpers/define-property')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _Symbol$iterator = require('babel-runtime/core-js/symbol/iterator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSupport = require('appium-support');

var _path2 = require('path');

var _path3 = _interopRequireDefault(_path2);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _semver = require('semver');

var _semver2 = _interopRequireDefault(_semver);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

// returns path to plist based on id for plist.
// these ids are appium terms
function plistPaths(sim, identifier) {
  var paths, simDirectory;
  return _regeneratorRuntime.async(function plistPaths$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        paths = [];
        simDirectory = sim.getDir();
        context$1$0.t0 = identifier;
        context$1$0.next = context$1$0.t0 === 'webInspector' ? 5 : context$1$0.t0 === 'mobileSafari' ? 7 : context$1$0.t0 === 'webUI' ? 15 : context$1$0.t0 === 'webFoundation' ? 17 : context$1$0.t0 === 'preferences' ? 19 : context$1$0.t0 === 'locationServices' ? 21 : context$1$0.t0 === 'locationClients' ? 23 : context$1$0.t0 === 'locationCache' ? 25 : context$1$0.t0 === 'userSettings' ? 28 : context$1$0.t0 === 'effectiveUserSettings' ? 30 : context$1$0.t0 === 'accessibilitySettings' ? 33 : 35;
        break;

      case 5:
        paths.push(_path3['default'].resolve(simDirectory, 'Library', 'Preferences', 'com.apple.webInspector.plist'));
        return context$1$0.abrupt('break', 35);

      case 7:
        context$1$0.t1 = paths;
        context$1$0.t2 = _path3['default'];
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(sim.getAppDir('com.apple.mobilesafari'));

      case 11:
        context$1$0.t3 = context$1$0.sent;
        context$1$0.t4 = context$1$0.t2.resolve.call(context$1$0.t2, context$1$0.t3, 'Library', 'Preferences', 'com.apple.mobilesafari.plist');
        context$1$0.t1.push.call(context$1$0.t1, context$1$0.t4);
        return context$1$0.abrupt('break', 35);

      case 15:
        paths.push(_path3['default'].resolve(simDirectory, 'Library', 'Preferences', 'com.apple.WebUI.plist'));
        return context$1$0.abrupt('break', 35);

      case 17:
        paths.push(_path3['default'].resolve(simDirectory, 'Library', 'Preferences', 'com.apple.WebFoundation.plist'));
        return context$1$0.abrupt('break', 35);

      case 19:
        paths.push(_path3['default'].resolve(simDirectory, 'Library', 'Preferences', 'com.apple.Preferences.plist'));
        return context$1$0.abrupt('break', 35);

      case 21:
        paths.push(_path3['default'].resolve(simDirectory, 'Library', 'Preferences', 'com.apple.locationd.plist'));
        return context$1$0.abrupt('break', 35);

      case 23:
        paths.push(_path3['default'].resolve(simDirectory, 'Library', 'Caches', 'locationd', 'clients.plist'));
        return context$1$0.abrupt('break', 35);

      case 25:
        paths.push(_path3['default'].resolve(simDirectory, 'Library', 'Caches', 'locationd', 'cache.plist'));
        paths.push(_path3['default'].resolve(simDirectory, 'Library', 'Preferences', 'com.apple.locationd.plist'));
        return context$1$0.abrupt('break', 35);

      case 28:
        if (_semver2['default'].lt(_semver2['default'].coerce(sim.xcodeVersion.versionString), _semver2['default'].coerce('7.3'))) {
          paths.push(_path3['default'].resolve(simDirectory, 'Library', 'ConfigurationProfiles', 'UserSettings.plist'));
          paths.push(_path3['default'].resolve(simDirectory, 'Library', 'ConfigurationProfiles', 'EffectiveUserSettings.plist'));
          paths.push(_path3['default'].resolve(simDirectory, 'Library', 'ConfigurationProfiles', 'PublicInfo', 'PublicEffectiveUserSettings.plist'));
        } else {
          paths.push(_path3['default'].resolve(simDirectory, 'Library', 'UserConfigurationProfiles', 'UserSettings.plist'));
          paths.push(_path3['default'].resolve(simDirectory, 'Library', 'UserConfigurationProfiles', 'EffectiveUserSettings.plist'));
          paths.push(_path3['default'].resolve(simDirectory, 'Library', 'UserConfigurationProfiles', 'PublicInfo', 'PublicEffectiveUserSettings.plist'));
        }
        return context$1$0.abrupt('break', 35);

      case 30:
        paths.push(_path3['default'].resolve(simDirectory, 'Library', 'ConfigurationProfiles', 'EffectiveUserSettings.plist'));
        paths.push(_path3['default'].resolve(simDirectory, 'Library', 'ConfigurationProfiles', 'PublicInfo', 'PublicEffectiveUserSettings.plist'));
        return context$1$0.abrupt('break', 35);

      case 33:
        paths.push(_path3['default'].resolve(simDirectory, 'Library', 'Preferences', 'com.apple.Accessibility.plist'));
        return context$1$0.abrupt('break', 35);

      case 35:
        return context$1$0.abrupt('return', paths);

      case 36:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function updateSettings(sim, plist, updates) {
  return _regeneratorRuntime.async(function updateSettings$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.t0 = _regeneratorRuntime;
        context$1$0.t1 = _bluebird2['default'];
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(plistPaths(sim, plist));

      case 4:
        context$1$0.t2 = context$1$0.sent;

        context$1$0.t3 = function reducer(updated, path) {
          return _regeneratorRuntime.async(function reducer$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(update(path, updates));

              case 2:
                context$2$0.t0 = context$2$0.sent;

                if (context$2$0.t0) {
                  context$2$0.next = 5;
                  break;
                }

                context$2$0.t0 = updated;

              case 5:
                return context$2$0.abrupt('return', context$2$0.t0);

              case 6:
              case 'end':
                return context$2$0.stop();
            }
          }, null, this);
        };

        context$1$0.t4 = context$1$0.t1.reduce.call(context$1$0.t1, context$1$0.t2, context$1$0.t3, false);
        context$1$0.next = 9;
        return context$1$0.t0.awrap.call(context$1$0.t0, context$1$0.t4);

      case 9:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

// update a plist file, located at pathToPlist
// pass in an object, all settings specified in the object will be
// updated on the plist, all others left as-is
function update(pathToPlist, updates) {
  var currentSettings, newSettings;
  return _regeneratorRuntime.async(function update$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(read(pathToPlist));

      case 2:
        currentSettings = context$1$0.sent;
        newSettings = _Object$assign({}, currentSettings, updates);

        if (!_lodash2['default'].isEqual(currentSettings, newSettings)) {
          context$1$0.next = 6;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_appiumSupport.plist.updatePlistFile(pathToPlist, newSettings, true, false));

      case 8:
        return context$1$0.abrupt('return', true);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function readSettings(sim, plist) {
  var settings, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _path;

  return _regeneratorRuntime.async(function readSettings$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        settings = {};
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 4;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(plistPaths(sim, plist));

      case 7:
        context$1$0.t0 = _Symbol$iterator;
        _iterator = context$1$0.sent[context$1$0.t0]();

      case 9:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 17;
          break;
        }

        _path = _step.value;
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(read(_path));

      case 13:
        settings[_path] = context$1$0.sent;

      case 14:
        _iteratorNormalCompletion = true;
        context$1$0.next = 9;
        break;

      case 17:
        context$1$0.next = 23;
        break;

      case 19:
        context$1$0.prev = 19;
        context$1$0.t1 = context$1$0['catch'](4);
        _didIteratorError = true;
        _iteratorError = context$1$0.t1;

      case 23:
        context$1$0.prev = 23;
        context$1$0.prev = 24;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 26:
        context$1$0.prev = 26;

        if (!_didIteratorError) {
          context$1$0.next = 29;
          break;
        }

        throw _iteratorError;

      case 29:
        return context$1$0.finish(26);

      case 30:
        return context$1$0.finish(23);

      case 31:
        return context$1$0.abrupt('return', settings);

      case 32:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[4, 19, 23, 31], [24,, 26, 30]]);
}

function read(pathToPlist) {
  return _regeneratorRuntime.async(function read$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.plist.parsePlistFile(pathToPlist, false));

      case 2:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function updateLocationSettings(sim, bundleId, authorized) {
  var newCachePrefs, updated, newClientPrefs, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, file, updates, _plist, weirdLocKey, baseSetting;

  return _regeneratorRuntime.async(function updateLocationSettings$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        newCachePrefs = {
          LastFenceActivityTimestamp: 412122103.232983,
          CleanShutdown: true
        };
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(updateSettings(sim, 'locationCache', _defineProperty({}, bundleId, newCachePrefs)));

      case 3:
        updated = context$1$0.sent;
        newClientPrefs = {
          BundleId: bundleId,
          Authorized: !!authorized,
          Whitelisted: false
        };
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 8;
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(plistPaths(sim, 'locationClients'));

      case 11:
        context$1$0.t0 = _Symbol$iterator;
        _iterator2 = context$1$0.sent[context$1$0.t0]();

      case 13:
        if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
          context$1$0.next = 35;
          break;
        }

        file = _step2.value;

        _logger2['default'].debug('Updating location client file: ' + file);

        updates = {};
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(read(file));

      case 19:
        _plist = context$1$0.sent;
        weirdLocKey = 'com.apple.locationd.bundle-/System/Library/' + 'PrivateFrameworks/AOSNotification.framework';

        if (!_lodash2['default'].has(_plist, weirdLocKey)) {
          updates[weirdLocKey] = {
            BundlePath: '/System/Library/PrivateFrameworks/AOSNotification.framework',
            Whitelisted: false,
            Executable: '',
            Registered: ''
          };
        }

        // create the update, and make sure it has sensible values
        baseSetting = _lodash2['default'].has(_plist, bundleId) ? _plist[bundleId] : {};

        updates[bundleId] = _lodash2['default'].defaults(newClientPrefs, baseSetting);
        updates[bundleId].Executable = updates[bundleId].Executable || '';
        updates[bundleId].Registered = updates[bundleId].Registered || '';

        context$1$0.next = 28;
        return _regeneratorRuntime.awrap(update(file, updates));

      case 28:
        context$1$0.t1 = context$1$0.sent;

        if (context$1$0.t1) {
          context$1$0.next = 31;
          break;
        }

        context$1$0.t1 = updated;

      case 31:
        updated = context$1$0.t1;

      case 32:
        _iteratorNormalCompletion2 = true;
        context$1$0.next = 13;
        break;

      case 35:
        context$1$0.next = 41;
        break;

      case 37:
        context$1$0.prev = 37;
        context$1$0.t2 = context$1$0['catch'](8);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t2;

      case 41:
        context$1$0.prev = 41;
        context$1$0.prev = 42;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 44:
        context$1$0.prev = 44;

        if (!_didIteratorError2) {
          context$1$0.next = 47;
          break;
        }

        throw _iteratorError2;

      case 47:
        return context$1$0.finish(44);

      case 48:
        return context$1$0.finish(41);

      case 49:
        return context$1$0.abrupt('return', updated);

      case 50:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[8, 37, 41, 49], [42,, 44, 48]]);
}

function setReduceMotion(sim) {
  var reduceMotion = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

  var paths, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, file;

  return _regeneratorRuntime.async(function setReduceMotion$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(plistPaths(sim, 'accessibilitySettings'));

      case 2:
        paths = context$1$0.sent;
        _iteratorNormalCompletion3 = true;
        _didIteratorError3 = false;
        _iteratorError3 = undefined;
        context$1$0.prev = 6;
        _iterator3 = _getIterator(paths);

      case 8:
        if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
          context$1$0.next = 15;
          break;
        }

        file = _step3.value;
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(update(file, {
          ReduceMotionEnabled: reduceMotion ? 1 : 0
        }));

      case 12:
        _iteratorNormalCompletion3 = true;
        context$1$0.next = 8;
        break;

      case 15:
        context$1$0.next = 21;
        break;

      case 17:
        context$1$0.prev = 17;
        context$1$0.t0 = context$1$0['catch'](6);
        _didIteratorError3 = true;
        _iteratorError3 = context$1$0.t0;

      case 21:
        context$1$0.prev = 21;
        context$1$0.prev = 22;

        if (!_iteratorNormalCompletion3 && _iterator3['return']) {
          _iterator3['return']();
        }

      case 24:
        context$1$0.prev = 24;

        if (!_didIteratorError3) {
          context$1$0.next = 27;
          break;
        }

        throw _iteratorError3;

      case 27:
        return context$1$0.finish(24);

      case 28:
        return context$1$0.finish(21);

      case 29:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6, 17, 21, 29], [22,, 24, 28]]);
}

function updateSafariUserSettings(sim, settingSet) {
  var newUserSettings, updated, _iteratorNormalCompletion4, _didIteratorError4, _iteratorError4, _iterator4, _step4, _step4$value, file, userSettingSet, _iteratorNormalCompletion5, _didIteratorError5, _iteratorError5, _iterator5, _step5, _step5$value, key, value;

  return _regeneratorRuntime.async(function updateSafariUserSettings$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Updating Safari user settings');

        // add extra stuff to UserSettings.plist and EffectiveUserSettings.plist
        newUserSettings = {};

        if (_lodash2['default'].has(settingSet, 'WebKitJavaScriptEnabled')) {
          newUserSettings.safariAllowJavaScript = settingSet.WebKitJavaScriptEnabled;
        }
        if (_lodash2['default'].has(settingSet, 'WebKitJavaScriptCanOpenWindowsAutomatically')) {
          newUserSettings.safariAllowPopups = settingSet.WebKitJavaScriptCanOpenWindowsAutomatically;
        }
        if (_lodash2['default'].has(settingSet, 'WarnAboutFraudulentWebsites')) {
          newUserSettings.safariForceFraudWarning = !settingSet.WarnAboutFraudulentWebsites;
        }

        if (!_lodash2['default'].isEmpty(newUserSettings)) {
          context$1$0.next = 7;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 7:
        updated = false;
        _iteratorNormalCompletion4 = true;
        _didIteratorError4 = false;
        _iteratorError4 = undefined;
        context$1$0.prev = 11;
        context$1$0.t0 = _lodash2['default'];
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(readSettings(sim, 'userSettings'));

      case 15:
        context$1$0.t1 = context$1$0.sent;
        context$1$0.t2 = _Symbol$iterator;
        _iterator4 = context$1$0.t0.toPairs.call(context$1$0.t0, context$1$0.t1)[context$1$0.t2]();

      case 18:
        if (_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done) {
          context$1$0.next = 51;
          break;
        }

        _step4$value = _slicedToArray(_step4.value, 2);
        file = _step4$value[0];
        userSettingSet = _step4$value[1];

        // the user settings plist has two buckets, one for
        // boolean settings (`restrictedBool`) and one for
        // other value settings (`restrictedValue`). In each, the value
        // is in a `value` sub-field.
        if (!_lodash2['default'].has(userSettingSet, 'restrictedBool')) {
          userSettingSet.restrictedBool = {};
        }
        _iteratorNormalCompletion5 = true;
        _didIteratorError5 = false;
        _iteratorError5 = undefined;
        context$1$0.prev = 26;
        for (_iterator5 = _getIterator(_lodash2['default'].toPairs(newUserSettings)); !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
          _step5$value = _slicedToArray(_step5.value, 2);
          key = _step5$value[0];
          value = _step5$value[1];

          userSettingSet.restrictedBool[key] = { value: value };
        }

        // actually do the update
        context$1$0.next = 34;
        break;

      case 30:
        context$1$0.prev = 30;
        context$1$0.t3 = context$1$0['catch'](26);
        _didIteratorError5 = true;
        _iteratorError5 = context$1$0.t3;

      case 34:
        context$1$0.prev = 34;
        context$1$0.prev = 35;

        if (!_iteratorNormalCompletion5 && _iterator5['return']) {
          _iterator5['return']();
        }

      case 37:
        context$1$0.prev = 37;

        if (!_didIteratorError5) {
          context$1$0.next = 40;
          break;
        }

        throw _iteratorError5;

      case 40:
        return context$1$0.finish(37);

      case 41:
        return context$1$0.finish(34);

      case 42:
        context$1$0.next = 44;
        return _regeneratorRuntime.awrap(update(file, userSettingSet));

      case 44:
        context$1$0.t4 = context$1$0.sent;

        if (context$1$0.t4) {
          context$1$0.next = 47;
          break;
        }

        context$1$0.t4 = updated;

      case 47:
        updated = context$1$0.t4;

      case 48:
        _iteratorNormalCompletion4 = true;
        context$1$0.next = 18;
        break;

      case 51:
        context$1$0.next = 57;
        break;

      case 53:
        context$1$0.prev = 53;
        context$1$0.t5 = context$1$0['catch'](11);
        _didIteratorError4 = true;
        _iteratorError4 = context$1$0.t5;

      case 57:
        context$1$0.prev = 57;
        context$1$0.prev = 58;

        if (!_iteratorNormalCompletion4 && _iterator4['return']) {
          _iterator4['return']();
        }

      case 60:
        context$1$0.prev = 60;

        if (!_didIteratorError4) {
          context$1$0.next = 63;
          break;
        }

        throw _iteratorError4;

      case 63:
        return context$1$0.finish(60);

      case 64:
        return context$1$0.finish(57);

      case 65:
        return context$1$0.abrupt('return', updated);

      case 66:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[11, 53, 57, 65], [26, 30, 34, 42], [35,, 37, 41], [58,, 60, 64]]);
}

function updateLocale(sim, language, locale, calendarFormat) {
  var globalPrefs, data, updates, supportedLangs, calSplit, curLocaleAndCal, split, curLoc, newLocaleAndCal;
  return _regeneratorRuntime.async(function updateLocale$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        globalPrefs = _path3['default'].resolve(sim.getDir(), 'Library', 'Preferences', '.GlobalPreferences.plist');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(read(globalPrefs));

      case 3:
        data = context$1$0.sent;
        updates = {};

        // if we are setting the language, add it to the beginning of the list of languages
        if (language) {
          _logger2['default'].debug('New language: ' + language);
          supportedLangs = data.AppleLanguages || [];

          // if the language is first, we don't need to do anything
          if (supportedLangs.indexOf(language) !== 0) {
            updates.AppleLanguages = [language].concat(_lodash2['default'].without(supportedLangs, language));
          }
        }
        // if we are setting the locale or calendar format, set them as appropriate
        if (locale || calendarFormat) {
          calSplit = '@calendar=';
          curLocaleAndCal = data.AppleLocale || language || 'en';
          split = curLocaleAndCal.split(calSplit);
          curLoc = split[0];

          if (calendarFormat || split[1]) {
            calendarFormat = '' + calSplit + (calendarFormat || split[1] || '');
          }
          calendarFormat = calendarFormat || '';
          newLocaleAndCal = locale ? locale : curLoc;

          if (calendarFormat) {
            newLocaleAndCal = '' + newLocaleAndCal + calendarFormat;
          }
          // only need to update if it has changed
          if (newLocaleAndCal !== curLocaleAndCal) {
            _logger2['default'].debug('New locale: ' + newLocaleAndCal);
            updates.AppleLocale = newLocaleAndCal;
          }
        }

        if (!(_lodash2['default'].size(updates) === 0)) {
          context$1$0.next = 10;
          break;
        }

        _logger2['default'].debug('No locale updates necessary.');
        return context$1$0.abrupt('return', false);

      case 10:

        _logger2['default'].debug('Writing new locale plist data');
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(update(globalPrefs, updates));

      case 13:
        return context$1$0.abrupt('return', true);

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function stub() {
  return _regeneratorRuntime.async(function stub$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(plistPaths);

      case 2:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.update = update;
exports.updateSettings = updateSettings;
exports.updateLocationSettings = updateLocationSettings;
exports.setReduceMotion = setReduceMotion;
exports.updateSafariUserSettings = updateSafariUserSettings;
exports.updateLocale = updateLocale;
exports.read = read;
exports.readSettings = readSettings;
exports.stub = stub;

// no setting changes, so do nothing

// update location cache

// update location clients

// see if the bundle is already there

// random data that always seems to be in the clients.plist

// get the current data
//# sourceMappingURL=data:application/json;charset=utf8;base64,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LEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDOzt5Q0FDckMsTUFBTSxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUM7Ozs0Q0FDM0IsSUFBSTs7Ozs7OztDQUNaOztBQUVELFNBQWUsSUFBSTs7Ozs7eUNBQ0osVUFBVTs7Ozs7Ozs7OztDQUN4Qjs7UUFFUSxNQUFNLEdBQU4sTUFBTTtRQUFFLGNBQWMsR0FBZCxjQUFjO1FBQUUsc0JBQXNCLEdBQXRCLHNCQUFzQjtRQUFFLGVBQWUsR0FBZixlQUFlO1FBQ2hFLHdCQUF3QixHQUF4Qix3QkFBd0I7UUFBRSxZQUFZLEdBQVosWUFBWTtRQUFFLElBQUksR0FBSixJQUFJO1FBQUUsWUFBWSxHQUFaLFlBQVk7UUFBRSxJQUFJLEdBQUosSUFBSSIsImZpbGUiOiJsaWIvc2V0dGluZ3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgcGxpc3QgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5cbi8vIHJldHVybnMgcGF0aCB0byBwbGlzdCBiYXNlZCBvbiBpZCBmb3IgcGxpc3QuXG4vLyB0aGVzZSBpZHMgYXJlIGFwcGl1bSB0ZXJtc1xuYXN5bmMgZnVuY3Rpb24gcGxpc3RQYXRocyAoc2ltLCBpZGVudGlmaWVyKSB7XG4gIGxldCBwYXRocyA9IFtdO1xuICBsZXQgc2ltRGlyZWN0b3J5ID0gc2ltLmdldERpcigpO1xuXG4gIHN3aXRjaCAoaWRlbnRpZmllcikge1xuICAgIGNhc2UgJ3dlYkluc3BlY3Rvcic6XG4gICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ1ByZWZlcmVuY2VzJywgJ2NvbS5hcHBsZS53ZWJJbnNwZWN0b3IucGxpc3QnKSk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdtb2JpbGVTYWZhcmknOlxuICAgICAgcGF0aHMucHVzaChwYXRoLnJlc29sdmUoYXdhaXQgc2ltLmdldEFwcERpcignY29tLmFwcGxlLm1vYmlsZXNhZmFyaScpLCAnTGlicmFyeScsICdQcmVmZXJlbmNlcycsICdjb20uYXBwbGUubW9iaWxlc2FmYXJpLnBsaXN0JykpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnd2ViVUknOlxuICAgICAgcGF0aHMucHVzaChwYXRoLnJlc29sdmUoc2ltRGlyZWN0b3J5LCAnTGlicmFyeScsICdQcmVmZXJlbmNlcycsICdjb20uYXBwbGUuV2ViVUkucGxpc3QnKSk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICd3ZWJGb3VuZGF0aW9uJzpcbiAgICAgIHBhdGhzLnB1c2gocGF0aC5yZXNvbHZlKHNpbURpcmVjdG9yeSwgJ0xpYnJhcnknLCAnUHJlZmVyZW5jZXMnLCAnY29tLmFwcGxlLldlYkZvdW5kYXRpb24ucGxpc3QnKSk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdwcmVmZXJlbmNlcyc6XG4gICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ1ByZWZlcmVuY2VzJywgJ2NvbS5hcHBsZS5QcmVmZXJlbmNlcy5wbGlzdCcpKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ2xvY2F0aW9uU2VydmljZXMnOlxuICAgICAgcGF0aHMucHVzaChwYXRoLnJlc29sdmUoc2ltRGlyZWN0b3J5LCAnTGlicmFyeScsICdQcmVmZXJlbmNlcycsICdjb20uYXBwbGUubG9jYXRpb25kLnBsaXN0JykpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnbG9jYXRpb25DbGllbnRzJzpcbiAgICAgIHBhdGhzLnB1c2gocGF0aC5yZXNvbHZlKHNpbURpcmVjdG9yeSwgJ0xpYnJhcnknLCAnQ2FjaGVzJywgJ2xvY2F0aW9uZCcsICdjbGllbnRzLnBsaXN0JykpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnbG9jYXRpb25DYWNoZSc6XG4gICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ0NhY2hlcycsICdsb2NhdGlvbmQnLCAnY2FjaGUucGxpc3QnKSk7XG4gICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ1ByZWZlcmVuY2VzJywgJ2NvbS5hcHBsZS5sb2NhdGlvbmQucGxpc3QnKSk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICd1c2VyU2V0dGluZ3MnOlxuICAgICAgaWYgKHNlbXZlci5sdChzZW12ZXIuY29lcmNlKHNpbS54Y29kZVZlcnNpb24udmVyc2lvblN0cmluZyksIHNlbXZlci5jb2VyY2UoJzcuMycpKSkge1xuICAgICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ0NvbmZpZ3VyYXRpb25Qcm9maWxlcycsICdVc2VyU2V0dGluZ3MucGxpc3QnKSk7XG4gICAgICAgIHBhdGhzLnB1c2gocGF0aC5yZXNvbHZlKHNpbURpcmVjdG9yeSwgJ0xpYnJhcnknLCAnQ29uZmlndXJhdGlvblByb2ZpbGVzJywgJ0VmZmVjdGl2ZVVzZXJTZXR0aW5ncy5wbGlzdCcpKTtcbiAgICAgICAgcGF0aHMucHVzaChwYXRoLnJlc29sdmUoc2ltRGlyZWN0b3J5LCAnTGlicmFyeScsICdDb25maWd1cmF0aW9uUHJvZmlsZXMnLCAnUHVibGljSW5mbycsICdQdWJsaWNFZmZlY3RpdmVVc2VyU2V0dGluZ3MucGxpc3QnKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ1VzZXJDb25maWd1cmF0aW9uUHJvZmlsZXMnLCAnVXNlclNldHRpbmdzLnBsaXN0JykpO1xuICAgICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ1VzZXJDb25maWd1cmF0aW9uUHJvZmlsZXMnLCAnRWZmZWN0aXZlVXNlclNldHRpbmdzLnBsaXN0JykpO1xuICAgICAgICBwYXRocy5wdXNoKHBhdGgucmVzb2x2ZShzaW1EaXJlY3RvcnksICdMaWJyYXJ5JywgJ1VzZXJDb25maWd1cmF0aW9uUHJvZmlsZXMnLCAnUHVibGljSW5mbycsICdQdWJsaWNFZmZlY3RpdmVVc2VyU2V0dGluZ3MucGxpc3QnKSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdlZmZlY3RpdmVVc2VyU2V0dGluZ3MnOlxuICAgICAgcGF0aHMucHVzaChwYXRoLnJlc29sdmUoc2ltRGlyZWN0b3J5LCAnTGlicmFyeScsICdDb25maWd1cmF0aW9uUHJvZmlsZXMnLCAnRWZmZWN0aXZlVXNlclNldHRpbmdzLnBsaXN0JykpO1xuICAgICAgcGF0aHMucHVzaChwYXRoLnJlc29sdmUoc2ltRGlyZWN0b3J5LCAnTGlicmFyeScsICdDb25maWd1cmF0aW9uUHJvZmlsZXMnLCAnUHVibGljSW5mbycsICdQdWJsaWNFZmZlY3RpdmVVc2VyU2V0dGluZ3MucGxpc3QnKSk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdhY2Nlc3NpYmlsaXR5U2V0dGluZ3MnOlxuICAgICAgcGF0aHMucHVzaChwYXRoLnJlc29sdmUoc2ltRGlyZWN0b3J5LCAnTGlicmFyeScsICdQcmVmZXJlbmNlcycsICdjb20uYXBwbGUuQWNjZXNzaWJpbGl0eS5wbGlzdCcpKTtcbiAgICAgIGJyZWFrO1xuICB9XG5cbiAgcmV0dXJuIHBhdGhzO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVTZXR0aW5ncyAoc2ltLCBwbGlzdCwgdXBkYXRlcykge1xuICByZXR1cm4gYXdhaXQgQi5yZWR1Y2UoYXdhaXQgcGxpc3RQYXRocyhzaW0sIHBsaXN0KSwgYXN5bmMgZnVuY3Rpb24gcmVkdWNlciAodXBkYXRlZCwgcGF0aCkge1xuICAgIHJldHVybiBhd2FpdCB1cGRhdGUocGF0aCwgdXBkYXRlcykgfHwgdXBkYXRlZDtcbiAgfSwgZmFsc2UpO1xufVxuXG4vLyB1cGRhdGUgYSBwbGlzdCBmaWxlLCBsb2NhdGVkIGF0IHBhdGhUb1BsaXN0XG4vLyBwYXNzIGluIGFuIG9iamVjdCwgYWxsIHNldHRpbmdzIHNwZWNpZmllZCBpbiB0aGUgb2JqZWN0IHdpbGwgYmVcbi8vIHVwZGF0ZWQgb24gdGhlIHBsaXN0LCBhbGwgb3RoZXJzIGxlZnQgYXMtaXNcbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZSAocGF0aFRvUGxpc3QsIHVwZGF0ZXMpIHtcbiAgY29uc3QgY3VycmVudFNldHRpbmdzID0gYXdhaXQgcmVhZChwYXRoVG9QbGlzdCk7XG4gIGNvbnN0IG5ld1NldHRpbmdzID0gT2JqZWN0LmFzc2lnbih7fSwgY3VycmVudFNldHRpbmdzLCB1cGRhdGVzKTtcblxuICBpZiAoXy5pc0VxdWFsKGN1cnJlbnRTZXR0aW5ncywgbmV3U2V0dGluZ3MpKSB7XG4gICAgLy8gbm8gc2V0dGluZyBjaGFuZ2VzLCBzbyBkbyBub3RoaW5nXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgYXdhaXQgcGxpc3QudXBkYXRlUGxpc3RGaWxlKHBhdGhUb1BsaXN0LCBuZXdTZXR0aW5ncywgdHJ1ZSwgZmFsc2UpO1xuICByZXR1cm4gdHJ1ZTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVhZFNldHRpbmdzIChzaW0sIHBsaXN0KSB7XG4gIGxldCBzZXR0aW5ncyA9IHt9O1xuICBmb3IgKGxldCBwYXRoIG9mIGF3YWl0IHBsaXN0UGF0aHMoc2ltLCBwbGlzdCkpIHtcbiAgICBzZXR0aW5nc1twYXRoXSA9IGF3YWl0IHJlYWQocGF0aCk7XG4gIH1cbiAgcmV0dXJuIHNldHRpbmdzO1xufVxuXG5hc3luYyBmdW5jdGlvbiByZWFkIChwYXRoVG9QbGlzdCkge1xuICByZXR1cm4gYXdhaXQgcGxpc3QucGFyc2VQbGlzdEZpbGUocGF0aFRvUGxpc3QsIGZhbHNlKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlTG9jYXRpb25TZXR0aW5ncyAoc2ltLCBidW5kbGVJZCwgYXV0aG9yaXplZCkge1xuICAvLyB1cGRhdGUgbG9jYXRpb24gY2FjaGVcbiAgY29uc3QgbmV3Q2FjaGVQcmVmcyA9IHtcbiAgICBMYXN0RmVuY2VBY3Rpdml0eVRpbWVzdGFtcDogNDEyMTIyMTAzLjIzMjk4MyxcbiAgICBDbGVhblNodXRkb3duOiB0cnVlXG4gIH07XG4gIGxldCB1cGRhdGVkID0gYXdhaXQgdXBkYXRlU2V0dGluZ3Moc2ltLCAnbG9jYXRpb25DYWNoZScsIHtbYnVuZGxlSWRdOiBuZXdDYWNoZVByZWZzfSk7XG5cbiAgLy8gdXBkYXRlIGxvY2F0aW9uIGNsaWVudHNcbiAgY29uc3QgbmV3Q2xpZW50UHJlZnMgPSB7XG4gICAgQnVuZGxlSWQ6IGJ1bmRsZUlkLFxuICAgIEF1dGhvcml6ZWQ6ICEhYXV0aG9yaXplZCxcbiAgICBXaGl0ZWxpc3RlZDogZmFsc2UsXG4gIH07XG4gIGZvciAoY29uc3QgZmlsZSBvZiBhd2FpdCBwbGlzdFBhdGhzKHNpbSwgJ2xvY2F0aW9uQ2xpZW50cycpKSB7XG4gICAgbG9nLmRlYnVnKGBVcGRhdGluZyBsb2NhdGlvbiBjbGllbnQgZmlsZTogJHtmaWxlfWApO1xuXG4gICAgbGV0IHVwZGF0ZXMgPSB7fTtcblxuICAgIC8vIHNlZSBpZiB0aGUgYnVuZGxlIGlzIGFscmVhZHkgdGhlcmVcbiAgICBjb25zdCBwbGlzdCA9IGF3YWl0IHJlYWQoZmlsZSk7XG5cbiAgICAvLyByYW5kb20gZGF0YSB0aGF0IGFsd2F5cyBzZWVtcyB0byBiZSBpbiB0aGUgY2xpZW50cy5wbGlzdFxuICAgIGNvbnN0IHdlaXJkTG9jS2V5ID0gJ2NvbS5hcHBsZS5sb2NhdGlvbmQuYnVuZGxlLS9TeXN0ZW0vTGlicmFyeS8nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICdQcml2YXRlRnJhbWV3b3Jrcy9BT1NOb3RpZmljYXRpb24uZnJhbWV3b3JrJztcbiAgICBpZiAoIV8uaGFzKHBsaXN0LCB3ZWlyZExvY0tleSkpIHtcbiAgICAgIHVwZGF0ZXNbd2VpcmRMb2NLZXldID0ge1xuICAgICAgICBCdW5kbGVQYXRoOiAnL1N5c3RlbS9MaWJyYXJ5L1ByaXZhdGVGcmFtZXdvcmtzL0FPU05vdGlmaWNhdGlvbi5mcmFtZXdvcmsnLFxuICAgICAgICBXaGl0ZWxpc3RlZDogZmFsc2UsXG4gICAgICAgIEV4ZWN1dGFibGU6ICcnLFxuICAgICAgICBSZWdpc3RlcmVkOiAnJ1xuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBjcmVhdGUgdGhlIHVwZGF0ZSwgYW5kIG1ha2Ugc3VyZSBpdCBoYXMgc2Vuc2libGUgdmFsdWVzXG4gICAgY29uc3QgYmFzZVNldHRpbmcgPSBfLmhhcyhwbGlzdCwgYnVuZGxlSWQpID8gcGxpc3RbYnVuZGxlSWRdIDoge307XG4gICAgdXBkYXRlc1tidW5kbGVJZF0gPSBfLmRlZmF1bHRzKG5ld0NsaWVudFByZWZzLCBiYXNlU2V0dGluZyk7XG4gICAgdXBkYXRlc1tidW5kbGVJZF0uRXhlY3V0YWJsZSA9IHVwZGF0ZXNbYnVuZGxlSWRdLkV4ZWN1dGFibGUgfHwgJyc7XG4gICAgdXBkYXRlc1tidW5kbGVJZF0uUmVnaXN0ZXJlZCA9IHVwZGF0ZXNbYnVuZGxlSWRdLlJlZ2lzdGVyZWQgfHwgJyc7XG5cbiAgICB1cGRhdGVkID0gYXdhaXQgdXBkYXRlKGZpbGUsIHVwZGF0ZXMpIHx8IHVwZGF0ZWQ7XG4gIH1cblxuICByZXR1cm4gdXBkYXRlZDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0UmVkdWNlTW90aW9uIChzaW0sIHJlZHVjZU1vdGlvbiA9IHRydWUpIHtcbiAgbGV0IHBhdGhzID0gYXdhaXQgcGxpc3RQYXRocyhzaW0sICdhY2Nlc3NpYmlsaXR5U2V0dGluZ3MnKTtcbiAgZm9yIChsZXQgZmlsZSBvZiBwYXRocykge1xuICAgIGF3YWl0IHVwZGF0ZShmaWxlLCB7XG4gICAgICBSZWR1Y2VNb3Rpb25FbmFibGVkOiByZWR1Y2VNb3Rpb24gPyAxIDogMFxuICAgIH0pO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVNhZmFyaVVzZXJTZXR0aW5ncyAoc2ltLCBzZXR0aW5nU2V0KSB7XG4gIGxvZy5kZWJ1ZygnVXBkYXRpbmcgU2FmYXJpIHVzZXIgc2V0dGluZ3MnKTtcblxuICAvLyBhZGQgZXh0cmEgc3R1ZmYgdG8gVXNlclNldHRpbmdzLnBsaXN0IGFuZCBFZmZlY3RpdmVVc2VyU2V0dGluZ3MucGxpc3RcbiAgbGV0IG5ld1VzZXJTZXR0aW5ncyA9IHt9O1xuICBpZiAoXy5oYXMoc2V0dGluZ1NldCwgJ1dlYktpdEphdmFTY3JpcHRFbmFibGVkJykpIHtcbiAgICBuZXdVc2VyU2V0dGluZ3Muc2FmYXJpQWxsb3dKYXZhU2NyaXB0ID0gc2V0dGluZ1NldC5XZWJLaXRKYXZhU2NyaXB0RW5hYmxlZDtcbiAgfVxuICBpZiAoXy5oYXMoc2V0dGluZ1NldCwgJ1dlYktpdEphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHknKSkge1xuICAgIG5ld1VzZXJTZXR0aW5ncy5zYWZhcmlBbGxvd1BvcHVwcyA9IHNldHRpbmdTZXQuV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseTtcbiAgfVxuICBpZiAoXy5oYXMoc2V0dGluZ1NldCwgJ1dhcm5BYm91dEZyYXVkdWxlbnRXZWJzaXRlcycpKSB7XG4gICAgbmV3VXNlclNldHRpbmdzLnNhZmFyaUZvcmNlRnJhdWRXYXJuaW5nID0gIXNldHRpbmdTZXQuV2FybkFib3V0RnJhdWR1bGVudFdlYnNpdGVzO1xuICB9XG5cbiAgaWYgKF8uaXNFbXB0eShuZXdVc2VyU2V0dGluZ3MpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgbGV0IHVwZGF0ZWQgPSBmYWxzZTtcbiAgZm9yIChjb25zdCBbZmlsZSwgdXNlclNldHRpbmdTZXRdIG9mIF8udG9QYWlycyhhd2FpdCByZWFkU2V0dGluZ3Moc2ltLCAndXNlclNldHRpbmdzJykpKSB7XG4gICAgLy8gdGhlIHVzZXIgc2V0dGluZ3MgcGxpc3QgaGFzIHR3byBidWNrZXRzLCBvbmUgZm9yXG4gICAgLy8gYm9vbGVhbiBzZXR0aW5ncyAoYHJlc3RyaWN0ZWRCb29sYCkgYW5kIG9uZSBmb3JcbiAgICAvLyBvdGhlciB2YWx1ZSBzZXR0aW5ncyAoYHJlc3RyaWN0ZWRWYWx1ZWApLiBJbiBlYWNoLCB0aGUgdmFsdWVcbiAgICAvLyBpcyBpbiBhIGB2YWx1ZWAgc3ViLWZpZWxkLlxuICAgIGlmICghXy5oYXModXNlclNldHRpbmdTZXQsICdyZXN0cmljdGVkQm9vbCcpKSB7XG4gICAgICB1c2VyU2V0dGluZ1NldC5yZXN0cmljdGVkQm9vbCA9IHt9O1xuICAgIH1cbiAgICBmb3IgKGxldCBba2V5LCB2YWx1ZV0gb2YgXy50b1BhaXJzKG5ld1VzZXJTZXR0aW5ncykpIHtcbiAgICAgIHVzZXJTZXR0aW5nU2V0LnJlc3RyaWN0ZWRCb29sW2tleV0gPSB7dmFsdWV9O1xuICAgIH1cblxuICAgIC8vIGFjdHVhbGx5IGRvIHRoZSB1cGRhdGVcbiAgICB1cGRhdGVkID0gYXdhaXQgdXBkYXRlKGZpbGUsIHVzZXJTZXR0aW5nU2V0KSB8fCB1cGRhdGVkO1xuICB9XG5cbiAgcmV0dXJuIHVwZGF0ZWQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUxvY2FsZSAoc2ltLCBsYW5ndWFnZSwgbG9jYWxlLCBjYWxlbmRhckZvcm1hdCkge1xuICBsZXQgZ2xvYmFsUHJlZnMgPSBwYXRoLnJlc29sdmUoc2ltLmdldERpcigpLCAnTGlicmFyeScsICdQcmVmZXJlbmNlcycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLkdsb2JhbFByZWZlcmVuY2VzLnBsaXN0Jyk7XG5cbiAgLy8gZ2V0IHRoZSBjdXJyZW50IGRhdGFcbiAgbGV0IGRhdGEgPSBhd2FpdCByZWFkKGdsb2JhbFByZWZzKTtcbiAgbGV0IHVwZGF0ZXMgPSB7fTtcblxuICAvLyBpZiB3ZSBhcmUgc2V0dGluZyB0aGUgbGFuZ3VhZ2UsIGFkZCBpdCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBsaXN0IG9mIGxhbmd1YWdlc1xuICBpZiAobGFuZ3VhZ2UpIHtcbiAgICBsb2cuZGVidWcoYE5ldyBsYW5ndWFnZTogJHtsYW5ndWFnZX1gKTtcbiAgICBsZXQgc3VwcG9ydGVkTGFuZ3MgPSBkYXRhLkFwcGxlTGFuZ3VhZ2VzIHx8IFtdO1xuICAgIC8vIGlmIHRoZSBsYW5ndWFnZSBpcyBmaXJzdCwgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZ1xuICAgIGlmIChzdXBwb3J0ZWRMYW5ncy5pbmRleE9mKGxhbmd1YWdlKSAhPT0gMCkge1xuICAgICAgdXBkYXRlcy5BcHBsZUxhbmd1YWdlcyA9IFtsYW5ndWFnZV0uY29uY2F0KF8ud2l0aG91dChzdXBwb3J0ZWRMYW5ncywgbGFuZ3VhZ2UpKTtcbiAgICB9XG4gIH1cbiAgLy8gaWYgd2UgYXJlIHNldHRpbmcgdGhlIGxvY2FsZSBvciBjYWxlbmRhciBmb3JtYXQsIHNldCB0aGVtIGFzIGFwcHJvcHJpYXRlXG4gIGlmIChsb2NhbGUgfHwgY2FsZW5kYXJGb3JtYXQpIHtcbiAgICBsZXQgY2FsU3BsaXQgPSAnQGNhbGVuZGFyPSc7XG4gICAgbGV0IGN1ckxvY2FsZUFuZENhbCA9IGRhdGEuQXBwbGVMb2NhbGUgfHwgbGFuZ3VhZ2UgfHwgJ2VuJztcblxuICAgIGxldCBzcGxpdCA9IGN1ckxvY2FsZUFuZENhbC5zcGxpdChjYWxTcGxpdCk7XG4gICAgbGV0IGN1ckxvYyA9IHNwbGl0WzBdO1xuICAgIGlmIChjYWxlbmRhckZvcm1hdCB8fCBzcGxpdFsxXSkge1xuICAgICAgY2FsZW5kYXJGb3JtYXQgPSBgJHtjYWxTcGxpdH0ke2NhbGVuZGFyRm9ybWF0IHx8IHNwbGl0WzFdIHx8ICcnfWA7XG4gICAgfVxuICAgIGNhbGVuZGFyRm9ybWF0ID0gY2FsZW5kYXJGb3JtYXQgfHwgJyc7XG4gICAgbGV0IG5ld0xvY2FsZUFuZENhbCA9IGxvY2FsZSA/IGxvY2FsZSA6IGN1ckxvYztcbiAgICBpZiAoY2FsZW5kYXJGb3JtYXQpIHtcbiAgICAgIG5ld0xvY2FsZUFuZENhbCA9IGAke25ld0xvY2FsZUFuZENhbH0ke2NhbGVuZGFyRm9ybWF0fWA7XG4gICAgfVxuICAgIC8vIG9ubHkgbmVlZCB0byB1cGRhdGUgaWYgaXQgaGFzIGNoYW5nZWRcbiAgICBpZiAobmV3TG9jYWxlQW5kQ2FsICE9PSBjdXJMb2NhbGVBbmRDYWwpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgTmV3IGxvY2FsZTogJHtuZXdMb2NhbGVBbmRDYWx9YCk7XG4gICAgICB1cGRhdGVzLkFwcGxlTG9jYWxlID0gbmV3TG9jYWxlQW5kQ2FsO1xuICAgIH1cbiAgfVxuXG4gIGlmIChfLnNpemUodXBkYXRlcykgPT09IDApIHtcbiAgICBsb2cuZGVidWcoJ05vIGxvY2FsZSB1cGRhdGVzIG5lY2Vzc2FyeS4nKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBsb2cuZGVidWcoJ1dyaXRpbmcgbmV3IGxvY2FsZSBwbGlzdCBkYXRhJyk7XG4gIGF3YWl0IHVwZGF0ZShnbG9iYWxQcmVmcywgdXBkYXRlcyk7XG4gIHJldHVybiB0cnVlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdHViICgpIHtcbiAgcmV0dXJuIGF3YWl0IHBsaXN0UGF0aHM7XG59XG5cbmV4cG9ydCB7IHVwZGF0ZSwgdXBkYXRlU2V0dGluZ3MsIHVwZGF0ZUxvY2F0aW9uU2V0dGluZ3MsIHNldFJlZHVjZU1vdGlvbixcbiAgICAgICAgdXBkYXRlU2FmYXJpVXNlclNldHRpbmdzLCB1cGRhdGVMb2NhbGUsIHJlYWQsIHJlYWRTZXR0aW5ncywgc3R1YiB9O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
