'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var RpcMessageHandler = (function () {
  function RpcMessageHandler(specialHandlers) {
    _classCallCheck(this, RpcMessageHandler);

    this.setHandlers();
    this.errorHandlers = {};
    this.specialHandlers = _lodash2['default'].clone(specialHandlers);
    this.dataHandlers = {};
    this.willNavigateWithoutReload = false;
  }

  _createClass(RpcMessageHandler, [{
    key: 'setDataMessageHandler',
    value: function setDataMessageHandler(key, errorHandler, handler) {
      this.errorHandlers[key] = errorHandler;
      this.dataHandlers[key] = handler;
    }
  }, {
    key: 'setSpecialMessageHandler',
    value: function setSpecialMessageHandler(key, errorHandler, handler) {
      this.errorHandlers[key] = errorHandler;
      this.specialHandlers[key] = handler;
    }
  }, {
    key: 'getSpecialMessageHandler',
    value: function getSpecialMessageHandler(key) {
      return this.specialHandlers[key];
    }
  }, {
    key: 'setTimelineEventHandler',
    value: function setTimelineEventHandler(timelineEventHandler) {
      this.timelineEventHandler = timelineEventHandler;
    }
  }, {
    key: 'setConsoleLogEventHandler',
    value: function setConsoleLogEventHandler(consoleLogEventHandler) {
      this.consoleLogEventHandler = consoleLogEventHandler;
    }
  }, {
    key: 'setNetworkEventHandler',
    value: function setNetworkEventHandler(networkLogEventHandler) {
      this.networkLogEventHandler = networkLogEventHandler;
    }
  }, {
    key: 'hasErrorHandler',
    value: function hasErrorHandler(key) {
      return _lodash2['default'].has(this.errorHandlers, key);
    }
  }, {
    key: 'hasSpecialMessageHandler',
    value: function hasSpecialMessageHandler(key) {
      return _lodash2['default'].has(this.specialHandlers, key);
    }
  }, {
    key: 'allowNavigationWithoutReload',
    value: function allowNavigationWithoutReload() {
      var allow = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];

      this.willNavigateWithoutReload = allow;
    }
  }, {
    key: 'handleMessage',
    value: function handleMessage(plist) {
      var handlerFor = plist.__selector;
      if (!handlerFor) {
        _logger2['default'].debug('Got an invalid plist');
        return;
      }

      if (_lodash2['default'].has(this.handlers, handlerFor)) {
        this.handlers[handlerFor](plist);
      } else {
        _logger2['default'].debug('Debugger got a message for \'' + handlerFor + '\' and have no ' + 'handler, doing nothing.');
      }
    }
  }, {
    key: 'handleSpecialMessage',
    value: function handleSpecialMessage(handler) {
      var fn = this.specialHandlers[handler];

      if (fn) {
        // most responses are only to be called once, then
        // removed. But not the ones below, which handle
        // page change and app connect/disconnect
        if (handler !== '_rpc_forwardGetListing:' && handler !== '_rpc_applicationDisconnected:' && handler !== '_rpc_applicationConnected:' && handler !== '_rpc_applicationUpdated:' && handler !== '_rpc_reportConnectedDriverList:') {
          this.specialHandlers[handler] = null;
        }

        for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
          args[_key - 1] = arguments[_key];
        }

        fn.apply(undefined, args);
      } else {
        _logger2['default'].warn('Tried to access special message handler \'' + handler + '\' ' + 'but none was found');
      }
    }
  }, {
    key: 'parseDataKey',
    value: function parseDataKey(plist) {
      try {
        return JSON.parse(plist.__argument.WIRMessageDataKey.toString('utf8'));
      } catch (err) {
        _logger2['default'].error('Unparseable message data: ' + _lodash2['default'].truncate(JSON.stringify(plist), { length: 100 }));
        throw new Error('Unable to parse message data: ' + err.message);
      }
    }
  }, {
    key: 'handleDataMessage',
    value: function handleDataMessage(plist) {
      var dataKey, msgId, result, error, message;
      return _regeneratorRuntime.async(function handleDataMessage$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            dataKey = this.parseDataKey(plist);
            msgId = (dataKey.id || '').toString();
            result = dataKey.result;
            error = dataKey.error || null;

            // we can get an error, or we can get a response that is an error
            if (result && result.wasThrown) {
              message = result.result && (result.result.value || result.result.description) ? result.result.value || result.result.description : 'Error occurred in handling data message';

              error = new Error(message);
            }

            if (!error) {
              context$2$0.next = 8;
              break;
            }

            if (this.hasErrorHandler(msgId)) {
              this.errorHandlers[msgId](error);
            } else {
              _logger2['default'].error('Error occurred in handling data message: ' + error);
              _logger2['default'].error('No error handler present, ignoring');
            }

            // short circuit
            return context$2$0.abrupt('return');

          case 8:
            if (!(dataKey.method === 'Profiler.resetProfiles')) {
              context$2$0.next = 12;
              break;
            }

            _logger2['default'].debug('Device is telling us to reset profiles. Should probably ' + 'do some kind of callback here');
            context$2$0.next = 27;
            break;

          case 12:
            if (!(dataKey.method === 'Page.frameNavigated')) {
              context$2$0.next = 16;
              break;
            }

            if (!this.willNavigateWithoutReload && !this.pageLoading) {
              _logger2['default'].debug('Frame navigated, unloading page');
              if (_lodash2['default'].isFunction(this.specialHandlers['Page.frameNavigated'])) {
                this.specialHandlers['Page.frameNavigated']('remote-debugger');
                this.specialHandlers['Page.frameNavigated'] = null;
              }
            } else {
              _logger2['default'].debug('Frame navigated but we were warned about it, not ' + 'considering page state unloaded');
              this.willNavigateWithoutReload = false;
            }
            context$2$0.next = 27;
            break;

          case 16:
            if (!(dataKey.method === 'Page.loadEventFired' && _lodash2['default'].isFunction(this.specialHandlers.pageLoad))) {
              context$2$0.next = 21;
              break;
            }

            context$2$0.next = 19;
            return _regeneratorRuntime.awrap(this.specialHandlers.pageLoad());

          case 19:
            context$2$0.next = 27;
            break;

          case 21:
            if (!(dataKey.method === 'Page.frameDetached' && _lodash2['default'].isFunction(this.specialHandlers.frameDetached))) {
              context$2$0.next = 26;
              break;
            }

            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(this.specialHandlers.frameDetached());

          case 24:
            context$2$0.next = 27;
            break;

          case 26:
            if (dataKey.method === 'Timeline.eventRecorded' && _lodash2['default'].isFunction(this.timelineEventHandler)) {
              this.timelineEventHandler(dataKey.params.record);
            } else if (dataKey.method === 'Console.messageAdded' && _lodash2['default'].isFunction(this.consoleLogEventHandler)) {
              this.consoleLogEventHandler(dataKey.params.message);
            } else if (dataKey.method && dataKey.method.startsWith('Network.') && _lodash2['default'].isFunction(this.networkLogEventHandler)) {
              this.networkLogEventHandler(dataKey.method, dataKey.params);
            } else if (_lodash2['default'].isFunction(this.dataHandlers[msgId])) {
              _logger2['default'].debug('Found data handler for response');
              // we will either get back a result object that has a result.value
              // in which case that is what we want,
              // or else we return the whole thing
              if (result.result && result.result.value) {
                result = result.result.value;
              }
              this.dataHandlers[msgId](result);
              this.dataHandlers[msgId] = null;
            } else if (this.dataHandlers[msgId] === null) {
              _logger2['default'].error('Debugger returned data for message ' + msgId + ' ' + 'but we already ran that callback! WTF??');
            } else {
              if (msgId || result || error) {
                _logger2['default'].error('Debugger returned data for message \'' + msgId + '\' ' + 'but we were not waiting for that message! ' + ('result: \'' + JSON.stringify(result) + '\'; ') + ('error: \'' + error + '\''));
              }
            }

          case 27:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setHandlers',
    value: function setHandlers() {
      var _this = this;

      this.handlers = {
        '_rpc_reportSetup:': function _rpc_reportSetup(plist) {
          _this.handleSpecialMessage('_rpc_reportIdentifier:', plist.__argument.WIRSimulatorNameKey, plist.__argument.WIRSimulatorBuildKey, plist.__argument.WIRSimulatorProductVersionKey);
        },
        '_rpc_reportConnectedApplicationList:': function _rpc_reportConnectedApplicationList(plist) {
          _this.handleSpecialMessage('_rpc_reportConnectedApplicationList:', plist.__argument.WIRApplicationDictionaryKey);
        },
        '_rpc_applicationSentListing:': function _rpc_applicationSentListing(plist) {
          _this.handleSpecialMessage('_rpc_forwardGetListing:', plist.__argument.WIRApplicationIdentifierKey, plist.__argument.WIRListingKey);
        },
        '_rpc_applicationConnected:': function _rpc_applicationConnected(plist) {
          _this.handleSpecialMessage('_rpc_applicationConnected:', plist.__argument);
        },
        '_rpc_applicationDisconnected:': function _rpc_applicationDisconnected(plist) {
          _this.handleSpecialMessage('_rpc_applicationDisconnected:', plist.__argument);
        },
        '_rpc_applicationUpdated:': function _rpc_applicationUpdated(plist) {
          _this.handleSpecialMessage('_rpc_applicationUpdated:', plist.__argument);
        },
        '_rpc_reportConnectedDriverList:': function _rpc_reportConnectedDriverList(plist) {
          _this.handleSpecialMessage('_rpc_reportConnectedDriverList:', plist.__argument);
        },
        '_rpc_applicationSentData:': this.handleDataMessage.bind(this)
      };
    }
  }]);

  return RpcMessageHandler;
})();

exports['default'] = RpcMessageHandler;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtZGVidWdnZXItbWVzc2FnZS1oYW5kbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O3NCQUFnQixVQUFVOzs7O3NCQUNaLFFBQVE7Ozs7SUFHRCxpQkFBaUI7QUFDeEIsV0FETyxpQkFBaUIsQ0FDdkIsZUFBZSxFQUFFOzBCQURYLGlCQUFpQjs7QUFFbEMsUUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0FBQ25CLFFBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO0FBQ3hCLFFBQUksQ0FBQyxlQUFlLEdBQUcsb0JBQUUsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ2hELFFBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDO0FBQ3ZCLFFBQUksQ0FBQyx5QkFBeUIsR0FBRyxLQUFLLENBQUM7R0FDeEM7O2VBUGtCLGlCQUFpQjs7V0FTZCwrQkFBQyxHQUFHLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRTtBQUNqRCxVQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFlBQVksQ0FBQztBQUN2QyxVQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE9BQU8sQ0FBQztLQUNsQzs7O1dBRXdCLGtDQUFDLEdBQUcsRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFO0FBQ3BELFVBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEdBQUcsWUFBWSxDQUFDO0FBQ3ZDLFVBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEdBQUcsT0FBTyxDQUFDO0tBQ3JDOzs7V0FFd0Isa0NBQUMsR0FBRyxFQUFFO0FBQzdCLGFBQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUNsQzs7O1dBRXVCLGlDQUFDLG9CQUFvQixFQUFFO0FBQzdDLFVBQUksQ0FBQyxvQkFBb0IsR0FBRyxvQkFBb0IsQ0FBQztLQUNsRDs7O1dBRXlCLG1DQUFDLHNCQUFzQixFQUFFO0FBQ2pELFVBQUksQ0FB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LEVBQUUscUNBQUMsS0FBSyxFQUFLO0FBQ3pDLGdCQUFLLG9CQUFvQixDQUFDLHlCQUF5QixFQUMvQyxLQUFLLENBQUMsVUFBVSxDQUFDLDJCQUEyQixFQUM1QyxLQUFLLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQ3JDO0FBQ0Qsb0NBQTRCLEVBQUUsbUNBQUMsS0FBSyxFQUFLO0FBQ3ZDLGdCQUFLLG9CQUFvQixDQUFDLDRCQUE0QixFQUNsRCxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDdkI7QUFDRCx1Q0FBK0IsRUFBRSxzQ0FBQyxLQUFLLEVBQUs7QUFDMUMsZ0JBQUssb0JBQW9CLENBQUMsK0JBQStCLEVBQ3JELEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUN2QjtBQUNELGtDQUEwQixFQUFFLGlDQUFDLEtBQUssRUFBSztBQUNyQyxnQkFBSyxvQkFBb0IsQ0FBQywwQkFBMEIsRUFDaEQsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQ3ZCO0FBQ0QseUNBQWlDLEVBQUUsd0NBQUMsS0FBSyxFQUFLO0FBQzVDLGdCQUFLLG9CQUFvQixDQUFDLGlDQUFpQyxFQUN2RCxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDdkI7QUFDRCxtQ0FBMkIsRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztPQUMvRCxDQUFDO0tBQ0g7OztTQXpNa0IsaUJBQWlCOzs7cUJBQWpCLGlCQUFpQiIsImZpbGUiOiJsaWIvcmVtb3RlLWRlYnVnZ2VyLW1lc3NhZ2UtaGFuZGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBScGNNZXNzYWdlSGFuZGxlciB7XG4gIGNvbnN0cnVjdG9yIChzcGVjaWFsSGFuZGxlcnMpIHtcbiAgICB0aGlzLnNldEhhbmRsZXJzKCk7XG4gICAgdGhpcy5lcnJvckhhbmRsZXJzID0ge307XG4gICAgdGhpcy5zcGVjaWFsSGFuZGxlcnMgPSBfLmNsb25lKHNwZWNpYWxIYW5kbGVycyk7XG4gICAgdGhpcy5kYXRhSGFuZGxlcnMgPSB7fTtcbiAgICB0aGlzLndpbGxOYXZpZ2F0ZVdpdGhvdXRSZWxvYWQgPSBmYWxzZTtcbiAgfVxuXG4gIHNldERhdGFNZXNzYWdlSGFuZGxlciAoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpIHtcbiAgICB0aGlzLmVycm9ySGFuZGxlcnNba2V5XSA9IGVycm9ySGFuZGxlcjtcbiAgICB0aGlzLmRhdGFIYW5kbGVyc1trZXldID0gaGFuZGxlcjtcbiAgfVxuXG4gIHNldFNwZWNpYWxNZXNzYWdlSGFuZGxlciAoa2V5LCBlcnJvckhhbmRsZXIsIGhhbmRsZXIpIHtcbiAgICB0aGlzLmVycm9ySGFuZGxlcnNba2V5XSA9IGVycm9ySGFuZGxlcjtcbiAgICB0aGlzLnNwZWNpYWxIYW5kbGVyc1trZXldID0gaGFuZGxlcjtcbiAgfVxuXG4gIGdldFNwZWNpYWxNZXNzYWdlSGFuZGxlciAoa2V5KSB7XG4gICAgcmV0dXJuIHRoaXMuc3BlY2lhbEhhbmRsZXJzW2tleV07XG4gIH1cblxuICBzZXRUaW1lbGluZUV2ZW50SGFuZGxlciAodGltZWxpbmVFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyID0gdGltZWxpbmVFdmVudEhhbmRsZXI7XG4gIH1cblxuICBzZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyIChjb25zb2xlTG9nRXZlbnRIYW5kbGVyKSB7XG4gICAgdGhpcy5jb25zb2xlTG9nRXZlbnRIYW5kbGVyID0gY29uc29sZUxvZ0V2ZW50SGFuZGxlcjtcbiAgfVxuXG4gIHNldE5ldHdvcmtFdmVudEhhbmRsZXIgKG5ldHdvcmtMb2dFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLm5ldHdvcmtMb2dFdmVudEhhbmRsZXIgPSBuZXR3b3JrTG9nRXZlbnRIYW5kbGVyO1xuICB9XG5cbiAgaGFzRXJyb3JIYW5kbGVyIChrZXkpIHtcbiAgICByZXR1cm4gXy5oYXModGhpcy5lcnJvckhhbmRsZXJzLCBrZXkpO1xuICB9XG5cbiAgaGFzU3BlY2lhbE1lc3NhZ2VIYW5kbGVyIChrZXkpIHtcbiAgICByZXR1cm4gXy5oYXModGhpcy5zcGVjaWFsSGFuZGxlcnMsIGtleSk7XG4gIH1cblxuICBhbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkIChhbGxvdyA9IHRydWUpIHtcbiAgICB0aGlzLndpbGxOYXZpZ2F0ZVdpdGhvdXRSZWxvYWQgPSBhbGxvdztcbiAgfVxuXG4gIGhhbmRsZU1lc3NhZ2UgKHBsaXN0KSB7XG4gICAgbGV0IGhhbmRsZXJGb3IgPSBwbGlzdC5fX3NlbGVjdG9yO1xuICAgIGlmICghaGFuZGxlckZvcikge1xuICAgICAgbG9nLmRlYnVnKCdHb3QgYW4gaW52YWxpZCBwbGlzdCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChfLmhhcyh0aGlzLmhhbmRsZXJzLCBoYW5kbGVyRm9yKSkge1xuICAgICAgdGhpcy5oYW5kbGVyc1toYW5kbGVyRm9yXShwbGlzdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZyhgRGVidWdnZXIgZ290IGEgbWVzc2FnZSBmb3IgJyR7aGFuZGxlckZvcn0nIGFuZCBoYXZlIG5vIGAgK1xuICAgICAgICAgICAgICAgIGBoYW5kbGVyLCBkb2luZyBub3RoaW5nLmApO1xuICAgIH1cbiAgfVxuXG4gIGhhbmRsZVNwZWNpYWxNZXNzYWdlIChoYW5kbGVyLCAuLi5hcmdzKSB7XG4gICAgY29uc3QgZm4gPSB0aGlzLnNwZWNpYWxIYW5kbGVyc1toYW5kbGVyXTtcblxuICAgIGlmIChmbikge1xuICAgICAgLy8gbW9zdCByZXNwb25zZXMgYXJlIG9ubHkgdG8gYmUgY2FsbGVkIG9uY2UsIHRoZW5cbiAgICAgIC8vIHJlbW92ZWQuIEJ1dCBub3QgdGhlIG9uZXMgYmVsb3csIHdoaWNoIGhhbmRsZVxuICAgICAgLy8gcGFnZSBjaGFuZ2UgYW5kIGFwcCBjb25uZWN0L2Rpc2Nvbm5lY3RcbiAgICAgIGlmIChoYW5kbGVyICE9PSAnX3JwY19mb3J3YXJkR2V0TGlzdGluZzonICYmXG4gICAgICAgICAgaGFuZGxlciAhPT0gJ19ycGNfYXBwbGljYXRpb25EaXNjb25uZWN0ZWQ6JyAmJlxuICAgICAgICAgIGhhbmRsZXIgIT09ICdfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOicgJiZcbiAgICAgICAgICBoYW5kbGVyICE9PSAnX3JwY19hcHBsaWNhdGlvblVwZGF0ZWQ6JyAmJlxuICAgICAgICAgIGhhbmRsZXIgIT09ICdfcnBjX3JlcG9ydENvbm5lY3RlZERyaXZlckxpc3Q6Jykge1xuICAgICAgICB0aGlzLnNwZWNpYWxIYW5kbGVyc1toYW5kbGVyXSA9IG51bGw7XG4gICAgICB9XG4gICAgICBmbiguLi5hcmdzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLndhcm4oYFRyaWVkIHRvIGFjY2VzcyBzcGVjaWFsIG1lc3NhZ2UgaGFuZGxlciAnJHtoYW5kbGVyfScgYCArXG4gICAgICAgICAgICAgICBgYnV0IG5vbmUgd2FzIGZvdW5kYCk7XG4gICAgfVxuICB9XG5cbiAgcGFyc2VEYXRhS2V5IChwbGlzdCkge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShwbGlzdC5fX2FyZ3VtZW50LldJUk1lc3NhZ2VEYXRhS2V5LnRvU3RyaW5nKCd1dGY4JykpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yKGBVbnBhcnNlYWJsZSBtZXNzYWdlIGRhdGE6ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShwbGlzdCksIHtsZW5ndGg6IDEwMH0pfWApO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gcGFyc2UgbWVzc2FnZSBkYXRhOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGhhbmRsZURhdGFNZXNzYWdlIChwbGlzdCkge1xuICAgIGNvbnN0IGRhdGFLZXkgPSB0aGlzLnBhcnNlRGF0YUtleShwbGlzdCk7XG4gICAgY29uc3QgbXNnSWQgPSAoZGF0YUtleS5pZCB8fCAnJykudG9TdHJpbmcoKTtcbiAgICBsZXQgcmVzdWx0ID0gZGF0YUtleS5yZXN1bHQ7XG4gICAgbGV0IGVycm9yID0gZGF0YUtleS5lcnJvciB8fCBudWxsO1xuXG4gICAgLy8gd2UgY2FuIGdldCBhbiBlcnJvciwgb3Igd2UgY2FuIGdldCBhIHJlc3BvbnNlIHRoYXQgaXMgYW4gZXJyb3JcbiAgICBpZiAocmVzdWx0ICYmIHJlc3VsdC53YXNUaHJvd24pIHtcbiAgICAgIGxldCBtZXNzYWdlID0gKHJlc3VsdC5yZXN1bHQgJiYgKHJlc3VsdC5yZXN1bHQudmFsdWUgfHwgcmVzdWx0LnJlc3VsdC5kZXNjcmlwdGlvbikpID9cbiAgICAgICAgICAgICAgICAgICAgKHJlc3VsdC5yZXN1bHQudmFsdWUgfHwgcmVzdWx0LnJlc3VsdC5kZXNjcmlwdGlvbikgOlxuICAgICAgICAgICAgICAgICAgICAnRXJyb3Igb2NjdXJyZWQgaW4gaGFuZGxpbmcgZGF0YSBtZXNzYWdlJztcbiAgICAgIGVycm9yID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIGlmIChlcnJvcikge1xuICAgICAgaWYgKHRoaXMuaGFzRXJyb3JIYW5kbGVyKG1zZ0lkKSkge1xuICAgICAgICB0aGlzLmVycm9ySGFuZGxlcnNbbXNnSWRdKGVycm9yKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5lcnJvcihgRXJyb3Igb2NjdXJyZWQgaW4gaGFuZGxpbmcgZGF0YSBtZXNzYWdlOiAke2Vycm9yfWApO1xuICAgICAgICBsb2cuZXJyb3IoJ05vIGVycm9yIGhhbmRsZXIgcHJlc2VudCwgaWdub3JpbmcnKTtcbiAgICAgIH1cblxuICAgICAgLy8gc2hvcnQgY2lyY3VpdFxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChkYXRhS2V5Lm1ldGhvZCA9PT0gJ1Byb2ZpbGVyLnJlc2V0UHJvZmlsZXMnKSB7XG4gICAgICBsb2cuZGVidWcoJ0RldmljZSBpcyB0ZWxsaW5nIHVzIHRvIHJlc2V0IHByb2ZpbGVzLiBTaG91bGQgcHJvYmFibHkgJyArXG4gICAgICAgICAgICAgICAgJ2RvIHNvbWUga2luZCBvZiBjYWxsYmFjayBoZXJlJyk7XG4gICAgfSBlbHNlIGlmIChkYXRhS2V5Lm1ldGhvZCA9PT0gJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnKSB7XG4gICAgICBpZiAoIXRoaXMud2lsbE5hdmlnYXRlV2l0aG91dFJlbG9hZCAmJiAhdGhpcy5wYWdlTG9hZGluZykge1xuICAgICAgICBsb2cuZGVidWcoJ0ZyYW1lIG5hdmlnYXRlZCwgdW5sb2FkaW5nIHBhZ2UnKTtcbiAgICAgICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLnNwZWNpYWxIYW5kbGVyc1snUGFnZS5mcmFtZU5hdmlnYXRlZCddKSkge1xuICAgICAgICAgIHRoaXMuc3BlY2lhbEhhbmRsZXJzWydQYWdlLmZyYW1lTmF2aWdhdGVkJ10oJ3JlbW90ZS1kZWJ1Z2dlcicpO1xuICAgICAgICAgIHRoaXMuc3BlY2lhbEhhbmRsZXJzWydQYWdlLmZyYW1lTmF2aWdhdGVkJ10gPSBudWxsO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoJ0ZyYW1lIG5hdmlnYXRlZCBidXQgd2Ugd2VyZSB3YXJuZWQgYWJvdXQgaXQsIG5vdCAnICtcbiAgICAgICAgICAgICAgICAgICdjb25zaWRlcmluZyBwYWdlIHN0YXRlIHVubG9hZGVkJyk7XG4gICAgICAgIHRoaXMud2lsbE5hdmlnYXRlV2l0aG91dFJlbG9hZCA9IGZhbHNlO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZGF0YUtleS5tZXRob2QgPT09ICdQYWdlLmxvYWRFdmVudEZpcmVkJyAmJiBfLmlzRnVuY3Rpb24odGhpcy5zcGVjaWFsSGFuZGxlcnMucGFnZUxvYWQpKSB7XG4gICAgICBhd2FpdCB0aGlzLnNwZWNpYWxIYW5kbGVycy5wYWdlTG9hZCgpO1xuICAgIH0gZWxzZSBpZiAoZGF0YUtleS5tZXRob2QgPT09ICdQYWdlLmZyYW1lRGV0YWNoZWQnICYmIF8uaXNGdW5jdGlvbih0aGlzLnNwZWNpYWxIYW5kbGVycy5mcmFtZURldGFjaGVkKSkge1xuICAgICAgYXdhaXQgdGhpcy5zcGVjaWFsSGFuZGxlcnMuZnJhbWVEZXRhY2hlZCgpO1xuICAgIH0gZWxzZSBpZiAoZGF0YUtleS5tZXRob2QgPT09ICdUaW1lbGluZS5ldmVudFJlY29yZGVkJyAmJiBfLmlzRnVuY3Rpb24odGhpcy50aW1lbGluZUV2ZW50SGFuZGxlcikpIHtcbiAgICAgIHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIoZGF0YUtleS5wYXJhbXMucmVjb3JkKTtcbiAgICB9IGVsc2UgaWYgKGRhdGFLZXkubWV0aG9kID09PSAnQ29uc29sZS5tZXNzYWdlQWRkZWQnICYmIF8uaXNGdW5jdGlvbih0aGlzLmNvbnNvbGVMb2dFdmVudEhhbmRsZXIpKSB7XG4gICAgICB0aGlzLmNvbnNvbGVMb2dFdmVudEhhbmRsZXIoZGF0YUtleS5wYXJhbXMubWVzc2FnZSk7XG4gICAgfSBlbHNlIGlmIChkYXRhS2V5Lm1ldGhvZCAmJiBkYXRhS2V5Lm1ldGhvZC5zdGFydHNXaXRoKCdOZXR3b3JrLicpICYmIF8uaXNGdW5jdGlvbih0aGlzLm5ldHdvcmtMb2dFdmVudEhhbmRsZXIpKSB7XG4gICAgICB0aGlzLm5ldHdvcmtMb2dFdmVudEhhbmRsZXIoZGF0YUtleS5tZXRob2QsIGRhdGFLZXkucGFyYW1zKTtcbiAgICB9IGVsc2UgaWYgKF8uaXNGdW5jdGlvbih0aGlzLmRhdGFIYW5kbGVyc1ttc2dJZF0pKSB7XG4gICAgICBsb2cuZGVidWcoJ0ZvdW5kIGRhdGEgaGFuZGxlciBmb3IgcmVzcG9uc2UnKTtcbiAgICAgIC8vIHdlIHdpbGwgZWl0aGVyIGdldCBiYWNrIGEgcmVzdWx0IG9iamVjdCB0aGF0IGhhcyBhIHJlc3VsdC52YWx1ZVxuICAgICAgLy8gaW4gd2hpY2ggY2FzZSB0aGF0IGlzIHdoYXQgd2Ugd2FudCxcbiAgICAgIC8vIG9yIGVsc2Ugd2UgcmV0dXJuIHRoZSB3aG9sZSB0aGluZ1xuICAgICAgaWYgKHJlc3VsdC5yZXN1bHQgJiYgcmVzdWx0LnJlc3VsdC52YWx1ZSkge1xuICAgICAgICByZXN1bHQgPSByZXN1bHQucmVzdWx0LnZhbHVlO1xuICAgICAgfVxuICAgICAgdGhpcy5kYXRhSGFuZGxlcnNbbXNnSWRdKHJlc3VsdCk7XG4gICAgICB0aGlzLmRhdGFIYW5kbGVyc1ttc2dJZF0gPSBudWxsO1xuICAgIH0gZWxzZSBpZiAodGhpcy5kYXRhSGFuZGxlcnNbbXNnSWRdID09PSBudWxsKSB7XG4gICAgICBsb2cuZXJyb3IoYERlYnVnZ2VyIHJldHVybmVkIGRhdGEgZm9yIG1lc3NhZ2UgJHttc2dJZH0gYCArXG4gICAgICAgICAgICAgICAgYGJ1dCB3ZSBhbHJlYWR5IHJhbiB0aGF0IGNhbGxiYWNrISBXVEY/P2ApO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAobXNnSWQgfHwgcmVzdWx0IHx8IGVycm9yKSB7XG4gICAgICAgIGxvZy5lcnJvcihgRGVidWdnZXIgcmV0dXJuZWQgZGF0YSBmb3IgbWVzc2FnZSAnJHttc2dJZH0nIGAgK1xuICAgICAgICAgICAgICAgICAgYGJ1dCB3ZSB3ZXJlIG5vdCB3YWl0aW5nIGZvciB0aGF0IG1lc3NhZ2UhIGAgK1xuICAgICAgICAgICAgICAgICAgYHJlc3VsdDogJyR7SlNPTi5zdHJpbmdpZnkocmVzdWx0KX0nOyBgICtcbiAgICAgICAgICAgICAgICAgIGBlcnJvcjogJyR7ZXJyb3J9J2ApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNldEhhbmRsZXJzICgpIHtcbiAgICB0aGlzLmhhbmRsZXJzID0ge1xuICAgICAgJ19ycGNfcmVwb3J0U2V0dXA6JzogKHBsaXN0KSA9PiB7XG4gICAgICAgIHRoaXMuaGFuZGxlU3BlY2lhbE1lc3NhZ2UoJ19ycGNfcmVwb3J0SWRlbnRpZmllcjonLFxuICAgICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJTaW11bGF0b3JOYW1lS2V5LFxuICAgICAgICAgICAgcGxpc3QuX19hcmd1bWVudC5XSVJTaW11bGF0b3JCdWlsZEtleSxcbiAgICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQuV0lSU2ltdWxhdG9yUHJvZHVjdFZlcnNpb25LZXkpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX3JlcG9ydENvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdDonOiAocGxpc3QpID0+IHtcbiAgICAgICAgdGhpcy5oYW5kbGVTcGVjaWFsTWVzc2FnZSgnX3JwY19yZXBvcnRDb25uZWN0ZWRBcHBsaWNhdGlvbkxpc3Q6JyxcbiAgICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQuV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5KTtcbiAgICAgIH0sXG4gICAgICAnX3JwY19hcHBsaWNhdGlvblNlbnRMaXN0aW5nOic6IChwbGlzdCkgPT4ge1xuICAgICAgICB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX2ZvcndhcmRHZXRMaXN0aW5nOicsXG4gICAgICAgICAgICBwbGlzdC5fX2FyZ3VtZW50LldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleSxcbiAgICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQuV0lSTGlzdGluZ0tleSk7XG4gICAgICB9LFxuICAgICAgJ19ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6JzogKHBsaXN0KSA9PiB7XG4gICAgICAgIHRoaXMuaGFuZGxlU3BlY2lhbE1lc3NhZ2UoJ19ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6JyxcbiAgICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOic6IChwbGlzdCkgPT4ge1xuICAgICAgICB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOicsXG4gICAgICAgICAgICBwbGlzdC5fX2FyZ3VtZW50KTtcbiAgICAgIH0sXG4gICAgICAnX3JwY19hcHBsaWNhdGlvblVwZGF0ZWQ6JzogKHBsaXN0KSA9PiB7XG4gICAgICAgIHRoaXMuaGFuZGxlU3BlY2lhbE1lc3NhZ2UoJ19ycGNfYXBwbGljYXRpb25VcGRhdGVkOicsXG4gICAgICAgICAgICBwbGlzdC5fX2FyZ3VtZW50KTtcbiAgICAgIH0sXG4gICAgICAnX3JwY19yZXBvcnRDb25uZWN0ZWREcml2ZXJMaXN0Oic6IChwbGlzdCkgPT4ge1xuICAgICAgICB0aGlzLmhhbmRsZVNwZWNpYWxNZXNzYWdlKCdfcnBjX3JlcG9ydENvbm5lY3RlZERyaXZlckxpc3Q6JyxcbiAgICAgICAgICAgIHBsaXN0Ll9fYXJndW1lbnQpO1xuICAgICAgfSxcbiAgICAgICdfcnBjX2FwcGxpY2F0aW9uU2VudERhdGE6JzogdGhpcy5oYW5kbGVEYXRhTWVzc2FnZS5iaW5kKHRoaXMpLFxuICAgIH07XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
