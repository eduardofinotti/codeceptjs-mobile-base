require('source-map-support').install();

'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$values = require('babel-runtime/core-js/object/values')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumBaseDriver = require('appium-base-driver');

var _remoteDebuggerRpcClient = require('./remote-debugger-rpc-client');

var _remoteDebuggerRpcClient2 = _interopRequireDefault(_remoteDebuggerRpcClient);

var _messageHandlers = require('./message-handlers');

var _messageHandlers2 = _interopRequireDefault(_messageHandlers);

var _helpers = require('./helpers');

var _appiumSupport = require('appium-support');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var DEBUGGER_TYPES = {
  webkit: 1,
  webinspector: 2
};
var SELECT_APP_RETRIES = 20;
var REMOTE_DEBUGGER_PORT = 27753;

/* How many milliseconds to wait for webkit to return a response before timing out */
var RPC_RESPONSE_TIMEOUT_MS = 5000;

var PAGE_READY_TIMEOUT = 5000;

var RESPONSE_LOG_LENGTH = 100;

var GARBAGE_COLLECT_TIMEOUT = 5000;

var RemoteDebugger = (function (_events$EventEmitter) {
  _inherits(RemoteDebugger, _events$EventEmitter);

  /*
   * The constructor takes an opts hash with the following properties:
   *   - bundleId - id of the app being connected to
   *   - platformVersion - version of iOS
   *   - debuggerType - one of the DEBUGGER_TYPES
   *   - useNewSafari - for web inspector, whether this is a new Safari instance
   *   - pageLoadMs - the time, in ms, that should be waited for page loading
   *   - host - the remote debugger's host address
   *   - port - the remote debugger port through which to communicate
   */

  function RemoteDebugger() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, RemoteDebugger);

    _get(Object.getPrototypeOf(RemoteDebugger.prototype), 'constructor', this).call(this);

    var bundleId = opts.bundleId;
    var platformVersion = opts.platformVersion;
    var _opts$debuggerType = opts.debuggerType;
    var debuggerType = _opts$debuggerType === undefined ? DEBUGGER_TYPES.webinspector : _opts$debuggerType;
    var _opts$useNewSafari = opts.useNewSafari;
    var useNewSafari = _opts$useNewSafari === undefined ? false : _opts$useNewSafari;
    var pageLoadMs = opts.pageLoadMs;
    var host = opts.host;
    var _opts$port = opts.port;
    var port = _opts$port === undefined ? REMOTE_DEBUGGER_PORT : _opts$port;
    var socketPath = opts.socketPath;
    var _opts$pageReadyTimeout = opts.pageReadyTimeout;
    var pageReadyTimeout = _opts$pageReadyTimeout === undefined ? PAGE_READY_TIMEOUT : _opts$pageReadyTimeout;
    var remoteDebugProxy = opts.remoteDebugProxy;
    var _opts$garbageCollectOnExecute = opts.garbageCollectOnExecute;
    var garbageCollectOnExecute = _opts$garbageCollectOnExecute === undefined ? true : _opts$garbageCollectOnExecute;

    this.bundleId = bundleId;
    this.platformVersion = platformVersion;
    this.debuggerType = debuggerType;
    if (this.debuggerType === DEBUGGER_TYPES.webinspector) {
      this.useNewSafari = useNewSafari;
      this.pageLoadMs = pageLoadMs;
      _logger2['default'].debug('useNewSafari --> ' + this.useNewSafari);
    }
    this.garbageCollectOnExecute = garbageCollectOnExecute;

    this.host = host;
    this.port = port;
    this.socketPath = socketPath;
    this.remoteDebugProxy = remoteDebugProxy;
    this.pageReadyTimeout = pageReadyTimeout;
  }

  // event emitted publically

  _createClass(RemoteDebugger, [{
    key: 'setup',
    value: function setup() {
      // app handling configuration
      this.appDict = {};
      this.appIdKey = null;
      this.pageIdKey = null;
      this.pageLoading = false;

      // set up the special callbacks for handling rd events
      this.specialCbs = {
        '_rpc_reportIdentifier:': _lodash2['default'].noop,
        '_rpc_forwardGetListing:': this.onPageChange.bind(this),
        '_rpc_reportConnectedApplicationList:': _lodash2['default'].noop,
        '_rpc_applicationConnected:': this.onAppConnect.bind(this),
        '_rpc_applicationDisconnected:': this.onAppDisconnect.bind(this),
        '_rpc_applicationUpdated:': this.onAppUpdate.bind(this),
        '_rpc_reportConnectedDriverList:': this.onReportDriverList.bind(this),
        'pageLoad': this.pageLoad.bind(this),
        'frameDetached': this.frameDetached.bind(this)
      };

      this.rpcClient = null;
    }
  }, {
    key: 'teardown',
    value: function teardown() {
      _logger2['default'].debug('Cleaning up listeners');

      this.appDict = {};
      this.appIdKey = null;
      this.pageIdKey = null;
      this.pageLoading = false;

      this.specialCbs = {};

      this.rpcClient = null;

      this.removeAllListeners(RemoteDebugger.EVENT_PAGE_CHANGE);
      this.removeAllListeners(RemoteDebugger.EVENT_DISCONNECT);
    }
  }, {
    key: 'connect',
    value: function connect() {
      var appInfo;
      return _regeneratorRuntime.async(function connect$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.setup();

            // initialize the rpc client
            this.rpcClient = new _remoteDebuggerRpcClient2['default']({
              host: this.host,
              port: this.port,
              socketPath: this.socketPath,
              specialMessageHandlers: this.specialCbs,
              messageProxy: this.remoteDebugProxy
            });
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.rpcClient.connect());

          case 4:
            context$2$0.prev = 4;
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.setConnectionKey());

          case 7:
            appInfo = context$2$0.sent;

            _logger2['default'].debug('Connected to application');
            return context$2$0.abrupt('return', appInfo);

          case 12:
            context$2$0.prev = 12;
            context$2$0.t0 = context$2$0['catch'](4);
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(this.disconnect());

          case 16:
            return context$2$0.abrupt('return', null);

          case 17:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[4, 12]]);
    }
  }, {
    key: 'disconnect',
    value: function disconnect() {
      return _regeneratorRuntime.async(function disconnect$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.rpcClient.disconnect());

          case 2:
            this.emit(RemoteDebugger.EVENT_DISCONNECT, true);
            this.teardown();

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'isConnected',
    value: function isConnected() {
      return !!(this.rpcClient && this.rpcClient.isConnected());
    }
  }, {
    key: 'logApplicationDictionary',
    value: function logApplicationDictionary(apps) {
      function getValueString(key, value) {
        if (_lodash2['default'].isFunction(value)) {
          return '[Function]';
        }
        if (key === 'pageDict' && !_lodash2['default'].isArray(value)) {
          return '"Waiting for data"';
        }
        return JSON.stringify(value);
      }
      _logger2['default'].debug('Current applications available:');
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = _getIterator(_lodash2['default'].toPairs(apps)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          var _step$value = _slicedToArray(_step.value, 2);

          var app = _step$value[0];
          var info = _step$value[1];

          _logger2['default'].debug('    Application: \'' + app + '\'');
          var _iteratorNormalCompletion2 = true;
          var _didIteratorError2 = false;
          var _iteratorError2 = undefined;

          try {
            for (var _iterator2 = _getIterator(_lodash2['default'].toPairs(info)), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
              var _step2$value = _slicedToArray(_step2.value, 2);

              var key = _step2$value[0];
              var value = _step2$value[1];

              var valueString = getValueString(key, value);
              _logger2['default'].debug('        ' + key + ': ' + valueString);
            }
          } catch (err) {
            _didIteratorError2 = true;
            _iteratorError2 = err;
          } finally {
            try {
              if (!_iteratorNormalCompletion2 && _iterator2['return']) {
                _iterator2['return']();
              }
            } finally {
              if (_didIteratorError2) {
                throw _iteratorError2;
              }
            }
          }
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }
    }
  }, {
    key: 'setConnectionKey',
    value: function setConnectionKey() {
      return _regeneratorRuntime.async(function setConnectionKey$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve, reject) {
              // local callback, called when the remote debugger has established
              // a connection to the app under test
              // `app` will be an array of dictionaries of app information
              var connectCb = function connectCb(apps) {
                if (_lodash2['default'].isUndefined(apps) || _lodash2['default'].keys(apps).length === 0) {
                  _logger2['default'].debug('Received no apps from remote debugger. Unable to connect.');
                  return resolve(_this.appDict);
                }
                var newDict = {};

                // translate the received information into an easier-to-manage
                // hash with app id as key, and app info as value
                var _iteratorNormalCompletion3 = true;
                var _didIteratorError3 = false;
                var _iteratorError3 = undefined;

                try {
                  for (var _iterator3 = _getIterator(_lodash2['default'].values(apps)), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
                    var dict = _step3.value;

                    var _appInfoFromDict = (0, _helpers.appInfoFromDict)(dict);

                    var _appInfoFromDict2 = _slicedToArray(_appInfoFromDict, 2);

                    var id = _appInfoFromDict2[0];
                    var entry = _appInfoFromDict2[1];

                    newDict[id] = entry;
                  }
                  // update the object's list of apps, and return it through the promise
                } catch (err) {
                  _didIteratorError3 = true;
                  _iteratorError3 = err;
                } finally {
                  try {
                    if (!_iteratorNormalCompletion3 && _iterator3['return']) {
                      _iterator3['return']();
                    }
                  } finally {
                    if (_didIteratorError3) {
                      throw _iteratorError3;
                    }
                  }
                }

                _lodash2['default'].defaults(_this.appDict, newDict);
                resolve(newDict);
              };
              _this.rpcClient.setSpecialMessageHandler('_rpc_reportConnectedApplicationList:', reject, connectCb);

              _logger2['default'].debug('Sending connection key request');
              return (function callee$3$0() {
                var _ref, _ref2, simNameKey, simBuildKey, simPlatformVersion;

                return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                  while (1) switch (context$4$0.prev = context$4$0.next) {
                    case 0:
                      context$4$0.next = 2;
                      return _regeneratorRuntime.awrap(this.rpcClient.send('setConnectionKey'));

                    case 2:
                      _ref = context$4$0.sent;
                      _ref2 = _slicedToArray(_ref, 3);
                      simNameKey = _ref2[0];
                      simBuildKey = _ref2[1];
                      simPlatformVersion = _ref2[2];

                      _logger2['default'].debug('Sim name: ' + simNameKey);
                      _logger2['default'].debug('Sim build: ' + simBuildKey);
                      _logger2['default'].debug('Sim platform version: ' + simPlatformVersion);

                    case 10:
                    case 'end':
                      return context$4$0.stop();
                  }
                }, null, _this);
              })();
            }));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'updateAppsWithDict',
    value: function updateAppsWithDict(dict) {
      // get the dictionary entry into a nice form, and add it to the
      // application dictionary
      this.appDict = this.appDict || {};

      var _appInfoFromDict3 = (0, _helpers.appInfoFromDict)(dict);

      var _appInfoFromDict32 = _slicedToArray(_appInfoFromDict3, 2);

      var id = _appInfoFromDict32[0];
      var entry = _appInfoFromDict32[1];

      if (this.appDict[id]) {
        // preserve the page dictionary for this entry
        entry.pageDict = this.appDict[id].pageDict;
      }
      this.appDict[id] = entry;

      // add a promise to get the page dictionary
      if (_lodash2['default'].isUndefined(entry.pageDict)) {
        entry.pageDict = (0, _helpers.deferredPromise)();
      }

      // try to get the app id from our connected apps
      if (!this.appIdKey) {
        this.appIdKey = (0, _helpers.getDebuggerAppKey)(this.bundleId, this.platformVersion, this.appDict);
      }
    }
  }, {
    key: 'selectApp',
    value: function selectApp() {
      var currentUrl = arguments.length <= 0 || arguments[0] === undefined ? null : arguments[0];
      var maxTries = arguments.length <= 1 || arguments[1] === undefined ? SELECT_APP_RETRIES : arguments[1];
      var ignoreAboutBlankUrl = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];

      var pageDict, appIdKey, i, possibleAppIds, _iteratorNormalCompletion4, _didIteratorError4, _iteratorError4, _iterator4, _step4, attemptedAppIdKey, _ref3, _ref32, found, _iteratorNormalCompletion5, _didIteratorError5, _iteratorError5, _iterator5, _step5, appDict, _iteratorNormalCompletion6, _didIteratorError6, _iteratorError6, _iterator6, _step6, dict, pagePromises, pageArray, fullPageArray, _iteratorNormalCompletion7, _didIteratorError7, _iteratorError7, _iterator7, _step7, _step7$value, app, info, id, _iteratorNormalCompletion8, _didIteratorError8, _iteratorError8, _iterator8, _step8, page, _pageDict;

      return _regeneratorRuntime.async(function selectApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Selecting application');

            if (!(!this.appDict || _lodash2['default'].keys(this.appDict).length === 0)) {
              context$2$0.next = 4;
              break;
            }

            _logger2['default'].debug('No applications currently connected.');
            return context$2$0.abrupt('return', []);

          case 4:
            pageDict = undefined, appIdKey = undefined;
            i = 0;

          case 6:
            if (!(i < maxTries)) {
              context$2$0.next = 128;
              break;
            }

            this.logApplicationDictionary(this.appDict);
            possibleAppIds = (0, _helpers.getPossibleDebuggerAppKeys)(this.bundleId, this.platformVersion, this.appDict);

            _logger2['default'].debug('Trying out the possible app ids: ' + possibleAppIds.join(', '));
            _iteratorNormalCompletion4 = true;
            _didIteratorError4 = false;
            _iteratorError4 = undefined;
            context$2$0.prev = 13;
            _iterator4 = _getIterator(possibleAppIds);

          case 15:
            if (_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done) {
              context$2$0.next = 111;
              break;
            }

            attemptedAppIdKey = _step4.value;
            context$2$0.prev = 17;

            _logger2['default'].debug('Selecting app ' + attemptedAppIdKey + ' (try #' + (i + 1) + ' of ' + maxTries + ')');
            context$2$0.next = 21;
            return _regeneratorRuntime.awrap(this.rpcClient.selectApp(attemptedAppIdKey, this.onAppConnect.bind(this)));

          case 21:
            _ref3 = context$2$0.sent;
            _ref32 = _slicedToArray(_ref3, 2);
            appIdKey = _ref32[0];
            pageDict = _ref32[1];

            if (!_lodash2['default'].isEmpty(pageDict)) {
              context$2$0.next = 28;
              break;
            }

            _logger2['default'].debug('Empty page dictionary received. Trying again.');
            return context$2$0.abrupt('continue', 108);

          case 28:

            // save the page array for this app
            this.appDict[appIdKey].pageDict = (0, _helpers.pageArrayFromDict)(pageDict);

            // if we are looking for a particular url, make sure we have the right page. Ignore empty or undefined urls. Ignore about:blank if requested.
            found = false;
            _iteratorNormalCompletion5 = true;
            _didIteratorError5 = false;
            _iteratorError5 = undefined;
            context$2$0.prev = 33;
            _iterator5 = _getIterator(_lodash2['default'].values(this.appDict));

          case 35:
            if (_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done) {
              context$2$0.next = 84;
              break;
            }

            appDict = _step5.value;

            if (!found) {
              context$2$0.next = 39;
              break;
            }

            return context$2$0.abrupt('break', 84);

          case 39:
            if (!(!appDict || !appDict.pageDict)) {
              context$2$0.next = 41;
              break;
            }

            return context$2$0.abrupt('continue', 81);

          case 41:
            if (!appDict.pageDict.promise) {
              context$2$0.next = 52;
              break;
            }

            context$2$0.prev = 42;
            context$2$0.next = 45;
            return _regeneratorRuntime.awrap(_bluebird2['default'].resolve(appDict.pageDict.promise).timeout(10000));

          case 45:
            context$2$0.next = 52;
            break;

          case 47:
            context$2$0.prev = 47;
            context$2$0.t0 = context$2$0['catch'](42);

            if (context$2$0.t0 instanceof _bluebird2['default'].TimeoutError) {
              context$2$0.next = 51;
              break;
            }

            throw context$2$0.t0;

          case 51:
            return context$2$0.abrupt('continue', 81);

          case 52:
            _iteratorNormalCompletion6 = true;
            _didIteratorError6 = false;
            _iteratorError6 = undefined;
            context$2$0.prev = 55;
            _iterator6 = _getIterator(appDict.pageDict || []);

          case 57:
            if (_iteratorNormalCompletion6 = (_step6 = _iterator6.next()).done) {
              context$2$0.next = 67;
              break;
            }

            dict = _step6.value;

            if (!((!ignoreAboutBlankUrl || dict.url !== 'about:blank') && (!currentUrl || dict.url === currentUrl))) {
              context$2$0.next = 64;
              break;
            }

            // save where we found the right page
            appIdKey = appDict.id;
            pageDict = dict;
            found = true;
            return context$2$0.abrupt('break', 84);

          case 64:
            _iteratorNormalCompletion6 = true;
            context$2$0.next = 57;
            break;

          case 67:
            context$2$0.next = 73;
            break;

          case 69:
            context$2$0.prev = 69;
            context$2$0.t1 = context$2$0['catch'](55);
            _didIteratorError6 = true;
            _iteratorError6 = context$2$0.t1;

          case 73:
            context$2$0.prev = 73;
            context$2$0.prev = 74;

            if (!_iteratorNormalCompletion6 && _iterator6['return']) {
              _iterator6['return']();
            }

          case 76:
            context$2$0.prev = 76;

            if (!_didIteratorError6) {
              context$2$0.next = 79;
              break;
            }

            throw _iteratorError6;

          case 79:
            return context$2$0.finish(76);

          case 80:
            return context$2$0.finish(73);

          case 81:
            _iteratorNormalCompletion5 = true;
            context$2$0.next = 35;
            break;

          case 84:
            context$2$0.next = 90;
            break;

          case 86:
            context$2$0.prev = 86;
            context$2$0.t2 = context$2$0['catch'](33);
            _didIteratorError5 = true;
            _iteratorError5 = context$2$0.t2;

          case 90:
            context$2$0.prev = 90;
            context$2$0.prev = 91;

            if (!_iteratorNormalCompletion5 && _iterator5['return']) {
              _iterator5['return']();
            }

          case 93:
            context$2$0.prev = 93;

            if (!_didIteratorError5) {
              context$2$0.next = 96;
              break;
            }

            throw _iteratorError5;

          case 96:
            return context$2$0.finish(93);

          case 97:
            return context$2$0.finish(90);

          case 98:
            if (found) {
              context$2$0.next = 102;
              break;
            }

            if (currentUrl) {
              _logger2['default'].debug('Received app, but expected url (\'' + currentUrl + '\') was not found. Trying again.');
            } else {
              _logger2['default'].debug('Received app, but no match was found. Trying again.');
            }
            pageDict = null;
            return context$2$0.abrupt('continue', 108);

          case 102:
            return context$2$0.abrupt('break', 128);

          case 105:
            context$2$0.prev = 105;
            context$2$0.t3 = context$2$0['catch'](17);

            _logger2['default'].debug('Error checking application: \'' + context$2$0.t3.message + '\'. Retrying connection');

          case 108:
            _iteratorNormalCompletion4 = true;
            context$2$0.next = 15;
            break;

          case 111:
            context$2$0.next = 117;
            break;

          case 113:
            context$2$0.prev = 113;
            context$2$0.t4 = context$2$0['catch'](13);
            _didIteratorError4 = true;
            _iteratorError4 = context$2$0.t4;

          case 117:
            context$2$0.prev = 117;
            context$2$0.prev = 118;

            if (!_iteratorNormalCompletion4 && _iterator4['return']) {
              _iterator4['return']();
            }

          case 120:
            context$2$0.prev = 120;

            if (!_didIteratorError4) {
              context$2$0.next = 123;
              break;
            }

            throw _iteratorError4;

          case 123:
            return context$2$0.finish(120);

          case 124:
            return context$2$0.finish(117);

          case 125:
            i++;
            context$2$0.next = 6;
            break;

          case 128:

            // if, after all this, we have no dictionary, we have failed
            if (!pageDict) {
              _logger2['default'].errorAndThrow('Could not connect to a valid app after ' + maxTries + ' tries.');
            }

            if (this.appIdKey !== appIdKey) {
              _logger2['default'].debug('Received altered app id, updating from \'' + this.appIdKey + '\' to \'' + appIdKey + '\'');
              this.appIdKey = appIdKey;
            }

            // wait for all the promises are back, or 30s passes
            pagePromises = _Object$values(this.appDict).filter(function (app) {
              return !!app.pageDict && !!app.pageDict.promise;
            }).map(function (app) {
              return app.pageDict.promise;
            });

            if (!pagePromises.length) {
              context$2$0.next = 135;
              break;
            }

            _logger2['default'].debug('Waiting for ' + pagePromises.length + ' pages to be fulfilled');
            context$2$0.next = 135;
            return _regeneratorRuntime.awrap(_bluebird2['default'].any([_bluebird2['default'].delay(30000), _bluebird2['default'].all(pagePromises)]));

          case 135:
            pageArray = (0, _helpers.pageArrayFromDict)(pageDict);

            _logger2['default'].debug('Finally selecting app ' + this.appIdKey + ': ' + (0, _helpers.simpleStringify)(pageArray));

            fullPageArray = [];
            _iteratorNormalCompletion7 = true;
            _didIteratorError7 = false;
            _iteratorError7 = undefined;
            context$2$0.prev = 141;
            _iterator7 = _getIterator(_lodash2['default'].toPairs(this.appDict));

          case 143:
            if (_iteratorNormalCompletion7 = (_step7 = _iterator7.next()).done) {
              context$2$0.next = 172;
              break;
            }

            _step7$value = _slicedToArray(_step7.value, 2);
            app = _step7$value[0];
            info = _step7$value[1];

            if (_lodash2['default'].isArray(info.pageDict)) {
              context$2$0.next = 149;
              break;
            }

            return context$2$0.abrupt('continue', 169);

          case 149:
            id = app.replace('PID:', '');
            _iteratorNormalCompletion8 = true;
            _didIteratorError8 = false;
            _iteratorError8 = undefined;
            context$2$0.prev = 153;

            for (_iterator8 = _getIterator(info.pageDict); !(_iteratorNormalCompletion8 = (_step8 = _iterator8.next()).done); _iteratorNormalCompletion8 = true) {
              page = _step8.value;

              if (page.url && (!ignoreAboutBlankUrl || page.url !== 'about:blank') && (!currentUrl || page.url === currentUrl)) {
                _pageDict = _lodash2['default'].clone(page);

                _pageDict.id = id + '.' + _pageDict.id;
                fullPageArray.push(_pageDict);
              }
            }
            context$2$0.next = 161;
            break;

          case 157:
            context$2$0.prev = 157;
            context$2$0.t5 = context$2$0['catch'](153);
            _didIteratorError8 = true;
            _iteratorError8 = context$2$0.t5;

          case 161:
            context$2$0.prev = 161;
            context$2$0.prev = 162;

            if (!_iteratorNormalCompletion8 && _iterator8['return']) {
              _iterator8['return']();
            }

          case 164:
            context$2$0.prev = 164;

            if (!_didIteratorError8) {
              context$2$0.next = 167;
              break;
            }

            throw _iteratorError8;

          case 167:
            return context$2$0.finish(164);

          case 168:
            return context$2$0.finish(161);

          case 169:
            _iteratorNormalCompletion7 = true;
            context$2$0.next = 143;
            break;

          case 172:
            context$2$0.next = 178;
            break;

          case 174:
            context$2$0.prev = 174;
            context$2$0.t6 = context$2$0['catch'](141);
            _didIteratorError7 = true;
            _iteratorError7 = context$2$0.t6;

          case 178:
            context$2$0.prev = 178;
            context$2$0.prev = 179;

            if (!_iteratorNormalCompletion7 && _iterator7['return']) {
              _iterator7['return']();
            }

          case 181:
            context$2$0.prev = 181;

            if (!_didIteratorError7) {
              context$2$0.next = 184;
              break;
            }

            throw _iteratorError7;

          case 184:
            return context$2$0.finish(181);

          case 185:
            return context$2$0.finish(178);

          case 186:
            return context$2$0.abrupt('return', fullPageArray);

          case 187:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[13, 113, 117, 125], [17, 105], [33, 86, 90, 98], [42, 47], [55, 69, 73, 81], [74,, 76, 80], [91,, 93, 97], [118,, 120, 124], [141, 174, 178, 186], [153, 157, 161, 169], [162,, 164, 168], [179,, 181, 185]]);
    }
  }, {
    key: 'selectPage',
    value: function selectPage(appIdKey, pageIdKey) {
      var skipReadyCheck = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
      var ready;
      return _regeneratorRuntime.async(function selectPage$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.appIdKey = 'PID:' + appIdKey;
            this.pageIdKey = pageIdKey;

            _logger2['default'].debug('Selecting page \'' + pageIdKey + '\' on app \'' + this.appIdKey + '\' and forwarding socket setup');

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.rpcClient.send('setSenderKey', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey
            }));

          case 5:
            _logger2['default'].debug('Sender key set');

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.rpcClient.send('enablePage', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 8:
            _logger2['default'].debug('Enabled activity on page');

            // make sure everything is ready to go
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.checkPageIsReady());

          case 11:
            ready = context$2$0.sent;

            if (!(!skipReadyCheck && !ready)) {
              context$2$0.next = 15;
              break;
            }

            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.pageUnload());

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'executeAtom',
    value: function executeAtom(atom, args, frames) {
      var script, value;
      return _regeneratorRuntime.async(function executeAtom$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.rpcClient.connected) {
              context$2$0.next = 2;
              break;
            }

            throw new Error('Remote debugger is not connected');

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((0, _helpers.getScriptForAtom)(atom, args, frames));

          case 4:
            script = context$2$0.sent;
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.execute(script, true));

          case 7:
            value = context$2$0.sent;

            _logger2['default'].debug('Received result for atom \'' + atom + '\' execution: ' + _lodash2['default'].truncate((0, _helpers.simpleStringify)(value), { length: RESPONSE_LOG_LENGTH }));
            return context$2$0.abrupt('return', value);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'executeAtomAsync',
    value: function executeAtomAsync(atom, args, frames, responseUrl) {
      var asyncCallBack, script;
      return _regeneratorRuntime.async(function executeAtomAsync$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            asyncCallBack = 'function (res) { xmlHttp = new XMLHttpRequest(); ' + ('xmlHttp.open(\'POST\', \'' + responseUrl + '\', true);') + 'xmlHttp.setRequestHeader(\'Content-type\',\'application/json\'); ' + 'xmlHttp.send(res); }';
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _helpers.getScriptForAtom)(atom, args, frames, asyncCallBack));

          case 3:
            script = context$2$0.sent;
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.execute(script));

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'frameDetached',
    value: function frameDetached() {
      return _regeneratorRuntime.async(function frameDetached$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.emit(RemoteDebugger.EVENT_FRAMES_DETACHED);

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'pageLoad',
    value: function pageLoad(startPageLoadMs, pageLoadVerifyHook) {
      var timeoutMs, start, verify;
      return _regeneratorRuntime.async(function pageLoad$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            timeoutMs = 500;
            start = startPageLoadMs || Date.now();

            _logger2['default'].debug('Page loaded, verifying whether ready');

            verify = function verify() {
              var ready;
              return _regeneratorRuntime.async(function verify$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    this.pageLoadDelay = _appiumSupport.util.cancellableDelay(timeoutMs);
                    context$3$0.prev = 1;
                    context$3$0.next = 4;
                    return _regeneratorRuntime.awrap(this.pageLoadDelay);

                  case 4:
                    context$3$0.next = 10;
                    break;

                  case 6:
                    context$3$0.prev = 6;
                    context$3$0.t0 = context$3$0['catch'](1);

                    if (!(context$3$0.t0 instanceof _bluebird2['default'].CancellationError)) {
                      context$3$0.next = 10;
                      break;
                    }

                    return context$3$0.abrupt('return');

                  case 10:
                    if (this.appIdKey) {
                      context$3$0.next = 13;
                      break;
                    }

                    _logger2['default'].debug('Not connected to an application. Ignoring page load');
                    return context$3$0.abrupt('return');

                  case 13:
                    if (!_lodash2['default'].isFunction(pageLoadVerifyHook)) {
                      context$3$0.next = 16;
                      break;
                    }

                    context$3$0.next = 16;
                    return _regeneratorRuntime.awrap(pageLoadVerifyHook());

                  case 16:
                    context$3$0.next = 18;
                    return _regeneratorRuntime.awrap(this.checkPageIsReady());

                  case 18:
                    ready = context$3$0.sent;

                    if (!(ready || this.pageLoadMs > 0 && start + this.pageLoadMs < Date.now())) {
                      context$3$0.next = 24;
                      break;
                    }

                    _logger2['default'].debug('Page is ready');
                    this.pageLoading = false;
                    context$3$0.next = 27;
                    break;

                  case 24:
                    _logger2['default'].debug('Page was not ready, retrying');
                    context$3$0.next = 27;
                    return _regeneratorRuntime.awrap(verify());

                  case 27:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2, [[1, 6]]);
            };

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(verify());

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'cancelPageLoad',
    value: function cancelPageLoad() {
      return _regeneratorRuntime.async(function cancelPageLoad$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Unregistering from page readiness notifications');
            this.pageLoading = false;
            if (this.pageLoadDelay) {
              this.pageLoadDelay.cancel();
            }

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'pageUnload',
    value: function pageUnload() {
      return _regeneratorRuntime.async(function pageUnload$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Page unloading');
            this.pageLoading = true;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.waitForDom());

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForDom',
    value: function waitForDom(startPageLoadMs, pageLoadVerifyHook) {
      return _regeneratorRuntime.async(function waitForDom$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Waiting for dom...');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.pageLoad(startPageLoadMs, pageLoadVerifyHook));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'checkPageIsReady',
    value: function checkPageIsReady() {
      var errors, readyCmd, readyState;
      return _regeneratorRuntime.async(function checkPageIsReady$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            errors = (0, _helpers.checkParams)({ appIdKey: this.appIdKey });

            if (!errors) {
              context$2$0.next = 3;
              break;
            }

            throw new Error(errors);

          case 3:
            // eslint-disable-line curly

            _logger2['default'].debug('Checking document readyState');
            readyCmd = '(function (){ return document.readyState; })()';
            readyState = 'loading';
            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(_bluebird2['default'].resolve(this.execute(readyCmd, true)).timeout(this.pageReadyTimeout));

          case 9:
            readyState = context$2$0.sent;
            context$2$0.next = 18;
            break;

          case 12:
            context$2$0.prev = 12;
            context$2$0.t0 = context$2$0['catch'](6);

            if (context$2$0.t0 instanceof _bluebird2['default'].TimeoutError) {
              context$2$0.next = 16;
              break;
            }

            throw context$2$0.t0;

          case 16:
            _logger2['default'].debug('Page readiness check timed out after ' + this.pageReadyTimeout + 'ms');
            return context$2$0.abrupt('return', false);

          case 18:
            _logger2['default'].debug('readyState was ' + (0, _helpers.simpleStringify)(readyState));

            return context$2$0.abrupt('return', readyState === 'complete');

          case 20:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6, 12]]);
    }
  }, {
    key: 'navToUrl',
    value: function navToUrl(url, pageLoadVerifyHook) {
      var errors;
      return _regeneratorRuntime.async(function navToUrl$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(this.debuggerType === DEBUGGER_TYPES.webinspector)) {
              context$2$0.next = 4;
              break;
            }

            errors = (0, _helpers.checkParams)({ appIdKey: this.appIdKey, pageIdKey: this.pageIdKey });

            if (!errors) {
              context$2$0.next = 4;
              break;
            }

            throw new Error(errors);

          case 4:
            // eslint-disable-line curly

            _logger2['default'].debug('Navigating to new URL: ' + url);
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.rpcClient.send('setUrl', {
              url: url,
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 7:
            if (this.useNewSafari) {
              context$2$0.next = 10;
              break;
            }

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(1000));

          case 10:
            if (!(this.debuggerType === DEBUGGER_TYPES.webinspector)) {
              context$2$0.next = 13;
              break;
            }

            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.waitForFrameNavigated());

          case 13:
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.waitForDom(Date.now(), pageLoadVerifyHook));

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForFrameNavigated',
    value: function waitForFrameNavigated() {
      return _regeneratorRuntime.async(function waitForFrameNavigated$(context$2$0) {
        var _this4 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function callee$2$0(resolve, reject) {
              var startMs, navEventListener, timeout;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this3 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    _logger2['default'].debug('Waiting for frame navigated message...');
                    startMs = Date.now();

                    navEventListener = function navEventListener(value) {
                      _logger2['default'].debug('Frame navigated in ' + (Date.now() - startMs) / 1000 + ' sec from source: ' + value);
                      if (_this3.navigationDelay) {
                        _this3.navigationDelay.cancel();
                      }
                      resolve(value);
                    };

                    this.rpcClient.setSpecialMessageHandler('Page.frameNavigated', reject, navEventListener);

                    // timeout, in case remote debugger doesn't respond,
                    // or takes a long time

                    if (!(!this.useNewSafari || this.pageLoadMs >= 0)) {
                      context$3$0.next = 15;
                      break;
                    }

                    timeout = this.useNewSafari ? this.pageLoadMs : 500;

                    this.navigationDelay = _appiumSupport.util.cancellableDelay(timeout);
                    context$3$0.prev = 7;
                    context$3$0.next = 10;
                    return _regeneratorRuntime.awrap(this.navigationDelay);

                  case 10:
                    navEventListener('timeout');
                    context$3$0.next = 15;
                    break;

                  case 13:
                    context$3$0.prev = 13;
                    context$3$0.t0 = context$3$0['catch'](7);

                  case 15:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this4, [[7, 13]]);
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startTimeline',

    // nothing to do: we only get here if the remote debugger
    // already notified of frame navigation, and the delay
    // was cancelled
    value: function startTimeline(fn) {
      return _regeneratorRuntime.async(function startTimeline$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Starting to record the timeline');
            this.rpcClient.setTimelineEventHandler(fn);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.rpcClient.send('startTimeline', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stopTimeline',
    value: function stopTimeline() {
      return _regeneratorRuntime.async(function stopTimeline$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Stopping to record the timeline');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.rpcClient.send('stopTimeline', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startConsole',
    value: function startConsole(fn) {
      return _regeneratorRuntime.async(function startConsole$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Starting to listen for JavaScript console');
            this.rpcClient.setConsoleLogEventHandler(fn);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.rpcClient.send('startConsole', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stopConsole',
    value: function stopConsole() {
      return _regeneratorRuntime.async(function stopConsole$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Stopping to listen for JavaScript console');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.rpcClient.send('stopConsole', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startNetwork',
    value: function startNetwork(fn) {
      return _regeneratorRuntime.async(function startNetwork$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Starting to listen for network events');
            this.rpcClient.setNetworkLogEventHandler(fn);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.rpcClient.send('startNetwork', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stopNetwork',
    value: function stopNetwork() {
      return _regeneratorRuntime.async(function stopNetwork$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Stopping to listen for network events');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.rpcClient.send('stopNetwork', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'execute',
    value: function execute(command, override) {
      var errors, res;
      return _regeneratorRuntime.async(function execute$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(this.pageLoading && !override)) {
              context$2$0.next = 4;
              break;
            }

            _logger2['default'].debug('Trying to execute but page is not loaded.');
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.waitForDom());

          case 4:
            if (!(this.debuggerType === DEBUGGER_TYPES.webinspector)) {
              context$2$0.next = 8;
              break;
            }

            errors = (0, _helpers.checkParams)({ appIdKey: this.appIdKey, pageIdKey: this.pageIdKey });

            if (!errors) {
              context$2$0.next = 8;
              break;
            }

            throw new Error(errors);

          case 8:
            if (!this.garbageCollectOnExecute) {
              context$2$0.next = 11;
              break;
            }

            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.garbageCollect());

          case 11:

            _logger2['default'].debug('Sending javascript command ' + _lodash2['default'].truncate(command, { length: 50 }));
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.rpcClient.send('sendJSCommand', {
              command: command,
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 14:
            res = context$2$0.sent;
            return context$2$0.abrupt('return', this.convertResult(res));

          case 16:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'callFunction',
    value: function callFunction(objId, fn, args) {
      var errors, res;
      return _regeneratorRuntime.async(function callFunction$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            errors = (0, _helpers.checkParams)({ appIdKey: this.appIdKey, pageIdKey: this.pageIdKey });

            if (!errors) {
              context$2$0.next = 3;
              break;
            }

            throw new Error(errors);

          case 3:
            if (!this.garbageCollectOnExecute) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.garbageCollect());

          case 6:

            _logger2['default'].debug('Calling javascript function');
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.rpcClient.send('callJSFunction', {
              objId: objId,
              fn: fn,
              args: args,
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 9:
            res = context$2$0.sent;
            return context$2$0.abrupt('return', this.convertResult(res));

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'convertResult',
    value: function convertResult(res) {
      if (_lodash2['default'].isUndefined(res)) {
        throw new Error('Did not get OK result from remote debugger. Result was: ' + _lodash2['default'].truncate((0, _helpers.simpleStringify)(res), { length: RESPONSE_LOG_LENGTH }));
      } else if (_lodash2['default'].isString(res)) {
        try {
          res = JSON.parse(res);
        } catch (err) {
          // we might get a serialized object, but we might not
          // if we get here, it is just a value
        }
      } else if (!_lodash2['default'].isObject(res)) {
          throw new Error('Result has unexpected type: (' + typeof res + ').');
        }

      if (res.status && res.status !== 0) {
        // we got some form of error.
        throw (0, _appiumBaseDriver.errorFromCode)(res.status, res.value.message || res.value);
      }

      // with either have an object with a `value` property (even if `null`),
      // or a plain object
      return res.hasOwnProperty('value') ? res.value : res;
    }
  }, {
    key: 'allowNavigationWithoutReload',
    value: function allowNavigationWithoutReload() {
      var allow = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];

      this.rpcClient.allowNavigationWithoutReload(allow);
    }
  }, {
    key: 'getCookies',
    value: function getCookies(urls) {
      return _regeneratorRuntime.async(function getCookies$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Getting network cookies');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.rpcClient.send('getCookies', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType,
              urls: urls
            }));

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteCookie',
    value: function deleteCookie(cookieName, url) {
      return _regeneratorRuntime.async(function deleteCookie$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Deleting cookie \'' + cookieName + '\' on \'' + url + '\'');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.rpcClient.send('deleteCookie', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType,
              cookieName: cookieName,
              url: url
            }));

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'garbageCollect',
    value: function garbageCollect() {
      var timeoutMs = arguments.length <= 0 || arguments[0] === undefined ? GARBAGE_COLLECT_TIMEOUT : arguments[0];
      var errors;
      return _regeneratorRuntime.async(function garbageCollect$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Garbage collecting with ' + timeoutMs + 'ms timeout');
            errors = (0, _helpers.checkParams)({
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey
            });

            if (!errors) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].debug('Unable to collect garbage at this time');
            return context$2$0.abrupt('return');

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(_bluebird2['default'].resolve(this.rpcClient.send('garbageCollect', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            })).timeout(timeoutMs).then(function () {
              // eslint-disable-line promise/prefer-await-to-then
              _logger2['default'].debug('Garbage collection successful');
            })['catch'](function (err) {
              // eslint-disable-line promise/prefer-await-to-callbacks
              if (err instanceof _bluebird2['default'].TimeoutError) {
                _logger2['default'].debug('Garbage collection timed out after ' + timeoutMs + 'ms');
              } else {
                _logger2['default'].debug('Unable to collect garbage: ' + err.message);
              }
            }));

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return RemoteDebugger;
})(_events2['default'].EventEmitter);

RemoteDebugger.EVENT_PAGE_CHANGE = 'remote_debugger_page_change';
RemoteDebugger.EVENT_FRAMES_DETACHED = 'remote_debugger_frames_detached';
RemoteDebugger.EVENT_DISCONNECT = 'remote_debugger_disconnect';

// add generic callbacks
var _iteratorNormalCompletion9 = true;
var _didIteratorError9 = false;
var _iteratorError9 = undefined;

try {
  for (var _iterator9 = _getIterator(_lodash2['default'].toPairs(_messageHandlers2['default'])), _step9; !(_iteratorNormalCompletion9 = (_step9 = _iterator9.next()).done); _iteratorNormalCompletion9 = true) {
    var _step9$value = _slicedToArray(_step9.value, 2);

    var _name = _step9$value[0];
    var handler = _step9$value[1];

    RemoteDebugger.prototype[_name] = handler;
  }
} catch (err) {
  _didIteratorError9 = true;
  _iteratorError9 = err;
} finally {
  try {
    if (!_iteratorNormalCompletion9 && _iterator9['return']) {
      _iterator9['return']();
    }
  } finally {
    if (_didIteratorError9) {
      throw _iteratorError9;
    }
  }
}

exports.RemoteDebugger = RemoteDebugger;
exports.DEBUGGER_TYPES = DEBUGGER_TYPES;
exports.REMOTE_DEBUGGER_PORT = REMOTE_DEBUGGER_PORT;
exports.RPC_RESPONSE_TIMEOUT_MS = RPC_RESPONSE_TIMEOUT_MS;

// get the connection information about the app

// only resolve when the connection response is received

// iterative solution, as recursion was swallowing the promise at some point

// in iOS 8.2 the connect logic happens, but with an empty dictionary
// which leads to the remote debugger getting disconnected, and into a loop
// eslint-disable-line curly

// if the page dictionary has not been loaded yet from the web
// inspector, wait for it or time out after 10s

// on timeout, just go on

// we have gotten the correct application by this point, so short circuit everything

// translate the dictionary into a useful form, and return to sender
// eslint-disable-line curly
// eslint-disable-line curly

// if the promise has been cancelled
// we want to skip checking the readiness

// we can get this called in the middle of trying to find a new app

// if we are ready, or we've spend too much time on this

// no need to do this check when using webkit

// a small pause for the browser to catch up

// add a handler for the `Page.frameNavigated` message
// from the remote debugger

// use pageLoadMs, or a small amount of time

// if the page is not loaded yet, wait for it

// no need to check errors if it is webkit
// eslint-disable-line curly
// eslint-disable-line curly
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtZGVidWdnZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztzQkFDbUIsUUFBUTs7OztzQkFDWCxVQUFVOzs7O2dDQUNJLG9CQUFvQjs7dUNBQ2QsOEJBQThCOzs7OytCQUN0QyxvQkFBb0I7Ozs7dUJBRW1CLFdBQVc7OzZCQUN6RCxnQkFBZ0I7O3NCQUN2QixRQUFROzs7O3dCQUNGLFVBQVU7Ozs7QUFHOUIsSUFBTSxjQUFjLEdBQUc7QUFDckIsUUFBTSxFQUFFLENBQUM7QUFDVCxjQUFZLEVBQUUsQ0FBQztDQUNoQixDQUFDO0FBQ0YsSUFBTSxrQkFBa0IsR0FBRyxFQUFFLENBQUM7QUFDOUIsSUFBTSxvQkFBb0IsR0FBRyxLQUFLLENBQUM7OztBQUduQyxJQUFNLHVCQUF1QixHQUFHLElBQUksQ0FBQzs7QUFFckMsSUFBTSxrQkFBa0IsR0FBRyxJQUFJLENBQUM7O0FBRWhDLElBQU0sbUJBQW1CLEdBQUcsR0FBRyxDQUFDOztBQUVoQyxJQUFNLHVCQUF1QixHQUFHLElBQUksQ0FBQzs7SUFHL0IsY0FBYztZQUFkLGNBQWM7Ozs7Ozs7Ozs7Ozs7QUFXTixXQVhSLGNBQWMsR0FXTTtRQUFYLElBQUkseURBQUcsRUFBRTs7MEJBWGxCLGNBQWM7O0FBWWhCLCtCQVpFLGNBQWMsNkNBWVI7O1FBR04sUUFBUSxHQVdOLElBQUksQ0FYTixRQUFRO1FBQ1IsZUFBZSxHQVViLElBQUksQ0FWTixlQUFlOzZCQVViLElBQUksQ0FUTixZQUFZO1FBQVosWUFBWSxzQ0FBRyxjQUFjLENBQUMsWUFBWTs2QkFTeEMsSUFBSSxDQVJOLFlBQVk7UUFBWixZQUFZLHNDQUFHLEtBQUs7UUFDcEIsVUFBVSxHQU9SLElBQUksQ0FQTixVQUFVO1FBQ1YsSUFBSSxHQU1GLElBQUksQ0FOTixJQUFJO3FCQU1GLElBQUksQ0FMTixJQUFJO1FBQUosSUFBSSw4QkFBRyxvQkFBb0I7UUFDM0IsVUFBVSxHQUlSLElBQUksQ0FKTixVQUFVO2lDQUlSLElBQUksQ0FITixnQkFBZ0I7UUFBaEIsZ0JBQWdCLDBDQUFHLGtCQUFrQjtRQUNyQyxnQkFBZ0IsR0FFZCxJQUFJLENBRk4sZ0JBQWdCO3dDQUVkLElBQUksQ0FETix1QkFBdUI7UUFBdkIsdUJBQXVCLGlEQUFHLElBQUk7O0FBR2hDLFFBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0FBQ3pCLFFBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO0FBQ3ZDLFFBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO0FBQ2pDLFFBQUksSUFBSSxDQUFDLFlBQVksS0FBSyxjQUFjLENBQUMsWUFBWSxFQUFFO0FBQ3JELFVBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO0FBQ2pDLFVBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO0FBQzdCLDBCQUFJLEtBQUssdUJBQXFCLElBQUksQ0FBQyxZQUFZLENBQUcsQ0FBQztLQUNwRDtBQUNELFFBQUksQ0FBQyx1QkFBdUIsR0FBRyx1QkFBdUIsQ0FBQzs7QUFFdkQsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDakIsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDakIsUUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7QUFDN0IsUUFBSSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDO0FBQ3pDLFFBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztHQUMxQzs7OztlQTNDRyxjQUFjOztXQTZDWixpQkFBRzs7QUFFUCxVQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztBQUNsQixVQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztBQUNyQixVQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztBQUN0QixVQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQzs7O0FBR3pCLFVBQUksQ0FBQyxVQUFVLEdBQUc7QUFDaEIsZ0NBQXdCLEVBQUUsb0JBQUUsSUFBSTtBQUNoQyxpQ0FBeUIsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7QUFDdkQsOENBQXNDLEVBQUUsb0JBQUUsSUFBSTtBQUM5QyxvQ0FBNEIsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7QUFDMUQsdUNBQStCLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO0FBQ2hFLGtDQUEwQixFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztBQUN2RCx5Q0FBaUMsRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztBQUNyRSxrQkFBVSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztBQUNwQyx1QkFBZSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztPQUMvQyxDQUFDOztBQUVGLFVBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO0tBQ3ZCOzs7V0FFUSxvQkFBRztBQUNWLDBCQUFJLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDOztBQUVuQyxVQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztBQUNsQixVQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztBQUNyQixVQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztBQUN0QixVQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQzs7QUFFekIsVUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRXJCLFVBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDOztBQUV0QixVQUFJLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDMUQsVUFBSSxDQUFDLGtCQUFrQixDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0tBQzFEOzs7V0FFYTtVQWVOLE9BQU87Ozs7QUFkYixnQkFBSSxDQUFDLEtBQUssRUFBRSxDQUFDOzs7QUFHYixnQkFBSSxDQUFDLFNBQVMsR0FBRyx5Q0FBNEI7QUFDM0Msa0JBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtBQUNmLGtCQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7QUFDZix3QkFBVSxFQUFFLElBQUksQ0FBQyxVQUFVO0FBQzNCLG9DQUFzQixFQUFFLElBQUksQ0FBQyxVQUFVO0FBQ3ZDLDBCQUFZLEVBQUUsSUFBSSxDQUFDLGdCQUFnQjthQUNwQyxDQUFDLENBQUM7OzZDQUNHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFOzs7Ozs2Q0FJUixJQUFJLENBQUMsZ0JBQWdCLEVBQUU7OztBQUF2QyxtQkFBTzs7QUFDWCxnQ0FBSSxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQztnREFDL0IsT0FBTzs7Ozs7OzZDQUVSLElBQUksQ0FBQyxVQUFVLEVBQUU7OztnREFDaEIsSUFBSTs7Ozs7OztLQUVkOzs7V0FFZ0I7Ozs7OzZDQUNULElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxFQUFFOzs7QUFDakMsZ0JBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ2pELGdCQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7Ozs7Ozs7S0FDakI7OztXQUVXLHVCQUFHO0FBQ2IsYUFBTyxDQUFDLEVBQUUsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFBLEFBQUMsQ0FBQztLQUMzRDs7O1dBRXdCLGtDQUFDLElBQUksRUFBRTtBQUM5QixlQUFTLGNBQWMsQ0FBRSxHQUFHLEVBQUUsS0FBSyxFQUFFO0FBQ25DLFlBQUksb0JBQUUsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFO0FBQ3ZCLGlCQUFPLFlBQVksQ0FBQztTQUNyQjtBQUNELFlBQUksR0FBRyxLQUFLLFVBQVUsSUFBSSxDQUFDLG9CQUFFLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUMzQyxpQkFBTyxvQkFBb0IsQ0FBQztTQUM3QjtBQUNELGVBQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztPQUM5QjtBQUNELDBCQUFJLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDOzs7Ozs7QUFDN0MsMENBQXdCLG9CQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsNEdBQUU7OztjQUEvQixHQUFHO2NBQUUsSUFBSTs7QUFDakIsOEJBQUksS0FBSyx5QkFBc0IsR0FBRyxRQUFJLENBQUM7Ozs7OztBQUN2QywrQ0FBeUIsb0JBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxpSEFBRTs7O2tCQUFoQyxHQUFHO2tCQUFFLEtBQUs7O0FBQ2xCLGtCQUFJLFdBQVcsR0FBRyxjQUFjLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBQzdDLGtDQUFJLEtBQUssY0FBWSxHQUFHLFVBQUssV0FBVyxDQUFHLENBQUM7YUFDN0M7Ozs7Ozs7Ozs7Ozs7OztTQUNGOzs7Ozs7Ozs7Ozs7Ozs7S0FDRjs7O1dBRXNCOzs7Ozs7OzZDQUVSLDBCQUFZLFVBQUMsT0FBTyxFQUFFLE1BQU0sRUFBSzs7OztBQUk1QyxrQkFBSSxTQUFTLEdBQUcsU0FBWixTQUFTLENBQUksSUFBSSxFQUFLO0FBQ3hCLG9CQUFJLG9CQUFFLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxvQkFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtBQUNwRCxzQ0FBSSxLQUFLLENBQUMsMkRBQTJELENBQUMsQ0FBQztBQUN2RSx5QkFBTyxPQUFPLENBQUMsTUFBSyxPQUFPLENBQUMsQ0FBQztpQkFDOUI7QUFDRCxvQkFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDOzs7Ozs7Ozs7QUFJakIscURBQWlCLG9CQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsaUhBQUU7d0JBQXhCLElBQUk7OzJDQUNPLDhCQUFnQixJQUFJLENBQUM7Ozs7d0JBQWxDLEVBQUU7d0JBQUUsS0FBSzs7QUFDZCwyQkFBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQzttQkFDckI7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUQsb0NBQUUsUUFBUSxDQUFDLE1BQUssT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQ2xDLHVCQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7ZUFDbEIsQ0FBQztBQUNGLG9CQUFLLFNBQVMsQ0FBQyx3QkFBd0IsQ0FBQyxzQ0FBc0MsRUFBRSxNQUFNLEVBQUUsU0FBUyxDQUFDLENBQUM7O0FBRW5HLGtDQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0FBQzVDLHFCQUFPLENBQUM7aUNBQ0QsVUFBVSxFQUFFLFdBQVcsRUFBRSxrQkFBa0I7Ozs7Ozt1REFBVSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQzs7Ozs7QUFBNUYsZ0NBQVU7QUFBRSxpQ0FBVztBQUFFLHdDQUFrQjs7QUFDaEQsMENBQUksS0FBSyxnQkFBYyxVQUFVLENBQUcsQ0FBQztBQUNyQywwQ0FBSSxLQUFLLGlCQUFlLFdBQVcsQ0FBRyxDQUFDO0FBQ3ZDLDBDQUFJLEtBQUssNEJBQTBCLGtCQUFrQixDQUFHLENBQUM7Ozs7Ozs7Z0JBQzFELEVBQUcsQ0FBQzthQUNOLENBQUM7Ozs7Ozs7Ozs7S0FDSDs7O1dBRWtCLDRCQUFDLElBQUksRUFBRTs7O0FBR3hCLFVBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7OzhCQUNoQiw4QkFBZ0IsSUFBSSxDQUFDOzs7O1VBQWxDLEVBQUU7VUFBRSxLQUFLOztBQUNkLFVBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFBRTs7QUFFcEIsYUFBSyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQztPQUM1QztBQUNELFVBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDOzs7QUFHekIsVUFBSSxvQkFBRSxXQUFXLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFO0FBQ2pDLGFBQUssQ0FBQyxRQUFRLEdBQUcsK0JBQWlCLENBQUM7T0FDcEM7OztBQUdELFVBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO0FBQ2xCLFlBQUksQ0FBQyxRQUFRLEdBQUcsZ0NBQWtCLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7T0FDdEY7S0FDRjs7O1dBRWU7VUFBQyxVQUFVLHlEQUFHLElBQUk7VUFBRSxRQUFRLHlEQUFHLGtCQUFrQjtVQUFFLG1CQUFtQix5REFBRyxLQUFLOztVQVF4RixRQUFRLEVBQUUsUUFBUSxFQUNKLENBQUMsRUFFYixjQUFjLHVGQUVULGlCQUFpQixpQkFlbEIsS0FBSyx1RkFDWSxPQUFPLHVGQXFCZixJQUFJLEVBdUNqQixZQUFZLEVBU2QsU0FBUyxFQUdULGFBQWEscUdBQ1AsR0FBRyxFQUFFLElBQUksRUFFYixFQUFFLHVGQUNHLElBQUksRUFFTCxTQUFROzs7OztBQTFHbEIsZ0NBQUksS0FBSyxDQUFDLHVCQUF1QixDQUFDLENBQUM7O2tCQUMvQixDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksb0JBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFBOzs7OztBQUNwRCxnQ0FBSSxLQUFLLENBQUMsc0NBQXNDLENBQUMsQ0FBQztnREFDM0MsRUFBRTs7O0FBSVAsb0JBQVEsY0FBRSxRQUFRO0FBQ0osYUFBQyxHQUFHLENBQUM7OztrQkFBRSxDQUFDLEdBQUcsUUFBUSxDQUFBOzs7OztBQUNuQyxnQkFBSSxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN4QywwQkFBYyxHQUFHLHlDQUEyQixJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQzs7QUFDbEcsZ0NBQUksS0FBSyx1Q0FBcUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBRyxDQUFDOzs7OztzQ0FDN0MsY0FBYzs7Ozs7Ozs7QUFBbkMsNkJBQWlCOzs7QUFFdEIsZ0NBQUksS0FBSyxvQkFBa0IsaUJBQWlCLGdCQUFVLENBQUMsR0FBQyxDQUFDLENBQUEsWUFBTyxRQUFRLE9BQUksQ0FBQzs7NkNBQ2hELElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDOzs7OztBQUFyRyxvQkFBUTtBQUFFLG9CQUFROztpQkFHZixvQkFBRSxPQUFPLENBQUMsUUFBUSxDQUFDOzs7OztBQUNyQixnQ0FBSSxLQUFLLENBQUMsK0NBQStDLENBQUMsQ0FBQzs7Ozs7O0FBSzdELGdCQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsR0FBRyxnQ0FBa0IsUUFBUSxDQUFDLENBQUM7OztBQUcxRCxpQkFBSyxHQUFHLEtBQUs7Ozs7O3NDQUNlLG9CQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDOzs7Ozs7OztBQUFqQyxtQkFBTzs7aUJBQ3RCLEtBQUs7Ozs7Ozs7O2tCQUVMLENBQUMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQTs7Ozs7Ozs7aUJBTTdCLE9BQU8sQ0FBQyxRQUFRLENBQUMsT0FBTzs7Ozs7Ozs2Q0FFbEIsc0JBQVEsT0FBTyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQzs7Ozs7Ozs7OztnQkFFeEQsMEJBQWUsc0JBQVEsWUFBWTs7Ozs7Ozs7Ozs7Ozs7O3NDQVF6QixPQUFPLENBQUMsUUFBUSxJQUFJLEVBQUU7Ozs7Ozs7O0FBQS9CLGdCQUFJOztrQkFDVCxDQUFDLENBQUMsbUJBQW1CLElBQUksSUFBSSxDQUFDLEdBQUcsS0FBSyxhQUFhLENBQUEsS0FBTSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsR0FBRyxLQUFLLFVBQVUsQ0FBQSxDQUFDOzs7Ozs7QUFFbEcsb0JBQVEsR0FBRyxPQUFPLENBQUMsRUFBRSxDQUFDO0FBQ3RCLG9CQUFRLEdBQUcsSUFBSSxDQUFDO0FBQ2hCLGlCQUFLLEdBQUcsSUFBSSxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O2dCQUtkLEtBQUs7Ozs7O0FBQ1IsZ0JBQUksVUFBVSxFQUFFO0FBQ2Qsa0NBQUksS0FBSyx3Q0FBcUMsVUFBVSxzQ0FBa0MsQ0FBQzthQUM1RixNQUFNO0FBQ0wsa0NBQUksS0FBSyxDQUFDLHFEQUFxRCxDQUFDLENBQUM7YUFDbEU7QUFDRCxvQkFBUSxHQUFHLElBQUksQ0FBQzs7Ozs7Ozs7OztBQU9sQixnQ0FBSSxLQUFLLG9DQUFpQyxlQUFJLE9BQU8sNkJBQXlCLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWhFOUMsYUFBQyxFQUFFOzs7Ozs7O0FBc0UxQyxnQkFBSSxDQUFDLFFBQVEsRUFBRTtBQUNiLGtDQUFJLGFBQWEsNkNBQTJDLFFBQVEsYUFBVSxDQUFDO2FBQ2hGOztBQUVELGdCQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFO0FBQzlCLGtDQUFJLEtBQUssK0NBQTRDLElBQUksQ0FBQyxRQUFRLGdCQUFTLFFBQVEsUUFBSSxDQUFDO0FBQ3hGLGtCQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQzthQUMxQjs7O0FBR0ssd0JBQVksR0FBRyxlQUFjLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FDN0MsTUFBTSxDQUFDLFVBQUMsR0FBRztxQkFBSyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPO2FBQUEsQ0FBQyxDQUN6RCxHQUFHLENBQUMsVUFBQyxHQUFHO3FCQUFLLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTzthQUFBLENBQUM7O2lCQUNqQyxZQUFZLENBQUMsTUFBTTs7Ozs7QUFDckIsZ0NBQUksS0FBSyxrQkFBZ0IsWUFBWSxDQUFDLE1BQU0sNEJBQXlCLENBQUM7OzZDQUNoRSxzQkFBUSxHQUFHLENBQUMsQ0FBQyxzQkFBUSxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsc0JBQVEsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7OztBQUlsRSxxQkFBUyxHQUFHLGdDQUFrQixRQUFRLENBQUM7O0FBQzNDLGdDQUFJLEtBQUssNEJBQTBCLElBQUksQ0FBQyxRQUFRLFVBQUssOEJBQWdCLFNBQVMsQ0FBQyxDQUFHLENBQUM7O0FBRS9FLHlCQUFhLEdBQUcsRUFBRTs7Ozs7c0NBQ0Usb0JBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7Ozs7Ozs7OztBQUFyQyxlQUFHO0FBQUUsZ0JBQUk7O2dCQUNaLG9CQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDOzs7Ozs7OztBQUN6QixjQUFFLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDOzs7Ozs7QUFDaEMsMkNBQWlCLElBQUksQ0FBQyxRQUFRLHlHQUFFO0FBQXZCLGtCQUFJOztBQUNYLGtCQUFJLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxtQkFBbUIsSUFBSSxJQUFJLENBQUMsR0FBRyxLQUFLLGFBQWEsQ0FBQSxBQUFDLEtBQUssQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLEdBQUcsS0FBSyxVQUFVLENBQUEsQUFBQyxFQUFFO0FBQzVHLHlCQUFRLEdBQUcsb0JBQUUsS0FBSyxDQUFDLElBQUksQ0FBQzs7QUFDNUIseUJBQVEsQ0FBQyxFQUFFLEdBQU0sRUFBRSxTQUFJLFNBQVEsQ0FBQyxFQUFFLEFBQUUsQ0FBQztBQUNyQyw2QkFBYSxDQUFDLElBQUksQ0FBQyxTQUFRLENBQUMsQ0FBQztlQUM5QjthQUNGOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztnREFHSSxhQUFhOzs7Ozs7O0tBQ3JCOzs7V0FFZ0Isb0JBQUMsUUFBUSxFQUFFLFNBQVM7VUFBRSxjQUFjLHlEQUFHLEtBQUs7VUFvQnZELEtBQUs7Ozs7QUFuQlQsZ0JBQUksQ0FBQyxRQUFRLFlBQVUsUUFBUSxBQUFFLENBQUM7QUFDbEMsZ0JBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDOztBQUUzQixnQ0FBSSxLQUFLLHVCQUFvQixTQUFTLG9CQUFhLElBQUksQ0FBQyxRQUFRLG9DQUFnQyxDQUFDOzs7NkNBRTNGLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRTtBQUN4QyxzQkFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO0FBQ3ZCLHVCQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7YUFDMUIsQ0FBQzs7O0FBQ0YsZ0NBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7Ozs2Q0FFdEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFO0FBQ3RDLHNCQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7QUFDdkIsdUJBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztBQUN6QiwwQkFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO2FBQ2hDLENBQUM7OztBQUNGLGdDQUFJLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxDQUFDOzs7OzZDQUdwQixJQUFJLENBQUMsZ0JBQWdCLEVBQUU7OztBQUFyQyxpQkFBSzs7a0JBQ0wsQ0FBQyxjQUFjLElBQUksQ0FBQyxLQUFLLENBQUE7Ozs7Ozs2Q0FDckIsSUFBSSxDQUFDLFVBQVUsRUFBRTs7Ozs7OztLQUUxQjs7O1dBRWlCLHFCQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTTtVQUcvQixNQUFNLEVBRU4sS0FBSzs7OztnQkFKSixJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVM7Ozs7O2tCQUFRLElBQUksS0FBSyxDQUFDLGtDQUFrQyxDQUFDOzs7OzZDQUUvRCwrQkFBaUIsSUFBSSxFQUFFLElBQUksRUFBRSxNQUFNLENBQUM7OztBQUFuRCxrQkFBTTs7NkNBRVEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDOzs7QUFBeEMsaUJBQUs7O0FBQ1QsZ0NBQUksS0FBSyxpQ0FBOEIsSUFBSSxzQkFBZ0Isb0JBQUUsUUFBUSxDQUFDLDhCQUFnQixLQUFLLENBQUMsRUFBRSxFQUFDLE1BQU0sRUFBRSxtQkFBbUIsRUFBQyxDQUFDLENBQUcsQ0FBQztnREFDekgsS0FBSzs7Ozs7OztLQUNiOzs7V0FFc0IsMEJBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsV0FBVztVQUNqRCxhQUFhLEVBSWIsTUFBTTs7OztBQUpOLHlCQUFhLEdBQUcscUZBQ3lCLFdBQVcsZ0JBQVcsc0VBQ2dCLHlCQUN6Qzs7NkNBQ3ZCLCtCQUFpQixJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxhQUFhLENBQUM7OztBQUFsRSxrQkFBTTs7NkNBQ0osSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7Ozs7Ozs7S0FDM0I7OztXQUVtQjs7OztBQUNsQixnQkFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMscUJBQXFCLENBQUMsQ0FBQzs7Ozs7OztLQUNqRDs7O1dBRWMsa0JBQUMsZUFBZSxFQUFFLGtCQUFrQjtVQUM3QyxTQUFTLEVBQ1QsS0FBSyxFQUdMLE1BQU07Ozs7OztBQUpOLHFCQUFTLEdBQUcsR0FBRztBQUNmLGlCQUFLLEdBQUcsZUFBZSxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUU7O0FBQ3pDLGdDQUFJLEtBQUssQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDOztBQUU5QyxrQkFBTSxHQUFHLFNBQVQsTUFBTTtrQkFzQkosS0FBSzs7OztBQXJCVCx3QkFBSSxDQUFDLGFBQWEsR0FBRyxvQkFBSyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQzs7O3FEQUU5QyxJQUFJLENBQUMsYUFBYTs7Ozs7Ozs7OzswQkFFcEIsMEJBQWUsc0JBQVEsaUJBQWlCLENBQUE7Ozs7Ozs7O3dCQVF6QyxJQUFJLENBQUMsUUFBUTs7Ozs7QUFDaEIsd0NBQUksS0FBSyxDQUFDLHFEQUFxRCxDQUFDLENBQUM7Ozs7eUJBSS9ELG9CQUFFLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQzs7Ozs7O3FEQUM1QixrQkFBa0IsRUFBRTs7OztxREFHVixJQUFJLENBQUMsZ0JBQWdCLEVBQUU7OztBQUFyQyx5QkFBSzs7MEJBR0wsS0FBSyxJQUFLLElBQUksQ0FBQyxVQUFVLEdBQUcsQ0FBQyxJQUFJLEFBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLEdBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDOzs7OztBQUMxRSx3Q0FBSSxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDM0Isd0JBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDOzs7OztBQUV6Qix3Q0FBSSxLQUFLLENBQUMsOEJBQThCLENBQUMsQ0FBQzs7cURBQ3BDLE1BQU0sRUFBRTs7Ozs7OzthQUVqQjs7OzZDQUNLLE1BQU0sRUFBRTs7Ozs7OztLQUNmOzs7V0FFb0I7Ozs7QUFDbkIsZ0NBQUksS0FBSyxDQUFDLGlEQUFpRCxDQUFDLENBQUM7QUFDN0QsZ0JBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO0FBQ3pCLGdCQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7QUFDdEIsa0JBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUM7YUFDN0I7Ozs7Ozs7S0FDRjs7O1dBRWdCOzs7O0FBQ2YsZ0NBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDNUIsZ0JBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDOzs2Q0FDbEIsSUFBSSxDQUFDLFVBQVUsRUFBRTs7Ozs7OztLQUN4Qjs7O1dBRWdCLG9CQUFDLGVBQWUsRUFBRSxrQkFBa0I7Ozs7QUFDbkQsZ0NBQUksS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7OzZDQUMxQixJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsRUFBRSxrQkFBa0IsQ0FBQzs7Ozs7OztLQUN6RDs7O1dBRXNCO1VBQ2pCLE1BQU0sRUFJSixRQUFRLEVBQ1YsVUFBVTs7OztBQUxWLGtCQUFNLEdBQUcsMEJBQVksRUFBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBQyxDQUFDOztpQkFDL0MsTUFBTTs7Ozs7a0JBQVEsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDOzs7OztBQUVuQyxnQ0FBSSxLQUFLLENBQUMsOEJBQThCLENBQUMsQ0FBQztBQUNwQyxvQkFBUSxHQUFHLGdEQUFnRDtBQUM3RCxzQkFBVSxHQUFHLFNBQVM7Ozs2Q0FFTCxzQkFBUSxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDOzs7QUFBL0Ysc0JBQVU7Ozs7Ozs7O2dCQUVKLDBCQUFlLHNCQUFRLFlBQVk7Ozs7Ozs7O0FBR3pDLGdDQUFJLEtBQUssMkNBQXlDLElBQUksQ0FBQyxnQkFBZ0IsUUFBSyxDQUFDO2dEQUN0RSxLQUFLOzs7QUFFZCxnQ0FBSSxLQUFLLHFCQUFtQiw4QkFBZ0IsVUFBVSxDQUFDLENBQUcsQ0FBQzs7Z0RBRXBELFVBQVUsS0FBSyxVQUFVOzs7Ozs7O0tBQ2pDOzs7V0FFYyxrQkFBQyxHQUFHLEVBQUUsa0JBQWtCO1VBRy9CLE1BQU07Ozs7a0JBRFIsSUFBSSxDQUFDLFlBQVksS0FBSyxjQUFjLENBQUMsWUFBWSxDQUFBOzs7OztBQUMvQyxrQkFBTSxHQUFHLDBCQUFZLEVBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUMsQ0FBQzs7aUJBQzFFLE1BQU07Ozs7O2tCQUFRLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQzs7Ozs7QUFHckMsZ0NBQUksS0FBSyw2QkFBMkIsR0FBRyxDQUFHLENBQUM7OzZDQUNyQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7QUFDbEMsaUJBQUcsRUFBSCxHQUFHO0FBQ0gsc0JBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtBQUN2Qix1QkFBUyxFQUFFLElBQUksQ0FBQyxTQUFTO0FBQ3pCLDBCQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVk7YUFDaEMsQ0FBQzs7O2dCQUVHLElBQUksQ0FBQyxZQUFZOzs7Ozs7NkNBRWQsc0JBQVEsS0FBSyxDQUFDLElBQUksQ0FBQzs7O2tCQUd2QixJQUFJLENBQUMsWUFBWSxLQUFLLGNBQWMsQ0FBQyxZQUFZLENBQUE7Ozs7Ozs2Q0FDN0MsSUFBSSxDQUFDLHFCQUFxQixFQUFFOzs7OzZDQUU5QixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxrQkFBa0IsQ0FBQzs7Ozs7OztLQUN0RDs7O1dBRTJCOzs7Ozs7Z0RBQ25CLDBCQUFZLG9CQUFPLE9BQU8sRUFBRSxNQUFNO2tCQUVuQyxPQUFPLEVBSVAsZ0JBQWdCLEVBYWQsT0FBTzs7Ozs7O0FBbEJiLHdDQUFJLEtBQUssQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDO0FBQ2hELDJCQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRTs7QUFJcEIsb0NBQWdCLEdBQUcsU0FBbkIsZ0JBQWdCLENBQUksS0FBSyxFQUFLO0FBQ2hDLDBDQUFJLEtBQUsseUJBQXdCLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLE9BQU8sQ0FBQSxHQUFFLElBQUksMEJBQXNCLEtBQUssQ0FBRyxDQUFDO0FBQzNGLDBCQUFJLE9BQUssZUFBZSxFQUFFO0FBQ3hCLCtCQUFLLGVBQWUsQ0FBQyxNQUFNLEVBQUUsQ0FBQzt1QkFDL0I7QUFDRCw2QkFBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO3FCQUNoQjs7QUFDRCx3QkFBSSxDQUFDLFNBQVMsQ0FBQyx3QkFBd0IsQ0FBQyxxQkFBcUIsRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQzs7Ozs7MEJBSXJGLENBQUMsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsQ0FBQTs7Ozs7QUFFeEMsMkJBQU8sR0FBRyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxVQUFVLEdBQUcsR0FBRzs7QUFDdkQsd0JBQUksQ0FBQyxlQUFlLEdBQUcsb0JBQUssZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7OztxREFFOUMsSUFBSSxDQUFDLGVBQWU7OztBQUMxQixvQ0FBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQzs7Ozs7Ozs7Ozs7OzthQU9qQyxDQUFDOzs7Ozs7O0tBQ0g7Ozs7Ozs7V0FFbUIsdUJBQUMsRUFBRTs7OztBQUNyQixnQ0FBSSxLQUFLLENBQUMsaUNBQWlDLENBQUMsQ0FBQztBQUM3QyxnQkFBSSxDQUFDLFNBQVMsQ0FBQyx1QkFBdUIsQ0FBQyxFQUFFLENBQUMsQ0FBQzs7NkNBQzlCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRTtBQUNoRCxzQkFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO0FBQ3ZCLHVCQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7QUFDekIsMEJBQVksRUFBRSxJQUFJLENBQUMsWUFBWTthQUNoQyxDQUFDOzs7Ozs7Ozs7O0tBQ0g7OztXQUVrQjs7OztBQUNqQixnQ0FBSSxLQUFLLENBQUMsaUNBQWlDLENBQUMsQ0FBQzs7NkNBQ3ZDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRTtBQUN4QyxzQkFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO0FBQ3ZCLHVCQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7QUFDekIsMEJBQVksRUFBRSxJQUFJLENBQUMsWUFBWTthQUNoQyxDQUFDOzs7Ozs7O0tBQ0g7OztXQUVrQixzQkFBQyxFQUFFOzs7O0FBQ3BCLGdDQUFJLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO0FBQ3ZELGdCQUFJLENBQUMsU0FBUyxDQUFDLHlCQUF5QixDQUFDLEVBQUUsQ0FBQyxDQUFDOzs2Q0FDaEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO0FBQy9DLHNCQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7QUFDdkIsdUJBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztBQUN6QiwwQkFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO2FBQ2hDLENBQUM7Ozs7Ozs7Ozs7S0FDSDs7O1dBRWlCOzs7O0FBQ2hCLGdDQUFJLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDOzs2Q0FDakQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFO0FBQ3ZDLHNCQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7QUFDdkIsdUJBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztBQUN6QiwwQkFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO2FBQ2hDLENBQUM7Ozs7Ozs7S0FDSDs7O1dBRWtCLHNCQUFDLEVBQUU7Ozs7QUFDcEIsZ0NBQUksS0FBSyxDQUFDLHVDQUF1QyxDQUFDLENBQUM7QUFDbkQsZ0JBQUksQ0FBQyxTQUFTLENBQUMseUJBQXlCLENBQUMsRUFBRSxDQUFDLENBQUM7OzZDQUNoQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUU7QUFDL0Msc0JBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtBQUN2Qix1QkFBUyxFQUFFLElBQUksQ0FBQyxTQUFTO0FBQ3pCLDBCQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVk7YUFDaEMsQ0FBQzs7Ozs7Ozs7OztLQUNIOzs7V0FFaUI7Ozs7QUFDaEIsZ0NBQUksS0FBSyxDQUFDLHVDQUF1QyxDQUFDLENBQUM7OzZDQUM3QyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUU7QUFDdkMsc0JBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtBQUN2Qix1QkFBUyxFQUFFLElBQUksQ0FBQyxTQUFTO0FBQ3pCLDBCQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVk7YUFDaEMsQ0FBQzs7Ozs7OztLQUNIOzs7V0FFYSxpQkFBQyxPQUFPLEVBQUUsUUFBUTtVQVN4QixNQUFNLEVBU1IsR0FBRzs7OztrQkFoQkgsSUFBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLFFBQVEsQ0FBQTs7Ozs7QUFDL0IsZ0NBQUksS0FBSyxDQUFDLDJDQUEyQyxDQUFDLENBQUM7OzZDQUNqRCxJQUFJLENBQUMsVUFBVSxFQUFFOzs7a0JBSXJCLElBQUksQ0FBQyxZQUFZLEtBQUssY0FBYyxDQUFDLFlBQVksQ0FBQTs7Ozs7QUFDL0Msa0JBQU0sR0FBRywwQkFBWSxFQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFDLENBQUM7O2lCQUMxRSxNQUFNOzs7OztrQkFBUSxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUM7OztpQkFHakMsSUFBSSxDQUFDLHVCQUF1Qjs7Ozs7OzZDQUN4QixJQUFJLENBQUMsY0FBYyxFQUFFOzs7O0FBRzdCLGdDQUFJLEtBQUssaUNBQStCLG9CQUFFLFFBQVEsQ0FBQyxPQUFPLEVBQUUsRUFBQyxNQUFNLEVBQUUsRUFBRSxFQUFDLENBQUMsQ0FBRyxDQUFDOzs2Q0FDN0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFO0FBQ25ELHFCQUFPLEVBQVAsT0FBTztBQUNQLHNCQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7QUFDdkIsdUJBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztBQUN6QiwwQkFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO2FBQ2hDLENBQUM7OztBQUxFLGVBQUc7Z0RBT0EsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUM7Ozs7Ozs7S0FDL0I7OztXQUVrQixzQkFBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLElBQUk7VUFDN0IsTUFBTSxFQVFOLEdBQUc7Ozs7QUFSSCxrQkFBTSxHQUFHLDBCQUFZLEVBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUMsQ0FBQzs7aUJBQzFFLE1BQU07Ozs7O2tCQUFRLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQzs7O2lCQUUvQixJQUFJLENBQUMsdUJBQXVCOzs7Ozs7NkNBQ3hCLElBQUksQ0FBQyxjQUFjLEVBQUU7Ozs7QUFHN0IsZ0NBQUksS0FBSyxDQUFDLDZCQUE2QixDQUFDLENBQUM7OzZDQUN6QixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtBQUNwRCxtQkFBSyxFQUFMLEtBQUs7QUFDTCxnQkFBRSxFQUFGLEVBQUU7QUFDRixrQkFBSSxFQUFKLElBQUk7QUFDSixzQkFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO0FBQ3ZCLHVCQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7QUFDekIsMEJBQVksRUFBRSxJQUFJLENBQUMsWUFBWTthQUNoQyxDQUFDOzs7QUFQRSxlQUFHO2dEQVNBLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDOzs7Ozs7O0tBQy9COzs7V0FFYSx1QkFBQyxHQUFHLEVBQUU7QUFDbEIsVUFBSSxvQkFBRSxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQUU7QUFDdEIsY0FBTSxJQUFJLEtBQUssOERBQTRELG9CQUFFLFFBQVEsQ0FBQyw4QkFBZ0IsR0FBRyxDQUFDLEVBQUUsRUFBQyxNQUFNLEVBQUUsbUJBQW1CLEVBQUMsQ0FBQyxDQUFHLENBQUM7T0FDL0ksTUFBTSxJQUFJLG9CQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtBQUMxQixZQUFJO0FBQ0YsYUFBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDdkIsQ0FBQyxPQUFPLEdBQUcsRUFBRTs7O1NBR2I7T0FDRixNQUFNLElBQUksQ0FBQyxvQkFBRSxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7QUFDM0IsZ0JBQU0sSUFBSSxLQUFLLG1DQUFpQyxPQUFPLEdBQUcsUUFBSyxDQUFDO1NBQ2pFOztBQUVELFVBQUksR0FBRyxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTs7QUFFbEMsY0FBTSxxQ0FBYyxHQUFHLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztPQUNqRTs7OztBQUlELGFBQU8sR0FBRyxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQztLQUN0RDs7O1dBRTRCLHdDQUFlO1VBQWQsS0FBSyx5REFBRyxJQUFJOztBQUN4QyxVQUFJLENBQUMsU0FBUyxDQUFDLDRCQUE0QixDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ3BEOzs7V0FFZ0Isb0JBQUMsSUFBSTs7OztBQUNwQixnQ0FBSSxLQUFLLENBQUMseUJBQXlCLENBQUMsQ0FBQzs7NkNBQ3hCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtBQUM3QyxzQkFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO0FBQ3ZCLHVCQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7QUFDekIsMEJBQVksRUFBRSxJQUFJLENBQUMsWUFBWTtBQUMvQixrQkFBSSxFQUFKLElBQUk7YUFDTCxDQUFDOzs7Ozs7Ozs7O0tBQ0g7OztXQUVrQixzQkFBQyxVQUFVLEVBQUUsR0FBRzs7OztBQUNqQyxnQ0FBSSxLQUFLLHdCQUFxQixVQUFVLGdCQUFTLEdBQUcsUUFBSSxDQUFDOzs2Q0FDNUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFO0FBQy9DLHNCQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7QUFDdkIsdUJBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztBQUN6QiwwQkFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO0FBQy9CLHdCQUFVLEVBQVYsVUFBVTtBQUNWLGlCQUFHLEVBQUgsR0FBRzthQUNKLENBQUM7Ozs7Ozs7Ozs7S0FDSDs7O1dBRW9CO1VBQUMsU0FBUyx5REFBRyx1QkFBdUI7VUFFakQsTUFBTTs7OztBQURaLGdDQUFJLEtBQUssOEJBQTRCLFNBQVMsZ0JBQWEsQ0FBQztBQUN0RCxrQkFBTSxHQUFHLDBCQUFZO0FBQ3pCLHNCQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7QUFDdkIsdUJBQVMsRUFBRSxJQUFJLENBQUMsU0FBUzthQUMxQixDQUFDOztpQkFDRSxNQUFNOzs7OztBQUNSLGdDQUFJLEtBQUssMENBQTBDLENBQUM7Ozs7OzZDQUloRCxzQkFBUSxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7QUFDMUQsc0JBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtBQUN2Qix1QkFBUyxFQUFFLElBQUksQ0FBQyxTQUFTO0FBQ3pCLDBCQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVk7YUFDaEMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUNyQixJQUFJLENBQUMsWUFBWTs7QUFDaEIsa0NBQUksS0FBSyxpQ0FBaUMsQ0FBQzthQUM1QyxDQUFDLFNBQU0sQ0FBQyxVQUFVLEdBQUcsRUFBRTs7QUFDdEIsa0JBQUksR0FBRyxZQUFZLHNCQUFRLFlBQVksRUFBRTtBQUN2QyxvQ0FBSSxLQUFLLHlDQUF1QyxTQUFTLFFBQUssQ0FBQztlQUNoRSxNQUFNO0FBQ0wsb0NBQUksS0FBSyxpQ0FBK0IsR0FBRyxDQUFDLE9BQU8sQ0FBRyxDQUFDO2VBQ3hEO2FBQ0YsQ0FBQzs7Ozs7OztLQUNIOzs7U0ExcUJHLGNBQWM7R0FBUyxvQkFBTyxZQUFZOztBQThxQmhELGNBQWMsQ0FBQyxpQkFBaUIsR0FBRyw2QkFBNkIsQ0FBQztBQUNqRSxjQUFjLENBQUMscUJBQXFCLEdBQUcsaUNBQWlDLENBQUM7QUFDekUsY0FBYyxDQUFDLGdCQUFnQixHQUFHLDRCQUE0QixDQUFDOzs7Ozs7OztBQUcvRCxxQ0FBNEIsb0JBQUUsT0FBTyw4QkFBaUIsaUhBQUU7OztRQUE5QyxLQUFJO1FBQUUsT0FBTzs7QUFDckIsa0JBQWMsQ0FBQyxTQUFTLENBQUMsS0FBSSxDQUFDLEdBQUcsT0FBTyxDQUFDO0dBQzFDOzs7Ozs7Ozs7Ozs7Ozs7O1FBRVEsY0FBYyxHQUFkLGNBQWM7UUFBRSxjQUFjLEdBQWQsY0FBYztRQUFFLG9CQUFvQixHQUFwQixvQkFBb0I7UUFBRSx1QkFBdUIsR0FBdkIsdUJBQXVCIiwiZmlsZSI6ImxpYi9yZW1vdGUtZGVidWdnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0cmFuc3BpbGU6bWFpblxuaW1wb3J0IGV2ZW50cyBmcm9tICdldmVudHMnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBlcnJvckZyb21Db2RlIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBSZW1vdGVEZWJ1Z2dlclJwY0NsaWVudCBmcm9tICcuL3JlbW90ZS1kZWJ1Z2dlci1ycGMtY2xpZW50JztcbmltcG9ydCBtZXNzYWdlSGFuZGxlcnMgZnJvbSAnLi9tZXNzYWdlLWhhbmRsZXJzJztcbmltcG9ydCB7IGFwcEluZm9Gcm9tRGljdCwgcGFnZUFycmF5RnJvbURpY3QsIGdldERlYnVnZ2VyQXBwS2V5LCBnZXRQb3NzaWJsZURlYnVnZ2VyQXBwS2V5cywgY2hlY2tQYXJhbXMsXG4gICAgICAgICBnZXRTY3JpcHRGb3JBdG9tLCBzaW1wbGVTdHJpbmdpZnksIGRlZmVycmVkUHJvbWlzZSB9IGZyb20gJy4vaGVscGVycyc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcblxuXG5jb25zdCBERUJVR0dFUl9UWVBFUyA9IHtcbiAgd2Via2l0OiAxLFxuICB3ZWJpbnNwZWN0b3I6IDJcbn07XG5jb25zdCBTRUxFQ1RfQVBQX1JFVFJJRVMgPSAyMDtcbmNvbnN0IFJFTU9URV9ERUJVR0dFUl9QT1JUID0gMjc3NTM7XG5cbi8qIEhvdyBtYW55IG1pbGxpc2Vjb25kcyB0byB3YWl0IGZvciB3ZWJraXQgdG8gcmV0dXJuIGEgcmVzcG9uc2UgYmVmb3JlIHRpbWluZyBvdXQgKi9cbmNvbnN0IFJQQ19SRVNQT05TRV9USU1FT1VUX01TID0gNTAwMDtcblxuY29uc3QgUEFHRV9SRUFEWV9USU1FT1VUID0gNTAwMDtcblxuY29uc3QgUkVTUE9OU0VfTE9HX0xFTkdUSCA9IDEwMDtcblxuY29uc3QgR0FSQkFHRV9DT0xMRUNUX1RJTUVPVVQgPSA1MDAwO1xuXG5cbmNsYXNzIFJlbW90ZURlYnVnZ2VyIGV4dGVuZHMgZXZlbnRzLkV2ZW50RW1pdHRlciB7XG4gIC8qXG4gICAqIFRoZSBjb25zdHJ1Y3RvciB0YWtlcyBhbiBvcHRzIGhhc2ggd2l0aCB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6XG4gICAqICAgLSBidW5kbGVJZCAtIGlkIG9mIHRoZSBhcHAgYmVpbmcgY29ubmVjdGVkIHRvXG4gICAqICAgLSBwbGF0Zm9ybVZlcnNpb24gLSB2ZXJzaW9uIG9mIGlPU1xuICAgKiAgIC0gZGVidWdnZXJUeXBlIC0gb25lIG9mIHRoZSBERUJVR0dFUl9UWVBFU1xuICAgKiAgIC0gdXNlTmV3U2FmYXJpIC0gZm9yIHdlYiBpbnNwZWN0b3IsIHdoZXRoZXIgdGhpcyBpcyBhIG5ldyBTYWZhcmkgaW5zdGFuY2VcbiAgICogICAtIHBhZ2VMb2FkTXMgLSB0aGUgdGltZSwgaW4gbXMsIHRoYXQgc2hvdWxkIGJlIHdhaXRlZCBmb3IgcGFnZSBsb2FkaW5nXG4gICAqICAgLSBob3N0IC0gdGhlIHJlbW90ZSBkZWJ1Z2dlcidzIGhvc3QgYWRkcmVzc1xuICAgKiAgIC0gcG9ydCAtIHRoZSByZW1vdGUgZGVidWdnZXIgcG9ydCB0aHJvdWdoIHdoaWNoIHRvIGNvbW11bmljYXRlXG4gICAqL1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgc3VwZXIoKTtcblxuICAgIGNvbnN0IHtcbiAgICAgIGJ1bmRsZUlkLFxuICAgICAgcGxhdGZvcm1WZXJzaW9uLFxuICAgICAgZGVidWdnZXJUeXBlID0gREVCVUdHRVJfVFlQRVMud2ViaW5zcGVjdG9yLFxuICAgICAgdXNlTmV3U2FmYXJpID0gZmFsc2UsXG4gICAgICBwYWdlTG9hZE1zLFxuICAgICAgaG9zdCxcbiAgICAgIHBvcnQgPSBSRU1PVEVfREVCVUdHRVJfUE9SVCxcbiAgICAgIHNvY2tldFBhdGgsXG4gICAgICBwYWdlUmVhZHlUaW1lb3V0ID0gUEFHRV9SRUFEWV9USU1FT1VULFxuICAgICAgcmVtb3RlRGVidWdQcm94eSxcbiAgICAgIGdhcmJhZ2VDb2xsZWN0T25FeGVjdXRlID0gdHJ1ZSxcbiAgICB9ID0gb3B0cztcblxuICAgIHRoaXMuYnVuZGxlSWQgPSBidW5kbGVJZDtcbiAgICB0aGlzLnBsYXRmb3JtVmVyc2lvbiA9IHBsYXRmb3JtVmVyc2lvbjtcbiAgICB0aGlzLmRlYnVnZ2VyVHlwZSA9IGRlYnVnZ2VyVHlwZTtcbiAgICBpZiAodGhpcy5kZWJ1Z2dlclR5cGUgPT09IERFQlVHR0VSX1RZUEVTLndlYmluc3BlY3Rvcikge1xuICAgICAgdGhpcy51c2VOZXdTYWZhcmkgPSB1c2VOZXdTYWZhcmk7XG4gICAgICB0aGlzLnBhZ2VMb2FkTXMgPSBwYWdlTG9hZE1zO1xuICAgICAgbG9nLmRlYnVnKGB1c2VOZXdTYWZhcmkgLS0+ICR7dGhpcy51c2VOZXdTYWZhcml9YCk7XG4gICAgfVxuICAgIHRoaXMuZ2FyYmFnZUNvbGxlY3RPbkV4ZWN1dGUgPSBnYXJiYWdlQ29sbGVjdE9uRXhlY3V0ZTtcblxuICAgIHRoaXMuaG9zdCA9IGhvc3Q7XG4gICAgdGhpcy5wb3J0ID0gcG9ydDtcbiAgICB0aGlzLnNvY2tldFBhdGggPSBzb2NrZXRQYXRoO1xuICAgIHRoaXMucmVtb3RlRGVidWdQcm94eSA9IHJlbW90ZURlYnVnUHJveHk7XG4gICAgdGhpcy5wYWdlUmVhZHlUaW1lb3V0ID0gcGFnZVJlYWR5VGltZW91dDtcbiAgfVxuXG4gIHNldHVwICgpIHtcbiAgICAvLyBhcHAgaGFuZGxpbmcgY29uZmlndXJhdGlvblxuICAgIHRoaXMuYXBwRGljdCA9IHt9O1xuICAgIHRoaXMuYXBwSWRLZXkgPSBudWxsO1xuICAgIHRoaXMucGFnZUlkS2V5ID0gbnVsbDtcbiAgICB0aGlzLnBhZ2VMb2FkaW5nID0gZmFsc2U7XG5cbiAgICAvLyBzZXQgdXAgdGhlIHNwZWNpYWwgY2FsbGJhY2tzIGZvciBoYW5kbGluZyByZCBldmVudHNcbiAgICB0aGlzLnNwZWNpYWxDYnMgPSB7XG4gICAgICAnX3JwY19yZXBvcnRJZGVudGlmaWVyOic6IF8ubm9vcCxcbiAgICAgICdfcnBjX2ZvcndhcmRHZXRMaXN0aW5nOic6IHRoaXMub25QYWdlQ2hhbmdlLmJpbmQodGhpcyksXG4gICAgICAnX3JwY19yZXBvcnRDb25uZWN0ZWRBcHBsaWNhdGlvbkxpc3Q6JzogXy5ub29wLFxuICAgICAgJ19ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6JzogdGhpcy5vbkFwcENvbm5lY3QuYmluZCh0aGlzKSxcbiAgICAgICdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOic6IHRoaXMub25BcHBEaXNjb25uZWN0LmJpbmQodGhpcyksXG4gICAgICAnX3JwY19hcHBsaWNhdGlvblVwZGF0ZWQ6JzogdGhpcy5vbkFwcFVwZGF0ZS5iaW5kKHRoaXMpLFxuICAgICAgJ19ycGNfcmVwb3J0Q29ubmVjdGVkRHJpdmVyTGlzdDonOiB0aGlzLm9uUmVwb3J0RHJpdmVyTGlzdC5iaW5kKHRoaXMpLFxuICAgICAgJ3BhZ2VMb2FkJzogdGhpcy5wYWdlTG9hZC5iaW5kKHRoaXMpLFxuICAgICAgJ2ZyYW1lRGV0YWNoZWQnOiB0aGlzLmZyYW1lRGV0YWNoZWQuYmluZCh0aGlzKSxcbiAgICB9O1xuXG4gICAgdGhpcy5ycGNDbGllbnQgPSBudWxsO1xuICB9XG5cbiAgdGVhcmRvd24gKCkge1xuICAgIGxvZy5kZWJ1ZygnQ2xlYW5pbmcgdXAgbGlzdGVuZXJzJyk7XG5cbiAgICB0aGlzLmFwcERpY3QgPSB7fTtcbiAgICB0aGlzLmFwcElkS2V5ID0gbnVsbDtcbiAgICB0aGlzLnBhZ2VJZEtleSA9IG51bGw7XG4gICAgdGhpcy5wYWdlTG9hZGluZyA9IGZhbHNlO1xuXG4gICAgdGhpcy5zcGVjaWFsQ2JzID0ge307XG5cbiAgICB0aGlzLnJwY0NsaWVudCA9IG51bGw7XG5cbiAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycyhSZW1vdGVEZWJ1Z2dlci5FVkVOVF9QQUdFX0NIQU5HRSk7XG4gICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoUmVtb3RlRGVidWdnZXIuRVZFTlRfRElTQ09OTkVDVCk7XG4gIH1cblxuICBhc3luYyBjb25uZWN0ICgpIHtcbiAgICB0aGlzLnNldHVwKCk7XG5cbiAgICAvLyBpbml0aWFsaXplIHRoZSBycGMgY2xpZW50XG4gICAgdGhpcy5ycGNDbGllbnQgPSBuZXcgUmVtb3RlRGVidWdnZXJScGNDbGllbnQoe1xuICAgICAgaG9zdDogdGhpcy5ob3N0LFxuICAgICAgcG9ydDogdGhpcy5wb3J0LFxuICAgICAgc29ja2V0UGF0aDogdGhpcy5zb2NrZXRQYXRoLFxuICAgICAgc3BlY2lhbE1lc3NhZ2VIYW5kbGVyczogdGhpcy5zcGVjaWFsQ2JzLFxuICAgICAgbWVzc2FnZVByb3h5OiB0aGlzLnJlbW90ZURlYnVnUHJveHksXG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5ycGNDbGllbnQuY29ubmVjdCgpO1xuXG4gICAgLy8gZ2V0IHRoZSBjb25uZWN0aW9uIGluZm9ybWF0aW9uIGFib3V0IHRoZSBhcHBcbiAgICB0cnkge1xuICAgICAgbGV0IGFwcEluZm8gPSBhd2FpdCB0aGlzLnNldENvbm5lY3Rpb25LZXkoKTtcbiAgICAgIGxvZy5kZWJ1ZygnQ29ubmVjdGVkIHRvIGFwcGxpY2F0aW9uJyk7XG4gICAgICByZXR1cm4gYXBwSW5mbztcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGlzY29ubmVjdCgpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGlzY29ubmVjdCAoKSB7XG4gICAgYXdhaXQgdGhpcy5ycGNDbGllbnQuZGlzY29ubmVjdCgpO1xuICAgIHRoaXMuZW1pdChSZW1vdGVEZWJ1Z2dlci5FVkVOVF9ESVNDT05ORUNULCB0cnVlKTtcbiAgICB0aGlzLnRlYXJkb3duKCk7XG4gIH1cblxuICBpc0Nvbm5lY3RlZCAoKSB7XG4gICAgcmV0dXJuICEhKHRoaXMucnBjQ2xpZW50ICYmIHRoaXMucnBjQ2xpZW50LmlzQ29ubmVjdGVkKCkpO1xuICB9XG5cbiAgbG9nQXBwbGljYXRpb25EaWN0aW9uYXJ5IChhcHBzKSB7XG4gICAgZnVuY3Rpb24gZ2V0VmFsdWVTdHJpbmcgKGtleSwgdmFsdWUpIHtcbiAgICAgIGlmIChfLmlzRnVuY3Rpb24odmFsdWUpKSB7XG4gICAgICAgIHJldHVybiAnW0Z1bmN0aW9uXSc7XG4gICAgICB9XG4gICAgICBpZiAoa2V5ID09PSAncGFnZURpY3QnICYmICFfLmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgIHJldHVybiAnXCJXYWl0aW5nIGZvciBkYXRhXCInO1xuICAgICAgfVxuICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKCdDdXJyZW50IGFwcGxpY2F0aW9ucyBhdmFpbGFibGU6Jyk7XG4gICAgZm9yIChsZXQgW2FwcCwgaW5mb10gb2YgXy50b1BhaXJzKGFwcHMpKSB7XG4gICAgICBsb2cuZGVidWcoYCAgICBBcHBsaWNhdGlvbjogJyR7YXBwfSdgKTtcbiAgICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBfLnRvUGFpcnMoaW5mbykpIHtcbiAgICAgICAgbGV0IHZhbHVlU3RyaW5nID0gZ2V0VmFsdWVTdHJpbmcoa2V5LCB2YWx1ZSk7XG4gICAgICAgIGxvZy5kZWJ1ZyhgICAgICAgICAke2tleX06ICR7dmFsdWVTdHJpbmd9YCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2V0Q29ubmVjdGlvbktleSAoKSB7XG4gICAgLy8gb25seSByZXNvbHZlIHdoZW4gdGhlIGNvbm5lY3Rpb24gcmVzcG9uc2UgaXMgcmVjZWl2ZWRcbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gbG9jYWwgY2FsbGJhY2ssIGNhbGxlZCB3aGVuIHRoZSByZW1vdGUgZGVidWdnZXIgaGFzIGVzdGFibGlzaGVkXG4gICAgICAvLyBhIGNvbm5lY3Rpb24gdG8gdGhlIGFwcCB1bmRlciB0ZXN0XG4gICAgICAvLyBgYXBwYCB3aWxsIGJlIGFuIGFycmF5IG9mIGRpY3Rpb25hcmllcyBvZiBhcHAgaW5mb3JtYXRpb25cbiAgICAgIGxldCBjb25uZWN0Q2IgPSAoYXBwcykgPT4ge1xuICAgICAgICBpZiAoXy5pc1VuZGVmaW5lZChhcHBzKSB8fCBfLmtleXMoYXBwcykubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKCdSZWNlaXZlZCBubyBhcHBzIGZyb20gcmVtb3RlIGRlYnVnZ2VyLiBVbmFibGUgdG8gY29ubmVjdC4nKTtcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZSh0aGlzLmFwcERpY3QpO1xuICAgICAgICB9XG4gICAgICAgIGxldCBuZXdEaWN0ID0ge307XG5cbiAgICAgICAgLy8gdHJhbnNsYXRlIHRoZSByZWNlaXZlZCBpbmZvcm1hdGlvbiBpbnRvIGFuIGVhc2llci10by1tYW5hZ2VcbiAgICAgICAgLy8gaGFzaCB3aXRoIGFwcCBpZCBhcyBrZXksIGFuZCBhcHAgaW5mbyBhcyB2YWx1ZVxuICAgICAgICBmb3IgKGxldCBkaWN0IG9mIF8udmFsdWVzKGFwcHMpKSB7XG4gICAgICAgICAgbGV0IFtpZCwgZW50cnldID0gYXBwSW5mb0Zyb21EaWN0KGRpY3QpO1xuICAgICAgICAgIG5ld0RpY3RbaWRdID0gZW50cnk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gdXBkYXRlIHRoZSBvYmplY3QncyBsaXN0IG9mIGFwcHMsIGFuZCByZXR1cm4gaXQgdGhyb3VnaCB0aGUgcHJvbWlzZVxuICAgICAgICBfLmRlZmF1bHRzKHRoaXMuYXBwRGljdCwgbmV3RGljdCk7XG4gICAgICAgIHJlc29sdmUobmV3RGljdCk7XG4gICAgICB9O1xuICAgICAgdGhpcy5ycGNDbGllbnQuc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKCdfcnBjX3JlcG9ydENvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdDonLCByZWplY3QsIGNvbm5lY3RDYik7XG5cbiAgICAgIGxvZy5kZWJ1ZygnU2VuZGluZyBjb25uZWN0aW9uIGtleSByZXF1ZXN0Jyk7XG4gICAgICByZXR1cm4gKGFzeW5jICgpID0+IHtcbiAgICAgICAgbGV0IFtzaW1OYW1lS2V5LCBzaW1CdWlsZEtleSwgc2ltUGxhdGZvcm1WZXJzaW9uXSA9IGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ3NldENvbm5lY3Rpb25LZXknKTtcbiAgICAgICAgbG9nLmRlYnVnKGBTaW0gbmFtZTogJHtzaW1OYW1lS2V5fWApO1xuICAgICAgICBsb2cuZGVidWcoYFNpbSBidWlsZDogJHtzaW1CdWlsZEtleX1gKTtcbiAgICAgICAgbG9nLmRlYnVnKGBTaW0gcGxhdGZvcm0gdmVyc2lvbjogJHtzaW1QbGF0Zm9ybVZlcnNpb259YCk7XG4gICAgICB9KSgpO1xuICAgIH0pO1xuICB9XG5cbiAgdXBkYXRlQXBwc1dpdGhEaWN0IChkaWN0KSB7XG4gICAgLy8gZ2V0IHRoZSBkaWN0aW9uYXJ5IGVudHJ5IGludG8gYSBuaWNlIGZvcm0sIGFuZCBhZGQgaXQgdG8gdGhlXG4gICAgLy8gYXBwbGljYXRpb24gZGljdGlvbmFyeVxuICAgIHRoaXMuYXBwRGljdCA9IHRoaXMuYXBwRGljdCB8fCB7fTtcbiAgICBsZXQgW2lkLCBlbnRyeV0gPSBhcHBJbmZvRnJvbURpY3QoZGljdCk7XG4gICAgaWYgKHRoaXMuYXBwRGljdFtpZF0pIHtcbiAgICAgIC8vIHByZXNlcnZlIHRoZSBwYWdlIGRpY3Rpb25hcnkgZm9yIHRoaXMgZW50cnlcbiAgICAgIGVudHJ5LnBhZ2VEaWN0ID0gdGhpcy5hcHBEaWN0W2lkXS5wYWdlRGljdDtcbiAgICB9XG4gICAgdGhpcy5hcHBEaWN0W2lkXSA9IGVudHJ5O1xuXG4gICAgLy8gYWRkIGEgcHJvbWlzZSB0byBnZXQgdGhlIHBhZ2UgZGljdGlvbmFyeVxuICAgIGlmIChfLmlzVW5kZWZpbmVkKGVudHJ5LnBhZ2VEaWN0KSkge1xuICAgICAgZW50cnkucGFnZURpY3QgPSBkZWZlcnJlZFByb21pc2UoKTtcbiAgICB9XG5cbiAgICAvLyB0cnkgdG8gZ2V0IHRoZSBhcHAgaWQgZnJvbSBvdXIgY29ubmVjdGVkIGFwcHNcbiAgICBpZiAoIXRoaXMuYXBwSWRLZXkpIHtcbiAgICAgIHRoaXMuYXBwSWRLZXkgPSBnZXREZWJ1Z2dlckFwcEtleSh0aGlzLmJ1bmRsZUlkLCB0aGlzLnBsYXRmb3JtVmVyc2lvbiwgdGhpcy5hcHBEaWN0KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzZWxlY3RBcHAgKGN1cnJlbnRVcmwgPSBudWxsLCBtYXhUcmllcyA9IFNFTEVDVF9BUFBfUkVUUklFUywgaWdub3JlQWJvdXRCbGFua1VybCA9IGZhbHNlKSB7XG4gICAgbG9nLmRlYnVnKCdTZWxlY3RpbmcgYXBwbGljYXRpb24nKTtcbiAgICBpZiAoIXRoaXMuYXBwRGljdCB8fCBfLmtleXModGhpcy5hcHBEaWN0KS5sZW5ndGggPT09IDApIHtcbiAgICAgIGxvZy5kZWJ1ZygnTm8gYXBwbGljYXRpb25zIGN1cnJlbnRseSBjb25uZWN0ZWQuJyk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgLy8gaXRlcmF0aXZlIHNvbHV0aW9uLCBhcyByZWN1cnNpb24gd2FzIHN3YWxsb3dpbmcgdGhlIHByb21pc2UgYXQgc29tZSBwb2ludFxuICAgIGxldCBwYWdlRGljdCwgYXBwSWRLZXk7XG4gICAgYXBwTG9vcDogZm9yIChsZXQgaSA9IDA7IGkgPCBtYXhUcmllczsgaSsrKSB7XG4gICAgICB0aGlzLmxvZ0FwcGxpY2F0aW9uRGljdGlvbmFyeSh0aGlzLmFwcERpY3QpO1xuICAgICAgbGV0IHBvc3NpYmxlQXBwSWRzID0gZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXModGhpcy5idW5kbGVJZCwgdGhpcy5wbGF0Zm9ybVZlcnNpb24sIHRoaXMuYXBwRGljdCk7XG4gICAgICBsb2cuZGVidWcoYFRyeWluZyBvdXQgdGhlIHBvc3NpYmxlIGFwcCBpZHM6ICR7cG9zc2libGVBcHBJZHMuam9pbignLCAnKX1gKTtcbiAgICAgIGZvciAobGV0IGF0dGVtcHRlZEFwcElkS2V5IG9mIHBvc3NpYmxlQXBwSWRzKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBTZWxlY3RpbmcgYXBwICR7YXR0ZW1wdGVkQXBwSWRLZXl9ICh0cnkgIyR7aSsxfSBvZiAke21heFRyaWVzfSlgKTtcbiAgICAgICAgICBbYXBwSWRLZXksIHBhZ2VEaWN0XSA9IGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbGVjdEFwcChhdHRlbXB0ZWRBcHBJZEtleSwgdGhpcy5vbkFwcENvbm5lY3QuYmluZCh0aGlzKSk7XG4gICAgICAgICAgLy8gaW4gaU9TIDguMiB0aGUgY29ubmVjdCBsb2dpYyBoYXBwZW5zLCBidXQgd2l0aCBhbiBlbXB0eSBkaWN0aW9uYXJ5XG4gICAgICAgICAgLy8gd2hpY2ggbGVhZHMgdG8gdGhlIHJlbW90ZSBkZWJ1Z2dlciBnZXR0aW5nIGRpc2Nvbm5lY3RlZCwgYW5kIGludG8gYSBsb29wXG4gICAgICAgICAgaWYgKF8uaXNFbXB0eShwYWdlRGljdCkpIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnRW1wdHkgcGFnZSBkaWN0aW9uYXJ5IHJlY2VpdmVkLiBUcnlpbmcgYWdhaW4uJyk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBzYXZlIHRoZSBwYWdlIGFycmF5IGZvciB0aGlzIGFwcFxuICAgICAgICAgIHRoaXMuYXBwRGljdFthcHBJZEtleV0ucGFnZURpY3QgPSBwYWdlQXJyYXlGcm9tRGljdChwYWdlRGljdCk7XG5cbiAgICAgICAgICAvLyBpZiB3ZSBhcmUgbG9va2luZyBmb3IgYSBwYXJ0aWN1bGFyIHVybCwgbWFrZSBzdXJlIHdlIGhhdmUgdGhlIHJpZ2h0IHBhZ2UuIElnbm9yZSBlbXB0eSBvciB1bmRlZmluZWQgdXJscy4gSWdub3JlIGFib3V0OmJsYW5rIGlmIHJlcXVlc3RlZC5cbiAgICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTtcbiAgICAgICAgICBkaWN0TG9vcDogZm9yIChjb25zdCBhcHBEaWN0IG9mIF8udmFsdWVzKHRoaXMuYXBwRGljdCkpIHtcbiAgICAgICAgICAgIGlmIChmb3VuZCkgYnJlYWs7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcblxuICAgICAgICAgICAgaWYgKCFhcHBEaWN0IHx8ICFhcHBEaWN0LnBhZ2VEaWN0KSB7XG4gICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBpZiB0aGUgcGFnZSBkaWN0aW9uYXJ5IGhhcyBub3QgYmVlbiBsb2FkZWQgeWV0IGZyb20gdGhlIHdlYlxuICAgICAgICAgICAgLy8gaW5zcGVjdG9yLCB3YWl0IGZvciBpdCBvciB0aW1lIG91dCBhZnRlciAxMHNcbiAgICAgICAgICAgIGlmIChhcHBEaWN0LnBhZ2VEaWN0LnByb21pc2UpIHtcbiAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBhd2FpdCBQcm9taXNlLnJlc29sdmUoYXBwRGljdC5wYWdlRGljdC5wcm9taXNlKS50aW1lb3V0KDEwMDAwKTtcbiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgaWYgKCEoZXJyIGluc3RhbmNlb2YgUHJvbWlzZS5UaW1lb3V0RXJyb3IpKSB7XG4gICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIG9uIHRpbWVvdXQsIGp1c3QgZ28gb25cbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGRpY3Qgb2YgKGFwcERpY3QucGFnZURpY3QgfHwgW10pKSB7XG4gICAgICAgICAgICAgIGlmICgoIWlnbm9yZUFib3V0QmxhbmtVcmwgfHwgZGljdC51cmwgIT09ICdhYm91dDpibGFuaycpICYmICghY3VycmVudFVybCB8fCBkaWN0LnVybCA9PT0gY3VycmVudFVybCkpIHtcbiAgICAgICAgICAgICAgICAvLyBzYXZlIHdoZXJlIHdlIGZvdW5kIHRoZSByaWdodCBwYWdlXG4gICAgICAgICAgICAgICAgYXBwSWRLZXkgPSBhcHBEaWN0LmlkO1xuICAgICAgICAgICAgICAgIHBhZ2VEaWN0ID0gZGljdDtcbiAgICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWsgZGljdExvb3A7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCFmb3VuZCkge1xuICAgICAgICAgICAgaWYgKGN1cnJlbnRVcmwpIHtcbiAgICAgICAgICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCBhcHAsIGJ1dCBleHBlY3RlZCB1cmwgKCcke2N1cnJlbnRVcmx9Jykgd2FzIG5vdCBmb3VuZC4gVHJ5aW5nIGFnYWluLmApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgbG9nLmRlYnVnKCdSZWNlaXZlZCBhcHAsIGJ1dCBubyBtYXRjaCB3YXMgZm91bmQuIFRyeWluZyBhZ2Fpbi4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBhZ2VEaWN0ID0gbnVsbDtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIHdlIGhhdmUgZ290dGVuIHRoZSBjb3JyZWN0IGFwcGxpY2F0aW9uIGJ5IHRoaXMgcG9pbnQsIHNvIHNob3J0IGNpcmN1aXQgZXZlcnl0aGluZ1xuICAgICAgICAgIGJyZWFrIGFwcExvb3A7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgRXJyb3IgY2hlY2tpbmcgYXBwbGljYXRpb246ICcke2Vyci5tZXNzYWdlfScuIFJldHJ5aW5nIGNvbm5lY3Rpb25gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGlmLCBhZnRlciBhbGwgdGhpcywgd2UgaGF2ZSBubyBkaWN0aW9uYXJ5LCB3ZSBoYXZlIGZhaWxlZFxuICAgIGlmICghcGFnZURpY3QpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgY29ubmVjdCB0byBhIHZhbGlkIGFwcCBhZnRlciAke21heFRyaWVzfSB0cmllcy5gKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5hcHBJZEtleSAhPT0gYXBwSWRLZXkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgYWx0ZXJlZCBhcHAgaWQsIHVwZGF0aW5nIGZyb20gJyR7dGhpcy5hcHBJZEtleX0nIHRvICcke2FwcElkS2V5fSdgKTtcbiAgICAgIHRoaXMuYXBwSWRLZXkgPSBhcHBJZEtleTtcbiAgICB9XG5cbiAgICAvLyB3YWl0IGZvciBhbGwgdGhlIHByb21pc2VzIGFyZSBiYWNrLCBvciAzMHMgcGFzc2VzXG4gICAgY29uc3QgcGFnZVByb21pc2VzID0gT2JqZWN0LnZhbHVlcyh0aGlzLmFwcERpY3QpXG4gICAgICAuZmlsdGVyKChhcHApID0+ICEhYXBwLnBhZ2VEaWN0ICYmICEhYXBwLnBhZ2VEaWN0LnByb21pc2UpXG4gICAgICAubWFwKChhcHApID0+IGFwcC5wYWdlRGljdC5wcm9taXNlKTtcbiAgICBpZiAocGFnZVByb21pc2VzLmxlbmd0aCkge1xuICAgICAgbG9nLmRlYnVnKGBXYWl0aW5nIGZvciAke3BhZ2VQcm9taXNlcy5sZW5ndGh9IHBhZ2VzIHRvIGJlIGZ1bGZpbGxlZGApO1xuICAgICAgYXdhaXQgUHJvbWlzZS5hbnkoW1Byb21pc2UuZGVsYXkoMzAwMDApLCBQcm9taXNlLmFsbChwYWdlUHJvbWlzZXMpXSk7XG4gICAgfVxuXG4gICAgLy8gdHJhbnNsYXRlIHRoZSBkaWN0aW9uYXJ5IGludG8gYSB1c2VmdWwgZm9ybSwgYW5kIHJldHVybiB0byBzZW5kZXJcbiAgICBsZXQgcGFnZUFycmF5ID0gcGFnZUFycmF5RnJvbURpY3QocGFnZURpY3QpO1xuICAgIGxvZy5kZWJ1ZyhgRmluYWxseSBzZWxlY3RpbmcgYXBwICR7dGhpcy5hcHBJZEtleX06ICR7c2ltcGxlU3RyaW5naWZ5KHBhZ2VBcnJheSl9YCk7XG5cbiAgICBsZXQgZnVsbFBhZ2VBcnJheSA9IFtdO1xuICAgIGZvciAobGV0IFthcHAsIGluZm9dIG9mIF8udG9QYWlycyh0aGlzLmFwcERpY3QpKSB7XG4gICAgICBpZiAoIV8uaXNBcnJheShpbmZvLnBhZ2VEaWN0KSkgY29udGludWU7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICAgIGxldCBpZCA9IGFwcC5yZXBsYWNlKCdQSUQ6JywgJycpO1xuICAgICAgZm9yIChsZXQgcGFnZSBvZiBpbmZvLnBhZ2VEaWN0KSB7XG4gICAgICAgIGlmIChwYWdlLnVybCAmJiAoIWlnbm9yZUFib3V0QmxhbmtVcmwgfHwgcGFnZS51cmwgIT09ICdhYm91dDpibGFuaycpICYmICghY3VycmVudFVybCB8fCBwYWdlLnVybCA9PT0gY3VycmVudFVybCkpIHtcbiAgICAgICAgICBsZXQgcGFnZURpY3QgPSBfLmNsb25lKHBhZ2UpO1xuICAgICAgICAgIHBhZ2VEaWN0LmlkID0gYCR7aWR9LiR7cGFnZURpY3QuaWR9YDtcbiAgICAgICAgICBmdWxsUGFnZUFycmF5LnB1c2gocGFnZURpY3QpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGZ1bGxQYWdlQXJyYXk7XG4gIH1cblxuICBhc3luYyBzZWxlY3RQYWdlIChhcHBJZEtleSwgcGFnZUlkS2V5LCBza2lwUmVhZHlDaGVjayA9IGZhbHNlKSB7XG4gICAgdGhpcy5hcHBJZEtleSA9IGBQSUQ6JHthcHBJZEtleX1gO1xuICAgIHRoaXMucGFnZUlkS2V5ID0gcGFnZUlkS2V5O1xuXG4gICAgbG9nLmRlYnVnKGBTZWxlY3RpbmcgcGFnZSAnJHtwYWdlSWRLZXl9JyBvbiBhcHAgJyR7dGhpcy5hcHBJZEtleX0nIGFuZCBmb3J3YXJkaW5nIHNvY2tldCBzZXR1cGApO1xuXG4gICAgYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnc2V0U2VuZGVyS2V5Jywge1xuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5XG4gICAgfSk7XG4gICAgbG9nLmRlYnVnKCdTZW5kZXIga2V5IHNldCcpO1xuXG4gICAgYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnZW5hYmxlUGFnZScsIHtcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICAgIGRlYnVnZ2VyVHlwZTogdGhpcy5kZWJ1Z2dlclR5cGVcbiAgICB9KTtcbiAgICBsb2cuZGVidWcoJ0VuYWJsZWQgYWN0aXZpdHkgb24gcGFnZScpO1xuXG4gICAgLy8gbWFrZSBzdXJlIGV2ZXJ5dGhpbmcgaXMgcmVhZHkgdG8gZ29cbiAgICBsZXQgcmVhZHkgPSBhd2FpdCB0aGlzLmNoZWNrUGFnZUlzUmVhZHkoKTtcbiAgICBpZiAoIXNraXBSZWFkeUNoZWNrICYmICFyZWFkeSkge1xuICAgICAgYXdhaXQgdGhpcy5wYWdlVW5sb2FkKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZUF0b20gKGF0b20sIGFyZ3MsIGZyYW1lcykge1xuICAgIGlmICghdGhpcy5ycGNDbGllbnQuY29ubmVjdGVkKSB0aHJvdyBuZXcgRXJyb3IoJ1JlbW90ZSBkZWJ1Z2dlciBpcyBub3QgY29ubmVjdGVkJyk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcblxuICAgIGxldCBzY3JpcHQgPSBhd2FpdCBnZXRTY3JpcHRGb3JBdG9tKGF0b20sIGFyZ3MsIGZyYW1lcyk7XG5cbiAgICBsZXQgdmFsdWUgPSBhd2FpdCB0aGlzLmV4ZWN1dGUoc2NyaXB0LCB0cnVlKTtcbiAgICBsb2cuZGVidWcoYFJlY2VpdmVkIHJlc3VsdCBmb3IgYXRvbSAnJHthdG9tfScgZXhlY3V0aW9uOiAke18udHJ1bmNhdGUoc2ltcGxlU3RyaW5naWZ5KHZhbHVlKSwge2xlbmd0aDogUkVTUE9OU0VfTE9HX0xFTkdUSH0pfWApO1xuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIGFzeW5jIGV4ZWN1dGVBdG9tQXN5bmMgKGF0b20sIGFyZ3MsIGZyYW1lcywgcmVzcG9uc2VVcmwpIHtcbiAgICBsZXQgYXN5bmNDYWxsQmFjayA9IGBmdW5jdGlvbiAocmVzKSB7IHhtbEh0dHAgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgeG1sSHR0cC5vcGVuKCdQT1NUJywgJyR7cmVzcG9uc2VVcmx9JywgdHJ1ZSk7YCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgeG1sSHR0cC5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LXR5cGUnLCdhcHBsaWNhdGlvbi9qc29uJyk7IGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgYHhtbEh0dHAuc2VuZChyZXMpOyB9YDtcbiAgICBsZXQgc2NyaXB0ID0gYXdhaXQgZ2V0U2NyaXB0Rm9yQXRvbShhdG9tLCBhcmdzLCBmcmFtZXMsIGFzeW5jQ2FsbEJhY2spO1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZShzY3JpcHQpO1xuICB9XG5cbiAgYXN5bmMgZnJhbWVEZXRhY2hlZCAoKSB7XG4gICAgdGhpcy5lbWl0KFJlbW90ZURlYnVnZ2VyLkVWRU5UX0ZSQU1FU19ERVRBQ0hFRCk7XG4gIH1cblxuICBhc3luYyBwYWdlTG9hZCAoc3RhcnRQYWdlTG9hZE1zLCBwYWdlTG9hZFZlcmlmeUhvb2spIHtcbiAgICBsZXQgdGltZW91dE1zID0gNTAwO1xuICAgIGxldCBzdGFydCA9IHN0YXJ0UGFnZUxvYWRNcyB8fCBEYXRlLm5vdygpO1xuICAgIGxvZy5kZWJ1ZygnUGFnZSBsb2FkZWQsIHZlcmlmeWluZyB3aGV0aGVyIHJlYWR5Jyk7XG5cbiAgICBsZXQgdmVyaWZ5ID0gYXN5bmMgKCkgPT4ge1xuICAgICAgdGhpcy5wYWdlTG9hZERlbGF5ID0gdXRpbC5jYW5jZWxsYWJsZURlbGF5KHRpbWVvdXRNcyk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnBhZ2VMb2FkRGVsYXk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgaWYgKGVyciBpbnN0YW5jZW9mIFByb21pc2UuQ2FuY2VsbGF0aW9uRXJyb3IpIHtcbiAgICAgICAgICAvLyBpZiB0aGUgcHJvbWlzZSBoYXMgYmVlbiBjYW5jZWxsZWRcbiAgICAgICAgICAvLyB3ZSB3YW50IHRvIHNraXAgY2hlY2tpbmcgdGhlIHJlYWRpbmVzc1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyB3ZSBjYW4gZ2V0IHRoaXMgY2FsbGVkIGluIHRoZSBtaWRkbGUgb2YgdHJ5aW5nIHRvIGZpbmQgYSBuZXcgYXBwXG4gICAgICBpZiAoIXRoaXMuYXBwSWRLZXkpIHtcbiAgICAgICAgbG9nLmRlYnVnKCdOb3QgY29ubmVjdGVkIHRvIGFuIGFwcGxpY2F0aW9uLiBJZ25vcmluZyBwYWdlIGxvYWQnKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpZiAoXy5pc0Z1bmN0aW9uKHBhZ2VMb2FkVmVyaWZ5SG9vaykpIHtcbiAgICAgICAgYXdhaXQgcGFnZUxvYWRWZXJpZnlIb29rKCk7XG4gICAgICB9XG5cbiAgICAgIGxldCByZWFkeSA9IGF3YWl0IHRoaXMuY2hlY2tQYWdlSXNSZWFkeSgpO1xuXG4gICAgICAvLyBpZiB3ZSBhcmUgcmVhZHksIG9yIHdlJ3ZlIHNwZW5kIHRvbyBtdWNoIHRpbWUgb24gdGhpc1xuICAgICAgaWYgKHJlYWR5IHx8ICh0aGlzLnBhZ2VMb2FkTXMgPiAwICYmIChzdGFydCArIHRoaXMucGFnZUxvYWRNcykgPCBEYXRlLm5vdygpKSkge1xuICAgICAgICBsb2cuZGVidWcoJ1BhZ2UgaXMgcmVhZHknKTtcbiAgICAgICAgdGhpcy5wYWdlTG9hZGluZyA9IGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmRlYnVnKCdQYWdlIHdhcyBub3QgcmVhZHksIHJldHJ5aW5nJyk7XG4gICAgICAgIGF3YWl0IHZlcmlmeSgpO1xuICAgICAgfVxuICAgIH07XG4gICAgYXdhaXQgdmVyaWZ5KCk7XG4gIH1cblxuICBhc3luYyBjYW5jZWxQYWdlTG9hZCAoKSB7XG4gICAgbG9nLmRlYnVnKCdVbnJlZ2lzdGVyaW5nIGZyb20gcGFnZSByZWFkaW5lc3Mgbm90aWZpY2F0aW9ucycpO1xuICAgIHRoaXMucGFnZUxvYWRpbmcgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5wYWdlTG9hZERlbGF5KSB7XG4gICAgICB0aGlzLnBhZ2VMb2FkRGVsYXkuY2FuY2VsKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcGFnZVVubG9hZCAoKSB7XG4gICAgbG9nLmRlYnVnKCdQYWdlIHVubG9hZGluZycpO1xuICAgIHRoaXMucGFnZUxvYWRpbmcgPSB0cnVlO1xuICAgIGF3YWl0IHRoaXMud2FpdEZvckRvbSgpO1xuICB9XG5cbiAgYXN5bmMgd2FpdEZvckRvbSAoc3RhcnRQYWdlTG9hZE1zLCBwYWdlTG9hZFZlcmlmeUhvb2spIHtcbiAgICBsb2cuZGVidWcoJ1dhaXRpbmcgZm9yIGRvbS4uLicpO1xuICAgIGF3YWl0IHRoaXMucGFnZUxvYWQoc3RhcnRQYWdlTG9hZE1zLCBwYWdlTG9hZFZlcmlmeUhvb2spO1xuICB9XG5cbiAgYXN5bmMgY2hlY2tQYWdlSXNSZWFkeSAoKSB7XG4gICAgbGV0IGVycm9ycyA9IGNoZWNrUGFyYW1zKHthcHBJZEtleTogdGhpcy5hcHBJZEtleX0pO1xuICAgIGlmIChlcnJvcnMpIHRocm93IG5ldyBFcnJvcihlcnJvcnMpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG5cbiAgICBsb2cuZGVidWcoJ0NoZWNraW5nIGRvY3VtZW50IHJlYWR5U3RhdGUnKTtcbiAgICBjb25zdCByZWFkeUNtZCA9ICcoZnVuY3Rpb24gKCl7IHJldHVybiBkb2N1bWVudC5yZWFkeVN0YXRlOyB9KSgpJztcbiAgICBsZXQgcmVhZHlTdGF0ZSA9ICdsb2FkaW5nJztcbiAgICB0cnkge1xuICAgICAgcmVhZHlTdGF0ZSA9IGF3YWl0IFByb21pc2UucmVzb2x2ZSh0aGlzLmV4ZWN1dGUocmVhZHlDbWQsIHRydWUpKS50aW1lb3V0KHRoaXMucGFnZVJlYWR5VGltZW91dCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoIShlcnIgaW5zdGFuY2VvZiBQcm9taXNlLlRpbWVvdXRFcnJvcikpIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGBQYWdlIHJlYWRpbmVzcyBjaGVjayB0aW1lZCBvdXQgYWZ0ZXIgJHt0aGlzLnBhZ2VSZWFkeVRpbWVvdXR9bXNgKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGByZWFkeVN0YXRlIHdhcyAke3NpbXBsZVN0cmluZ2lmeShyZWFkeVN0YXRlKX1gKTtcblxuICAgIHJldHVybiByZWFkeVN0YXRlID09PSAnY29tcGxldGUnO1xuICB9XG5cbiAgYXN5bmMgbmF2VG9VcmwgKHVybCwgcGFnZUxvYWRWZXJpZnlIb29rKSB7XG4gICAgLy8gbm8gbmVlZCB0byBkbyB0aGlzIGNoZWNrIHdoZW4gdXNpbmcgd2Via2l0XG4gICAgaWYgKHRoaXMuZGVidWdnZXJUeXBlID09PSBERUJVR0dFUl9UWVBFUy53ZWJpbnNwZWN0b3IpIHtcbiAgICAgIGxldCBlcnJvcnMgPSBjaGVja1BhcmFtcyh7YXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXl9KTtcbiAgICAgIGlmIChlcnJvcnMpIHRocm93IG5ldyBFcnJvcihlcnJvcnMpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKGBOYXZpZ2F0aW5nIHRvIG5ldyBVUkw6ICR7dXJsfWApO1xuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ3NldFVybCcsIHtcbiAgICAgIHVybCxcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICAgIGRlYnVnZ2VyVHlwZTogdGhpcy5kZWJ1Z2dlclR5cGVcbiAgICB9KTtcblxuICAgIGlmICghdGhpcy51c2VOZXdTYWZhcmkpIHtcbiAgICAgIC8vIGEgc21hbGwgcGF1c2UgZm9yIHRoZSBicm93c2VyIHRvIGNhdGNoIHVwXG4gICAgICBhd2FpdCBQcm9taXNlLmRlbGF5KDEwMDApO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmRlYnVnZ2VyVHlwZSA9PT0gREVCVUdHRVJfVFlQRVMud2ViaW5zcGVjdG9yKSB7XG4gICAgICBhd2FpdCB0aGlzLndhaXRGb3JGcmFtZU5hdmlnYXRlZCgpO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLndhaXRGb3JEb20oRGF0ZS5ub3coKSwgcGFnZUxvYWRWZXJpZnlIb29rKTtcbiAgfVxuXG4gIGFzeW5jIHdhaXRGb3JGcmFtZU5hdmlnYXRlZCAoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGxvZy5kZWJ1ZygnV2FpdGluZyBmb3IgZnJhbWUgbmF2aWdhdGVkIG1lc3NhZ2UuLi4nKTtcbiAgICAgIGxldCBzdGFydE1zID0gRGF0ZS5ub3coKTtcblxuICAgICAgLy8gYWRkIGEgaGFuZGxlciBmb3IgdGhlIGBQYWdlLmZyYW1lTmF2aWdhdGVkYCBtZXNzYWdlXG4gICAgICAvLyBmcm9tIHRoZSByZW1vdGUgZGVidWdnZXJcbiAgICAgIGxldCBuYXZFdmVudExpc3RlbmVyID0gKHZhbHVlKSA9PiB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgRnJhbWUgbmF2aWdhdGVkIGluICR7KChEYXRlLm5vdygpIC0gc3RhcnRNcykvMTAwMCl9IHNlYyBmcm9tIHNvdXJjZTogJHt2YWx1ZX1gKTtcbiAgICAgICAgaWYgKHRoaXMubmF2aWdhdGlvbkRlbGF5KSB7XG4gICAgICAgICAgdGhpcy5uYXZpZ2F0aW9uRGVsYXkuY2FuY2VsKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICB9O1xuICAgICAgdGhpcy5ycGNDbGllbnQuc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKCdQYWdlLmZyYW1lTmF2aWdhdGVkJywgcmVqZWN0LCBuYXZFdmVudExpc3RlbmVyKTtcblxuICAgICAgLy8gdGltZW91dCwgaW4gY2FzZSByZW1vdGUgZGVidWdnZXIgZG9lc24ndCByZXNwb25kLFxuICAgICAgLy8gb3IgdGFrZXMgYSBsb25nIHRpbWVcbiAgICAgIGlmICghdGhpcy51c2VOZXdTYWZhcmkgfHwgdGhpcy5wYWdlTG9hZE1zID49IDApIHtcbiAgICAgICAgLy8gdXNlIHBhZ2VMb2FkTXMsIG9yIGEgc21hbGwgYW1vdW50IG9mIHRpbWVcbiAgICAgICAgbGV0IHRpbWVvdXQgPSB0aGlzLnVzZU5ld1NhZmFyaSA/IHRoaXMucGFnZUxvYWRNcyA6IDUwMDtcbiAgICAgICAgdGhpcy5uYXZpZ2F0aW9uRGVsYXkgPSB1dGlsLmNhbmNlbGxhYmxlRGVsYXkodGltZW91dCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5uYXZpZ2F0aW9uRGVsYXk7XG4gICAgICAgICAgbmF2RXZlbnRMaXN0ZW5lcigndGltZW91dCcpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAvLyBub3RoaW5nIHRvIGRvOiB3ZSBvbmx5IGdldCBoZXJlIGlmIHRoZSByZW1vdGUgZGVidWdnZXJcbiAgICAgICAgICAvLyBhbHJlYWR5IG5vdGlmaWVkIG9mIGZyYW1lIG5hdmlnYXRpb24sIGFuZCB0aGUgZGVsYXlcbiAgICAgICAgICAvLyB3YXMgY2FuY2VsbGVkXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0VGltZWxpbmUgKGZuKSB7XG4gICAgbG9nLmRlYnVnKCdTdGFydGluZyB0byByZWNvcmQgdGhlIHRpbWVsaW5lJyk7XG4gICAgdGhpcy5ycGNDbGllbnQuc2V0VGltZWxpbmVFdmVudEhhbmRsZXIoZm4pO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdzdGFydFRpbWVsaW5lJywge1xuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgICAgZGVidWdnZXJUeXBlOiB0aGlzLmRlYnVnZ2VyVHlwZVxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc3RvcFRpbWVsaW5lICgpIHtcbiAgICBsb2cuZGVidWcoJ1N0b3BwaW5nIHRvIHJlY29yZCB0aGUgdGltZWxpbmUnKTtcbiAgICBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdzdG9wVGltZWxpbmUnLCB7XG4gICAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICAgIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXksXG4gICAgICBkZWJ1Z2dlclR5cGU6IHRoaXMuZGVidWdnZXJUeXBlXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBzdGFydENvbnNvbGUgKGZuKSB7XG4gICAgbG9nLmRlYnVnKCdTdGFydGluZyB0byBsaXN0ZW4gZm9yIEphdmFTY3JpcHQgY29uc29sZScpO1xuICAgIHRoaXMucnBjQ2xpZW50LnNldENvbnNvbGVMb2dFdmVudEhhbmRsZXIoZm4pO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdzdGFydENvbnNvbGUnLCB7XG4gICAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICAgIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXksXG4gICAgICBkZWJ1Z2dlclR5cGU6IHRoaXMuZGVidWdnZXJUeXBlXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBzdG9wQ29uc29sZSAoKSB7XG4gICAgbG9nLmRlYnVnKCdTdG9wcGluZyB0byBsaXN0ZW4gZm9yIEphdmFTY3JpcHQgY29uc29sZScpO1xuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ3N0b3BDb25zb2xlJywge1xuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgICAgZGVidWdnZXJUeXBlOiB0aGlzLmRlYnVnZ2VyVHlwZVxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc3RhcnROZXR3b3JrIChmbikge1xuICAgIGxvZy5kZWJ1ZygnU3RhcnRpbmcgdG8gbGlzdGVuIGZvciBuZXR3b3JrIGV2ZW50cycpO1xuICAgIHRoaXMucnBjQ2xpZW50LnNldE5ldHdvcmtMb2dFdmVudEhhbmRsZXIoZm4pO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdzdGFydE5ldHdvcmsnLCB7XG4gICAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICAgIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXksXG4gICAgICBkZWJ1Z2dlclR5cGU6IHRoaXMuZGVidWdnZXJUeXBlXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBzdG9wTmV0d29yayAoKSB7XG4gICAgbG9nLmRlYnVnKCdTdG9wcGluZyB0byBsaXN0ZW4gZm9yIG5ldHdvcmsgZXZlbnRzJyk7XG4gICAgYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnc3RvcE5ldHdvcmsnLCB7XG4gICAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICAgIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXksXG4gICAgICBkZWJ1Z2dlclR5cGU6IHRoaXMuZGVidWdnZXJUeXBlXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBleGVjdXRlIChjb21tYW5kLCBvdmVycmlkZSkge1xuICAgIC8vIGlmIHRoZSBwYWdlIGlzIG5vdCBsb2FkZWQgeWV0LCB3YWl0IGZvciBpdFxuICAgIGlmICh0aGlzLnBhZ2VMb2FkaW5nICYmICFvdmVycmlkZSkge1xuICAgICAgbG9nLmRlYnVnKCdUcnlpbmcgdG8gZXhlY3V0ZSBidXQgcGFnZSBpcyBub3QgbG9hZGVkLicpO1xuICAgICAgYXdhaXQgdGhpcy53YWl0Rm9yRG9tKCk7XG4gICAgfVxuXG4gICAgLy8gbm8gbmVlZCB0byBjaGVjayBlcnJvcnMgaWYgaXQgaXMgd2Via2l0XG4gICAgaWYgKHRoaXMuZGVidWdnZXJUeXBlID09PSBERUJVR0dFUl9UWVBFUy53ZWJpbnNwZWN0b3IpIHtcbiAgICAgIGxldCBlcnJvcnMgPSBjaGVja1BhcmFtcyh7YXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXl9KTtcbiAgICAgIGlmIChlcnJvcnMpIHRocm93IG5ldyBFcnJvcihlcnJvcnMpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuZ2FyYmFnZUNvbGxlY3RPbkV4ZWN1dGUpIHtcbiAgICAgIGF3YWl0IHRoaXMuZ2FyYmFnZUNvbGxlY3QoKTtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYFNlbmRpbmcgamF2YXNjcmlwdCBjb21tYW5kICR7Xy50cnVuY2F0ZShjb21tYW5kLCB7bGVuZ3RoOiA1MH0pfWApO1xuICAgIGxldCByZXMgPSBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdzZW5kSlNDb21tYW5kJywge1xuICAgICAgY29tbWFuZCxcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICAgIGRlYnVnZ2VyVHlwZTogdGhpcy5kZWJ1Z2dlclR5cGVcbiAgICB9KTtcblxuICAgIHJldHVybiB0aGlzLmNvbnZlcnRSZXN1bHQocmVzKTtcbiAgfVxuXG4gIGFzeW5jIGNhbGxGdW5jdGlvbiAob2JqSWQsIGZuLCBhcmdzKSB7XG4gICAgbGV0IGVycm9ycyA9IGNoZWNrUGFyYW1zKHthcHBJZEtleTogdGhpcy5hcHBJZEtleSwgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleX0pO1xuICAgIGlmIChlcnJvcnMpIHRocm93IG5ldyBFcnJvcihlcnJvcnMpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG5cbiAgICBpZiAodGhpcy5nYXJiYWdlQ29sbGVjdE9uRXhlY3V0ZSkge1xuICAgICAgYXdhaXQgdGhpcy5nYXJiYWdlQ29sbGVjdCgpO1xuICAgIH1cblxuICAgIGxvZy5kZWJ1ZygnQ2FsbGluZyBqYXZhc2NyaXB0IGZ1bmN0aW9uJyk7XG4gICAgbGV0IHJlcyA9IGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ2NhbGxKU0Z1bmN0aW9uJywge1xuICAgICAgb2JqSWQsXG4gICAgICBmbixcbiAgICAgIGFyZ3MsXG4gICAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICAgIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXksXG4gICAgICBkZWJ1Z2dlclR5cGU6IHRoaXMuZGVidWdnZXJUeXBlXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5jb252ZXJ0UmVzdWx0KHJlcyk7XG4gIH1cblxuICBjb252ZXJ0UmVzdWx0IChyZXMpIHtcbiAgICBpZiAoXy5pc1VuZGVmaW5lZChyZXMpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYERpZCBub3QgZ2V0IE9LIHJlc3VsdCBmcm9tIHJlbW90ZSBkZWJ1Z2dlci4gUmVzdWx0IHdhczogJHtfLnRydW5jYXRlKHNpbXBsZVN0cmluZ2lmeShyZXMpLCB7bGVuZ3RoOiBSRVNQT05TRV9MT0dfTEVOR1RIfSl9YCk7XG4gICAgfSBlbHNlIGlmIChfLmlzU3RyaW5nKHJlcykpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJlcyA9IEpTT04ucGFyc2UocmVzKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyB3ZSBtaWdodCBnZXQgYSBzZXJpYWxpemVkIG9iamVjdCwgYnV0IHdlIG1pZ2h0IG5vdFxuICAgICAgICAvLyBpZiB3ZSBnZXQgaGVyZSwgaXQgaXMganVzdCBhIHZhbHVlXG4gICAgICB9XG4gICAgfSBlbHNlIGlmICghXy5pc09iamVjdChyZXMpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlc3VsdCBoYXMgdW5leHBlY3RlZCB0eXBlOiAoJHt0eXBlb2YgcmVzfSkuYCk7XG4gICAgfVxuXG4gICAgaWYgKHJlcy5zdGF0dXMgJiYgcmVzLnN0YXR1cyAhPT0gMCkge1xuICAgICAgLy8gd2UgZ290IHNvbWUgZm9ybSBvZiBlcnJvci5cbiAgICAgIHRocm93IGVycm9yRnJvbUNvZGUocmVzLnN0YXR1cywgcmVzLnZhbHVlLm1lc3NhZ2UgfHwgcmVzLnZhbHVlKTtcbiAgICB9XG5cbiAgICAvLyB3aXRoIGVpdGhlciBoYXZlIGFuIG9iamVjdCB3aXRoIGEgYHZhbHVlYCBwcm9wZXJ0eSAoZXZlbiBpZiBgbnVsbGApLFxuICAgIC8vIG9yIGEgcGxhaW4gb2JqZWN0XG4gICAgcmV0dXJuIHJlcy5oYXNPd25Qcm9wZXJ0eSgndmFsdWUnKSA/IHJlcy52YWx1ZSA6IHJlcztcbiAgfVxuXG4gIGFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQgKGFsbG93ID0gdHJ1ZSkge1xuICAgIHRoaXMucnBjQ2xpZW50LmFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQoYWxsb3cpO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q29va2llcyAodXJscykge1xuICAgIGxvZy5kZWJ1ZygnR2V0dGluZyBuZXR3b3JrIGNvb2tpZXMnKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnZ2V0Q29va2llcycsIHtcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICAgIGRlYnVnZ2VyVHlwZTogdGhpcy5kZWJ1Z2dlclR5cGUsXG4gICAgICB1cmxzLFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlQ29va2llIChjb29raWVOYW1lLCB1cmwpIHtcbiAgICBsb2cuZGVidWcoYERlbGV0aW5nIGNvb2tpZSAnJHtjb29raWVOYW1lfScgb24gJyR7dXJsfSdgKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnZGVsZXRlQ29va2llJywge1xuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgICAgZGVidWdnZXJUeXBlOiB0aGlzLmRlYnVnZ2VyVHlwZSxcbiAgICAgIGNvb2tpZU5hbWUsXG4gICAgICB1cmwsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBnYXJiYWdlQ29sbGVjdCAodGltZW91dE1zID0gR0FSQkFHRV9DT0xMRUNUX1RJTUVPVVQpIHtcbiAgICBsb2cuZGVidWcoYEdhcmJhZ2UgY29sbGVjdGluZyB3aXRoICR7dGltZW91dE1zfW1zIHRpbWVvdXRgKTtcbiAgICBjb25zdCBlcnJvcnMgPSBjaGVja1BhcmFtcyh7XG4gICAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICAgIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXksXG4gICAgfSk7XG4gICAgaWYgKGVycm9ycykge1xuICAgICAgbG9nLmRlYnVnKGBVbmFibGUgdG8gY29sbGVjdCBnYXJiYWdlIGF0IHRoaXMgdGltZWApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGF3YWl0IFByb21pc2UucmVzb2x2ZSh0aGlzLnJwY0NsaWVudC5zZW5kKCdnYXJiYWdlQ29sbGVjdCcsIHtcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICAgIGRlYnVnZ2VyVHlwZTogdGhpcy5kZWJ1Z2dlclR5cGVcbiAgICB9KSkudGltZW91dCh0aW1lb3V0TXMpXG4gICAgLnRoZW4oZnVuY3Rpb24gKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLXRoZW5cbiAgICAgIGxvZy5kZWJ1ZyhgR2FyYmFnZSBjb2xsZWN0aW9uIHN1Y2Nlc3NmdWxgKTtcbiAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzXG4gICAgICBpZiAoZXJyIGluc3RhbmNlb2YgUHJvbWlzZS5UaW1lb3V0RXJyb3IpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBHYXJiYWdlIGNvbGxlY3Rpb24gdGltZWQgb3V0IGFmdGVyICR7dGltZW91dE1zfW1zYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoYFVuYWJsZSB0byBjb2xsZWN0IGdhcmJhZ2U6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn1cblxuLy8gZXZlbnQgZW1pdHRlZCBwdWJsaWNhbGx5XG5SZW1vdGVEZWJ1Z2dlci5FVkVOVF9QQUdFX0NIQU5HRSA9ICdyZW1vdGVfZGVidWdnZXJfcGFnZV9jaGFuZ2UnO1xuUmVtb3RlRGVidWdnZXIuRVZFTlRfRlJBTUVTX0RFVEFDSEVEID0gJ3JlbW90ZV9kZWJ1Z2dlcl9mcmFtZXNfZGV0YWNoZWQnO1xuUmVtb3RlRGVidWdnZXIuRVZFTlRfRElTQ09OTkVDVCA9ICdyZW1vdGVfZGVidWdnZXJfZGlzY29ubmVjdCc7XG5cbi8vIGFkZCBnZW5lcmljIGNhbGxiYWNrc1xuZm9yIChsZXQgW25hbWUsIGhhbmRsZXJdIG9mIF8udG9QYWlycyhtZXNzYWdlSGFuZGxlcnMpKSB7XG4gIFJlbW90ZURlYnVnZ2VyLnByb3RvdHlwZVtuYW1lXSA9IGhhbmRsZXI7XG59XG5cbmV4cG9ydCB7IFJlbW90ZURlYnVnZ2VyLCBERUJVR0dFUl9UWVBFUywgUkVNT1RFX0RFQlVHR0VSX1BPUlQsIFJQQ19SRVNQT05TRV9USU1FT1VUX01TIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
