'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _remoteDebugger = require('./remote-debugger');

var _remoteMessages = require('./remote-messages');

var _remoteMessages2 = _interopRequireDefault(_remoteMessages);

var _ws = require('ws');

var _ws2 = _interopRequireDefault(_ws);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _helpers = require('./helpers');

var _es6Error = require('es6-error');

var _es6Error2 = _interopRequireDefault(_es6Error);

var _appiumSupport = require('appium-support');

var DATA_LOG_LENGTH = { length: 200 };

var WebKitRpcClient = (function (_events$EventEmitter) {
  _inherits(WebKitRpcClient, _events$EventEmitter);

  function WebKitRpcClient(host) {
    var port = arguments.length <= 1 || arguments[1] === undefined ? _remoteDebugger.REMOTE_DEBUGGER_PORT : arguments[1];
    var responseTimeout = arguments.length <= 2 || arguments[2] === undefined ? _remoteDebugger.RPC_RESPONSE_TIMEOUT_MS : arguments[2];

    _classCallCheck(this, WebKitRpcClient);

    _get(Object.getPrototypeOf(WebKitRpcClient.prototype), 'constructor', this).call(this);

    this.host = host || 'localhost';
    this.port = port;

    this.responseTimeout = responseTimeout;

    this.curMsgId = 0;

    this.dataHandlers = {};
    this.dataMethods = {};
    this.errorHandlers = {};
  }

  _createClass(WebKitRpcClient, [{
    key: 'connect',
    value: function connect(pageId) {
      return _regeneratorRuntime.async(function connect$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve, reject) {
              // we will only resolve this call when the socket is open
              // WebKit url
              var url = 'ws://' + _this.host + ':' + _this.port + '/devtools/page/' + pageId;
              _this.pageIdKey = pageId;

              // create and set up socket with appropriate event handlers
              _this.socket = new _ws2['default'](url);
              _this.socket.on('open', function () {
                _logger2['default'].debug('WebKit debugger web socket connected to url: ' + url);
                _this.connected = true;
                resolve();
              });
              _this.socket.on('close', function () {
                _logger2['default'].debug('WebKit remote debugger socket disconnected');
                _this.connected = false;
              });
              _this.socket.on('error', function (exception) {
                if (_this.connected) {
                  _logger2['default'].debug('WebKit debugger web socket error: ' + exception.message);
                  _this.connected = false;
                }

                reject(exception);
              });
              _this.socket.on('message', _this.receive.bind(_this));
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'disconnect',
    value: function disconnect() {
      _logger2['default'].debug('Disconnecting from WebKit remote debugger');
      if (this.isConnected()) {
        this.socket.close(1001);
      }
      this.connected = false;
    }
  }, {
    key: 'isConnected',
    value: function isConnected() {
      return this.socket !== null && this.connected;
    }
  }, {
    key: 'send',
    value: function send(command) {
      var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      var data, id;
      return _regeneratorRuntime.async(function send$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            data = (0, _remoteMessages2['default'])(command, _lodash2['default'].defaults({ connId: this.connId, senderId: this.senderId }, opts));

            _logger2['default'].debug('Sending WebKit data: ' + _lodash2['default'].truncate(JSON.stringify(data), DATA_LOG_LENGTH));
            _logger2['default'].debug('Webkit response timeout: ' + this.responseTimeout);

            this.curMsgId++;
            data.id = this.curMsgId;

            id = this.curMsgId.toString();
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve, reject) {
              // only resolve the send command when WebKit returns a response
              // store the handler and the data sent
              _this2.dataHandlers[id] = resolve;
              _this2.dataMethods[id] = data.method;
              _this2.errorHandlers[id] = reject;

              // send the data
              _this2.socket.send(JSON.stringify(data), function (error) {
                if (_appiumSupport.util.hasValue(error)) {
                  _logger2['default'].debug('WebKit socket error occurred: ' + error);
                  reject(new Error(error));
                }
              });
            })['catch'](function (e) {
              if (e.constructor.name !== WebKitRPCWarning.name) {
                throw e;
              }
              _logger2['default'].warn(e.message);
              return _bluebird2['default'].resolve(null);
            })['finally'](function (res) {
              // no need to hold onto anything
              delete _this2.dataHandlers[id];
              delete _this2.dataMethods[id];
              delete _this2.errorHandlers[id];

              // and pass along the result
              return res;
            }).timeout(this.responseTimeout));

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'receive',
    value: function receive(data) {
      var _this3 = this;

      _logger2['default'].debug('Received WebKit data: \'' + _lodash2['default'].truncate(data, DATA_LOG_LENGTH) + '\'');
      data = _appiumSupport.util.safeJsonParse(data);

      var rejectCall = function rejectCall(error) {
        if (data && _this3.errorHandlers[data.id]) {
          return _this3.errorHandlers[data.id](error);
        }

        if (error.constructor.name === WebKitRPCWarning.name) {
          _logger2['default'].warn(error.message);
        } else {
          _logger2['default'].errorAndThrow(error);
        }
      };

      if (!_lodash2['default'].isPlainObject(data)) {
        return rejectCall(new WebKitRPCWarning('No parseable data found'));
      }

      // we can get an error, or we can get a response that is an error
      if (data.wasThrown || data.result && data.result.wasThrown) {
        var message = data.wasThrown ? data.result.value || data.result.description : data.result.result.value || data.result.result.description;
        return rejectCall(new Error(message));
      }

      var msgId = data.id;
      // when sending we set a data method and associated callback.
      // get that, or the generic (automatically sent, not associated
      // with a particular request) method
      var method = this.dataMethods[msgId] || data.method;
      if (!method) {
        return rejectCall(new WebKitRPCWarning('Did not find any handlers for ' + (msgId ? '\'' + msgId + '\'' : 'the recent') + ' message'));
      }
      _logger2['default'].debug('Found method \'' + method + '\'' + (msgId ? ' for \'' + msgId + '\' message' : ''));
      var isEventHandled = false;
      switch (method) {
        case 'Profiler.resetProfiles':
          _logger2['default'].debug('Device is telling us to reset profiles. Should probably ' + 'do some kind of callback here');
          isEventHandled = true;
          break;
        case 'Timeline.eventRecorded':
          if (this.timelineEventHandler) {
            this.timelineEventHandler(data.result);
            isEventHandled = true;
          }
          break;
        case 'Console.messageAdded':
          if (this.consoleEventHandler) {
            this.consoleEventHandler(data.params.message);
            isEventHandled = true;
          }
          break;
        case 'Page.navigate':
          _logger2['default'].debug('Received page navigated message: ' + (0, _helpers.simpleStringify)(data));
          isEventHandled = true;
          break;
        case 'Network.dataReceived':
        case 'Network.requestWillBeSent':
        case 'Network.responseReceived':
        case 'Network.loadingFinished':
        case 'Network.loadingFailed':
          if (_lodash2['default'].isFunction(this.networkEventHandler)) {
            this.networkEventHandler(method, data.params);
            return;
          }
          break;
      }
      if (!data.error && _lodash2['default'].has(this.dataHandlers, msgId)) {
        return this.dataHandlers[msgId](data.result);
      }
      if (data.error && _lodash2['default'].has(this.errorHandlers, msgId)) {
        return this.errorHandlers[msgId](data.error);
      }
      if (!isEventHandled) {
        _logger2['default'].debug('There is no handler scheduled for method \'' + method + '\' in ' + (msgId ? '\'' + msgId + '\'' : 'the recent') + ' message');
      }
    }
  }, {
    key: 'setTimelineEventHandler',
    value: function setTimelineEventHandler(timelineEventHandler) {
      this.timelineEventHandler = timelineEventHandler;
    }
  }, {
    key: 'setConsoleLogEventHandler',
    value: function setConsoleLogEventHandler(consoleEventHandler) {
      this.consoleEventHandler = consoleEventHandler;
    }
  }, {
    key: 'setNetworkLogEventHandler',
    value: function setNetworkLogEventHandler(networkEventHandler) {
      this.networkEventHandler = networkEventHandler;
    }
  }]);

  return WebKitRpcClient;
})(_events2['default'].EventEmitter);

exports['default'] = WebKitRpcClient;

var WebKitRPCWarning = (function (_ES6Error) {
  _inherits(WebKitRPCWarning, _ES6Error);

  function WebKitRPCWarning() {
    _classCallCheck(this, WebKitRPCWarning);

    _get(Object.getPrototypeOf(WebKitRPCWarning.prototype), 'constructor', this).apply(this, arguments);
  }

  return WebKitRPCWarning;
})(_es6Error2['default']);

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJraXQtcnBjLWNsaWVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7c0JBQWdCLFVBQVU7Ozs7OEJBQ29DLG1CQUFtQjs7OEJBQ3BELG1CQUFtQjs7OztrQkFDMUIsSUFBSTs7Ozt3QkFDTixVQUFVOzs7O3NCQUNoQixRQUFROzs7O3NCQUNILFFBQVE7Ozs7dUJBQ0ssV0FBVzs7d0JBQ3RCLFdBQVc7Ozs7NkJBQ1gsZ0JBQWdCOztBQUdyQyxJQUFNLGVBQWUsR0FBRyxFQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUMsQ0FBQzs7SUFFakIsZUFBZTtZQUFmLGVBQWU7O0FBQ3RCLFdBRE8sZUFBZSxDQUNyQixJQUFJLEVBQTBFO1FBQXhFLElBQUk7UUFBeUIsZUFBZTs7MEJBRDVDLGVBQWU7O0FBRWhDLCtCQUZpQixlQUFlLDZDQUV4Qjs7QUFFUixRQUFJLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxXQUFXLENBQUM7QUFDaEMsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7O0FBRWpCLFFBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDOztBQUV2QyxRQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQzs7QUFFbEIsUUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7QUFDdkIsUUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7QUFDdEIsUUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUM7R0FDekI7O2VBZGtCLGVBQWU7O1dBZ0JwQixpQkFBQyxNQUFNOzs7Ozs7Z0RBQ1osMEJBQVksVUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFLOzs7QUFHdEMsa0JBQUksR0FBRyxhQUFXLE1BQUssSUFBSSxTQUFJLE1BQUssSUFBSSx1QkFBa0IsTUFBTSxBQUFFLENBQUM7QUFDbkUsb0JBQUssU0FBUyxHQUFHLE1BQU0sQ0FBQzs7O0FBR3hCLG9CQUFLLE1BQU0sR0FBRyxvQkFBYyxHQUFHLENBQUMsQ0FBQztB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LEtBQUssSUFBSSxvQkFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsRUFBRTtBQUNsRCxlQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO09BQzlDO0FBQ0QsVUFBSSxDQUFDLGNBQWMsRUFBRTtBQUNuQiw0QkFBSSxLQUFLLGlEQUE4QyxNQUFNLGVBQVEsS0FBSyxVQUFPLEtBQUssVUFBTSxZQUFZLENBQUEsY0FBVyxDQUFDO09BQ3JIO0tBQ0Y7OztXQUV1QixpQ0FBQyxvQkFBb0IsRUFBRTtBQUM3QyxVQUFJLENBQUMsb0JBQW9CLEdBQUcsb0JBQW9CLENBQUM7S0FDbEQ7OztXQUV5QixtQ0FBQyxtQkFBbUIsRUFBRTtBQUM5QyxVQUFJLENBQUMsbUJBQW1CLEdBQUcsbUJBQW1CLENBQUM7S0FDaEQ7OztXQUV5QixtQ0FBQyxtQkFBbUIsRUFBRTtBQUM5QyxVQUFJLENBQUMsbUJBQW1CLEdBQUcsbUJBQW1CLENBQUM7S0FDaEQ7OztTQWhNa0IsZUFBZTtHQUFTLG9CQUFPLFlBQVk7O3FCQUEzQyxlQUFlOztJQW9NOUIsZ0JBQWdCO1lBQWhCLGdCQUFnQjs7V0FBaEIsZ0JBQWdCOzBCQUFoQixnQkFBZ0I7OytCQUFoQixnQkFBZ0I7OztTQUFoQixnQkFBZ0IiLCJmaWxlIjoibGliL3dlYmtpdC1ycGMtY2xpZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBSRU1PVEVfREVCVUdHRVJfUE9SVCwgUlBDX1JFU1BPTlNFX1RJTUVPVVRfTVMgfSBmcm9tICcuL3JlbW90ZS1kZWJ1Z2dlcic7XG5pbXBvcnQgZ2V0UmVtb3RlQ29tbWFuZCBmcm9tICcuL3JlbW90ZS1tZXNzYWdlcyc7XG5pbXBvcnQgV2ViU29ja2V0IGZyb20gJ3dzJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgZXZlbnRzIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyBzaW1wbGVTdHJpbmdpZnkgfSBmcm9tICcuL2hlbHBlcnMnO1xuaW1wb3J0IEVTNkVycm9yIGZyb20gJ2VzNi1lcnJvcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuXG5cbmNvbnN0IERBVEFfTE9HX0xFTkdUSCA9IHtsZW5ndGg6IDIwMH07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdlYktpdFJwY0NsaWVudCBleHRlbmRzIGV2ZW50cy5FdmVudEVtaXR0ZXIge1xuICBjb25zdHJ1Y3RvciAoaG9zdCwgcG9ydCA9IFJFTU9URV9ERUJVR0dFUl9QT1JULCByZXNwb25zZVRpbWVvdXQgPSBSUENfUkVTUE9OU0VfVElNRU9VVF9NUykge1xuICAgIHN1cGVyKCk7XG5cbiAgICB0aGlzLmhvc3QgPSBob3N0IHx8ICdsb2NhbGhvc3QnO1xuICAgIHRoaXMucG9ydCA9IHBvcnQ7XG5cbiAgICB0aGlzLnJlc3BvbnNlVGltZW91dCA9IHJlc3BvbnNlVGltZW91dDtcblxuICAgIHRoaXMuY3VyTXNnSWQgPSAwO1xuXG4gICAgdGhpcy5kYXRhSGFuZGxlcnMgPSB7fTtcbiAgICB0aGlzLmRhdGFNZXRob2RzID0ge307XG4gICAgdGhpcy5lcnJvckhhbmRsZXJzID0ge307XG4gIH1cblxuICBhc3luYyBjb25uZWN0IChwYWdlSWQpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gd2Ugd2lsbCBvbmx5IHJlc29sdmUgdGhpcyBjYWxsIHdoZW4gdGhlIHNvY2tldCBpcyBvcGVuXG4gICAgICAvLyBXZWJLaXQgdXJsXG4gICAgICBsZXQgdXJsID0gYHdzOi8vJHt0aGlzLmhvc3R9OiR7dGhpcy5wb3J0fS9kZXZ0b29scy9wYWdlLyR7cGFnZUlkfWA7XG4gICAgICB0aGlzLnBhZ2VJZEtleSA9IHBhZ2VJZDtcblxuICAgICAgLy8gY3JlYXRlIGFuZCBzZXQgdXAgc29ja2V0IHdpdGggYXBwcm9wcmlhdGUgZXZlbnQgaGFuZGxlcnNcbiAgICAgIHRoaXMuc29ja2V0ID0gbmV3IFdlYlNvY2tldCh1cmwpO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ29wZW4nLCAoKSA9PiB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgV2ViS2l0IGRlYnVnZ2VyIHdlYiBzb2NrZXQgY29ubmVjdGVkIHRvIHVybDogJHt1cmx9YCk7XG4gICAgICAgIHRoaXMuY29ubmVjdGVkID0gdHJ1ZTtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnNvY2tldC5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgIGxvZy5kZWJ1ZygnV2ViS2l0IHJlbW90ZSBkZWJ1Z2dlciBzb2NrZXQgZGlzY29ubmVjdGVkJyk7XG4gICAgICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdlcnJvcicsIChleGNlcHRpb24pID0+IHtcbiAgICAgICAgaWYgKHRoaXMuY29ubmVjdGVkKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBXZWJLaXQgZGVidWdnZXIgd2ViIHNvY2tldCBlcnJvcjogJHtleGNlcHRpb24ubWVzc2FnZX1gKTtcbiAgICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVqZWN0KGV4Y2VwdGlvbik7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdtZXNzYWdlJywgdGhpcy5yZWNlaXZlLmJpbmQodGhpcykpO1xuICAgIH0pO1xuICB9XG5cbiAgZGlzY29ubmVjdCAoKSB7XG4gICAgbG9nLmRlYnVnKCdEaXNjb25uZWN0aW5nIGZyb20gV2ViS2l0IHJlbW90ZSBkZWJ1Z2dlcicpO1xuICAgIGlmICh0aGlzLmlzQ29ubmVjdGVkKCkpIHtcbiAgICAgIHRoaXMuc29ja2V0LmNsb3NlKDEwMDEpO1xuICAgIH1cbiAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICB9XG5cbiAgaXNDb25uZWN0ZWQgKCkge1xuICAgIHJldHVybiAodGhpcy5zb2NrZXQgIT09IG51bGwgJiYgdGhpcy5jb25uZWN0ZWQpO1xuICB9XG5cbiAgYXN5bmMgc2VuZCAoY29tbWFuZCwgb3B0cyA9IHt9KSB7XG4gICAgbGV0IGRhdGEgPSBnZXRSZW1vdGVDb21tYW5kKGNvbW1hbmQsIF8uZGVmYXVsdHMoe2Nvbm5JZDogdGhpcy5jb25uSWQsIHNlbmRlcklkOiB0aGlzLnNlbmRlcklkfSwgb3B0cykpO1xuXG4gICAgbG9nLmRlYnVnKGBTZW5kaW5nIFdlYktpdCBkYXRhOiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoZGF0YSksIERBVEFfTE9HX0xFTkdUSCl9YCk7XG4gICAgbG9nLmRlYnVnKGBXZWJraXQgcmVzcG9uc2UgdGltZW91dDogJHt0aGlzLnJlc3BvbnNlVGltZW91dH1gKTtcblxuICAgIHRoaXMuY3VyTXNnSWQrKztcbiAgICBkYXRhLmlkID0gdGhpcy5jdXJNc2dJZDtcblxuICAgIGNvbnN0IGlkID0gdGhpcy5jdXJNc2dJZC50b1N0cmluZygpO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBvbmx5IHJlc29sdmUgdGhlIHNlbmQgY29tbWFuZCB3aGVuIFdlYktpdCByZXR1cm5zIGEgcmVzcG9uc2VcbiAgICAgIC8vIHN0b3JlIHRoZSBoYW5kbGVyIGFuZCB0aGUgZGF0YSBzZW50XG4gICAgICB0aGlzLmRhdGFIYW5kbGVyc1tpZF0gPSByZXNvbHZlO1xuICAgICAgdGhpcy5kYXRhTWV0aG9kc1tpZF0gPSBkYXRhLm1ldGhvZDtcbiAgICAgIHRoaXMuZXJyb3JIYW5kbGVyc1tpZF0gPSByZWplY3Q7XG5cbiAgICAgIC8vIHNlbmQgdGhlIGRhdGFcbiAgICAgIHRoaXMuc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkoZGF0YSksIGZ1bmN0aW9uIChlcnJvcikge1xuICAgICAgICBpZiAodXRpbC5oYXNWYWx1ZShlcnJvcikpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYFdlYktpdCBzb2NrZXQgZXJyb3Igb2NjdXJyZWQ6ICR7ZXJyb3J9YCk7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihlcnJvcikpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KS5jYXRjaCgoZSkgPT4ge1xuICAgICAgaWYgKGUuY29uc3RydWN0b3IubmFtZSAhPT0gV2ViS2l0UlBDV2FybmluZy5uYW1lKSB7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgICBsb2cud2FybihlLm1lc3NhZ2UpO1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShudWxsKTtcbiAgICB9KS5maW5hbGx5KChyZXMpID0+IHtcbiAgICAgIC8vIG5vIG5lZWQgdG8gaG9sZCBvbnRvIGFueXRoaW5nXG4gICAgICBkZWxldGUgdGhpcy5kYXRhSGFuZGxlcnNbaWRdO1xuICAgICAgZGVsZXRlIHRoaXMuZGF0YU1ldGhvZHNbaWRdO1xuICAgICAgZGVsZXRlIHRoaXMuZXJyb3JIYW5kbGVyc1tpZF07XG5cbiAgICAgIC8vIGFuZCBwYXNzIGFsb25nIHRoZSByZXN1bHRcbiAgICAgIHJldHVybiByZXM7XG4gICAgfSkudGltZW91dCh0aGlzLnJlc3BvbnNlVGltZW91dCk7XG4gIH1cblxuICByZWNlaXZlIChkYXRhKSB7XG4gICAgbG9nLmRlYnVnKGBSZWNlaXZlZCBXZWJLaXQgZGF0YTogJyR7Xy50cnVuY2F0ZShkYXRhLCBEQVRBX0xPR19MRU5HVEgpfSdgKTtcbiAgICBkYXRhID0gdXRpbC5zYWZlSnNvblBhcnNlKGRhdGEpO1xuXG4gICAgY29uc3QgcmVqZWN0Q2FsbCA9IChlcnJvcikgPT4ge1xuICAgICAgaWYgKGRhdGEgJiYgdGhpcy5lcnJvckhhbmRsZXJzW2RhdGEuaWRdKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmVycm9ySGFuZGxlcnNbZGF0YS5pZF0oZXJyb3IpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZXJyb3IuY29uc3RydWN0b3IubmFtZSA9PT0gV2ViS2l0UlBDV2FybmluZy5uYW1lKSB7XG4gICAgICAgIGxvZy53YXJuKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coZXJyb3IpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChkYXRhKSkge1xuICAgICAgcmV0dXJuIHJlamVjdENhbGwobmV3IFdlYktpdFJQQ1dhcm5pbmcoYE5vIHBhcnNlYWJsZSBkYXRhIGZvdW5kYCkpO1xuICAgIH1cblxuICAgIC8vIHdlIGNhbiBnZXQgYW4gZXJyb3IsIG9yIHdlIGNhbiBnZXQgYSByZXNwb25zZSB0aGF0IGlzIGFuIGVycm9yXG4gICAgaWYgKGRhdGEud2FzVGhyb3duIHx8IChkYXRhLnJlc3VsdCAmJiBkYXRhLnJlc3VsdC53YXNUaHJvd24pKSB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gZGF0YS53YXNUaHJvd25cbiAgICAgICAgPyBkYXRhLnJlc3VsdC52YWx1ZSB8fCBkYXRhLnJlc3VsdC5kZXNjcmlwdGlvblxuICAgICAgICA6IGRhdGEucmVzdWx0LnJlc3VsdC52YWx1ZSB8fCBkYXRhLnJlc3VsdC5yZXN1bHQuZGVzY3JpcHRpb247XG4gICAgICByZXR1cm4gcmVqZWN0Q2FsbChuZXcgRXJyb3IobWVzc2FnZSkpO1xuICAgIH1cblxuICAgIGNvbnN0IG1zZ0lkID0gZGF0YS5pZDtcbiAgICAvLyB3aGVuIHNlbmRpbmcgd2Ugc2V0IGEgZGF0YSBtZXRob2QgYW5kIGFzc29jaWF0ZWQgY2FsbGJhY2suXG4gICAgLy8gZ2V0IHRoYXQsIG9yIHRoZSBnZW5lcmljIChhdXRvbWF0aWNhbGx5IHNlbnQsIG5vdCBhc3NvY2lhdGVkXG4gICAgLy8gd2l0aCBhIHBhcnRpY3VsYXIgcmVxdWVzdCkgbWV0aG9kXG4gICAgY29uc3QgbWV0aG9kID0gdGhpcy5kYXRhTWV0aG9kc1ttc2dJZF0gfHwgZGF0YS5tZXRob2Q7XG4gICAgaWYgKCFtZXRob2QpIHtcbiAgICAgIHJldHVybiByZWplY3RDYWxsKFxuICAgICAgICBuZXcgV2ViS2l0UlBDV2FybmluZyhgRGlkIG5vdCBmaW5kIGFueSBoYW5kbGVycyBmb3IgJHttc2dJZCA/IGAnJHttc2dJZH0nYCA6ICd0aGUgcmVjZW50J30gbWVzc2FnZWApKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBGb3VuZCBtZXRob2QgJyR7bWV0aG9kfScke21zZ0lkID8gYCBmb3IgJyR7bXNnSWR9JyBtZXNzYWdlYCA6ICcnfWApO1xuICAgIGxldCBpc0V2ZW50SGFuZGxlZCA9IGZhbHNlO1xuICAgIHN3aXRjaCAobWV0aG9kKSB7XG4gICAgICBjYXNlICdQcm9maWxlci5yZXNldFByb2ZpbGVzJzpcbiAgICAgICAgbG9nLmRlYnVnKCdEZXZpY2UgaXMgdGVsbGluZyB1cyB0byByZXNldCBwcm9maWxlcy4gU2hvdWxkIHByb2JhYmx5ICcgK1xuICAgICAgICAgICAgICAgICAgJ2RvIHNvbWUga2luZCBvZiBjYWxsYmFjayBoZXJlJyk7XG4gICAgICAgIGlzRXZlbnRIYW5kbGVkID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdUaW1lbGluZS5ldmVudFJlY29yZGVkJzpcbiAgICAgICAgaWYgKHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIpIHtcbiAgICAgICAgICB0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyKGRhdGEucmVzdWx0KTtcbiAgICAgICAgICBpc0V2ZW50SGFuZGxlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdDb25zb2xlLm1lc3NhZ2VBZGRlZCc6XG4gICAgICAgIGlmICh0aGlzLmNvbnNvbGVFdmVudEhhbmRsZXIpIHtcbiAgICAgICAgICB0aGlzLmNvbnNvbGVFdmVudEhhbmRsZXIoZGF0YS5wYXJhbXMubWVzc2FnZSk7XG4gICAgICAgICAgaXNFdmVudEhhbmRsZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnUGFnZS5uYXZpZ2F0ZSc6XG4gICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgcGFnZSBuYXZpZ2F0ZWQgbWVzc2FnZTogJHtzaW1wbGVTdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgICAgIGlzRXZlbnRIYW5kbGVkID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdOZXR3b3JrLmRhdGFSZWNlaXZlZCc6XG4gICAgICBjYXNlICdOZXR3b3JrLnJlcXVlc3RXaWxsQmVTZW50JzpcbiAgICAgIGNhc2UgJ05ldHdvcmsucmVzcG9uc2VSZWNlaXZlZCc6XG4gICAgICBjYXNlICdOZXR3b3JrLmxvYWRpbmdGaW5pc2hlZCc6XG4gICAgICBjYXNlICdOZXR3b3JrLmxvYWRpbmdGYWlsZWQnOlxuICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMubmV0d29ya0V2ZW50SGFuZGxlcikpIHtcbiAgICAgICAgICB0aGlzLm5ldHdvcmtFdmVudEhhbmRsZXIobWV0aG9kLCBkYXRhLnBhcmFtcyk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBpZiAoIWRhdGEuZXJyb3IgJiYgXy5oYXModGhpcy5kYXRhSGFuZGxlcnMsIG1zZ0lkKSkge1xuICAgICAgcmV0dXJuIHRoaXMuZGF0YUhhbmRsZXJzW21zZ0lkXShkYXRhLnJlc3VsdCk7XG4gICAgfVxuICAgIGlmIChkYXRhLmVycm9yICYmIF8uaGFzKHRoaXMuZXJyb3JIYW5kbGVycywgbXNnSWQpKSB7XG4gICAgICByZXR1cm4gdGhpcy5lcnJvckhhbmRsZXJzW21zZ0lkXShkYXRhLmVycm9yKTtcbiAgICB9XG4gICAgaWYgKCFpc0V2ZW50SGFuZGxlZCkge1xuICAgICAgbG9nLmRlYnVnKGBUaGVyZSBpcyBubyBoYW5kbGVyIHNjaGVkdWxlZCBmb3IgbWV0aG9kICcke21ldGhvZH0nIGluICR7bXNnSWQgPyBgJyR7bXNnSWR9J2AgOiAndGhlIHJlY2VudCd9IG1lc3NhZ2VgKTtcbiAgICB9XG4gIH1cblxuICBzZXRUaW1lbGluZUV2ZW50SGFuZGxlciAodGltZWxpbmVFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyID0gdGltZWxpbmVFdmVudEhhbmRsZXI7XG4gIH1cblxuICBzZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyIChjb25zb2xlRXZlbnRIYW5kbGVyKSB7XG4gICAgdGhpcy5jb25zb2xlRXZlbnRIYW5kbGVyID0gY29uc29sZUV2ZW50SGFuZGxlcjtcbiAgfVxuXG4gIHNldE5ldHdvcmtMb2dFdmVudEhhbmRsZXIgKG5ldHdvcmtFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLm5ldHdvcmtFdmVudEhhbmRsZXIgPSBuZXR3b3JrRXZlbnRIYW5kbGVyO1xuICB9XG59XG5cblxuY2xhc3MgV2ViS2l0UlBDV2FybmluZyBleHRlbmRzIEVTNkVycm9yIHt9XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
