'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _defineProperty = require('babel-runtime/helpers/define-property')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _2 = require('../..');

var _lruCache = require('lru-cache');

var _lruCache2 = _interopRequireDefault(_lruCache);

var _protocolProtocol = require('../protocol/protocol');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _uuidJs = require('uuid-js');

var _uuidJs2 = _interopRequireDefault(_uuidJs);

var MAX_CACHE_SIZE = 1024 * 1024 * 40; // 40mb
var TAP_DURATION_MS = 125;
var IMAGE_EL_TAP_STRATEGY_W3C = 'w3cActions';
var IMAGE_EL_TAP_STRATEGY_MJSONWP = 'touchActions';
var IMAGE_TAP_STRATEGIES = [IMAGE_EL_TAP_STRATEGY_MJSONWP, IMAGE_EL_TAP_STRATEGY_W3C];

/**
 * @typedef {Object} Rect
 * @property {int} x - x-coordinate of top-left corner
 * @property {int} y - y-coordinate of top-left corner
 * @property {int} width - width of rect
 * @property {int} height - height of rect
 */

/**
 * @typedef {Object} Dimension
 * @property {int} width - width of rect
 * @property {int} height - height of rect
 */

/**
 * @typedef {Object} Position
 * @property {int} x - x coordinate
 * @property {int} y - y coordinate
 */

/**
 * Representation of an "image element", which is simply a set of coordinates
 * and methods that can be used on that set of coordinates via the driver
 */

var ImageElement = (function () {

  /**
   * @param {string} b64Template - the base64-encoded image which was used to
   * find this ImageElement
   * @param {Rect} rect - bounds of matched image element
   *
   * @returns {ImageElement}
   */

  function ImageElement(b64Template, rect) {
    _classCallCheck(this, ImageElement);

    this.template = b64Template;
    this.rect = rect;
    this.id = '' + _protocolProtocol.IMAGE_ELEMENT_PREFIX + _uuidJs2['default'].create().hex;
  }

  /**
   * @returns {Dimension} - dimension of element
   */

  _createClass(ImageElement, [{
    key: 'asElement',

    /**
     * @param {string} protocolKey - the protocol-specific JSON key for
     * a WebElement
     *
     * @returns {WebElement} - this image element as a WebElement
     */
    value: function asElement(protocolKey) {
      return _defineProperty({}, protocolKey, this.id);
    }

    /**
     * @param {ImageElement} other - an ImageElement to compare with this one
     *
     * @returns {boolean} - whether the other element and this one have the same
     * properties
     */
  }, {
    key: 'equals',
    value: function equals(other) {
      return this.rect.x === other.rect.x && this.rect.y === other.rect.y && this.rect.width === other.rect.width && this.rect.height === other.rect.height;
    }

    /**
     * Use a driver to tap the screen at the center of this ImageElement's
     * position
     *
     * @param {BaseDriver} driver - driver for calling actions with
     */
  }, {
    key: 'click',
    value: function click(driver) {
      var newImgEl, _driver$settings$getSettings, updatePos, checkForImageElementStaleness, imageElementTapStrategy, _center, x, y, _action, action;

      return _regeneratorRuntime.async(function click$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            newImgEl = undefined;
            _driver$settings$getSettings = driver.settings.getSettings();
            updatePos = _driver$settings$getSettings.autoUpdateImageElementPosition;
            checkForImageElementStaleness = _driver$settings$getSettings.checkForImageElementStaleness;
            imageElementTapStrategy = _driver$settings$getSettings.imageElementTapStrategy;

            if (IMAGE_TAP_STRATEGIES.includes(imageElementTapStrategy)) {
              context$2$0.next = 7;
              break;
            }

            throw new Error('Incorrect imageElementTapStrategy setting ' + ('\'' + imageElementTapStrategy + '\'. Must be one of ') + JSON.stringify(IMAGE_TAP_STRATEGIES));

          case 7:
            if (!(checkForImageElementStaleness || updatePos)) {
              context$2$0.next = 19;
              break;
            }

            _logger2['default'].info('Checking image element for staleness before clicking');
            context$2$0.prev = 9;
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(driver.findByImage(this.template, {
              shouldCheckStaleness: true
            }));

          case 12:
            newImgEl = context$2$0.sent;
            context$2$0.next = 18;
            break;

          case 15:
            context$2$0.prev = 15;
            context$2$0.t0 = context$2$0['catch'](9);
            throw new _2.errors.StaleElementReferenceError();

          case 18:

            if (!this.equals(newImgEl)) {
              _logger2['default'].warn('When trying to click on an image element, the image changed ' + 'position from where it was originally found. It is now at ' + (JSON.stringify(newImgEl.rect) + ' and was originally at ') + (JSON.stringify(this.rect) + '.'));
              if (updatePos) {
                _logger2['default'].warn('Click will proceed at new coordinates');
                this.rect = _lodash2['default'].clone(newImgEl.rect);
              } else {
                _logger2['default'].warn("Click will take place at original coordinates. If you " + "would like Appium to automatically click the new " + "coordinates, set the 'autoUpdateImageElementPosition' " + "setting to true");
              }
            }

          case 19:
            _center = this.center;
            x = _center.x;
            y = _center.y;

            _logger2['default'].info('Will tap on image element at coordinate [' + x + ', ' + y + ']');

            if (!(imageElementTapStrategy === IMAGE_EL_TAP_STRATEGY_W3C)) {
              context$2$0.next = 31;
              break;
            }

            // set up a W3C action to click on the image by position
            _logger2['default'].info('Will tap using W3C actions');
            _action = {
              type: 'pointer',
              id: 'mouse',
              parameters: { pointerType: 'touch' },
              actions: [{ type: 'pointerMove', x: x, y: y, duration: 0 }, { type: 'pointerDown' }, { type: 'pause', duration: TAP_DURATION_MS }, { type: 'pointerUp' }]
            };

            if (!driver.performActions) {
              context$2$0.next = 30;
              break;
            }

            context$2$0.next = 29;
            return _regeneratorRuntime.awrap(driver.performActions([_action]));

          case 29:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 30:

            // if not, warn and fall back to the other method
            _logger2['default'].warn('Driver does not seem to implement W3C actions, falling back ' + 'to TouchActions');

          case 31:

            // if the w3c strategy was not requested, do the only other option (mjsonwp
            // touch actions)
            _logger2['default'].info('Will tap using MJSONWP TouchActions');
            action = {
              action: 'tap',
              options: { x: x, y: y }
            };

            if (!driver.performTouch) {
              context$2$0.next = 37;
              break;
            }

            context$2$0.next = 36;
            return _regeneratorRuntime.awrap(driver.performTouch([action]));

          case 36:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 37:
            throw new Error("Driver did not implement the 'performTouch' command. " + "For drivers to support finding image elements, they " + "should support 'performTouch' and 'performActions'");

          case 38:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[9, 15]]);
    }

    /**
     * Handle various Appium commands that involve an image element
     *
     * @param {BaseDriver} driver - the driver to use for commands
     * @param {string} cmd - the name of the driver command
     * @param {string} imgElId - the id of the ImageElement to work with
     *
     * @returns {Object} - the result of running a command
     */
  }, {
    key: 'size',
    get: function get() {
      return { width: this.rect.width, height: this.rect.height };
    }

    /**
     * @returns {Position} - coordinates of top-left corner of element
     */
  }, {
    key: 'location',
    get: function get() {
      return { x: this.rect.x, y: this.rect.y };
    }

    /**
     * @returns {Position} - coordinates of center of element
     */
  }, {
    key: 'center',
    get: function get() {
      return {
        x: this.rect.x + this.rect.width / 2,
        y: this.rect.y + this.rect.height / 2
      };
    }
  }], [{
    key: 'execute',
    value: function execute(driver, cmd, imgElId) {
      var imgEl;
      return _regeneratorRuntime.async(function execute$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (driver._imgElCache.has(imgElId)) {
              context$2$0.next = 2;
              break;
            }

            throw new _2.errors.NoSuchElementError();

          case 2:
            imgEl = driver._imgElCache.get(imgElId);
            context$2$0.t0 = cmd;
            context$2$0.next = context$2$0.t0 === 'click' ? 6 : context$2$0.t0 === 'elementDisplayed' ? 9 : context$2$0.t0 === 'getSize' ? 10 : context$2$0.t0 === 'getLocation' ? 11 : context$2$0.t0 === 'getLocationInView' ? 11 : context$2$0.t0 === 'getElementRect' ? 12 : 13;
            break;

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(imgEl.click(driver));

          case 8:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 9:
            return context$2$0.abrupt('return', true);

          case 10:
            return context$2$0.abrupt('return', imgEl.size);

          case 11:
            return context$2$0.abrupt('return', imgEl.location);

          case 12:
            return context$2$0.abrupt('return', imgEl.rect);

          case 13:
            throw new _2.errors.NotYetImplementedError();

          case 14:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return ImageElement;
})();

function makeImageElementCache() {
  var max = arguments.length <= 0 || arguments[0] === undefined ? MAX_CACHE_SIZE : arguments[0];

  return (0, _lruCache2['default'])({
    max: max,
    length: function length(el) {
      return el.template.length;
    }
  });
}

function getImgElFromArgs(args) {
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(args), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var arg = _step.value;

      if (_lodash2['default'].isString(arg) && arg.startsWith(_protocolProtocol.IMAGE_ELEMENT_PREFIX)) {
        return arg;
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }
}

exports.ImageElement = ImageElement;
exports.getImgElFromArgs = getImgElFromArgs;
exports.makeImageElementCache = makeImageElementCache;
exports.IMAGE_EL_TAP_STRATEGY_MJSONWP = IMAGE_EL_TAP_STRATEGY_MJSONWP;
exports.IMAGE_EL_TAP_STRATEGY_W3C = IMAGE_EL_TAP_STRATEGY_W3C;

// before we click we need to make sure the element is actually still there
// where we expect it to be

// validate tap strategy

// check if the driver has the appropriate performActions method
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2ltYWdlLWVsZW1lbnQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O3NCQUFjLFFBQVE7Ozs7aUJBQ0MsT0FBTzs7d0JBQ2QsV0FBVzs7OztnQ0FDVSxzQkFBc0I7O3NCQUMzQyxVQUFVOzs7O3NCQUNULFNBQVM7Ozs7QUFFMUIsSUFBTSxjQUFjLEdBQUcsSUFBSSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7QUFDeEMsSUFBTSxlQUFlLEdBQUcsR0FBRyxDQUFDO0FBQzVCLElBQU0seUJBQXlCLEdBQUcsWUFBWSxDQUFDO0FBQy9DLElBQU0sNkJBQTZCLEdBQUcsY0FBYyxDQUFDO0FBQ3JELElBQU0sb0JBQW9CLEdBQUcsQ0FDM0IsNkJBQTZCLEVBQzdCLHlCQUF5QixDQUMxQixDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUEwQkksWUFBWTs7Ozs7Ozs7OztBQVNKLFdBVFIsWUFBWSxDQVNILFdBQVcsRUFBRSxJQUFJLEVBQUU7MEJBVDVCLFlBQVk7O0FBVWQsUUFBSSxDQUFDLFFBQVEsR0FBRyxXQUFXLENBQUM7QUFDNUIsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDakIsUUFBSSxDQUFDLEVBQUUsaURBQTZCLG9CQUFLLE1BQU0sRUFBRSxDQUFDLEdBQUcsQUFBRSxDQUFDO0dBQ3pEOzs7Ozs7ZUFiRyxZQUFZOzs7Ozs7Ozs7V0E2Q04sbUJBQUMsV0FBVyxFQUFFO0FBQ3RCLGlDQUFTLFdBQVcsRUFBRyxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ2pDOzs7Ozs7Ozs7O1dBUU0sZ0JBQUMsS0FBSyxFQUFFO0FBQ2IsYUFBTyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsSUFDNUIsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQzVCLElBQUksQ0FBQyxJQUFJ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LENBQUMsT0FBTyxDQUFDOzZCQUVyQyxHQUFHO2tEQUNKLE9BQU8sMEJBRVAsa0JBQWtCLDBCQUVsQixTQUFTLDJCQUVULGFBQWEsMkJBQ2IsbUJBQW1CLDJCQUVuQixnQkFBZ0I7Ozs7OzZDQVJOLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDOzs7Ozs7Z0RBRXpCLElBQUk7OztnREFFSixLQUFLLENBQUMsSUFBSTs7O2dEQUdWLEtBQUssQ0FBQyxRQUFROzs7Z0RBRWQsS0FBSyxDQUFDLElBQUk7OztrQkFDSixJQUFJLFVBQU8sc0JBQXNCLEVBQUU7Ozs7Ozs7S0FFckQ7OztTQTNMRyxZQUFZOzs7QUE4TGxCLFNBQVMscUJBQXFCLEdBQXdCO01BQXRCLEdBQUcseURBQUcsY0FBYzs7QUFDbEQsU0FBTywyQkFBSTtBQUNULE9BQUcsRUFBSCxHQUFHO0FBQ0gsVUFBTSxFQUFFLGdCQUFDLEVBQUU7YUFBSyxFQUFFLENBQUMsUUFBUSxDQUFDLE1BQU07S0FBQTtHQUNuQyxDQUFDLENBQUM7Q0FDSjs7QUFFRCxTQUFTLGdCQUFnQixDQUFFLElBQUksRUFBRTs7Ozs7O0FBQy9CLHNDQUFnQixJQUFJLDRHQUFFO1VBQWIsR0FBRzs7QUFDVixVQUFJLG9CQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsVUFBVSx3Q0FBc0IsRUFBRTtBQUMzRCxlQUFPLEdBQUcsQ0FBQztPQUNaO0tBQ0Y7Ozs7Ozs7Ozs7Ozs7OztDQUNGOztRQUVRLFlBQVksR0FBWixZQUFZO1FBQUUsZ0JBQWdCLEdBQWhCLGdCQUFnQjtRQUFFLHFCQUFxQixHQUFyQixxQkFBcUI7UUFDckQsNkJBQTZCLEdBQTdCLDZCQUE2QjtRQUFFLHlCQUF5QixHQUF6Qix5QkFBeUIiLCJmaWxlIjoibGliL2Jhc2Vkcml2ZXIvaW1hZ2UtZWxlbWVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICcuLi8uLic7XG5pbXBvcnQgTFJVIGZyb20gJ2xydS1jYWNoZSc7XG5pbXBvcnQgeyBJTUFHRV9FTEVNRU5UX1BSRUZJWCB9IGZyb20gJy4uL3Byb3RvY29sL3Byb3RvY29sJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IFVVSUQgZnJvbSAndXVpZC1qcyc7XG5cbmNvbnN0IE1BWF9DQUNIRV9TSVpFID0gMTAyNCAqIDEwMjQgKiA0MDsgLy8gNDBtYlxuY29uc3QgVEFQX0RVUkFUSU9OX01TID0gMTI1O1xuY29uc3QgSU1BR0VfRUxfVEFQX1NUUkFURUdZX1czQyA9ICd3M2NBY3Rpb25zJztcbmNvbnN0IElNQUdFX0VMX1RBUF9TVFJBVEVHWV9NSlNPTldQID0gJ3RvdWNoQWN0aW9ucyc7XG5jb25zdCBJTUFHRV9UQVBfU1RSQVRFR0lFUyA9IFtcbiAgSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AsXG4gIElNQUdFX0VMX1RBUF9TVFJBVEVHWV9XM0Ncbl07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gUmVjdFxuICogQHByb3BlcnR5IHtpbnR9IHggLSB4LWNvb3JkaW5hdGUgb2YgdG9wLWxlZnQgY29ybmVyXG4gKiBAcHJvcGVydHkge2ludH0geSAtIHktY29vcmRpbmF0ZSBvZiB0b3AtbGVmdCBjb3JuZXJcbiAqIEBwcm9wZXJ0eSB7aW50fSB3aWR0aCAtIHdpZHRoIG9mIHJlY3RcbiAqIEBwcm9wZXJ0eSB7aW50fSBoZWlnaHQgLSBoZWlnaHQgb2YgcmVjdFxuICovXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gRGltZW5zaW9uXG4gKiBAcHJvcGVydHkge2ludH0gd2lkdGggLSB3aWR0aCBvZiByZWN0XG4gKiBAcHJvcGVydHkge2ludH0gaGVpZ2h0IC0gaGVpZ2h0IG9mIHJlY3RcbiAqL1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFBvc2l0aW9uXG4gKiBAcHJvcGVydHkge2ludH0geCAtIHggY29vcmRpbmF0ZVxuICogQHByb3BlcnR5IHtpbnR9IHkgLSB5IGNvb3JkaW5hdGVcbiAqL1xuXG4vKipcbiAqIFJlcHJlc2VudGF0aW9uIG9mIGFuIFwiaW1hZ2UgZWxlbWVudFwiLCB3aGljaCBpcyBzaW1wbHkgYSBzZXQgb2YgY29vcmRpbmF0ZXNcbiAqIGFuZCBtZXRob2RzIHRoYXQgY2FuIGJlIHVzZWQgb24gdGhhdCBzZXQgb2YgY29vcmRpbmF0ZXMgdmlhIHRoZSBkcml2ZXJcbiAqL1xuY2xhc3MgSW1hZ2VFbGVtZW50IHtcblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IGI2NFRlbXBsYXRlIC0gdGhlIGJhc2U2NC1lbmNvZGVkIGltYWdlIHdoaWNoIHdhcyB1c2VkIHRvXG4gICAqIGZpbmQgdGhpcyBJbWFnZUVsZW1lbnRcbiAgICogQHBhcmFtIHtSZWN0fSByZWN0IC0gYm91bmRzIG9mIG1hdGNoZWQgaW1hZ2UgZWxlbWVudFxuICAgKlxuICAgKiBAcmV0dXJucyB7SW1hZ2VFbGVtZW50fVxuICAgKi9cbiAgY29uc3RydWN0b3IgKGI2NFRlbXBsYXRlLCByZWN0KSB7XG4gICAgdGhpcy50ZW1wbGF0ZSA9IGI2NFRlbXBsYXRlO1xuICAgIHRoaXMucmVjdCA9IHJlY3Q7XG4gICAgdGhpcy5pZCA9IGAke0lNQUdFX0VMRU1FTlRfUFJFRklYfSR7VVVJRC5jcmVhdGUoKS5oZXh9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7RGltZW5zaW9ufSAtIGRpbWVuc2lvbiBvZiBlbGVtZW50XG4gICAqL1xuICBnZXQgc2l6ZSAoKSB7XG4gICAgcmV0dXJuIHt3aWR0aDogdGhpcy5yZWN0LndpZHRoLCBoZWlnaHQ6IHRoaXMucmVjdC5oZWlnaHR9O1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtQb3NpdGlvbn0gLSBjb29yZGluYXRlcyBvZiB0b3AtbGVmdCBjb3JuZXIgb2YgZWxlbWVudFxuICAgKi9cbiAgZ2V0IGxvY2F0aW9uICgpIHtcbiAgICByZXR1cm4ge3g6IHRoaXMucmVjdC54LCB5OiB0aGlzLnJlY3QueX07XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge1Bvc2l0aW9ufSAtIGNvb3JkaW5hdGVzIG9mIGNlbnRlciBvZiBlbGVtZW50XG4gICAqL1xuICBnZXQgY2VudGVyICgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgeDogdGhpcy5yZWN0LnggKyB0aGlzLnJlY3Qud2lkdGggLyAyLFxuICAgICAgeTogdGhpcy5yZWN0LnkgKyB0aGlzLnJlY3QuaGVpZ2h0IC8gMixcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwcm90b2NvbEtleSAtIHRoZSBwcm90b2NvbC1zcGVjaWZpYyBKU09OIGtleSBmb3JcbiAgICogYSBXZWJFbGVtZW50XG4gICAqXG4gICAqIEByZXR1cm5zIHtXZWJFbGVtZW50fSAtIHRoaXMgaW1hZ2UgZWxlbWVudCBhcyBhIFdlYkVsZW1lbnRcbiAgICovXG4gIGFzRWxlbWVudCAocHJvdG9jb2xLZXkpIHtcbiAgICByZXR1cm4ge1twcm90b2NvbEtleV06IHRoaXMuaWR9O1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7SW1hZ2VFbGVtZW50fSBvdGhlciAtIGFuIEltYWdlRWxlbWVudCB0byBjb21wYXJlIHdpdGggdGhpcyBvbmVcbiAgICpcbiAgICogQHJldHVybnMge2Jvb2xlYW59IC0gd2hldGhlciB0aGUgb3RoZXIgZWxlbWVudCBhbmQgdGhpcyBvbmUgaGF2ZSB0aGUgc2FtZVxuICAgKiBwcm9wZXJ0aWVzXG4gICAqL1xuICBlcXVhbHMgKG90aGVyKSB7XG4gICAgcmV0dXJuIHRoaXMucmVjdC54ID09PSBvdGhlci5yZWN0LnggJiZcbiAgICAgICAgICAgdGhpcy5yZWN0LnkgPT09IG90aGVyLnJlY3QueSAmJlxuICAgICAgICAgICB0aGlzLnJlY3Qud2lkdGggPT09IG90aGVyLnJlY3Qud2lkdGggJiZcbiAgICAgICAgICAgdGhpcy5yZWN0LmhlaWdodCA9PT0gb3RoZXIucmVjdC5oZWlnaHQ7XG4gIH1cblxuICAvKipcbiAgICogVXNlIGEgZHJpdmVyIHRvIHRhcCB0aGUgc2NyZWVuIGF0IHRoZSBjZW50ZXIgb2YgdGhpcyBJbWFnZUVsZW1lbnQnc1xuICAgKiBwb3NpdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge0Jhc2VEcml2ZXJ9IGRyaXZlciAtIGRyaXZlciBmb3IgY2FsbGluZyBhY3Rpb25zIHdpdGhcbiAgICovXG4gIGFzeW5jIGNsaWNrIChkcml2ZXIpIHtcbiAgICAvLyBiZWZvcmUgd2UgY2xpY2sgd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIGVsZW1lbnQgaXMgYWN0dWFsbHkgc3RpbGwgdGhlcmVcbiAgICAvLyB3aGVyZSB3ZSBleHBlY3QgaXQgdG8gYmVcbiAgICBsZXQgbmV3SW1nRWw7XG4gICAgY29uc3Qge1xuICAgICAgYXV0b1VwZGF0ZUltYWdlRWxlbWVudFBvc2l0aW9uOiB1cGRhdGVQb3MsXG4gICAgICBjaGVja0ZvckltYWdlRWxlbWVudFN0YWxlbmVzcyxcbiAgICAgIGltYWdlRWxlbWVudFRhcFN0cmF0ZWd5LFxuICAgIH0gPSBkcml2ZXIuc2V0dGluZ3MuZ2V0U2V0dGluZ3MoKTtcblxuICAgIC8vIHZhbGlkYXRlIHRhcCBzdHJhdGVneVxuICAgIGlmICghSU1BR0VfVEFQX1NUUkFURUdJRVMuaW5jbHVkZXMoaW1hZ2VFbGVtZW50VGFwU3RyYXRlZ3kpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEluY29ycmVjdCBpbWFnZUVsZW1lbnRUYXBTdHJhdGVneSBzZXR0aW5nIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGAnJHtpbWFnZUVsZW1lbnRUYXBTdHJhdGVneX0nLiBNdXN0IGJlIG9uZSBvZiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShJTUFHRV9UQVBfU1RSQVRFR0lFUykpO1xuICAgIH1cblxuICAgIGlmIChjaGVja0ZvckltYWdlRWxlbWVudFN0YWxlbmVzcyB8fCB1cGRhdGVQb3MpIHtcbiAgICAgIGxvZy5pbmZvKCdDaGVja2luZyBpbWFnZSBlbGVtZW50IGZvciBzdGFsZW5lc3MgYmVmb3JlIGNsaWNraW5nJyk7XG4gICAgICB0cnkge1xuICAgICAgICBuZXdJbWdFbCA9IGF3YWl0IGRyaXZlci5maW5kQnlJbWFnZSh0aGlzLnRlbXBsYXRlLCB7XG4gICAgICAgICAgc2hvdWxkQ2hlY2tTdGFsZW5lc3M6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5TdGFsZUVsZW1lbnRSZWZlcmVuY2VFcnJvcigpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIXRoaXMuZXF1YWxzKG5ld0ltZ0VsKSkge1xuICAgICAgICBsb2cud2FybihgV2hlbiB0cnlpbmcgdG8gY2xpY2sgb24gYW4gaW1hZ2UgZWxlbWVudCwgdGhlIGltYWdlIGNoYW5nZWQgYCArXG4gICAgICAgICAgICAgICAgIGBwb3NpdGlvbiBmcm9tIHdoZXJlIGl0IHdhcyBvcmlnaW5hbGx5IGZvdW5kLiBJdCBpcyBub3cgYXQgYCArXG4gICAgICAgICAgICAgICAgIGAke0pTT04uc3RyaW5naWZ5KG5ld0ltZ0VsLnJlY3QpfSBhbmQgd2FzIG9yaWdpbmFsbHkgYXQgYCArXG4gICAgICAgICAgICAgICAgIGAke0pTT04uc3RyaW5naWZ5KHRoaXMucmVjdCl9LmApO1xuICAgICAgICBpZiAodXBkYXRlUG9zKSB7XG4gICAgICAgICAgbG9nLndhcm4oJ0NsaWNrIHdpbGwgcHJvY2VlZCBhdCBuZXcgY29vcmRpbmF0ZXMnKTtcbiAgICAgICAgICB0aGlzLnJlY3QgPSBfLmNsb25lKG5ld0ltZ0VsLnJlY3QpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxvZy53YXJuKFwiQ2xpY2sgd2lsbCB0YWtlIHBsYWNlIGF0IG9yaWdpbmFsIGNvb3JkaW5hdGVzLiBJZiB5b3UgXCIgK1xuICAgICAgICAgICAgICAgICAgIFwid291bGQgbGlrZSBBcHBpdW0gdG8gYXV0b21hdGljYWxseSBjbGljayB0aGUgbmV3IFwiICtcbiAgICAgICAgICAgICAgICAgICBcImNvb3JkaW5hdGVzLCBzZXQgdGhlICdhdXRvVXBkYXRlSW1hZ2VFbGVtZW50UG9zaXRpb24nIFwiICtcbiAgICAgICAgICAgICAgICAgICBcInNldHRpbmcgdG8gdHJ1ZVwiKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHt4LCB5fSA9IHRoaXMuY2VudGVyO1xuICAgIGxvZy5pbmZvKGBXaWxsIHRhcCBvbiBpbWFnZSBlbGVtZW50IGF0IGNvb3JkaW5hdGUgWyR7eH0sICR7eX1dYCk7XG5cbiAgICBpZiAoaW1hZ2VFbGVtZW50VGFwU3RyYXRlZ3kgPT09IElNQUdFX0VMX1RBUF9TVFJBVEVHWV9XM0MpIHtcbiAgICAgIC8vIHNldCB1cCBhIFczQyBhY3Rpb24gdG8gY2xpY2sgb24gdGhlIGltYWdlIGJ5IHBvc2l0aW9uXG4gICAgICBsb2cuaW5mbygnV2lsbCB0YXAgdXNpbmcgVzNDIGFjdGlvbnMnKTtcbiAgICAgIGNvbnN0IGFjdGlvbiA9IHtcbiAgICAgICAgdHlwZTogJ3BvaW50ZXInLFxuICAgICAgICBpZDogJ21vdXNlJyxcbiAgICAgICAgcGFyYW1ldGVyczoge3BvaW50ZXJUeXBlOiAndG91Y2gnfSxcbiAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgIHt0eXBlOiAncG9pbnRlck1vdmUnLCB4LCB5LCBkdXJhdGlvbjogMH0sXG4gICAgICAgICAge3R5cGU6ICdwb2ludGVyRG93bid9LFxuICAgICAgICAgIHt0eXBlOiAncGF1c2UnLCBkdXJhdGlvbjogVEFQX0RVUkFUSU9OX01TfSxcbiAgICAgICAgICB7dHlwZTogJ3BvaW50ZXJVcCd9LFxuICAgICAgICBdXG4gICAgICB9O1xuXG4gICAgICAvLyBjaGVjayBpZiB0aGUgZHJpdmVyIGhhcyB0aGUgYXBwcm9wcmlhdGUgcGVyZm9ybUFjdGlvbnMgbWV0aG9kXG4gICAgICBpZiAoZHJpdmVyLnBlcmZvcm1BY3Rpb25zKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBkcml2ZXIucGVyZm9ybUFjdGlvbnMoW2FjdGlvbl0pO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiBub3QsIHdhcm4gYW5kIGZhbGwgYmFjayB0byB0aGUgb3RoZXIgbWV0aG9kXG4gICAgICBsb2cud2FybignRHJpdmVyIGRvZXMgbm90IHNlZW0gdG8gaW1wbGVtZW50IFczQyBhY3Rpb25zLCBmYWxsaW5nIGJhY2sgJyArXG4gICAgICAgICAgICAgICAndG8gVG91Y2hBY3Rpb25zJyk7XG4gICAgfVxuXG4gICAgLy8gaWYgdGhlIHczYyBzdHJhdGVneSB3YXMgbm90IHJlcXVlc3RlZCwgZG8gdGhlIG9ubHkgb3RoZXIgb3B0aW9uIChtanNvbndwXG4gICAgLy8gdG91Y2ggYWN0aW9ucylcbiAgICBsb2cuaW5mbygnV2lsbCB0YXAgdXNpbmcgTUpTT05XUCBUb3VjaEFjdGlvbnMnKTtcbiAgICBjb25zdCBhY3Rpb24gPSB7XG4gICAgICBhY3Rpb246ICd0YXAnLFxuICAgICAgb3B0aW9uczoge3gsIHl9XG4gICAgfTtcblxuICAgIGlmIChkcml2ZXIucGVyZm9ybVRvdWNoKSB7XG4gICAgICByZXR1cm4gYXdhaXQgZHJpdmVyLnBlcmZvcm1Ub3VjaChbYWN0aW9uXSk7XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiRHJpdmVyIGRpZCBub3QgaW1wbGVtZW50IHRoZSAncGVyZm9ybVRvdWNoJyBjb21tYW5kLiBcIiArXG4gICAgICAgICAgICAgICAgICAgIFwiRm9yIGRyaXZlcnMgdG8gc3VwcG9ydCBmaW5kaW5nIGltYWdlIGVsZW1lbnRzLCB0aGV5IFwiICtcbiAgICAgICAgICAgICAgICAgICAgXCJzaG91bGQgc3VwcG9ydCAncGVyZm9ybVRvdWNoJyBhbmQgJ3BlcmZvcm1BY3Rpb25zJ1wiKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGUgdmFyaW91cyBBcHBpdW0gY29tbWFuZHMgdGhhdCBpbnZvbHZlIGFuIGltYWdlIGVsZW1lbnRcbiAgICpcbiAgICogQHBhcmFtIHtCYXNlRHJpdmVyfSBkcml2ZXIgLSB0aGUgZHJpdmVyIHRvIHVzZSBmb3IgY29tbWFuZHNcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNtZCAtIHRoZSBuYW1lIG9mIHRoZSBkcml2ZXIgY29tbWFuZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gaW1nRWxJZCAtIHRoZSBpZCBvZiB0aGUgSW1hZ2VFbGVtZW50IHRvIHdvcmsgd2l0aFxuICAgKlxuICAgKiBAcmV0dXJucyB7T2JqZWN0fSAtIHRoZSByZXN1bHQgb2YgcnVubmluZyBhIGNvbW1hbmRcbiAgICovXG4gIHN0YXRpYyBhc3luYyBleGVjdXRlIChkcml2ZXIsIGNtZCwgaW1nRWxJZCkge1xuICAgIGlmICghZHJpdmVyLl9pbWdFbENhY2hlLmhhcyhpbWdFbElkKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbWdFbCA9IGRyaXZlci5faW1nRWxDYWNoZS5nZXQoaW1nRWxJZCk7XG5cbiAgICBzd2l0Y2ggKGNtZCkge1xuICAgICAgY2FzZSAnY2xpY2snOlxuICAgICAgICByZXR1cm4gYXdhaXQgaW1nRWwuY2xpY2soZHJpdmVyKTtcbiAgICAgIGNhc2UgJ2VsZW1lbnREaXNwbGF5ZWQnOlxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIGNhc2UgJ2dldFNpemUnOlxuICAgICAgICByZXR1cm4gaW1nRWwuc2l6ZTtcbiAgICAgIGNhc2UgJ2dldExvY2F0aW9uJzpcbiAgICAgIGNhc2UgJ2dldExvY2F0aW9uSW5WaWV3JzpcbiAgICAgICAgcmV0dXJuIGltZ0VsLmxvY2F0aW9uO1xuICAgICAgY2FzZSAnZ2V0RWxlbWVudFJlY3QnOlxuICAgICAgICByZXR1cm4gaW1nRWwucmVjdDtcbiAgICAgIGRlZmF1bHQ6IHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcigpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBtYWtlSW1hZ2VFbGVtZW50Q2FjaGUgKG1heCA9IE1BWF9DQUNIRV9TSVpFKSB7XG4gIHJldHVybiBMUlUoe1xuICAgIG1heCxcbiAgICBsZW5ndGg6IChlbCkgPT4gZWwudGVtcGxhdGUubGVuZ3RoLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0SW1nRWxGcm9tQXJncyAoYXJncykge1xuICBmb3IgKGxldCBhcmcgb2YgYXJncykge1xuICAgIGlmIChfLmlzU3RyaW5nKGFyZykgJiYgYXJnLnN0YXJ0c1dpdGgoSU1BR0VfRUxFTUVOVF9QUkVGSVgpKSB7XG4gICAgICByZXR1cm4gYXJnO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBJbWFnZUVsZW1lbnQsIGdldEltZ0VsRnJvbUFyZ3MsIG1ha2VJbWFnZUVsZW1lbnRDYWNoZSxcbiAgICAgICAgIElNQUdFX0VMX1RBUF9TVFJBVEVHWV9NSlNPTldQLCBJTUFHRV9FTF9UQVBfU1RSQVRFR1lfVzNDIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
