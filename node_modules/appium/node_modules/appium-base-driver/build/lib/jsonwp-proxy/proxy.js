'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _defineProperty = require('babel-runtime/helpers/define-property')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSupport = require('appium-support');

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _jsonwpStatusStatus = require('../jsonwp-status/status');

var _protocolErrors = require('../protocol/errors');

var _basedriverDriver = require('../basedriver/driver');

var _basedriverDriver2 = _interopRequireDefault(_basedriverDriver);

var _protocolRoutes = require('../protocol/routes');

var log = _appiumSupport.logger.getLogger('JSONWP Proxy');
// TODO: Make this value configurable as a server side capability
var LOG_OBJ_LENGTH = 1024; // MAX LENGTH Logged to file / console
var DEFAULT_REQUEST_TIMEOUT = 240000;

var COMMAND_URLS_CONFLICTS = [{
  commandNames: ['execute', 'executeAsync'],
  jsonwpConverter: function jsonwpConverter(url) {
    return url.replace(/\/execute.*/, url.includes('async') ? '/execute_async' : '/execute');
  },
  w3cConverter: function w3cConverter(url) {
    return url.replace(/\/execute.*/, url.includes('async') ? '/execute/async' : '/execute/sync');
  }
}, {
  commandNames: ['getElementScreenshot'],
  jsonwpConverter: function jsonwpConverter(url) {
    return url.replace(/\/element\/([^\/]+)\/screenshot$/, '/screenshot/$1');
  },
  w3cConverter: function w3cConverter(url) {
    return url.replace(/\/screenshot\/([^\/]+)/, '/element/$1/screenshot');
  }
}, {
  commandNames: ['getWindowHandles', 'getWindowHandle'],
  jsonwpConverter: function jsonwpConverter(url) {
    return url.replace(/\/window\/handle(s?)$/, '/window_handle$1');
  },
  w3cConverter: function w3cConverter(url) {
    return url.replace(/\/window_handle(s?)$/, '/window/handle$1');
  }
}];

var _BaseDriver$DRIVER_PROTOCOL = _basedriverDriver2['default'].DRIVER_PROTOCOL;
var MJSONWP = _BaseDriver$DRIVER_PROTOCOL.MJSONWP;
var W3C = _BaseDriver$DRIVER_PROTOCOL.W3C;

var JWProxy = (function () {
  function JWProxy() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, JWProxy);

    _Object$assign(this, {
      scheme: 'http',
      server: 'localhost',
      port: 4444,
      base: '/wd/hub',
      sessionId: null,
      timeout: DEFAULT_REQUEST_TIMEOUT
    }, opts);
    this.scheme = this.scheme.toLowerCase();
    this._activeRequests = [];
  }

  // abstract the call behind a member function
  // so that we can mock it in tests

  _createClass(JWProxy, [{
    key: 'request',
    value: function request() {
      var currentRequest,
          args$2$0 = arguments;
      return _regeneratorRuntime.async(function request$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            currentRequest = _requestPromise2['default'].apply(undefined, args$2$0);

            this._activeRequests.push(currentRequest);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(currentRequest['finally'](function () {
              return _lodash2['default'].pull(_this._activeRequests, currentRequest);
            }));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getActiveRequestsCount',
    value: function getActiveRequestsCount() {
      return this._activeRequests.length;
    }
  }, {
    key: 'cancelActiveRequests',
    value: function cancelActiveRequests() {
      try {
        var _iteratorNormalCompletion = true;
        var _didIteratorError = false;
        var _iteratorError = undefined;

        try {
          for (var _iterator = _getIterator(this._activeRequests), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
            var r = _step.value;

            r.cancel();
          }
        } catch (err) {
          _didIteratorError = true;
          _iteratorError = err;
        } finally {
          try {
            if (!_iteratorNormalCompletion && _iterator['return']) {
              _iterator['return']();
            }
          } finally {
            if (_didIteratorError) {
              throw _iteratorError;
            }
          }
        }
      } finally {
        this._activeRequests = [];
      }
    }
  }, {
    key: 'endpointRequiresSessionId',
    value: function endpointRequiresSessionId(endpoint) {
      return !_lodash2['default'].includes(['/session', '/sessions', '/status'], endpoint);
    }
  }, {
    key: 'getUrlForProxy',
    value: function getUrlForProxy(url) {
      if (url === '') {
        url = '/';
      }
      var proxyBase = this.scheme + '://' + this.server + ':' + this.port + this.base;
      var endpointRe = '(/(session|status))';
      var remainingUrl = '';
      if (/^http/.test(url)) {
        var first = new RegExp('(https?://.+)' + endpointRe).exec(url);
        if (!first) {
          throw new Error('Got a complete url but could not extract JWP endpoint');
        }
        remainingUrl = url.replace(first[1], '');
      } else if (new RegExp('^/').test(url)) {
        remainingUrl = url;
      } else {
        throw new Error('Did not know what to do with url \'' + url + '\'');
      }

      var stripPrefixRe = new RegExp('^.*?(/(session|status).*)$');
      if (stripPrefixRe.test(remainingUrl)) {
        remainingUrl = stripPrefixRe.exec(remainingUrl)[1];
      }

      if (!new RegExp(endpointRe).test(remainingUrl)) {
        remainingUrl = '/session/' + this.sessionId + remainingUrl;
      }

      var requiresSessionId = this.endpointRequiresSessionId(remainingUrl);

      if (requiresSessionId && this.sessionId === null) {
        throw new Error('Trying to proxy a session command without session id');
      }

      var sessionBaseRe = new RegExp('^/session/([^/]+)');
      if (sessionBaseRe.test(remainingUrl)) {
        // we have something like /session/:id/foobar, so we need to replace
        // the session id
        var match = sessionBaseRe.exec(remainingUrl);
        remainingUrl = remainingUrl.replace(match[1], this.sessionId);
      } else if (requiresSessionId) {
        throw new Error('Could not find :session section for url: ' + remainingUrl);
      }
      remainingUrl = remainingUrl.replace(/\/$/, ''); // can't have trailing slashes

      return proxyBase + remainingUrl;
    }
  }, {
    key: 'proxy',
    value: function proxy(url, method) {
      var body = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];
      var newUrl, reqOpts, res, resBody, resBodyObj, message, err, responseError;
      return _regeneratorRuntime.async(function proxy$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            method = method.toUpperCase();
            newUrl = this.getUrlForProxy(url);
            reqOpts = {
              url: newUrl,
              method: method,
              headers: {
                'content-type': 'application/json; charset=utf-8',
                'user-agent': 'appium',
                accept: '*/*'
              },
              resolveWithFullResponse: true,
              timeout: this.timeout,
              forever: true
            };

            if (body !== null) {
              if (typeof body !== 'object') {
                body = JSON.parse(body);
              }
              reqOpts.json = body;
            }

            // GET methods shouldn't have any body. Most servers are OK with this, but WebDriverAgent throws 400 errors
            if (method === 'GET') {
              reqOpts.json = null;
            }

            log.debug('Proxying [' + method + ' ' + (url || "/") + '] to [' + method + ' ' + newUrl + '] ' + (body ? 'with body: ' + _lodash2['default'].truncate(JSON.stringify(body), { length: LOG_OBJ_LENGTH }) : 'with no body'));

            res = undefined, resBody = undefined;
            context$2$0.prev = 7;
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.request(reqOpts));

          case 10:
            res = context$2$0.sent;

            resBody = res.body;
            log.debug('Got response with status ' + res.statusCode + ': ' + _lodash2['default'].truncate(JSON.stringify(resBody), { length: LOG_OBJ_LENGTH }));
            if (/\/session$/.test(url) && method === 'POST') {
              if (res.statusCode === 200) {
                this.sessionId = resBody.sessionId;
              } else if (res.statusCode === 303) {
                this.sessionId = /\/session\/([^\/]+)/.exec(resBody)[1];
              }
            }
            resBodyObj = _appiumSupport.util.safeJsonParse(resBody);

            if (!this._downstreamProtocol) {
              this._downstreamProtocol = this.getProtocolFromResBody(resBodyObj);
            }

            if (!(res.statusCode < 400 && this._downstreamProtocol === MJSONWP && parseInt(resBodyObj.status, 10) !== 0)) {
              context$2$0.next = 23;
              break;
            }

            message = 'The request to ' + url + ' has failed';
            err = new Error(message);

            err.message = message;
            err.error = resBody;
            err.statusCode = 500;
            throw err;

          case 23:
            context$2$0.next = 30;
            break;

          case 25:
            context$2$0.prev = 25;
            context$2$0.t0 = context$2$0['catch'](7);
            responseError = undefined;

            try {
              responseError = JSON.parse(context$2$0.t0.error);
            } catch (e1) {
              if (!_lodash2['default'].isEmpty(context$2$0.t0.error) && _lodash2['default'].isString(context$2$0.t0.error)) {
                log.warn('Got an unexpected response: ' + _lodash2['default'].truncate(context$2$0.t0.error, { length: 300 }));
              }
              responseError = _lodash2['default'].isPlainObject(context$2$0.t0.error) ? context$2$0.t0.error : null;
            }
            throw new _protocolErrors.errors.ProxyRequestError('Could not proxy command to remote server. ' + ('Original error: ' + context$2$0.t0.message), responseError, context$2$0.t0.statusCode);

          case 30:
            return context$2$0.abrupt('return', [res, resBody]);

          case 31:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[7, 25]]);
    }

    /**
     * W3C /timeouts can take as many as 3 timeout types at once, MJSONWP /timeouts only takes one
     * at a time. So if we're using W3C and proxying to MJSONWP and there's more than one timeout type
     * provided in the request, we need to do 3 proxies and combine the result
     *
     * @param {Object} body Request body
     * @return {Array} Array of W3C + MJSONWP compatible timeout objects
     */
  }, {
    key: 'getTimeoutRequestObjects',
    value: function getTimeoutRequestObjects(body) {
      var downstreamProtocol, typeToW3C, _ret;

      return _regeneratorRuntime.async(function getTimeoutRequestObjects$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            downstreamProtocol = undefined;
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.getDownstreamProtocol());

          case 4:
            downstreamProtocol = context$2$0.sent;
            context$2$0.next = 10;
            break;

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](1);

            log.warn(context$2$0.t0);

          case 10:
            if (downstreamProtocol) {
              context$2$0.next = 13;
              break;
            }

            log.warn('The downstream protocol cannot be detected. Proxying the request body to /timeouts as is');
            return context$2$0.abrupt('return', [body]);

          case 13:
            if (!(downstreamProtocol === W3C && _lodash2['default'].has(body, 'ms') && _lodash2['default'].has(body, 'type'))) {
              context$2$0.next = 16;
              break;
            }

            typeToW3C = function typeToW3C(x) {
              return x === 'page load' ? 'pageLoad' : x;
            };

            return context$2$0.abrupt('return', [_defineProperty({}, typeToW3C(body.type), body.ms)]);

          case 16:
            if (!(downstreamProtocol === MJSONWP && (!_lodash2['default'].has(body, 'ms') || !_lodash2['default'].has(body, 'type')))) {
              context$2$0.next = 20;
              break;
            }

            _ret = (function () {
              var typeToJSONWP = function typeToJSONWP(x) {
                return x === 'pageLoad' ? 'page load' : x;
              };
              return {
                v: _lodash2['default'].toPairs(body).filter(function (pair) {
                  return !isNaN(parseFloat(pair[1]));
                }).map(function (pair) {
                  return {
                    type: typeToJSONWP(pair[0]),
                    ms: pair[1]
                  };
                })
              };
            })();

            if (!(typeof _ret === 'object')) {
              context$2$0.next = 20;
              break;
            }

            return context$2$0.abrupt('return', _ret.v);

          case 20:
            return context$2$0.abrupt('return', [body]);

          case 21:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 7]]);
    }

    /**
     * Proxy an array of timeout objects and merge the result
     * @param {String} url Endpoint url
     * @param {String} method Endpoint method
     * @param {Object} body Request body
     */
  }, {
    key: 'proxySetTimeouts',
    value: function proxySetTimeouts(url, method, body) {
      var response, resBody, timeoutRequestObjects, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, timeoutObj, _ref2, _ref22, protocol;

      return _regeneratorRuntime.async(function proxySetTimeouts$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            response = undefined, resBody = undefined;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getTimeoutRequestObjects(body));

          case 3:
            timeoutRequestObjects = context$2$0.sent;

            log.debug('Will send the following request bodies to /timeouts: ' + JSON.stringify(timeoutRequestObjects));
            _iteratorNormalCompletion2 = true;
            _didIteratorError2 = false;
            _iteratorError2 = undefined;
            context$2$0.prev = 8;
            _iterator2 = _getIterator(timeoutRequestObjects);

          case 10:
            if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
              context$2$0.next = 26;
              break;
            }

            timeoutObj = _step2.value;
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.proxy(url, method, timeoutObj));

          case 14:
            _ref2 = context$2$0.sent;
            _ref22 = _slicedToArray(_ref2, 2);
            response = _ref22[0];
            resBody = _ref22[1];
            protocol = this.getProtocolFromResBody(resBody);

            if (!(protocol !== MJSONWP)) {
              context$2$0.next = 21;
              break;
            }

            return context$2$0.abrupt('return', [response, resBody]);

          case 21:
            if (!(response.statusCode >= 400)) {
              context$2$0.next = 23;
              break;
            }

            return context$2$0.abrupt('return', [response, resBody]);

          case 23:
            _iteratorNormalCompletion2 = true;
            context$2$0.next = 10;
            break;

          case 26:
            context$2$0.next = 32;
            break;

          case 28:
            context$2$0.prev = 28;
            context$2$0.t0 = context$2$0['catch'](8);
            _didIteratorError2 = true;
            _iteratorError2 = context$2$0.t0;

          case 32:
            context$2$0.prev = 32;
            context$2$0.prev = 33;

            if (!_iteratorNormalCompletion2 && _iterator2['return']) {
              _iterator2['return']();
            }

          case 35:
            context$2$0.prev = 35;

            if (!_didIteratorError2) {
              context$2$0.next = 38;
              break;
            }

            throw _iteratorError2;

          case 38:
            return context$2$0.finish(35);

          case 39:
            return context$2$0.finish(32);

          case 40:
            return context$2$0.abrupt('return', [response, resBody]);

          case 41:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[8, 28, 32, 40], [33,, 35, 39]]);
    }
  }, {
    key: 'getProtocolFromResBody',
    value: function getProtocolFromResBody(resBody) {
      if (!_lodash2['default'].isPlainObject(resBody)) {
        try {
          resBody = JSON.parse(resBody);
        } catch (err) {
          return;
        }
      }
      if (_appiumSupport.util.hasValue(resBody.status)) {
        return MJSONWP;
      }
      if (_appiumSupport.util.hasValue(resBody.value)) {
        return W3C;
      }
    }
  }, {
    key: 'getDownstreamProtocol',
    value: function getDownstreamProtocol() {
      var _ref3, _ref32, resBody;

      return _regeneratorRuntime.async(function getDownstreamProtocol$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this._downstreamProtocol) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.proxy('/status', 'GET'));

          case 3:
            _ref3 = context$2$0.sent;
            _ref32 = _slicedToArray(_ref3, 2);
            resBody = _ref32[1];

            this._downstreamProtocol = this.getProtocolFromResBody(resBody);

          case 7:
            return context$2$0.abrupt('return', this._downstreamProtocol);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'requestToCommandName',
    value: function requestToCommandName(url, method) {
      var extractCommandName = function extractCommandName(pattern) {
        var pathMatch = pattern.exec(url);
        return pathMatch ? (0, _protocolRoutes.routeToCommandName)(pathMatch[1], method) : null;
      };
      var commandName = (0, _protocolRoutes.routeToCommandName)(url, method);
      if (!commandName && _lodash2['default'].includes(url, '/wd/hub/session/')) {
        commandName = extractCommandName(/\/wd\/hub\/session\/[^\/]+(.+)/);
      }
      if (!commandName && _lodash2['default'].includes(url, '/wd/hub/')) {
        commandName = extractCommandName(/\/wd\/hub(\/.+)/);
      }
      return commandName;
    }
  }, {
    key: 'proxyCommand',
    value: function proxyCommand(url, method) {
      var body = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];

      var commandName, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, _step3$value,

      // Same arguments, but different URLs

      commandNames, jsonwpConverter, w3cConverter, downstreamProtocol, rewrittenUrl;

      return _regeneratorRuntime.async(function proxyCommand$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            commandName = this.requestToCommandName(url, method);

            if (commandName) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.proxy(url, method, body));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
            log.debug('Matched \'' + url + '\' to command name \'' + commandName + '\'');

            // Handle "crossing" endpoints for the case
            // when upstream and downstream drivers operate different protocols

            // Same url, but different arguments

            if (!(commandName === 'timeouts')) {
              context$2$0.next = 10;
              break;
            }

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.proxySetTimeouts(url, method, body));

          case 9:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 10:
            _iteratorNormalCompletion3 = true;
            _didIteratorError3 = false;
            _iteratorError3 = undefined;
            context$2$0.prev = 13;
            _iterator3 = _getIterator(COMMAND_URLS_CONFLICTS);

          case 15:
            if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
              context$2$0.next = 46;
              break;
            }

            _step3$value = _step3.value;
            commandNames = _step3$value.commandNames;
            jsonwpConverter = _step3$value.jsonwpConverter;
            w3cConverter = _step3$value.w3cConverter;

            if (commandNames.includes(commandName)) {
              context$2$0.next = 22;
              break;
            }

            return context$2$0.abrupt('continue', 43);

          case 22:
            downstreamProtocol = undefined;
            context$2$0.prev = 23;
            context$2$0.next = 26;
            return _regeneratorRuntime.awrap(this.getDownstreamProtocol());

          case 26:
            downstreamProtocol = context$2$0.sent;
            context$2$0.next = 32;
            break;

          case 29:
            context$2$0.prev = 29;
            context$2$0.t0 = context$2$0['catch'](23);

            log.warn(context$2$0.t0);

          case 32:
            if (downstreamProtocol) {
              context$2$0.next = 35;
              break;
            }

            log.warn('The downstream protocol cannot be detected. Proxying as is');
            return context$2$0.abrupt('break', 46);

          case 35:
            rewrittenUrl = downstreamProtocol === MJSONWP ? jsonwpConverter(url) : w3cConverter(url);

            if (!(rewrittenUrl === url)) {
              context$2$0.next = 39;
              break;
            }

            log.debug('Did not know how to rewrite the original URL \'' + url + '\' ' + ('for ' + downstreamProtocol + ' protocol'));
            return context$2$0.abrupt('break', 46);

          case 39:
            log.info('Rewrote the original URL \'' + url + '\' to \'' + rewrittenUrl + '\' ' + ('for ' + downstreamProtocol + ' protocol'));
            context$2$0.next = 42;
            return _regeneratorRuntime.awrap(this.proxy(rewrittenUrl, method, body));

          case 42:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 43:
            _iteratorNormalCompletion3 = true;
            context$2$0.next = 15;
            break;

          case 46:
            context$2$0.next = 52;
            break;

          case 48:
            context$2$0.prev = 48;
            context$2$0.t1 = context$2$0['catch'](13);
            _didIteratorError3 = true;
            _iteratorError3 = context$2$0.t1;

          case 52:
            context$2$0.prev = 52;
            context$2$0.prev = 53;

            if (!_iteratorNormalCompletion3 && _iterator3['return']) {
              _iterator3['return']();
            }

          case 55:
            context$2$0.prev = 55;

            if (!_didIteratorError3) {
              context$2$0.next = 58;
              break;
            }

            throw _iteratorError3;

          case 58:
            return context$2$0.finish(55);

          case 59:
            return context$2$0.finish(52);

          case 60:
            context$2$0.next = 62;
            return _regeneratorRuntime.awrap(this.proxy(url, method, body));

          case 62:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 63:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[13, 48, 52, 60], [23, 29], [53,, 55, 59]]);
    }
  }, {
    key: 'command',
    value: function command(url, method) {
      var body = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];

      var response, resBody, _ref4, _ref42, protocol, _status, message;

      return _regeneratorRuntime.async(function command$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            response = undefined;
            resBody = undefined;
            context$2$0.prev = 2;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.proxyCommand(url, method, body));

          case 5:
            _ref4 = context$2$0.sent;
            _ref42 = _slicedToArray(_ref4, 2);
            response = _ref42[0];
            resBody = _ref42[1];
            context$2$0.next = 16;
            break;

          case 11:
            context$2$0.prev = 11;
            context$2$0.t0 = context$2$0['catch'](2);

            if (!(0, _protocolErrors.isErrorType)(context$2$0.t0, _protocolErrors.errors.ProxyRequestError)) {
              context$2$0.next = 15;
              break;
            }

            throw context$2$0.t0.getActualError();

          case 15:
            throw new _protocolErrors.errors.UnknownError(context$2$0.t0.message);

          case 16:
            resBody = _appiumSupport.util.safeJsonParse(resBody);
            protocol = this.getProtocolFromResBody(resBody);

            if (!(protocol === MJSONWP)) {
              context$2$0.next = 28;
              break;
            }

            if (!(response.statusCode === 200 && resBody.status === 0)) {
              context$2$0.next = 21;
              break;
            }

            return context$2$0.abrupt('return', resBody.value);

          case 21:
            _status = parseInt(resBody.status, 10);

            if (!(!isNaN(_status) && _status !== 0)) {
              context$2$0.next = 26;
              break;
            }

            message = resBody.value;

            if (_lodash2['default'].has(resBody.value, 'message')) {
              message = _lodash2['default'].isEmpty(message) ? resBody.value.message : message + ' ' + resBody.value.message;
            }
            throw (0, _protocolErrors.errorFromMJSONWPStatusCode)(_status, _lodash2['default'].isEmpty(message) ? (0, _jsonwpStatusStatus.getSummaryByCode)(_status) : message);

          case 26:
            context$2$0.next = 37;
            break;

          case 28:
            if (!(protocol === W3C)) {
              context$2$0.next = 35;
              break;
            }

            if (!(response.statusCode < 300)) {
              context$2$0.next = 31;
              break;
            }

            return context$2$0.abrupt('return', resBody.value);

          case 31:
            if (!(_lodash2['default'].isPlainObject(resBody.value) && resBody.value.error)) {
              context$2$0.next = 33;
              break;
            }

            throw (0, _protocolErrors.errorFromW3CJsonCode)(resBody.value.error, resBody.value.message, resBody.value.stacktrace);

          case 33:
            context$2$0.next = 37;
            break;

          case 35:
            if (!(response.statusCode === 200)) {
              context$2$0.next = 37;
              break;
            }

            return context$2$0.abrupt('return', resBody);

          case 37:
            throw new _protocolErrors.errors.UnknownError('Did not know what to do with response code \'' + response.statusCode + '\' ' + ('and response body \'' + _lodash2['default'].truncate(JSON.stringify(resBody), { length: 300 }) + '\''));

          case 38:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[2, 11]]);
    }
  }, {
    key: 'getSessionIdFromUrl',
    value: function getSessionIdFromUrl(url) {
      var match = url.match(/\/session\/([^\/]+)/);
      return match ? match[1] : null;
    }
  }, {
    key: 'proxyReqRes',
    value: function proxyReqRes(req, res) {
      var _ref5, _ref52, response, body, reqSessionId;

      return _regeneratorRuntime.async(function proxyReqRes$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.proxyCommand(req.originalUrl, req.method, req.body));

          case 2:
            _ref5 = context$2$0.sent;
            _ref52 = _slicedToArray(_ref5, 2);
            response = _ref52[0];
            body = _ref52[1];

            res.headers = response.headers;
            res.set('content-type', response.headers['content-type']);
            // if the proxied response contains a sessionId that the downstream
            // driver has generated, we don't want to return that to the client.
            // Instead, return the id from the request or from current session
            body = _appiumSupport.util.safeJsonParse(body);
            if (body && body.sessionId) {
              reqSessionId = this.getSessionIdFromUrl(req.originalUrl);

              if (reqSessionId) {
                log.info('Replacing sessionId ' + body.sessionId + ' with ' + reqSessionId);
                body.sessionId = reqSessionId;
              } else if (this.sessionId) {
                log.info('Replacing sessionId ' + body.sessionId + ' with ' + this.sessionId);
                body.sessionId = this.sessionId;
              }
            }
            res.status(response.statusCode).send(JSON.stringify(body));

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return JWProxy;
})();

exports['default'] = JWProxy;
module.exports = exports['default'];

// Some servers, like chromedriver may return response code 200 for non-zero JSONWP statuses

// If we got a non-MJSONWP response, return the result, nothing left to do

// If we got an error, return the error right away

// ...Otherwise, continue to the next timeouts call

// No matches found. Proceed normally

// Got response in MJSONWP format

// Got response in W3C format

// Unknown protocol. Keeping it because of the backward compatibility
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJveHkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztzQkFBYyxRQUFROzs7OzZCQUNPLGdCQUFnQjs7OEJBQ3pCLGlCQUFpQjs7OztrQ0FDSix5QkFBeUI7OzhCQUM0QixvQkFBb0I7O2dDQUNuRixzQkFBc0I7Ozs7OEJBQ1Ysb0JBQW9COztBQUd2RCxJQUFNLEdBQUcsR0FBRyxzQkFBTyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUM7O0FBRTdDLElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQztBQUM1QixJQUFNLHVCQUF1QixHQUFHLE1BQU0sQ0FBQzs7QUFFdkMsSUFBTSxzQkFBc0IsR0FBRyxDQUM3QjtBQUNFLGNBQVksRUFBRSxDQUFDLFNBQVMsRUFBRSxjQUFjLENBQUM7QUFDekMsaUJBQWUsRUFBRSx5QkFBQyxHQUFHO1dBQUssR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQ2pELEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsZ0JBQWdCLEdBQUcsVUFBVSxDQUFDO0dBQUE7QUFDeEQsY0FBWSxFQUFFLHNCQUFDLEdBQUc7V0FBSyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFDOUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxnQkFBZ0IsR0FBRyxlQUFlLENBQUM7R0FBQTtDQUM5RCxFQUNEO0FBQ0UsY0FBWSxFQUFFLENBQUMsc0JBQXNCLENBQUM7QUFDdEMsaUJBQWUsRUFBRSx5QkFBQyxHQUFHO1dBQUssR0FBRyxDQUFDLE9BQU8sQ0FBQyxrQ0FBa0MsRUFDdEUsZ0JBQWdCLENBQUM7R0FBQTtBQUNuQixjQUFZLEVBQUUsc0JBQUMsR0FBRztXQUFLLEdBQUcsQ0FBQyxPQUFPLENBQUMsd0JBQXdCLEVBQ3pELHdCQUF3QixDQUFDO0dBQUE7Q0FDNUIsRUFDRDtBQUNFLGNBQVksRUFBRSxDQUFDLGtCQUFrQixFQUFFLGlCQUFpQixD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c0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGxvZ2dlciwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgeyBnZXRTdW1tYXJ5QnlDb2RlIH0gZnJvbSAnLi4vanNvbndwLXN0YXR1cy9zdGF0dXMnO1xuaW1wb3J0IHsgZXJyb3JzLCBpc0Vycm9yVHlwZSwgZXJyb3JGcm9tTUpTT05XUFN0YXR1c0NvZGUsIGVycm9yRnJvbVczQ0pzb25Db2RlIH0gZnJvbSAnLi4vcHJvdG9jb2wvZXJyb3JzJztcbmltcG9ydCBCYXNlRHJpdmVyIGZyb20gJy4uL2Jhc2Vkcml2ZXIvZHJpdmVyJztcbmltcG9ydCB7IHJvdXRlVG9Db21tYW5kTmFtZSB9IGZyb20gJy4uL3Byb3RvY29sL3JvdXRlcyc7XG5cblxuY29uc3QgbG9nID0gbG9nZ2VyLmdldExvZ2dlcignSlNPTldQIFByb3h5Jyk7XG4vLyBUT0RPOiBNYWtlIHRoaXMgdmFsdWUgY29uZmlndXJhYmxlIGFzIGEgc2VydmVyIHNpZGUgY2FwYWJpbGl0eVxuY29uc3QgTE9HX09CSl9MRU5HVEggPSAxMDI0OyAvLyBNQVggTEVOR1RIIExvZ2dlZCB0byBmaWxlIC8gY29uc29sZVxuY29uc3QgREVGQVVMVF9SRVFVRVNUX1RJTUVPVVQgPSAyNDAwMDA7XG5cbmNvbnN0IENPTU1BTkRfVVJMU19DT05GTElDVFMgPSBbXG4gIHtcbiAgICBjb21tYW5kTmFtZXM6IFsnZXhlY3V0ZScsICdleGVjdXRlQXN5bmMnXSxcbiAgICBqc29ud3BDb252ZXJ0ZXI6ICh1cmwpID0+IHVybC5yZXBsYWNlKC9cXC9leGVjdXRlLiovLFxuICAgICAgdXJsLmluY2x1ZGVzKCdhc3luYycpID8gJy9leGVjdXRlX2FzeW5jJyA6ICcvZXhlY3V0ZScpLFxuICAgIHczY0NvbnZlcnRlcjogKHVybCkgPT4gdXJsLnJlcGxhY2UoL1xcL2V4ZWN1dGUuKi8sXG4gICAgICB1cmwuaW5jbHVkZXMoJ2FzeW5jJykgPyAnL2V4ZWN1dGUvYXN5bmMnIDogJy9leGVjdXRlL3N5bmMnKSxcbiAgfSxcbiAge1xuICAgIGNvbW1hbmROYW1lczogWydnZXRFbGVtZW50U2NyZWVuc2hvdCddLFxuICAgIGpzb253cENvbnZlcnRlcjogKHVybCkgPT4gdXJsLnJlcGxhY2UoL1xcL2VsZW1lbnRcXC8oW15cXC9dKylcXC9zY3JlZW5zaG90JC8sXG4gICAgICAnL3NjcmVlbnNob3QvJDEnKSxcbiAgICB3M2NDb252ZXJ0ZXI6ICh1cmwpID0+IHVybC5yZXBsYWNlKC9cXC9zY3JlZW5zaG90XFwvKFteXFwvXSspLyxcbiAgICAgICcvZWxlbWVudC8kMS9zY3JlZW5zaG90JyksXG4gIH0sXG4gIHtcbiAgICBjb21tYW5kTmFtZXM6IFsnZ2V0V2luZG93SGFuZGxlcycsICdnZXRXaW5kb3dIYW5kbGUnXSxcbiAgICBqc29ud3BDb252ZXJ0ZXI6ICh1cmwpID0+IHVybC5yZXBsYWNlKC9cXC93aW5kb3dcXC9oYW5kbGUocz8pJC8sXG4gICAgICAnL3dpbmRvd19oYW5kbGUkMScpLFxuICAgIHczY0NvbnZlcnRlcjogKHVybCkgPT4gdXJsLnJlcGxhY2UoL1xcL3dpbmRvd19oYW5kbGUocz8pJC8sXG4gICAgICAnL3dpbmRvdy9oYW5kbGUkMScpLFxuICB9LFxuXTtcblxuY29uc3Qge01KU09OV1AsIFczQ30gPSBCYXNlRHJpdmVyLkRSSVZFUl9QUk9UT0NPTDtcblxuY2xhc3MgSldQcm94eSB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIHtcbiAgICAgIHNjaGVtZTogJ2h0dHAnLFxuICAgICAgc2VydmVyOiAnbG9jYWxob3N0JyxcbiAgICAgIHBvcnQ6IDQ0NDQsXG4gICAgICBiYXNlOiAnL3dkL2h1YicsXG4gICAgICBzZXNzaW9uSWQ6IG51bGwsXG4gICAgICB0aW1lb3V0OiBERUZBVUxUX1JFUVVFU1RfVElNRU9VVCxcbiAgICB9LCBvcHRzKTtcbiAgICB0aGlzLnNjaGVtZSA9IHRoaXMuc2NoZW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgdGhpcy5fYWN0aXZlUmVxdWVzdHMgPSBbXTtcbiAgfVxuXG4gIC8vIGFic3RyYWN0IHRoZSBjYWxsIGJlaGluZCBhIG1lbWJlciBmdW5jdGlvblxuICAvLyBzbyB0aGF0IHdlIGNhbiBtb2NrIGl0IGluIHRlc3RzXG4gIGFzeW5jIHJlcXVlc3QgKC4uLmFyZ3MpIHtcbiAgICBjb25zdCBjdXJyZW50UmVxdWVzdCA9IHJlcXVlc3QoLi4uYXJncyk7XG4gICAgdGhpcy5fYWN0aXZlUmVxdWVzdHMucHVzaChjdXJyZW50UmVxdWVzdCk7XG4gICAgcmV0dXJuIGF3YWl0IGN1cnJlbnRSZXF1ZXN0LmZpbmFsbHkoKCkgPT4gXy5wdWxsKHRoaXMuX2FjdGl2ZVJlcXVlc3RzLCBjdXJyZW50UmVxdWVzdCkpO1xuICB9XG5cbiAgZ2V0QWN0aXZlUmVxdWVzdHNDb3VudCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FjdGl2ZVJlcXVlc3RzLmxlbmd0aDtcbiAgfVxuXG4gIGNhbmNlbEFjdGl2ZVJlcXVlc3RzICgpIHtcbiAgICB0cnkge1xuICAgICAgZm9yIChsZXQgciBvZiB0aGlzLl9hY3RpdmVSZXF1ZXN0cykge1xuICAgICAgICByLmNhbmNlbCgpO1xuICAgICAgfVxuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cyA9IFtdO1xuICAgIH1cbiAgfVxuXG4gIGVuZHBvaW50UmVxdWlyZXNTZXNzaW9uSWQgKGVuZHBvaW50KSB7XG4gICAgcmV0dXJuICFfLmluY2x1ZGVzKFsnL3Nlc3Npb24nLCAnL3Nlc3Npb25zJywgJy9zdGF0dXMnXSwgZW5kcG9pbnQpO1xuICB9XG5cbiAgZ2V0VXJsRm9yUHJveHkgKHVybCkge1xuICAgIGlmICh1cmwgPT09ICcnKSB7XG4gICAgICB1cmwgPSAnLyc7XG4gICAgfVxuICAgIGNvbnN0IHByb3h5QmFzZSA9IGAke3RoaXMuc2NoZW1lfTovLyR7dGhpcy5zZXJ2ZXJ9OiR7dGhpcy5wb3J0fSR7dGhpcy5iYXNlfWA7XG4gICAgY29uc3QgZW5kcG9pbnRSZSA9ICcoLyhzZXNzaW9ufHN0YXR1cykpJztcbiAgICBsZXQgcmVtYWluaW5nVXJsID0gJyc7XG4gICAgaWYgKC9eaHR0cC8udGVzdCh1cmwpKSB7XG4gICAgICBjb25zdCBmaXJzdCA9IChuZXcgUmVnRXhwKGAoaHR0cHM/Oi8vLispJHtlbmRwb2ludFJlfWApKS5leGVjKHVybCk7XG4gICAgICBpZiAoIWZpcnN0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignR290IGEgY29tcGxldGUgdXJsIGJ1dCBjb3VsZCBub3QgZXh0cmFjdCBKV1AgZW5kcG9pbnQnKTtcbiAgICAgIH1cbiAgICAgIHJlbWFpbmluZ1VybCA9IHVybC5yZXBsYWNlKGZpcnN0WzFdLCAnJyk7XG4gICAgfSBlbHNlIGlmICgobmV3IFJlZ0V4cCgnXi8nKSkudGVzdCh1cmwpKSB7XG4gICAgICByZW1haW5pbmdVcmwgPSB1cmw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRGlkIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCB1cmwgJyR7dXJsfSdgKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdHJpcFByZWZpeFJlID0gbmV3IFJlZ0V4cCgnXi4qPygvKHNlc3Npb258c3RhdHVzKS4qKSQnKTtcbiAgICBpZiAoc3RyaXBQcmVmaXhSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHN0cmlwUHJlZml4UmUuZXhlYyhyZW1haW5pbmdVcmwpWzFdO1xuICAgIH1cblxuICAgIGlmICghKG5ldyBSZWdFeHAoZW5kcG9pbnRSZSkpLnRlc3QocmVtYWluaW5nVXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gYC9zZXNzaW9uLyR7dGhpcy5zZXNzaW9uSWR9JHtyZW1haW5pbmdVcmx9YDtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1aXJlc1Nlc3Npb25JZCA9IHRoaXMuZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZChyZW1haW5pbmdVcmwpO1xuXG4gICAgaWYgKHJlcXVpcmVzU2Vzc2lvbklkICYmIHRoaXMuc2Vzc2lvbklkID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyeWluZyB0byBwcm94eSBhIHNlc3Npb24gY29tbWFuZCB3aXRob3V0IHNlc3Npb24gaWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBzZXNzaW9uQmFzZVJlID0gbmV3IFJlZ0V4cCgnXi9zZXNzaW9uLyhbXi9dKyknKTtcbiAgICBpZiAoc2Vzc2lvbkJhc2VSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIC8vIHdlIGhhdmUgc29tZXRoaW5nIGxpa2UgL3Nlc3Npb24vOmlkL2Zvb2Jhciwgc28gd2UgbmVlZCB0byByZXBsYWNlXG4gICAgICAvLyB0aGUgc2Vzc2lvbiBpZFxuICAgICAgY29uc3QgbWF0Y2ggPSBzZXNzaW9uQmFzZVJlLmV4ZWMocmVtYWluaW5nVXJsKTtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHJlbWFpbmluZ1VybC5yZXBsYWNlKG1hdGNoWzFdLCB0aGlzLnNlc3Npb25JZCk7XG4gICAgfSBlbHNlIGlmIChyZXF1aXJlc1Nlc3Npb25JZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCA6c2Vzc2lvbiBzZWN0aW9uIGZvciB1cmw6ICR7cmVtYWluaW5nVXJsfWApO1xuICAgIH1cbiAgICByZW1haW5pbmdVcmwgPSByZW1haW5pbmdVcmwucmVwbGFjZSgvXFwvJC8sICcnKTsgLy8gY2FuJ3QgaGF2ZSB0cmFpbGluZyBzbGFzaGVzXG5cbiAgICByZXR1cm4gcHJveHlCYXNlICsgcmVtYWluaW5nVXJsO1xuICB9XG5cbiAgYXN5bmMgcHJveHkgKHVybCwgbWV0aG9kLCBib2R5ID0gbnVsbCkge1xuICAgIG1ldGhvZCA9IG1ldGhvZC50b1VwcGVyQ2FzZSgpO1xuICAgIGNvbnN0IG5ld1VybCA9IHRoaXMuZ2V0VXJsRm9yUHJveHkodXJsKTtcbiAgICBjb25zdCByZXFPcHRzID0ge1xuICAgICAgdXJsOiBuZXdVcmwsXG4gICAgICBtZXRob2QsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCcsXG4gICAgICAgICd1c2VyLWFnZW50JzogJ2FwcGl1bScsXG4gICAgICAgIGFjY2VwdDogJyovKicsXG4gICAgICB9LFxuICAgICAgcmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2U6IHRydWUsXG4gICAgICB0aW1lb3V0OiB0aGlzLnRpbWVvdXQsXG4gICAgICBmb3JldmVyOiB0cnVlLFxuICAgIH07XG4gICAgaWYgKGJvZHkgIT09IG51bGwpIHtcbiAgICAgIGlmICh0eXBlb2YgYm9keSAhPT0gJ29iamVjdCcpIHtcbiAgICAgICAgYm9keSA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgICB9XG4gICAgICByZXFPcHRzLmpzb24gPSBib2R5O1xuICAgIH1cblxuICAgIC8vIEdFVCBtZXRob2RzIHNob3VsZG4ndCBoYXZlIGFueSBib2R5LiBNb3N0IHNlcnZlcnMgYXJlIE9LIHdpdGggdGhpcywgYnV0IFdlYkRyaXZlckFnZW50IHRocm93cyA0MDAgZXJyb3JzXG4gICAgaWYgKG1ldGhvZCA9PT0gJ0dFVCcpIHtcbiAgICAgIHJlcU9wdHMuanNvbiA9IG51bGw7XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKGBQcm94eWluZyBbJHttZXRob2R9ICR7dXJsIHx8IFwiL1wifV0gdG8gWyR7bWV0aG9kfSAke25ld1VybH1dIGAgK1xuICAgICAgICAgICAgIChib2R5ID8gYHdpdGggYm9keTogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KGJvZHkpLCB7bGVuZ3RoOiBMT0dfT0JKX0xFTkdUSH0pfWAgOiAnd2l0aCBubyBib2R5JykpO1xuXG4gICAgbGV0IHJlcywgcmVzQm9keTtcbiAgICB0cnkge1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy5yZXF1ZXN0KHJlcU9wdHMpO1xuICAgICAgcmVzQm9keSA9IHJlcy5ib2R5O1xuICAgICAgbG9nLmRlYnVnKGBHb3QgcmVzcG9uc2Ugd2l0aCBzdGF0dXMgJHtyZXMuc3RhdHVzQ29kZX06ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShyZXNCb2R5KSwge2xlbmd0aDogTE9HX09CSl9MRU5HVEh9KX1gKTtcbiAgICAgIGlmICgvXFwvc2Vzc2lvbiQvLnRlc3QodXJsKSAmJiBtZXRob2QgPT09ICdQT1NUJykge1xuICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgICAgIHRoaXMuc2Vzc2lvbklkID0gcmVzQm9keS5zZXNzaW9uSWQ7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDMwMykge1xuICAgICAgICAgIHRoaXMuc2Vzc2lvbklkID0gL1xcL3Nlc3Npb25cXC8oW15cXC9dKykvLmV4ZWMocmVzQm9keSlbMV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbnN0IHJlc0JvZHlPYmogPSB1dGlsLnNhZmVKc29uUGFyc2UocmVzQm9keSk7XG4gICAgICBpZiAoIXRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCkge1xuICAgICAgICB0aGlzLl9kb3duc3RyZWFtUHJvdG9jb2wgPSB0aGlzLmdldFByb3RvY29sRnJvbVJlc0JvZHkocmVzQm9keU9iaik7XG4gICAgICB9XG4gICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPCA0MDAgJiYgdGhpcy5fZG93bnN0cmVhbVByb3RvY29sID09PSBNSlNPTldQICYmIHBhcnNlSW50KHJlc0JvZHlPYmouc3RhdHVzLCAxMCkgIT09IDApIHtcbiAgICAgICAgLy8gU29tZSBzZXJ2ZXJzLCBsaWtlIGNocm9tZWRyaXZlciBtYXkgcmV0dXJuIHJlc3BvbnNlIGNvZGUgMjAwIGZvciBub24temVybyBKU09OV1Agc3RhdHVzZXNcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IGBUaGUgcmVxdWVzdCB0byAke3VybH0gaGFzIGZhaWxlZGA7XG4gICAgICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgICAgICAgZXJyLm1lc3NhZ2UgPSBtZXNzYWdlO1xuICAgICAgICBlcnIuZXJyb3IgPSByZXNCb2R5O1xuICAgICAgICBlcnIuc3RhdHVzQ29kZSA9IDUwMDtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxldCByZXNwb25zZUVycm9yO1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmVzcG9uc2VFcnJvciA9IEpTT04ucGFyc2UoZS5lcnJvcik7XG4gICAgICB9IGNhdGNoIChlMSkge1xuICAgICAgICBpZiAoIV8uaXNFbXB0eShlLmVycm9yKSAmJiBfLmlzU3RyaW5nKGUuZXJyb3IpKSB7XG4gICAgICAgICAgbG9nLndhcm4oYEdvdCBhbiB1bmV4cGVjdGVkIHJlc3BvbnNlOiAke18udHJ1bmNhdGUoZS5lcnJvciwge2xlbmd0aDogMzAwfSl9YCk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzcG9uc2VFcnJvciA9IF8uaXNQbGFpbk9iamVjdChlLmVycm9yKSA/IGUuZXJyb3IgOiBudWxsO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Qcm94eVJlcXVlc3RFcnJvcihgQ291bGQgbm90IHByb3h5IGNvbW1hbmQgdG8gcmVtb3RlIHNlcnZlci4gYCAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCwgcmVzcG9uc2VFcnJvciwgZS5zdGF0dXNDb2RlKTtcbiAgICB9XG4gICAgcmV0dXJuIFtyZXMsIHJlc0JvZHldO1xuICB9XG5cbiAgLyoqXG4gICAqIFczQyAvdGltZW91dHMgY2FuIHRha2UgYXMgbWFueSBhcyAzIHRpbWVvdXQgdHlwZXMgYXQgb25jZSwgTUpTT05XUCAvdGltZW91dHMgb25seSB0YWtlcyBvbmVcbiAgICogYXQgYSB0aW1lLiBTbyBpZiB3ZSdyZSB1c2luZyBXM0MgYW5kIHByb3h5aW5nIHRvIE1KU09OV1AgYW5kIHRoZXJlJ3MgbW9yZSB0aGFuIG9uZSB0aW1lb3V0IHR5cGVcbiAgICogcHJvdmlkZWQgaW4gdGhlIHJlcXVlc3QsIHdlIG5lZWQgdG8gZG8gMyBwcm94aWVzIGFuZCBjb21iaW5lIHRoZSByZXN1bHRcbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IGJvZHkgUmVxdWVzdCBib2R5XG4gICAqIEByZXR1cm4ge0FycmF5fSBBcnJheSBvZiBXM0MgKyBNSlNPTldQIGNvbXBhdGlibGUgdGltZW91dCBvYmplY3RzXG4gICAqL1xuICBhc3luYyBnZXRUaW1lb3V0UmVxdWVzdE9iamVjdHMgKGJvZHkpIHtcbiAgICBsZXQgZG93bnN0cmVhbVByb3RvY29sO1xuICAgIHRyeSB7XG4gICAgICBkb3duc3RyZWFtUHJvdG9jb2wgPSBhd2FpdCB0aGlzLmdldERvd25zdHJlYW1Qcm90b2NvbCgpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oZXJyKTtcbiAgICB9XG4gICAgaWYgKCFkb3duc3RyZWFtUHJvdG9jb2wpIHtcbiAgICAgIGxvZy53YXJuKCdUaGUgZG93bnN0cmVhbSBwcm90b2NvbCBjYW5ub3QgYmUgZGV0ZWN0ZWQuIFByb3h5aW5nIHRoZSByZXF1ZXN0IGJvZHkgdG8gL3RpbWVvdXRzIGFzIGlzJyk7XG4gICAgICByZXR1cm4gW2JvZHldO1xuICAgIH1cblxuICAgIGlmIChkb3duc3RyZWFtUHJvdG9jb2wgPT09IFczQyAmJiBfLmhhcyhib2R5LCAnbXMnKSAmJiBfLmhhcyhib2R5LCAndHlwZScpKSB7XG4gICAgICBjb25zdCB0eXBlVG9XM0MgPSAoeCkgPT4geCA9PT0gJ3BhZ2UgbG9hZCcgPyAncGFnZUxvYWQnIDogeDtcbiAgICAgIHJldHVybiBbe1xuICAgICAgICBbdHlwZVRvVzNDKGJvZHkudHlwZSldOiBib2R5Lm1zLFxuICAgICAgfV07XG4gICAgfVxuXG4gICAgaWYgKGRvd25zdHJlYW1Qcm90b2NvbCA9PT0gTUpTT05XUCAmJiAoIV8uaGFzKGJvZHksICdtcycpIHx8ICFfLmhhcyhib2R5LCAndHlwZScpKSkge1xuICAgICAgY29uc3QgdHlwZVRvSlNPTldQID0gKHgpID0+IHggPT09ICdwYWdlTG9hZCcgPyAncGFnZSBsb2FkJyA6IHg7XG4gICAgICByZXR1cm4gXy50b1BhaXJzKGJvZHkpXG4gICAgICAgIC5maWx0ZXIoKHBhaXIpID0+ICFpc05hTihwYXJzZUZsb2F0KHBhaXJbMV0pKSlcbiAgICAgICAgLm1hcCgocGFpcikgPT4ge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0eXBlOiB0eXBlVG9KU09OV1AocGFpclswXSksXG4gICAgICAgICAgICBtczogcGFpclsxXSxcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gW2JvZHldO1xuICB9XG5cbiAgLyoqXG4gICAqIFByb3h5IGFuIGFycmF5IG9mIHRpbWVvdXQgb2JqZWN0cyBhbmQgbWVyZ2UgdGhlIHJlc3VsdFxuICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsIEVuZHBvaW50IHVybFxuICAgKiBAcGFyYW0ge1N0cmluZ30gbWV0aG9kIEVuZHBvaW50IG1ldGhvZFxuICAgKiBAcGFyYW0ge09iamVjdH0gYm9keSBSZXF1ZXN0IGJvZHlcbiAgICovXG4gIGFzeW5jIHByb3h5U2V0VGltZW91dHMgKHVybCwgbWV0aG9kLCBib2R5KSB7XG4gICAgbGV0IHJlc3BvbnNlLCByZXNCb2R5O1xuXG4gICAgY29uc3QgdGltZW91dFJlcXVlc3RPYmplY3RzID0gYXdhaXQgdGhpcy5nZXRUaW1lb3V0UmVxdWVzdE9iamVjdHMoYm9keSk7XG4gICAgbG9nLmRlYnVnKGBXaWxsIHNlbmQgdGhlIGZvbGxvd2luZyByZXF1ZXN0IGJvZGllcyB0byAvdGltZW91dHM6ICR7SlNPTi5zdHJpbmdpZnkodGltZW91dFJlcXVlc3RPYmplY3RzKX1gKTtcbiAgICBmb3IgKGNvbnN0IHRpbWVvdXRPYmogb2YgdGltZW91dFJlcXVlc3RPYmplY3RzKSB7XG4gICAgICBbcmVzcG9uc2UsIHJlc0JvZHldID0gYXdhaXQgdGhpcy5wcm94eSh1cmwsIG1ldGhvZCwgdGltZW91dE9iaik7XG5cbiAgICAgIGNvbnN0IHByb3RvY29sID0gdGhpcy5nZXRQcm90b2NvbEZyb21SZXNCb2R5KHJlc0JvZHkpO1xuXG4gICAgICAvLyBJZiB3ZSBnb3QgYSBub24tTUpTT05XUCByZXNwb25zZSwgcmV0dXJuIHRoZSByZXN1bHQsIG5vdGhpbmcgbGVmdCB0byBkb1xuICAgICAgaWYgKHByb3RvY29sICE9PSBNSlNPTldQKSB7XG4gICAgICAgIHJldHVybiBbcmVzcG9uc2UsIHJlc0JvZHldO1xuICAgICAgfVxuXG4gICAgICAvLyBJZiB3ZSBnb3QgYW4gZXJyb3IsIHJldHVybiB0aGUgZXJyb3IgcmlnaHQgYXdheVxuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPj0gNDAwKSB7XG4gICAgICAgIHJldHVybiBbcmVzcG9uc2UsIHJlc0JvZHldO1xuICAgICAgfVxuXG4gICAgICAvLyAuLi5PdGhlcndpc2UsIGNvbnRpbnVlIHRvIHRoZSBuZXh0IHRpbWVvdXRzIGNhbGxcbiAgICB9XG4gICAgcmV0dXJuIFtyZXNwb25zZSwgcmVzQm9keV07XG4gIH1cblxuICBnZXRQcm90b2NvbEZyb21SZXNCb2R5IChyZXNCb2R5KSB7XG4gICAgaWYgKCFfLmlzUGxhaW5PYmplY3QocmVzQm9keSkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJlc0JvZHkgPSBKU09OLnBhcnNlKHJlc0JvZHkpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHV0aWwuaGFzVmFsdWUocmVzQm9keS5zdGF0dXMpKSB7XG4gICAgICByZXR1cm4gTUpTT05XUDtcbiAgICB9XG4gICAgaWYgKHV0aWwuaGFzVmFsdWUocmVzQm9keS52YWx1ZSkpIHtcbiAgICAgIHJldHVybiBXM0M7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0RG93bnN0cmVhbVByb3RvY29sICgpIHtcbiAgICBpZiAoIXRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCkge1xuICAgICAgY29uc3QgWywgcmVzQm9keV0gPSBhd2FpdCB0aGlzLnByb3h5KCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgICAgdGhpcy5fZG93bnN0cmVhbVByb3RvY29sID0gdGhpcy5nZXRQcm90b2NvbEZyb21SZXNCb2R5KHJlc0JvZHkpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fZG93bnN0cmVhbVByb3RvY29sO1xuICB9XG5cbiAgcmVxdWVzdFRvQ29tbWFuZE5hbWUgKHVybCwgbWV0aG9kKSB7XG4gICAgY29uc3QgZXh0cmFjdENvbW1hbmROYW1lID0gKHBhdHRlcm4pID0+IHtcbiAgICAgIGNvbnN0IHBhdGhNYXRjaCA9IHBhdHRlcm4uZXhlYyh1cmwpO1xuICAgICAgcmV0dXJuIHBhdGhNYXRjaCA/IHJvdXRlVG9Db21tYW5kTmFtZShwYXRoTWF0Y2hbMV0sIG1ldGhvZCkgOiBudWxsO1xuICAgIH07XG4gICAgbGV0IGNvbW1hbmROYW1lID0gcm91dGVUb0NvbW1hbmROYW1lKHVybCwgbWV0aG9kKTtcbiAgICBpZiAoIWNvbW1hbmROYW1lICYmIF8uaW5jbHVkZXModXJsLCAnL3dkL2h1Yi9zZXNzaW9uLycpKSB7XG4gICAgICBjb21tYW5kTmFtZSA9IGV4dHJhY3RDb21tYW5kTmFtZSgvXFwvd2RcXC9odWJcXC9zZXNzaW9uXFwvW15cXC9dKyguKykvKTtcbiAgICB9XG4gICAgaWYgKCFjb21tYW5kTmFtZSAmJiBfLmluY2x1ZGVzKHVybCwgJy93ZC9odWIvJykpIHtcbiAgICAgIGNvbW1hbmROYW1lID0gZXh0cmFjdENvbW1hbmROYW1lKC9cXC93ZFxcL2h1YihcXC8uKykvKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbW1hbmROYW1lO1xuICB9XG5cbiAgYXN5bmMgcHJveHlDb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBjb25zdCBjb21tYW5kTmFtZSA9IHRoaXMucmVxdWVzdFRvQ29tbWFuZE5hbWUodXJsLCBtZXRob2QpO1xuICAgIGlmICghY29tbWFuZE5hbWUpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5KHVybCwgbWV0aG9kLCBib2R5KTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBNYXRjaGVkICcke3VybH0nIHRvIGNvbW1hbmQgbmFtZSAnJHtjb21tYW5kTmFtZX0nYCk7XG5cbiAgICAvLyBIYW5kbGUgXCJjcm9zc2luZ1wiIGVuZHBvaW50cyBmb3IgdGhlIGNhc2VcbiAgICAvLyB3aGVuIHVwc3RyZWFtIGFuZCBkb3duc3RyZWFtIGRyaXZlcnMgb3BlcmF0ZSBkaWZmZXJlbnQgcHJvdG9jb2xzXG5cbiAgICAvLyBTYW1lIHVybCwgYnV0IGRpZmZlcmVudCBhcmd1bWVudHNcblxuICAgIGlmIChjb21tYW5kTmFtZSA9PT0gJ3RpbWVvdXRzJykgIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5U2V0VGltZW91dHModXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIH1cblxuICAgIC8vIFNhbWUgYXJndW1lbnRzLCBidXQgZGlmZmVyZW50IFVSTHNcblxuICAgIGZvciAoY29uc3Qge2NvbW1hbmROYW1lcywganNvbndwQ29udmVydGVyLCB3M2NDb252ZXJ0ZXJ9IG9mIENPTU1BTkRfVVJMU19DT05GTElDVFMpIHtcbiAgICAgIGlmICghY29tbWFuZE5hbWVzLmluY2x1ZGVzKGNvbW1hbmROYW1lKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgbGV0IGRvd25zdHJlYW1Qcm90b2NvbDtcbiAgICAgIHRyeSB7XG4gICAgICAgIGRvd25zdHJlYW1Qcm90b2NvbCA9IGF3YWl0IHRoaXMuZ2V0RG93bnN0cmVhbVByb3RvY29sKCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nLndhcm4oZXJyKTtcbiAgICAgIH1cbiAgICAgIGlmICghZG93bnN0cmVhbVByb3RvY29sKSB7XG4gICAgICAgIGxvZy53YXJuKCdUaGUgZG93bnN0cmVhbSBwcm90b2NvbCBjYW5ub3QgYmUgZGV0ZWN0ZWQuIFByb3h5aW5nIGFzIGlzJyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY29uc3QgcmV3cml0dGVuVXJsID0gZG93bnN0cmVhbVByb3RvY29sID09PSBNSlNPTldQXG4gICAgICAgID8ganNvbndwQ29udmVydGVyKHVybClcbiAgICAgICAgOiB3M2NDb252ZXJ0ZXIodXJsKTtcbiAgICAgIGlmIChyZXdyaXR0ZW5VcmwgPT09IHVybCkge1xuICAgICAgICBsb2cuZGVidWcoYERpZCBub3Qga25vdyBob3cgdG8gcmV3cml0ZSB0aGUgb3JpZ2luYWwgVVJMICcke3VybH0nIGAgK1xuICAgICAgICAgIGBmb3IgJHtkb3duc3RyZWFtUHJvdG9jb2x9IHByb3RvY29sYCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgbG9nLmluZm8oYFJld3JvdGUgdGhlIG9yaWdpbmFsIFVSTCAnJHt1cmx9JyB0byAnJHtyZXdyaXR0ZW5Vcmx9JyBgICtcbiAgICAgICAgYGZvciAke2Rvd25zdHJlYW1Qcm90b2NvbH0gcHJvdG9jb2xgKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5KHJld3JpdHRlblVybCwgbWV0aG9kLCBib2R5KTtcbiAgICB9XG5cbiAgICAvLyBObyBtYXRjaGVzIGZvdW5kLiBQcm9jZWVkIG5vcm1hbGx5XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHkodXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG5cbiAgYXN5bmMgY29tbWFuZCAodXJsLCBtZXRob2QsIGJvZHkgPSBudWxsKSB7XG4gICAgbGV0IHJlc3BvbnNlO1xuICAgIGxldCByZXNCb2R5O1xuICAgIHRyeSB7XG4gICAgICBbcmVzcG9uc2UsIHJlc0JvZHldID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGlzRXJyb3JUeXBlKGVyciwgZXJyb3JzLlByb3h5UmVxdWVzdEVycm9yKSkge1xuICAgICAgICB0aHJvdyBlcnIuZ2V0QWN0dWFsRXJyb3IoKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKGVyci5tZXNzYWdlKTtcbiAgICB9XG4gICAgcmVzQm9keSA9IHV0aWwuc2FmZUpzb25QYXJzZShyZXNCb2R5KTtcbiAgICBsZXQgcHJvdG9jb2wgPSB0aGlzLmdldFByb3RvY29sRnJvbVJlc0JvZHkocmVzQm9keSk7XG4gICAgaWYgKHByb3RvY29sID09PSBNSlNPTldQKSB7XG4gICAgICAvLyBHb3QgcmVzcG9uc2UgaW4gTUpTT05XUCBmb3JtYXRcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDAgJiYgcmVzQm9keS5zdGF0dXMgPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJlc0JvZHkudmFsdWU7XG4gICAgICB9XG4gICAgICBjb25zdCBzdGF0dXMgPSBwYXJzZUludChyZXNCb2R5LnN0YXR1cywgMTApO1xuICAgICAgaWYgKCFpc05hTihzdGF0dXMpICYmIHN0YXR1cyAhPT0gMCkge1xuICAgICAgICBsZXQgbWVzc2FnZSA9IHJlc0JvZHkudmFsdWU7XG4gICAgICAgIGlmIChfLmhhcyhyZXNCb2R5LnZhbHVlLCAnbWVzc2FnZScpKSB7XG4gICAgICAgICAgbWVzc2FnZSA9IF8uaXNFbXB0eShtZXNzYWdlKSA/IHJlc0JvZHkudmFsdWUubWVzc2FnZSA6IGAke21lc3NhZ2V9ICR7cmVzQm9keS52YWx1ZS5tZXNzYWdlfWA7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZXJyb3JGcm9tTUpTT05XUFN0YXR1c0NvZGUoc3RhdHVzLCBfLmlzRW1wdHkobWVzc2FnZSkgPyBnZXRTdW1tYXJ5QnlDb2RlKHN0YXR1cykgOiBtZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHByb3RvY29sID09PSBXM0MpIHtcbiAgICAgIC8vIEdvdCByZXNwb25zZSBpbiBXM0MgZm9ybWF0XG4gICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA8IDMwMCkge1xuICAgICAgICByZXR1cm4gcmVzQm9keS52YWx1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QocmVzQm9keS52YWx1ZSkgJiYgcmVzQm9keS52YWx1ZS5lcnJvcikge1xuICAgICAgICB0aHJvdyBlcnJvckZyb21XM0NKc29uQ29kZShyZXNCb2R5LnZhbHVlLmVycm9yLCByZXNCb2R5LnZhbHVlLm1lc3NhZ2UsIHJlc0JvZHkudmFsdWUuc3RhY2t0cmFjZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDApIHtcbiAgICAgIC8vIFVua25vd24gcHJvdG9jb2wuIEtlZXBpbmcgaXQgYmVjYXVzZSBvZiB0aGUgYmFja3dhcmQgY29tcGF0aWJpbGl0eVxuICAgICAgcmV0dXJuIHJlc0JvZHk7XG4gICAgfVxuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKGBEaWQgbm90IGtub3cgd2hhdCB0byBkbyB3aXRoIHJlc3BvbnNlIGNvZGUgJyR7cmVzcG9uc2Uuc3RhdHVzQ29kZX0nIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBhbmQgcmVzcG9uc2UgYm9keSAnJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KHJlc0JvZHkpLCB7bGVuZ3RoOiAzMDB9KX0nYCk7XG4gIH1cblxuICBnZXRTZXNzaW9uSWRGcm9tVXJsICh1cmwpIHtcbiAgICBjb25zdCBtYXRjaCA9IHVybC5tYXRjaCgvXFwvc2Vzc2lvblxcLyhbXlxcL10rKS8pO1xuICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogbnVsbDtcbiAgfVxuXG4gIGFzeW5jIHByb3h5UmVxUmVzIChyZXEsIHJlcykge1xuICAgIGxldCBbcmVzcG9uc2UsIGJvZHldID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQocmVxLm9yaWdpbmFsVXJsLCByZXEubWV0aG9kLCByZXEuYm9keSk7XG5cbiAgICByZXMuaGVhZGVycyA9IHJlc3BvbnNlLmhlYWRlcnM7XG4gICAgcmVzLnNldCgnY29udGVudC10eXBlJywgcmVzcG9uc2UuaGVhZGVyc1snY29udGVudC10eXBlJ10pO1xuICAgIC8vIGlmIHRoZSBwcm94aWVkIHJlc3BvbnNlIGNvbnRhaW5zIGEgc2Vzc2lvbklkIHRoYXQgdGhlIGRvd25zdHJlYW1cbiAgICAvLyBkcml2ZXIgaGFzIGdlbmVyYXRlZCwgd2UgZG9uJ3Qgd2FudCB0byByZXR1cm4gdGhhdCB0byB0aGUgY2xpZW50LlxuICAgIC8vIEluc3RlYWQsIHJldHVybiB0aGUgaWQgZnJvbSB0aGUgcmVxdWVzdCBvciBmcm9tIGN1cnJlbnQgc2Vzc2lvblxuICAgIGJvZHkgPSB1dGlsLnNhZmVKc29uUGFyc2UoYm9keSk7XG4gICAgaWYgKGJvZHkgJiYgYm9keS5zZXNzaW9uSWQpIHtcbiAgICAgIGNvbnN0IHJlcVNlc3Npb25JZCA9IHRoaXMuZ2V0U2Vzc2lvbklkRnJvbVVybChyZXEub3JpZ2luYWxVcmwpO1xuICAgICAgaWYgKHJlcVNlc3Npb25JZCkge1xuICAgICAgICBsb2cuaW5mbyhgUmVwbGFjaW5nIHNlc3Npb25JZCAke2JvZHkuc2Vzc2lvbklkfSB3aXRoICR7cmVxU2Vzc2lvbklkfWApO1xuICAgICAgICBib2R5LnNlc3Npb25JZCA9IHJlcVNlc3Npb25JZDtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5zZXNzaW9uSWQpIHtcbiAgICAgICAgbG9nLmluZm8oYFJlcGxhY2luZyBzZXNzaW9uSWQgJHtib2R5LnNlc3Npb25JZH0gd2l0aCAke3RoaXMuc2Vzc2lvbklkfWApO1xuICAgICAgICBib2R5LnNlc3Npb25JZCA9IHRoaXMuc2Vzc2lvbklkO1xuICAgICAgfVxuICAgIH1cbiAgICByZXMuc3RhdHVzKHJlc3BvbnNlLnN0YXR1c0NvZGUpLnNlbmQoSlNPTi5zdHJpbmdpZnkoYm9keSkpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEpXUHJveHk7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
