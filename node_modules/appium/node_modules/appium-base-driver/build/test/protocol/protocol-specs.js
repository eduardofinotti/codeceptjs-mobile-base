require('source-map-support').install();

'use strict';

var _defineProperty = require('babel-runtime/helpers/define-property')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

require('../..');

// NOTE: For some reason this file needs to be imported to prevent a babel error

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _libProtocolProtocol = require('../../lib/protocol/protocol');

var _libBasedriverDriver = require('../../lib/basedriver/driver');

var _libBasedriverDriver2 = _interopRequireDefault(_libBasedriverDriver);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('Protocol', function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:

        describe('#parseProtocol', function () {
          it('should parse {protocol: "MJSONWP"} as MJSONWP', function () {
            (0, _libProtocolProtocol.parseProtocol)({ protocol: 'MJSONWP', value: undefined }).should.eql({ isW3C: false, isMJSONWP: true, value: undefined });
          });
          it('should parse {protocol: "W3C"} as W3C', function () {
            (0, _libProtocolProtocol.parseProtocol)({ protocol: 'W3C', value: undefined }).should.eql({ isW3C: true, isMJSONWP: false, value: undefined });
          });
          it('should parse {protocol: "MJSONWP", value: false} as MJSONWP with value: false', function () {
            (0, _libProtocolProtocol.parseProtocol)({ protocol: 'MJSONWP', value: false }).should.eql({ isW3C: false, isMJSONWP: true, value: false });
          });
          it('should parse {protocol: "W3C", value: 0} as W3C with value: 0', function () {
            (0, _libProtocolProtocol.parseProtocol)({ protocol: 'W3C', value: 0 }).should.eql({ isW3C: true, isMJSONWP: false, value: 0 });
          });
          it('should parse {protocol: "MJSONWP", value: "string"}', function () {
            (0, _libProtocolProtocol.parseProtocol)({ protocol: 'MJSONWP', value: "string" }).should.eql({ isW3C: false, isMJSONWP: true, value: "string" });
          });
          it('should parse {protocol: "W3C", value: {obj}}', function () {
            var value = { hello: 'world', goodbye: 'whirl' };
            (0, _libProtocolProtocol.parseProtocol)({ protocol: 'MJSONWP', value: value }).should.eql({ isW3C: false, isMJSONWP: true, value: value });
          });
          it('should throw if {protocol: "MJSONWP", error}', function () {
            var error = new Error('some error');
            (0, _libProtocolProtocol.parseProtocol)({ protocol: 'W3C', error: error }).error.should.equal(error);
          });
        });

        describe('#driverShouldDoJwpProxy', function () {
          it('should not proxy if an image element is found in request url', function () {
            var d = new _libBasedriverDriver2['default']();
            _sinon2['default'].stub(d, 'proxyActive').returns(true);
            _sinon2['default'].stub(d, 'proxyRouteIsAvoided').returns(false);
            var hasImageElements = ['/wd/hub/session/:sessionId/element/' + _libProtocolProtocol.IMAGE_ELEMENT_PREFIX + 'bar', '/wd/hub/session/:sessionId/element/' + _libProtocolProtocol.IMAGE_ELEMENT_PREFIX + 'bar/click', '/wd/hub/session/:sessionId/element/' + _libProtocolProtocol.IMAGE_ELEMENT_PREFIX + 'bar/submit', '/wd/hub/session/:sessionId/screenshot/' + _libProtocolProtocol.IMAGE_ELEMENT_PREFIX + 'bar'];
            var noImageElements = ['/wd/hub/session/:sessionId/element/' + _libProtocolProtocol.IMAGE_ELEMENT_PREFIX, '/wd/hub/session/:sessionId/screenshot/' + _libProtocolProtocol.IMAGE_ELEMENT_PREFIX, '/wd/hub/session/:sessionId/element/bar' + _libProtocolProtocol.IMAGE_ELEMENT_PREFIX, '/wd/hub/session/:sessionId/element/element123', '/wd/hub/session/:sessionId/title', '/wd/hub/session/:sessionId/notelement/' + _libProtocolProtocol.IMAGE_ELEMENT_PREFIX + 'bar'];
            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
              for (var _iterator = _getIterator(hasImageElements), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                var testCase = _step.value;

                var req = { body: {}, params: {}, originalUrl: testCase };
                (0, _libProtocolProtocol.driverShouldDoJwpProxy)(d, req, null).should.be['false'];
              }
            } catch (err) {
              _didIteratorError = true;
              _iteratorError = err;
            } finally {
              try {
                if (!_iteratorNormalCompletion && _iterator['return']) {
                  _iterator['return']();
                }
              } finally {
                if (_didIteratorError) {
                  throw _iteratorError;
                }
              }
            }

            var _iteratorNormalCompletion2 = true;
            var _didIteratorError2 = false;
            var _iteratorError2 = undefined;

            try {
              for (var _iterator2 = _getIterator(noImageElements), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                var testCase = _step2.value;

                var req = { body: {}, params: {}, originalUrl: testCase };
                (0, _libProtocolProtocol.driverShouldDoJwpProxy)(d, req, null).should.be['true'];
              }
            } catch (err) {
              _didIteratorError2 = true;
              _iteratorError2 = err;
            } finally {
              try {
                if (!_iteratorNormalCompletion2 && _iterator2['return']) {
                  _iterator2['return']();
                }
              } finally {
                if (_didIteratorError2) {
                  throw _iteratorError2;
                }
              }
            }
          });
          it('should not proxy if an image element is found in request body', function () {
            var d = new _libBasedriverDriver2['default']();
            _sinon2['default'].stub(d, 'proxyActive').returns(true);
            _sinon2['default'].stub(d, 'proxyRouteIsAvoided').returns(false);
            var hasImageElements = [_defineProperty({}, _libProtocolProtocol.W3C_ELEMENT_KEY, _libProtocolProtocol.IMAGE_ELEMENT_PREFIX + 'bar'), _defineProperty({}, _libProtocolProtocol.W3C_ELEMENT_KEY, _libProtocolProtocol.IMAGE_ELEMENT_PREFIX + 'foo'), _defineProperty({}, _libProtocolProtocol.MJSONWP_ELEMENT_KEY, _libProtocolProtocol.IMAGE_ELEMENT_PREFIX + 'bar')];
            var noImageElements = [_defineProperty({}, _libProtocolProtocol.IMAGE_ELEMENT_PREFIX, 'foo'), _defineProperty({}, _libProtocolProtocol.W3C_ELEMENT_KEY, '' + _libProtocolProtocol.IMAGE_ELEMENT_PREFIX), _defineProperty({}, _libProtocolProtocol.MJSONWP_ELEMENT_KEY, '' + _libProtocolProtocol.IMAGE_ELEMENT_PREFIX), {
              foo: 'bar'
            }, _defineProperty({}, _libProtocolProtocol.W3C_ELEMENT_KEY, 'bar'), _defineProperty({}, _libProtocolProtocol.MJSONWP_ELEMENT_KEY, 'bar'), {
              foo: _libProtocolProtocol.IMAGE_ELEMENT_PREFIX + 'bar'
            }, {
              foo: 'bar' + _libProtocolProtocol.IMAGE_ELEMENT_PREFIX
            }, _defineProperty({}, _libProtocolProtocol.W3C_ELEMENT_KEY, 'bar' + _libProtocolProtocol.IMAGE_ELEMENT_PREFIX), _defineProperty({}, _libProtocolProtocol.MJSONWP_ELEMENT_KEY, 'bar' + _libProtocolProtocol.IMAGE_ELEMENT_PREFIX)];
            var _iteratorNormalCompletion3 = true;
            var _didIteratorError3 = false;
            var _iteratorError3 = undefined;

            try {
              for (var _iterator3 = _getIterator(hasImageElements), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
                var testCase = _step3.value;

                var req = { body: testCase, params: {} };
                (0, _libProtocolProtocol.driverShouldDoJwpProxy)(d, req, null).should.be['false'];
              }
            } catch (err) {
              _didIteratorError3 = true;
              _iteratorError3 = err;
            } finally {
              try {
                if (!_iteratorNormalCompletion3 && _iterator3['return']) {
                  _iterator3['return']();
                }
              } finally {
                if (_didIteratorError3) {
                  throw _iteratorError3;
                }
              }
            }

            var _iteratorNormalCompletion4 = true;
            var _didIteratorError4 = false;
            var _iteratorError4 = undefined;

            try {
              for (var _iterator4 = _getIterator(noImageElements), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
                var testCase = _step4.value;

                var req = { body: testCase, params: {} };
                (0, _libProtocolProtocol.driverShouldDoJwpProxy)(d, req, null).should.be['true'];
              }
            } catch (err) {
              _didIteratorError4 = true;
              _iteratorError4 = err;
            } finally {
              try {
                if (!_iteratorNormalCompletion4 && _iterator4['return']) {
                  _iterator4['return']();
                }
              } finally {
                if (_didIteratorError4) {
                  throw _iteratorError4;
                }
              }
            }
          });
        });

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvcHJvdG9jb2wvcHJvdG9jb2wtc3BlY3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O1FBRU8sT0FBTzs7OztvQkFDRyxNQUFNOzs7O3FCQUNMLE9BQU87Ozs7OEJBQ0Usa0JBQWtCOzs7O21DQUNxRSw2QkFBNkI7O21DQUN4SCw2QkFBNkI7Ozs7QUFFcEQsa0JBQUssTUFBTSxFQUFFLENBQUM7QUFDZCxrQkFBSyxHQUFHLDZCQUFnQixDQUFDOztBQUV6QixRQUFRLENBQUMsVUFBVSxFQUFFOzs7OztBQUVuQixnQkFBUSxDQUFDLGdCQUFnQixFQUFFLFlBQVk7QUFDckMsWUFBRSxDQUFDLCtDQUErQyxFQUFFLFlBQVk7QUFDOUQsb0RBQWMsRUFBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBQyxDQUFDLENBQUM7V0FDdEgsQ0FBQyxDQUFDO0FBQ0gsWUFBRSxDQUFDLHVDQUF1QyxFQUFFLFlBQVk7QUFDdEQsb0RBQWMsRUFBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBQyxDQUFDLENBQUM7V0FDbEgsQ0FBQyxDQUFDO0FBQ0gsWUFBRSxDQUFDLCtFQUErRSxFQUFFLFlBQVk7QUFDOUYsb0RBQWMsRUFBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBQyxDQUFDLENBQUM7V0FDOUcsQ0FBQyxDQUFDO0FBQ0gsWUFBRSxDQUFDLCtEQUErRCxFQUFFLFlBQVk7QUFDOUUsb0RBQWMsRUFBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBQyxDQUFDLENBQUM7V0FDbEcsQ0FBQyxDQUFDO0FBQ0gsWUFBRSxDQUFDLHFEQUFxRCxFQUFFLFlBQVk7QUFDcEUsb0RBQWMsRUFBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBQyxDQUFDLENBQUM7V0FDcEgsQ0FBQyxDQUFDO0FBQ0gsWUFBRSxDQUFDLDhDQUE4QyxFQUFFLFlBQVk7QUFDN0QsZ0JBQU0sS0FBSyxHQUFHLEVBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFDLENBQUM7QUFDakQsb0RBQWMsRUFBQyxRQUFRLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBTCxLQUFLLEVBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFMLEtBQUssRUFBQyxDQUFDLENBQUM7V0FDaEcsQ0FBQyxDQUFDO0FBQ0gsWUFBRSxDQUFDLDhDQUE4QyxFQUFFLFlBQVk7QUFDN0QsZ0JBQU0sS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3RDLG9EQUFjLEVBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUwsS0FBSyxFQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztXQUNuRSxDQUFDLENBQUM7U0FDSixDQUFDLENBQUM7O0FBRUgsZ0JBQVEsQ0FBQyx5QkFBeUIsRUFBRSxZQUFZO0FBQzlDLFlBQUUsQ0FBQyw4REFBOEQsRUFBRSxZQUFZO0FBQzdFLGdCQUFNLENBQUMsR0FBRyxzQ0FBZ0IsQ0FBQztBQUMzQiwrQkFBTSxJQUFJLENBQUMsQ0FBQyxFQUFFLGFBQWEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMzQywrQkFBTSxJQUFJLENBQUMsQ0FBQyxFQUFFLHFCQUFxQixDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3BELGdCQUFNLGdCQUFnQixHQUFHLDRYQUt4QixDQUFDO0FBQ0YsZ0JBQU0sZUFBZSxHQUFHLGdRQUl0QiwrQ0FBK0MsRUFDL0Msa0NBQWtDLCtGQUVuQyxDQUFDOzs7Ozs7QUFDRixnREFBcUIsZ0JBQWdCLDRHQUFFO29CQUE5QixRQUFROztBQUNmLG9CQUFNLEdBQUcsR0FBRyxFQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFDLENBQUM7QUFDMUQsaUVBQXVCLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsU0FBTSxDQUFDO2VBQ3REOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDRCxpREFBcUIsZUFBZSxpSEFBRTtvQkFBN0IsUUFBUTs7QUFDZixvQkFBTSxHQUFHLEdBQUcsRUFBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBQyxDQUFDO0FBQzFELGlFQUF1QixDQUFDLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLFFBQUssQ0FBQztlQUNyRDs7Ozs7Ozs7Ozs7Ozs7O1dBQ0YsQ0FBQyxDQUFDO0FBQ0gsWUFBRSxDQUFDLCtEQUErRCxFQUFFLFlBQVk7QUFDOUUsZ0JBQU0sQ0FBQyxHQUFHLHNDQUFnQixDQUFDO0FBQzNCLCtCQUFNLElBQUksQ0FBQyxDQUFDLEVBQUUsYUFBYSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzNDLCtCQUFNLElBQUksQ0FBQyxDQUFDLEVBQUUscUJBQXFCLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDcEQsZ0JBQU0sZ0JBQWdCLEdBQUcsOFVBTXZCLENBQUM7QUFDSCxnQkFBTSxlQUFlLEdBQUcsZ0VBQ0UsS0FBSyw2TkFLNUI7QUFDRCxpQkFBRyxFQUFFLEtBQUs7YUFDWCw0REFDb0IsS0FBSyxpRUFFRCxLQUFLLEdBQzNCO0FBQ0QsaUJBQUcsbURBQThCO2FBQ2xDLEVBQUU7QUFDRCxpQkFBRyxtREFBOEI7YUFDbEMsaU9BSUMsQ0FBQzs7Ozs7O0FBQ0gsaURBQXFCLGdCQUFnQixpSEFBRTtvQkFBOUIsUUFBUTs7QUFDZixvQkFBTSxHQUFHLEdBQUcsRUFBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUMsQ0FBQztBQUN6QyxpRUFBdUIsQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxTQUFNLENBQUM7ZUFDdEQ7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUNELGlEQUFxQixlQUFlLGlIQUFFO29CQUE3QixRQUFROztBQUNmLG9CQUFNLEdBQUcsR0FBRyxFQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBQyxDQUFDO0FBQ3pDLGlFQUF1QixDQUFDLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLFFBQUssQ0FBQztlQUNyRDs7Ozs7Ozs7Ozs7Ozs7O1dBRUYsQ0FBQyxDQUFDO1NBQ0osQ0FBQyxDQUFDOzs7Ozs7O0NBQ0osQ0FBQyxDQUFDIiwiZmlsZSI6InRlc3QvcHJvdG9jb2wvcHJvdG9jb2wtc3BlY3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0cmFuc3BpbGU6bW9jaGFcblxuaW1wb3J0ICcuLi8uLic7IC8vIE5PVEU6IEZvciBzb21lIHJlYXNvbiB0aGlzIGZpbGUgbmVlZHMgdG8gYmUgaW1wb3J0ZWQgdG8gcHJldmVudCBhIGJhYmVsIGVycm9yXG5pbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBzaW5vbiBmcm9tICdzaW5vbic7XG5pbXBvcnQgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCc7XG5pbXBvcnQgeyBNSlNPTldQX0VMRU1FTlRfS0VZLCBXM0NfRUxFTUVOVF9LRVksIHBhcnNlUHJvdG9jb2wsIGRyaXZlclNob3VsZERvSndwUHJveHksIElNQUdFX0VMRU1FTlRfUFJFRklYIH0gZnJvbSAnLi4vLi4vbGliL3Byb3RvY29sL3Byb3RvY29sJztcbmltcG9ydCBCYXNlRHJpdmVyIGZyb20gJy4uLy4uL2xpYi9iYXNlZHJpdmVyL2RyaXZlcic7XG5cbmNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmRlc2NyaWJlKCdQcm90b2NvbCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcblxuICBkZXNjcmliZSgnI3BhcnNlUHJvdG9jb2wnLCBmdW5jdGlvbiAoKSB7XG4gICAgaXQoJ3Nob3VsZCBwYXJzZSB7cHJvdG9jb2w6IFwiTUpTT05XUFwifSBhcyBNSlNPTldQJywgZnVuY3Rpb24gKCkge1xuICAgICAgcGFyc2VQcm90b2NvbCh7cHJvdG9jb2w6ICdNSlNPTldQJywgdmFsdWU6IHVuZGVmaW5lZH0pLnNob3VsZC5lcWwoe2lzVzNDOiBmYWxzZSwgaXNNSlNPTldQOiB0cnVlLCB2YWx1ZTogdW5kZWZpbmVkfSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBwYXJzZSB7cHJvdG9jb2w6IFwiVzNDXCJ9IGFzIFczQycsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHBhcnNlUHJvdG9jb2woe3Byb3RvY29sOiAnVzNDJywgdmFsdWU6IHVuZGVmaW5lZH0pLnNob3VsZC5lcWwoe2lzVzNDOiB0cnVlLCBpc01KU09OV1A6IGZhbHNlLCB2YWx1ZTogdW5kZWZpbmVkfSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBwYXJzZSB7cHJvdG9jb2w6IFwiTUpTT05XUFwiLCB2YWx1ZTogZmFsc2V9IGFzIE1KU09OV1Agd2l0aCB2YWx1ZTogZmFsc2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBwYXJzZVByb3RvY29sKHtwcm90b2NvbDogJ01KU09OV1AnLCB2YWx1ZTogZmFsc2V9KS5zaG91bGQuZXFsKHtpc1czQzogZmFsc2UsIGlzTUpTT05XUDogdHJ1ZSwgdmFsdWU6IGZhbHNlfSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBwYXJzZSB7cHJvdG9jb2w6IFwiVzNDXCIsIHZhbHVlOiAwfSBhcyBXM0Mgd2l0aCB2YWx1ZTogMCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHBhcnNlUHJvdG9jb2woe3Byb3RvY29sOiAnVzNDJywgdmFsdWU6IDB9KS5zaG91bGQuZXFsKHtpc1czQzogdHJ1ZSwgaXNNSlNPTldQOiBmYWxzZSwgdmFsdWU6IDB9KTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHBhcnNlIHtwcm90b2NvbDogXCJNSlNPTldQXCIsIHZhbHVlOiBcInN0cmluZ1wifScsIGZ1bmN0aW9uICgpIHtcbiAgICAgIHBhcnNlUHJvdG9jb2woe3Byb3RvY29sOiAnTUpTT05XUCcsIHZhbHVlOiBcInN0cmluZ1wifSkuc2hvdWxkLmVxbCh7aXNXM0M6IGZhbHNlLCBpc01KU09OV1A6IHRydWUsIHZhbHVlOiBcInN0cmluZ1wifSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBwYXJzZSB7cHJvdG9jb2w6IFwiVzNDXCIsIHZhbHVlOiB7b2JqfX0nLCBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IHtoZWxsbzogJ3dvcmxkJywgZ29vZGJ5ZTogJ3doaXJsJ307XG4gICAgICBwYXJzZVByb3RvY29sKHtwcm90b2NvbDogJ01KU09OV1AnLCB2YWx1ZX0pLnNob3VsZC5lcWwoe2lzVzNDOiBmYWxzZSwgaXNNSlNPTldQOiB0cnVlLCB2YWx1ZX0pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgdGhyb3cgaWYge3Byb3RvY29sOiBcIk1KU09OV1BcIiwgZXJyb3J9JywgZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ3NvbWUgZXJyb3InKTtcbiAgICAgIHBhcnNlUHJvdG9jb2woe3Byb3RvY29sOiAnVzNDJywgZXJyb3J9KS5lcnJvci5zaG91bGQuZXF1YWwoZXJyb3IpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnI2RyaXZlclNob3VsZERvSndwUHJveHknLCBmdW5jdGlvbiAoKSB7XG4gICAgaXQoJ3Nob3VsZCBub3QgcHJveHkgaWYgYW4gaW1hZ2UgZWxlbWVudCBpcyBmb3VuZCBpbiByZXF1ZXN0IHVybCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnN0IGQgPSBuZXcgQmFzZURyaXZlcigpO1xuICAgICAgc2lub24uc3R1YihkLCAncHJveHlBY3RpdmUnKS5yZXR1cm5zKHRydWUpO1xuICAgICAgc2lub24uc3R1YihkLCAncHJveHlSb3V0ZUlzQXZvaWRlZCcpLnJldHVybnMoZmFsc2UpO1xuICAgICAgY29uc3QgaGFzSW1hZ2VFbGVtZW50cyA9IFtcbiAgICAgICAgYC93ZC9odWIvc2Vzc2lvbi86c2Vzc2lvbklkL2VsZW1lbnQvJHtJTUFHRV9FTEVNRU5UX1BSRUZJWH1iYXJgLFxuICAgICAgICBgL3dkL2h1Yi9zZXNzaW9uLzpzZXNzaW9uSWQvZWxlbWVudC8ke0lNQUdFX0VMRU1FTlRfUFJFRklYfWJhci9jbGlja2AsXG4gICAgICAgIGAvd2QvaHViL3Nlc3Npb24vOnNlc3Npb25JZC9lbGVtZW50LyR7SU1BR0VfRUxFTUVOVF9QUkVGSVh9YmFyL3N1Ym1pdGAsXG4gICAgICAgIGAvd2QvaHViL3Nlc3Npb24vOnNlc3Npb25JZC9zY3JlZW5zaG90LyR7SU1BR0VfRUxFTUVOVF9QUkVGSVh9YmFyYCxcbiAgICAgIF07XG4gICAgICBjb25zdCBub0ltYWdlRWxlbWVudHMgPSBbXG4gICAgICAgIGAvd2QvaHViL3Nlc3Npb24vOnNlc3Npb25JZC9lbGVtZW50LyR7SU1BR0VfRUxFTUVOVF9QUkVGSVh9YCxcbiAgICAgICAgYC93ZC9odWIvc2Vzc2lvbi86c2Vzc2lvbklkL3NjcmVlbnNob3QvJHtJTUFHRV9FTEVNRU5UX1BSRUZJWH1gLFxuICAgICAgICBgL3dkL2h1Yi9zZXNzaW9uLzpzZXNzaW9uSWQvZWxlbWVudC9iYXIke0lNQUdFX0VMRU1FTlRfUFJFRklYfWAsXG4gICAgICAgICcvd2QvaHViL3Nlc3Npb24vOnNlc3Npb25JZC9lbGVtZW50L2VsZW1lbnQxMjMnLFxuICAgICAgICAnL3dkL2h1Yi9zZXNzaW9uLzpzZXNzaW9uSWQvdGl0bGUnLFxuICAgICAgICBgL3dkL2h1Yi9zZXNzaW9uLzpzZXNzaW9uSWQvbm90ZWxlbWVudC8ke0lNQUdFX0VMRU1FTlRfUFJFRklYfWJhcmAsXG4gICAgICBdO1xuICAgICAgZm9yIChsZXQgdGVzdENhc2Ugb2YgaGFzSW1hZ2VFbGVtZW50cykge1xuICAgICAgICBjb25zdCByZXEgPSB7Ym9keToge30sIHBhcmFtczoge30sIG9yaWdpbmFsVXJsOiB0ZXN0Q2FzZX07XG4gICAgICAgIGRyaXZlclNob3VsZERvSndwUHJveHkoZCwgcmVxLCBudWxsKS5zaG91bGQuYmUuZmFsc2U7XG4gICAgICB9XG4gICAgICBmb3IgKGxldCB0ZXN0Q2FzZSBvZiBub0ltYWdlRWxlbWVudHMpIHtcbiAgICAgICAgY29uc3QgcmVxID0ge2JvZHk6IHt9LCBwYXJhbXM6IHt9LCBvcmlnaW5hbFVybDogdGVzdENhc2V9O1xuICAgICAgICBkcml2ZXJTaG91bGREb0p3cFByb3h5KGQsIHJlcSwgbnVsbCkuc2hvdWxkLmJlLnRydWU7XG4gICAgICB9XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBub3QgcHJveHkgaWYgYW4gaW1hZ2UgZWxlbWVudCBpcyBmb3VuZCBpbiByZXF1ZXN0IGJvZHknLCBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCBkID0gbmV3IEJhc2VEcml2ZXIoKTtcbiAgICAgIHNpbm9uLnN0dWIoZCwgJ3Byb3h5QWN0aXZlJykucmV0dXJucyh0cnVlKTtcbiAgICAgIHNpbm9uLnN0dWIoZCwgJ3Byb3h5Um91dGVJc0F2b2lkZWQnKS5yZXR1cm5zKGZhbHNlKTtcbiAgICAgIGNvbnN0IGhhc0ltYWdlRWxlbWVudHMgPSBbe1xuICAgICAgICBbVzNDX0VMRU1FTlRfS0VZXTogYCR7SU1BR0VfRUxFTUVOVF9QUkVGSVh9YmFyYCxcbiAgICAgIH0sIHtcbiAgICAgICAgW1czQ19FTEVNRU5UX0tFWV06IGAke0lNQUdFX0VMRU1FTlRfUFJFRklYfWZvb2AsXG4gICAgICB9LCB7XG4gICAgICAgIFtNSlNPTldQX0VMRU1FTlRfS0VZXTogYCR7SU1BR0VfRUxFTUVOVF9QUkVGSVh9YmFyYCxcbiAgICAgIH1dO1xuICAgICAgY29uc3Qgbm9JbWFnZUVsZW1lbnRzID0gW3tcbiAgICAgICAgW0lNQUdFX0VMRU1FTlRfUFJFRklYXTogJ2ZvbycsXG4gICAgICB9LCB7XG4gICAgICAgIFtXM0NfRUxFTUVOVF9LRVldOiBgJHtJTUFHRV9FTEVNRU5UX1BSRUZJWH1gLFxuICAgICAgfSwge1xuICAgICAgICBbTUpTT05XUF9FTEVNRU5UX0tFWV06IGAke0lNQUdFX0VMRU1FTlRfUFJFRklYfWAsXG4gICAgICB9LCB7XG4gICAgICAgIGZvbzogJ2JhcicsXG4gICAgICB9LCB7XG4gICAgICAgIFtXM0NfRUxFTUVOVF9LRVldOiAnYmFyJyxcbiAgICAgIH0sIHtcbiAgICAgICAgW01KU09OV1BfRUxFTUVOVF9LRVldOiAnYmFyJyxcbiAgICAgIH0sIHtcbiAgICAgICAgZm9vOiBgJHtJTUFHRV9FTEVNRU5UX1BSRUZJWH1iYXJgLFxuICAgICAgfSwge1xuICAgICAgICBmb286IGBiYXIke0lNQUdFX0VMRU1FTlRfUFJFRklYfWBcbiAgICAgIH0sIHtcbiAgICAgICAgW1czQ19FTEVNRU5UX0tFWV06IGBiYXIke0lNQUdFX0VMRU1FTlRfUFJFRklYfWBcbiAgICAgIH0sIHtcbiAgICAgICAgW01KU09OV1BfRUxFTUVOVF9LRVldOiBgYmFyJHtJTUFHRV9FTEVNRU5UX1BSRUZJWH1gXG4gICAgICB9XTtcbiAgICAgIGZvciAobGV0IHRlc3RDYXNlIG9mIGhhc0ltYWdlRWxlbWVudHMpIHtcbiAgICAgICAgY29uc3QgcmVxID0ge2JvZHk6IHRlc3RDYXNlLCBwYXJhbXM6IHt9fTtcbiAgICAgICAgZHJpdmVyU2hvdWxkRG9Kd3BQcm94eShkLCByZXEsIG51bGwpLnNob3VsZC5iZS5mYWxzZTtcbiAgICAgIH1cbiAgICAgIGZvciAobGV0IHRlc3RDYXNlIG9mIG5vSW1hZ2VFbGVtZW50cykge1xuICAgICAgICBjb25zdCByZXEgPSB7Ym9keTogdGVzdENhc2UsIHBhcmFtczoge319O1xuICAgICAgICBkcml2ZXJTaG91bGREb0p3cFByb3h5KGQsIHJlcSwgbnVsbCkuc2hvdWxkLmJlLnRydWU7XG4gICAgICB9XG5cbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
