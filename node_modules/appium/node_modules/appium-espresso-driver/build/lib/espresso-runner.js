'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _asyncbox = require('asyncbox');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _packageJson = require('../../package.json');

// eslint-disable-line import/no-unresolved

var TEST_APK_PATH = _path2['default'].resolve(__dirname, '..', '..', 'espresso-server', 'app', 'build', 'outputs', 'apk', 'androidTest', 'debug', 'app-debug-androidTest.apk');
var TEST_MANIFEST_PATH = _path2['default'].resolve(__dirname, '..', '..', 'espresso-server', 'AndroidManifest-test.xml');
var TEST_APK_PKG = 'io.appium.espressoserver.test';
var REQUIRED_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'appPackage', 'forceEspressoRebuild'];
var ESPRESSO_SERVER_LAUNCH_TIMEOUT = 30000;

var EspressoRunner = (function () {
  function EspressoRunner() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, EspressoRunner);

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = _getIterator(REQUIRED_PARAMS), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var req = _step.value;

        if (!opts || !_appiumSupport.util.hasValue(opts[req])) {
          throw new Error('Option \'' + req + '\' is required!');
        }
        this[req] = opts[req];
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({ server: this.host, port: this.systemPort, base: '' });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);

    this.modServerPath = _path2['default'].resolve(this.tmpDir, TEST_APK_PKG + '_' + _packageJson.version + '_' + this.appPackage + '.apk');

    this.serverLaunchTimeout = opts.serverLaunchTimeout || ESPRESSO_SERVER_LAUNCH_TIMEOUT;
  }

  _createClass(EspressoRunner, [{
    key: 'installTestApk',
    value: function installTestApk() {
      return _regeneratorRuntime.async(function installTestApk$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.t0 = this.forceEspressoRebuild;

            if (!context$2$0.t0) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.modServerPath));

          case 4:
            context$2$0.t0 = context$2$0.sent;

          case 5:
            if (!context$2$0.t0) {
              context$2$0.next = 9;
              break;
            }

            _logger2['default'].debug('Capability \'forceEspressoRebuild\' on. Deleting file \'' + this.modServerPath + '\'');
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(this.modServerPath));

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.modServerPath));

          case 11:
            if (context$2$0.sent) {
              context$2$0.next = 14;
              break;
            }

            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.buildNewModServer());

          case 14:
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap(this.checkAndSignCert(this.modServerPath));

          case 16:
            if (!this.forceEspressoRebuild) {
              context$2$0.next = 20;
              break;
            }

            _logger2['default'].info("New server was built, uninstalling any instances of it");
            context$2$0.next = 20;
            return _regeneratorRuntime.awrap(this.adb.uninstallApk(TEST_APK_PKG));

          case 20:
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(this.adb.installOrUpgrade(this.modServerPath, TEST_APK_PKG));

          case 22:
            _logger2['default'].info('Installed Espresso Test Server apk \'' + this.modServerPath + '\' (pkg: \'' + TEST_APK_PKG + '\')');

          case 23:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'buildNewModServer',
    value: function buildNewModServer() {
      var packageTmpDir, newManifestPath;
      return _regeneratorRuntime.async(function buildNewModServer$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info('Repackaging espresso server for: \'' + this.appPackage + '\'');
            packageTmpDir = _path2['default'].resolve(this.tmpDir, this.appPackage);
            newManifestPath = _path2['default'].resolve(this.tmpDir, 'AndroidManifest.xml');
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(newManifestPath));

          case 5:

            _logger2['default'].info('Creating new manifest: \'' + newManifestPath + '\'');
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(packageTmpDir));

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(TEST_MANIFEST_PATH, newManifestPath));

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.adb.compileManifest(newManifestPath, TEST_APK_PKG, this.appPackage));

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.adb.insertManifest(newManifestPath, TEST_APK_PATH, this.modServerPath));

          case 14:
            // copies from second to third and add manifest
            _logger2['default'].info('Repackaged espresso server ready: \'' + this.modServerPath + '\'');

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // TODO duplicated from uiautomator2, should be a lib method
  }, {
    key: 'checkAndSignCert',
    value: function checkAndSignCert(apk, apkPackage) {
      var signed;
      return _regeneratorRuntime.async(function checkAndSignCert$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.adb.checkApkCert(apk, apkPackage));

          case 2:
            signed = context$2$0.sent;

            if (signed) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.adb.sign(apk));

          case 6:
            return context$2$0.abrupt('return', !signed);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSession',
    value: function startSession(caps) {
      var cmd;
      return _regeneratorRuntime.async(function startSession$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmd = ['shell', 'am', 'instrument', '-w', '-e', 'debug', process.env.ESPRESSO_JAVA_DEBUG === 'true' ? 'true' : 'false', TEST_APK_PKG + '/android.support.test.runner.AndroidJUnitRunner'];

            _logger2['default'].info('Starting Espresso Server v' + _packageJson.version + ' with cmd: adb ' + cmd.join(' '));

            // start the instrumentation process
            this.instProcess = this.adb.createSubProcess(cmd);
            this.instProcess.on('exit', function (code, signal) {
              _logger2['default'].info('Instrumentation process exited with code ' + code + ' from signal ' + signal);
            });
            this.instProcess.on('die', function (code, signal) {
              _logger2['default'].error('Instrumentation process died with code ' + code + ' and signal ' + signal);
            });
            this.instProcess.on('stream-line', function (line) {
              _logger2['default'].debug('[Instrumentation]' + line.trim());
            });

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.instProcess.start(function (stdout, stderr) {
              // for any call to the start detector, one of stdout or stderr will have
              // content, so merge for checks here
              var out = stdout.trim() || stderr.trim();

              // adb always prints this out on success. If this is found not to be the
              // case, add other conditions
              if (out.includes('io.appium.espressoserver.EspressoServerRunnerTest:')) {
                return true;
              }
              if (out.toLowerCase().includes('exception')) {
                throw new Error(out);
              }
            }, this.serverLaunchTimeout));

          case 8:

            _logger2['default'].info('Waiting for Espresso to be online...');

            // wait 20s for espresso to be online
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(20, 1000, function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.jwproxy.command('/status', 'GET'));

                  case 2:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            }));

          case 11:
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/session', 'POST', { desiredCapabilities: caps }));

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Deleting Espresso server session');
            // rely on jwproxy's intelligence to know what we're talking about and
            // delete the current session
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/', 'DELETE'));

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].warn('Did not get confirmation Espresso deleteSession worked; ' + ('Error was: ' + context$2$0.t0));

          case 9:
            if (!(this.instProcess && this.instProcess.isRunning)) {
              context$2$0.next = 12;
              break;
            }

            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.instProcess.stop());

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }]);

  return EspressoRunner;
})();

exports.EspressoRunner = EspressoRunner;
exports.REQUIRED_PARAMS = REQUIRED_PARAMS;
exports['default'] = EspressoRunner;
// creates a file `${newManifestPath}.apk`
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFvRCxDQUFDLEVBQUU7QUFDdEUsdUJBQU8sSUFBSSxDQUFDO2VBQ2I7QUFDRCxrQkFBSSxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxFQUFFO0FBQzNDLHNCQUFNLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2VBQ3RCO2FBQ0YsRUFBRSxJQUFJLENBQUMsbUJBQW1CLENBQUM7Ozs7QUFFNUIsZ0NBQU8sSUFBSSxDQUFDLHNDQUFzQyxDQUFDLENBQUM7Ozs7NkNBRzlDLDZCQUFjLEVBQUUsRUFBRSxJQUFJLEVBQUU7Ozs7O3FEQUN0QixJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDOzs7Ozs7O2FBQzdDLENBQUM7Ozs7NkNBQ0ksSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxFQUFDLG1CQUFtQixFQUFFLElBQUksRUFBQyxDQUFDOzs7Ozs7O0tBQzVFOzs7V0FFbUI7Ozs7QUFDbEIsZ0NBQU8sS0FBSyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7Ozs7OzZDQUl6QyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDOzs7Ozs7Ozs7O0FBRXpDLGdDQUFPLElBQUksQ0FBQyw2RkFDVyxDQUFDLENBQUM7OztrQkFHdkIsSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQTs7Ozs7OzZDQUMxQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRTs7Ozs7OztLQUVoQzs7O1NBdkhHLGNBQWM7OztRQTBIWCxjQUFjLEdBQWQsY0FBYztRQUFFLGVBQWUsR0FBZixlQUFlO3FCQUN6QixjQUFjIiwiZmlsZSI6ImxpYi9lc3ByZXNzby1ydW5uZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMsIHV0aWwsIG1rZGlycCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IHZlcnNpb24gfSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGltcG9ydC9uby11bnJlc29sdmVkXG5cblxuY29uc3QgVEVTVF9BUEtfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdlc3ByZXNzby1zZXJ2ZXInLCAnYXBwJywgJ2J1aWxkJywgJ291dHB1dHMnLCAnYXBrJywgJ2FuZHJvaWRUZXN0JywgJ2RlYnVnJywgJ2FwcC1kZWJ1Zy1hbmRyb2lkVGVzdC5hcGsnKTtcbmNvbnN0IFRFU1RfTUFOSUZFU1RfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdlc3ByZXNzby1zZXJ2ZXInLCAnQW5kcm9pZE1hbmlmZXN0LXRlc3QueG1sJyk7XG5jb25zdCBURVNUX0FQS19QS0cgPSAnaW8uYXBwaXVtLmVzcHJlc3Nvc2VydmVyLnRlc3QnO1xuY29uc3QgUkVRVUlSRURfUEFSQU1TID0gWydhZGInLCAndG1wRGlyJywgJ2hvc3QnLCAnc3lzdGVtUG9ydCcsICdkZXZpY2VQb3J0JywgJ2FwcFBhY2thZ2UnLCAnZm9yY2VFc3ByZXNzb1JlYnVpbGQnXTtcbmNvbnN0IEVTUFJFU1NPX1NFUlZFUl9MQVVOQ0hfVElNRU9VVCA9IDMwMDAwO1xuXG5jbGFzcyBFc3ByZXNzb1J1bm5lciB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBmb3IgKGxldCByZXEgb2YgUkVRVUlSRURfUEFSQU1TKSB7XG4gICAgICBpZiAoIW9wdHMgfHwgIXV0aWwuaGFzVmFsdWUob3B0c1tyZXFdKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE9wdGlvbiAnJHtyZXF9JyBpcyByZXF1aXJlZCFgKTtcbiAgICAgIH1cbiAgICAgIHRoaXNbcmVxXSA9IG9wdHNbcmVxXTtcbiAgICB9XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkoe3NlcnZlcjogdGhpcy5ob3N0LCBwb3J0OiB0aGlzLnN5c3RlbVBvcnQsIGJhc2U6ICcnfSk7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMuandwcm94eS5wcm94eVJlcVJlcy5iaW5kKHRoaXMuandwcm94eSk7XG5cbiAgICB0aGlzLm1vZFNlcnZlclBhdGggPSBwYXRoLnJlc29sdmUodGhpcy50bXBEaXIsIGAke1RFU1RfQVBLX1BLR31fJHt2ZXJzaW9ufV8ke3RoaXMuYXBwUGFja2FnZX0uYXBrYCk7XG5cbiAgICB0aGlzLnNlcnZlckxhdW5jaFRpbWVvdXQgPSBvcHRzLnNlcnZlckxhdW5jaFRpbWVvdXQgfHwgRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFsbFRlc3RBcGsgKCkge1xuICAgIGlmICh0aGlzLmZvcmNlRXNwcmVzc29SZWJ1aWxkICYmIGF3YWl0IGZzLmV4aXN0cyh0aGlzLm1vZFNlcnZlclBhdGgpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYENhcGFiaWxpdHkgJ2ZvcmNlRXNwcmVzc29SZWJ1aWxkJyBvbi4gRGVsZXRpbmcgZmlsZSAnJHt0aGlzLm1vZFNlcnZlclBhdGh9J2ApO1xuICAgICAgYXdhaXQgZnMudW5saW5rKHRoaXMubW9kU2VydmVyUGF0aCk7XG4gICAgfVxuXG4gICAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHRoaXMubW9kU2VydmVyUGF0aCkpKSB7XG4gICAgICBhd2FpdCB0aGlzLmJ1aWxkTmV3TW9kU2VydmVyKCk7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMuY2hlY2tBbmRTaWduQ2VydCh0aGlzLm1vZFNlcnZlclBhdGgpO1xuICAgIGlmICh0aGlzLmZvcmNlRXNwcmVzc29SZWJ1aWxkKSB7XG4gICAgICBsb2dnZXIuaW5mbyhcIk5ldyBzZXJ2ZXIgd2FzIGJ1aWx0LCB1bmluc3RhbGxpbmcgYW55IGluc3RhbmNlcyBvZiBpdFwiKTtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayhURVNUX0FQS19QS0cpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuYWRiLmluc3RhbGxPclVwZ3JhZGUodGhpcy5tb2RTZXJ2ZXJQYXRoLCBURVNUX0FQS19QS0cpO1xuICAgIGxvZ2dlci5pbmZvKGBJbnN0YWxsZWQgRXNwcmVzc28gVGVzdCBTZXJ2ZXIgYXBrICcke3RoaXMubW9kU2VydmVyUGF0aH0nIChwa2c6ICcke1RFU1RfQVBLX1BLR30nKWApO1xuICB9XG5cbiAgYXN5bmMgYnVpbGROZXdNb2RTZXJ2ZXIgKCkge1xuICAgIGxvZ2dlci5pbmZvKGBSZXBhY2thZ2luZyBlc3ByZXNzbyBzZXJ2ZXIgZm9yOiAnJHt0aGlzLmFwcFBhY2thZ2V9J2ApO1xuICAgIGNvbnN0IHBhY2thZ2VUbXBEaXIgPSBwYXRoLnJlc29sdmUodGhpcy50bXBEaXIsIHRoaXMuYXBwUGFja2FnZSk7XG4gICAgY29uc3QgbmV3TWFuaWZlc3RQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCAnQW5kcm9pZE1hbmlmZXN0LnhtbCcpO1xuICAgIGF3YWl0IGZzLnJpbXJhZihuZXdNYW5pZmVzdFBhdGgpO1xuXG4gICAgbG9nZ2VyLmluZm8oYENyZWF0aW5nIG5ldyBtYW5pZmVzdDogJyR7bmV3TWFuaWZlc3RQYXRofSdgKTtcbiAgICBhd2FpdCBta2RpcnAocGFja2FnZVRtcERpcik7XG4gICAgYXdhaXQgZnMuY29weUZpbGUoVEVTVF9NQU5JRkVTVF9QQVRILCBuZXdNYW5pZmVzdFBhdGgpO1xuICAgIGF3YWl0IHRoaXMuYWRiLmNvbXBpbGVNYW5pZmVzdChuZXdNYW5pZmVzdFBhdGgsIFRFU1RfQVBLX1BLRywgdGhpcy5hcHBQYWNrYWdlKTsgLy8gY3JlYXRlcyBhIGZpbGUgYCR7bmV3TWFuaWZlc3RQYXRofS5hcGtgXG4gICAgYXdhaXQgdGhpcy5hZGIuaW5zZXJ0TWFuaWZlc3QobmV3TWFuaWZlc3RQYXRoLCBURVNUX0FQS19QQVRILCB0aGlzLm1vZFNlcnZlclBhdGgpOyAvLyBjb3BpZXMgZnJvbSBzZWNvbmQgdG8gdGhpcmQgYW5kIGFkZCBtYW5pZmVzdFxuICAgIGxvZ2dlci5pbmZvKGBSZXBhY2thZ2VkIGVzcHJlc3NvIHNlcnZlciByZWFkeTogJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofSdgKTtcbiAgfVxuXG4gIC8vIFRPRE8gZHVwbGljYXRlZCBmcm9tIHVpYXV0b21hdG9yMiwgc2hvdWxkIGJlIGEgbGliIG1ldGhvZFxuICBhc3luYyBjaGVja0FuZFNpZ25DZXJ0IChhcGssIGFwa1BhY2thZ2UpIHtcbiAgICBsZXQgc2lnbmVkID0gYXdhaXQgdGhpcy5hZGIuY2hlY2tBcGtDZXJ0KGFwaywgYXBrUGFja2FnZSk7XG4gICAgaWYgKCFzaWduZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnNpZ24oYXBrKTtcbiAgICB9XG4gICAgcmV0dXJuICFzaWduZWQ7XG4gIH1cblxuICBhc3luYyBzdGFydFNlc3Npb24gKGNhcHMpIHtcbiAgICBjb25zdCBjbWQgPSBbXG4gICAgICAnc2hlbGwnLFxuICAgICAgJ2FtJywgJ2luc3RydW1lbnQnLFxuICAgICAgJy13JyxcbiAgICAgICctZScsICdkZWJ1ZycsIHByb2Nlc3MuZW52LkVTUFJFU1NPX0pBVkFfREVCVUcgPT09ICd0cnVlJyA/ICd0cnVlJyA6ICdmYWxzZScsXG4gICAgICBgJHtURVNUX0FQS19QS0d9L2FuZHJvaWQuc3VwcG9ydC50ZXN0LnJ1bm5lci5BbmRyb2lkSlVuaXRSdW5uZXJgLFxuICAgIF07XG5cbiAgICBsb2dnZXIuaW5mbyhgU3RhcnRpbmcgRXNwcmVzc28gU2VydmVyIHYke3ZlcnNpb259IHdpdGggY21kOiBhZGIgJHtjbWQuam9pbignICcpfWApO1xuXG4gICAgLy8gc3RhcnQgdGhlIGluc3RydW1lbnRhdGlvbiBwcm9jZXNzXG4gICAgdGhpcy5pbnN0UHJvY2VzcyA9IHRoaXMuYWRiLmNyZWF0ZVN1YlByb2Nlc3MoY21kKTtcbiAgICB0aGlzLmluc3RQcm9jZXNzLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgbG9nZ2VyLmluZm8oYEluc3RydW1lbnRhdGlvbiBwcm9jZXNzIGV4aXRlZCB3aXRoIGNvZGUgJHtjb2RlfSBmcm9tIHNpZ25hbCAke3NpZ25hbH1gKTtcbiAgICB9KTtcbiAgICB0aGlzLmluc3RQcm9jZXNzLm9uKCdkaWUnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoYEluc3RydW1lbnRhdGlvbiBwcm9jZXNzIGRpZWQgd2l0aCBjb2RlICR7Y29kZX0gYW5kIHNpZ25hbCAke3NpZ25hbH1gKTtcbiAgICB9KTtcbiAgICB0aGlzLmluc3RQcm9jZXNzLm9uKCdzdHJlYW0tbGluZScsIGxpbmUgPT4ge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBbSW5zdHJ1bWVudGF0aW9uXSR7bGluZS50cmltKCl9YCk7XG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLmluc3RQcm9jZXNzLnN0YXJ0KChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgLy8gZm9yIGFueSBjYWxsIHRvIHRoZSBzdGFydCBkZXRlY3Rvciwgb25lIG9mIHN0ZG91dCBvciBzdGRlcnIgd2lsbCBoYXZlXG4gICAgICAvLyBjb250ZW50LCBzbyBtZXJnZSBmb3IgY2hlY2tzIGhlcmVcbiAgICAgIGNvbnN0IG91dCA9IHN0ZG91dC50cmltKCkgfHwgc3RkZXJyLnRyaW0oKTtcblxuICAgICAgLy8gYWRiIGFsd2F5cyBwcmludHMgdGhpcyBvdXQgb24gc3VjY2Vzcy4gSWYgdGhpcyBpcyBmb3VuZCBub3QgdG8gYmUgdGhlXG4gICAgICAvLyBjYXNlLCBhZGQgb3RoZXIgY29uZGl0aW9uc1xuICAgICAgaWYgKG91dC5pbmNsdWRlcygnaW8uYXBwaXVtLmVzcHJlc3Nvc2VydmVyLkVzcHJlc3NvU2VydmVyUnVubmVyVGVzdDonKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChvdXQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnZXhjZXB0aW9uJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG91dCk7XG4gICAgICB9XG4gICAgfSwgdGhpcy5zZXJ2ZXJMYXVuY2hUaW1lb3V0KTtcblxuICAgIGxvZ2dlci5pbmZvKCdXYWl0aW5nIGZvciBFc3ByZXNzbyB0byBiZSBvbmxpbmUuLi4nKTtcblxuICAgIC8vIHdhaXQgMjBzIGZvciBlc3ByZXNzbyB0byBiZSBvbmxpbmVcbiAgICBhd2FpdCByZXRyeUludGVydmFsKDIwLCAxMDAwLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3Nlc3Npb24nLCAnUE9TVCcsIHtkZXNpcmVkQ2FwYWJpbGl0aWVzOiBjYXBzfSk7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uICgpIHtcbiAgICBsb2dnZXIuZGVidWcoJ0RlbGV0aW5nIEVzcHJlc3NvIHNlcnZlciBzZXNzaW9uJyk7XG4gICAgLy8gcmVseSBvbiBqd3Byb3h5J3MgaW50ZWxsaWdlbmNlIHRvIGtub3cgd2hhdCB3ZSdyZSB0YWxraW5nIGFib3V0IGFuZFxuICAgIC8vIGRlbGV0ZSB0aGUgY3VycmVudCBzZXNzaW9uXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvJywgJ0RFTEVURScpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLndhcm4oYERpZCBub3QgZ2V0IGNvbmZpcm1hdGlvbiBFc3ByZXNzbyBkZWxldGVTZXNzaW9uIHdvcmtlZDsgYCArXG4gICAgICAgICAgYEVycm9yIHdhczogJHtlcnJ9YCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaW5zdFByb2Nlc3MgJiYgdGhpcy5pbnN0UHJvY2Vzcy5pc1J1bm5pbmcpIHtcbiAgICAgIGF3YWl0IHRoaXMuaW5zdFByb2Nlc3Muc3RvcCgpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBFc3ByZXNzb1J1bm5lciwgUkVRVUlSRURfUEFSQU1TIH07XG5leHBvcnQgZGVmYXVsdCBFc3ByZXNzb1J1bm5lcjtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
