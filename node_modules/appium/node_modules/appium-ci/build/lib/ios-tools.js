'use strict';

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _utils = require('./utils');

var _utils2 = _interopRequireDefault(_utils);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumSupport = require('appium-support');

var log = _appiumSupport.logger.getLogger('ios-tools');

var SIDE_DISK = '/Volumes/SIDE';
var SIDE_SIMS = _path2['default'].resolve(SIDE_DISK, 'sims');

function killAll() {
  var processes = arguments.length <= 0 || arguments[0] === undefined ? ['instruments', 'simulator'] : arguments[0];

  processes = _lodash2['default'].flatten([processes]);
  var seq = (0, _lodash2['default'])(processes).map(function (p) {
    return function () {
      return _utils2['default'].exec('sudo pkill -f ' + p)['catch'](function () {});
    };
  }).value();
  return _bluebird2['default'].reduce(seq, function (_, fn) {
    return fn();
  }, null);
}

function spawnAsUser(user, cmd, args) {
  log.info('running spawnAsUser', user, cmd, args);
  return _utils2['default'].exec("ps -axj | grep loginwindow | awk \"/^" + user + " / {print \\$2;exit}\"").spread(function (stdout) {
    var userPid = stdout.trim();
    return _utils2['default'].spawn("sudo", ['launchctl', 'bsexec', userPid, 'sudo', '-u'].concat([user, cmd]).concat(args), { detached: false });
  });
}

function spawnAsCurrentUser(cmd, args) {
  log.info('running spawnAsCurrentUser', cmd, args);
  return _utils2['default'].exec('whoami').spread(function (stdout) {
    var currentUser = stdout.trim();
    return spawnAsUser(currentUser, cmd, args);
  });
}

function setIosSimulatorScale() {
  log.info('setting simulator scale');
  return _utils2['default'].exec('defaults write com.apple.iphonesimulator SimulatorWindowLastScale 0.5');
}

function configureXcode(xCodeVersion) {
  log.info('configuring xCode', xCodeVersion);
  var bin = _path2['default'].resolve(SIDE_SIMS, 'configure.sh');
  return _utils2['default'].exec(bin + ' ' + xCodeVersion);
}

function resetSims() {
  log.info('resetting simulators');
  var bin = _path2['default'].resolve(SIDE_SIMS, 'reset-sims.sh');
  return _utils2['default'].exec(bin);
}

exports['default'] = {
  spawnAsUser: spawnAsUser,
  spawnAsCurrentUser: spawnAsCurrentUser,
  setIosSimulatorScale: setIosSimulatorScale,
  configureXcode: configureXcode,
  resetSims: resetSims,
  killAll: killAll
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,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SSxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsWUFBWSxDQUFDLENBQUM7Q0FDN0M7O0FBRUQsU0FBUyxTQUFTLEdBQUk7QUFDcEIsS0FBRyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2pDLE1BQU0sR0FBRyxHQUFHLGtCQUFLLE9BQU8sQ0FBQyxTQUFTLEVBQUUsZUFBZSxDQUFDLENBQUM7QUFDckQsU0FBTyxtQkFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Q0FDeEI7O3FCQUVjO0FBQ2IsYUFBVyxFQUFYLFdBQVc7QUFDWCxvQkFBa0IsRUFBbEIsa0JBQWtCO0FBQ2xCLHNCQUFvQixFQUFwQixvQkFBb0I7QUFDcEIsZ0JBQWMsRUFBZCxjQUFjO0FBQ2QsV0FBUyxFQUFULFNBQVM7QUFDVCxTQUFPLEVBQVAsT0FBTztDQUNSIiwiZmlsZSI6ImxpYi9pb3MtdG9vbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB1dGlscyBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ2lvcy10b29scycpO1xuXG5jb25zdCBTSURFX0RJU0sgPSAnL1ZvbHVtZXMvU0lERSc7XG5jb25zdCBTSURFX1NJTVMgPSBwYXRoLnJlc29sdmUoU0lERV9ESVNLLCAnc2ltcycpO1xuXG5mdW5jdGlvbiBraWxsQWxsIChwcm9jZXNzZXMgPSBbJ2luc3RydW1lbnRzJywgJ3NpbXVsYXRvciddKSB7XG4gIHByb2Nlc3NlcyA9IF8uZmxhdHRlbihbcHJvY2Vzc2VzXSk7XG4gIGxldCBzZXEgPSBfKHByb2Nlc3NlcykubWFwKChwKSA9PiB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIHJldHVybiB1dGlscy5leGVjKCdzdWRvIHBraWxsIC1mICcgKyBwKS5jYXRjaCgoKSA9PiB7fSk7XG4gICAgfTtcbiAgfSkudmFsdWUoKTtcbiAgcmV0dXJuIEIucmVkdWNlKHNlcSwgZnVuY3Rpb24gKF8sIGZuKSB7IHJldHVybiBmbigpOyB9LCBudWxsKTtcbn1cblxuZnVuY3Rpb24gc3Bhd25Bc1VzZXIgKHVzZXIsIGNtZCwgYXJncykge1xuICBsb2cuaW5mbygncnVubmluZyBzcGF3bkFzVXNlcicsIHVzZXIsIGNtZCwgYXJncyk7XG4gIHJldHVybiB1dGlscy5leGVjKFxuICAgIFwicHMgLWF4aiB8IGdyZXAgbG9naW53aW5kb3cgfCBhd2sgXFxcIi9eXCIgKyB1c2VyICsgXCIgLyB7cHJpbnQgXFxcXCQyO2V4aXR9XFxcIlwiXG4gICkuc3ByZWFkKGZ1bmN0aW9uIChzdGRvdXQpIHtcbiAgICBjb25zdCB1c2VyUGlkID0gc3Rkb3V0LnRyaW0oKTtcbiAgICByZXR1cm4gdXRpbHMuc3Bhd24oXG4gICAgICBcInN1ZG9cIixcbiAgICAgIFsnbGF1bmNoY3RsJywgJ2JzZXhlYycsIHVzZXJQaWQsICdzdWRvJywgJy11J11cbiAgICAgICAgLmNvbmNhdChbdXNlciwgY21kXSkuY29uY2F0KGFyZ3MpLFxuICAgICAgeyBkZXRhY2hlZDogZmFsc2UgfSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBzcGF3bkFzQ3VycmVudFVzZXIgKGNtZCwgYXJncykge1xuICBsb2cuaW5mbygncnVubmluZyBzcGF3bkFzQ3VycmVudFVzZXInLCBjbWQsIGFyZ3MpO1xuICByZXR1cm4gdXRpbHMuZXhlYygnd2hvYW1pJykuc3ByZWFkKGZ1bmN0aW9uIChzdGRvdXQpIHtcbiAgICBjb25zdCBjdXJyZW50VXNlciA9IHN0ZG91dC50cmltKCk7XG4gICAgcmV0dXJuIHNwYXduQXNVc2VyKGN1cnJlbnRVc2VyLCBjbWQsIGFyZ3MpO1xuICB9KTtcbn1cblxuXG5mdW5jdGlvbiBzZXRJb3NTaW11bGF0b3JTY2FsZSAoKSB7XG4gIGxvZy5pbmZvKCdzZXR0aW5nIHNpbXVsYXRvciBzY2FsZScpO1xuICByZXR1cm4gdXRpbHMuZXhlYyhcbiAgICAnZGVmYXVsdHMgd3JpdGUgY29tLmFwcGxlLmlwaG9uZXNpbXVsYXRvciBTaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUgMC41J1xuICApO1xufVxuXG5mdW5jdGlvbiBjb25maWd1cmVYY29kZSAoeENvZGVWZXJzaW9uKSB7XG4gIGxvZy5pbmZvKCdjb25maWd1cmluZyB4Q29kZScsIHhDb2RlVmVyc2lvbik7XG4gIGNvbnN0IGJpbiA9IHBhdGgucmVzb2x2ZShTSURFX1NJTVMsICdjb25maWd1cmUuc2gnKTtcbiAgcmV0dXJuIHV0aWxzLmV4ZWMoYmluICsgJyAnICsgeENvZGVWZXJzaW9uKTtcbn1cblxuZnVuY3Rpb24gcmVzZXRTaW1zICgpIHtcbiAgbG9nLmluZm8oJ3Jlc2V0dGluZyBzaW11bGF0b3JzJyk7XG4gIGNvbnN0IGJpbiA9IHBhdGgucmVzb2x2ZShTSURFX1NJTVMsICdyZXNldC1zaW1zLnNoJyk7XG4gIHJldHVybiB1dGlscy5leGVjKGJpbik7XG59XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgc3Bhd25Bc1VzZXIsXG4gIHNwYXduQXNDdXJyZW50VXNlcixcbiAgc2V0SW9zU2ltdWxhdG9yU2NhbGUsXG4gIGNvbmZpZ3VyZVhjb2RlLFxuICByZXNldFNpbXMsXG4gIGtpbGxBbGwsXG59O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
