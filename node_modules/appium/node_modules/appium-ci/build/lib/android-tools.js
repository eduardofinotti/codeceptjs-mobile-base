'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _this = this;

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _stream = require('stream');

var _stream2 = _interopRequireDefault(_stream);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _split = require('split');

var _split2 = _interopRequireDefault(_split);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _utils = require('./utils');

var _utils2 = _interopRequireDefault(_utils);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSupport = require('appium-support');

var log = {
  emu: _appiumSupport.logger.getLogger('android-emu')
};

var DEFAULT_OPTS = {
  initWait: 15000,
  maxWait: 300000,
  pool: 5000
};

var androidTools = {
  killAll: function killAll(processes) {
    var _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, p, cmd;

    return _regeneratorRuntime.async(function killAll$(context$1$0) {
      while (1) switch (context$1$0.prev = context$1$0.next) {
        case 0:
          processes = processes || ['emulator'];
          processes = _lodash2['default'].flatten([processes]);
          _iteratorNormalCompletion = true;
          _didIteratorError = false;
          _iteratorError = undefined;
          context$1$0.prev = 5;
          _iterator = _getIterator(processes);

        case 7:
          if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
            context$1$0.next = 16;
            break;
          }

          p = _step.value;
          cmd = process.platform.match(/^win/) ? 'powershell -Command "Stop-Process -Name *' + p + '*"' : 'sudo pkill -f ' + p;

          console.log('killing process with command:' + cmd); // eslint-disable-line no-console
          context$1$0.next = 13;
          return _regeneratorRuntime.awrap(_utils2['default'].exec(cmd)['catch'](function () {}));

        case 13:
          _iteratorNormalCompletion = true;
          context$1$0.next = 7;
          break;

        case 16:
          context$1$0.next = 22;
          break;

        case 18:
          context$1$0.prev = 18;
          context$1$0.t0 = context$1$0['catch'](5);
          _didIteratorError = true;
          _iteratorError = context$1$0.t0;

        case 22:
          context$1$0.prev = 22;
          context$1$0.prev = 23;

          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }

        case 25:
          context$1$0.prev = 25;

          if (!_didIteratorError) {
            context$1$0.next = 28;
            break;
          }

          throw _iteratorError;

        case 28:
          return context$1$0.finish(25);

        case 29:
          return context$1$0.finish(22);

        case 30:
        case 'end':
          return context$1$0.stop();
      }
    }, null, _this, [[5, 18, 22, 30], [23,, 25, 29]]);
  }
};

exports.androidTools = androidTools;

var Emulator = (function () {
  function Emulator(avd) {
    var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

    _classCallCheck(this, Emulator);

    this.opts = _lodash2['default'].clone(opts);
    _lodash2['default'].defaults(this.opts, DEFAULT_OPTS);
    this.avd = avd;
  }

  _createClass(Emulator, [{
    key: 'start',
    value: function start() {
      var out = new _stream2['default'].PassThrough();
      out.pipe((0, _split2['default'])()).on('data', function (line) {
        log.emu.info(line);
      });
      out.pipe(_fs2['default'].createWriteStream('emulator.log'));
      var emuBin = _os2['default'].platform() === 'linux' ? 'emulator64-x86' : 'emulator';
      var emuArgs = ['-avd', this.avd, '-no-snapshot-load', '-no-snapshot-save', '-no-audio', '-netfast'];
      if (_os2['default'].platform() === 'linux') {
        emuArgs = emuArgs.concat(['-qemu', '-m', '512', '-enable-kvm']);
      }
      log.emu.info('executing', emuBin, emuArgs.join(' '));
      this.child = _utils2['default'].spawn(emuBin, emuArgs);
      this.child.stdout.pipe(out);
      this.child.stderr.pipe(out);
    }
  }, {
    key: 'waitTillReady',
    value: function waitTillReady() {
      var startMs, timeoutPromise, emuStarted, emuErrored, procPromise, _waitForEmu;

      return _regeneratorRuntime.async(function waitTillReady$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            startMs = Date.now();
            timeoutPromise = undefined, emuStarted = undefined, emuErrored = undefined;
            procPromise = new _bluebird2['default'].Promise(function (resolve, reject) {
              _this2.child.on('error', function (err) {
                // eslint-disable-line promise/prefer-await-to-callbacks
                emuErrored = true;
                reject('Emulator didn\'t start properly, error:', err);
              });
              _this2.child.on('close', function () {
                if (!emuStarted) {
                  emuErrored = true;
                  reject('Emulator closed too early, see emu logs for errors.');
                }
              });
            }).cancellable()['catch'](_bluebird2['default'].Promise.CancellationError, function () {});

            _waitForEmu = function _waitForEmu(waitMs) {
              var stdout, _ref, _ref2;

              return _regeneratorRuntime.async(function _waitForEmu$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    waitMs = waitMs || this.opts.pool;

                    // wait

                    if (!(waitMs > 0)) {
                      context$3$0.next = 6;
                      break;
                    }

                    log.emu.info('Waiting ' + waitMs + ' ms for emu...');
                    timeoutPromise = new _bluebird2['default'].Promise(function () {}).timeout(waitMs); // cancellable
                    context$3$0.next = 6;
                    return _regeneratorRuntime.awrap(timeoutPromise.then(_waitForEmu)['catch'](_bluebird2['default'].Promise.TimeoutError, function () {})['catch'](_bluebird2['default'].Promise.CancellationError, function () {}));

                  case 6:
                    if (!emuErrored) {
                      context$3$0.next = 8;
                      break;
                    }

                    throw new Error('emulator errored');

                  case 8:
                    if (!(Date.now() - startMs > this.opts.maxWait)) {
                      context$3$0.next = 10;
                      break;
                    }

                    throw new Error('Emulator did not show up');

                  case 10:
                    stdout = undefined;
                    context$3$0.prev = 11;
                    context$3$0.next = 14;
                    return _regeneratorRuntime.awrap(_utils2['default'].exec('adb shell getprop sys.boot_completed'));

                  case 14:
                    _ref = context$3$0.sent;
                    _ref2 = _slicedToArray(_ref, 1);
                    stdout = _ref2[0];
                    context$3$0.next = 31;
                    break;

                  case 19:
                    context$3$0.prev = 19;
                    context$3$0.t0 = context$3$0['catch'](11);

                    if (!context$3$0.t0.toString().match(/device not found/)) {
                      context$3$0.next = 26;
                      break;
                    }

                    // there might be something wrong with the adb server
                    log.emu.warn('Device not found, it should be there, killing adb server.');
                    return context$3$0.abrupt('return', _utils2['default'].exec('adb kill-server').then(function () {
                      return _waitForEmu();
                    }));

                  case 26:
                    if (!context$3$0.t0.toString().match(/device offline/)) {
                      context$3$0.next = 30;
                      break;
                    }

                    return context$3$0.abrupt('return', _waitForEmu());

                  case 30:
                    throw context$3$0.t0;

                  case 31:
                    if (!(stdout && stdout.trim() === '1')) {
                      context$3$0.next = 36;
                      break;
                    }

                    log.emu.info('emulator started');
                    emuStarted = true;
                    context$3$0.next = 38;
                    break;

                  case 36:
                    context$3$0.next = 38;
                    return _regeneratorRuntime.awrap(_waitForEmu());

                  case 38:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2, [[11, 19]]);
            };

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_bluebird2['default'].race([_waitForEmu(this.opts.initWait), procPromise])['finally'](function () {
              // cancel outstanding promises so that they do not hang the node process
              timeoutPromise.cancel();
              procPromise.cancel();
            }));

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      if (this.child) {
        this.child.kill();
      }
    }
  }]);

  return Emulator;
})();

exports.Emulator = Emulator;

// one cancellable promise monitor the proc events for abnormal termination

// recursion end conditions

// retrieve emulator status
// eslint-disable-line promise/prefer-await-to-then

// that's ok,just wait

// check emulator status

// wait for first promise
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hbmRyb2lkLXRvb2xzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O3dCQUFjLFVBQVU7Ozs7c0JBQ0wsUUFBUTs7OztrQkFDWixJQUFJOzs7O3FCQUNELE9BQU87Ozs7a0JBQ1YsSUFBSTs7OztxQkFDRCxTQUFTOzs7O3NCQUNiLFFBQVE7Ozs7NkJBQ0MsZ0JBQWdCOztBQUV2QyxJQUFNLEdBQUcsR0FBRztBQUNWLEtBQUcsRUFBRSxzQkFBTyxTQUFTLENBQUMsYUFBYSxDQUFDO0NBQ3JDLENBQUM7O0FBRUYsSUFBTSxZQUFZLEdBQUc7QUFDbkIsVUFBUSxFQUFFLEtBQUs7QUFDZixTQUFPLEVBQUUsTUFBTTtBQUNmLE1BQUksRUFBRSxJQUFJO0NBQ1gsQ0FBQzs7QUFFRixJQUFLLFlBQVksR0FBRztBQUNsQixTQUFPLEVBQUUsaUJBQU8sU0FBUzt3RkFHZCxDQUFDLEVBQ0osR0FBRzs7Ozs7QUFIVCxtQkFBUyxHQUFHLFNBQVMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ3RDLG1CQUFTLEdBQUcsb0JBQUUsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQzs7Ozs7bUNBQ3JCLFNBQVM7Ozs7Ozs7O0FBQWQsV0FBQztBQUNKLGFBQUcsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRywyQ0FBMkMsR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUMvRixnQkFBZ0IsR0FBRyxDQUFDOztBQUN0QixpQkFBTyxDQUFDLEdBQUcsQ0FBQywrQkFBK0IsR0FBRyxHQUFHLENBQUMsQ0FBQzs7MkNBQzdDLG1CQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBTSxDQUFDLFlBQU0sRUFBRSxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBRXhDO0NBQ0YsQ0FBQzs7UUFFTyxZQUFZLEdBQVosWUFBWTs7SUFFUixRQUFRO0FBQ1As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OztBQUNqQyx1QkFBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUNqQyw4QkFBVSxHQUFHLElBQUksQ0FBQzs7Ozs7O3FEQUVaLFdBQVcsRUFBRTs7Ozs7OzthQUV0Qjs7OzZDQUdLLHNCQUFFLElBQUksQ0FBQyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxDQUFDLFdBQ2xELENBQUMsWUFBTTs7QUFFYiw0QkFBYyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ3hCLHlCQUFXLENBQUMsTUFBTSxFQUFFLENBQUM7YUFDdEIsQ0FBQzs7Ozs7OztLQUVMOzs7V0FFSSxnQkFBRztBQUNOLFVBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtBQUNkLFlBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7T0FDbkI7S0FDRjs7O1NBN0dVLFFBQVEiLCJmaWxlIjoibGliL2FuZHJvaWQtdG9vbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgc3RyZWFtIGZyb20gJ3N0cmVhbSc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHNwbGl0IGZyb20gJ3NwbGl0JztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgdXRpbHMgZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuXG5jb25zdCBsb2cgPSB7XG4gIGVtdTogbG9nZ2VyLmdldExvZ2dlcignYW5kcm9pZC1lbXUnKVxufTtcblxuY29uc3QgREVGQVVMVF9PUFRTID0ge1xuICBpbml0V2FpdDogMTUwMDAsXG4gIG1heFdhaXQ6IDMwMDAwMCxcbiAgcG9vbDogNTAwMCxcbn07XG5cbmxldCAgYW5kcm9pZFRvb2xzID0ge1xuICBraWxsQWxsOiBhc3luYyAocHJvY2Vzc2VzKSA9PiB7XG4gICAgcHJvY2Vzc2VzID0gcHJvY2Vzc2VzIHx8IFsnZW11bGF0b3InXTtcbiAgICBwcm9jZXNzZXMgPSBfLmZsYXR0ZW4oW3Byb2Nlc3Nlc10pO1xuICAgIGZvciAobGV0IHAgb2YgcHJvY2Vzc2VzKSB7XG4gICAgICBsZXQgY21kID0gcHJvY2Vzcy5wbGF0Zm9ybS5tYXRjaCgvXndpbi8pID8gJ3Bvd2Vyc2hlbGwgLUNvbW1hbmQgXCJTdG9wLVByb2Nlc3MgLU5hbWUgKicgKyBwICsgJypcIicgOlxuICAgICAgICAnc3VkbyBwa2lsbCAtZiAnICsgcDtcbiAgICAgIGNvbnNvbGUubG9nKCdraWxsaW5nIHByb2Nlc3Mgd2l0aCBjb21tYW5kOicgKyBjbWQpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGVcbiAgICAgIGF3YWl0IHV0aWxzLmV4ZWMoY21kKS5jYXRjaCgoKSA9PiB7fSk7XG4gICAgfVxuICB9XG59O1xuXG5leHBvcnQgeyBhbmRyb2lkVG9vbHMgfTtcblxuZXhwb3J0IGNsYXNzIEVtdWxhdG9yIHtcbiAgY29uc3RydWN0b3IgKGF2ZCwgb3B0cyA9IHt9KSB7XG4gICAgdGhpcy5vcHRzID0gXy5jbG9uZShvcHRzKTtcbiAgICBfLmRlZmF1bHRzKHRoaXMub3B0cywgREVGQVVMVF9PUFRTKTtcbiAgICB0aGlzLmF2ZCA9IGF2ZDtcbiAgfVxuXG4gIHN0YXJ0ICgpIHtcbiAgICBsZXQgb3V0ID0gbmV3IHN0cmVhbS5QYXNzVGhyb3VnaCgpO1xuICAgIG91dC5waXBlKHNwbGl0KCkpXG4gICAgICAub24oJ2RhdGEnLCAobGluZSkgPT4ge1xuICAgICAgICBsb2cuZW11LmluZm8obGluZSk7XG4gICAgICB9KTtcbiAgICBvdXQucGlwZShmcy5jcmVhdGVXcml0ZVN0cmVhbSgnZW11bGF0b3IubG9nJykpO1xuICAgIGxldCBlbXVCaW4gPSBvcy5wbGF0Zm9ybSgpID09PSAnbGludXgnID8gJ2VtdWxhdG9yNjQteDg2JyA6ICdlbXVsYXRvcic7XG4gICAgbGV0IGVtdUFyZ3MgPSBbXG4gICAgICAnLWF2ZCcsIHRoaXMuYXZkLFxuICAgICAgJy1uby1zbmFwc2hvdC1sb2FkJywgJy1uby1zbmFwc2hvdC1zYXZlJyxcbiAgICAgICctbm8tYXVkaW8nLCAnLW5ldGZhc3QnXG4gICAgXTtcbiAgICBpZiAob3MucGxhdGZvcm0oKSA9PT0gJ2xpbnV4Jykge1xuICAgICAgZW11QXJncyA9IGVtdUFyZ3MuY29uY2F0KFtcbiAgICAgICAgJy1xZW11JywgJy1tJywgJzUxMicsICctZW5hYmxlLWt2bSdcbiAgICAgIF0pO1xuICAgIH1cbiAgICBsb2cuZW11LmluZm8oJ2V4ZWN1dGluZycsIGVtdUJpbiwgZW11QXJncy5qb2luKCcgJykpO1xuICAgIHRoaXMuY2hpbGQgPSB1dGlscy5zcGF3bihlbXVCaW4sIGVtdUFyZ3MpO1xuICAgIHRoaXMuY2hpbGQuc3Rkb3V0LnBpcGUob3V0KTtcbiAgICB0aGlzLmNoaWxkLnN0ZGVyci5waXBlKG91dCk7XG4gIH1cblxuICBhc3luYyB3YWl0VGlsbFJlYWR5ICgpIHtcbiAgICBsZXQgc3RhcnRNcyA9IERhdGUubm93KCk7XG4gICAgbGV0IHRpbWVvdXRQcm9taXNlLCBlbXVTdGFydGVkLCBlbXVFcnJvcmVkO1xuXG4gICAgLy8gb25lIGNhbmNlbGxhYmxlIHByb21pc2UgbW9uaXRvciB0aGUgcHJvYyBldmVudHMgZm9yIGFibm9ybWFsIHRlcm1pbmF0aW9uXG4gICAgbGV0IHByb2NQcm9taXNlID0gbmV3IEIuUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmNoaWxkLm9uKCdlcnJvcicsIChlcnIpID0+IHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by1jYWxsYmFja3NcbiAgICAgICAgZW11RXJyb3JlZCA9IHRydWU7XG4gICAgICAgIHJlamVjdCgnRW11bGF0b3IgZGlkblxcJ3Qgc3RhcnQgcHJvcGVybHksIGVycm9yOicsIGVycik7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuY2hpbGQub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICBpZiAoIWVtdVN0YXJ0ZWQpIHtcbiAgICAgICAgICBlbXVFcnJvcmVkID0gdHJ1ZTtcbiAgICAgICAgICByZWplY3QoJ0VtdWxhdG9yIGNsb3NlZCB0b28gZWFybHksIHNlZSBlbXUgbG9ncyBmb3IgZXJyb3JzLicpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KS5jYW5jZWxsYWJsZSgpLmNhdGNoKEIuUHJvbWlzZS5DYW5jZWxsYXRpb25FcnJvciwgKCkgPT4ge30pO1xuXG4gICAgbGV0IF93YWl0Rm9yRW11ID0gYXN5bmMgKHdhaXRNcykgPT4ge1xuICAgICAgd2FpdE1zID0gd2FpdE1zIHx8IHRoaXMub3B0cy5wb29sO1xuXG4gICAgICAvLyB3YWl0XG4gICAgICBpZiAod2FpdE1zID4gMCkge1xuICAgICAgICBsb2cuZW11LmluZm8oJ1dhaXRpbmcgJyArIHdhaXRNcyArICAnIG1zIGZvciBlbXUuLi4nKTtcbiAgICAgICAgdGltZW91dFByb21pc2UgPSBuZXcgQi5Qcm9taXNlKCgpID0+IHt9KS50aW1lb3V0KHdhaXRNcyk7IC8vIGNhbmNlbGxhYmxlXG4gICAgICAgIGF3YWl0IHRpbWVvdXRQcm9taXNlLnRoZW4oX3dhaXRGb3JFbXUpXG4gICAgICAgICAgICAuY2F0Y2goQi5Qcm9taXNlLlRpbWVvdXRFcnJvciwgKCkgPT4ge30pXG4gICAgICAgICAgICAuY2F0Y2goQi5Qcm9taXNlLkNhbmNlbGxhdGlvbkVycm9yLCAoKSA9PiB7fSk7XG4gICAgICB9XG5cbiAgICAgIC8vIHJlY3Vyc2lvbiBlbmQgY29uZGl0aW9uc1xuICAgICAgaWYgKGVtdUVycm9yZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdlbXVsYXRvciBlcnJvcmVkJyk7XG4gICAgICB9XG4gICAgICBpZiAoRGF0ZS5ub3coKSAtIHN0YXJ0TXMgPiB0aGlzLm9wdHMubWF4V2FpdCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0VtdWxhdG9yIGRpZCBub3Qgc2hvdyB1cCcpO1xuICAgICAgfVxuXG4gICAgICAvLyByZXRyaWV2ZSBlbXVsYXRvciBzdGF0dXNcbiAgICAgIGxldCBzdGRvdXQ7XG4gICAgICB0cnkge1xuICAgICAgICBbc3Rkb3V0XSA9IGF3YWl0IHV0aWxzLmV4ZWMoJ2FkYiBzaGVsbCBnZXRwcm9wIHN5cy5ib290X2NvbXBsZXRlZCcpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGlmIChlcnIudG9TdHJpbmcoKS5tYXRjaCgvZGV2aWNlIG5vdCBmb3VuZC8pKSB7XG4gICAgICAgICAgLy8gdGhlcmUgbWlnaHQgYmUgc29tZXRoaW5nIHdyb25nIHdpdGggdGhlIGFkYiBzZXJ2ZXJcbiAgICAgICAgICBsb2cuZW11Lndhcm4oJ0RldmljZSBub3QgZm91bmQsIGl0IHNob3VsZCBiZSB0aGVyZSwga2lsbGluZyBhZGIgc2VydmVyLicpO1xuICAgICAgICAgIHJldHVybiB1dGlscy5leGVjKCdhZGIga2lsbC1zZXJ2ZXInKS50aGVuKCgpID0+IHsgcmV0dXJuIF93YWl0Rm9yRW11KCk7IH0pOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLXRoZW5cbiAgICAgICAgfSBlbHNlIGlmIChlcnIudG9TdHJpbmcoKS5tYXRjaCgvZGV2aWNlIG9mZmxpbmUvKSkge1xuICAgICAgICAgIC8vIHRoYXQncyBvayxqdXN0IHdhaXRcbiAgICAgICAgICByZXR1cm4gX3dhaXRGb3JFbXUoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyAoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBjaGVjayBlbXVsYXRvciBzdGF0dXNcbiAgICAgIGlmIChzdGRvdXQgJiYgc3Rkb3V0LnRyaW0oKSA9PT0gJzEnKSB7XG4gICAgICAgIGxvZy5lbXUuaW5mbygnZW11bGF0b3Igc3RhcnRlZCcpO1xuICAgICAgICBlbXVTdGFydGVkID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF3YWl0IF93YWl0Rm9yRW11KCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIC8vIHdhaXQgZm9yIGZpcnN0IHByb21pc2VcbiAgICBhd2FpdCBCLnJhY2UoW193YWl0Rm9yRW11KHRoaXMub3B0cy5pbml0V2FpdCksIHByb2NQcm9taXNlXSlcbiAgICAgIC5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgLy8gY2FuY2VsIG91dHN0YW5kaW5nIHByb21pc2VzIHNvIHRoYXQgdGhleSBkbyBub3QgaGFuZyB0aGUgbm9kZSBwcm9jZXNzXG4gICAgICAgIHRpbWVvdXRQcm9taXNlLmNhbmNlbCgpO1xuICAgICAgICBwcm9jUHJvbWlzZS5jYW5jZWwoKTtcbiAgICAgIH0pO1xuXG4gIH1cblxuICBzdG9wICgpIHtcbiAgICBpZiAodGhpcy5jaGlsZCkge1xuICAgICAgdGhpcy5jaGlsZC5raWxsKCk7XG4gICAgfVxuICB9XG59XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
