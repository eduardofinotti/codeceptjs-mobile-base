'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Promise = require('babel-runtime/core-js/promise')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _commandsIndex = require('./commands/index');

var _commandsIndex2 = _interopRequireDefault(_commandsIndex);

var _appiumBaseDriver = require('appium-base-driver');

var _asyncbox = require('asyncbox');

var _teen_process = require('teen_process');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var COMMAND_TYPES = {
  ACTION: 'action',
  SHUTDOWN: 'shutdown'
};

var TizenBootstrap = (function () {
  function TizenBootstrap(sdb) {
    var systemPort = arguments.length <= 1 || arguments[1] === undefined ? 8888 : arguments[1];
    var webSocket = arguments.length <= 2 || arguments[2] === undefined ? undefined : arguments[2];

    _classCallCheck(this, TizenBootstrap);

    this.appPackage;
    this.sdb = sdb;
    this.systemPort = systemPort;
    this.webSocket = webSocket;
    this.ignoreUnexpectedShutdown = false;
    this.isUiAutomatorInstalled = false;
    this.uiautomator = 'uiautomator';
    this.isRestartApp = false;

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = _getIterator(_lodash2['default'].pairs(_commandsIndex2['default'])), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var _step$value = _slicedToArray(_step.value, 2);

        var cmd = _step$value[0];
        var fn = _step$value[1];

        TizenBootstrap.prototype[cmd] = fn;
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }
  }

  _createClass(TizenBootstrap, [{
    key: 'start',
    value: function start(appPackage) {
      return _regeneratorRuntime.async(function start$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.appPackage = appPackage;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.init());

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.sdb.forwardPort(this.systemPort, 8888));

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _asyncbox.sleep)(6000));

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.connectSocket());

          case 9:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'connectSocket',
    value: function connectSocket() {
      return _regeneratorRuntime.async(function connectSocket$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(new _Promise(function (resolve, reject) {
              try {
                if (!_this.socketClient) {
                  _this.socketClient = _net2['default'].connect(_this.systemPort);
                  _this.socketClient.setEncoding('utf8');
                  _this.socketClient.on('error', function (err) {
                    if (!_this.ignoreUnexpectedShutdown) {
                      throw new Error('Tizen bootstrap socket crashed: ' + err);
                    }
                  });
                  _this.socketClient.once('connect', function () {
                    _logger2['default'].info("Tizen bootstrap socket is now connected");
                    resolve();
                  });
                } else {
                  _logger2['default'].info("SocketClient already Created");
                  resolve();
                }
              } catch (err) {
                reject(err);
              }
            }));

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](0);

            _logger2['default'].errorAndThrow('Error occured while reconnection TizenBootstrap. Original error: ' + context$2$0.t0);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 6]]);
    }
  }, {
    key: 'sendCommand',
    value: function sendCommand(type) {
      var extra = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      var isStartedApp;
      return _regeneratorRuntime.async(function sendCommand$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(this.appPackage && type !== COMMAND_TYPES.SHUTDOWN)) {
              context$2$0.next = 14;
              break;
            }

            if (!this.isRestartApp) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((0, _asyncbox.sleep)(5000));

          case 4:
            this.isRestartApp = false;

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.sdb.isStartedApp(this.appPackage));

          case 7:
            isStartedApp = context$2$0.sent;

            if (isStartedApp) {
              context$2$0.next = 14;
              break;
            }

            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.sdb.startApp(this.appPackage));

          case 11:
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap((0, _asyncbox.sleep)(3000));

          case 13:
            this.isRestartApp = false;

          case 14:
            if (this.socketClient) {
              context$2$0.next = 17;
              break;
            }

            context$2$0.next = 17;
            return _regeneratorRuntime.awrap(this.connectSocket());

          case 17:
            context$2$0.next = 19;
            return _regeneratorRuntime.awrap(new _Promise(function (resolve, reject) {
              var cmd = _Object$assign({ cmd: type }, extra);
              var cmdJson = JSON.stringify(cmd) + ' \n';
              _logger2['default'].debug('Sending command to tizen: ' + _lodash2['default'].trunc(cmdJson, 1000).trim());

              try {
                _this2.socketClient.removeAllListeners('timeout');
                _this2.socketClient.removeAllListeners('end');
                _this2.socketClient.write(cmdJson);
                _this2.socketClient.on('data', function (data) {
                  var streamData = '';
                  _logger2['default'].debug("Received command result from bootstrap : " + data);
                  try {
                    streamData = JSON.parse(streamData + data);
                    _this2.socketClient.removeAllListeners('data');
                    if (streamData.status === 0) {
                      resolve(streamData.value);
                    }
                    reject((0, _appiumBaseDriver.errorFromCode)(streamData.status));
                  } catch (ign) {
                    _logger2['default'].debug("Stream still not complete, waiting");
                    streamData += data;
                  }
                });
                _this2.socketClient.setTimeout(15000);
                _this2.socketClient.on('timeout', function () {
                  _this2.socketClient.destroy();
                  _this2.socketClient = null;
                  _this2.isRestartApp = true;
                  reject((0, _appiumBaseDriver.errorFromCode)(-1, "No response from Server"));
                });
                _this2.socketClient.on('end', function () {
                  _this2.socketClient.destroy();
                  _this2.socketClient = null;
                  _this2.isRestartApp = true;
                  reject((0, _appiumBaseDriver.errorFromCode)(-1, "Socket ended by Server"));
                });
              } catch (err) {
                reject((0, _appiumBaseDriver.errorFromCode)(-1, err));
              }
            }));

          case 19:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 20:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'sendAction',
    value: function sendAction(action) {
      var params = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      var extra;
      return _regeneratorRuntime.async(function sendAction$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            extra = { action: action, params: params };
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.sendCommand(COMMAND_TYPES.ACTION, extra));

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'sendInputAction',
    value: function sendInputAction(action) {
      var params = arguments.length <= 1 || arguments[1] === undefined ? [] : arguments[1];
      var actions, actionPath, i;
      return _regeneratorRuntime.async(function sendInputAction$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (action === 'touchDown') {
              action = 'down';
            } else if (action === 'touchUp') {
              action = 'up';
            } else if (action === 'touchMove') {
              action = 'move';
            }

            actions = [];
            actionPath = "dbus-send --system --type=signal /org/tizen/appium org.tizen.appium.Input";

            actions.push(actionPath);
            actions.push('string:\'' + action + '\'');

            for (i = 0; i < params.length; i++) {
              if (params[i]) {
                actions.push('string:\'' + params[i] + '\'');
              } else if (params[i] === 0) {
                actions.push('string:\'' + params[i] + '\'');
              } else {
                actions.push("string:'null'");
              }
            }

            if (params.length === 0) {
              actions.push("string:'null'");
              actions.push("string:'null'");
            } else if (params.length === 1) {
              actions.push("string:'null'");
            }

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.sdb.shell(actions));

          case 9:
            return context$2$0.abrupt('return', true);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'shutdown',
    value: function shutdown() {
      var uiautomatorStatus;
      return _regeneratorRuntime.async(function shutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.socketClient) {
              this.socketClient.end();
              this.socketClient.destroy();
              this.socketClient = null;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.sdb.processExists(this.uiautomator));

          case 3:
            uiautomatorStatus = context$2$0.sent;

            if (!uiautomatorStatus) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.sdb.killProcess(this.uiautomator));

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.sdb.removePortForward(this.systemPort));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'init',
    value: function init() {
      var uiautomatorStatus;
      return _regeneratorRuntime.async(function init$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.sdb.root());

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.sdb.fileExists('/usr/bin/' + this.uiautomator));

          case 4:
            this.isUiAutomatorInstalled = context$2$0.sent;

            if (this.isUiAutomatorInstalled) {
              context$2$0.next = 8;
              break;
            }

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.pushUiAutomator());

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.sdb.processExists(this.uiautomator));

          case 10:
            uiautomatorStatus = context$2$0.sent;

            if (uiautomatorStatus) {
              context$2$0.next = 15;
              break;
            }

            (0, _teen_process.exec)(this.sdb.executable.path, ['shell', '/usr/bin/' + this.uiautomator]);
            context$2$0.next = 20;
            break;

          case 15:
            context$2$0.next = 17;
            return _regeneratorRuntime.awrap(this.sdb.killProcess(this.uiautomator));

          case 17:
            context$2$0.next = 19;
            return _regeneratorRuntime.awrap((0, _asyncbox.sleep)(1000));

          case 19:
            (0, _teen_process.exec)(this.sdb.executable.path, ['shell', '/usr/bin/' + this.uiautomator]);

          case 20:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'pushUiAutomator',
    value: function pushUiAutomator() {
      var arch, file;
      return _regeneratorRuntime.async(function pushUiAutomator$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.sdb.shell('uname -a'));

          case 2:
            arch = context$2$0.sent;
            file = this.uiautomator;

            if (arch.indexOf('i686') != -1) {
              file += '_i586';
            } else if (arch.indexOf('x86_64') != -1) {
              file += '_x86_64';
            } else {
              file += '_armv7l';
            }

            _logger2['default'].debug('Target Architecture : ' + arch);
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.sdb.push(__dirname + ('/../' + file), '/usr/bin/' + this.uiautomator));

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'removeUiAutomator',
    value: function removeUiAutomator() {
      return _regeneratorRuntime.async(function removeUiAutomator$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.sdb.shell('rm /usr/bin/uiautomator'));

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'ignoreUnexpectedShutdown',
    set: function set(ignore) {
      _logger2['default'].debug((ignore ? 'Ignoring' : 'Watching for') + ' bootstrap disconnect');
      this._ignoreUnexpectedShutdown = ignore;
    },
    get: function get() {
      return this._ignoreUnexpectedShutdown;
    }
  }]);

  return TizenBootstrap;
})();

exports.TizenBootstrap = TizenBootstrap;
exports.COMMAND_TYPES = COMMAND_TYPES;
exports['default'] = TizenBootstrap;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90aXplbi1ib290c3RyYXAuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzttQkFBZ0IsS0FBSzs7OztzQkFDUCxRQUFROzs7OzZCQUNELGtCQUFrQjs7OztnQ0FDVCxvQkFBb0I7O3dCQUM1QixVQUFVOzs0QkFDWCxjQUFjOztzQkFDbkIsVUFBVTs7OztBQUcxQixJQUFNLGFBQWEsR0FBRztBQUNwQixRQUFNLEVBQUUsUUFBUTtBQUNoQixVQUFRLEVBQUUsVUFBVTtDQUNyQixDQUFDOztJQUVJLGNBQWM7QUFDTixXQURSLGNBQWMsQ0FDTCxHQUFHLEVBQTRDO1FBQTFDLFVBQVUseURBQUcsSUFBSTtRQUFFLFNBQVMseURBQUcsU0FBUzs7MEJBRHRELGNBQWM7O0FBRWhCLFFBQUksQ0FBQyxVQUFVLENBQUM7QUFDaEIsUUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7QUFDZixRQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztBQUM3QixRQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztBQUMzQixRQUFJLENBQUMsd0JBQXdCLEdBQUcsS0FBSyxDQUFDO0FBQ3RDLFFBQUksQ0FBQyxzQkFBc0IsR0FBRyxLQUFLLENBQUM7QUFDcEMsUUFBSSxDQUFDLFdBQVcsR0FBRyxhQUFhLENBQUM7QUFDakMsUUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7Ozs7Ozs7QUFFMUIsd0NBQXNCLG9CQUFFLEtBQUssNEJBQVUsNEdBQUU7OztZQUEvQixHQUFHO1lBQUUsRUFBRTs7QUFDZixzQkFBYyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7T0FDcEM7Ozs7Ozs7Ozs7Ozs7OztHQUNGOztlQWRHLGNBQWM7O1dBZ0JOLGVBQUMsVUFBVTs7OztBQUNyQixnQkFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7OzZDQUN2QixJQUFJLENBQUMsSUFBSSxFQUFFOzs7OzZDQUNYLElBQUks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QUksQ0FBQyxDQUFDOzs2Q0FDckMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxhQUFVLElBQUksQ0FBRSxnQkFBYyxJQUFJLENBQUMsV0FBVyxDQUFHOzs7Ozs7O0tBQy9FOzs7V0FFdUI7Ozs7OzZDQUNoQixJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQzs7Ozs7OztLQUNoRDs7O1NBRTRCLGFBQUMsTUFBTSxFQUFFO0FBQ3BDLDBCQUFJLEtBQUssRUFBSSxNQUFNLEdBQUcsVUFBVSxHQUFHLGNBQWMsQ0FBQSwyQkFBd0IsQ0FBQztBQUMxRSxVQUFJLENBQUMseUJBQXlCLEdBQUcsTUFBTSxDQUFDO0tBQ3pDO1NBRTRCLGVBQUc7QUFDOUIsYUFBTyxJQUFJLENBQUMseUJBQXlCLENBQUM7S0FDdkM7OztTQXpORyxjQUFjOzs7UUE0TlgsY0FBYyxHQUFkLGNBQWM7UUFBRSxhQUFhLEdBQWIsYUFBYTtxQkFDdkIsY0FBYyIsImZpbGUiOiJsaWIvdGl6ZW4tYm9vdHN0cmFwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG5ldCBmcm9tICduZXQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBjb21tYW5kcyBmcm9tICcuL2NvbW1hbmRzL2luZGV4JztcbmltcG9ydCB7IGVycm9yRnJvbUNvZGUgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgc2xlZXAgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuXG5cbmNvbnN0IENPTU1BTkRfVFlQRVMgPSB7XG4gIEFDVElPTjogJ2FjdGlvbicsXG4gIFNIVVRET1dOOiAnc2h1dGRvd24nXG59O1xuXG5jbGFzcyBUaXplbkJvb3RzdHJhcCB7XG4gIGNvbnN0cnVjdG9yIChzZGIsIHN5c3RlbVBvcnQgPSA4ODg4LCB3ZWJTb2NrZXQgPSB1bmRlZmluZWQpIHtcbiAgICB0aGlzLmFwcFBhY2thZ2U7XG4gICAgdGhpcy5zZGIgPSBzZGI7XG4gICAgdGhpcy5zeXN0ZW1Qb3J0ID0gc3lzdGVtUG9ydDtcbiAgICB0aGlzLndlYlNvY2tldCA9IHdlYlNvY2tldDtcbiAgICB0aGlzLmlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biA9IGZhbHNlO1xuICAgIHRoaXMuaXNVaUF1dG9tYXRvckluc3RhbGxlZCA9IGZhbHNlO1xuICAgIHRoaXMudWlhdXRvbWF0b3IgPSAndWlhdXRvbWF0b3InO1xuICAgIHRoaXMuaXNSZXN0YXJ0QXBwID0gZmFsc2U7XG5cbiAgICBmb3IgKGxldCBbY21kLCBmbl0gb2YgXy5wYWlycyhjb21tYW5kcykpIHtcbiAgICAgIFRpemVuQm9vdHN0cmFwLnByb3RvdHlwZVtjbWRdID0gZm47XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc3RhcnQgKGFwcFBhY2thZ2UpIHtcbiAgICB0aGlzLmFwcFBhY2thZ2UgPSBhcHBQYWNrYWdlO1xuICAgIGF3YWl0IHRoaXMuaW5pdCgpO1xuICAgIGF3YWl0IHRoaXMuc2RiLmZvcndhcmRQb3J0KHRoaXMuc3lzdGVtUG9ydCwgODg4OCk7XG4gICAgYXdhaXQgc2xlZXAoNjAwMCk7XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5jb25uZWN0U29ja2V0KCk7XG4gIH1cblxuICBhc3luYyBjb25uZWN0U29ja2V0ICgpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBpZiAoIXRoaXMuc29ja2V0Q2xpZW50KSB7XG4gICAgICAgICAgICB0aGlzLnNvY2tldENsaWVudCA9IG5ldC5jb25uZWN0KHRoaXMuc3lzdGVtUG9ydCk7XG4gICAgICAgICAgICB0aGlzLnNvY2tldENsaWVudC5zZXRFbmNvZGluZygndXRmOCcpO1xuICAgICAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICAgICAgICBpZiAoIXRoaXMuaWdub3JlVW5leHBlY3RlZFNodXRkb3duKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaXplbiBib290c3RyYXAgc29ja2V0IGNyYXNoZWQ6ICR7ZXJyfWApO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMuc29ja2V0Q2xpZW50Lm9uY2UoJ2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgICAgICAgICAgIGxvZy5pbmZvKFwiVGl6ZW4gYm9vdHN0cmFwIHNvY2tldCBpcyBub3cgY29ubmVjdGVkXCIpO1xuICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbG9nLmluZm8oXCJTb2NrZXRDbGllbnQgYWxyZWFkeSBDcmVhdGVkXCIpO1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYEVycm9yIG9jY3VyZWQgd2hpbGUgcmVjb25uZWN0aW9uIFRpemVuQm9vdHN0cmFwLiBPcmlnaW5hbCBlcnJvcjogJHtlcnJ9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VuZENvbW1hbmQgKHR5cGUsIGV4dHJhID0ge30pIHtcbiAgICBpZiAodGhpcy5hcHBQYWNrYWdlICYmIHR5cGUgIT09IENPTU1BTkRfVFlQRVMuU0hVVERPV04pIHtcbiAgICAgIGlmICh0aGlzLmlzUmVzdGFydEFwcCkge1xuICAgICAgICBhd2FpdCBzbGVlcCg1MDAwKTtcbiAgICAgICAgdGhpcy5pc1Jlc3RhcnRBcHAgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGxldCBpc1N0YXJ0ZWRBcHAgPSBhd2FpdCB0aGlzLnNkYi5pc1N0YXJ0ZWRBcHAodGhpcy5hcHBQYWNrYWdlKTtcbiAgICAgIGlmICghaXNTdGFydGVkQXBwKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuc2RiLnN0YXJ0QXBwKHRoaXMuYXBwUGFja2FnZSk7XG4gICAgICAgIGF3YWl0IHNsZWVwKDMwMDApO1xuICAgICAgICB0aGlzLmlzUmVzdGFydEFwcCA9IGZhbHNlO1xuICAgICAgfVxuICAgIH1cblxuXG4gICAgaWYgKCF0aGlzLnNvY2tldENsaWVudCkge1xuICAgICAgYXdhaXQgdGhpcy5jb25uZWN0U29ja2V0KCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGxldCBjbWQgPSBPYmplY3QuYXNzaWduKHsgY21kOiB0eXBlIH0sIGV4dHJhKTtcbiAgICAgIGxldCBjbWRKc29uID0gYCR7SlNPTi5zdHJpbmdpZnkoY21kKX0gXFxuYDtcbiAgICAgIGxvZy5kZWJ1ZyhgU2VuZGluZyBjb21tYW5kIHRvIHRpemVuOiAke18udHJ1bmMoY21kSnNvbiwgMTAwMCkudHJpbSgpfWApO1xuXG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLnNvY2tldENsaWVudC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3RpbWVvdXQnKTtcbiAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQucmVtb3ZlQWxsTGlzdGVuZXJzKCdlbmQnKTtcbiAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQud3JpdGUoY21kSnNvbik7XG4gICAgICAgIHRoaXMuc29ja2V0Q2xpZW50Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgICAgICBsZXQgc3RyZWFtRGF0YSA9ICcnO1xuICAgICAgICAgIGxvZy5kZWJ1ZyhcIlJlY2VpdmVkIGNvbW1hbmQgcmVzdWx0IGZyb20gYm9vdHN0cmFwIDogXCIrZGF0YSk7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHN0cmVhbURhdGEgPSBKU09OLnBhcnNlKHN0cmVhbURhdGEgKyBkYXRhKTtcbiAgICAgICAgICAgIHRoaXMuc29ja2V0Q2xpZW50LnJlbW92ZUFsbExpc3RlbmVycygnZGF0YScpO1xuICAgICAgICAgICAgaWYgKHN0cmVhbURhdGEuc3RhdHVzID09PSAwKSB7XG4gICAgICAgICAgICAgIHJlc29sdmUoc3RyZWFtRGF0YS52YWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZWplY3QoZXJyb3JGcm9tQ29kZShzdHJlYW1EYXRhLnN0YXR1cykpO1xuICAgICAgICAgIH0gY2F0Y2ggKGlnbikge1xuICAgICAgICAgICAgbG9nLmRlYnVnKFwiU3RyZWFtIHN0aWxsIG5vdCBjb21wbGV0ZSwgd2FpdGluZ1wiKTtcbiAgICAgICAgICAgIHN0cmVhbURhdGEgKz0gZGF0YTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnNvY2tldENsaWVudC5zZXRUaW1lb3V0KDE1MDAwKTtcbiAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQub24oJ3RpbWVvdXQnLCAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQuZGVzdHJveSgpO1xuICAgICAgICAgIHRoaXMuc29ja2V0Q2xpZW50ID0gbnVsbDtcbiAgICAgICAgICB0aGlzLmlzUmVzdGFydEFwcCA9IHRydWU7XG4gICAgICAgICAgcmVqZWN0KGVycm9yRnJvbUNvZGUoLTEsIFwiTm8gcmVzcG9uc2UgZnJvbSBTZXJ2ZXJcIikpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICB0aGlzLnNvY2tldENsaWVudC5kZXN0cm95KCk7XG4gICAgICAgICAgdGhpcy5zb2NrZXRDbGllbnQgPSBudWxsO1xuICAgICAgICAgIHRoaXMuaXNSZXN0YXJ0QXBwID0gdHJ1ZTtcbiAgICAgICAgICByZWplY3QoZXJyb3JGcm9tQ29kZSgtMSwgXCJTb2NrZXQgZW5kZWQgYnkgU2VydmVyXCIpKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmVqZWN0KGVycm9yRnJvbUNvZGUoLTEsIGVycikpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc2VuZEFjdGlvbiAoYWN0aW9uLCBwYXJhbXMgPSB7fSkge1xuICAgIGxldCBleHRyYSA9IHsgYWN0aW9uLCBwYXJhbXMgfTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kQ29tbWFuZChDT01NQU5EX1RZUEVTLkFDVElPTiwgZXh0cmEpO1xuICB9XG5cbiAgYXN5bmMgc2VuZElucHV0QWN0aW9uIChhY3Rpb24sIHBhcmFtcyA9IFtdKSB7XG4gICAgaWYgKGFjdGlvbiA9PT0gJ3RvdWNoRG93bicpIHtcbiAgICAgIGFjdGlvbiA9ICdkb3duJztcbiAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gJ3RvdWNoVXAnKSB7XG4gICAgICBhY3Rpb24gPSAndXAnO1xuICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAndG91Y2hNb3ZlJykge1xuICAgICAgYWN0aW9uID0gJ21vdmUnO1xuICAgIH1cblxuICAgIGxldCBhY3Rpb25zID0gW107XG4gICAgbGV0IGFjdGlvblBhdGggPSBcImRidXMtc2VuZCAtLXN5c3RlbSAtLXR5cGU9c2lnbmFsIC9vcmcvdGl6ZW4vYXBwaXVtIG9yZy50aXplbi5hcHBpdW0uSW5wdXRcIjtcbiAgICBhY3Rpb25zLnB1c2goYWN0aW9uUGF0aCk7XG4gICAgYWN0aW9ucy5wdXNoKGBzdHJpbmc6JyR7YWN0aW9ufSdgKTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFyYW1zLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAocGFyYW1zW2ldKSB7XG4gICAgICAgIGFjdGlvbnMucHVzaChgc3RyaW5nOicke3BhcmFtc1tpXX0nYCk7XG4gICAgICB9IGVsc2UgaWYgKHBhcmFtc1tpXSA9PT0gMCkge1xuICAgICAgICBhY3Rpb25zLnB1c2goYHN0cmluZzonJHtwYXJhbXNbaV19J2ApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYWN0aW9ucy5wdXNoKFwic3RyaW5nOidudWxsJ1wiKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocGFyYW1zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgYWN0aW9ucy5wdXNoKFwic3RyaW5nOidudWxsJ1wiKTtcbiAgICAgIGFjdGlvbnMucHVzaChcInN0cmluZzonbnVsbCdcIik7XG4gICAgfSBlbHNlIGlmIChwYXJhbXMubGVuZ3RoID09PSAxKSB7XG4gICAgICBhY3Rpb25zLnB1c2goXCJzdHJpbmc6J251bGwnXCIpO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuc2RiLnNoZWxsKGFjdGlvbnMpO1xuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBhc3luYyBzaHV0ZG93biAoKSB7XG4gICAgaWYgKHRoaXMuc29ja2V0Q2xpZW50KSB7XG4gICAgICB0aGlzLnNvY2tldENsaWVudC5lbmQoKTtcbiAgICAgIHRoaXMuc29ja2V0Q2xpZW50LmRlc3Ryb3koKTtcbiAgICAgIHRoaXMuc29ja2V0Q2xpZW50ID0gbnVsbDtcbiAgICB9XG5cbiAgICBsZXQgdWlhdXRvbWF0b3JTdGF0dXMgPSBhd2FpdCB0aGlzLnNkYi5wcm9jZXNzRXhpc3RzKHRoaXMudWlhdXRvbWF0b3IpO1xuICAgIGlmICh1aWF1dG9tYXRvclN0YXR1cykge1xuICAgICAgYXdhaXQgdGhpcy5zZGIua2lsbFByb2Nlc3ModGhpcy51aWF1dG9tYXRvcik7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5zZGIucmVtb3ZlUG9ydEZvcndhcmQodGhpcy5zeXN0ZW1Qb3J0KTtcbiAgfVxuXG4gIGFzeW5jIGluaXQgKCkge1xuICAgIGF3YWl0IHRoaXMuc2RiLnJvb3QoKTtcblxuICAgIHRoaXMuaXNVaUF1dG9tYXRvckluc3RhbGxlZCA9IGF3YWl0IHRoaXMuc2RiLmZpbGVFeGlzdHMoYC91c3IvYmluLyR7dGhpcy51aWF1dG9tYXRvcn1gKTtcbiAgICBpZiAoIXRoaXMuaXNVaUF1dG9tYXRvckluc3RhbGxlZCkge1xuICAgICAgYXdhaXQgdGhpcy5wdXNoVWlBdXRvbWF0b3IoKTtcbiAgICB9XG5cbiAgICBsZXQgdWlhdXRvbWF0b3JTdGF0dXMgPSBhd2FpdCB0aGlzLnNkYi5wcm9jZXNzRXhpc3RzKHRoaXMudWlhdXRvbWF0b3IpO1xuICAgIGlmICghdWlhdXRvbWF0b3JTdGF0dXMpIHtcbiAgICAgIGV4ZWModGhpcy5zZGIuZXhlY3V0YWJsZS5wYXRoLCBbJ3NoZWxsJywgYC91c3IvYmluLyR7dGhpcy51aWF1dG9tYXRvcn1gXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMuc2RiLmtpbGxQcm9jZXNzKHRoaXMudWlhdXRvbWF0b3IpO1xuICAgICAgYXdhaXQgc2xlZXAoMTAwMCk7XG4gICAgICBleGVjKHRoaXMuc2RiLmV4ZWN1dGFibGUucGF0aCwgWydzaGVsbCcsIGAvdXNyL2Jpbi8ke3RoaXMudWlhdXRvbWF0b3J9YF0pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHB1c2hVaUF1dG9tYXRvciAoKSB7XG4gICAgbGV0IGFyY2ggPSBhd2FpdCB0aGlzLnNkYi5zaGVsbChgdW5hbWUgLWFgKTtcbiAgICBsZXQgZmlsZSA9IHRoaXMudWlhdXRvbWF0b3I7XG5cbiAgICBpZiAoYXJjaC5pbmRleE9mKCdpNjg2JykgIT0gLTEpIHtcbiAgICAgICAgZmlsZSArPSAnX2k1ODYnO1xuICAgIH0gZWxzZSBpZiAoYXJjaC5pbmRleE9mKCd4ODZfNjQnKSAhPSAtMSkge1xuICAgICAgICBmaWxlICs9ICdfeDg2XzY0JztcbiAgICB9IGVsc2Uge1xuICAgICAgICBmaWxlICs9ICdfYXJtdjdsJztcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoJ1RhcmdldCBBcmNoaXRlY3R1cmUgOiAnICsgYXJjaCk7XG4gICAgYXdhaXQgdGhpcy5zZGIucHVzaChfX2Rpcm5hbWUgKyBgLy4uLyR7ZmlsZX1gLCBgL3Vzci9iaW4vJHt0aGlzLnVpYXV0b21hdG9yfWApO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlVWlBdXRvbWF0b3IgKCkge1xuICAgIGF3YWl0IHRoaXMuc2RiLnNoZWxsKCdybSAvdXNyL2Jpbi91aWF1dG9tYXRvcicpO1xuICB9XG5cbiAgc2V0IGlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biAoaWdub3JlKSB7XG4gICAgbG9nLmRlYnVnKGAke2lnbm9yZSA/ICdJZ25vcmluZycgOiAnV2F0Y2hpbmcgZm9yJ30gYm9vdHN0cmFwIGRpc2Nvbm5lY3RgKTtcbiAgICB0aGlzLl9pZ25vcmVVbmV4cGVjdGVkU2h1dGRvd24gPSBpZ25vcmU7XG4gIH1cblxuICBnZXQgaWdub3JlVW5leHBlY3RlZFNodXRkb3duICgpIHtcbiAgICByZXR1cm4gdGhpcy5faWdub3JlVW5leHBlY3RlZFNodXRkb3duO1xuICB9XG59XG5cbmV4cG9ydCB7IFRpemVuQm9vdHN0cmFwLCBDT01NQU5EX1RZUEVTIH07XG5leHBvcnQgZGVmYXVsdCBUaXplbkJvb3RzdHJhcDtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
