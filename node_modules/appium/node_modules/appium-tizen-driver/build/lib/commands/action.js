'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumSupport = require('appium-support');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _jimp = require('jimp');

var _jimp2 = _interopRequireDefault(_jimp);

var swipeStepsPerSec = 28;

var commands = {},
    extensions = {};

commands.pressKeyCode = function callee$0$0(keycode) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.bootstrap.sendAction("pressKeyCode", { keycode: keycode }));

      case 2:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.keys = function callee$0$0(keys) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        keys = _lodash2['default'].isArray(keys) ? keys.join('') : keys;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.inputText(keys));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.flick = function callee$0$0(element, xSpeed, ySpeed, xOffset, yOffset, speed) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!element) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.fakeFlickElement(element, xOffset, yOffset, speed));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.fakeFlick(xSpeed, ySpeed));

      case 8:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.fakeFlick = function callee$0$0(xSpeed, ySpeed) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.bootstrap.sendInputAction('flick', [xSpeed, ySpeed]));

      case 2:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.fakeFlickElement = function callee$0$0(elementId, xoffset, yoffset, speed) {
  var steps, xStart, yStart, _location, xEnd, yEnd, params;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        steps = 1250.0 / speed + 1;
        xStart = 1;
        yStart = 1;

        if (elementId === this.sessionId) {
          elementId = null;
        }

        if (!elementId) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.getLocationValueByElementId(elementId));

      case 7:
        _location = context$1$0.sent;

        xStart = _location[0];
        yStart = _location[1];

      case 10:
        xEnd = xStart + xoffset;
        yEnd = yStart + yoffset;
        params = [xStart, yStart, xEnd, yEnd, steps];
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(this.doSwipe(params));

      case 15:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.swipe = function callee$0$0(startX, startY, endX, endY, duration) {
  var swipeOpts;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (startX === 'null') {
          startX = 1;
        }
        if (startY === 'null') {
          startY = 1;
        }
        swipeOpts = [startX, startY, endX, endY, Math.round(duration * swipeStepsPerSec)];
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.doSwipe(swipeOpts));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.doSwipe = function callee$0$0(swipeOpts) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.bootstrap.sendInputAction("swipe", swipeOpts));

      case 2:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pullFile = function callee$0$0(remotePath) {
  var rootDir, filePath, localFile, data, b64data;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        rootDir = _path2['default'].resolve(__dirname, '..', '..');
        filePath = _path2['default'].resolve(rootDir, 'file');
        localFile = filePath + '/appiumfile.tmp';
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.sdb.pull(remotePath, localFile));

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(localFile));

      case 7:
        data = context$1$0.sent;
        b64data = new Buffer(data).toString('base64');
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(localFile));

      case 11:
        if (!context$1$0.sent) {
          context$1$0.next = 14;
          break;
        }

        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(localFile));

      case 14:
        return context$1$0.abrupt('return', b64data);

      case 15:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

function takeScreenShot(sdb) {
  return _regeneratorRuntime.async(function takeScreenShot$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(sdb.takeScreenShot());

      case 2:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getScreenshotData(sdb) {
  var rootDir, filePath, localFile, pngDir, png;
  return _regeneratorRuntime.async(function getScreenshotData$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        rootDir = _path2['default'].resolve(__dirname, '..', '..');
        filePath = _path2['default'].resolve(rootDir, 'file');
        localFile = filePath + '/screenShot.tmp';
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(localFile));

      case 5:
        if (!context$1$0.sent) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(localFile));

      case 8:
        context$1$0.prev = 8;
        pngDir = '/tmp/';
        png = _path2['default'].posix.resolve(pngDir, 'dump_screen.png');
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(sdb.pull(png, localFile));

      case 13:
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(_jimp2['default'].read(localFile));

      case 15:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 16:
        context$1$0.prev = 16;
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(localFile));

      case 19:
        if (!context$1$0.sent) {
          context$1$0.next = 22;
          break;
        }

        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(localFile));

      case 22:
        return context$1$0.finish(16);

      case 23:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[8,, 16, 23]]);
}

commands.getScreenshot = function callee$0$0() {
  var result, image, getBuffer, imgBuffer;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(takeScreenShot(this.sdb));

      case 2:
        result = context$1$0.sent;

        if (!result) {
          context$1$0.next = 14;
          break;
        }

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(getScreenshotData(this.sdb));

      case 6:
        image = context$1$0.sent;
        getBuffer = _bluebird2['default'].promisify(image.getBuffer, { context: image });
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(getBuffer(_jimp2['default'].MIME_PNG));

      case 10:
        imgBuffer = context$1$0.sent;
        return context$1$0.abrupt('return', imgBuffer.toString('base64'));

      case 14:
        return context$1$0.abrupt('return', null);

      case 15:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands);
exports.commands = commands;
exports['default'] = extensions;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9hY3Rpb24uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OzZCQUFtQixnQkFBZ0I7O3NCQUNyQixRQUFROzs7O3dCQUNSLFVBQVU7Ozs7b0JBQ1AsTUFBTTs7OztvQkFDTixNQUFNOzs7O0FBRXZCLElBQU0sZ0JBQWdCLEdBQUcsRUFBRSxDQUFDOztBQUU1QixJQUFJLFFBQVEsR0FBRyxFQUFFO0lBQUUsVUFBVSxHQUFHLEVBQUUsQ0FBQzs7QUFFbkMsUUFBUSxDQUFDLFlBQVksR0FBRyxvQkFBZ0IsT0FBTzs7Ozs7eUNBQ2hDLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLGNBQWMsRUFBRSxFQUFFLE9BQU8sRUFBUCxPQUFPLEVBQUUsQ0FBQzs7Ozs7Ozs7OztDQUNwRSxDQUFDOztBQUVGLFFBQVEsQ0FBQyxJQUFJLEdBQUcsb0JBQWdCLElBQUk7Ozs7QUFDbEMsWUFBSSxHQUFHLG9CQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQzs7eUNBQ2pDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDOzs7Ozs7Ozs7O0NBQ2xDLENBQUM7O0FBRUYsUUFBUSxDQUFDLEtBQUssR0FBRyxvQkFBZ0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLOzs7O2FBQzNFLE9BQU87Ozs7Ozt5Q0FDSSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDOzs7Ozs7O3lDQUV2RCxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUM7Ozs7Ozs7Ozs7Q0FFOUMsQ0FBQzs7QUFFRixRQUFRLENBQUMsU0FBUyxHQUFHLG9CQUFnQixNQUFNLEVBQUUsTUFBTTs7Ozs7eUNBQ3BDLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQzs7Ozs7Ozs7OztDQUN2RSxDQUFDOztBQUVGLFFBQVEsQ0FBQyxnQkFBZ0IsR0FBRyxvQkFBZ0IsU0FBUyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSztNQUN4RSxLQUFLLEVBRUwsTUFBTSxFQUNOLE1BQU0sRUFNSixTQUFRLEVBS1YsSUFBSSxFQUNKLElBQUksRUFFSixNQUFNOzs7OztBQWpCTixhQUFLLEdBQUcsTUFBTSxHQUFHLEtBQUssR0FBRyxDQUFDO0FBRTFCLGNBQU0sR0FBRyxDQUFDO0FBQ1YsY0FBTSxHQUFHLENBQUM7O0FBRWQsWUFBSSxTQUFTLEtBQUssSUFBSSxDQUFDLFNBQVMsRUFBRTtBQUNoQyxtQkFBUyxHQUFHLElBQUksQ0FBQztTQUNsQjs7YUFDRyxTQUFTOzs7Ozs7eUNBQ1UsSUFBSSxDQUFDLDJCQUEyQixDQUFDLFNBQVMsQ0FBQzs7O0FBQTVELGlCQUFROztBQUNaLGNBQU0sR0FBRyxTQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDckIsY0FBTSxHQUFHLFNBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQzs7O0FBR25CLFlBQUksR0FBRyxNQUFNLEdBQUcsT0FBTztBQUN2QixZQUFJLEdBQUcsTUFBTSxHQUFHLE9BQU87QUFFdkIsY0FBTSxHQUFHLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQzs7eUNBRW5DLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDOzs7Ozs7Ozs7O0NBQ2xDLENBQUM7O0FBRUYsUUFBUSxDQUFDLEtBQUssR0FBRyxvQkFBZ0IsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFFBQVE7TUFPL0QsU0FBUzs7OztBQU5iLFlBQUksTUFBTSxLQUFLLE1BQU0sRUFBRTtBQUNyQixnQkFBTSxHQUFHLENBQUMsQ0FBQztTQUNaO0FBQ0QsWUFBSSxNQUFNLEtBQUssTUFBTSxFQUFFO0FBQ3JCLGdCQUFNLEdBQUcsQ0FBQyxDQUFDO1NBQ1o7QUFDRyxpQkFBUyxHQUFHLENBQ2QsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUMxQixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxnQkFBZ0IsQ0FBQyxDQUN4Qzs7eUNBRVksSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUM7Ozs7Ozs7Ozs7Q0FDckMsQ0FBQzs7QUFFRixRQUFRLENBQUMsT0FBTyxHQUFHLG9CQUFnQixTQUFTOzs7Ozt5Q0FDN0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQzs7Ozs7Ozs7OztDQUNoRSxDQUFDOztBQUVGLFFBQVEsQ0FBQyxRQUFRLEdBQUcsb0JBQWdCLFVBQVU7TUFDdEMsT0FBTyxFQUNQLFFBQVEsRUFDVixTQUFTLEVBRVQsSUFBSSxFQUNKLE9BQU87Ozs7QUFMTCxlQUFPLEdBQUcsa0JBQUssT0FBTyxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDO0FBQzdDLGdCQUFRLEdBQUcsa0JBQUssT0FBTyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUM7QUFDMUMsaUJBQVMsR0FBRyxRQUFRLEdBQUcsaUJBQWlCOzt5Q0FDdEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQzs7Ozt5Q0FDekIsa0JBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQzs7O0FBQW5DLFlBQUk7QUFDSixlQUFPLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQzs7eUNBQ3ZDLGtCQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUM7Ozs7Ozs7Ozt5Q0FDdEIsa0JBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQzs7OzRDQUVyQixPQUFPOzs7Ozs7O0NBQ2YsQ0FBQzs7QUFFRixTQUFlLGNBQWMsQ0FBRSxHQUFHOzs7Ozt5Q0FDbkIsR0FBRyxDQUFDLGNBQWMsRUFBRTs7Ozs7Ozs7OztDQUNsQzs7QUFFRCxTQUFlLGlCQUFpQixDQUFFLEdBQUc7TUFDN0IsT0FBTyxFQUNQLFFBQVEsRUFDVixTQUFTLEVBS0wsTUFBTSxFQUNOLEdBQUc7Ozs7QUFSTCxlQUFPLEdBQUcsa0JBQUssT0FBTyxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDO0FBQzdDLGdCQUFRLEdBQUcsa0JBQUssT0FBTyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUM7QUFDMUMsaUJBQVMsR0FBRyxRQUFRLEdBQUcsaUJBQWlCOzt5Q0FDbEMsa0JBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQzs7Ozs7Ozs7O3lDQUN0QixrQkFBRyxNQUFNLENBQUMsU0FBUyxDQUFDOzs7O0FBR3BCLGNBQU0sR0FBRyxPQUFPO0FBQ2hCLFdBQUcsR0FBRyxrQkFBSyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxpQkFBaUIsQ0FBQzs7eUNBQ25ELEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLFNBQVMsQ0FBQzs7Ozt5Q0FDakIsa0JBQUssSUFBSSxDQUFDLFNBQVMsQ0FBQzs7Ozs7Ozs7eUNBRXZCLGtCQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUM7Ozs7Ozs7Ozt5Q0FDdEIsa0JBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQzs7Ozs7Ozs7OztDQUcvQjs7QUFFRCxRQUFRLENBQUMsYUFBYSxHQUFHO01BQ25CLE1BQU0sRUFHSixLQUFLLEVBQ0gsU0FBUyxFQUNULFNBQVM7Ozs7O3lDQUxFLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDOzs7QUFBdkMsY0FBTTs7YUFFTixNQUFNOzs7Ozs7eUNBQ1UsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQzs7O0FBQXpDLGFBQUs7QUFDSCxpQkFBUyxHQUFHLHNCQUFFLFNBQVMsQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDOzt5Q0FDMUMsU0FBUyxDQUFDLGtCQUFLLFFBQVEsQ0FBQzs7O0FBQTFDLGlCQUFTOzRDQUNSLFNBQVMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDOzs7NENBRTVCLElBQUk7Ozs7Ozs7Q0FFZCxDQUFDOztBQUVGLGVBQWMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzNCLFFBQVEsR0FBUixRQUFRO3FCQUNGLFVBQVUiLCJmaWxlIjoibGliL2NvbW1hbmRzL2FjdGlvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGppbXAgZnJvbSAnamltcCc7XG5cbmNvbnN0IHN3aXBlU3RlcHNQZXJTZWMgPSAyODtcblxubGV0IGNvbW1hbmRzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29tbWFuZHMucHJlc3NLZXlDb2RlID0gYXN5bmMgZnVuY3Rpb24gKGtleWNvZGUpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuYm9vdHN0cmFwLnNlbmRBY3Rpb24oXCJwcmVzc0tleUNvZGVcIiwgeyBrZXljb2RlIH0pO1xufTtcblxuY29tbWFuZHMua2V5cyA9IGFzeW5jIGZ1bmN0aW9uIChrZXlzKSB7XG4gIGtleXMgPSBfLmlzQXJyYXkoa2V5cykgPyBrZXlzLmpvaW4oJycpIDoga2V5cztcbiAgcmV0dXJuIGF3YWl0IHRoaXMuaW5wdXRUZXh0KGtleXMpO1xufTtcblxuY29tbWFuZHMuZmxpY2sgPSBhc3luYyBmdW5jdGlvbiAoZWxlbWVudCwgeFNwZWVkLCB5U3BlZWQsIHhPZmZzZXQsIHlPZmZzZXQsIHNwZWVkKSB7XG4gIGlmIChlbGVtZW50KSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmFrZUZsaWNrRWxlbWVudChlbGVtZW50LCB4T2Zmc2V0LCB5T2Zmc2V0LCBzcGVlZCk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmFrZUZsaWNrKHhTcGVlZCwgeVNwZWVkKTtcbiAgfVxufTtcblxuY29tbWFuZHMuZmFrZUZsaWNrID0gYXN5bmMgZnVuY3Rpb24gKHhTcGVlZCwgeVNwZWVkKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLmJvb3RzdHJhcC5zZW5kSW5wdXRBY3Rpb24oJ2ZsaWNrJywgW3hTcGVlZCwgeVNwZWVkXSk7XG59O1xuXG5jb21tYW5kcy5mYWtlRmxpY2tFbGVtZW50ID0gYXN5bmMgZnVuY3Rpb24gKGVsZW1lbnRJZCwgeG9mZnNldCwgeW9mZnNldCwgc3BlZWQpIHtcbiAgbGV0IHN0ZXBzID0gMTI1MC4wIC8gc3BlZWQgKyAxO1xuXG4gIGxldCB4U3RhcnQgPSAxO1xuICBsZXQgeVN0YXJ0ID0gMTtcblxuICBpZiAoZWxlbWVudElkID09PSB0aGlzLnNlc3Npb25JZCkge1xuICAgIGVsZW1lbnRJZCA9IG51bGw7XG4gIH1cbiAgaWYgKGVsZW1lbnRJZCkge1xuICAgIGxldCBsb2NhdGlvbiA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb25WYWx1ZUJ5RWxlbWVudElkKGVsZW1lbnRJZCk7XG4gICAgeFN0YXJ0ID0gbG9jYXRpb25bMF07XG4gICAgeVN0YXJ0ID0gbG9jYXRpb25bMV07XG4gIH1cblxuICBsZXQgeEVuZCA9IHhTdGFydCArIHhvZmZzZXQ7XG4gIGxldCB5RW5kID0geVN0YXJ0ICsgeW9mZnNldDtcblxuICBsZXQgcGFyYW1zID0gW3hTdGFydCwgeVN0YXJ0LCB4RW5kLCB5RW5kLCBzdGVwc107XG5cbiAgcmV0dXJuIGF3YWl0IHRoaXMuZG9Td2lwZShwYXJhbXMpO1xufTtcblxuY29tbWFuZHMuc3dpcGUgPSBhc3luYyBmdW5jdGlvbiAoc3RhcnRYLCBzdGFydFksIGVuZFgsIGVuZFksIGR1cmF0aW9uKSB7XG4gIGlmIChzdGFydFggPT09ICdudWxsJykge1xuICAgIHN0YXJ0WCA9IDE7XG4gIH1cbiAgaWYgKHN0YXJ0WSA9PT0gJ251bGwnKSB7XG4gICAgc3RhcnRZID0gMTtcbiAgfVxuICBsZXQgc3dpcGVPcHRzID0gW1xuICAgIHN0YXJ0WCwgc3RhcnRZLCBlbmRYLCBlbmRZLFxuICAgIE1hdGgucm91bmQoZHVyYXRpb24gKiBzd2lwZVN0ZXBzUGVyU2VjKVxuICBdO1xuXG4gIHJldHVybiBhd2FpdCB0aGlzLmRvU3dpcGUoc3dpcGVPcHRzKTtcbn07XG5cbmNvbW1hbmRzLmRvU3dpcGUgPSBhc3luYyBmdW5jdGlvbiAoc3dpcGVPcHRzKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLmJvb3RzdHJhcC5zZW5kSW5wdXRBY3Rpb24oXCJzd2lwZVwiLCBzd2lwZU9wdHMpO1xufTtcblxuY29tbWFuZHMucHVsbEZpbGUgPSBhc3luYyBmdW5jdGlvbiAocmVtb3RlUGF0aCkge1xuICBjb25zdCByb290RGlyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJyk7XG4gIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKHJvb3REaXIsICdmaWxlJyk7XG4gIGxldCBsb2NhbEZpbGUgPSBmaWxlUGF0aCArICcvYXBwaXVtZmlsZS50bXAnO1xuICBhd2FpdCB0aGlzLnNkYi5wdWxsKHJlbW90ZVBhdGgsIGxvY2FsRmlsZSk7XG4gIGxldCBkYXRhID0gYXdhaXQgZnMucmVhZEZpbGUobG9jYWxGaWxlKTtcbiAgbGV0IGI2NGRhdGEgPSBuZXcgQnVmZmVyKGRhdGEpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhsb2NhbEZpbGUpKSB7XG4gICAgYXdhaXQgZnMudW5saW5rKGxvY2FsRmlsZSk7XG4gIH1cbiAgcmV0dXJuIGI2NGRhdGE7XG59O1xuXG5hc3luYyBmdW5jdGlvbiB0YWtlU2NyZWVuU2hvdCAoc2RiKSB7XG4gIHJldHVybiBhd2FpdCBzZGIudGFrZVNjcmVlblNob3QoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0U2NyZWVuc2hvdERhdGEgKHNkYikge1xuICBjb25zdCByb290RGlyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJyk7XG4gIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKHJvb3REaXIsICdmaWxlJyk7XG4gIGxldCBsb2NhbEZpbGUgPSBmaWxlUGF0aCArICcvc2NyZWVuU2hvdC50bXAnO1xuICBpZiAoYXdhaXQgZnMuZXhpc3RzKGxvY2FsRmlsZSkpIHtcbiAgICBhd2FpdCBmcy51bmxpbmsobG9jYWxGaWxlKTtcbiAgfVxuICB0cnkge1xuICAgIGNvbnN0IHBuZ0RpciA9ICcvdG1wLyc7XG4gICAgY29uc3QgcG5nID0gcGF0aC5wb3NpeC5yZXNvbHZlKHBuZ0RpciwgJ2R1bXBfc2NyZWVuLnBuZycpO1xuICAgIGF3YWl0IHNkYi5wdWxsKHBuZywgbG9jYWxGaWxlKTtcbiAgICByZXR1cm4gYXdhaXQgamltcC5yZWFkKGxvY2FsRmlsZSk7XG4gIH0gZmluYWxseSB7XG4gICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhsb2NhbEZpbGUpKSB7XG4gICAgICBhd2FpdCBmcy51bmxpbmsobG9jYWxGaWxlKTtcbiAgICB9XG4gIH1cbn1cblxuY29tbWFuZHMuZ2V0U2NyZWVuc2hvdCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IHJlc3VsdCA9IGF3YWl0IHRha2VTY3JlZW5TaG90KHRoaXMuc2RiKTtcblxuICBpZiAocmVzdWx0KSB7XG4gICAgbGV0IGltYWdlID0gYXdhaXQgZ2V0U2NyZWVuc2hvdERhdGEodGhpcy5zZGIpO1xuICAgIGNvbnN0IGdldEJ1ZmZlciA9IEIucHJvbWlzaWZ5KGltYWdlLmdldEJ1ZmZlciwgeyBjb250ZXh0OiBpbWFnZSB9KTtcbiAgICBjb25zdCBpbWdCdWZmZXIgPSBhd2FpdCBnZXRCdWZmZXIoamltcC5NSU1FX1BORyk7XG4gICAgcmV0dXJuIGltZ0J1ZmZlci50b1N0cmluZygnYmFzZTY0Jyk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn07XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMpO1xuZXhwb3J0IHsgY29tbWFuZHMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
