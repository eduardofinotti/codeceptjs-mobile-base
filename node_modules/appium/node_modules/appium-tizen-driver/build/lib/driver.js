'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _desiredCaps = require('./desired-caps');

var _desiredCaps2 = _interopRequireDefault(_desiredCaps);

var _commandsIndex = require('./commands/index');

var _commandsIndex2 = _interopRequireDefault(_commandsIndex);

var _tizenHelpers = require('./tizen-helpers');

var _tizenHelpers2 = _interopRequireDefault(_tizenHelpers);

var _tizenBootstrapJs = require('./tizen-bootstrap.js');

var _tizenBootstrapJs2 = _interopRequireDefault(_tizenBootstrapJs);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSdb = require('appium-sdb');

var _appiumSupport = require('appium-support');

var _asyncbox = require('asyncbox');

var _packageJson = require('../../package.json');

// eslint-disable-line import/no-unresolved

var BOOTSTRAP_PORT = 8888;
var NO_PROXY = [['POST', new RegExp('^/session/[^/]+/appium')], ['GET', new RegExp('^/session/[^/]+/appium')]];

var TizenDriver = (function (_BaseDriver) {
  _inherits(TizenDriver, _BaseDriver);

  function TizenDriver() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
    var shouldValidateCaps = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

    _classCallCheck(this, TizenDriver);

    _get(Object.getPrototypeOf(TizenDriver.prototype), 'constructor', this).call(this, opts, shouldValidateCaps);

    _logger2['default'].debug('TizenDriver version: ' + _packageJson.version);

    this.locatorStrategies = ['id', 'accessibility id', 'class name'];

    this.desiredCapConstraints = _desiredCaps2['default'];
    this.jwpProxyActive = false;
    this.jwpProxyAvoid = _lodash2['default'].clone(NO_PROXY);
    this.settings = new _appiumBaseDriver.DeviceSettings({ ignoreUnimportantViews: false });
    this.bootstrapPort = BOOTSTRAP_PORT;

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = _getIterator(_lodash2['default'].pairs(_commandsIndex2['default'])), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var _step$value = _slicedToArray(_step.value, 2);

        var cmd = _step$value[0];
        var fn = _step$value[1];

        TizenDriver.prototype[cmd] = fn;
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }
  }

  _createClass(TizenDriver, [{
    key: 'createSession',
    value: function createSession(caps) {
      var sessionId, _ref, _ref2, serverDetails, defaultOpts, _ref3, udid, emPort;

      return _regeneratorRuntime.async(function createSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            sessionId = undefined;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(TizenDriver.prototype), 'createSession', this).call(this, caps));

          case 4:
            _ref = context$2$0.sent;
            _ref2 = _slicedToArray(_ref, 1);
            sessionId = _ref2[0];
            serverDetails = { platform: 'LINUX',
              webStorageEnabled: false,
              takesScreenshot: false,
              javascriptEnabled: true,
              databaseEnabled: false,
              networkConnectionEnabled: false,
              locationContextEnabled: false,
              warnings: {},
              desired: this.caps };

            this.caps = _Object$assign(serverDetails, this.caps);

            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(_appiumSupport.tempDir.staticDir());

          case 11:
            context$2$0.t0 = context$2$0.sent;
            context$2$0.t1 = _appiumSdb.DEFAULT_SDB_PORT;
            defaultOpts = {
              tmpDir: context$2$0.t0,
              fullReset: false,
              sdbPort: context$2$0.t1,
              tizenInstallTimeout: 50000
            };

            _lodash2['default'].defaults(this.opts, defaultOpts);

            if (this.opts.noReset === true) {
              this.opts.fullReset = false;
            }
            if (this.opts.fullReset === true) {
              this.opts.noReset = false;
            }
            this.opts.fastReset = !this.opts.fullReset && !this.opts.noReset;
            this.opts.skipUninstall = this.opts.fastReset || this.opts.noReset;

            context$2$0.next = 21;
            return _regeneratorRuntime.awrap(_tizenHelpers2['default'].getDeviceInfoFromCaps(this.opts));

          case 21:
            _ref3 = context$2$0.sent;
            udid = _ref3.udid;
            emPort = _ref3.emPort;

            this.opts.udid = udid;
            this.opts.emPort = emPort;

            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(_tizenHelpers2['default'].createSDB(this.opts.udid, this.opts.emPort, this.opts.sdbPort, this.opts.suppressKillServer));

          case 28:
            this.sdb = context$2$0.sent;
            context$2$0.next = 31;
            return _regeneratorRuntime.awrap(this.startTizenSession(this.opts));

          case 31:
            return context$2$0.abrupt('return', [sessionId, this.caps]);

          case 34:
            context$2$0.prev = 34;
            context$2$0.t2 = context$2$0['catch'](0);
            context$2$0.prev = 36;
            context$2$0.next = 39;
            return _regeneratorRuntime.awrap(this.deleteSession());

          case 39:
            context$2$0.next = 43;
            break;

          case 41:
            context$2$0.prev = 41;
            context$2$0.t3 = context$2$0['catch'](36);

          case 43:
            throw context$2$0.t2;

          case 44:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 34], [36, 41]]);
    }
  }, {
    key: 'startTizenSession',
    value: function startTizenSession() {
      var isAppInstalled, isStartedApp;
      return _regeneratorRuntime.async(function startTizenSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.opts.reboot) {
              context$2$0.next = 9;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.sdb.root());

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.sdb.reboot());

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _asyncbox.sleep)(40000));

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.sdb.stopAutoSleep());

          case 9:
            if (!this.opts.app) {
              context$2$0.next = 12;
              break;
            }

            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.installApp(this.opts.app));

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.isAppInstalled(this.opts.appPackage));

          case 14:
            isAppInstalled = context$2$0.sent;

            if (!isAppInstalled) {
              _logger2['default'].errorAndThrow('Could not find to App in device.');
            }

            if (!this.opts.appPackage) {
              context$2$0.next = 25;
              break;
            }

            context$2$0.next = 19;
            return _regeneratorRuntime.awrap(this.isStartedApp());

          case 19:
            isStartedApp = context$2$0.sent;

            if (!isStartedApp) {
              context$2$0.next = 23;
              break;
            }

            context$2$0.next = 23;
            return _regeneratorRuntime.awrap(this.closeApp());

          case 23:
            context$2$0.next = 25;
            return _regeneratorRuntime.awrap(this.startApp({ timeout: 20000 }));

          case 25:

            this.bootstrap = new _tizenBootstrapJs2['default'](this.sdb, this.bootstrapPort, this.opts.websocket);
            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(this.bootstrap.start(this.opts.appPackage));

          case 28:
            context$2$0.next = 30;
            return _regeneratorRuntime.awrap(this.bootstrap.pushUiAutomator());

          case 30:
            if (!this.opts.ignoreUnimportantViews) {
              context$2$0.next = 33;
              break;
            }

            context$2$0.next = 33;
            return _regeneratorRuntime.awrap(this.settings.update({ ignoreUnimportantViews: this.opts.ignoreUnimportantViews }));

          case 33:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'checkPackagePresent',
    value: function checkPackagePresent() {
      return _regeneratorRuntime.async(function checkPackagePresent$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug("Checking whether package is present on the device");
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.sdb.shell(['app_launcher --list | grep ' + this.opts.appPackage]));

          case 3:
            if (context$2$0.sent) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].errorAndThrow('Could not find package ' + this.opts.appPackage + ' on the device');

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug("Shutting down Tizen driver");
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(TizenDriver.prototype), 'deleteSession', this).call(this));

          case 3:
            if (!this.bootstrap) {
              context$2$0.next = 18;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.sdb.forceStop(this.opts.appPackage));

          case 6:
            if (!(this.opts.fullReset && !this.opts.skipUninstall && !this.appOnDevice)) {
              context$2$0.next = 9;
              break;
            }

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.sdb.uninstall(this.opts.appPackage));

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.sdb.startAutoSleep());

          case 11:
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.bootstrap.removeUiAutomator());

          case 13:
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.bootstrap.shutdown());

          case 15:
            this.bootstrap = null;
            context$2$0.next = 19;
            break;

          case 18:
            _logger2['default'].debug("Called deleteSession but bootstrap wasn't active");

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'validateDesiredCaps',
    value: function validateDesiredCaps(caps) {
      var res = _get(Object.getPrototypeOf(TizenDriver.prototype), 'validateDesiredCaps', this).call(this, caps);
      if (!res) {
        return res;
      }

      if (!caps.appPackage) {
        var msg = 'The desired capabilities must include an appPackage';
        _logger2['default'].errorAndThrow(msg);
      }
    }
  }, {
    key: 'proxyActive',
    value: function proxyActive(sessionId) {
      _get(Object.getPrototypeOf(TizenDriver.prototype), 'proxyActive', this).call(this, sessionId);

      return this.jwpProxyActive;
    }
  }, {
    key: 'getProxyAvoidList',
    value: function getProxyAvoidList(sessionId) {
      _get(Object.getPrototypeOf(TizenDriver.prototype), 'getProxyAvoidList', this).call(this, sessionId);

      return this.jwpProxyAvoid;
    }
  }, {
    key: 'canProxy',
    value: function canProxy(sessionId) {
      _get(Object.getPrototypeOf(TizenDriver.prototype), 'canProxy', this).call(this, sessionId);

      return false;
    }
  }, {
    key: 'appOnDevice',
    get: function get() {
      return this.helpers.isPackageOrBundle(this.opts.appPackage);
    }
  }]);

  return TizenDriver;
})(_appiumBaseDriver.BaseDriver);

exports['default'] = TizenDriver;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,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RyxHQUFHLHFEQUFxRCxDQUFDO0FBQ2hFLDRCQUFJLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztPQUN4QjtLQUNGOzs7V0FFVyxxQkFBQyxTQUFTLEVBQUU7QUFDdEIsaUNBbEpFLFdBQVcsNkNBa0pLLFNBQVMsRUFBRTs7QUFFN0IsYUFBTyxJQUFJLENBQUMsY0FBYyxDQUFDO0tBQzVCOzs7V0FFaUIsMkJBQUMsU0FBUyxFQUFFO0FBQzVCLGlDQXhKRSxXQUFXLG1EQXdKVyxTQUFTLEVBQUU7O0FBRW5DLGFBQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztLQUMzQjs7O1dBRVEsa0JBQUMsU0FBUyxFQUFFO0FBQ25CLGlDQTlKRSxXQUFXLDBDQThKRSxTQUFTLEVBQUU7O0FBRTFCLGFBQU8sS0FBSyxDQUFDO0tBQ2Q7OztTQXRGZSxlQUFHO0FBQ2pCLGFBQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0tBQzdEOzs7U0E3RUcsV0FBVzs7O3FCQW9LRixXQUFXIiwiZmlsZSI6ImxpYi9kcml2ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCYXNlRHJpdmVyLCBEZXZpY2VTZXR0aW5ncyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgZGVzaXJlZENvbnN0cmFpbnRzIGZyb20gJy4vZGVzaXJlZC1jYXBzJztcbmltcG9ydCBjb21tYW5kcyBmcm9tICcuL2NvbW1hbmRzL2luZGV4JztcbmltcG9ydCBoZWxwZXJzIGZyb20gJy4vdGl6ZW4taGVscGVycyc7XG5pbXBvcnQgQm9vdHN0cmFwIGZyb20gJy4vdGl6ZW4tYm9vdHN0cmFwLmpzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IERFRkFVTFRfU0RCX1BPUlQgfSBmcm9tICdhcHBpdW0tc2RiJztcbmltcG9ydCB7IHRlbXBEaXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBzbGVlcCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IHZlcnNpb24gfSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGltcG9ydC9uby11bnJlc29sdmVkXG5cbmNvbnN0IEJPT1RTVFJBUF9QT1JUID0gODg4ODtcbmNvbnN0IE5PX1BST1hZID0gW1xuICBbJ1BPU1QnLCBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vW14vXSsvYXBwaXVtJyldLFxuICBbJ0dFVCcsIG5ldyBSZWdFeHAoJ14vc2Vzc2lvbi9bXi9dKy9hcHBpdW0nKV0sXG5dO1xuXG5jbGFzcyBUaXplbkRyaXZlciBleHRlbmRzIEJhc2VEcml2ZXIge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9LCBzaG91bGRWYWxpZGF0ZUNhcHMgPSB0cnVlKSB7XG4gICAgc3VwZXIob3B0cywgc2hvdWxkVmFsaWRhdGVDYXBzKTtcblxuICAgIGxvZy5kZWJ1ZyhgVGl6ZW5Ecml2ZXIgdmVyc2lvbjogJHt2ZXJzaW9ufWApO1xuXG4gICAgdGhpcy5sb2NhdG9yU3RyYXRlZ2llcyA9IFtcbiAgICAgICdpZCcsXG4gICAgICAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgICAnY2xhc3MgbmFtZSdcbiAgICBdO1xuXG4gICAgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMgPSBkZXNpcmVkQ29uc3RyYWludHM7XG4gICAgdGhpcy5qd3BQcm94eUFjdGl2ZSA9IGZhbHNlO1xuICAgIHRoaXMuandwUHJveHlBdm9pZCA9IF8uY2xvbmUoTk9fUFJPWFkpO1xuICAgIHRoaXMuc2V0dGluZ3MgPSBuZXcgRGV2aWNlU2V0dGluZ3Moe2lnbm9yZVVuaW1wb3J0YW50Vmlld3M6IGZhbHNlfSk7XG4gICAgdGhpcy5ib290c3RyYXBQb3J0ID0gQk9PVFNUUkFQX1BPUlQ7XG5cbiAgICBmb3IgKGxldCBbY21kLCBmbl0gb2YgXy5wYWlycyhjb21tYW5kcykpIHtcbiAgICAgIFRpemVuRHJpdmVyLnByb3RvdHlwZVtjbWRdID0gZm47XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY3JlYXRlU2Vzc2lvbiAoY2Fwcykge1xuICAgIHRyeSB7XG4gICAgICBsZXQgc2Vzc2lvbklkO1xuICAgICAgW3Nlc3Npb25JZF0gPSBhd2FpdCBzdXBlci5jcmVhdGVTZXNzaW9uKGNhcHMpO1xuXG4gICAgICBsZXQgc2VydmVyRGV0YWlscyA9IHtwbGF0Zm9ybTogJ0xJTlVYJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHdlYlN0b3JhZ2VFbmFibGVkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHRha2VzU2NyZWVuc2hvdDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBqYXZhc2NyaXB0RW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFiYXNlRW5hYmxlZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBuZXR3b3JrQ29ubmVjdGlvbkVuYWJsZWQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYXRpb25Db250ZXh0RW5hYmxlZDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB3YXJuaW5nczoge30sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNpcmVkOiB0aGlzLmNhcHN9O1xuICAgICAgdGhpcy5jYXBzID0gT2JqZWN0LmFzc2lnbihzZXJ2ZXJEZXRhaWxzLCB0aGlzLmNhcHMpO1xuXG4gICAgICBsZXQgZGVmYXVsdE9wdHMgPSB7XG4gICAgICAgIHRtcERpcjogYXdhaXQgdGVtcERpci5zdGF0aWNEaXIoKSxcbiAgICAgICAgZnVsbFJlc2V0OiBmYWxzZSxcbiAgICAgICAgc2RiUG9ydDogREVGQVVMVF9TREJfUE9SVCxcbiAgICAgICAgdGl6ZW5JbnN0YWxsVGltZW91dDogNTAwMDBcbiAgICAgIH07XG4gICAgICBfLmRlZmF1bHRzKHRoaXMub3B0cywgZGVmYXVsdE9wdHMpO1xuXG4gICAgICBpZiAodGhpcy5vcHRzLm5vUmVzZXQgPT09IHRydWUpIHtcbiAgICAgICAgdGhpcy5vcHRzLmZ1bGxSZXNldCA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMub3B0cy5mdWxsUmVzZXQgPT09IHRydWUpIHtcbiAgICAgICAgdGhpcy5vcHRzLm5vUmVzZXQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHRoaXMub3B0cy5mYXN0UmVzZXQgPSAhdGhpcy5vcHRzLmZ1bGxSZXNldCAmJiAhdGhpcy5vcHRzLm5vUmVzZXQ7XG4gICAgICB0aGlzLm9wdHMuc2tpcFVuaW5zdGFsbCA9IHRoaXMub3B0cy5mYXN0UmVzZXQgfHwgdGhpcy5vcHRzLm5vUmVzZXQ7XG5cbiAgICAgIGxldCB7dWRpZCwgZW1Qb3J0fSA9IGF3YWl0IGhlbHBlcnMuZ2V0RGV2aWNlSW5mb0Zyb21DYXBzKHRoaXMub3B0cyk7XG4gICAgICB0aGlzLm9wdHMudWRpZCA9IHVkaWQ7XG4gICAgICB0aGlzLm9wdHMuZW1Qb3J0ID0gZW1Qb3J0O1xuXG4gICAgICB0aGlzLnNkYiA9IGF3YWl0IGhlbHBlcnMuY3JlYXRlU0RCKHRoaXMub3B0cy51ZGlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdHMuZW1Qb3J0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdHMuc2RiUG9ydCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRzLnN1cHByZXNzS2lsbFNlcnZlcik7XG5cbiAgICAgIGF3YWl0IHRoaXMuc3RhcnRUaXplblNlc3Npb24odGhpcy5vcHRzKTtcbiAgICAgIHJldHVybiBbc2Vzc2lvbklkLCB0aGlzLmNhcHNdO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbigpO1xuICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cblxuICBnZXQgYXBwT25EZXZpY2UgKCkge1xuICAgIHJldHVybiB0aGlzLmhlbHBlcnMuaXNQYWNrYWdlT3JCdW5kbGUodGhpcy5vcHRzLmFwcFBhY2thZ2UpO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRUaXplblNlc3Npb24gKCkge1xuICAgIGlmICh0aGlzLm9wdHMucmVib290KSB7XG4gICAgICBhd2FpdCB0aGlzLnNkYi5yb290KCk7XG4gICAgICBhd2FpdCB0aGlzLnNkYi5yZWJvb3QoKTtcbiAgICAgIGF3YWl0IHNsZWVwKDQwMDAwKTtcblxuICAgICAgYXdhaXQgdGhpcy5zZGIuc3RvcEF1dG9TbGVlcCgpO1xuICAgIH1cbiAgICBpZiAodGhpcy5vcHRzLmFwcCkge1xuICAgICAgYXdhaXQgdGhpcy5pbnN0YWxsQXBwKHRoaXMub3B0cy5hcHApO1xuICAgIH1cbiAgICBsZXQgaXNBcHBJbnN0YWxsZWQgPSBhd2FpdCB0aGlzLmlzQXBwSW5zdGFsbGVkKHRoaXMub3B0cy5hcHBQYWNrYWdlKTtcbiAgICBpZiAoIWlzQXBwSW5zdGFsbGVkKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdygnQ291bGQgbm90IGZpbmQgdG8gQXBwIGluIGRldmljZS4nKTtcbiAgICB9XG4gICAgaWYgKHRoaXMub3B0cy5hcHBQYWNrYWdlKSB7XG4gICAgICBsZXQgaXNTdGFydGVkQXBwID0gYXdhaXQgdGhpcy5pc1N0YXJ0ZWRBcHAoKTtcbiAgICAgIGlmIChpc1N0YXJ0ZWRBcHApIHtcbiAgICAgICAgYXdhaXQgdGhpcy5jbG9zZUFwcCgpO1xuICAgICAgfVxuICAgICAgYXdhaXQgdGhpcy5zdGFydEFwcCh7IHRpbWVvdXQ6IDIwMDAwIH0pO1xuICAgIH1cblxuICAgIHRoaXMuYm9vdHN0cmFwID0gbmV3IEJvb3RzdHJhcCh0aGlzLnNkYiwgdGhpcy5ib290c3RyYXBQb3J0LCB0aGlzLm9wdHMud2Vic29ja2V0KTtcbiAgICBhd2FpdCB0aGlzLmJvb3RzdHJhcC5zdGFydCh0aGlzLm9wdHMuYXBwUGFja2FnZSk7XG4gICAgYXdhaXQgdGhpcy5ib290c3RyYXAucHVzaFVpQXV0b21hdG9yKCk7XG5cbiAgICBpZiAodGhpcy5vcHRzLmlnbm9yZVVuaW1wb3J0YW50Vmlld3MpIHtcbiAgICAgIGF3YWl0IHRoaXMuc2V0dGluZ3MudXBkYXRlKHtpZ25vcmVVbmltcG9ydGFudFZpZXdzOiB0aGlzLm9wdHMuaWdub3JlVW5pbXBvcnRhbnRWaWV3c30pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNoZWNrUGFja2FnZVByZXNlbnQgKCkge1xuICAgIGxvZy5kZWJ1ZyhcIkNoZWNraW5nIHdoZXRoZXIgcGFja2FnZSBpcyBwcmVzZW50IG9uIHRoZSBkZXZpY2VcIik7XG4gICAgaWYgKCEoYXdhaXQgdGhpcy5zZGIuc2hlbGwoW2BhcHBfbGF1bmNoZXIgLS1saXN0IHwgZ3JlcCAke3RoaXMub3B0cy5hcHBQYWNrYWdlfWBdKSkpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgZmluZCBwYWNrYWdlICR7dGhpcy5vcHRzLmFwcFBhY2thZ2V9IG9uIHRoZSBkZXZpY2VgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uICgpIHtcbiAgICBsb2cuZGVidWcoXCJTaHV0dGluZyBkb3duIFRpemVuIGRyaXZlclwiKTtcbiAgICBhd2FpdCBzdXBlci5kZWxldGVTZXNzaW9uKCk7XG4gICAgaWYgKHRoaXMuYm9vdHN0cmFwKSB7XG4gICAgICBhd2FpdCB0aGlzLnNkYi5mb3JjZVN0b3AodGhpcy5vcHRzLmFwcFBhY2thZ2UpO1xuICAgICAgaWYgKHRoaXMub3B0cy5mdWxsUmVzZXQgJiYgIXRoaXMub3B0cy5za2lwVW5pbnN0YWxsICYmICF0aGlzLmFwcE9uRGV2aWNlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuc2RiLnVuaW5zdGFsbCh0aGlzLm9wdHMuYXBwUGFja2FnZSk7XG4gICAgICB9XG4gICAgICBhd2FpdCB0aGlzLnNkYi5zdGFydEF1dG9TbGVlcCgpO1xuICAgICAgYXdhaXQgdGhpcy5ib290c3RyYXAucmVtb3ZlVWlBdXRvbWF0b3IoKTtcbiAgICAgIGF3YWl0IHRoaXMuYm9vdHN0cmFwLnNodXRkb3duKCk7XG4gICAgICB0aGlzLmJvb3RzdHJhcCA9IG51bGw7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZyhcIkNhbGxlZCBkZWxldGVTZXNzaW9uIGJ1dCBib290c3RyYXAgd2Fzbid0IGFjdGl2ZVwiKTtcbiAgICB9XG4gIH1cblxuICB2YWxpZGF0ZURlc2lyZWRDYXBzIChjYXBzKSB7XG4gICAgbGV0IHJlcyA9IHN1cGVyLnZhbGlkYXRlRGVzaXJlZENhcHMoY2Fwcyk7XG4gICAgaWYgKCFyZXMpIHsgcmV0dXJuIHJlczsgfVxuXG4gICAgaWYgKCFjYXBzLmFwcFBhY2thZ2UpIHtcbiAgICAgIGxldCBtc2cgPSAnVGhlIGRlc2lyZWQgY2FwYWJpbGl0aWVzIG11c3QgaW5jbHVkZSBhbiBhcHBQYWNrYWdlJztcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KG1zZyk7XG4gICAgfVxuICB9XG5cbiAgcHJveHlBY3RpdmUgKHNlc3Npb25JZCkge1xuICAgIHN1cGVyLnByb3h5QWN0aXZlKHNlc3Npb25JZCk7XG5cbiAgICByZXR1cm4gdGhpcy5qd3BQcm94eUFjdGl2ZTtcbiAgfVxuXG4gIGdldFByb3h5QXZvaWRMaXN0IChzZXNzaW9uSWQpIHtcbiAgICBzdXBlci5nZXRQcm94eUF2b2lkTGlzdChzZXNzaW9uSWQpO1xuXG4gICAgcmV0dXJuIHRoaXMuandwUHJveHlBdm9pZDtcbiAgfVxuXG4gIGNhblByb3h5IChzZXNzaW9uSWQpIHtcbiAgICBzdXBlci5jYW5Qcm94eShzZXNzaW9uSWQpO1xuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFRpemVuRHJpdmVyO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
