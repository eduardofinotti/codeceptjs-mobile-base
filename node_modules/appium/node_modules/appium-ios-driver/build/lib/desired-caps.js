'use strict';

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var desiredCapConstraints = {
  platformName: {
    presence: true,
    isString: true,
    inclusionCaseInsensitive: ['iOS']
  },
  browserName: {
    isString: true
  },
  app: {
    isString: true
  },

  launchTimeout: {
    // recognize the cap,
    // but validate in the driver#validateDesiredCaps method
  },
  calendarFormat: {
    isString: true
  },
  bundleId: {
    isString: true
  },
  udid: {
    isString: true
  },
  locationServicesEnabled: {
    isBoolean: true
  },
  locationServicesAuthorized: {
    isBoolean: true
  },
  autoAcceptAlerts: {
    isBoolean: true
  },
  autoDismissAlerts: {
    isBoolean: true
  },
  nativeInstrumentsLib: {
    isBoolean: true
  },
  nativeWebTap: {
    isBoolean: true
  },
  safariInitialUrl: {
    isString: true
  },
  safariAllowPopups: {
    isBoolean: true
  },
  safariIgnoreFraudWarning: {
    isBoolean: true
  },
  safariOpenLinksInBackground: {
    isBoolean: true
  },
  safariGarbageCollect: {
    isBoolean: true
  },
  keepKeyChains: {
    isBoolean: true
  },
  localizableStringsDir: {
    isString: true
  },
  processArguments: {
    // recognize the cap,
    // but validate in the driver#validateDesiredCaps method
  },
  interKeyDelay: {
    isNumber: true
  },
  showIOSLog: {
    isBoolean: true
  },
  sendKeyStrategy: {
    isString: true,
    inclusion: ['oneByOne', 'grouped', 'setValue']
  },
  screenshotWaitTimeout: {
    isNumber: true
  },
  waitForAppScript: {
    isString: true
  },
  webviewConnectRetries: {
    isNumber: true
  },
  appName: {
    isString: true
  },
  clearSystemFiles: {
    isBoolean: true
  },
  customSSLCert: {
    isString: true
  },
  webkitResponseTimeout: {
    isNumber: true
  },
  remoteDebugProxy: {
    isString: true
  },
  enablePerformanceLogging: {
    isBoolean: true
  },
  enableAsyncExecuteFromHttps: {
    isBoolean: true
  },
  realDeviceLogger: {
    isString: true
  },
  fullContextList: {
    isBoolean: true
  },
  ignoreAboutBlankUrl: {
    isBoolean: true
  }
};

function desiredCapValidation(caps) {
  // make sure that the capabilities have one of `app` or `bundleId`
  if ((caps.browserName || '').toLowerCase() !== 'safari' && !caps.app && !caps.bundleId) {
    var msg = 'The desired capabilities must include either an app or a bundleId for iOS';
    _logger2['default'].errorAndThrow(msg);
  }

  // `launchTimeout` is more complex than the validators can easily handle
  // and too specific for a generalized validator of its own
  if (caps.launchTimeout) {
    // it can be a number, a JSON string, or an object
    var msg = 'launchTimeout must be a number, object, or string JSON object';
    if (!_lodash2['default'].isNumber(caps.launchTimeout)) {
      if (_lodash2['default'].isString(caps.launchTimeout)) {
        // if this is a string, it must be a JSON string
        try {
          // change `launchTimeout` to an object
          caps.launchTimeout = JSON.parse(caps.launchTimeout);
        } catch (err) {
          // it was a string, but not something parsable as JSON
          _logger2['default'].errorAndThrow(msg);
        }
      }
      if (!_lodash2['default'].isObject(caps.launchTimeout)) {
        _logger2['default'].errorAndThrow(msg);
      }
    }
  }

  // `processArguments` is more complex as it can be a string
  // or a hash
  if (caps.processArguments) {
    if (_lodash2['default'].isString(caps.processArguments)) {
      try {
        // try to parse the string as JSON
        caps.processArguments = JSON.parse(caps.processArguments);
      } catch (ign) {
        // if we cannot parse, just leave as a string
      }
    } else if (!_lodash2['default'].isObject(caps.processArguments)) {
        _logger2['default'].errorAndThrow('processArguments must be a string, object, or a string JSON object');
      }
  }

  // there is an undocumented legacy cap `loggingPrefs.performance` to enable
  // performance logging. Translate to `enablePerformanceLogging`
  if (typeof caps.enablePerformanceLogging !== 'boolean' && typeof caps.loggingPrefs === 'object' && caps.loggingPrefs.performance) {
    caps.enablePerformanceLogging = !!caps.loggingPrefs.performance;
  }

  // finally, return true since the superclass check passed, as did this
  return true;
}

exports.desiredCapConstraints = desiredCapConstraints;
exports.desiredCapValidation = desiredCapValidation;
exports['default'] = desiredCapConstraints;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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SSxDQUFDLGdCQUFnQixDQUFDLEVBQUU7QUFDN0MsNEJBQU8sYUFBYSxDQUFDLG9FQUFvRSxDQUFDLENBQUM7T0FDNUY7R0FDRjs7OztBQUlELE1BQUksT0FBTyxJQUFJLENBQUMsd0JBQXdCLEtBQUssU0FBUyxJQUNsRCxPQUFPLElBQUksQ0FBQyxZQUFZLEtBQUssUUFBUSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFO0FBQzFFLFFBQUksQ0FBQyx3QkFBd0IsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUM7R0FDakU7OztBQUdELFNBQU8sSUFBSSxDQUFDO0NBQ2I7O1FBRVEscUJBQXFCLEdBQXJCLHFCQUFxQjtRQUFFLG9CQUFvQixHQUFwQixvQkFBb0I7cUJBQ3JDLHFCQUFxQiIsImZpbGUiOiJsaWIvZGVzaXJlZC1jYXBzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuXG5cbmNvbnN0IGRlc2lyZWRDYXBDb25zdHJhaW50cyA9IHtcbiAgcGxhdGZvcm1OYW1lOiB7XG4gICAgcHJlc2VuY2U6IHRydWUsXG4gICAgaXNTdHJpbmc6IHRydWUsXG4gICAgaW5jbHVzaW9uQ2FzZUluc2Vuc2l0aXZlOiBbJ2lPUyddXG4gIH0sXG4gIGJyb3dzZXJOYW1lOiB7XG4gICAgaXNTdHJpbmc6IHRydWVcbiAgfSxcbiAgYXBwOiB7XG4gICAgaXNTdHJpbmc6IHRydWVcbiAgfSxcblxuICBsYXVuY2hUaW1lb3V0OiB7XG4gICAgLy8gcmVjb2duaXplIHRoZSBjYXAsXG4gICAgLy8gYnV0IHZhbGlkYXRlIGluIHRoZSBkcml2ZXIjdmFsaWRhdGVEZXNpcmVkQ2FwcyBtZXRob2RcbiAgfSxcbiAgY2FsZW5kYXJGb3JtYXQ6IHtcbiAgICBpc1N0cmluZzogdHJ1ZVxuICB9LFxuICBidW5kbGVJZDoge1xuICAgIGlzU3RyaW5nOiB0cnVlXG4gIH0sXG4gIHVkaWQ6IHtcbiAgICBpc1N0cmluZzogdHJ1ZVxuICB9LFxuICBsb2NhdGlvblNlcnZpY2VzRW5hYmxlZDoge1xuICAgIGlzQm9vbGVhbjogdHJ1ZVxuICB9LFxuICBsb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZDoge1xuICAgIGlzQm9vbGVhbjogdHJ1ZVxuICB9LFxuICBhdXRvQWNjZXB0QWxlcnRzOiB7XG4gICAgaXNCb29sZWFuOiB0cnVlXG4gIH0sXG4gIGF1dG9EaXNtaXNzQWxlcnRzOiB7XG4gICAgaXNCb29sZWFuOiB0cnVlXG4gIH0sXG4gIG5hdGl2ZUluc3RydW1lbnRzTGliOiB7XG4gICAgaXNCb29sZWFuOiB0cnVlXG4gIH0sXG4gIG5hdGl2ZVdlYlRhcDoge1xuICAgIGlzQm9vbGVhbjogdHJ1ZVxuICB9LFxuICBzYWZhcmlJbml0aWFsVXJsOiB7XG4gICAgaXNTdHJpbmc6IHRydWVcbiAgfSxcbiAgc2FmYXJpQWxsb3dQb3B1cHM6IHtcbiAgICBpc0Jvb2xlYW46IHRydWVcbiAgfSxcbiAgc2FmYXJpSWdub3JlRnJhdWRXYXJuaW5nOiB7XG4gICAgaXNCb29sZWFuOiB0cnVlXG4gIH0sXG4gIHNhZmFyaU9wZW5MaW5rc0luQmFja2dyb3VuZDoge1xuICAgIGlzQm9vbGVhbjogdHJ1ZVxuICB9LFxuICBzYWZhcmlHYXJiYWdlQ29sbGVjdDoge1xuICAgIGlzQm9vbGVhbjogdHJ1ZVxuICB9LFxuICBrZWVwS2V5Q2hhaW5zOiB7XG4gICAgaXNCb29sZWFuOiB0cnVlXG4gIH0sXG4gIGxvY2FsaXphYmxlU3RyaW5nc0Rpcjoge1xuICAgIGlzU3RyaW5nOiB0cnVlXG4gIH0sXG4gIHByb2Nlc3NBcmd1bWVudHM6IHtcbiAgICAvLyByZWNvZ25pemUgdGhlIGNhcCxcbiAgICAvLyBidXQgdmFsaWRhdGUgaW4gdGhlIGRyaXZlciN2YWxpZGF0ZURlc2lyZWRDYXBzIG1ldGhvZFxuICB9LFxuICBpbnRlcktleURlbGF5OiB7XG4gICAgaXNOdW1iZXI6IHRydWVcbiAgfSxcbiAgc2hvd0lPU0xvZzoge1xuICAgIGlzQm9vbGVhbjogdHJ1ZVxuICB9LFxuICBzZW5kS2V5U3RyYXRlZ3k6IHtcbiAgICBpc1N0cmluZzogdHJ1ZSxcbiAgICBpbmNsdXNpb246IFsnb25lQnlPbmUnLCAnZ3JvdXBlZCcsICdzZXRWYWx1ZSddXG4gIH0sXG4gIHNjcmVlbnNob3RXYWl0VGltZW91dDoge1xuICAgIGlzTnVtYmVyOiB0cnVlXG4gIH0sXG4gIHdhaXRGb3JBcHBTY3JpcHQ6IHtcbiAgICBpc1N0cmluZzogdHJ1ZVxuICB9LFxuICB3ZWJ2aWV3Q29ubmVjdFJldHJpZXM6IHtcbiAgICBpc051bWJlcjogdHJ1ZVxuICB9LFxuICBhcHBOYW1lOiB7XG4gICAgaXNTdHJpbmc6IHRydWVcbiAgfSxcbiAgY2xlYXJTeXN0ZW1GaWxlczoge1xuICAgIGlzQm9vbGVhbjogdHJ1ZVxuICB9LFxuICBjdXN0b21TU0xDZXJ0OiB7XG4gICAgaXNTdHJpbmc6IHRydWVcbiAgfSxcbiAgd2Via2l0UmVzcG9uc2VUaW1lb3V0OiB7XG4gICAgaXNOdW1iZXI6IHRydWVcbiAgfSxcbiAgcmVtb3RlRGVidWdQcm94eToge1xuICAgIGlzU3RyaW5nOiB0cnVlXG4gIH0sXG4gIGVuYWJsZVBlcmZvcm1hbmNlTG9nZ2luZzoge1xuICAgIGlzQm9vbGVhbjogdHJ1ZVxuICB9LFxuICBlbmFibGVBc3luY0V4ZWN1dGVGcm9tSHR0cHM6IHtcbiAgICBpc0Jvb2xlYW46IHRydWVcbiAgfSxcbiAgcmVhbERldmljZUxvZ2dlcjoge1xuICAgIGlzU3RyaW5nOiB0cnVlXG4gIH0sXG4gIGZ1bGxDb250ZXh0TGlzdDoge1xuICAgIGlzQm9vbGVhbjogdHJ1ZVxuICB9LFxuICBpZ25vcmVBYm91dEJsYW5rVXJsOiB7XG4gICAgaXNCb29sZWFuOiB0cnVlXG4gIH0sXG59O1xuXG5mdW5jdGlvbiBkZXNpcmVkQ2FwVmFsaWRhdGlvbiAoY2Fwcykge1xuICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgY2FwYWJpbGl0aWVzIGhhdmUgb25lIG9mIGBhcHBgIG9yIGBidW5kbGVJZGBcbiAgaWYgKChjYXBzLmJyb3dzZXJOYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpICE9PSAnc2FmYXJpJyAmJlxuICAgICAgIWNhcHMuYXBwICYmICFjYXBzLmJ1bmRsZUlkKSB7XG4gICAgbGV0IG1zZyA9ICdUaGUgZGVzaXJlZCBjYXBhYmlsaXRpZXMgbXVzdCBpbmNsdWRlIGVpdGhlciBhbiBhcHAgb3IgYSBidW5kbGVJZCBmb3IgaU9TJztcbiAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICB9XG5cbiAgLy8gYGxhdW5jaFRpbWVvdXRgIGlzIG1vcmUgY29tcGxleCB0aGFuIHRoZSB2YWxpZGF0b3JzIGNhbiBlYXNpbHkgaGFuZGxlXG4gIC8vIGFuZCB0b28gc3BlY2lmaWMgZm9yIGEgZ2VuZXJhbGl6ZWQgdmFsaWRhdG9yIG9mIGl0cyBvd25cbiAgaWYgKGNhcHMubGF1bmNoVGltZW91dCkge1xuICAgIC8vIGl0IGNhbiBiZSBhIG51bWJlciwgYSBKU09OIHN0cmluZywgb3IgYW4gb2JqZWN0XG4gICAgbGV0IG1zZyA9ICdsYXVuY2hUaW1lb3V0IG11c3QgYmUgYSBudW1iZXIsIG9iamVjdCwgb3Igc3RyaW5nIEpTT04gb2JqZWN0JztcbiAgICBpZiAoIV8uaXNOdW1iZXIoY2Fwcy5sYXVuY2hUaW1lb3V0KSkge1xuICAgICAgaWYgKF8uaXNTdHJpbmcoY2Fwcy5sYXVuY2hUaW1lb3V0KSkge1xuICAgICAgICAvLyBpZiB0aGlzIGlzIGEgc3RyaW5nLCBpdCBtdXN0IGJlIGEgSlNPTiBzdHJpbmdcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAvLyBjaGFuZ2UgYGxhdW5jaFRpbWVvdXRgIHRvIGFuIG9iamVjdFxuICAgICAgICAgIGNhcHMubGF1bmNoVGltZW91dCA9IEpTT04ucGFyc2UoY2Fwcy5sYXVuY2hUaW1lb3V0KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgLy8gaXQgd2FzIGEgc3RyaW5nLCBidXQgbm90IHNvbWV0aGluZyBwYXJzYWJsZSBhcyBKU09OXG4gICAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCFfLmlzT2JqZWN0KGNhcHMubGF1bmNoVGltZW91dCkpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBgcHJvY2Vzc0FyZ3VtZW50c2AgaXMgbW9yZSBjb21wbGV4IGFzIGl0IGNhbiBiZSBhIHN0cmluZ1xuICAvLyBvciBhIGhhc2hcbiAgaWYgKGNhcHMucHJvY2Vzc0FyZ3VtZW50cykge1xuICAgIGlmIChfLmlzU3RyaW5nKGNhcHMucHJvY2Vzc0FyZ3VtZW50cykpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIHRyeSB0byBwYXJzZSB0aGUgc3RyaW5nIGFzIEpTT05cbiAgICAgICAgY2Fwcy5wcm9jZXNzQXJndW1lbnRzID0gSlNPTi5wYXJzZShjYXBzLnByb2Nlc3NBcmd1bWVudHMpO1xuICAgICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAgIC8vIGlmIHdlIGNhbm5vdCBwYXJzZSwganVzdCBsZWF2ZSBhcyBhIHN0cmluZ1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoIV8uaXNPYmplY3QoY2Fwcy5wcm9jZXNzQXJndW1lbnRzKSkge1xuICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coJ3Byb2Nlc3NBcmd1bWVudHMgbXVzdCBiZSBhIHN0cmluZywgb2JqZWN0LCBvciBhIHN0cmluZyBKU09OIG9iamVjdCcpO1xuICAgIH1cbiAgfVxuXG4gIC8vIHRoZXJlIGlzIGFuIHVuZG9jdW1lbnRlZCBsZWdhY3kgY2FwIGBsb2dnaW5nUHJlZnMucGVyZm9ybWFuY2VgIHRvIGVuYWJsZVxuICAvLyBwZXJmb3JtYW5jZSBsb2dnaW5nLiBUcmFuc2xhdGUgdG8gYGVuYWJsZVBlcmZvcm1hbmNlTG9nZ2luZ2BcbiAgaWYgKHR5cGVvZiBjYXBzLmVuYWJsZVBlcmZvcm1hbmNlTG9nZ2luZyAhPT0gJ2Jvb2xlYW4nICYmXG4gICAgICB0eXBlb2YgY2Fwcy5sb2dnaW5nUHJlZnMgPT09ICdvYmplY3QnICYmIGNhcHMubG9nZ2luZ1ByZWZzLnBlcmZvcm1hbmNlKSB7XG4gICAgY2Fwcy5lbmFibGVQZXJmb3JtYW5jZUxvZ2dpbmcgPSAhIWNhcHMubG9nZ2luZ1ByZWZzLnBlcmZvcm1hbmNlO1xuICB9XG5cbiAgLy8gZmluYWxseSwgcmV0dXJuIHRydWUgc2luY2UgdGhlIHN1cGVyY2xhc3MgY2hlY2sgcGFzc2VkLCBhcyBkaWQgdGhpc1xuICByZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IHsgZGVzaXJlZENhcENvbnN0cmFpbnRzLCBkZXNpcmVkQ2FwVmFsaWRhdGlvbiB9O1xuZXhwb3J0IGRlZmF1bHQgZGVzaXJlZENhcENvbnN0cmFpbnRzO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
