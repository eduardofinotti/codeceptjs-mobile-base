'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _toConsumableArray = require('babel-runtime/helpers/to-consumable-array')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _config = require('./config');

var _appiumBaseDriver = require('appium-base-driver');

var _appiumFakeDriver = require('appium-fake-driver');

var _appiumAndroidDriver = require('appium-android-driver');

var _appiumIosDriver = require('appium-ios-driver');

var _appiumUiautomator2Driver = require('appium-uiautomator2-driver');

var _appiumSelendroidDriver = require('appium-selendroid-driver');

var _appiumXcuitestDriver = require('appium-xcuitest-driver');

var _appiumYouiengineDriver = require('appium-youiengine-driver');

var _appiumWindowsDriver = require('appium-windows-driver');

var _appiumMacDriver = require('appium-mac-driver');

var _appiumEspressoDriver = require('appium-espresso-driver');

var _appiumTizenDriver = require('appium-tizen-driver');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _asyncLock = require('async-lock');

var _asyncLock2 = _interopRequireDefault(_asyncLock);

var _utils = require('./utils');

var _semver = require('semver');

var _semver2 = _interopRequireDefault(_semver);

var AUTOMATION_NAMES = {
  APPIUM: 'Appium',
  SELENDROID: 'Selendroid',
  UIAUTOMATOR2: 'UiAutomator2',
  XCUITEST: 'XCUITest',
  YOUIENGINE: 'YouiEngine',
  ESPRESSO: 'Espresso',
  TIZEN: 'Tizen',
  FAKE: 'Fake'
};
var DRIVER_MAP = {
  SelendroidDriver: {
    driverClass: _appiumSelendroidDriver.SelendroidDriver,
    automationName: AUTOMATION_NAMES.SELENDROID,
    version: (0, _utils.getPackageVersion)('appium-selendroid-driver')
  },
  AndroidUiautomator2Driver: {
    driverClass: _appiumUiautomator2Driver.AndroidUiautomator2Driver,
    automationName: AUTOMATION_NAMES.UIAUTOMATOR2,
    version: (0, _utils.getPackageVersion)('appium-uiautomator2-driver')
  },
  XCUITestDriver: {
    driverClass: _appiumXcuitestDriver.XCUITestDriver,
    automationName: AUTOMATION_NAMES.XCUITEST,
    version: (0, _utils.getPackageVersion)('appium-xcuitest-driver')
  },
  YouiEngineDriver: {
    driverClass: _appiumYouiengineDriver.YouiEngineDriver,
    automationName: AUTOMATION_NAMES.YOUIENGINE,
    version: (0, _utils.getPackageVersion)('appium-youiengine-driver')
  },
  FakeDriver: {
    driverClass: _appiumFakeDriver.FakeDriver,
    version: (0, _utils.getPackageVersion)('appium-fake-driver')
  },
  AndroidDriver: {
    driverClass: _appiumAndroidDriver.AndroidDriver,
    version: (0, _utils.getPackageVersion)('appium-android-driver')
  },
  IosDriver: {
    driverClass: _appiumIosDriver.IosDriver,
    version: (0, _utils.getPackageVersion)('appium-ios-driver')
  },
  WindowsDriver: {
    driverClass: _appiumWindowsDriver.WindowsDriver,
    version: (0, _utils.getPackageVersion)('appium-windows-driver')
  },
  MacDriver: {
    driverClass: _appiumMacDriver.MacDriver,
    version: (0, _utils.getPackageVersion)('appium-mac-driver')
  },
  EspressoDriver: {
    driverClass: _appiumEspressoDriver.EspressoDriver,
    automationName: AUTOMATION_NAMES.ESPRESSO,
    version: (0, _utils.getPackageVersion)('appium-espresso-driver')
  },
  TizenDriver: {
    driverClass: _appiumTizenDriver.TizenDriver,
    automationName: AUTOMATION_NAMES.TIZEN,
    version: (0, _utils.getPackageVersion)('appium-tizen-driver')
  }
};

var PLATFORMS_MAP = {
  fake: function fake() {
    return _appiumFakeDriver.FakeDriver;
  },
  android: function android(caps) {
    var platformVersion = _semver2['default'].valid(_semver2['default'].coerce(caps.platformVersion));
    if (platformVersion && _semver2['default'].satisfies(platformVersion, '>=6.0.0')) {
      _logger2['default'].warn("Consider setting 'automationName' capability to " + ('\'' + AUTOMATION_NAMES.UIAUTOMATOR2 + '\' ') + "on Android >= 6, since UIAutomator framework " + "is not maintained anymore by the OS vendor.");
    }

    return _appiumAndroidDriver.AndroidDriver;
  },
  ios: function ios(caps) {
    var platformVersion = _semver2['default'].valid(_semver2['default'].coerce(caps.platformVersion));
    if (platformVersion && _semver2['default'].satisfies(platformVersion, '>=10.0.0')) {
      _logger2['default'].info("Requested iOS support with version >= 10, " + ('using \'' + AUTOMATION_NAMES.XCUITEST + '\' ') + "driver instead of UIAutomation-based driver, since the " + "latter is unsupported on iOS 10 and up.");
      return _appiumXcuitestDriver.XCUITestDriver;
    }

    return _appiumIosDriver.IosDriver;
  },
  windows: function windows() {
    return _appiumWindowsDriver.WindowsDriver;
  },
  mac: function mac() {
    return _appiumMacDriver.MacDriver;
  },
  tizen: function tizen() {
    return _appiumTizenDriver.TizenDriver;
  }
};

var desiredCapabilityConstraints = {
  automationName: {
    presence: false,
    isString: true,
    inclusionCaseInsensitive: _lodash2['default'].values(AUTOMATION_NAMES)
  },
  platformName: {
    presence: true,
    isString: true,
    inclusionCaseInsensitive: _lodash2['default'].keys(PLATFORMS_MAP)
  }
};

var sessionsListGuard = new _asyncLock2['default']();
var pendingDriversGuard = new _asyncLock2['default']();

var AppiumDriver = (function (_BaseDriver) {
  _inherits(AppiumDriver, _BaseDriver);

  function AppiumDriver(args) {
    _classCallCheck(this, AppiumDriver);

    _get(Object.getPrototypeOf(AppiumDriver.prototype), 'constructor', this).call(this);

    this.desiredCapConstraints = desiredCapabilityConstraints;

    // the main Appium Driver has no new command timeout
    this.newCommandTimeoutMs = 0;

    this.args = _Object$assign({}, args);

    // Access to sessions list must be guarded with a Semaphore, because
    // it might be changed by other async calls at any time
    // It is not recommended to access this property directly from the outside
    this.sessions = {};

    // Access to pending drivers list must be guarded with a Semaphore, because
    // it might be changed by other async calls at any time
    // It is not recommended to access this property directly from the outside
    this.pendingDrivers = {};
  }

  // help decide which commands should be proxied to sub-drivers and which
  // should be handled by this, our umbrella driver

  /**
   * Cancel commands queueing for the umbrella Appium driver
   */

  _createClass(AppiumDriver, [{
    key: 'sessionExists',
    value: function sessionExists(sessionId) {
      var dstSession = this.sessions[sessionId];
      return dstSession && dstSession.sessionId !== null;
    }
  }, {
    key: 'driverForSession',
    value: function driverForSession(sessionId) {
      return this.sessions[sessionId];
    }
  }, {
    key: 'getDriverForCaps',
    value: function getDriverForCaps(caps) {
      if (!_lodash2['default'].isString(caps.platformName)) {
        throw new Error("You must include a platformName capability");
      }

      // we don't necessarily have an `automationName` capability,
      if (_lodash2['default'].isString(caps.automationName)) {
        var _iteratorNormalCompletion = true;
        var _didIteratorError = false;
        var _iteratorError = undefined;

        try {
          for (var _iterator = _getIterator(_lodash2['default'].values(DRIVER_MAP)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
            var _step$value = _step.value;
            var automationName = _step$value.automationName;
            var driverClass = _step$value.driverClass;

            if (_lodash2['default'].toLower(automationName) === caps.automationName.toLowerCase()) {
              return driverClass;
            }
          }
        } catch (err) {
          _didIteratorError = true;
          _iteratorError = err;
        } finally {
          try {
            if (!_iteratorNormalCompletion && _iterator['return']) {
              _iterator['return']();
            }
          } finally {
            if (_didIteratorError) {
              throw _iteratorError;
            }
          }
        }
      }

      var driverSelector = PLATFORMS_MAP[caps.platformName.toLowerCase()];
      if (driverSelector) {
        return driverSelector(caps);
      }

      var msg = _lodash2['default'].isString(caps.automationName) ? 'Could not find a driver for automationName \'' + caps.automationName + '\' and platformName ' + ('\'' + caps.platformName + '\'.') : 'Could not find a driver for platformName \'' + caps.platformName + '\'.';
      throw new Error(msg + ' Please check your desired capabilities.');
    }
  }, {
    key: 'getDriverVersion',
    value: function getDriverVersion(driver) {
      var _ref = DRIVER_MAP[driver.name] || {};

      var version = _ref.version;

      if (version) {
        return version;
      }
      _logger2['default'].warn('Unable to get version of driver \'' + driver.name + '\'');
    }
  }, {
    key: 'getStatus',
    value: function getStatus() {
      var config, gitSha, status;
      return _regeneratorRuntime.async(function getStatus$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _config.getAppiumConfig)());

          case 2:
            config = context$2$0.sent;
            gitSha = config['git-sha'];
            status = { build: { version: config.version } };

            if (!_lodash2['default'].isEmpty(gitSha)) {
              status.build.revision = gitSha;
            }
            return context$2$0.abrupt('return', status);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getSessions',
    value: function getSessions() {
      var sessions;
      return _regeneratorRuntime.async(function getSessions$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(sessionsListGuard.acquire(AppiumDriver.name, function () {
              return _this.sessions;
            }));

          case 2:
            sessions = context$2$0.sent;
            return context$2$0.abrupt('return', _lodash2['default'].toPairs(sessions).map(function (_ref2) {
              var _ref22 = _slicedToArray(_ref2, 2);

              var id = _ref22[0];
              var driver = _ref22[1];

              return { id: id, capabilities: driver.caps };
            }));

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'printNewSessionAnnouncement',
    value: function printNewSessionAnnouncement(driver, caps) {
      var driverVersion = this.getDriverVersion(driver);
      var introString = driverVersion ? 'Creating new ' + driver.name + ' (v' + driverVersion + ') session' : 'Creating new ' + driver.name + ' session';
      _logger2['default'].info(introString);
      _logger2['default'].info('Capabilities:');
      (0, _utils.inspectObject)(caps);
    }

    /**
     * Create a new session
     * @param {Object} jsonwpCaps JSONWP formatted desired capabilities
     * @param {Object} reqCaps Required capabilities (JSONWP standard)
     * @param {Object} w3cCapabilities W3C capabilities
     * @return {Array} Unique session ID and capabilities
     */
  }, {
    key: 'createSession',
    value: function createSession(jsonwpCaps, reqCaps, w3cCapabilities) {
      var defaultCapabilities, protocol, innerSessionId, dCaps;
      return _regeneratorRuntime.async(function createSession$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            defaultCapabilities = this.args.defaultCapabilities;
            protocol = undefined;
            innerSessionId = undefined, dCaps = undefined;
            context$2$0.prev = 3;
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap((function callee$2$0() {
              var parsedCaps, desiredCaps, processedJsonwpCapabilities, processedW3CCapabilities, error, InnerDriver, sessionIdsToDelete, runningDriversData, otherPendingDriversData, d, _ref3, _ref32;

              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this2 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    parsedCaps = (0, _utils.parseCapsForInnerDriver)(jsonwpCaps, w3cCapabilities, this.desiredCapConstraints, defaultCapabilities);
                    desiredCaps = parsedCaps.desiredCaps;
                    processedJsonwpCapabilities = parsedCaps.processedJsonwpCapabilities;
                    processedW3CCapabilities = parsedCaps.processedW3CCapabilities;
                    error = parsedCaps.error;

                    protocol = parsedCaps.protocol;

                    // If the parsing of the caps produced an error, throw it in here

                    if (!error) {
                      context$3$0.next = 8;
                      break;
                    }

                    throw error;

                  case 8:
                    InnerDriver = this.getDriverForCaps(desiredCaps);

                    this.printNewSessionAnnouncement(InnerDriver, desiredCaps);

                    if (!this.args.sessionOverride) {
                      context$3$0.next = 23;
                      break;
                    }

                    context$3$0.next = 13;
                    return _regeneratorRuntime.awrap(sessionsListGuard.acquire(AppiumDriver.name, function () {
                      return _lodash2['default'].keys(_this2.sessions);
                    }));

                  case 13:
                    sessionIdsToDelete = context$3$0.sent;

                    if (!sessionIdsToDelete.length) {
                      context$3$0.next = 23;
                      break;
                    }

                    _logger2['default'].info('Session override is on. Deleting other ' + sessionIdsToDelete.length + ' active session' + (sessionIdsToDelete.length ? '' : 's') + '.');
                    context$3$0.prev = 16;
                    context$3$0.next = 19;
                    return _regeneratorRuntime.awrap(_bluebird2['default'].map(sessionIdsToDelete, function (id) {
                      return _this2.deleteSession(id);
                    }));

                  case 19:
                    context$3$0.next = 23;
                    break;

                  case 21:
                    context$3$0.prev = 21;
                    context$3$0.t0 = context$3$0['catch'](16);

                  case 23:
                    runningDriversData = undefined, otherPendingDriversData = undefined;
                    d = new InnerDriver(this.args);

                    if (this.args.relaxedSecurityEnabled) {
                      _logger2['default'].info('Applying relaxed security to \'' + InnerDriver.name + '\' as per server command line argument');
                      d.relaxedSecurityEnabled = true;
                    }
                    // This assignment is required for correct web sockets functionality inside the driver
                    d.server = this.server;
                    context$3$0.prev = 27;
                    context$3$0.next = 30;
                    return _regeneratorRuntime.awrap(this.curSessionDataForDriver(InnerDriver));

                  case 30:
                    runningDriversData = context$3$0.sent;
                    context$3$0.next = 36;
                    break;

                  case 33:
                    context$3$0.prev = 33;
                    context$3$0.t1 = context$3$0['catch'](27);
                    throw new _appiumBaseDriver.errors.SessionNotCreatedError(context$3$0.t1.message);

                  case 36:
                    context$3$0.next = 38;
                    return _regeneratorRuntime.awrap(pendingDriversGuard.acquire(AppiumDriver.name, function () {
                      _this2.pendingDrivers[InnerDriver.name] = _this2.pendingDrivers[InnerDriver.name] || [];
                      otherPendingDriversData = _this2.pendingDrivers[InnerDriver.name].map(function (drv) {
                        return drv.driverData;
                      });
                      _this2.pendingDrivers[InnerDriver.name].push(d);
                    }));

                  case 38:
                    context$3$0.prev = 38;
                    context$3$0.next = 41;
                    return _regeneratorRuntime.awrap(d.createSession(processedJsonwpCapabilities, reqCaps, processedW3CCapabilities, [].concat(_toConsumableArray(runningDriversData), _toConsumableArray(otherPendingDriversData))));

                  case 41:
                    _ref3 = context$3$0.sent;
                    _ref32 = _slicedToArray(_ref3, 2);
                    innerSessionId = _ref32[0];
                    dCaps = _ref32[1];

                    protocol = d.protocol;
                    context$3$0.next = 48;
                    return _regeneratorRuntime.awrap(sessionsListGuard.acquire(AppiumDriver.name, function () {
                      _this2.sessions[innerSessionId] = d;
                    }));

                  case 48:
                    context$3$0.prev = 48;
                    context$3$0.next = 51;
                    return _regeneratorRuntime.awrap(pendingDriversGuard.acquire(AppiumDriver.name, function () {
                      _lodash2['default'].pull(_this2.pendingDrivers[InnerDriver.name], d);
                    }));

                  case 51:
                    return context$3$0.finish(48);

                  case 52:

                    // this is an async function but we don't await it because it handles
                    // an out-of-band promise which is fulfilled if the inner driver
                    // unexpectedly shuts down
                    this.attachUnexpectedShutdownHandler(d, innerSessionId);

                    _logger2['default'].info('New ' + InnerDriver.name + ' session created successfully, session ' + (innerSessionId + ' added to master session list'));

                    // set the New Command Timeout for the inner driver
                    d.startNewCommandTimeout();

                  case 55:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3, [[16, 21], [27, 33], [38,, 48, 52]]);
            })());

          case 6:
            context$2$0.next = 11;
            break;

          case 8:
            context$2$0.prev = 8;
            context$2$0.t0 = context$2$0['catch'](3);
            return context$2$0.abrupt('return', {
              protocol: protocol,
              error: context$2$0.t0
            });

          case 11:
            return context$2$0.abrupt('return', {
              protocol: protocol,
              value: [innerSessionId, dCaps, protocol]
            });

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[3, 8]]);
    }
  }, {
    key: 'attachUnexpectedShutdownHandler',
    value: function attachUnexpectedShutdownHandler(driver, innerSessionId) {
      return _regeneratorRuntime.async(function attachUnexpectedShutdownHandler$(context$2$0) {
        var _this4 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(driver.onUnexpectedShutdown);

          case 3:
            throw new Error('Unexpected shutdown');

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](0);

            if (!(context$2$0.t0 instanceof _bluebird2['default'].CancellationError)) {
              context$2$0.next = 10;
              break;
            }

            return context$2$0.abrupt('return');

          case 10:
            _logger2['default'].warn('Closing session, cause was \'' + context$2$0.t0.message + '\'');
            _logger2['default'].info('Removing session ' + innerSessionId + ' from our master session list');
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(sessionsListGuard.acquire(AppiumDriver.name, function () {
              delete _this4.sessions[innerSessionId];
            }));

          case 14:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 6]]);
    }
  }, {
    key: 'curSessionDataForDriver',
    value: function curSessionDataForDriver(InnerDriver) {
      var sessions, data, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, datum;

      return _regeneratorRuntime.async(function curSessionDataForDriver$(context$2$0) {
        var _this5 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(sessionsListGuard.acquire(AppiumDriver.name, function () {
              return _this5.sessions;
            }));

          case 2:
            sessions = context$2$0.sent;
            data = _lodash2['default'].values(sessions).filter(function (s) {
              return s.constructor.name === InnerDriver.name;
            }).map(function (s) {
              return s.driverData;
            });
            _iteratorNormalCompletion2 = true;
            _didIteratorError2 = false;
            _iteratorError2 = undefined;
            context$2$0.prev = 7;
            _iterator2 = _getIterator(data);

          case 9:
            if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
              context$2$0.next = 16;
              break;
            }

            datum = _step2.value;

            if (datum) {
              context$2$0.next = 13;
              break;
            }

            throw new Error('Problem getting session data for driver type ' + (InnerDriver.name + '; does it implement \'get ') + 'driverData\'?');

          case 13:
            _iteratorNormalCompletion2 = true;
            context$2$0.next = 9;
            break;

          case 16:
            context$2$0.next = 22;
            break;

          case 18:
            context$2$0.prev = 18;
            context$2$0.t0 = context$2$0['catch'](7);
            _didIteratorError2 = true;
            _iteratorError2 = context$2$0.t0;

          case 22:
            context$2$0.prev = 22;
            context$2$0.prev = 23;

            if (!_iteratorNormalCompletion2 && _iterator2['return']) {
              _iterator2['return']();
            }

          case 25:
            context$2$0.prev = 25;

            if (!_didIteratorError2) {
              context$2$0.next = 28;
              break;
            }

            throw _iteratorError2;

          case 28:
            return context$2$0.finish(25);

          case 29:
            return context$2$0.finish(22);

          case 30:
            return context$2$0.abrupt('return', data);

          case 31:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[7, 18, 22, 30], [23,, 25, 29]]);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession(sessionId) {
      var protocol, _ret2;

      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        var _this7 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            protocol = undefined;
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((function callee$2$0() {
              var otherSessionsData, dstSession;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this6 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    otherSessionsData = null;
                    dstSession = null;
                    context$3$0.next = 4;
                    return _regeneratorRuntime.awrap(sessionsListGuard.acquire(AppiumDriver.name, function () {
                      if (!_this6.sessions[sessionId]) {
                        return;
                      }
                      var curConstructorName = _this6.sessions[sessionId].constructor.name;
                      otherSessionsData = _lodash2['default'].toPairs(_this6.sessions).filter(function (_ref4) {
                        var _ref42 = _slicedToArray(_ref4, 2);

                        var key = _ref42[0];
                        var value = _ref42[1];
                        return value.constructor.name === curConstructorName && key !== sessionId;
                      }).map(function (_ref5) {
                        var _ref52 = _slicedToArray(_ref5, 2);

                        var value = _ref52[1];
                        return value.driverData;
                      });
                      dstSession = _this6.sessions[sessionId];
                      protocol = dstSession.protocol;
                      _logger2['default'].info('Removing session ' + sessionId + ' from our master session list');
                      // regardless of whether the deleteSession completes successfully or not
                      // make the session unavailable, because who knows what state it might
                      // be in otherwise
                      delete _this6.sessions[sessionId];
                    }));

                  case 4:
                    context$3$0.t0 = protocol;
                    context$3$0.next = 7;
                    return _regeneratorRuntime.awrap(dstSession.deleteSession(sessionId, otherSessionsData));

                  case 7:
                    context$3$0.t1 = context$3$0.sent;
                    context$3$0.t2 = {
                      protocol: context$3$0.t0,
                      value: context$3$0.t1
                    };
                    return context$3$0.abrupt('return', {
                      v: context$3$0.t2
                    });

                  case 10:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this7);
            })());

          case 4:
            _ret2 = context$2$0.sent;

            if (!(typeof _ret2 === 'object')) {
              context$2$0.next = 7;
              break;
            }

            return context$2$0.abrupt('return', _ret2.v);

          case 7:
            context$2$0.next = 13;
            break;

          case 9:
            context$2$0.prev = 9;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].error('Had trouble ending session ' + sessionId + ': ' + context$2$0.t0.message);
            return context$2$0.abrupt('return', {
              protocol: protocol,
              error: context$2$0.t0
            });

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 9]]);
    }
  }, {
    key: 'executeCommand',
    value: function executeCommand(cmd) {
      for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        args[_key - 1] = arguments[_key];
      }

      var _get2, sessionId, dstSession, res;

      return _regeneratorRuntime.async(function executeCommand$(context$2$0) {
        var _this8 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(cmd === 'getStatus')) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getStatus());

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
            if (!isAppiumDriverCommand(cmd)) {
              context$2$0.next = 8;
              break;
            }

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((_get2 = _get(Object.getPrototypeOf(AppiumDriver.prototype), 'executeCommand', this)).call.apply(_get2, [this, cmd].concat(args)));

          case 7:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 8:
            sessionId = _lodash2['default'].last(args);
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(sessionsListGuard.acquire(AppiumDriver.name, function () {
              return _this8.sessions[sessionId];
            }));

          case 11:
            dstSession = context$2$0.sent;

            if (dstSession) {
              context$2$0.next = 14;
              break;
            }

            throw new Error('The session with id \'' + sessionId + '\' does not exist');

          case 14:
            res = {
              protocol: dstSession.protocol
            };
            context$2$0.prev = 15;
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(dstSession.executeCommand.apply(dstSession, [cmd].concat(args)));

          case 18:
            res.value = context$2$0.sent;
            context$2$0.next = 24;
            break;

          case 21:
            context$2$0.prev = 21;
            context$2$0.t0 = context$2$0['catch'](15);

            res.error = context$2$0.t0;

          case 24:
            return context$2$0.abrupt('return', res);

          case 25:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[15, 21]]);
    }
  }, {
    key: 'proxyActive',
    value: function proxyActive(sessionId) {
      var dstSession = this.sessions[sessionId];
      return dstSession && _lodash2['default'].isFunction(dstSession.proxyActive) && dstSession.proxyActive(sessionId);
    }
  }, {
    key: 'getProxyAvoidList',
    value: function getProxyAvoidList(sessionId) {
      var dstSession = this.sessions[sessionId];
      return dstSession ? dstSession.getProxyAvoidList() : [];
    }
  }, {
    key: 'canProxy',
    value: function canProxy(sessionId) {
      var dstSession = this.sessions[sessionId];
      return dstSession && dstSession.canProxy(sessionId);
    }
  }, {
    key: 'isCommandsQueueEnabled',
    get: function get() {
      return false;
    }
  }]);

  return AppiumDriver;
})(_appiumBaseDriver.BaseDriver);

function isAppiumDriverCommand(cmd) {
  return !(0, _appiumBaseDriver.isSessionCommand)(cmd) || cmd === "deleteSession";
}

exports.AppiumDriver = AppiumDriver;

// Parse the caps into a format that the InnerDriver will accept

// Remove the session on unexpected shutdown, so that we are in a position
// to open another session later on.
// TODO: this should be removed and replaced by a onShutdown callback.
// this is a cancellable promise
// if we get here, we've had an unexpected shutdown, so error

// if we cancelled the unexpected shutdown promise, that means we
// no longer care about it, and can safely ignore it

// getStatus command should not be put into queue. If we do it as part of super.executeCommand, it will be added to queue.
// There will be lot of status commands in queue during createSession command, as createSession can take up to or more than a minute.
//# sourceMappingURL=data:application/json;charset=utf8;base64,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VSxHQUFnQixHQUFHLFNBQUssSUFBSSxFQUFDOzs7QUFBekQsZUFBRyxDQUFDLEtBQUs7Ozs7Ozs7O0FBRVQsZUFBRyxDQUFDLEtBQUssaUJBQUksQ0FBQzs7O2dEQUVULEdBQUc7Ozs7Ozs7S0FDWDs7O1dBRVcscUJBQUMsU0FBUyxFQUFFO0FBQ3RCLFVBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDNUMsYUFBTyxVQUFVLElBQUksb0JBQUUsVUFBVSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxVQUFVLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0tBQ2hHOzs7V0FFaUIsMkJBQUMsU0FBUyxFQUFFO0FBQzVCLFVBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDNUMsYUFBTyxVQUFVLEdBQUcsVUFBVSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsRUFBRSxDQUFDO0tBQ3pEOzs7V0FFUSxrQkFBQyxTQUFTLEVBQUU7QUFDbkIsVUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUM1QyxhQUFPLFVBQVUsSUFBSSxVQUFVLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0tBQ3JEOzs7U0FsUzBCLGVBQUc7QUFDNUIsYUFBTyxLQUFLLENBQUM7S0FDZDs7O1NBM0JHLFlBQVk7OztBQWdVbEIsU0FBUyxxQkFBcUIsQ0FBRSxHQUFHLEVBQUU7QUFDbkMsU0FBTyxDQUFDLHdDQUFpQixHQUFHLENBQUMsSUFBSSxHQUFHLEtBQUssZUFBZSxDQUFDO0NBQzFEOztRQUVRLFlBQVksR0FBWixZQUFZIiwiZmlsZSI6ImxpYi9hcHBpdW0uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBnZXRBcHBpdW1Db25maWcgfSBmcm9tICcuL2NvbmZpZyc7XG5pbXBvcnQgeyBCYXNlRHJpdmVyLCBlcnJvcnMsIGlzU2Vzc2lvbkNvbW1hbmQgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgRmFrZURyaXZlciB9IGZyb20gJ2FwcGl1bS1mYWtlLWRyaXZlcic7XG5pbXBvcnQgeyBBbmRyb2lkRHJpdmVyIH0gZnJvbSAnYXBwaXVtLWFuZHJvaWQtZHJpdmVyJztcbmltcG9ydCB7IElvc0RyaXZlciB9IGZyb20gJ2FwcGl1bS1pb3MtZHJpdmVyJztcbmltcG9ydCB7IEFuZHJvaWRVaWF1dG9tYXRvcjJEcml2ZXIgfSBmcm9tICdhcHBpdW0tdWlhdXRvbWF0b3IyLWRyaXZlcic7XG5pbXBvcnQgeyBTZWxlbmRyb2lkRHJpdmVyIH0gZnJvbSAnYXBwaXVtLXNlbGVuZHJvaWQtZHJpdmVyJztcbmltcG9ydCB7IFhDVUlUZXN0RHJpdmVyIH0gZnJvbSAnYXBwaXVtLXhjdWl0ZXN0LWRyaXZlcic7XG5pbXBvcnQgeyBZb3VpRW5naW5lRHJpdmVyIH0gZnJvbSAnYXBwaXVtLXlvdWllbmdpbmUtZHJpdmVyJztcbmltcG9ydCB7IFdpbmRvd3NEcml2ZXIgfSBmcm9tICdhcHBpdW0td2luZG93cy1kcml2ZXInO1xuaW1wb3J0IHsgTWFjRHJpdmVyIH0gZnJvbSAnYXBwaXVtLW1hYy1kcml2ZXInO1xuaW1wb3J0IHsgRXNwcmVzc29Ecml2ZXIgfSBmcm9tICdhcHBpdW0tZXNwcmVzc28tZHJpdmVyJztcbmltcG9ydCB7IFRpemVuRHJpdmVyIH0gZnJvbSAnYXBwaXVtLXRpemVuLWRyaXZlcic7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgQXN5bmNMb2NrIGZyb20gJ2FzeW5jLWxvY2snO1xuaW1wb3J0IHsgaW5zcGVjdE9iamVjdCwgcGFyc2VDYXBzRm9ySW5uZXJEcml2ZXIsIGdldFBhY2thZ2VWZXJzaW9uIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5cblxuY29uc3QgQVVUT01BVElPTl9OQU1FUyA9IHtcbiAgQVBQSVVNOiAnQXBwaXVtJyxcbiAgU0VMRU5EUk9JRDogJ1NlbGVuZHJvaWQnLFxuICBVSUFVVE9NQVRPUjI6ICdVaUF1dG9tYXRvcjInLFxuICBYQ1VJVEVTVDogJ1hDVUlUZXN0JyxcbiAgWU9VSUVOR0lORTogJ1lvdWlFbmdpbmUnLFxuICBFU1BSRVNTTzogJ0VzcHJlc3NvJyxcbiAgVElaRU46ICdUaXplbicsXG4gIEZBS0U6ICdGYWtlJyxcbn07XG5jb25zdCBEUklWRVJfTUFQID0ge1xuICBTZWxlbmRyb2lkRHJpdmVyOiB7XG4gICAgZHJpdmVyQ2xhc3M6IFNlbGVuZHJvaWREcml2ZXIsXG4gICAgYXV0b21hdGlvbk5hbWU6IEFVVE9NQVRJT05fTkFNRVMuU0VMRU5EUk9JRCxcbiAgICB2ZXJzaW9uOiBnZXRQYWNrYWdlVmVyc2lvbignYXBwaXVtLXNlbGVuZHJvaWQtZHJpdmVyJyksXG4gIH0sXG4gIEFuZHJvaWRVaWF1dG9tYXRvcjJEcml2ZXI6IHtcbiAgICBkcml2ZXJDbGFzczogQW5kcm9pZFVpYXV0b21hdG9yMkRyaXZlcixcbiAgICBhdXRvbWF0aW9uTmFtZTogQVVUT01BVElPTl9OQU1FUy5VSUFVVE9NQVRPUjIsXG4gICAgdmVyc2lvbjogZ2V0UGFja2FnZVZlcnNpb24oJ2FwcGl1bS11aWF1dG9tYXRvcjItZHJpdmVyJyksXG4gIH0sXG4gIFhDVUlUZXN0RHJpdmVyOiB7XG4gICAgZHJpdmVyQ2xhc3M6IFhDVUlUZXN0RHJpdmVyLFxuICAgIGF1dG9tYXRpb25OYW1lOiBBVVRPTUFUSU9OX05BTUVTLlhDVUlURVNULFxuICAgIHZlcnNpb246IGdldFBhY2thZ2VWZXJzaW9uKCdhcHBpdW0teGN1aXRlc3QtZHJpdmVyJyksXG4gIH0sXG4gIFlvdWlFbmdpbmVEcml2ZXI6IHtcbiAgICBkcml2ZXJDbGFzczogWW91aUVuZ2luZURyaXZlcixcbiAgICBhdXRvbWF0aW9uTmFtZTogQVVUT01BVElPTl9OQU1FUy5ZT1VJRU5HSU5FLFxuICAgIHZlcnNpb246IGdldFBhY2thZ2VWZXJzaW9uKCdhcHBpdW0teW91aWVuZ2luZS1kcml2ZXInKSxcbiAgfSxcbiAgRmFrZURyaXZlcjoge1xuICAgIGRyaXZlckNsYXNzOiBGYWtlRHJpdmVyLFxuICAgIHZlcnNpb246IGdldFBhY2thZ2VWZXJzaW9uKCdhcHBpdW0tZmFrZS1kcml2ZXInKSxcbiAgfSxcbiAgQW5kcm9pZERyaXZlcjoge1xuICAgIGRyaXZlckNsYXNzOiBBbmRyb2lkRHJpdmVyLFxuICAgIHZlcnNpb246IGdldFBhY2thZ2VWZXJzaW9uKCdhcHBpdW0tYW5kcm9pZC1kcml2ZXInKSxcbiAgfSxcbiAgSW9zRHJpdmVyOiB7XG4gICAgZHJpdmVyQ2xhc3M6IElvc0RyaXZlcixcbiAgICB2ZXJzaW9uOiBnZXRQYWNrYWdlVmVyc2lvbignYXBwaXVtLWlvcy1kcml2ZXInKSxcbiAgfSxcbiAgV2luZG93c0RyaXZlcjoge1xuICAgIGRyaXZlckNsYXNzOiBXaW5kb3dzRHJpdmVyLFxuICAgIHZlcnNpb246IGdldFBhY2thZ2VWZXJzaW9uKCdhcHBpdW0td2luZG93cy1kcml2ZXInKSxcbiAgfSxcbiAgTWFjRHJpdmVyOiB7XG4gICAgZHJpdmVyQ2xhc3M6IE1hY0RyaXZlcixcbiAgICB2ZXJzaW9uOiBnZXRQYWNrYWdlVmVyc2lvbignYXBwaXVtLW1hYy1kcml2ZXInKSxcbiAgfSxcbiAgRXNwcmVzc29Ecml2ZXI6IHtcbiAgICBkcml2ZXJDbGFzczogRXNwcmVzc29Ecml2ZXIsXG4gICAgYXV0b21hdGlvbk5hbWU6IEFVVE9NQVRJT05fTkFNRVMuRVNQUkVTU08sXG4gICAgdmVyc2lvbjogZ2V0UGFja2FnZVZlcnNpb24oJ2FwcGl1bS1lc3ByZXNzby1kcml2ZXInKSxcbiAgfSxcbiAgVGl6ZW5Ecml2ZXI6IHtcbiAgICBkcml2ZXJDbGFzczogVGl6ZW5Ecml2ZXIsXG4gICAgYXV0b21hdGlvbk5hbWU6IEFVVE9NQVRJT05fTkFNRVMuVElaRU4sXG4gICAgdmVyc2lvbjogZ2V0UGFja2FnZVZlcnNpb24oJ2FwcGl1bS10aXplbi1kcml2ZXInKSxcbiAgfSxcbn07XG5cbmNvbnN0IFBMQVRGT1JNU19NQVAgPSB7XG4gIGZha2U6ICgpID0+IEZha2VEcml2ZXIsXG4gIGFuZHJvaWQ6IChjYXBzKSA9PiB7XG4gICAgY29uc3QgcGxhdGZvcm1WZXJzaW9uID0gc2VtdmVyLnZhbGlkKHNlbXZlci5jb2VyY2UoY2Fwcy5wbGF0Zm9ybVZlcnNpb24pKTtcbiAgICBpZiAocGxhdGZvcm1WZXJzaW9uICYmIHNlbXZlci5zYXRpc2ZpZXMocGxhdGZvcm1WZXJzaW9uLCAnPj02LjAuMCcpKSB7XG4gICAgICBsb2cud2FybihcIkNvbnNpZGVyIHNldHRpbmcgJ2F1dG9tYXRpb25OYW1lJyBjYXBhYmlsaXR5IHRvIFwiICtcbiAgICAgICAgYCcke0FVVE9NQVRJT05fTkFNRVMuVUlBVVRPTUFUT1IyfScgYCArXG4gICAgICAgIFwib24gQW5kcm9pZCA+PSA2LCBzaW5jZSBVSUF1dG9tYXRvciBmcmFtZXdvcmsgXCIgK1xuICAgICAgICBcImlzIG5vdCBtYWludGFpbmVkIGFueW1vcmUgYnkgdGhlIE9TIHZlbmRvci5cIik7XG4gICAgfVxuXG4gICAgcmV0dXJuIEFuZHJvaWREcml2ZXI7XG4gIH0sXG4gIGlvczogKGNhcHMpID0+IHtcbiAgICBjb25zdCBwbGF0Zm9ybVZlcnNpb24gPSBzZW12ZXIudmFsaWQoc2VtdmVyLmNvZXJjZShjYXBzLnBsYXRmb3JtVmVyc2lvbikpO1xuICAgIGlmIChwbGF0Zm9ybVZlcnNpb24gJiYgc2VtdmVyLnNhdGlzZmllcyhwbGF0Zm9ybVZlcnNpb24sICc+PTEwLjAuMCcpKSB7XG4gICAgICBsb2cuaW5mbyhcIlJlcXVlc3RlZCBpT1Mgc3VwcG9ydCB3aXRoIHZlcnNpb24gPj0gMTAsIFwiICtcbiAgICAgICAgYHVzaW5nICcke0FVVE9NQVRJT05fTkFNRVMuWENVSVRFU1R9JyBgICtcbiAgICAgICAgXCJkcml2ZXIgaW5zdGVhZCBvZiBVSUF1dG9tYXRpb24tYmFzZWQgZHJpdmVyLCBzaW5jZSB0aGUgXCIgK1xuICAgICAgICBcImxhdHRlciBpcyB1bnN1cHBvcnRlZCBvbiBpT1MgMTAgYW5kIHVwLlwiKTtcbiAgICAgIHJldHVybiBYQ1VJVGVzdERyaXZlcjtcbiAgICB9XG5cbiAgICByZXR1cm4gSW9zRHJpdmVyO1xuICB9LFxuICB3aW5kb3dzOiAoKSA9PiBXaW5kb3dzRHJpdmVyLFxuICBtYWM6ICgpID0+IE1hY0RyaXZlcixcbiAgdGl6ZW46ICgpID0+IFRpemVuRHJpdmVyLFxufTtcblxuY29uc3QgZGVzaXJlZENhcGFiaWxpdHlDb25zdHJhaW50cyA9IHtcbiAgYXV0b21hdGlvbk5hbWU6IHtcbiAgICBwcmVzZW5jZTogZmFsc2UsXG4gICAgaXNTdHJpbmc6IHRydWUsXG4gICAgaW5jbHVzaW9uQ2FzZUluc2Vuc2l0aXZlOiBfLnZhbHVlcyhBVVRPTUFUSU9OX05BTUVTKSxcbiAgfSxcbiAgcGxhdGZvcm1OYW1lOiB7XG4gICAgcHJlc2VuY2U6IHRydWUsXG4gICAgaXNTdHJpbmc6IHRydWUsXG4gICAgaW5jbHVzaW9uQ2FzZUluc2Vuc2l0aXZlOiBfLmtleXMoUExBVEZPUk1TX01BUCksXG4gIH0sXG59O1xuXG5jb25zdCBzZXNzaW9uc0xpc3RHdWFyZCA9IG5ldyBBc3luY0xvY2soKTtcbmNvbnN0IHBlbmRpbmdEcml2ZXJzR3VhcmQgPSBuZXcgQXN5bmNMb2NrKCk7XG5cbmNsYXNzIEFwcGl1bURyaXZlciBleHRlbmRzIEJhc2VEcml2ZXIge1xuICBjb25zdHJ1Y3RvciAoYXJncykge1xuICAgIHN1cGVyKCk7XG5cbiAgICB0aGlzLmRlc2lyZWRDYXBDb25zdHJhaW50cyA9IGRlc2lyZWRDYXBhYmlsaXR5Q29uc3RyYWludHM7XG5cbiAgICAvLyB0aGUgbWFpbiBBcHBpdW0gRHJpdmVyIGhhcyBubyBuZXcgY29tbWFuZCB0aW1lb3V0XG4gICAgdGhpcy5uZXdDb21tYW5kVGltZW91dE1zID0gMDtcblxuICAgIHRoaXMuYXJncyA9IE9iamVjdC5hc3NpZ24oe30sIGFyZ3MpO1xuXG4gICAgLy8gQWNjZXNzIHRvIHNlc3Npb25zIGxpc3QgbXVzdCBiZSBndWFyZGVkIHdpdGggYSBTZW1hcGhvcmUsIGJlY2F1c2VcbiAgICAvLyBpdCBtaWdodCBiZSBjaGFuZ2VkIGJ5IG90aGVyIGFzeW5jIGNhbGxzIGF0IGFueSB0aW1lXG4gICAgLy8gSXQgaXMgbm90IHJlY29tbWVuZGVkIHRvIGFjY2VzcyB0aGlzIHByb3BlcnR5IGRpcmVjdGx5IGZyb20gdGhlIG91dHNpZGVcbiAgICB0aGlzLnNlc3Npb25zID0ge307XG5cbiAgICAvLyBBY2Nlc3MgdG8gcGVuZGluZyBkcml2ZXJzIGxpc3QgbXVzdCBiZSBndWFyZGVkIHdpdGggYSBTZW1hcGhvcmUsIGJlY2F1c2VcbiAgICAvLyBpdCBtaWdodCBiZSBjaGFuZ2VkIGJ5IG90aGVyIGFzeW5jIGNhbGxzIGF0IGFueSB0aW1lXG4gICAgLy8gSXQgaXMgbm90IHJlY29tbWVuZGVkIHRvIGFjY2VzcyB0aGlzIHByb3BlcnR5IGRpcmVjdGx5IGZyb20gdGhlIG91dHNpZGVcbiAgICB0aGlzLnBlbmRpbmdEcml2ZXJzID0ge307XG4gIH1cblxuICAvKipcbiAgICogQ2FuY2VsIGNvbW1hbmRzIHF1ZXVlaW5nIGZvciB0aGUgdW1icmVsbGEgQXBwaXVtIGRyaXZlclxuICAgKi9cbiAgZ2V0IGlzQ29tbWFuZHNRdWV1ZUVuYWJsZWQgKCkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHNlc3Npb25FeGlzdHMgKHNlc3Npb25JZCkge1xuICAgIGNvbnN0IGRzdFNlc3Npb24gPSB0aGlzLnNlc3Npb25zW3Nlc3Npb25JZF07XG4gICAgcmV0dXJuIGRzdFNlc3Npb24gJiYgZHN0U2Vzc2lvbi5zZXNzaW9uSWQgIT09IG51bGw7XG4gIH1cblxuICBkcml2ZXJGb3JTZXNzaW9uIChzZXNzaW9uSWQpIHtcbiAgICByZXR1cm4gdGhpcy5zZXNzaW9uc1tzZXNzaW9uSWRdO1xuICB9XG5cbiAgZ2V0RHJpdmVyRm9yQ2FwcyAoY2Fwcykge1xuICAgIGlmICghXy5pc1N0cmluZyhjYXBzLnBsYXRmb3JtTmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIllvdSBtdXN0IGluY2x1ZGUgYSBwbGF0Zm9ybU5hbWUgY2FwYWJpbGl0eVwiKTtcbiAgICB9XG5cbiAgICAvLyB3ZSBkb24ndCBuZWNlc3NhcmlseSBoYXZlIGFuIGBhdXRvbWF0aW9uTmFtZWAgY2FwYWJpbGl0eSxcbiAgICBpZiAoXy5pc1N0cmluZyhjYXBzLmF1dG9tYXRpb25OYW1lKSkge1xuICAgICAgZm9yIChjb25zdCB7YXV0b21hdGlvbk5hbWUsIGRyaXZlckNsYXNzfSBvZiBfLnZhbHVlcyhEUklWRVJfTUFQKSkge1xuICAgICAgICBpZiAoXy50b0xvd2VyKGF1dG9tYXRpb25OYW1lKSA9PT0gY2Fwcy5hdXRvbWF0aW9uTmFtZS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgICAgcmV0dXJuIGRyaXZlckNsYXNzO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgZHJpdmVyU2VsZWN0b3IgPSBQTEFURk9STVNfTUFQW2NhcHMucGxhdGZvcm1OYW1lLnRvTG93ZXJDYXNlKCldO1xuICAgIGlmIChkcml2ZXJTZWxlY3Rvcikge1xuICAgICAgcmV0dXJuIGRyaXZlclNlbGVjdG9yKGNhcHMpO1xuICAgIH1cblxuICAgIGNvbnN0IG1zZyA9IF8uaXNTdHJpbmcoY2Fwcy5hdXRvbWF0aW9uTmFtZSlcbiAgICAgID8gYENvdWxkIG5vdCBmaW5kIGEgZHJpdmVyIGZvciBhdXRvbWF0aW9uTmFtZSAnJHtjYXBzLmF1dG9tYXRpb25OYW1lfScgYW5kIHBsYXRmb3JtTmFtZSBgICtcbiAgICAgICAgICAgIGAnJHtjYXBzLnBsYXRmb3JtTmFtZX0nLmBcbiAgICAgIDogYENvdWxkIG5vdCBmaW5kIGEgZHJpdmVyIGZvciBwbGF0Zm9ybU5hbWUgJyR7Y2Fwcy5wbGF0Zm9ybU5hbWV9Jy5gO1xuICAgIHRocm93IG5ldyBFcnJvcihgJHttc2d9IFBsZWFzZSBjaGVjayB5b3VyIGRlc2lyZWQgY2FwYWJpbGl0aWVzLmApO1xuICB9XG5cbiAgZ2V0RHJpdmVyVmVyc2lvbiAoZHJpdmVyKSB7XG4gICAgY29uc3Qge3ZlcnNpb259ID0gRFJJVkVSX01BUFtkcml2ZXIubmFtZV0gfHwge307XG4gICAgaWYgKHZlcnNpb24pIHtcbiAgICAgIHJldHVybiB2ZXJzaW9uO1xuICAgIH1cbiAgICBsb2cud2FybihgVW5hYmxlIHRvIGdldCB2ZXJzaW9uIG9mIGRyaXZlciAnJHtkcml2ZXIubmFtZX0nYCk7XG4gIH1cblxuICBhc3luYyBnZXRTdGF0dXMgKCkge1xuICAgIGNvbnN0IGNvbmZpZyA9IGF3YWl0IGdldEFwcGl1bUNvbmZpZygpO1xuICAgIGNvbnN0IGdpdFNoYSA9IGNvbmZpZ1snZ2l0LXNoYSddO1xuICAgIGNvbnN0IHN0YXR1cyA9IHtidWlsZDoge3ZlcnNpb246IGNvbmZpZy52ZXJzaW9ufX07XG4gICAgaWYgKCFfLmlzRW1wdHkoZ2l0U2hhKSkge1xuICAgICAgc3RhdHVzLmJ1aWxkLnJldmlzaW9uID0gZ2l0U2hhO1xuICAgIH1cbiAgICByZXR1cm4gc3RhdHVzO1xuICB9XG5cbiAgYXN5bmMgZ2V0U2Vzc2lvbnMgKCkge1xuICAgIGNvbnN0IHNlc3Npb25zID0gYXdhaXQgc2Vzc2lvbnNMaXN0R3VhcmQuYWNxdWlyZShBcHBpdW1Ecml2ZXIubmFtZSwgKCkgPT4gdGhpcy5zZXNzaW9ucyk7XG4gICAgcmV0dXJuIF8udG9QYWlycyhzZXNzaW9ucylcbiAgICAgICAgLm1hcCgoW2lkLCBkcml2ZXJdKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtpZCwgY2FwYWJpbGl0aWVzOiBkcml2ZXIuY2Fwc307XG4gICAgICAgIH0pO1xuICB9XG5cbiAgcHJpbnROZXdTZXNzaW9uQW5ub3VuY2VtZW50IChkcml2ZXIsIGNhcHMpIHtcbiAgICBjb25zdCBkcml2ZXJWZXJzaW9uID0gdGhpcy5nZXREcml2ZXJWZXJzaW9uKGRyaXZlcik7XG4gICAgY29uc3QgaW50cm9TdHJpbmcgPSBkcml2ZXJWZXJzaW9uXG4gICAgICA/IGBDcmVhdGluZyBuZXcgJHtkcml2ZXIubmFtZX0gKHYke2RyaXZlclZlcnNpb259KSBzZXNzaW9uYFxuICAgICAgOiBgQ3JlYXRpbmcgbmV3ICR7ZHJpdmVyLm5hbWV9IHNlc3Npb25gO1xuICAgIGxvZy5pbmZvKGludHJvU3RyaW5nKTtcbiAgICBsb2cuaW5mbygnQ2FwYWJpbGl0aWVzOicpO1xuICAgIGluc3BlY3RPYmplY3QoY2Fwcyk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IHNlc3Npb25cbiAgICogQHBhcmFtIHtPYmplY3R9IGpzb253cENhcHMgSlNPTldQIGZvcm1hdHRlZCBkZXNpcmVkIGNhcGFiaWxpdGllc1xuICAgKiBAcGFyYW0ge09iamVjdH0gcmVxQ2FwcyBSZXF1aXJlZCBjYXBhYmlsaXRpZXMgKEpTT05XUCBzdGFuZGFyZClcbiAgICogQHBhcmFtIHtPYmplY3R9IHczY0NhcGFiaWxpdGllcyBXM0MgY2FwYWJpbGl0aWVzXG4gICAqIEByZXR1cm4ge0FycmF5fSBVbmlxdWUgc2Vzc2lvbiBJRCBhbmQgY2FwYWJpbGl0aWVzXG4gICAqL1xuICBhc3luYyBjcmVhdGVTZXNzaW9uIChqc29ud3BDYXBzLCByZXFDYXBzLCB3M2NDYXBhYmlsaXRpZXMpIHtcbiAgICBjb25zdCB7ZGVmYXVsdENhcGFiaWxpdGllc30gPSB0aGlzLmFyZ3M7XG4gICAgbGV0IHByb3RvY29sO1xuICAgIGxldCBpbm5lclNlc3Npb25JZCwgZENhcHM7XG5cbiAgICB0cnkge1xuICAgICAgLy8gUGFyc2UgdGhlIGNhcHMgaW50byBhIGZvcm1hdCB0aGF0IHRoZSBJbm5lckRyaXZlciB3aWxsIGFjY2VwdFxuICAgICAgY29uc3QgcGFyc2VkQ2FwcyA9IHBhcnNlQ2Fwc0ZvcklubmVyRHJpdmVyKFxuICAgICAgICBqc29ud3BDYXBzLFxuICAgICAgICB3M2NDYXBhYmlsaXRpZXMsXG4gICAgICAgIHRoaXMuZGVzaXJlZENhcENvbnN0cmFpbnRzLFxuICAgICAgICBkZWZhdWx0Q2FwYWJpbGl0aWVzXG4gICAgICApO1xuXG4gICAgICBsZXQge2Rlc2lyZWRDYXBzLCBwcm9jZXNzZWRKc29ud3BDYXBhYmlsaXRpZXMsIHByb2Nlc3NlZFczQ0NhcGFiaWxpdGllcywgZXJyb3J9ID0gcGFyc2VkQ2FwcztcbiAgICAgIHByb3RvY29sID0gcGFyc2VkQ2Fwcy5wcm90b2NvbDtcblxuICAgICAgLy8gSWYgdGhlIHBhcnNpbmcgb2YgdGhlIGNhcHMgcHJvZHVjZWQgYW4gZXJyb3IsIHRocm93IGl0IGluIGhlcmVcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgSW5uZXJEcml2ZXIgPSB0aGlzLmdldERyaXZlckZvckNhcHMoZGVzaXJlZENhcHMpO1xuICAgICAgdGhpcy5wcmludE5ld1Nlc3Npb25Bbm5vdW5jZW1lbnQoSW5uZXJEcml2ZXIsIGRlc2lyZWRDYXBzKTtcblxuICAgICAgaWYgKHRoaXMuYXJncy5zZXNzaW9uT3ZlcnJpZGUpIHtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbklkc1RvRGVsZXRlID0gYXdhaXQgc2Vzc2lvbnNMaXN0R3VhcmQuYWNxdWlyZShBcHBpdW1Ecml2ZXIubmFtZSwgKCkgPT4gXy5rZXlzKHRoaXMuc2Vzc2lvbnMpKTtcbiAgICAgICAgaWYgKHNlc3Npb25JZHNUb0RlbGV0ZS5sZW5ndGgpIHtcbiAgICAgICAgICBsb2cuaW5mbyhgU2Vzc2lvbiBvdmVycmlkZSBpcyBvbi4gRGVsZXRpbmcgb3RoZXIgJHtzZXNzaW9uSWRzVG9EZWxldGUubGVuZ3RofSBhY3RpdmUgc2Vzc2lvbiR7c2Vzc2lvbklkc1RvRGVsZXRlLmxlbmd0aCA/ICcnIDogJ3MnfS5gKTtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgQi5tYXAoc2Vzc2lvbklkc1RvRGVsZXRlLCAoaWQpID0+IHRoaXMuZGVsZXRlU2Vzc2lvbihpZCkpO1xuICAgICAgICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBsZXQgcnVubmluZ0RyaXZlcnNEYXRhLCBvdGhlclBlbmRpbmdEcml2ZXJzRGF0YTtcbiAgICAgIGNvbnN0IGQgPSBuZXcgSW5uZXJEcml2ZXIodGhpcy5hcmdzKTtcbiAgICAgIGlmICh0aGlzLmFyZ3MucmVsYXhlZFNlY3VyaXR5RW5hYmxlZCkge1xuICAgICAgICBsb2cuaW5mbyhgQXBwbHlpbmcgcmVsYXhlZCBzZWN1cml0eSB0byAnJHtJbm5lckRyaXZlci5uYW1lfScgYXMgcGVyIHNlcnZlciBjb21tYW5kIGxpbmUgYXJndW1lbnRgKTtcbiAgICAgICAgZC5yZWxheGVkU2VjdXJpdHlFbmFibGVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIC8vIFRoaXMgYXNzaWdubWVudCBpcyByZXF1aXJlZCBmb3IgY29ycmVjdCB3ZWIgc29ja2V0cyBmdW5jdGlvbmFsaXR5IGluc2lkZSB0aGUgZHJpdmVyXG4gICAgICBkLnNlcnZlciA9IHRoaXMuc2VydmVyO1xuICAgICAgdHJ5IHtcbiAgICAgICAgcnVubmluZ0RyaXZlcnNEYXRhID0gYXdhaXQgdGhpcy5jdXJTZXNzaW9uRGF0YUZvckRyaXZlcihJbm5lckRyaXZlcik7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRocm93IG5ldyBlcnJvcnMuU2Vzc2lvbk5vdENyZWF0ZWRFcnJvcihlLm1lc3NhZ2UpO1xuICAgICAgfVxuICAgICAgYXdhaXQgcGVuZGluZ0RyaXZlcnNHdWFyZC5hY3F1aXJlKEFwcGl1bURyaXZlci5uYW1lLCAoKSA9PiB7XG4gICAgICAgIHRoaXMucGVuZGluZ0RyaXZlcnNbSW5uZXJEcml2ZXIubmFtZV0gPSB0aGlzLnBlbmRpbmdEcml2ZXJzW0lubmVyRHJpdmVyLm5hbWVdIHx8IFtdO1xuICAgICAgICBvdGhlclBlbmRpbmdEcml2ZXJzRGF0YSA9IHRoaXMucGVuZGluZ0RyaXZlcnNbSW5uZXJEcml2ZXIubmFtZV0ubWFwKChkcnYpID0+IGRydi5kcml2ZXJEYXRhKTtcbiAgICAgICAgdGhpcy5wZW5kaW5nRHJpdmVyc1tJbm5lckRyaXZlci5uYW1lXS5wdXNoKGQpO1xuICAgICAgfSk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIFtpbm5lclNlc3Npb25JZCwgZENhcHNdID0gYXdhaXQgZC5jcmVhdGVTZXNzaW9uKFxuICAgICAgICAgIHByb2Nlc3NlZEpzb253cENhcGFiaWxpdGllcyxcbiAgICAgICAgICByZXFDYXBzLFxuICAgICAgICAgIHByb2Nlc3NlZFczQ0NhcGFiaWxpdGllcyxcbiAgICAgICAgICBbLi4ucnVubmluZ0RyaXZlcnNEYXRhLCAuLi5vdGhlclBlbmRpbmdEcml2ZXJzRGF0YV1cbiAgICAgICAgKTtcbiAgICAgICAgcHJvdG9jb2wgPSBkLnByb3RvY29sO1xuICAgICAgICBhd2FpdCBzZXNzaW9uc0xpc3RHdWFyZC5hY3F1aXJlKEFwcGl1bURyaXZlci5uYW1lLCAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5zZXNzaW9uc1tpbm5lclNlc3Npb25JZF0gPSBkO1xuICAgICAgICB9KTtcbiAgICAgIH0gZmluYWxseSB7XG4gICAgICAgIGF3YWl0IHBlbmRpbmdEcml2ZXJzR3VhcmQuYWNxdWlyZShBcHBpdW1Ecml2ZXIubmFtZSwgKCkgPT4ge1xuICAgICAgICAgIF8ucHVsbCh0aGlzLnBlbmRpbmdEcml2ZXJzW0lubmVyRHJpdmVyLm5hbWVdLCBkKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIHRoaXMgaXMgYW4gYXN5bmMgZnVuY3Rpb24gYnV0IHdlIGRvbid0IGF3YWl0IGl0IGJlY2F1c2UgaXQgaGFuZGxlc1xuICAgICAgLy8gYW4gb3V0LW9mLWJhbmQgcHJvbWlzZSB3aGljaCBpcyBmdWxmaWxsZWQgaWYgdGhlIGlubmVyIGRyaXZlclxuICAgICAgLy8gdW5leHBlY3RlZGx5IHNodXRzIGRvd25cbiAgICAgIHRoaXMuYXR0YWNoVW5leHBlY3RlZFNodXRkb3duSGFuZGxlcihkLCBpbm5lclNlc3Npb25JZCk7XG5cblxuICAgICAgbG9nLmluZm8oYE5ldyAke0lubmVyRHJpdmVyLm5hbWV9IHNlc3Npb24gY3JlYXRlZCBzdWNjZXNzZnVsbHksIHNlc3Npb24gYCArXG4gICAgICAgICAgICAgIGAke2lubmVyU2Vzc2lvbklkfSBhZGRlZCB0byBtYXN0ZXIgc2Vzc2lvbiBsaXN0YCk7XG5cbiAgICAgIC8vIHNldCB0aGUgTmV3IENvbW1hbmQgVGltZW91dCBmb3IgdGhlIGlubmVyIGRyaXZlclxuICAgICAgZC5zdGFydE5ld0NvbW1hbmRUaW1lb3V0KCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHByb3RvY29sLFxuICAgICAgICBlcnJvcixcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHByb3RvY29sLFxuICAgICAgdmFsdWU6IFtpbm5lclNlc3Npb25JZCwgZENhcHMsIHByb3RvY29sXVxuICAgIH07XG4gIH1cblxuICBhc3luYyBhdHRhY2hVbmV4cGVjdGVkU2h1dGRvd25IYW5kbGVyIChkcml2ZXIsIGlubmVyU2Vzc2lvbklkKSB7XG4gICAgLy8gUmVtb3ZlIHRoZSBzZXNzaW9uIG9uIHVuZXhwZWN0ZWQgc2h1dGRvd24sIHNvIHRoYXQgd2UgYXJlIGluIGEgcG9zaXRpb25cbiAgICAvLyB0byBvcGVuIGFub3RoZXIgc2Vzc2lvbiBsYXRlciBvbi5cbiAgICAvLyBUT0RPOiB0aGlzIHNob3VsZCBiZSByZW1vdmVkIGFuZCByZXBsYWNlZCBieSBhIG9uU2h1dGRvd24gY2FsbGJhY2suXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGRyaXZlci5vblVuZXhwZWN0ZWRTaHV0ZG93bjsgLy8gdGhpcyBpcyBhIGNhbmNlbGxhYmxlIHByb21pc2VcbiAgICAgIC8vIGlmIHdlIGdldCBoZXJlLCB3ZSd2ZSBoYWQgYW4gdW5leHBlY3RlZCBzaHV0ZG93biwgc28gZXJyb3JcbiAgICAgIHRocm93IG5ldyBFcnJvcignVW5leHBlY3RlZCBzaHV0ZG93bicpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlIGluc3RhbmNlb2YgQi5DYW5jZWxsYXRpb25FcnJvcikge1xuICAgICAgICAvLyBpZiB3ZSBjYW5jZWxsZWQgdGhlIHVuZXhwZWN0ZWQgc2h1dGRvd24gcHJvbWlzZSwgdGhhdCBtZWFucyB3ZVxuICAgICAgICAvLyBubyBsb25nZXIgY2FyZSBhYm91dCBpdCwgYW5kIGNhbiBzYWZlbHkgaWdub3JlIGl0XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGxvZy53YXJuKGBDbG9zaW5nIHNlc3Npb24sIGNhdXNlIHdhcyAnJHtlLm1lc3NhZ2V9J2ApO1xuICAgICAgbG9nLmluZm8oYFJlbW92aW5nIHNlc3Npb24gJHtpbm5lclNlc3Npb25JZH0gZnJvbSBvdXIgbWFzdGVyIHNlc3Npb24gbGlzdGApO1xuICAgICAgYXdhaXQgc2Vzc2lvbnNMaXN0R3VhcmQuYWNxdWlyZShBcHBpdW1Ecml2ZXIubmFtZSwgKCkgPT4ge1xuICAgICAgICBkZWxldGUgdGhpcy5zZXNzaW9uc1tpbm5lclNlc3Npb25JZF07XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjdXJTZXNzaW9uRGF0YUZvckRyaXZlciAoSW5uZXJEcml2ZXIpIHtcbiAgICBjb25zdCBzZXNzaW9ucyA9IGF3YWl0IHNlc3Npb25zTGlzdEd1YXJkLmFjcXVpcmUoQXBwaXVtRHJpdmVyLm5hbWUsICgpID0+IHRoaXMuc2Vzc2lvbnMpO1xuICAgIGNvbnN0IGRhdGEgPSBfLnZhbHVlcyhzZXNzaW9ucylcbiAgICAgICAgICAgICAgICAgICAuZmlsdGVyKChzKSA9PiBzLmNvbnN0cnVjdG9yLm5hbWUgPT09IElubmVyRHJpdmVyLm5hbWUpXG4gICAgICAgICAgICAgICAgICAgLm1hcCgocykgPT4gcy5kcml2ZXJEYXRhKTtcbiAgICBmb3IgKGxldCBkYXR1bSBvZiBkYXRhKSB7XG4gICAgICBpZiAoIWRhdHVtKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgUHJvYmxlbSBnZXR0aW5nIHNlc3Npb24gZGF0YSBmb3IgZHJpdmVyIHR5cGUgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgJHtJbm5lckRyaXZlci5uYW1lfTsgZG9lcyBpdCBpbXBsZW1lbnQgJ2dldCBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgIGBkcml2ZXJEYXRhJz9gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uIChzZXNzaW9uSWQpIHtcbiAgICBsZXQgcHJvdG9jb2w7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBvdGhlclNlc3Npb25zRGF0YSA9IG51bGw7XG4gICAgICBsZXQgZHN0U2Vzc2lvbiA9IG51bGw7XG4gICAgICBhd2FpdCBzZXNzaW9uc0xpc3RHdWFyZC5hY3F1aXJlKEFwcGl1bURyaXZlci5uYW1lLCAoKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5zZXNzaW9uc1tzZXNzaW9uSWRdKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGN1ckNvbnN0cnVjdG9yTmFtZSA9IHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbklkXS5jb25zdHJ1Y3Rvci5uYW1lO1xuICAgICAgICBvdGhlclNlc3Npb25zRGF0YSA9IF8udG9QYWlycyh0aGlzLnNlc3Npb25zKVxuICAgICAgICAgICAgICAuZmlsdGVyKChba2V5LCB2YWx1ZV0pID0+IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgPT09IGN1ckNvbnN0cnVjdG9yTmFtZSAmJiBrZXkgIT09IHNlc3Npb25JZClcbiAgICAgICAgICAgICAgLm1hcCgoWywgdmFsdWVdKSA9PiB2YWx1ZS5kcml2ZXJEYXRhKTtcbiAgICAgICAgZHN0U2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbklkXTtcbiAgICAgICAgcHJvdG9jb2wgPSBkc3RTZXNzaW9uLnByb3RvY29sO1xuICAgICAgICBsb2cuaW5mbyhgUmVtb3Zpbmcgc2Vzc2lvbiAke3Nlc3Npb25JZH0gZnJvbSBvdXIgbWFzdGVyIHNlc3Npb24gbGlzdGApO1xuICAgICAgICAvLyByZWdhcmRsZXNzIG9mIHdoZXRoZXIgdGhlIGRlbGV0ZVNlc3Npb24gY29tcGxldGVzIHN1Y2Nlc3NmdWxseSBvciBub3RcbiAgICAgICAgLy8gbWFrZSB0aGUgc2Vzc2lvbiB1bmF2YWlsYWJsZSwgYmVjYXVzZSB3aG8ga25vd3Mgd2hhdCBzdGF0ZSBpdCBtaWdodFxuICAgICAgICAvLyBiZSBpbiBvdGhlcndpc2VcbiAgICAgICAgZGVsZXRlIHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbklkXTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcHJvdG9jb2wsXG4gICAgICAgIHZhbHVlOiBhd2FpdCBkc3RTZXNzaW9uLmRlbGV0ZVNlc3Npb24oc2Vzc2lvbklkLCBvdGhlclNlc3Npb25zRGF0YSksXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy5lcnJvcihgSGFkIHRyb3VibGUgZW5kaW5nIHNlc3Npb24gJHtzZXNzaW9uSWR9OiAke2UubWVzc2FnZX1gKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHByb3RvY29sLFxuICAgICAgICBlcnJvcjogZSxcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZUNvbW1hbmQgKGNtZCwgLi4uYXJncykge1xuICAgIC8vIGdldFN0YXR1cyBjb21tYW5kIHNob3VsZCBub3QgYmUgcHV0IGludG8gcXVldWUuIElmIHdlIGRvIGl0IGFzIHBhcnQgb2Ygc3VwZXIuZXhlY3V0ZUNvbW1hbmQsIGl0IHdpbGwgYmUgYWRkZWQgdG8gcXVldWUuXG4gICAgLy8gVGhlcmUgd2lsbCBiZSBsb3Qgb2Ygc3RhdHVzIGNvbW1hbmRzIGluIHF1ZXVlIGR1cmluZyBjcmVhdGVTZXNzaW9uIGNvbW1hbmQsIGFzIGNyZWF0ZVNlc3Npb24gY2FuIHRha2UgdXAgdG8gb3IgbW9yZSB0aGFuIGEgbWludXRlLlxuICAgIGlmIChjbWQgPT09ICdnZXRTdGF0dXMnKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRTdGF0dXMoKTtcbiAgICB9XG5cbiAgICBpZiAoaXNBcHBpdW1Ecml2ZXJDb21tYW5kKGNtZCkpIHtcbiAgICAgIHJldHVybiBhd2FpdCBzdXBlci5leGVjdXRlQ29tbWFuZChjbWQsIC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIGNvbnN0IHNlc3Npb25JZCA9IF8ubGFzdChhcmdzKTtcbiAgICBjb25zdCBkc3RTZXNzaW9uID0gYXdhaXQgc2Vzc2lvbnNMaXN0R3VhcmQuYWNxdWlyZShBcHBpdW1Ecml2ZXIubmFtZSwgKCkgPT4gdGhpcy5zZXNzaW9uc1tzZXNzaW9uSWRdKTtcbiAgICBpZiAoIWRzdFNlc3Npb24pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHNlc3Npb24gd2l0aCBpZCAnJHtzZXNzaW9uSWR9JyBkb2VzIG5vdCBleGlzdGApO1xuICAgIH1cblxuICAgIGxldCByZXMgPSB7XG4gICAgICBwcm90b2NvbDogZHN0U2Vzc2lvbi5wcm90b2NvbFxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgcmVzLnZhbHVlID0gYXdhaXQgZHN0U2Vzc2lvbi5leGVjdXRlQ29tbWFuZChjbWQsIC4uLmFyZ3MpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJlcy5lcnJvciA9IGU7XG4gICAgfVxuICAgIHJldHVybiByZXM7XG4gIH1cblxuICBwcm94eUFjdGl2ZSAoc2Vzc2lvbklkKSB7XG4gICAgY29uc3QgZHN0U2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbnNbc2Vzc2lvbklkXTtcbiAgICByZXR1cm4gZHN0U2Vzc2lvbiAmJiBfLmlzRnVuY3Rpb24oZHN0U2Vzc2lvbi5wcm94eUFjdGl2ZSkgJiYgZHN0U2Vzc2lvbi5wcm94eUFjdGl2ZShzZXNzaW9uSWQpO1xuICB9XG5cbiAgZ2V0UHJveHlBdm9pZExpc3QgKHNlc3Npb25JZCkge1xuICAgIGNvbnN0IGRzdFNlc3Npb24gPSB0aGlzLnNlc3Npb25zW3Nlc3Npb25JZF07XG4gICAgcmV0dXJuIGRzdFNlc3Npb24gPyBkc3RTZXNzaW9uLmdldFByb3h5QXZvaWRMaXN0KCkgOiBbXTtcbiAgfVxuXG4gIGNhblByb3h5IChzZXNzaW9uSWQpIHtcbiAgICBjb25zdCBkc3RTZXNzaW9uID0gdGhpcy5zZXNzaW9uc1tzZXNzaW9uSWRdO1xuICAgIHJldHVybiBkc3RTZXNzaW9uICYmIGRzdFNlc3Npb24uY2FuUHJveHkoc2Vzc2lvbklkKTtcbiAgfVxufVxuXG4vLyBoZWxwIGRlY2lkZSB3aGljaCBjb21tYW5kcyBzaG91bGQgYmUgcHJveGllZCB0byBzdWItZHJpdmVycyBhbmQgd2hpY2hcbi8vIHNob3VsZCBiZSBoYW5kbGVkIGJ5IHRoaXMsIG91ciB1bWJyZWxsYSBkcml2ZXJcbmZ1bmN0aW9uIGlzQXBwaXVtRHJpdmVyQ29tbWFuZCAoY21kKSB7XG4gIHJldHVybiAhaXNTZXNzaW9uQ29tbWFuZChjbWQpIHx8IGNtZCA9PT0gXCJkZWxldGVTZXNzaW9uXCI7XG59XG5cbmV4cG9ydCB7IEFwcGl1bURyaXZlciB9O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
