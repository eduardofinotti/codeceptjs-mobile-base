'use strict';

var _extends = require('babel-runtime/helpers/extends')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _toConsumableArray = require('babel-runtime/helpers/to-consumable-array')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumBaseDriver = require('appium-base-driver');

var _findRoot = require('find-root');

var _findRoot2 = _interopRequireDefault(_findRoot);

var W3C_APPIUM_PREFIX = 'appium';

function inspectObject(args) {
  function getValueArray(obj) {
    var indent = arguments.length <= 1 || arguments[1] === undefined ? '  ' : arguments[1];

    if (!_lodash2['default'].isObject(obj)) {
      return [obj];
    }

    var strArr = ['{'];
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = _getIterator(_lodash2['default'].toPairs(obj)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var _step$value = _slicedToArray(_step.value, 2);

        var arg = _step$value[0];
        var value = _step$value[1];

        if (!_lodash2['default'].isObject(value)) {
          strArr.push(indent + '  ' + arg + ': ' + value);
        } else {
          value = getValueArray(value, indent + '  ');
          strArr.push(indent + '  ' + arg + ': ' + value.shift());
          strArr.push.apply(strArr, _toConsumableArray(value));
        }
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    strArr.push(indent + '}');
    return strArr;
  }
  var _iteratorNormalCompletion2 = true;
  var _didIteratorError2 = false;
  var _iteratorError2 = undefined;

  try {
    for (var _iterator2 = _getIterator(_lodash2['default'].toPairs(args)), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
      var _step2$value = _slicedToArray(_step2.value, 2);

      var arg = _step2$value[0];
      var value = _step2$value[1];

      value = getValueArray(value);
      _logger2['default'].info('  ' + arg + ': ' + value.shift());
      var _iteratorNormalCompletion3 = true;
      var _didIteratorError3 = false;
      var _iteratorError3 = undefined;

      try {
        for (var _iterator3 = _getIterator(value), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
          var val = _step3.value;

          _logger2['default'].info(val);
        }
      } catch (err) {
        _didIteratorError3 = true;
        _iteratorError3 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion3 && _iterator3['return']) {
            _iterator3['return']();
          }
        } finally {
          if (_didIteratorError3) {
            throw _iteratorError3;
          }
        }
      }
    }
  } catch (err) {
    _didIteratorError2 = true;
    _iteratorError2 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion2 && _iterator2['return']) {
        _iterator2['return']();
      }
    } finally {
      if (_didIteratorError2) {
        throw _iteratorError2;
      }
    }
  }
}

/**
 * Takes the caps that were provided in the request and translates them
 * into caps that can be used by the inner drivers.
 *
 * @param {Object} jsonwpCapabilities
 * @param {Object} w3cCapabilities
 * @param {Object} constraints
 * @param {Object} defaultCapabilities
 */
function parseCapsForInnerDriver(jsonwpCapabilities, w3cCapabilities) {
  var constraints = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];
  var defaultCapabilities = arguments.length <= 3 || arguments[3] === undefined ? {} : arguments[3];

  // Check if the caller sent JSONWP caps, W3C caps, or both
  var hasW3CCaps = _lodash2['default'].isPlainObject(w3cCapabilities) && (_lodash2['default'].has(w3cCapabilities, 'alwaysMatch') || _lodash2['default'].has(w3cCapabilities, 'firstMatch'));
  var hasJSONWPCaps = _lodash2['default'].isPlainObject(jsonwpCapabilities);
  var protocol = null;
  var desiredCaps = {};
  var processedW3CCapabilities = null;
  var processedJsonwpCapabilities = null;

  if (!hasJSONWPCaps && !hasW3CCaps) {
    return {
      protocol: _appiumBaseDriver.BaseDriver.DRIVER_PROTOCOL.W3C,
      error: new Error('Either JSONWP or W3C capabilities should be provided')
    };
  }

  var _BaseDriver$DRIVER_PROTOCOL = _appiumBaseDriver.BaseDriver.DRIVER_PROTOCOL;
  var W3C = _BaseDriver$DRIVER_PROTOCOL.W3C;
  var MJSONWP = _BaseDriver$DRIVER_PROTOCOL.MJSONWP;

  // Make copies of the capabilities that include the default capabilities
  if (hasW3CCaps) {
    w3cCapabilities = _extends({}, w3cCapabilities, {
      alwaysMatch: _extends({}, defaultCapabilities, w3cCapabilities.alwaysMatch)
    });
  }

  if (hasJSONWPCaps) {
    jsonwpCapabilities = _extends({}, defaultCapabilities, jsonwpCapabilities);
  }

  // Get MJSONWP caps
  if (hasJSONWPCaps) {
    protocol = MJSONWP;
    desiredCaps = jsonwpCapabilities;
    processedJsonwpCapabilities = removeW3CPrefixes(_extends({}, desiredCaps));
  }

  // Get W3C caps
  if (hasW3CCaps) {
    protocol = W3C;
    // Call the process capabilities algorithm to find matching caps on the W3C
    // (see: https://github.com/jlipps/simple-wd-spec#processing-capabilities)
    var isFixingNeededForW3cCaps = false;
    try {
      desiredCaps = (0, _appiumBaseDriver.processCapabilities)(w3cCapabilities, constraints, true);
    } catch (error) {
      if (!hasJSONWPCaps) {
        return {
          desiredCaps: desiredCaps,
          processedJsonwpCapabilities: processedJsonwpCapabilities,
          processedW3CCapabilities: processedW3CCapabilities,
          protocol: protocol,
          error: error
        };
      }
      _logger2['default'].info('Could not parse W3C capabilities: ' + error.message);
      isFixingNeededForW3cCaps = true;
    }

    if (hasJSONWPCaps && !isFixingNeededForW3cCaps) {
      var differingKeys = _lodash2['default'].difference(_lodash2['default'].keys(processedJsonwpCapabilities), _lodash2['default'].keys(removeW3CPrefixes(desiredCaps)));
      if (!_lodash2['default'].isEmpty(differingKeys)) {
        _logger2['default'].info('The following capabilities were provided in the JSONWP desired capabilities that are missing ' + ('in W3C capabilities: ' + JSON.stringify(differingKeys)));
        isFixingNeededForW3cCaps = true;
      }
    }

    if (isFixingNeededForW3cCaps && hasJSONWPCaps) {
      _logger2['default'].info('Trying to fix W3C capabilities by merging them with JSONWP caps');
      w3cCapabilities = fixW3cCapabilities(w3cCapabilities, jsonwpCapabilities);
      try {
        desiredCaps = (0, _appiumBaseDriver.processCapabilities)(w3cCapabilities, constraints, true);
      } catch (error) {
        _logger2['default'].warn('Could not parse fixed W3C capabilities: ' + error.message + '. Falling back to JSONWP protocol');
        return {
          desiredCaps: processedJsonwpCapabilities,
          processedJsonwpCapabilities: processedJsonwpCapabilities,
          processedW3CCapabilities: null,
          protocol: MJSONWP
        };
      }
    }

    // Create a new w3c capabilities payload that contains only the matching caps in `alwaysMatch`
    processedW3CCapabilities = {
      alwaysMatch: _extends({}, insertAppiumPrefixes(desiredCaps)),
      firstMatch: [{}]
    };
  }

  return { desiredCaps: desiredCaps, processedJsonwpCapabilities: processedJsonwpCapabilities, processedW3CCapabilities: processedW3CCapabilities, protocol: protocol };
}

/**
 * This helper method tries to fix corrupted W3C capabilities by
 * merging them to existing JSONWP capabilities.
 *
 * @param {Object} w3cCaps W3C capabilities
 * @param {Object} jsonwpCaps JSONWP capabilities
 * @returns {Object} Fixed W3C capabilities
 */
function fixW3cCapabilities(w3cCaps, jsonwpCaps) {
  var result = {
    firstMatch: w3cCaps.firstMatch || [],
    alwaysMatch: w3cCaps.alwaysMatch || {}
  };
  var keysToInsert = _lodash2['default'].keys(jsonwpCaps);
  var removeMatchingKeys = function removeMatchingKeys(match) {
    _lodash2['default'].pull(keysToInsert, match);
    var colonIndex = match.indexOf(':');
    if (colonIndex >= 0 && match.length > colonIndex) {
      _lodash2['default'].pull(keysToInsert, match.substring(colonIndex + 1));
    }
    if (keysToInsert.includes(W3C_APPIUM_PREFIX + ':' + match)) {
      _lodash2['default'].pull(keysToInsert, W3C_APPIUM_PREFIX + ':' + match);
    }
  };

  var _iteratorNormalCompletion4 = true;
  var _didIteratorError4 = false;
  var _iteratorError4 = undefined;

  try {
    for (var _iterator4 = _getIterator(result.firstMatch), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
      var firstMatchEntry = _step4.value;
      var _iteratorNormalCompletion7 = true;
      var _didIteratorError7 = false;
      var _iteratorError7 = undefined;

      try {
        for (var _iterator7 = _getIterator(_lodash2['default'].toPairs(firstMatchEntry)), _step7; !(_iteratorNormalCompletion7 = (_step7 = _iterator7.next()).done); _iteratorNormalCompletion7 = true) {
          var pair = _step7.value;

          removeMatchingKeys(pair[0]);
        }
      } catch (err) {
        _didIteratorError7 = true;
        _iteratorError7 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion7 && _iterator7['return']) {
            _iterator7['return']();
          }
        } finally {
          if (_didIteratorError7) {
            throw _iteratorError7;
          }
        }
      }
    }
  } catch (err) {
    _didIteratorError4 = true;
    _iteratorError4 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion4 && _iterator4['return']) {
        _iterator4['return']();
      }
    } finally {
      if (_didIteratorError4) {
        throw _iteratorError4;
      }
    }
  }

  var _iteratorNormalCompletion5 = true;
  var _didIteratorError5 = false;
  var _iteratorError5 = undefined;

  try {
    for (var _iterator5 = _getIterator(_lodash2['default'].toPairs(result.alwaysMatch)), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
      var pair = _step5.value;

      removeMatchingKeys(pair[0]);
    }
  } catch (err) {
    _didIteratorError5 = true;
    _iteratorError5 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion5 && _iterator5['return']) {
        _iterator5['return']();
      }
    } finally {
      if (_didIteratorError5) {
        throw _iteratorError5;
      }
    }
  }

  var _iteratorNormalCompletion6 = true;
  var _didIteratorError6 = false;
  var _iteratorError6 = undefined;

  try {
    for (var _iterator6 = _getIterator(keysToInsert), _step6; !(_iteratorNormalCompletion6 = (_step6 = _iterator6.next()).done); _iteratorNormalCompletion6 = true) {
      var key = _step6.value;

      result.alwaysMatch[key] = jsonwpCaps[key];
    }
  } catch (err) {
    _didIteratorError6 = true;
    _iteratorError6 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion6 && _iterator6['return']) {
        _iterator6['return']();
      }
    } finally {
      if (_didIteratorError6) {
        throw _iteratorError6;
      }
    }
  }

  return result;
}

/**
 * Takes a capabilities objects and prefixes capabilities with `appium:`
 * @param {Object} caps Desired capabilities object
 */
function insertAppiumPrefixes(caps) {
  // Standard, non-prefixed capabilities (see https://www.w3.org/TR/webdriver/#dfn-table-of-standard-capabilities)
  var STANDARD_CAPS = ['browserName', 'browserVersion', 'platformName', 'acceptInsecureCerts', 'pageLoadStrategy', 'proxy', 'setWindowRect', 'timeouts', 'unhandledPromptBehavior'];

  var prefixedCaps = {};
  var _iteratorNormalCompletion8 = true;
  var _didIteratorError8 = false;
  var _iteratorError8 = undefined;

  try {
    for (var _iterator8 = _getIterator(_lodash2['default'].toPairs(caps)), _step8; !(_iteratorNormalCompletion8 = (_step8 = _iterator8.next()).done); _iteratorNormalCompletion8 = true) {
      var _step8$value = _slicedToArray(_step8.value, 2);

      var _name = _step8$value[0];
      var value = _step8$value[1];

      if (STANDARD_CAPS.includes(_name) || _name.includes(':')) {
        prefixedCaps[_name] = value;
      } else {
        prefixedCaps[W3C_APPIUM_PREFIX + ':' + _name] = value;
      }
    }
  } catch (err) {
    _didIteratorError8 = true;
    _iteratorError8 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion8 && _iterator8['return']) {
        _iterator8['return']();
      }
    } finally {
      if (_didIteratorError8) {
        throw _iteratorError8;
      }
    }
  }

  return prefixedCaps;
}

function removeW3CPrefixes(caps) {
  if (!_lodash2['default'].isPlainObject(caps)) {
    return caps;
  }

  var fixedCaps = {};
  var _iteratorNormalCompletion9 = true;
  var _didIteratorError9 = false;
  var _iteratorError9 = undefined;

  try {
    for (var _iterator9 = _getIterator(_lodash2['default'].toPairs(caps)), _step9; !(_iteratorNormalCompletion9 = (_step9 = _iterator9.next()).done); _iteratorNormalCompletion9 = true) {
      var _step9$value = _slicedToArray(_step9.value, 2);

      var _name2 = _step9$value[0];
      var value = _step9$value[1];

      var colonPos = _name2.indexOf(':');
      var key = colonPos > 0 ? _name2.substring(colonPos + 1) : _name2;
      fixedCaps[key] = value;
    }
  } catch (err) {
    _didIteratorError9 = true;
    _iteratorError9 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion9 && _iterator9['return']) {
        _iterator9['return']();
      }
    } finally {
      if (_didIteratorError9) {
        throw _iteratorError9;
      }
    }
  }

  return fixedCaps;
}

function getPackageVersion(pkgName) {
  var pkgInfo = require(pkgName + '/package.json') || {};
  return pkgInfo.version;
}

var rootDir = (0, _findRoot2['default'])(__dirname);

exports.inspectObject = inspectObject;
exports.parseCapsForInnerDriver = parseCapsForInnerDriver;
exports.insertAppiumPrefixes = insertAppiumPrefixes;
exports.rootDir = rootDir;
exports.getPackageVersion = getPackageVersion;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QU0sR0FBRyxHQUFHLFFBQVEsR0FBRyxDQUFDLEdBQUcsTUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLEdBQUcsTUFBSSxDQUFDO0FBQy9ELGVBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7S0FDeEI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDRCxTQUFPLFNBQVMsQ0FBQztDQUNsQjs7QUFFRCxTQUFTLGlCQUFpQixDQUFFLE9BQU8sRUFBRTtBQUNuQyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUksT0FBTyxtQkFBZ0IsSUFBSSxFQUFFLENBQUM7QUFDekQsU0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDO0NBQ3hCOztBQUVELElBQU0sT0FBTyxHQUFHLDJCQUFTLFNBQVMsQ0FBQyxDQUFDOztRQUUzQixhQUFhLEdBQWIsYUFBYTtRQUFFLHVCQUF1QixHQUF2Qix1QkFBdUI7UUFBRSxvQkFBb0IsR0FBcEIsb0JBQW9CO1FBQUUsT0FBTyxHQUFQLE9BQU87UUFDckUsaUJBQWlCLEdBQWpCLGlCQUFpQiIsImZpbGUiOiJsaWIvdXRpbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBwcm9jZXNzQ2FwYWJpbGl0aWVzLCBCYXNlRHJpdmVyIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBmaW5kUm9vdCBmcm9tICdmaW5kLXJvb3QnO1xuXG5jb25zdCBXM0NfQVBQSVVNX1BSRUZJWCA9ICdhcHBpdW0nO1xuXG5mdW5jdGlvbiBpbnNwZWN0T2JqZWN0IChhcmdzKSB7XG4gIGZ1bmN0aW9uIGdldFZhbHVlQXJyYXkgKG9iaiwgaW5kZW50ID0gJyAgJykge1xuICAgIGlmICghXy5pc09iamVjdChvYmopKSB7XG4gICAgICByZXR1cm4gW29ial07XG4gICAgfVxuXG4gICAgbGV0IHN0ckFyciA9IFsneyddO1xuICAgIGZvciAobGV0IFthcmcsIHZhbHVlXSBvZiBfLnRvUGFpcnMob2JqKSkge1xuICAgICAgaWYgKCFfLmlzT2JqZWN0KHZhbHVlKSkge1xuICAgICAgICBzdHJBcnIucHVzaChgJHtpbmRlbnR9ICAke2FyZ306ICR7dmFsdWV9YCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YWx1ZSA9IGdldFZhbHVlQXJyYXkodmFsdWUsIGAke2luZGVudH0gIGApO1xuICAgICAgICBzdHJBcnIucHVzaChgJHtpbmRlbnR9ICAke2FyZ306ICR7dmFsdWUuc2hpZnQoKX1gKTtcbiAgICAgICAgc3RyQXJyLnB1c2goLi4udmFsdWUpO1xuICAgICAgfVxuICAgIH1cbiAgICBzdHJBcnIucHVzaChgJHtpbmRlbnR9fWApO1xuICAgIHJldHVybiBzdHJBcnI7XG4gIH1cbiAgZm9yIChsZXQgW2FyZywgdmFsdWVdIG9mIF8udG9QYWlycyhhcmdzKSkge1xuICAgIHZhbHVlID0gZ2V0VmFsdWVBcnJheSh2YWx1ZSk7XG4gICAgbG9nZ2VyLmluZm8oYCAgJHthcmd9OiAke3ZhbHVlLnNoaWZ0KCl9YCk7XG4gICAgZm9yIChsZXQgdmFsIG9mIHZhbHVlKSB7XG4gICAgICBsb2dnZXIuaW5mbyh2YWwpO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIFRha2VzIHRoZSBjYXBzIHRoYXQgd2VyZSBwcm92aWRlZCBpbiB0aGUgcmVxdWVzdCBhbmQgdHJhbnNsYXRlcyB0aGVtXG4gKiBpbnRvIGNhcHMgdGhhdCBjYW4gYmUgdXNlZCBieSB0aGUgaW5uZXIgZHJpdmVycy5cbiAqXG4gKiBAcGFyYW0ge09iamVjdH0ganNvbndwQ2FwYWJpbGl0aWVzXG4gKiBAcGFyYW0ge09iamVjdH0gdzNjQ2FwYWJpbGl0aWVzXG4gKiBAcGFyYW0ge09iamVjdH0gY29uc3RyYWludHNcbiAqIEBwYXJhbSB7T2JqZWN0fSBkZWZhdWx0Q2FwYWJpbGl0aWVzXG4gKi9cbmZ1bmN0aW9uIHBhcnNlQ2Fwc0ZvcklubmVyRHJpdmVyIChqc29ud3BDYXBhYmlsaXRpZXMsIHczY0NhcGFiaWxpdGllcywgY29uc3RyYWludHMgPSB7fSwgZGVmYXVsdENhcGFiaWxpdGllcyA9IHt9KSB7XG4gIC8vIENoZWNrIGlmIHRoZSBjYWxsZXIgc2VudCBKU09OV1AgY2FwcywgVzNDIGNhcHMsIG9yIGJvdGhcbiAgY29uc3QgaGFzVzNDQ2FwcyA9IF8uaXNQbGFpbk9iamVjdCh3M2NDYXBhYmlsaXRpZXMpICYmXG4gICAgKF8uaGFzKHczY0NhcGFiaWxpdGllcywgJ2Fsd2F5c01hdGNoJykgfHwgXy5oYXModzNjQ2FwYWJpbGl0aWVzLCAnZmlyc3RNYXRjaCcpKTtcbiAgY29uc3QgaGFzSlNPTldQQ2FwcyA9IF8uaXNQbGFpbk9iamVjdChqc29ud3BDYXBhYmlsaXRpZXMpO1xuICBsZXQgcHJvdG9jb2wgPSBudWxsO1xuICBsZXQgZGVzaXJlZENhcHMgPSB7fTtcbiAgbGV0IHByb2Nlc3NlZFczQ0NhcGFiaWxpdGllcyA9IG51bGw7XG4gIGxldCBwcm9jZXNzZWRKc29ud3BDYXBhYmlsaXRpZXMgPSBudWxsO1xuXG4gIGlmICghaGFzSlNPTldQQ2FwcyAmJiAhaGFzVzNDQ2Fwcykge1xuICAgIHJldHVybiB7XG4gICAgICBwcm90b2NvbDogQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0wuVzNDLFxuICAgICAgZXJyb3I6IG5ldyBFcnJvcignRWl0aGVyIEpTT05XUCBvciBXM0MgY2FwYWJpbGl0aWVzIHNob3VsZCBiZSBwcm92aWRlZCcpLFxuICAgIH07XG4gIH1cblxuICBjb25zdCB7VzNDLCBNSlNPTldQfSA9IEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MO1xuXG4gIC8vIE1ha2UgY29waWVzIG9mIHRoZSBjYXBhYmlsaXRpZXMgdGhhdCBpbmNsdWRlIHRoZSBkZWZhdWx0IGNhcGFiaWxpdGllc1xuICBpZiAoaGFzVzNDQ2Fwcykge1xuICAgIHczY0NhcGFiaWxpdGllcyA9IHtcbiAgICAgIC4uLnczY0NhcGFiaWxpdGllcyxcbiAgICAgIGFsd2F5c01hdGNoOiB7XG4gICAgICAgIC4uLmRlZmF1bHRDYXBhYmlsaXRpZXMsXG4gICAgICAgIC4uLnczY0NhcGFiaWxpdGllcy5hbHdheXNNYXRjaCxcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIGlmIChoYXNKU09OV1BDYXBzKSB7XG4gICAganNvbndwQ2FwYWJpbGl0aWVzID0ge1xuICAgICAgLi4uZGVmYXVsdENhcGFiaWxpdGllcyxcbiAgICAgIC4uLmpzb253cENhcGFiaWxpdGllcyxcbiAgICB9O1xuICB9XG5cbiAgLy8gR2V0IE1KU09OV1AgY2Fwc1xuICBpZiAoaGFzSlNPTldQQ2Fwcykge1xuICAgIHByb3RvY29sID0gTUpTT05XUDtcbiAgICBkZXNpcmVkQ2FwcyA9IGpzb253cENhcGFiaWxpdGllcztcbiAgICBwcm9jZXNzZWRKc29ud3BDYXBhYmlsaXRpZXMgPSByZW1vdmVXM0NQcmVmaXhlcyh7Li4uZGVzaXJlZENhcHN9KTtcbiAgfVxuXG4gIC8vIEdldCBXM0MgY2Fwc1xuICBpZiAoaGFzVzNDQ2Fwcykge1xuICAgIHByb3RvY29sID0gVzNDO1xuICAgIC8vIENhbGwgdGhlIHByb2Nlc3MgY2FwYWJpbGl0aWVzIGFsZ29yaXRobSB0byBmaW5kIG1hdGNoaW5nIGNhcHMgb24gdGhlIFczQ1xuICAgIC8vIChzZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9qbGlwcHMvc2ltcGxlLXdkLXNwZWMjcHJvY2Vzc2luZy1jYXBhYmlsaXRpZXMpXG4gICAgbGV0IGlzRml4aW5nTmVlZGVkRm9yVzNjQ2FwcyA9IGZhbHNlO1xuICAgIHRyeSB7XG4gICAgICBkZXNpcmVkQ2FwcyA9IHByb2Nlc3NDYXBhYmlsaXRpZXModzNjQ2FwYWJpbGl0aWVzLCBjb25zdHJhaW50cywgdHJ1ZSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmICghaGFzSlNPTldQQ2Fwcykge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGRlc2lyZWRDYXBzLFxuICAgICAgICAgIHByb2Nlc3NlZEpzb253cENhcGFiaWxpdGllcyxcbiAgICAgICAgICBwcm9jZXNzZWRXM0NDYXBhYmlsaXRpZXMsXG4gICAgICAgICAgcHJvdG9jb2wsXG4gICAgICAgICAgZXJyb3IsXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgICBsb2dnZXIuaW5mbyhgQ291bGQgbm90IHBhcnNlIFczQyBjYXBhYmlsaXRpZXM6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgIGlzRml4aW5nTmVlZGVkRm9yVzNjQ2FwcyA9IHRydWU7XG4gICAgfVxuXG4gICAgaWYgKGhhc0pTT05XUENhcHMgJiYgIWlzRml4aW5nTmVlZGVkRm9yVzNjQ2Fwcykge1xuICAgICAgY29uc3QgZGlmZmVyaW5nS2V5cyA9IF8uZGlmZmVyZW5jZShfLmtleXMocHJvY2Vzc2VkSnNvbndwQ2FwYWJpbGl0aWVzKSwgXy5rZXlzKHJlbW92ZVczQ1ByZWZpeGVzKGRlc2lyZWRDYXBzKSkpO1xuICAgICAgaWYgKCFfLmlzRW1wdHkoZGlmZmVyaW5nS2V5cykpIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oYFRoZSBmb2xsb3dpbmcgY2FwYWJpbGl0aWVzIHdlcmUgcHJvdmlkZWQgaW4gdGhlIEpTT05XUCBkZXNpcmVkIGNhcGFiaWxpdGllcyB0aGF0IGFyZSBtaXNzaW5nIGAgK1xuICAgICAgICAgIGBpbiBXM0MgY2FwYWJpbGl0aWVzOiAke0pTT04uc3RyaW5naWZ5KGRpZmZlcmluZ0tleXMpfWApO1xuICAgICAgICBpc0ZpeGluZ05lZWRlZEZvclczY0NhcHMgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChpc0ZpeGluZ05lZWRlZEZvclczY0NhcHMgJiYgaGFzSlNPTldQQ2Fwcykge1xuICAgICAgbG9nZ2VyLmluZm8oJ1RyeWluZyB0byBmaXggVzNDIGNhcGFiaWxpdGllcyBieSBtZXJnaW5nIHRoZW0gd2l0aCBKU09OV1AgY2FwcycpO1xuICAgICAgdzNjQ2FwYWJpbGl0aWVzID0gZml4VzNjQ2FwYWJpbGl0aWVzKHczY0NhcGFiaWxpdGllcywganNvbndwQ2FwYWJpbGl0aWVzKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGRlc2lyZWRDYXBzID0gcHJvY2Vzc0NhcGFiaWxpdGllcyh3M2NDYXBhYmlsaXRpZXMsIGNvbnN0cmFpbnRzLCB0cnVlKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKGBDb3VsZCBub3QgcGFyc2UgZml4ZWQgVzNDIGNhcGFiaWxpdGllczogJHtlcnJvci5tZXNzYWdlfS4gRmFsbGluZyBiYWNrIHRvIEpTT05XUCBwcm90b2NvbGApO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGRlc2lyZWRDYXBzOiBwcm9jZXNzZWRKc29ud3BDYXBhYmlsaXRpZXMsXG4gICAgICAgICAgcHJvY2Vzc2VkSnNvbndwQ2FwYWJpbGl0aWVzLFxuICAgICAgICAgIHByb2Nlc3NlZFczQ0NhcGFiaWxpdGllczogbnVsbCxcbiAgICAgICAgICBwcm90b2NvbDogTUpTT05XUCxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgYSBuZXcgdzNjIGNhcGFiaWxpdGllcyBwYXlsb2FkIHRoYXQgY29udGFpbnMgb25seSB0aGUgbWF0Y2hpbmcgY2FwcyBpbiBgYWx3YXlzTWF0Y2hgXG4gICAgcHJvY2Vzc2VkVzNDQ2FwYWJpbGl0aWVzID0ge1xuICAgICAgYWx3YXlzTWF0Y2g6IHsuLi5pbnNlcnRBcHBpdW1QcmVmaXhlcyhkZXNpcmVkQ2Fwcyl9LFxuICAgICAgZmlyc3RNYXRjaDogW3t9XSxcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIHtkZXNpcmVkQ2FwcywgcHJvY2Vzc2VkSnNvbndwQ2FwYWJpbGl0aWVzLCBwcm9jZXNzZWRXM0NDYXBhYmlsaXRpZXMsIHByb3RvY29sfTtcbn1cblxuLyoqXG4gKiBUaGlzIGhlbHBlciBtZXRob2QgdHJpZXMgdG8gZml4IGNvcnJ1cHRlZCBXM0MgY2FwYWJpbGl0aWVzIGJ5XG4gKiBtZXJnaW5nIHRoZW0gdG8gZXhpc3RpbmcgSlNPTldQIGNhcGFiaWxpdGllcy5cbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gdzNjQ2FwcyBXM0MgY2FwYWJpbGl0aWVzXG4gKiBAcGFyYW0ge09iamVjdH0ganNvbndwQ2FwcyBKU09OV1AgY2FwYWJpbGl0aWVzXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBGaXhlZCBXM0MgY2FwYWJpbGl0aWVzXG4gKi9cbmZ1bmN0aW9uIGZpeFczY0NhcGFiaWxpdGllcyAodzNjQ2FwcywganNvbndwQ2Fwcykge1xuICBjb25zdCByZXN1bHQgPSB7XG4gICAgZmlyc3RNYXRjaDogdzNjQ2Fwcy5maXJzdE1hdGNoIHx8IFtdLFxuICAgIGFsd2F5c01hdGNoOiB3M2NDYXBzLmFsd2F5c01hdGNoIHx8IHt9LFxuICB9O1xuICBjb25zdCBrZXlzVG9JbnNlcnQgPSBfLmtleXMoanNvbndwQ2Fwcyk7XG4gIGNvbnN0IHJlbW92ZU1hdGNoaW5nS2V5cyA9IChtYXRjaCkgPT4ge1xuICAgIF8ucHVsbChrZXlzVG9JbnNlcnQsIG1hdGNoKTtcbiAgICBjb25zdCBjb2xvbkluZGV4ID0gbWF0Y2guaW5kZXhPZignOicpO1xuICAgIGlmIChjb2xvbkluZGV4ID49IDAgJiYgbWF0Y2gubGVuZ3RoID4gY29sb25JbmRleCkge1xuICAgICAgXy5wdWxsKGtleXNUb0luc2VydCwgbWF0Y2guc3Vic3RyaW5nKGNvbG9uSW5kZXggKyAxKSk7XG4gICAgfVxuICAgIGlmIChrZXlzVG9JbnNlcnQuaW5jbHVkZXMoYCR7VzNDX0FQUElVTV9QUkVGSVh9OiR7bWF0Y2h9YCkpIHtcbiAgICAgIF8ucHVsbChrZXlzVG9JbnNlcnQsIGAke1czQ19BUFBJVU1fUFJFRklYfToke21hdGNofWApO1xuICAgIH1cbiAgfTtcblxuICBmb3IgKGNvbnN0IGZpcnN0TWF0Y2hFbnRyeSBvZiByZXN1bHQuZmlyc3RNYXRjaCkge1xuICAgIGZvciAoY29uc3QgcGFpciBvZiBfLnRvUGFpcnMoZmlyc3RNYXRjaEVudHJ5KSkge1xuICAgICAgcmVtb3ZlTWF0Y2hpbmdLZXlzKHBhaXJbMF0pO1xuICAgIH1cbiAgfVxuXG4gIGZvciAoY29uc3QgcGFpciBvZiBfLnRvUGFpcnMocmVzdWx0LmFsd2F5c01hdGNoKSkge1xuICAgIHJlbW92ZU1hdGNoaW5nS2V5cyhwYWlyWzBdKTtcbiAgfVxuXG4gIGZvciAoY29uc3Qga2V5IG9mIGtleXNUb0luc2VydCkge1xuICAgIHJlc3VsdC5hbHdheXNNYXRjaFtrZXldID0ganNvbndwQ2Fwc1trZXldO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbi8qKlxuICogVGFrZXMgYSBjYXBhYmlsaXRpZXMgb2JqZWN0cyBhbmQgcHJlZml4ZXMgY2FwYWJpbGl0aWVzIHdpdGggYGFwcGl1bTpgXG4gKiBAcGFyYW0ge09iamVjdH0gY2FwcyBEZXNpcmVkIGNhcGFiaWxpdGllcyBvYmplY3RcbiAqL1xuZnVuY3Rpb24gaW5zZXJ0QXBwaXVtUHJlZml4ZXMgKGNhcHMpIHtcbiAgLy8gU3RhbmRhcmQsIG5vbi1wcmVmaXhlZCBjYXBhYmlsaXRpZXMgKHNlZSBodHRwczovL3d3dy53My5vcmcvVFIvd2ViZHJpdmVyLyNkZm4tdGFibGUtb2Ytc3RhbmRhcmQtY2FwYWJpbGl0aWVzKVxuICBjb25zdCBTVEFOREFSRF9DQVBTID0gW1xuICAgICdicm93c2VyTmFtZScsXG4gICAgJ2Jyb3dzZXJWZXJzaW9uJyxcbiAgICAncGxhdGZvcm1OYW1lJyxcbiAgICAnYWNjZXB0SW5zZWN1cmVDZXJ0cycsXG4gICAgJ3BhZ2VMb2FkU3RyYXRlZ3knLFxuICAgICdwcm94eScsXG4gICAgJ3NldFdpbmRvd1JlY3QnLFxuICAgICd0aW1lb3V0cycsXG4gICAgJ3VuaGFuZGxlZFByb21wdEJlaGF2aW9yJ1xuICBdO1xuXG4gIGxldCBwcmVmaXhlZENhcHMgPSB7fTtcbiAgZm9yIChsZXQgW25hbWUsIHZhbHVlXSBvZiBfLnRvUGFpcnMoY2FwcykpIHtcbiAgICBpZiAoU1RBTkRBUkRfQ0FQUy5pbmNsdWRlcyhuYW1lKSB8fCBuYW1lLmluY2x1ZGVzKCc6JykpIHtcbiAgICAgIHByZWZpeGVkQ2Fwc1tuYW1lXSA9IHZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBwcmVmaXhlZENhcHNbYCR7VzNDX0FQUElVTV9QUkVGSVh9OiR7bmFtZX1gXSA9IHZhbHVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcHJlZml4ZWRDYXBzO1xufVxuXG5mdW5jdGlvbiByZW1vdmVXM0NQcmVmaXhlcyAoY2Fwcykge1xuICBpZiAoIV8uaXNQbGFpbk9iamVjdChjYXBzKSkge1xuICAgIHJldHVybiBjYXBzO1xuICB9XG5cbiAgY29uc3QgZml4ZWRDYXBzID0ge307XG4gIGZvciAobGV0IFtuYW1lLCB2YWx1ZV0gb2YgXy50b1BhaXJzKGNhcHMpKSB7XG4gICAgY29uc3QgY29sb25Qb3MgPSBuYW1lLmluZGV4T2YoJzonKTtcbiAgICBjb25zdCBrZXkgPSBjb2xvblBvcyA+IDAgPyBuYW1lLnN1YnN0cmluZyhjb2xvblBvcyArIDEpIDogbmFtZTtcbiAgICBmaXhlZENhcHNba2V5XSA9IHZhbHVlO1xuICB9XG4gIHJldHVybiBmaXhlZENhcHM7XG59XG5cbmZ1bmN0aW9uIGdldFBhY2thZ2VWZXJzaW9uIChwa2dOYW1lKSB7XG4gIGNvbnN0IHBrZ0luZm8gPSByZXF1aXJlKGAke3BrZ05hbWV9L3BhY2thZ2UuanNvbmApIHx8IHt9O1xuICByZXR1cm4gcGtnSW5mby52ZXJzaW9uO1xufVxuXG5jb25zdCByb290RGlyID0gZmluZFJvb3QoX19kaXJuYW1lKTtcblxuZXhwb3J0IHsgaW5zcGVjdE9iamVjdCwgcGFyc2VDYXBzRm9ySW5uZXJEcml2ZXIsIGluc2VydEFwcGl1bVByZWZpeGVzLCByb290RGlyLFxuICAgICAgICAgZ2V0UGFja2FnZVZlcnNpb24gfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
